[{"categories":["Kubernetes å­¦ä¹ "],"content":"Updateã€Applyã€Server Side Apply","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 Update æœºåˆ¶ Update æœºåˆ¶æŒ‡çš„æ˜¯é€šè¿‡ HTTP Put æ–¹æ³•ä¸Šä¼ å®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œè€Œ Kubernetes ä½¿ç”¨å®Œæ•´çš„èµ„æºå¯¹è±¡æ›´æ–°åŸæ¥çš„èµ„æºå¯¹è±¡ã€‚åœ¨æ›´æ–°å¯¹è±¡æ—¶ï¼ŒKubernetes é€šè¿‡ resourceVersion æ¥æ£€æŸ¥æ˜¯å¦å‘ç”Ÿå†²çªã€‚ metadata.resourceVersion å¯ä»¥ä»£è¡¨èµ„æºçš„ç‰ˆæœ¬å·ï¼Œæœ¬è´¨ä¸Šæ˜¯ç”± etcd æä¾› modified indexã€‚åœ¨å¯¹è±¡å†™å…¥ etcd åï¼ŒresourceVersion éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ å®˜æ–¹æ–‡æ¡£ä¸­æŒ‡å‡ºï¼ŒresourceVersion ä»…ä»…åªèƒ½ç”¨æ¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ï¼Œè€Œæ²¡æœ‰å¤§å°ä¹‹åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸èƒ½æŒ‰ç…§ resourceVersion çš„å¤§å°æ¥åˆ¤æ–­å¯¹è±¡çš„æ–°æ—§ã€‚ å†™å…¥å¯¹è±¡åˆ° etcd æ—¶ï¼Œä¼šæ¯”è¾ƒå¯¹è±¡çš„ resourceVersion æ˜¯å¦ä¸å½“å‰å­˜å‚¨çš„å¯¹è±¡ resourceVersion ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰å°±è¡¨æ˜æ­¤æ¬¡æ›´æ–°å‘ç”Ÿå†²çªã€‚ Note Controller ä¸­ä½¿ç”¨çš„ Update() æ¥å£æ›´æ–°èµ„æºï¼Œéƒ½æ˜¯ Update æœºåˆ¶ï¼Œè¿”å›å†²çªé”™è¯¯ä¹Ÿå°±æ˜¯é‡åˆ°äº† resourceVersion ä¸ç›¸ç­‰çš„æƒ…å†µã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Patch æœºåˆ¶ Patch æœºåˆ¶æŒ‡çš„æ˜¯é€šè¿‡ HTTP Patch æ–¹æ³•ä¸Šä¼ å¢é‡çš„å¯¹è±¡å­—æ®µï¼ˆé™¤äº† Server Side Apply æ˜¯ä¸Šä¼ å®Œæ•´å¯¹è±¡ï¼‰ï¼ŒKubernetes ä¼šç›´æ¥æ¥å—è¯·æ±‚ï¼Œå°† patch æ‰“åˆ°å¯¹è±¡ä¸Šï¼ŒåŒæ—¶æ›´æ–° resourceVersionã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPatch æœºåˆ¶ï¼ˆé™¤äº† Server Side Applyï¼‰é»˜è®¤æ²¡æœ‰å†²çªæœºåˆ¶ã€‚ ç›®å‰æœ‰ç€ 4 ç§ Patch çš„æ–¹å¼ï¼Œå„ç§æ–¹å¼é€šè¿‡ HTTP Content-Type Header æ¥åŒºåˆ†ï¼š JSON Patch Merge Patch Strategic Merge Patch Apply Patch ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 JSON Patch JSON Patch æ˜¯ä¸€ç§æ ‡å‡†çš„ Patch åè®®ï¼ˆRFC 6901ï¼‰ï¼Œä½¿ç”¨ â€œContent-Type: application/json-patch+jsonâ€ æ ‡è¯†ã€‚ JSON Patch å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚åœ¨ä¿®æ”¹æ•°ç»„æ—¶ï¼Œéœ€è¦é€šè¿‡ç¼–å·æ¥æŒ‡å®šå…ƒç´ ã€‚ [ { \"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/image\", \"value\": \"app-image:v2\" } ] ä½†æ˜¯åœ¨å¤šä¸ªåŒæ—¶ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºæ²¡æœ‰å†²çªæœºåˆ¶ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœã€‚ä¾‹å¦‚å½“è¯¥è¯·æ±‚å‘å‡ºåï¼Œè¯¥å¯¹è±¡å·²ç»ä¿®æ”¹äº†æ•°ç»„ï¼Œé‚£ä¹ˆè¯¥ 0 ç¼–å·çš„å…ƒç´ å¾ˆå¯èƒ½å˜åŒ–äº†ï¼Œä»è€Œè¯¥è¯·æ±‚å¯¼è‡´äº†éæœŸæœ›çš„ä¿®æ”¹ã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 Merge Patch Merge Patch (ä¹Ÿç§°ä¸º JSON Merge Patchï¼‰æ˜¯ä¸€ç§æ ‡å‡†çš„ Patch åè®®ï¼ˆRFC 7386ï¼‰ï¼Œä½¿ç”¨ â€œContent-Type: application/merge-patch+jsonâ€ æ ‡è¯†ã€‚ Merge Patch ç›´æ¥ä¸Šä¼ éœ€è¦ä¿®æ”¹çš„å­—æ®µï¼Œç”¨å€¼ä¸º null è¡¨ç¤ºåˆ é™¤ä¸€ä¸ªå­—æ®µã€‚è¿™ä¹Ÿè¡¨æ˜ï¼ŒMerge Patch ä¸å…è®¸å•ç‹¬ä¿®æ”¹æ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´ ï¼Œéœ€è¦æä¾›æ•´ä¸ªæ•°ç»„æ¥è¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”æ— æ³•è¡¨ç¤º null å€¼ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢è¯·æ±‚è¡¨æ˜ç›´æ¥è¦†ç›–å½“å‰å¯¹è±¡çš„ containerï¼Œè€Œä¸èƒ½å•ç‹¬ä¿®æ”¹æ•°ç»„ã€‚ { \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"app\", \"image\": \"app-image:v2\" }, { \"name\": \"nginx\", \"image\": \"nginx:alpline\" } ] } } } } å¯è§ï¼ŒMerge Patch ä¸é€‚åˆå¯¹åˆ—è¡¨æ·±å±‚çš„å­—æ®µåšæ›´æ–°ã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 Strategic Merge Patch Strategic Merge Patch æ˜¯ Kubernetes è®¾è®¡çš„ä¸€ç§ Patch æ–¹å¼ï¼Œé€šè¿‡ä¸å­—æ®µæ•°æ®ç»“æ„çš„ä¸€äº›æ³¨é‡Šï¼ŒæŒ‡æ˜æ•°ç»„ä¸­å…ƒç´ çš„ keyï¼Œä»¥è§£å†³ Merge Patch çš„ä¸€äº›é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ Pod çš„ Container å­—æ®µçš„æºç ï¼Œå…¶ä¸­ patchMergeKey=name è¡¨æ˜ä½¿ç”¨ container.name å­—æ®µä¸ºå…ƒç´ çš„ keyã€‚ // ... // +patchMergeKey=name // +patchStrategy=merge Containers []Container `json:\"containers\" patchStrategy:\"merge\" patchMergeKey:\"name\" protobuf:\"bytes,2,rep,name=containers\"` çŸ¥æ™“äº†æ•°ç»„å…ƒç´ çš„ key åï¼Œå¯ä»¥å°†æ•°ç»„ç±»ä¼¼äº map äº†ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Merge Patch åŸºç¡€ä¸Šæ›´æ–°æŸä¸ªæ•°ç»„ä¸­çš„å…ƒç´ äº†ã€‚ ä¸‹é¢çš„è¯·æ±‚ä»…ä»…åªä¼šæ›´æ–° nginx container é…ç½®ï¼Œè€Œä¸ä¼šå½±å“åˆ°å¯¹è±¡ä¸­å·²æœ‰çš„ container é…ç½®ã€‚ { \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"nginx\", \"image\": \"nginx:mainline\" } ] } } } } ä½†æ˜¯ï¼Œä½¿ç”¨ Strategic Merge Patch æ–¹å¼éœ€è¦ Kubernetes çŸ¥æ™“å…¶æ•°æ®ç»“æ„çš„æ³¨é‡Šï¼Œå› æ­¤åªèƒ½åº”æœ‰ä¸ Kubernetes åŸç”Ÿçš„èµ„æºå¯¹è±¡ã€‚å¯¹äº Custom Resource æ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 Server Side Apply Kubernetes 1.16 ä¹‹åï¼Œé»˜è®¤å¼€å¯äº† Server Side Apply ç‰¹æ€§ï¼Œåœ¨å‰é¢ä¸‰ç§ Apply æ–¹å¼çš„åŸºç¡€ä¸Šï¼Œæä¾›äº†å†²çªçš„æœºåˆ¶ã€‚ 2.4.1 å­—æ®µç®¡ç† Server Side Apply å°†å¯¹è±¡çš„æ¯ä¸ªå­—æ®µéƒ½è®¤ä¸ºç”±ä¸€ä¸ª Manager æ¥ç®¡ç†ã€‚ ä½¿ç”¨ Server Side Apply æƒ³è¦æ›´æ–°å¯¹è±¡çš„æŸä¸ªå­—æ®µæ—¶ï¼Œå¦‚æœè¯¥å­—æ®µæ˜¯ç”±å…¶ä»– Manager ç®¡ç†æ—¶ï¼Œå°±ä¼šè§¦å‘ Conlictã€‚ä¹Ÿå°±è¡¨æ˜ï¼Œè¯¥å­—æ®µçš„æ‰€æœ‰æƒæ˜¯å±äºå…¶ä»– Manager çš„ã€‚ Note Conflict åªåœ¨ä½¿ç”¨ Server Side Apply æ—¶è§¦å‘ï¼Œå¹¶ä¸”å­—æ®µç®¡ç†çš„ç‰¹æ€§æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå› æ­¤å…¶ä»–ä»»ä½•æ›´æ–°å¯¹è±¡çš„æ“ä½œä¼šç›´æ¥æ›¿æ¢å­—æ®µçš„ Managerã€‚ å­—æ®µç®¡ç†çš„ä¿¡æ¯è®°å½•åœ¨ metadata.managedFields ä¸­ï¼š apiVersion:v1kind:ConfigMapmetadata:name:test-cmnamespace:defaultlabels:test-label:testmanagedFields:- manager:kubectloperation:ApplyapiVersion:v1time:\"2010-10-10T0:00:00Z\"fieldsType:FieldsV1fieldsV1:f:metadata:f:labels:f:test-label:{}f:data:fğŸ”‘ {}data:key:some value ä¾‹å¦‚ä¸Šè¿°å­—æ®µè¡¨æ˜ï¼Œç›®å‰ data.key å’Œ metadata.labels.test-label æ˜¯ç”± kubectl ç®¡ç†çš„ï¼Œæ›´æ–°å­—æ®µçš„æ“ä½œæ˜¯ Applyã€‚ å¦‚æœå¤šä¸ª Manager å°†åŒä¸€ä¸ªå­—æ®µè®¾ä¸ºç›¸åŒçš„å€¼ï¼Œé‚£ä¹ˆä»–ä»¬å…±äº«æ­¤å­—æ®µçš„æ‰€æœ‰æƒï¼Œç§°ä¸º Shared Managerã€‚åç»­ä»»ä½• Manager å°è¯•æ”¹å˜å­—æ®µå€¼æ—¶éƒ½ä¼šè§¦å‘ Conflictã€‚ managedFields å­—æ®µçš„æ ¼å¼è¯´æ˜è§ API æ–‡æ¡£ã€‚ åœ¨ä»»ä½•å¯¹è±¡æ›´æ–°çš„æ“ä½œæ—¶ï¼Œå¯ä»¥é€šè¿‡ fieldManager æŸ¥è¯¢æ“ä½œæ ‡è¯† Managerï¼ˆå¯¹äº Apply æ“ä½œæ˜¯å¿…é¡»æŒ‡å®šçš„ï¼‰ã€‚ 2.4.2 Merge ç­–ç•¥ Server Side Apply çš„è¯·æ±‚ä¸ Strategic Merge Patch å’Œ Merge Patch ç±»ä¼¼ã€‚å¯¹äºåŸç”Ÿèµ„æºï¼ŒServer Side Apply ä½¿ç”¨ Strategic Merge Patch çš„æ–¹å¼ï¼›å¯¹äºéåŸç”Ÿèµ„æºï¼Œä½¿ç”¨ Merge Patch çš„æ–¹å¼ã€‚ 2.4.3 Conflict å¤„ç† å½“å­—æ®µçš„æ›´æ–°è§¦å‘ Conflict æ—¶ï¼Œæœ‰ä¸‰ç§å¤„ç†æ–¹å¼ï¼š å¼ºåˆ¶æ›´æ–°ï¼Œè½¬ç§»æ‰€æœ‰æƒï¼šä½¿ç”¨ force æŸ¥è¯¢å‚æ•°ï¼Œå†å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿™è¡¨æ˜éœ€è¦å¼ºåˆ¶æ›´æ–°èµ„æºï¼Œå¹¶å°†æ›´æ–°çš„å­—æ®µçš„ Manager å˜æ›´ä¸ºå½“å‰ã€‚ æ”¾å¼ƒä¿®æ”¹ï¼šåœ¨è¯·æ±‚ä¸­å»é™¤å­—æ®µï¼Œè¡¨æ˜ä¸æ›´æ”¹å…¶å­—æ®µã€‚ æˆä¸º Shared Managerï¼šè¯·æ±‚ä¸­å­—æ®µè®¾ä¸ºå½“å‰å€¼ï¼Œä¸æ›´æ”¹å­—æ®µï¼Œä½†æ˜¯ä¼šæˆä¸º Shared Managerã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 CLI å®ç° ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 kubectl apply 3.1.1 client side apply kubectl apply é»˜è®¤æ‰§è¡Œçš„æ˜¯ client side applyï¼Œæ˜¯åŸºäºå¯¹è±¡çš„ last-applied-configuration annotation è¿›è¡Œå‰åå¯¹æ¯”ã€‚ æ€»çš„æ¥è¯´ kubectl apply åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š apply çš„å¯¹è±¡å½“å‰ä¸å­˜åœ¨ - æ‰§è¡Œ POST HTTP åˆ›å»ºå¯¹è±¡ï¼Œå¹¶è®¾ç½® last-applied-configuration annotationã€‚ apply çš„å¯¹è±¡å­˜åœ¨ï¼Œå¯¹è±¡ä¸º Kubernetes åŸç”Ÿå¯¹è±¡ - æ‰§è¡Œ PATCH HTTPï¼ŒPatch ç±»å‹ä¸º strategic merge patchã€‚ apply çš„å¯¹è±¡å­˜åœ¨ï¼Œå¯¹è±¡ä¸æ˜¯ Kubernetes åŸç”Ÿå¯¹è±¡ - æ‰§è¡Œ PATCH HTTPï¼ŒPatch ç±»å‹ä¸º merge patchã€‚ å¯¹è±¡ä¸å­˜åœ¨ï¼Œkubectl apply ç­‰ä»·äº kubectl create å‘½ä»¤ï¼Œä»…ä»…å¤šè®¾ç½®äº† last-applied-configuration annotationï¼Œä¸ºåç»­æ›´æ–°åšå‡†å¤‡ã€‚ å¯¹è±¡å­˜åœ¨ï¼Œkubectl apply ç­‰ä»·ä¸ kubectl patch å‘½ä»¤ï¼ŒåŒºåˆ«åœ¨äº kubectl apply è¾“å…¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡ï¼Œå‘½ä»¤é€šè¿‡ last-applied-configuration annotation å¾—åˆ°ä¸Šä¸€æ¬¡çš„å¯¹è±¡é…ç½®ï¼Œç„¶åè¿›è¡Œ diff ç”Ÿæˆ Patch è¯·æ±‚ã€‚ 3.1.2 server side apply kubectl apply åŠ ä¸Š --server-side å‚æ•°æ—¶ä½¿ç”¨çš„å°±æ˜¯ server side applyã€‚ä½¿ç”¨ --force-conflicts å‚æ•°å¯ä»¥å¼ºåˆ¶æ›´æ–°ï¼Œä½¿ç”¨ --field-manager å‚æ•°å¯ä»¥æŒ‡å®š Manager åå­—ï¼ˆé»˜è®¤ä¸º kubectlï¼‰ã€‚ server side apply çš„è¿‡ç¨‹æ˜¯å®Œå…¨äº¤ç»™ APIServer å¤„ç†ï¼Œkubectl ä¸éœ€è¦è¯»å– annotation è¿›è¡Œ diffï¼Œç›´æ¥é€šè¿‡ PATCH HTTP æäº¤å®Œæ•´çš„å¯¹è±¡å³å¯ï¼Œç”± APISever æ¥è¿›è¡Œ diff æ“ä½œï¼Œå¹¶ä¿®æ”¹èµ„æºã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 kubectl patch kubectl patch å‘é€çš„æ˜¯ Patch è¯·æ±‚ï¼Œåªéœ€è¦ä¸Šä¼ å¢é‡çš„æ•°æ®ï¼ˆç­‰äºè¯´æ˜¯ç”±ç”¨æˆ·åš Diff æ“ä½œï¼‰ï¼Œé»˜è®¤ä½¿ç”¨ Strategic Merge Patch ç±»å‹ã€‚å¯ä»¥ä½¿ç”¨ --type æ¥æŒ‡å®š Patch ç±»å‹ã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.3 kubectl edit kubectl edit æ¯” kubectl apply æ›´åŠ ç®€å•ï¼Œå› ä¸ºä¸éœ€è¦é€šè¿‡ annotation è¯»å–å˜åŒ–ï¼Œè€Œæ˜¯ç›´æ¥ diff ç¼–è¾‘å‰åçš„å¯¹è±¡æ¥ç”Ÿæˆ Patch è¯·æ±‚ã€‚ å½“ç„¶ï¼ŒPatch ç±»å‹ä¹Ÿæ˜¯åŸºäºå¯¹è±¡æ˜¯å¦æ˜¯ Kubernetes åŸç”Ÿçš„å†³å®šçš„ã€‚ ","date":"2022-01-13","objectID":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"Kubernetes èµ„æºæ›´æ–°æœºåˆ¶ä¸ CLI å®ç°","uri":"/posts/cloud_computing/k8s_learning/update-resource-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"Domainï¼ŒName Server","date":"2021-12-23","objectID":"/posts/net/dns/","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"ä¸»æœºä½¿ç”¨ IP åœ°å€ä½œä¸ºé€šä¿¡åœ°å€æ˜¯å¾ˆéš¾è®°å¿†çš„ï¼Œç”¨æˆ·æ›´æ„¿æ„ä½¿ç”¨æ¯”è¾ƒå®¹æ˜“è®°å¿†çš„ Hostnameã€‚è€Œ Domain Name Systemï¼ˆDNSï¼‰å°±æ˜¯ç”¨äºå°† Domain è½¬æ¢ä¸º IP åœ°å€ã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:0:0","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"1 Domain ä½“ç³» Domain æœ‰ç€ä¸¥æ ¼çš„å±‚æ¬¡åˆ’åˆ†ï¼Œä¾‹å¦‚ main.cctv.com. å°±ç”±ä¸‰ä¸ªæ ‡å·ç»„æˆï¼Œå…¶ä¸­ . ä¸ºæ ¹ï¼Œcom ä¸ºé¡¶çº§åŸŸåï¼Œcctv ä¸ºäºŒçº§åŸŸåï¼Œmail ä¸ºä¸‰çº§åŸŸåã€‚ Note å› ä¸ºåŸŸåçš„æ ¹æ°¸è¿œæ˜¯ . å·ï¼Œå› æ­¤ç”¨æˆ·åœ¨ä½¿ç”¨æ—¶å¸¸å¸¸ä¼šçœç•¥ï¼ŒåŸŸåè§£æç¨‹åºä¼šè‡ªåŠ¨åŠ ä¸Šæ ¹ . å·ã€‚ æ ¹æ®å…¶å±‚çº§ç»“æ„ï¼Œmain.cctv.com ä¹Ÿè¢«ç§°ä¸º cctv.com çš„ SubDomainã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:1:0","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"2 Domain Server Domain Serverï¼ˆä¹Ÿç§°ä¸º Name Serverï¼‰ï¼Œæ˜¯ç”¨äºå¤„ç† DNS è§£æè¯·æ±‚çš„æœåŠ¡åŒºã€‚ åŸºäº Domain çš„åˆ†å±‚è®¾ç½®ï¼Œç”¨äºå¤„ç† Domain è½¬æ¢ä¸º IP çš„æœåŠ¡å™¨ä¹Ÿæ˜¯æŒ‰ç…§ä¸åŒå±‚çº§åˆ†ç±»ã€‚ æ ¹åŸŸåæœåŠ¡å™¨ - æœ€é¡¶çº§çš„åŸŸåæœåŠ¡å™¨ å…¨çƒä¸€å…±æœ‰ 13 å°æ ¹åŸŸåæœåŠ¡å™¨ï¼Œæ¯å°æ ¹åŸŸåæœåŠ¡å™¨çŸ¥æ™“æ‰€æœ‰çš„é¡¶çº§åŸŸåæœåŠ¡å™¨ã€‚ æ ¹åŸŸåæœåŠ¡å™¨é€šå¸¸ä¸ä¼šç›´æ¥å¯¹åŸŸåè¿›è¡Œè§£æï¼Œè€Œæ˜¯æ ¹æ®å…¶é¡¶çº§åŸŸåï¼Œè¿”å›å¯¹åº”çš„é¡¶çº§åŸŸåæœåŠ¡å™¨çš„ IP åœ°å€ã€‚ é¡¶çº§åŸŸåæœåŠ¡å™¨ - è´Ÿè´£æ‰€æœ‰é¡¶çº§åŸŸå åŒæ ·ï¼Œé¡¶çº§åŸŸåæœåŠ¡å™¨æ”¶åˆ° DNS è¯·æ±‚æ—¶ï¼Œå¯èƒ½ç›´æ¥å›å¤ IP åœ°å€ï¼Œä¹Ÿå¯èƒ½è¿”å›ä¸‹ä¸€çº§æƒé™æœåŠ¡å™¨çš„ IP åœ°å€ã€‚ æƒé™åŸŸåæœåŠ¡å™¨ - è´Ÿè´£ç®¡ç†æŸä¸ªåŒºåŸŸçš„åŸŸå æœ¬åœ°åŸŸåæœåŠ¡å™¨ - åŸŸåè§£æçš„å…¥å£ æœ¬åœ°åŸŸåæœåŠ¡å™¨å¹¶ä¸è´Ÿè´£åŸŸåçš„æŸä¸€å±‚çº§ï¼Œè€Œæ˜¯ä½œä¸ºåŸŸåè§£æçš„å…¥å£ã€‚ä¸»æœºå‘èµ·çš„ DNS è§£æè¯·æ±‚éƒ½ä¼šå‘é€åˆ°æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼Œç”±æœ¬åœ°åŸŸåæœåŠ¡å™¨æ¥æ‰§è¡ŒåŸŸåè§£æçš„è¿‡ç¨‹ã€‚ æ¯ä¸ªå› ç‰¹ç½‘æœåŠ¡å•† ISPï¼Œç”šè‡³ä¸€ä¸ªå¤§å­¦é‡Œéƒ½å¯ä»¥æœ‰ç€æœ¬åœ°åŸŸåæœåŠ¡å™¨ã€‚ æœ¬åœ°åŸŸåæœåŠ¡å™¨ä¹Ÿè¢«ç§°ä¸º DNS Resolverï¼ŒåŸŸåæœåŠ¡å™¨ä¹Ÿè¢«ç§°ä¸º Name Serverã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:2:0","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"3 åŸŸåè§£æè¿‡ç¨‹ ä¸»æœºå‘æœ¬åœ°åŸŸåæœåŠ¡å™¨çš„æŸ¥è¯¢ä¸€èˆ¬æ˜¯é€’å½’æŸ¥è¯¢ï¼šå¦‚æœæœ¬åœ°æœåŠ¡å™¨æ— æ³•å¤„ç† DNS è¯·æ±‚ï¼Œé‚£ä¹ˆå°±ç”±æœ¬åœ°åŸŸåæœåŠ¡å™¨å‘å…¶ä»–ä¸Šçº§åŸŸåæœåŠ¡å™¨å‘å‡º DNS è¯·æ±‚ã€‚ ä¸ºäº†æé«˜ DNS æŸ¥è¯¢æ•ˆç‡ï¼ŒåŸŸåæœåŠ¡å™¨ä¼šç¼“å­˜ Domain-\u003eIP çš„æ˜ å°„å…³ç³»ï¼Œå¹¶åœ¨è®¾å®šçš„ TTL æ—¶é—´åæ¸…ç†ç¼“å­˜è®°å½•ã€‚ä¸ä»…ä»…æ˜¯åŸŸåæœåŠ¡å™¨ï¼Œè®¸å¤šä¸»æœºä¹Ÿä¼šåœ¨æœ¬åœ°ç»´æŠ¤è‡ªå·±çš„åŸŸåç¼“å­˜ã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:3:0","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4 DNS Record åŸŸåæœåŠ¡å™¨ä¸­ä¿å­˜ç€å¤šä¸ª DNS Recordï¼Œæ¥å—åˆ° DNS è§£æè¯·æ±‚åï¼Œä¼šæŸ¥è¯¢ä¿å­˜çš„ DNS Record æ¥è¿›è¡Œå›å¤ã€‚ ä¸€ä¸ª DNS Record å¯ä»¥ç†è§£ä¸º Domain -\u003e Content çš„æ˜ å°„ã€‚æ ¹æ®å…¶ Content çš„ä¸åŒå†…å®¹ï¼ŒDNS Record åˆ†ç±»ä¸åŒçš„ç±»å‹ï¼š A - Content ä¸º IP åœ°å€ AAAA - Content ä¸º IPv6 åœ°å€ CNAME - Content ä¸ºå¦ä¸€ä¸ªæƒå¨åŸŸåcanonical name MX - Content ä¸ºé‚®ä»¶äº¤æ¢æœåŠ¡å™¨mail exchange NS - Content ä¸ºå¦ä¸€ä¸ªåŸŸåæœåŠ¡å™¨name server TXT - Context æ˜¯å¯¹è¯¥ Domain çš„æè¿°ä¿¡æ¯ ALIAS - ï¼ˆAWS Route 53 ç‰¹æœ‰ï¼‰Content ä¸ºå¦ä¸€ä¸ª Domain Note DNS Record çš„ç±»å‹å°±æ˜¯ DNS æŠ¥æ–‡ä¸­çš„ Typeã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:4:0","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4.1 A ç±»å‹ A ç±»å‹ DNS Record è¡¨ç¤º Domain å¯¹åº”çš„ IP åœ°å€ã€‚å½“åŸŸåæœåŠ¡å™¨æ¥å—åˆ° DNS è¯·æ±‚æ—¶ï¼ŒæŸ¥è¯¢åˆ° Domain å¯¹åº”çš„ DNS Record æ˜¯ A ç±»å‹ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å› IP åœ°å€ã€‚ $ dig www.google.com ; \u003c\u003c\u003e\u003e DiG 9.16.1-Ubuntu \u003c\u003c\u003e\u003e www.google.com ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 55926 ;; flags: qr rd ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;www.google.com. IN A ;; ANSWER SECTION: www.google.com. 0 IN A 172.217.26.228 ;; Query time: 0 msec ;; SERVER: 172.23.64.1#53(172.23.64.1) ;; WHEN: Sat Dec 25 22:42:48 CST 2021 ;; MSG SIZE rcvd: 62 ","date":"2021-12-23","objectID":"/posts/net/dns/:4:1","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4.2 AAAA ç±»å‹ AAAA ç±»å‹ DNS Record è¡¨ç¤º Domain å¯¹åº”çš„ IPv6 åœ°å€ã€‚ dig å‘½ä»¤é»˜è®¤ä»…ä»…æŸ¥è¯¢ A è®°å½•ï¼Œéœ€è¦é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šï¼š $ dig www.google.com AAAA ; \u003c\u003c\u003e\u003e DiG 9.16.1-Ubuntu \u003c\u003c\u003e\u003e www.google.com AAAA ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 57495 ;; flags: qr rd ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;www.google.com. IN AAAA ;; ANSWER SECTION: www.google.com. 0 IN AAAA 2404:6800:4004:801::2004 ;; Query time: 40 msec ;; SERVER: 172.23.64.1#53(172.23.64.1) ;; WHEN: Sat Dec 25 22:44:47 CST 2021 ;; MSG SIZE rcvd: 74 ","date":"2021-12-23","objectID":"/posts/net/dns/:4:2","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4.3 CNAME ç±»å‹ CNAME ç±»å‹è¡¨ç¤ºä½¿ç”¨åˆ«åçš„æƒå¨åŸŸåcanonical nameã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCNAME æ˜¯ Domain çš„åŸŸåçš„åˆ«åã€‚ å½“ Name Server è¿”å› CNAME è®°å½•æ—¶ï¼Œè¡¨æ˜ DNS Resolver åº”è¯¥é€šè¿‡è¿”å›çš„ CNAME ç»§ç»­è¿›è¡Œ DNS è§£æã€‚ ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ CDN æœåŠ¡æ—¶ï¼Œç”¨æˆ·æä¾›æºç«™åï¼Œé€šå¸¸ CDN æœåŠ¡ä¼šæä¾›ä¸€ä¸ª CNAMEï¼Œä¾‹å¦‚ â€œxx.cdn.dnsv1.comâ€ã€‚è€Œè¿™æ—¶ï¼ŒCDN æœåŠ¡å™¨ä¼šåœ¨ Name Server æ·»åŠ ä¸€æ¡ DNS Recordã€‚ CNAME \u003csource site\u003e \"xx.cdn.dnsv1.com\" è¿™æ ·ï¼Œç”¨æˆ·è®¿é—® source site æ—¶åä¼šè¿”å› CNAME åœ°å€ï¼Œæ¥ç€ç”¨æˆ·å°±ä¼šå¯¹ CNAME åœ°å€çš„æœåŠ¡å™¨å‘èµ· DNS è§£æä»¥åŠè®¿é—®ï¼Œä»è€Œç”¨æˆ·å°±æ”¾å›åˆ°äº† CDN çš„ç¼“å­˜æœåŠ¡å™¨ã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:4:3","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4.4 MX ç±»å‹ MX è®°å½•ï¼Œè¡¨ç¤ºé‚®ä»¶äº¤æ¢mail exchangeæœåŠ¡ã€‚æ¯ä¸ªé‚®ä»¶å‚å•†éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„åŸŸåï¼ŒæŸ¥è¯¢è¯¥åŸŸååï¼Œå°±ä¼šè¿”å›å¯¹åº”çš„é‚®ä»¶æœåŠ¡å™¨çš„åŸŸåã€‚ $ dig qq.com MX ; \u003c\u003c\u003e\u003e DiG 9.16.1-Ubuntu \u003c\u003c\u003e\u003e qq.com MX ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 1841 ;; flags: qr rd ad; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;qq.com. IN MX ;; ANSWER SECTION: qq.com. 0 IN MX 20 mx2.qq.com. qq.com. 0 IN MX 30 mx1.qq.com. qq.com. 0 IN MX 10 mx3.qq.com. ;; Query time: 10 msec ;; SERVER: 172.23.64.1#53(172.23.64.1) ;; WHEN: Sat Dec 25 23:10:03 CST 2021 ;; MSG SIZE rcvd: 108 Note MX ç±»å‹çš„å‡ºç°æ˜¯å†å²çš„åŸå› ï¼Œç°åœ¨ç†è®ºä¸Šå¯ä»¥ä½¿ç”¨ A ç±»å‹è®°å½•æ›¿ä»£ã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:4:4","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4.5 NS ç±»å‹ NS ç±»å‹è®°å½•ï¼Œè¡¨ç¤ºè¯¥ Domain éœ€è¦ç»§ç»­è®¿é—®å…¶ä»–çš„ Name Server è¿›è¡Œè§£æï¼Œå³è¯¥ DNS Record ä¼šè¿”å›å¦ä¸€ä¸ª Name Server çš„åŸŸåã€‚ ä»¥è®¿é—® qq.comï¼Œå½“ DNS è¯·æ±‚å‘åˆ° com Name Server æ—¶ï¼Œcom æ ¹æ®è‡ªèº«çš„ NS è®°å½•å‘ŠçŸ¥åº”è¯¥å»å“ªä¸ª Name Server ç»§ç»­è¿›è¡Œ DNS è§£æã€‚ å› æ­¤ï¼ŒNS ç±»å‹å®é™…ä¸Šå®ç°äº† Domain çš„å±‚çº§ç»“æ„ï¼Œå¹¶å½¢æˆäº†è¿­ä»£çš„ DNS è§£ææµç¨‹ã€‚ $ dig qq.com NS ; \u003c\u003c\u003e\u003e DiG 9.16.1-Ubuntu \u003c\u003c\u003e\u003e qq.com NS ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 25101 ;; flags: qr rd ad; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 0 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;qq.com. IN NS ;; ANSWER SECTION: qq.com. 0 IN NS ns4.qq.com. qq.com. 0 IN NS ns1.qq.com. qq.com. 0 IN NS ns2.qq.com. qq.com. 0 IN NS ns3.qq.com. ;; Query time: 60 msec ;; SERVER: 172.23.64.1#53(172.23.64.1) ;; WHEN: Sat Dec 25 23:15:17 CST 2021 ;; MSG SIZE rcvd: 126 ","date":"2021-12-23","objectID":"/posts/net/dns/:4:5","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["ç½‘ç»œ"],"content":"4.6 TXT ç±»å‹ TXT ç±»å‹è®°å½•ä¸æ˜¯å®é™…ä¸Šå½±å“ DNS è§£æçš„è®°å½•ï¼Œè€Œæ˜¯ä¿å­˜ä¸€äº›æ–‡æœ¬ä¿¡æ¯ï¼Œå…¶ä¸­ä¸€äº›ä¿¡æ¯æ˜¯ DNS è§£æçš„é…ç½®ã€‚ ","date":"2021-12-23","objectID":"/posts/net/dns/:4:6","tags":["ç½‘ç»œ"],"title":"DNS åŸŸåè§£æç³»ç»Ÿ","uri":"/posts/net/dns/"},{"categories":["Kubernetes å®è·µ"],"content":"1 æ¦‚è¿° ExternalDNS ç”¨äºå°† Kubernetes é›†ç¾¤ä¸­çš„ Service/Ingress æš´éœ²çš„æœåŠ¡åŒæ­¥ç»™å¤–éƒ¨çš„ DNS æœåŠ¡å•†ï¼Œä¾‹å¦‚ AWS Route53ã€GCP CloudDNS ç­‰ã€‚ ExternalDNS æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ª DNS Nameserverï¼Œè€Œæ˜¯è´Ÿè´£å°† Kubernetes é›†ç¾¤çš„ DNS è®°å½•å†™å…¥åˆ°å¤–éƒ¨çš„ DNS Nameserverã€‚ ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2 ä¸º AWS Route53 è®¾ç½® External DNS ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2.1 å¯åŠ¨ EKS é›†ç¾¤ æ‰§è¡Œ eksctl create cluster å‘½ä»¤å¯åŠ¨ä¸€ä¸ª EKS é›†ç¾¤ã€‚ $ eksctl create cluster --name test-cluster --with-oidc --managed --region us-west-2 --nodes 3 æ³¨æ„ï¼Œè¿™é‡Œå¿…é¡»ä½¿ç”¨ --with-oidc å‚æ•°æ¥åˆ›å»º OIDC æœåŠ¡ï¼Œå› ä¸ºè¦è®© ServiceAccount ç»‘å®š IAM Policy éœ€è¦ OIDC æœåŠ¡æä¾›ã€‚ ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2.2 å‡†å¤‡ ServiceAccount å› ä¸º ExternalDNS éœ€è¦å°† DNS è®°å½•åŒæ­¥ç»™ AWS Route53ï¼Œå› æ­¤éœ€è¦ä¸º ExternalDNS å‡†å¤‡ä¸€ä¸ªç»‘å®šäº† IAM Role çš„ ServiceAccountã€‚ ExternalDNS æ‰€éœ€æƒé™çš„ IAM Policy å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å…¶éœ€è¦ Route53 çš„ä¿®æ”¹ä¸æŸ¥çœ‹æƒé™ã€‚ { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Action\": [ \"route53:ChangeResourceRecordSets\" ], \"Resource\": [ // è¿™é‡Œç»™äºˆäº†è®¿é—®æ‰€æœ‰ hostzone çš„æƒé™ï¼Œä¹Ÿå¯ä»¥é™åˆ¶ä¸ºä½ éœ€è¦çš„ \"arn:aws:route53:::hostedzone/*\" ] }, { \"Effect\": \"Allow\", \"Action\": [ \"route53:ListHostedZones\", \"route53:ListResourceRecordSets\" ], \"Resource\": [ \"*\" ] } ] } æ‰§è¡Œ aws iam create-policy å‘½ä»¤æ¥åˆ›å»º IAM Policyï¼Œå…¶åä¸º external-dns $ aws iam create-policy --policy-name external-dns --policy-document file://external-dns-policy.json { \"Policy\": { \"PolicyName\": \"external-dns\", \"PolicyId\": \"ANPAVTR2JPDXDMH3BN6RZ\", \"Arn\": \"arn:aws:iam::385595570414:policy/external-dns\", \"Path\": \"/\", \"DefaultVersionId\": \"v1\", \"AttachmentCount\": 0, \"PermissionsBoundaryUsageCount\": 0, \"IsAttachable\": true, \"CreateDate\": \"2021-12-22T14:24:39+00:00\", \"UpdateDate\": \"2021-12-22T14:24:39+00:00\" } } è®°å½•è¿™é‡Œçš„ IAM Policy çš„ ARNï¼Œåç»­åˆ›å»º ServiceAccount æ—¶éœ€è¦ä½¿ç”¨ã€‚ é€šè¿‡ eksctl create iamserviceaccount å‘½ä»¤åˆ›å»ºç»‘å®š IAM Role çš„ ServiceAccountï¼š eksctl create iamserviceaccount --cluster=test-cluster --name=external-dns --namespace=external-dns-admin --attach-policy-arn=arn:aws:iam::385595570414:policy/external-dns --approve --override-existing-serviceaccounts --cluster ä¸ --region æŒ‡å®šäº† EKS é›†ç¾¤ --name ä¸ --namepsace æŒ‡å®šåˆ›å»ºçš„ ServiceAccount çš„ name ä¸ ns --attach-policy-arn æŒ‡å®šäº†è¦ç»‘å®šçš„ IAM Policy --override-existing-serviceaccounts è¡¨æ˜å…è®¸è¦†ç›–å·²ç»å­˜åœ¨çš„ ServiceAccount --approve è¡¨æ˜åº”ç”¨ä¿®æ”¹ Note ä¹Ÿå¯ä»¥é€šè¿‡ aws cli æ¥åˆ›å»º ServiceAccountï¼Œå…·ä½“è§å®˜æ–¹æ–‡æ¡£ï¼šCreating an IAM role and policy for your service accountã€‚ ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2.3 å‡†å¤‡ Route53 Host Zone åˆ›å»º ExternalDNS åŒæ­¥ DNS çš„ Route53 Host Zoneï¼Œå½“ç„¶å¦‚æœéœ€è¦ä½¿ç”¨å·²æœ‰çš„ Host Zoneï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è·³è¿‡ã€‚ é€šè¿‡ aws route53 create-hosted-zone åˆ›å»ºä¸€ä¸ªæ–°çš„ Host Zoneï¼š $ aws route53 create-hosted-zone --name \"external-dns-test.my-org.com.\" --caller-reference \"external-dns-test-$(date +%s)\" { \"Location\": \"https://route53.amazonaws.com/2013-04-01/hostedzone/Z10422583QOCYXWPPFU3S\", \"HostedZone\": { \"Id\": \"/hostedzone/Z10422583QOCYXWPPFU3S\", \"Name\": \"external-dns-test.my-org.com.\", \"CallerReference\": \"external-dns-test-1640156982\", \"Config\": { \"PrivateZone\": false }, \"ResourceRecordSetCount\": 2 }, // ... } è®°å½•è¿™é‡Œçš„ Host Zone çš„ IDï¼Œåœ¨é…ç½® External DNS æ—¶éœ€è¦ä½¿ç”¨ã€‚ ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2.4 éƒ¨ç½² ExternalDNS åˆ›å»º ExternalDNS çš„å®šä¹‰ yamlï¼Œå…¶ä¸­åŒ…å«äº† ClusterRoleã€ClusterRoleBinding ä¸ Deploymentã€‚ apiVersion:rbac.authorization.k8s.io/v1kind:ClusterRolemetadata:name:external-dnsrules:- apiGroups:[\"\"]resources:[\"services\",\"endpoints\",\"pods\"]verbs:[\"get\",\"watch\",\"list\"]- apiGroups:[\"extensions\",\"networking.k8s.io\"]resources:[\"ingresses\"]verbs:[\"get\",\"watch\",\"list\"]- apiGroups:[\"\"]resources:[\"nodes\"]verbs:[\"list\",\"watch\"]---apiVersion:rbac.authorization.k8s.io/v1kind:ClusterRoleBindingmetadata:name:external-dns-viewerroleRef:apiGroup:rbac.authorization.k8s.iokind:ClusterRolename:external-dnssubjects:- kind:ServiceAccountname:external-dnsnamespace:external-dns-admin---apiVersion:apps/v1kind:Deploymentmetadata:name:external-dnsnamespace:external-dns-adminspec:strategy:type:Recreateselector:matchLabels:app:external-dnstemplate:metadata:labels:app:external-dnsspec:serviceAccountName:external-dnscontainers:- name:external-dnsimage:k8s.gcr.io/external-dns/external-dns:v0.7.6args:- --source=service- --source=ingress- --domain-filter=external-dns-test.my-org.com- --provider=aws- --policy=upsert-only- --aws-zone-type=public- --registry=txt- --txt-owner-id=my-hostedzone-identifier éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸º ExternalDNS çš„ Pod éœ€è¦ä½¿ç”¨å‰é¢åˆ›å»ºçš„ ServiceAccountï¼Œå› æ­¤éœ€è¦éƒ¨ç½²åœ¨ç›¸åŒçš„ nsï¼ŒClusterRoleBinding ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ çœ‹ä¸‹ ExternalDNS çš„å¯åŠ¨å‚æ•°ï¼š --source æŒ‡å®šäº†ä»å“ªäº›èµ„æºæŸ¥æ‰¾éœ€è¦åŒæ­¥çš„ Endpoint --domain-filter é™åˆ¶å¤„ç†çš„ç›®æ ‡ DNS Zone --provider æŒ‡æ˜äº† DNS æä¾›å•† --policy æŒ‡æ˜ä¸ DNS Provider çš„æ•°æ®åŒæ­¥æ–¹å¼ï¼Œé»˜è®¤ syncï¼Œå¯é€‰ upsert-only, create-only ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2.5 éƒ¨ç½² Service ä»¥ LB Service ä¸ºä¾‹ï¼Œæ¥éªŒè¯ ExternalDNS çš„å·¥ä½œã€‚ å…ˆåˆ›å»ºéœ€è¦ä½¿ç”¨çš„ Serviceï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š apiVersion:v1kind:Servicemetadata:name:nginxannotations:external-dns.alpha.kubernetes.io/hostname:nginx.external-dns-test.my-org.comspec:type:LoadBalancerports:- port:80name:httptargetPort:80selector:app:nginx å…¶å…³é”®åœ¨äºï¼Œæ·»åŠ äº† key ä¸º external-dns.alpha.kubernetes.io/hostname çš„ annotationï¼Œå…¶ value ä¸ºéœ€è¦åŒæ­¥åˆ° Route 53 çš„ DNS åŸŸåã€‚ ç­‰å¾…å‡ åˆ†é’Ÿåï¼ŒæŸ¥è¯¢ Route 53 çš„ DNS è®°å½•å¯ä»¥çœ‹åˆ°å…¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ DNS è®°å½•ï¼š $ aws route53 list-resource-record-sets --output json --hosted-zone-id /hostedzone/Z10422583QOCYXWPPFU3S { \"ResourceRecordSets\": [ // ... { \"Name\": \"nginx.external-dns-test.my-org.com.\", \"Type\": \"A\", \"AliasTarget\": { \"HostedZoneId\": \"Z368ELLRRE2KJ0\", \"DNSName\": \"a8ffeecc9c0c048e5bdff2d90d66f307-118096740.us-west-1.elb.amazonaws.com.\", \"EvaluateTargetHealth\": true } } // ... } å¯ä»¥çœ‹åˆ°ï¼Œâ€œnginx.external-dns-test.my-org.com.â€ ä¸ºä¸€ä¸ª DNS åˆ«åï¼Œå…¶æŒ‡å‘çš„æ˜¯ Service çš„ LB åŸŸåã€‚ ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"2.6 éªŒè¯ æˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ª nginx æœåŠ¡æ¥éªŒè¯ DNS è®°å½•å·²ç»è¢«åŒæ­¥ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š apiVersion:apps/v1kind:Deploymentmetadata:name:nginxspec:selector:matchLabels:app:nginxtemplate:metadata:labels:app:nginxspec:containers:- image:nginxname:nginxports:- containerPort:80name:http ç„¶åé€šè¿‡è®¿é—®åœ¨ Service annotation æŒ‡å®šçš„éœ€è¦åŒæ­¥çš„ DNS åŸŸåï¼Œæ¥æµ‹è¯• DNS çš„åŒæ­¥æ˜¯å¦æˆåŠŸï¼š $ curl nginx.external-dns-test.my-org.com. ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:2:6","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å®è·µ"],"content":"å‚è€ƒ Githubï¼šexternal-dns Docï¼šSetting up ExternalDNS for Services on AWS Blogï¼šé€šè¿‡ ExternalDNS é›†æˆå¤–éƒ¨ DNS æœåŠ¡ ","date":"2021-12-22","objectID":"/posts/cloud_computing/k8s_practice/use-external-dns/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - ä½¿ç”¨ External DNS","uri":"/posts/cloud_computing/k8s_practice/use-external-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"HPA ç®—æ³•å®šä¹‰","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"HPA çš„æ ¸å¿ƒåŸç†å°±æ˜¯å°±æ˜¯ä» Metric Server é‡‡é›†æŒ‡æ ‡æ•°æ®ï¼Œç„¶åæ ¹æ®ç¼©æ‰©å®¹ç®—æ³•è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°ç›®æ ‡çš„ Pod å‰¯æœ¬æ•°é‡ã€‚å½“ç›®æ ‡ Pod å‰¯æœ¬æ•°é‡ä¸å½“å‰å‰¯æœ¬æ•°é‡ä¸åŒæ—¶ï¼ŒHPA Controller è°ƒç”¨æŒ‡å®šçš„èµ„æºå¯¹è±¡çš„ scale æ“ä½œï¼Œè¿›è¡Œç¼©æ‰©å®¹ã€‚ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 ç¼©æ‰©å®¹ç®—æ³• ä»æœ€æ ¹æœ¬ä¸Šçœ‹ï¼Œç¼©æ‰©å®¹ç®—æ³•æŒ‰ç…§ä»¥ä¸‹çš„å…¬å¼æ¥è®¡ç®—ç›®æ ‡çš„ Pod å‰¯æœ¬æ•°é‡ã€‚ desiredReplicas = ceil[currentReplicas * (currentMetricValue / metricValue)] currentReplicas - å½“å‰ Pod çš„å‰¯æœ¬æ•°é‡ currentMetricValue - å½“å‰çš„ Metrics å€¼ metricValue - é¢„å®šä¹‰çš„ Metric å€¼ currentMetricValue ä¸ metricValue å¯ä»¥æ˜¯æŒ‰ç…§å›ºå®šå€¼ã€å¹³å‡å€¼æˆ–è€…ä½¿ç”¨ç‡çš„æ–¹å‘å»è®¡ç®—ã€‚ Value - desiredMetricValue ä¸ºå›ºå®šå€¼ï¼ŒcurrentMetricValue ä¸ºé‡‡é›†åˆ°çš„å€¼ AverageValue - targetAverageValue ä¸ºå›ºå®šå€¼ï¼ŒcurrentMetricValue ä¸ºæ‰€æœ‰ Pod Metric çš„å¹³å‡å€¼ Utilization - targetAverageUtilization ä¸ºå›ºå®šçš„æ¯”ä¾‹ï¼Œä¸ºå›ºå®šå€¼ï¼ŒcurrentMetricValue å°†æ‰€æœ‰ Pod çš„ Metric å€¼æ±‚å¹³å‡åé™¤ä»¥ Metric æ€»å’Œ å¯ä»¥è®¾ç½®åŸºäºå¤šä¸ª metric æŒ‡æ ‡è®¡ç®—ï¼ŒHPA ä¼šå¯¹æ¯ä¸ª metric ç®—å‡ºå„ä¸ª desiredReplicasï¼Œç„¶åä»¥å…¨éƒ¨ç»“æœçš„æœ€å¤§å€¼ä½œä¸ºæœ€ç»ˆç»“æœã€‚ä¸è¿‡ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ª metric æ— æ³•ç®—å‡º desiredReplicasï¼Œé‚£ä¹ˆå°±ä¼šè·³è¿‡æœ¬æ¬¡ç¼©æ‰©å®¹ã€‚ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 å®¹å¿åº¦ ä¸º desiredReplicas ä¸ currentReplicas æ¯”ä¾‹æ¥è¿‘äº 1 æ—¶ï¼Œå¯ä»¥è®¾ç½® tolerance å€¼æ¥è®© HPA Controller ä¸è¿›è¡Œç¼©æ‰©å®¹ã€‚ é»˜è®¤ä¸‹ï¼Œtolerance è®¾ç½®ä¸º 0.1ï¼ˆ10%ï¼‰ï¼Œé‚£ä¹ˆå½“ desiredReplicas ä¸ currentReplicas æ¯”ä¾‹åœ¨ [-10%, +10%] åŒºé—´æ—¶ï¼Œä¸ä¼šè¿›è¡Œè‡ªåŠ¨ç¼©æ‰©å®¹ã€‚ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.2 å¼‚å¸¸å¤„ç† å½“è®¡ç®— desiredReplicas æ—¶ï¼Œå¦‚æœéƒ¨åˆ† Pod å¤„äºå¼‚å¸¸çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºè¿™äº› Pod çš„æ•°æ®ä¼šè¿›è¡Œç‰¹æ®Šçš„å¯¹å¾…ã€‚ Pod çš„å¼‚å¸¸çŠ¶æ€åŒ…æ‹¬ï¼š Pod æ­£åœ¨è¢«åˆ é™¤ï¼ˆDeletionTimeStamp != nilï¼‰ Pod çš„ metric value æ— æ³•é‡‡é›† Pod è¿˜æœªè¾¾åˆ° Ready çŠ¶æ€ï¼ˆä»…ä»…å¯¹äº CPU æŒ‡æ ‡çš„ç¼©æ‰©å®¹ä½¿ç”¨ï¼‰ å¯¹äº desiredMetricValue çš„æ–¹å¼ï¼Œæ‰€æœ‰å¼‚å¸¸çš„ Pod ä¼šè¢«å¿½ç•¥ï¼Œä¸è®¡å…¥ currentReplicas ä¸ç®—å‡º desiredReplicasã€‚ å¯¹äº targetAverageValue / targetAverageUtilizationï¼Œåœ¨è®¡ç®—å¹³å‡å€¼ä¼šä½¿ç”¨ â€œä¿å®ˆâ€ åœ°ç­–ç•¥ã€‚ åœ¨éœ€è¦ Scaleup è®¡ç®—æ—¶ï¼Œè®¤ä¸º Pod çš„ MetricValue æ¯”ä¾‹ä¸º 0%ï¼Œä»¥å‡å°ç®—å‡ºçš„ desiredReplicas åœ¨éœ€è¦ Scaledown è®¡ç®—æ—¶ï¼Œè®¤ä¸º Pod çš„ MetricValue æ¯”ä¾‹ä¸º 100%ï¼Œä»¥å¢å¤§ç®—å‡º desiredReplicas ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.3 å†·å´æ—¶é—´ HPA è®¡ç®—ç›®æ ‡å‰¯æœ¬æ•°é‡æ—¶ï¼Œå¯èƒ½å› ä¸ºæŒ‡æ ‡çš„æŠ–åŠ¨å¯¼è‡´ Pod å‰¯æœ¬æ•°é‡é¢‘ç¹å˜åŒ–ã€‚å¯ä»¥é…ç½® kube-controller-manager çš„å¯åŠ¨å‚æ•° â€“horizontal-pod-autoscaler-downscale-stabilization æ¥è®¾ç½®ä¸¤æ¬¡ç¼©æ‰©å®¹æ“ä½œçš„é—´éš”æ—¶é—´ï¼ˆé»˜è®¤è¯¥å€¼ä¸º 5minï¼‰ã€‚ å½“ç„¶éœ€è¦ç†è§£ï¼Œå½“è¯¥å‚æ•°è¿‡å°æ—¶ï¼Œå¯èƒ½å¯¼è‡´å‰¯æœ¬æ•°é‡çš„æŠ–åŠ¨ï¼Œå½“è¯¥å‚æ•°è¿‡å¤§æ—¶ï¼ŒHPA å¯èƒ½ä¸èƒ½å¾ˆå¥½çš„æ”¹å˜å‰¯æœ¬æ•°é‡ã€‚ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Spec HorizontalPodAutoscaler åŸºæœ¬çš„å®šä¹‰å¦‚ä¸‹ï¼š spec:scaleTargetRef:apiVersion:apps/v1kind:Deploymentname:testminReplicas:1maxReplicas:10metrics:- type:Resourceresource:name:cputarget:type:UtilizationaverageUtilization:50behavior:scaleUp:stabilizationWindowSeconds:0selectPolicy:# policies# scaleDown minReplicas - å®šä¹‰è‡ªåŠ¨ç¼©æ‰©å®¹çš„æœ€å°å‰¯æœ¬å€¼ maxReplicas - å®šä¹‰è‡ªåŠ¨ç¼©æ‰©å®¹çš„æœ€å¤§å‰¯æœ¬å€¼ scaleTargetRef - æŒ‡å®š HPA æ“ä½œçš„èµ„æºï¼Œä¾‹å¦‚ Deployment/StatefulSet/ReplicaSet metrics - ç”¨äºè®¡ç®—å‰¯æœ¬å€¼çš„æ•°æ®ï¼Œæ”¯æŒä½¿ç”¨ Kubernetes é›†ç¾¤å†…éƒ¨æ•°æ®ï¼Œæˆ–è€…æ¥è‡ªäº metric æ•°æ® behavior - æ§åˆ¶ç¼©å®¹ä¸æ‰©å®¹çš„è¡Œä¸º ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 ç¼©æ‰©å®¹çš„ç›®æ ‡ HPA åœ¨ç»è¿‡ç®—æ³•è®¡ç®—ï¼Œéœ€è¦å®é™…è¿›è¡Œç¼©æ‰©å®¹æ—¶ï¼Œä¼šè°ƒç”¨å®šä¹‰çš„ç›®æ ‡å¯¹è±¡çš„ scale æ¥å£ã€‚å› æ­¤ï¼Œåªè¦å®ç°äº† scale æ¥å£çš„èµ„æºéƒ½å¯ä»¥ä½œä¸º HPA æ“ä½œçš„ç›®æ ‡å¯¹è±¡ã€‚ä¾‹å¦‚ Deployment å’Œ StatefulSetï¼Œä»¥åŠå®šä¹‰äº† scale subresource çš„ CRDã€‚ åœ¨å®šä¹‰ä¸­ï¼Œé€šè¿‡ spec.scaleTargetRef æ¥å®šä¹‰æ“ä½œçš„ç›®æ ‡å¯¹è±¡ã€‚ spec:scaleTargetRef:apiVersion:apps/v1kind:Deploymentname:test ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 Metric æŒ‡æ ‡ HPA æ”¯æŒè¯»å– Kubernetes å†…ç½®çš„æˆ–è€…ç¬¬ä¸‰æ–¹çš„ Metric æŒ‡æ ‡ï¼Œæ¥è¿›è¡Œå‰¯æœ¬çš„è®¡ç®—ã€‚ HPA ä¼šé€šè¿‡è®¿é—® Kubernetes APIServer çš„ç‰¹å®šæ¥å£è¯»å– Metric å€¼ï¼Œä½†æ˜¯è¿™äº› Metric çš„æ¥å£éƒ½ä¸æ˜¯ Kubernetes APIServer å†…ç½®çš„ï¼Œéœ€è¦ç”¨æˆ·å…ˆéƒ¨ç½²æä¾›æ¥å£çš„ Custom APIServerï¼ˆAggregate APIServerï¼‰ã€‚ HPA æ ¹æ®ä¸åŒç±»å‹çš„ Metric æŒ‡æ ‡ï¼Œä¼šè¯·æ±‚ä¸åŒçš„æ¥å£ã€‚ Resource æŒ‡æ ‡ - CPU/Mem èµ„æºç›¸å…³ï¼Œä¼šè¯·æ±‚ metrics.k8s.io æ¥å£ Kubernetes æä¾›äº†å®ç° metrics-server å¯ä»¥ç›´æ¥éƒ¨ç½²ä½¿ç”¨ã€‚ Custom æŒ‡æ ‡ - è‡ªå®šä¹‰ Kubernetes é›†ç¾¤å†…éƒ¨çš„æŒ‡æ ‡ï¼Œä¼šè¯·æ±‚ custom.metrics.k8s.io æ¥å£ å…¶ä»–æŒ‡æ ‡ä¼šæä¾›åä¸º â€œAdapterâ€ ä½œä¸º Custom APIServer å®ç°ã€‚å¦‚æœæƒ³è‡ªå·±ç¼–å†™ï¼Œå¯ä»¥å‚è€ƒ ç¤ºä¾‹é¡¹ç›® å¼€å§‹ã€‚ External æŒ‡æ ‡ - ä» Kubernetes é›†ç¾¤å¤–éƒ¨å¾—åˆ°çš„æŒ‡æ ‡ï¼ˆä¾‹å¦‚ä»äº‘å‚å•†çš„æ•°æ®ï¼‰ï¼Œä¼šè¯·æ±‚ external.metrics.k8s.io æ¥å£ ä¾æ—§ç”±åä¸º â€œAdapterâ€ çš„ Custom APIServer å®ç°ã€‚è‡ªè¡Œç¼–å†™ä¸ Custom æŒ‡æ ‡ä¸€æ ·ã€‚ ä¸Šé¢ä¸åŒçš„ Metric æŒ‡æ ‡ä½“ç°åœ¨ spec.metrics å­—æ®µï¼š spec:metrics:- type:Resourceresource:name:cputarget:type:UtilizationaverageUtilization:50 å…¶ä¸­ type å­—æ®µæŒ‡æ˜äº†æŒ‡æ ‡çš„ç±»å‹ï¼Œä¸åŒç±»å‹çš„æŒ‡æ ‡ä¼šä½¿ç”¨ä¸åŒçš„å­—æ®µã€‚ Resource -ï¼ˆResource æŒ‡æ ‡ï¼‰ç›®æ ‡å¯¹è±¡çš„ Pod çš„ CPU/Mem æŒ‡æ ‡ã€‚ å¯¹äº CPUï¼Œä»…æ”¯æŒ target è®¾ç½®ä¸º type: Utilizationï¼Œæ¥è®¾ç½® CPU çš„å¹³å‡ä½¿ç”¨ç‡ã€‚ å¯¹äº Memï¼Œä»…æ”¯æŒ target è®¾ç½®ä¸º type: AverageValueï¼Œæ¥è®¾ç½® Mem çš„å¹³å‡ä½¿ç”¨å€¼ã€‚ type:Resourceresource:name:cputarget:type:UtilizationaverageUtilization:60 ContainerResource -ï¼ˆResource æŒ‡æ ‡ï¼‰ç›®æ ‡å¯¹è±¡çš„ Pod çš„æŸä¸ª Container çš„ CPU/Mem æŒ‡æ ‡ã€‚ å¯¹äº CPUï¼Œä»…æ”¯æŒ target è®¾ç½®ä¸º type: Utilizationï¼Œæ¥è®¾ç½® CPU çš„å¹³å‡ä½¿ç”¨ç‡ã€‚ å¯¹äº Memï¼Œä»…æ”¯æŒ target è®¾ç½®ä¸º type: AverageValueï¼Œæ¥è®¾ç½® Mem çš„å¹³å‡ä½¿ç”¨å€¼ã€‚ type:ContainerResourcecontainerResource:name:cpucontainer:application# é’ˆå¯¹ Pod ä¸­çš„ application å®¹å™¨target:type:UtilizationaverageUtilization:60 Pods -ï¼ˆCustom æŒ‡æ ‡ï¼‰ä¼¸ç¼©å¯¹è±¡çš„ Pod æŒ‡æ ‡ï¼Œä¾‹å¦‚ metrics-server æä¾› Pod çš„æ¯ç§’æ”¶åŒ…æŒ‡æ ‡ã€‚ ä»…æ”¯æŒ target è®¾ç½®ä¸º type: AverageValueã€‚ type:Podspods:metric:name:packets-per-secondtarget:type:AverageValueaverageValue:1k Object -ï¼ˆCustom æŒ‡æ ‡ï¼‰ä¸€äº› Kubernetes é›†ç¾¤çš„å¯¹è±¡çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚ metrics-server æä¾›äº† Ingress çš„ QPS æŒ‡æ ‡ã€‚ ä»…æ”¯æŒ target è®¾ç½®ä¸º type: AverageValue å’Œ type:Valueã€‚ type:Objectobject:metric:name:requests-per-seconddescribedObject:apiVersion:networking.k8s.iokind:Ingressname:main-routetarget:type:Valuevalue:2k External -ï¼ˆExternal æŒ‡æ ‡ï¼‰é Kubernetes åŸç”Ÿå¯¹è±¡çš„æŒ‡æ ‡ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 Behavior spec.behavior å­—æ®µç”¨ä»¥æ§åˆ¶ HPA Controller è¿›è¡Œç¼©æ‰©å®¹çš„è¡Œä¸ºã€‚ behavior:scaleDown:stabilizationWindowSeconds:300policies:- type:Percentvalue:100periodSeconds:15scaleUp:stabilizationWindowSeconds:0policies:- type:Percentvalue:100periodSeconds:15- type:Podsvalue:4periodSeconds:15selectPolicy:Max å…¶ä¸­ï¼ŒscaleDown ä¸ scaleUp å…·æœ‰ç›¸åŒçš„å­—æ®µï¼Œä¸€ä¸ªç”¨äºæ§åˆ¶ç¼©å®¹è¡Œä¸ºï¼Œå¦ä¸€ä¸ªæ§åˆ¶æ‰©å®¹è¡Œä¸ºã€‚ 2.3.1 ç¼©æ‰©ç­–ç•¥ policies å­—æ®µç”¨äºå®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªç¼©æ‰©ç­–ç•¥ã€‚å½“æŒ‡å®šå¤šä¸ªç¼©æ‰©ç­–ç•¥æ—¶ï¼Œä¼šé€‰æ‹©ç®—å‡ºç¼©æ‰©å‰¯æœ¬æ•°æœ€å¤šçš„ç­–ç•¥ã€‚ ä¸‹é¢çš„é…ç½®ç­‰äºé»˜è®¤çš„ç¼©æ‰©è¡Œä¸ºï¼š behavior:scaleDown:stabilizationWindowSeconds:300policies:- type:Percentvalue:100periodSeconds:15scaleUp:stabilizationWindowSeconds:0policies:- type:Percentvalue:100periodSeconds:15- type:Podsvalue:4periodSeconds:15selectPolicy:Max type è¡¨ç¤ºç­–ç•¥çš„æ§åˆ¶ç»´åº¦ï¼ŒperiodSeconds è¡¨ç¤ºè®¡ç®—è¯¥ç­–ç•¥çš„æ—¶é—´åŒºé—´ï¼Œvalue è¡¨ç¤ºæœ€å¤§æ•°å€¼ã€‚ ç›®å‰æ”¯æŒä¸¤ç§æ–¹å¼ï¼ˆtypeï¼‰çš„æ§åˆ¶ï¼š Pods - æ§åˆ¶æ¯æ¬¡ç¼©æ‰©çš„æœ€å¤§å…è®¸æ•°é‡ Percent - æ§åˆ¶æ¯æ¬¡ç¼©æ‰©çš„æœ€å¤§æ¯”ä¾‹ ä»¥ä¸Šè¿°é…ç½®ä¸ºä¾‹ï¼Œç¬¬ä¸€ä¸ªç­–ç•¥è¡¨ç¤º 60s å†…æœ€å¤šå…è®¸ç¼©å®¹ 4 ä¸ªå‰¯æœ¬ï¼Œç¬¬äºŒä¸ªç­–ç•¥è¡¨ç¤º 60s å†…æœ€å¤šç¼©å®¹å½“å‰å‰¯æœ¬æ•°çš„ 10%ã€‚ 2.3.2 ç¼©æ‰©ç­–ç•¥é€‰æ‹© selectPolicy å­—æ®µç”¨äºæ§åˆ¶æ¯æ¬¡é€‰æ‹©ç¼©æ‰©ç­–ç•¥çš„è¡Œä¸ºï¼Œæ”¯æŒï¼š Max -ï¼ˆé»˜è®¤ï¼‰å¤šä¸ªç­–ç•¥ä¸‹ï¼Œé€‰æ‹©å‰¯æœ¬å˜åŒ–æœ€å¤§çš„ç­–ç•¥ã€‚ Min - å¤šä¸ªç­–ç•¥ä¸‹ï¼Œé€‰æ‹©å‰¯æœ¬å˜åŒ–æœ€å°çš„ç­–ç•¥ã€‚ Disabled - ä¸è¿›è¡Œç¼©æˆ–è€…æ‰© 2.3.3 ç¨³å®šçª—å£ å½“ Metric æŒç»­æŠ–åŠ¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç¨³å®šçª—å£æ¥é™åˆ¶å‰¯æœ¬æ•°ä¸Šä¸‹æŒ¯åŠ¨ã€‚ç¼©æ‰©ç®—æ³•åœ¨æ‰§è¡Œç¼©æ‰©æ—¶ï¼Œä¼šè€ƒè™‘è¿‡å»è®¡ç®—è¿‡çš„æœŸæœ›çŠ¶æ€ã€‚stabilizationWindowSeconds ç”¨äºæŒ‡å®šè€ƒè™‘è¿‡å»å¤šä¹…çš„æœŸæœ›çŠ¶æ€ã€‚ scaleDown:stabilizationWindowSeconds:300 è¿™é‡Œè¡¨ç¤ºï¼Œè¿‡å» 5min çš„æ‰€æœ‰æœŸæœ›çŠ¶æ€éƒ½ä¼šè¢«è®¡ç®—ã€‚å¦‚æœç¨³å®šçª—å£ä¸º 0 æ—¶ï¼Œè¡¨æ˜å½“å‰ç®—æ³•è®¡ç®—å‡ºç¼©å®¹æ—¶ä¼šç«‹å³æ‰§è¡Œã€‚ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 Status ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 Condition status.conditions å­—æ®µå±•ç¤ºäº† HPA æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œç¼©æ‰©ï¼Œä»¥åŠå—åˆ°äº†å“ªäº›çš„é™åˆ¶ã€‚ Conditions: Type Status Reason Message ---- ------ ------ ------- AbleToScale True ReadyForNewScale the last scale time was sufficiently old as to warrant a new scale ScalingActive True ValidMetricFound the HPA was able to successfully calculate a replica count from pods metric http_requests ScalingLimited False DesiredWithinRange the desired replica count is within the acceptable range AbleToScale è¡¨ç¤º HPA æ˜¯å¦èƒ½å¤Ÿè·å–å’Œæ›´æ–°ç¼©æ‰©ä¿¡æ¯ï¼Œä»¥åŠæ˜¯å¦å­˜åœ¨é˜»æ­¢ç¼©æ‰©çš„é™åˆ¶æ¡ä»¶ã€‚ ScalingActive è¡¨ç¤º HPA æ˜¯å¦å¯ç”¨ï¼Œä»¥åŠæ˜¯å¦èƒ½å¤Ÿå®Œæˆç¼©æ‰©è®¡ç®—ã€‚å½“ä¸º False æ—¶ï¼Œé€šå¸¸ä¸ºè·å– Metric å‡ºç°ç¨³å®šã€‚ ScalingLimited è¡¨æ˜ç¼©æ‰©å€¼æ˜¯å¦è¾¾åˆ°äº†é™åˆ¶å€¼ï¼ˆæœ€å¤§æœ€å°é™åˆ¶å€¼ï¼‰ã€‚é€šå¸¸è¿™è¡¨æ˜å¯èƒ½éœ€è¦è°ƒæ•´ maxReplicas æˆ– minReplicasã€‚ ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ Doc: Horizontal Pod Autoscaling ","date":"2021-12-20","objectID":"/posts/cloud_computing/k8s_learning/12-hpa/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 12 - Horizontal Pod Autoscaler","uri":"/posts/cloud_computing/k8s_learning/12-hpa/"},{"categories":["AWS å­¦ä¹ "],"content":"1 Storage Type ä¸ºäº†ä¸åŒçš„å­˜å‚¨åœºæ™¯ï¼ŒS3 æä¾›äº†å¤šç§ç±»å‹çš„å­˜å‚¨ç±»å‹ã€‚ å­˜å‚¨ç±»å‹ ä½¿ç”¨åœºæ™¯ S3 Standard ç»å¸¸è®¿é—®çš„æ•°æ® S3 Intelligent-Tiering åŠ¨æ€è‡ªåŠ¨ä¼˜åŒ–è®¿é—®æ¨¡å¼ S3 Standard-IA ä¸ç»å¸¸è®¿é—®æ•°æ®ï¼Œä¼šè·¨å¤šä¸ª AZ å­˜å‚¨å†—ä½™ä¿å­˜æ•°æ® S3 One Zone-IA ä¸ç»å¸¸è®¿é—®æ•°æ®ï¼Œä½†æ²¡æœ‰å¤š AZ æ•°æ®å¤‡ä»½ S3 Glacier å½’æ¡£æ•°æ®ï¼Œè§£å†»æ•°æ®æ—¶é—´ä¸º 1-5 åˆ†é’Ÿ S3 Deep Archive æ·±åº¦å½’æ¡£æ•°æ®ï¼Œè§£å†»æ•°æ®æ—¶é—´ä¸º 12 å°æ—¶ å„ä¸ªå­˜å‚¨ç±»å‹çš„å®šä»·è§ Amazon S3 å®šä»·ã€‚ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"2 å­˜å‚¨ç®¡ç† ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"2.1 S3 Lifecycle S3 Lifecycle å®šä¹‰ä¸€ç»„è§„åˆ™ï¼Œç”¨äºé…ç½® Bucket è‡ªåŠ¨å¯¹ç‰¹å®šå¯¹è±¡çš„æ“ä½œã€‚æ“ä½œåŒ…æ‹¬ï¼š Transition - å®šä¹‰å°†å¯¹è±¡è½¬æ¢ä¸ºå¦ä¸€ä¸ª Storage Type çš„æ—¶é—´ã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥é€‰æ‹©åœ¨å¯¹è±¡åˆ›å»º 30 å¤©åå°†å…¶è½¬æ¢ä¸º S3 Standard-IAï¼Œåˆ›å»º 1 å¹´åä½¿ç”¨ S3 Glacier å­˜å‚¨ã€‚ Expiration - å®šä¹‰å¯¹è±¡çš„è¿‡æœŸæ—¶é—´ï¼ŒS3 å°†è‡ªåŠ¨åˆ é™¤è¿‡æœŸçš„å¯¹è±¡ã€‚ S3 Lifecycle å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼é…ç½®ã€‚ä¾‹å¦‚ä½¿ç”¨ CLI é…ç½® JSON æ–‡ä»¶ï¼š { \"Rules\": [ { \"Filter\": { \"Prefix\": \"documents/\" }, \"Status\": \"Enabled\", \"Transitions\": [ { \"Days\": 365, \"StorageClass\": \"GLACIER\" } ], \"Expiration\": { \"Days\": 3650 }, \"ID\": \"ExampleRule\" } ] } Filter - è®¾ç½®åº”ç”¨ Bucket æ–‡ä»¶ä¸­çš„æ–‡ä»¶èŒƒå›´ã€‚æ”¯æŒé€šè¿‡ prefix æˆ–è€… tag è¿›è¡Œç­›é€‰ã€‚ Status - å¼€å¯æˆ–å…³é—­ Transitions - Enabled/Disabledï¼Œå®šä¹‰ Transition è§„åˆ™ Expiration - å®šä¹‰ Expiration è§„åˆ™ 2.1.1 Transition Transition æ”¯æŒè‡ªåŠ¨åœ¨ä¸åŒ Storage Type è½¬æ¢ï¼Œä»¥èŠ‚çœå­˜å‚¨æˆæœ¬ã€‚ 2.1.2 Expiration å½“æ–‡ä»¶æ»¡è¶³ Expiration å®šä¹‰çš„æ—¶é—´åï¼ŒS3 ä¼šå°†å…¶è‡ªåŠ¨åˆ é™¤ã€‚ å¦‚æœéœ€è¦çŸ¥æ™“ä¸€ä¸ªæ–‡ä»¶çš„è¿‡æœŸæ—¶é—´ï¼Œä½ å¯ä»¥é€šè¿‡ HEAD/GET HTTP è®¿é—®æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°æ–‡ä»¶è®¡åˆ’è¿‡æœŸæ—¶é—´çš„ HEADã€‚ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:2:1","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"2.2 Object Lock é€šè¿‡ Object Lock åŠŸèƒ½ï¼Œå¯ä»¥é˜²æ­¢å¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡å†™å…¥åä¸å†å…è®¸ä¿®æ”¹æˆ–è€…åˆ é™¤ã€‚ Object Lock æ”¯æŒä¸¤ç§æ–¹å¼é”å®šæ–¹å¼ï¼š Retention period - æŒ‡å®šå¯¹è±¡åœ¨ä¸€æ®µæ—¶é—´å†…é”å®š Legal hold - å¯¹è±¡æ°¸ä¹…ä¿ç•™ï¼ˆç›´åˆ°æ˜ç¡®ç§»é™¤ Legal holdï¼‰ Object Lock åªèƒ½åœ¨åˆ›å»º Bucket æ—¶å€™å¼€å¯ï¼Œåˆ›å»ºåæ— æ³•ä¿®æ”¹ã€‚å¹¶ä¸”ï¼ŒObject Lock å¿…é¡»å¼€å¯ Object çš„ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ã€‚ 2.2.1 ä½¿ç”¨æ–¹å¼ åˆ›å»º S3 Bucket æ—¶å¼€å¯ Object Lock åŠŸèƒ½ã€‚ ä¸Šä¼ æ–‡ä»¶åˆ° Bucketï¼ˆå¦‚æœä½¿ç”¨ AWS CLI/SDKï¼Œå¯ä»¥åœ¨ä¸Šä¼ æ–‡ä»¶æ—¶æŒ‡å®š Object Lock å‚æ•°ï¼‰ã€‚ åœ¨ Console ä¿®æ”¹ object propertiesï¼Œåº”ç”¨ Retention Period æˆ–è€… Legal hold ä¿ç•™æ¨¡å¼ã€‚ 2.2.2 Retention Period Retention Period æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š Governance mode - å…·æœ‰æƒé™çš„ IAM User å¯ä»¥ä¿®æ”¹é”å®šè®¾ç½®ï¼Œå¹¶ä¸”å¯ä»¥è°ƒæ•´ä¿ç•™æœŸé™ Compliance mode - ä»»ä½• Userï¼ˆåŒ…æ‹¬ root userï¼‰éƒ½æ— æ³•è¦†ç›–æˆ–åˆ é™¤å—ä¿æŠ¤çš„ objectï¼ŒæœŸé™ä¹Ÿæ— æ³•ä¿®æ”¹ Retention Period å…è®¸åœ¨ä¸€å®šæ—¶é—´å†…é”å®šå¯¹è±¡ã€‚å¼€å¯ Retention Period åï¼ŒS3 ä¼šåœ¨å¯¹è±¡ç‰ˆæœ¬çš„å…ƒä¿¡æ¯ä¸­å­˜å‚¨ Retain Until Dateï¼Œä»¥è¡¨æ˜ object çš„åˆ°æœŸæ—¶é—´æˆ³ã€‚å½“å¯¹è±¡ä¿ç•™æ—¶æœŸåˆ°æœŸåï¼Œä¾¿å¯ä»¥è¦†ç›–æˆ–åˆ é™¤ objectã€‚ Retention Period å¯ä»¥é€‚ç”¨å¯¹ object çš„å„ä¸ª versionï¼Œæ¯ä¸ª object çš„ version å¯ä»¥æœ‰ç€ä¸åŒçš„ä¿ç•™æ¨¡å¼å’Œå‘¨æœŸã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°† object ä¿ç•™ä¸º 15 å¤©ï¼Œä¹‹åå°†åŒå object å­˜å…¥ S3 å¹¶ä¿ç•™ 60 å¤©ï¼Œè¿™æ · S3 å°†åˆ›å»ºä¸€ä¸ªä¿ç•™ 60 å¤©çš„ objectï¼Œæ—§ç‰ˆæœ¬ object ä¿æŒåŸæ¥å¯¹çš„ä¿ç•™æœŸé™ã€‚ é€šè¿‡å¯¹å¯¹è±¡æäº¤æ–°çš„é”å®šè¯·æ±‚ï¼Œå°±å¯ä»¥æ›´æ–° object çš„ Retan Until Dateã€‚ 2.2.3 Legal hold Legal hold ä¹Ÿå¯ä»¥é˜²æ­¢ object version è¢«è¦†ç›–æˆ–è€…åˆ é™¤ï¼Œä¸è¿‡ Legal hold æ¨¡å¼æ²¡æœ‰å…³è”ä¿å­˜æœŸé™ã€‚ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:2:2","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"2.3 Replication ä½¿ç”¨ Replication çš„åœºæ™¯ï¼š å¤åˆ¶ Objectï¼Œå¹¶ä¿ç•™å…ƒä¿¡æ¯ å¯ä»¥ä½¿ç”¨ Replication æ¥å¯¹ Object åˆ›å»ºå‰¯æœ¬ï¼Œå¹¶ä¸”ä¼šä¿ç•™ Object çš„æ‰€æœ‰å…ƒä¿¡æ¯ï¼ˆObject åˆ›å»ºæ—¶é—´ï¼Œç‰ˆæœ¬ç­‰ï¼‰ã€‚ å°† Object å¤åˆ¶åˆ°ä¸åŒçš„ Storage Type çš„ Bucket åœ¨ Storage Type ä¸­ä»‹ç»äº†å„ç§çš„å­˜å‚¨ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ Replication å°† Object å¤åˆ¶åˆ°å…¶ä»–å­˜å‚¨ç±»å‹çš„ Bucketã€‚ ç»´æŠ¤ Object å¤šä¸ªå‰¯æœ¬ï¼Œæ¯ä¸ªå‰¯æœ¬æä¾›ç»™ç”¨æˆ·ä¸åŒçš„è®¿é—®æƒé™ æ— è®ºè°åˆ›å»ºäº† Objectï¼Œä½ å¯ä»¥å°†å…¶ Object å¤åˆ¶åˆ°ç›®æ ‡ Bucketï¼Œå¹¶ä¿®æ”¹ Object çš„æ‰€å±è´¦æˆ·ï¼Œè¿™è¢«ç§°ä¸º owner overrideã€‚ä¹‹åï¼Œä½ å¯ä»¥é™åˆ¶å¯¹ Object å‰¯æœ¬çš„è®¿é—®æƒé™ã€‚ å°† Object ä¿å­˜åœ¨å¤šä¸ª Region åœ¨å¤šä¸ª Region è®¾ç½®å¤šä¸ª Bucketï¼Œç„¶åé€šè¿‡ Replication ä¿å­˜ç›¸åŒçš„ Objectã€‚è¿™å¯èƒ½æœ‰åŠ©äºæ»¡è¶³åˆè§„æ€§è¦æ±‚ã€‚ 15 åˆ†é’Ÿå†…å¤åˆ¶ Object å¯ä»¥ä½¿ç”¨ S3 Replication Time Controlï¼ˆç®€ç§° RTCï¼‰åœ¨ä¸€å®šæ—¶é—´å†…å®Œæˆ Replicationã€‚S3 RTC åœ¨ 15 åˆ†é’Ÿå†…å¤åˆ¶ S3 ä¸­å­˜å‚¨çš„ 99.99% çš„æ–°å¯¹è±¡ã€‚ 2.3.1 å‰ææ¡ä»¶ ä½¿ç”¨ Replication å¿…é¡»æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š æº Bucket æ‹¥æœ‰è€…çš„è´¦æˆ·å¿…é¡»å¼€å¯æº Region ä¸ç›®æ ‡ Regionï¼Œç›®æ ‡ Bucket æ‹¥æœ‰è€…çš„è´¦æˆ·å¿…é¡»å¼€å¯ç›®æ ‡ Regionã€‚ æº Bucket å’Œç›®æ ‡ Bucket å¿…é¡»éƒ½å¼€å¯ Version Controlã€‚ S3 å¿…é¡»æœ‰è¶³å¤Ÿçš„æƒé™å°†æº Bucket å¤åˆ¶åˆ°ç›®æ ‡ Bucketã€‚ æº Bucket çš„æ‹¥æœ‰è€…å¿…é¡»æœ‰æ‰€æœ‰ Object çš„ READ å’Œ READ_ACP æƒé™ï¼ˆé€šè¿‡ Object ACL å¯ä»¥å¼€å¯ï¼‰ã€‚ å¦‚æœæº Bucket å¼€å¯äº† Object Lockï¼Œé‚£ä¹ˆç›®æ ‡ Bucket ä¹Ÿå¿…é¡»å¼€å¯ Object Lockã€‚ å½“è·¨è´¦æˆ·å¤åˆ¶ Bucket æ—¶ï¼Œæœ‰ä¸€äº›é¢å¤–çš„è¦æ±‚ï¼š ç›®æ ‡ Bucket çš„æ‹¥æœ‰è€…å¿…é¡»æä¾›ç»™æº Bucket çš„æ‹¥æœ‰è€…å¤åˆ¶ Object çš„æƒé™ã€‚å‚è€ƒï¼šå½“æºå­˜å‚¨æ¡¶å’Œç›®æ ‡å­˜å‚¨æ¡¶ç”±ä¸åŒçš„ AWS è´¦æˆ·æ‹¥æœ‰æ—¶æˆäºˆæƒé™ã€‚ ç›®æ ‡ Bucket ä¸èƒ½é…ç½®ä¸º Requester Pays Bucketã€‚ 2.3.2 å¤åˆ¶çš„å†…å®¹ é»˜è®¤ä¸‹ï¼ŒS3 ä¼šå¤åˆ¶ Bucket ä¸­çš„ä»¥ä¸‹å†…å®¹ï¼š é…ç½® Replication åï¼Œæ–°æ·»åŠ çš„ Object æœªåŠ å¯†çš„ Object ä½¿ç”¨ SSE-S3 æˆ–è€… SSE-KMS é™æ€åŠ å¯†çš„ Objectï¼ˆå¦‚æœè¦å¤åˆ¶è¿™äº›åŠ å¯† Objectï¼Œå¿…é¡»æ˜¾å¼å¯ç”¨è¯¥é€‰é¡¹ï¼‰ Object å…ƒæ•°æ® ä»…é™æº Bucket æ‹¥æœ‰è€…å…·ä½“è¯»å–æƒé™çš„ Object Object ACL çš„æ›´æ–° Object Tag Object Lock çš„ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ é»˜è®¤ä¸‹ï¼ŒS3 ä¸ä¼šå¤åˆ¶ Bucket ä¸­çš„ä»¥ä¸‹å†…å®¹ï¼š é…ç½® Replication ä¹‹å‰å­˜åœ¨çš„ Objectï¼Œå³ S3 ä¸ä¼šå¤åˆ¶å·²ç»å­˜åœ¨çš„ Object å¤åˆ¶çš„ Object ä¸ä¼šä¼ é€’ã€‚ä¾‹å¦‚ï¼ŒBucket A å¤åˆ¶åˆ° Bucket Bï¼ŒBucket B å¤åˆ¶åˆ° Bucket Cï¼Œè¿™ç§æƒ…å†µä¸‹å¤åˆ¶åˆ° Bucket B çš„ Object ä¸ä¼šå¤åˆ¶åˆ° Bucket C å·²ç»è¢«å¤åˆ¶çš„ Objectã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¿®æ”¹äº† Replication çš„ç›®æ ‡ Bucketï¼Œé‚£ä¹ˆ S3 ä¸ä¼šå¤åˆ¶å·²ç»æ—§çš„ Object ä½¿ç”¨ SSE-C åŠ å¯†çš„ Object ä»ä¸åŒçš„ AWS è´¦æˆ·åˆ é™¤æ ‡è®°å¤åˆ¶æ—¶ï¼Œæ·»åŠ åˆ°å­˜å‚¨æ¡¶çš„åˆ é™¤æ ‡è®°ä¸ä¼šè¢«å¤åˆ¶ S3 Glacier æˆ– S3 Glacier Deep Archive ä¸­çš„ Object ä¸å…è®¸å¤åˆ¶ æº Bucket æ‹¥æœ‰è€…æ²¡æœ‰æƒé™è®¿é—®çš„ Object S3 Lifecycle æ ‡è®°ã€‚ä¾‹å¦‚ï¼Œå¯ç”¨ Lifecycle ä¼šå¯¹ Object åˆ›å»ºåˆ é™¤æ ‡è®°ï¼Œä½†æ˜¯ Replication ä¸ä¼šå¤åˆ¶è¿™äº›æ ‡è®°ã€‚ å¦‚æœä½ éœ€è¦å¤åˆ¶å·²ç»ä¿å­˜çš„ Objectï¼Œéœ€è¦è”ç³» AWS Supportã€‚ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:2:3","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"2.4 Batch Operation S3 Batch Operation å¯ä»¥å¯¹ S3 æ‰§è¡Œå¤§è§„æ¨¡çš„æ‰¹é‡æ“ä½œï¼ŒS3 å¯ä»¥æä¾›å®Œå…¨æ‰˜ç®¡çš„æ— æœåŠ¡å™¨ä½“éªŒï¼Œå¹¶æä¾›é€šçŸ¥ä¸è¯¦ç»†çš„å®ŒæˆæŠ¥å‘Šã€‚ Batch Operation çš„æœ¯è¯­å¦‚ä¸‹ï¼š Job - S3 Batch Operation çš„åŸºæœ¬å·¥ä½œå•å…ƒï¼ŒJob ä¸­åŒ…å«è¿è¡Œæ“ä½œçš„å…¨éƒ¨ä¿¡æ¯ã€‚åœ¨ Job å¼€å§‹åï¼ŒJob ä¼šä¸ºæ¸…å•ä¸­çš„æ¯ä¸ª Object æ‰§è¡Œæ“ä½œã€‚ Operation - å¯¹ Object æ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚å¤åˆ¶ Objectã€‚å¯¹äºæ¸…å•ä¸­æŒ‡å®šçš„æ‰€æœ‰ Objectï¼Œæ¯ä¸ª Job åªèƒ½æ‰§è¡Œä¸€ç§ Operationã€‚ Task - Task æ˜¯ Job çš„æ‰§è¡Œå•å…ƒï¼ŒTask è¡¨ç¤ºå¯¹ S3 æˆ–è€… Lambda çš„ä¸€ä¸ª API è°ƒç”¨ã€‚åœ¨ Job æ•´ä¸ªçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒBatch Operation ä¼šä¸ºæ¯ä¸ª Object åˆ›å»ºä¸€ä¸ª Taskã€‚ Manifest - åŒ…å« Job éœ€è¦æ“ä½œçš„ Object çš„æ¸…å•ã€‚ 2.4.1 ä½¿ç”¨æ–¹å¼ åˆ›å»º Batch Operation Job æ—¶ï¼Œéœ€è¦æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š Operation - æŒ‡å®šå¯¹ Object çš„æ“ä½œã€‚ Manifest - éœ€è¦æ“ä½œçš„ Object çš„åˆ—è¡¨ï¼ŒManifest æ–‡ä»¶éœ€è¦å­˜å‚¨åœ¨ S3 Bucket ä¸­ã€‚ Priority - Job åœ¨è´¦æˆ·ä¸­å¯¹æ¯”ä¸å…¶ä»– Job çš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚ä½†æ˜¯ï¼Œä¼˜å…ˆçº§ä¸ä»£è¡¨ Job ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ RoleArn - è¿è¡Œ Job ä½¿ç”¨çš„ IAM Roleï¼Œå¿…é¡»è¦æœ‰è¶³å¤Ÿçš„æƒé™æ‰§è¡Œæ“ä½œã€‚ Report - æŒ‡ç¤ºæ˜¯å¦éœ€è¦ç”Ÿæˆå®ŒæˆæŠ¥å‘Šã€‚ä½ å¯ä»¥é…ç½®æŠ¥å‘Šçš„æ ¼å¼ã€ä¿¡æ¯ç­‰ã€‚ Tags Description ä½¿ç”¨ Batch Operation çš„åŸºæœ¬æµç¨‹ä¸ºï¼š åˆ›å»º Manifestã€‚ åˆ›å»ºå¹¶è¿è¡Œ Jobã€‚åˆ›å»ºæˆåŠŸåï¼ŒS3 å°†è¿”å›ä¸€ä¸ª Job IDã€‚ æŸ¥çœ‹æŠ¥å‘Š 2.4.2 æ”¯æŒçš„æ“ä½œ Batch Operation æ”¯æŒçš„æ“ä½œåŒ…æ‹¬ï¼š Copy å¤åˆ¶ Manifest ä¸­çš„æ¯ä¸ª Objectï¼Œå¯ä»¥å¤åˆ¶åˆ°ç›¸åŒæˆ–ä¸åŒ Region çš„ Bucketã€‚å¤åˆ¶çš„åŒæ—¶ï¼Œè¿˜æ”¯æŒé¢å¤–çš„æ“ä½œé€‰é¡¹ï¼ŒåŒ…æ‹¬è®¾ç½® Object å…ƒæ•°æ®ã€è®¾ç½®æƒé™æˆ–è€…æ›´æ”¹å­˜å‚¨ç±»å‹ã€‚ Invoke AWS Lambda function è°ƒç”¨æŒ‡å®šçš„ AWS Lambda å‡½æ•°ï¼Œæ¥å¯¹ Manifest ä¸­çš„ Object æ‰§è¡Œè‡ªå®šä¹‰æ“ä½œã€‚Batch Operation ä¼šå¯¹æ¯ä¸ª Object è¿è¡Œ Lambda å‡½æ•°ï¼ˆLambdaInvoke APIï¼‰ã€‚ Replace all object tags æ›¿æ¢ Manifest ä¸­çš„æ¯ä¸ª Object çš„ Tagã€‚ Delete all object tags åˆ é™¤ Manifest ä¸­æ¯ä¸ª Object çš„æ‰€æœ‰ Tagï¼Œä¸æ”¯æŒä¿ç•™ Tagã€‚ Replace access control list æ›¿æ¢ Manifest ä¸­æ¯ä¸ª Object çš„ ACLã€‚ Restore è¿˜åŸ Manifest ä¸­æ¯ä¸ª Objectï¼Œè¯¥æ“ä½œä¸»è¦ç”¨äºè¿˜åŸ S3 Glacier è¿™ç±»éœ€è¦ â€œè§£å†»â€ çš„å­˜å‚¨ç±»ä¸­çš„ Objectã€‚ Object Lock retention å¯¹ Manifest ä¸­çš„æ¯ä¸ª Object æ‰§è¡Œ Lock retentionã€‚ Object Lock legal hold å¯¹ Manifest ä¸­çš„æ¯ä¸ª Object æ‰§è¡Œ Lock legal holdã€‚ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:2:4","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"3 è®¿é—®æ§åˆ¶ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"3.1 è®¿é—®æƒé™æ§åˆ¶ é»˜è®¤ä¸‹ï¼ŒS3 èµ„æºï¼ˆBucketã€Object å’Œå…¶ä»–å­èµ„æºï¼‰éƒ½æ˜¯ç§æœ‰çš„ï¼Œåªæœ‰èµ„æºæ‹¥æœ‰è€…å’Œåˆ›å»ºèµ„æºçš„ AWS è´¦æˆ·å¯ä»¥è®¿é—® S3 èµ„æºã€‚ ä»–äººè¦è®¿é—®ç§æœ‰çš„ S3 èµ„æºï¼Œå¯ä»¥é€šè¿‡æˆäºˆ Identity-based Policy æˆ–è€… Resource-based Policyã€‚ Resource-base Policy å°±æ˜¯åŸºäºåŸºæœ¬çš„ IAM æ¥æˆäºˆç”¨æˆ·è°ƒç”¨ S3 ç›¸å…³æ¥å£çš„æƒé™ã€‚ Identity-based Policy æ˜¯ä»¥ S3 èµ„æºä¸ºå¯¹è±¡ï¼Œæä¾›ç»™è¢«æˆäºˆè€…ç›¸å…³ S3 èµ„æºçš„æƒé™ã€‚åŒ…å«ä¸¤ç§æ–¹å¼ï¼šACL ä¸ Bucket Policyã€‚ 3.1.1 S3 ä¸­çš„èµ„æº S3 ä¸­ï¼ŒBucket ä¸ Object æ˜¯æœ€åŸºæœ¬çš„èµ„æºï¼Œå¹¶ä¸”å®ƒä»¬æœ‰ç€ç›¸å…³çš„å­èµ„æºã€‚ Bucket çš„å­èµ„æºï¼š lifecycle - ç”Ÿå‘½å‘¨æœŸé…ç½®ä¿¡æ¯ website - ä½¿ç”¨ Bucket å­˜å‚¨é™æ€ç½‘ç«™æ—¶çš„é…ç½®ä¿¡æ¯ versioning - Bucket Versioning çš„é…ç½® policy å’Œ acl - ä¿å­˜å­˜å‚¨è®¿é—®æƒé™ä¿¡æ¯ cors - æ”¯æŒé…ç½® Bucket ä»¥å…è®¸è·¨æºè¯·æ±‚ object ownership - å…è®¸ Bucket å–å¾— Bucket ä¸­æ–°å¯¹è±¡çš„æ‰€æœ‰æƒ logging - è¯·æ±‚ S3 ä¿å­˜ Bucket çš„è®¿é—®æ—¥å¿— Object çš„å­èµ„æºï¼š acl - Object è®¿é—®æƒé™ä¿¡æ¯ restore - æ”¯æŒä¸´æ—¶è¿˜åŸ Archive Object é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰èµ„æºçš„æ‹¥æœ‰è€…å¯ä»¥è®¿é—®è¿™äº›èµ„æºã€‚èµ„æºæ‹¥æœ‰è€…æŒ‡çš„æ˜¯åˆ›å»ºèµ„æºçš„ AWS è´¦æˆ·ï¼Œå³ï¼š åˆ›å»º Bucket å’Œä¸Šä¼  Object çš„ AWS è´¦æˆ·æ‹¥æœ‰è¿™äº›èµ„æºã€‚ å¦‚æœä½¿ç”¨ IAM User æˆ–è€… Role ä¸Šä¼  Objectï¼Œé‚£ä¹ˆ User ä¸ Role æ‰€å±çš„ AWS è´¦æˆ·æ‹¥æœ‰è¯¥ Objectã€‚ Bucket æ‹¥æœ‰è€…å¯ä»¥æˆäºˆå…¶ä»–è´¦æˆ·ä¸Šä¼  Object çš„æƒé™ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¸Šä¼  Object çš„è´¦æˆ·æ‹¥æœ‰è¿™äº›å¯¹è±¡ã€‚è€Œ Bucket æ‹¥æœ‰è€…å¯¹è¿™äº› Object æ²¡æœ‰æƒé™ã€‚é™¤äº†ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼š Bucket å®Œå…¨ç”± Bucket æ‹¥æœ‰è€…ä»˜è´¹ï¼Œé‚£ä¹ˆæ‹¥æœ‰è€…æœ‰ç€å®Œå…¨çš„è®¿é—®æƒé™ã€‚ Bucket æ‹¥æœ‰æƒå¯ä»¥å­˜æ¡£æˆ–è¿˜åŸ Objectã€‚ 3.1.2 ACL ACL è¡¨æ˜äº†è¢«æˆæƒè€…ä»¥åŠè¢«æˆæƒçš„æƒé™ï¼Œæ¯ä¸ª Bucket ä¸ Object éƒ½æœ‰å…³è”çš„ ACLã€‚é€šè¿‡ ACLï¼Œä½ å¯ä»¥å‘å…¶ä»– AWS è´¦æˆ·æˆäºˆåŸºæœ¬çš„ R/W æƒé™ã€‚ ä¸‹ä¾‹ ACL è¡¨æ˜äº† Bucket æ‹¥æœ‰è€…æœ‰ç€å®Œå…¨çš„æ§åˆ¶æƒé™ï¼š \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003cAccessControlPolicy xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"\u003e \u003cOwner\u003e \u003cID\u003e*** Owner-Canonical-User-ID ***\u003c/ID\u003e \u003cDisplayName\u003eowner-display-name\u003c/DisplayName\u003e \u003c/Owner\u003e \u003cAccessControlList\u003e \u003cGrant\u003e \u003cGrantee xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"Canonical User\"\u003e \u003cID\u003e*** Owner-Canonical-User-ID ***\u003c/ID\u003e \u003cDisplayName\u003edisplay-name\u003c/DisplayName\u003e \u003c/Grantee\u003e \u003cPermission\u003eFULL_CONTROL\u003c/Permission\u003e \u003c/Grant\u003e \u003c/AccessControlList\u003e \u003c/AccessControlPolicy\u003e 3.1.3 Bucket Policy Bucket Policy æ˜¯é’ˆå¯¹äº Bucket çš„ IAM Policyï¼Œå°†å…¶ç»‘å®šåˆ°å…¶ä»– AWS è´¦æˆ·æˆ–è€… IAM User å°±å¯ä»¥ä½¿å…¶è·å¾—ç›¸åº”çš„æƒé™ã€‚ ä¸‹é¢ Policy å®ä¾‹ï¼Œè¡¨æ˜æˆäºˆå¯¹ä¸€ä¸ª Bucket æ‰€æœ‰å¯¹è±¡çš„åŒ¿åè¯»å–æƒé™ï¼š { \"Version\":\"2012-10-17\", \"Statement\": [ { \"Sid\":\"GrantAnonymousReadPermissions\", \"Effect\":\"Allow\", \"Principal\": \"*\", \"Action\":[\"s3:GetObject\"], \"Resource\":[\"arn:aws:s3:::awsexamplebucket1/*\"] } ] } ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:3:1","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"3.2 Block Public Access é»˜è®¤æƒ…å†µä¸‹ï¼Œæ–° Bucketã€Endpoint å’Œ Object ä¸å…è®¸å…¬æœ‰è®¿é—®ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¿®æ”¹ Bucket Policyã€Endpoint Policy æˆ–è€… Object Permission ä»¥å…è®¸å…¬æœ‰è®¿é—®ã€‚ ç”¨æˆ·ä¹Ÿå¯ä»¥è®¾ç½® Block Public Access è¦†ç›–ä¸Šè¿°å¼€å¯å…¬æœ‰è®¿é—®çš„ç­–ç•¥å’Œæƒé™ã€‚å½“ S3 æ”¶åˆ°è®¿é—® Bucket æˆ– Object çš„è¯·æ±‚æ—¶ï¼Œå®ƒå°†ç¡®è®¤ Bucket æˆ–è€… Bucket æ‹¥æœ‰è€…æ˜¯å¦å¼€å¯äº† Block Public Accessã€‚å¦‚æœè¯·æ±‚æ—¶ Endpoint å‘å‡ºçš„ï¼Œè¿˜ä¼šæ£€æŸ¥ Endpoint çš„ Block Public Access è®¾ç½®ã€‚ å¦‚æœå½“å‰å¼€å¯äº† Block Public Accessï¼Œé‚£ä¹ˆ S3 å°†æ‹’ç»è¯·æ±‚ã€‚ Block Public Access æœ‰å››ç§è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ç»„åˆå°†å…¶åº”ç”¨åˆ° Endpointã€Bucket æˆ–è€…æ•´ä¸ª AWS Accountã€‚å¦‚æœè®¾ç½®åˆ°è´¦æˆ·æ—¶ï¼Œå°†ä¼šåº”ç”¨äºè´¦æˆ·ä¸‹æ‰€æœ‰çš„ Bucket ä¸ Endpointï¼Œå¦‚æœè®¾ç½®åˆ° Bucketï¼Œå°†ä¼šåº”ç”¨åˆ° Bucket å…³è”çš„æ‰€æœ‰ Endpointã€‚ BlockPublicAcls IgnorePublicAcls BlockPublicPolicy RestrictPublicBuckets ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:3:2","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"3.3 è®¿é—®åˆ†æå™¨ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:3:3","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"æ•°æ®å¤„ç† ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:4:0","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"ç›‘æ§ ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:5:0","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"å·¥ä½œåŸç† ","date":"2021-12-06","objectID":"/posts/cloud_computing/aws_learning/8-s3/:6:0","tags":["aws"],"title":"AWS å­¦ä¹  - 8 - S3","uri":"/posts/cloud_computing/aws_learning/8-s3/"},{"categories":["AWS å­¦ä¹ "],"content":"ELB ALB NLB","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"1 LB çš„åŸºæœ¬æ¨¡å‹ ä¸åŒçš„ LB åœ¨ä½¿ç”¨ä¸Šæ˜¯åŸºæœ¬ç›¸åŒçš„ï¼Œéƒ½ä¾æ®ä»¥ä¸‹çš„æ¨¡å‹ï¼š Domain - LB æ‹¥æœ‰ç€ä¸€ä¸ªå”¯ä¸€çš„åŸŸåï¼ŒClient é€šè¿‡è¯¥åŸŸåæ¥è®¿é—® LBã€‚ LB çš„åŸŸåæ˜¯å•ç‚¹çš„ï¼Œä½†æ˜¯åŸŸåå¯¹åº”å¤šä¸ª IPï¼ˆæ¯ä¸ª AZ ä¸€ä¸ª IPï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLB æ‰€åœ¨ Region çš„æ¯ä¸ª AZ éƒ½æœ‰ç€ LB çš„å¤„ç†ç¨‹åºï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚ä¼šè¢«æŸä¸ª AZ çš„ LB å®ä¾‹è¿›è¡Œå¤„ç†ã€‚ Listener - LB åŸŸåä¸‹æ‰©å±•å¤šä¸ª Listenerï¼Œç”¨äºæ ¹æ®è¯·æ±‚çš„ Port æ¥è¿›è¡Œè½¬å‘ã€‚ é€šè¿‡ Listenerï¼ŒClient è¯·æ±‚ä¸€ä¸ª LB æ—¶å¯ä»¥æ ¹æ®è¯·æ±‚çš„ Port ç”±ä¸åŒçš„ Target è¿›è¡Œå¤„ç†ã€‚ Rule - å¦‚æœæ˜¯ ALBï¼Œè¿˜å¯ä»¥ç»™ Listener æ·»åŠ å¤šä¸ª Ruleï¼Œè¿›ä¸€æ­¥æ ¹æ®è¯·æ±‚ä¿¡æ¯ï¼ˆHTTP Pathã€HTTP Method ç­‰ï¼‰æ¥è¿›è¡Œè½¬å‘ã€‚ Target Group - æ¯ä¸ª Listener å¯¹åº”äºä¸€ä¸ª Target Groupï¼ŒåŒ…å«å¤šä¸ªç”¨äºå¤„ç†è¯·æ±‚çš„ Targetã€‚ Target - å¤„ç†è¯·æ±‚çš„å®ä¾‹ï¼Œæœ€å¹³å¸¸çš„å°±æ˜¯ä¸€ä¸ª Instanceã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"2 Domain LB åˆ†ä¸ºä¸¤ç§ Schemeï¼š Internet-facing - é¢å‘å…¬ç½‘çš„ LBï¼Œå…·æœ‰ Public IPï¼Œéœ€è¦éƒ¨ç½²åœ¨ Publich Subnet Internal - å†…ç½‘ LBï¼Œä»…ä»…å…·æœ‰ Private IP æ— è®ºå“ªç§ LBï¼Œåˆ›å»ºåéƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ Domainï¼Œç”¨ä½œè®¿é—® LB çš„å…¥å£ã€‚è¯¥ Domain ä¼šè¢«è§£æä¸ºå…¶æœåŠ¡çš„å¤šä¸ª Subnet çš„ Public/Private IPã€‚ LB çš„ Domain æ ¼å¼ä¸ºï¼š \u003cLB-id\u003e-\u003chash\u003e.elb.\u003cregion\u003e.amazonaws.com ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"3 Listener Listener å°† Domain è®¿é—®æ ¹æ® Protocol + Port åˆ†ä¸ºå¤šä¸ªè·¯ç”±é¡¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¿é—® Domain çš„è¯·æ±‚æ ¹æ® Protocol + Port ç”±ä¸åŒçš„ Listener æ¥å¤„ç†ã€‚ æ¯ä¸ª Listener éœ€è¦æŒ‡å®šï¼š Protocol - åŒ¹é…çš„åè®® å¯¹äº ALBï¼ŒProtocol æ”¯æŒ HTTP ä¸ HTTPsã€‚å¯¹äº NLBï¼ŒProtocol æ”¯æŒ TCPã€TCP_UDPã€TLS ä¸ UDPã€‚ Port - åŒ¹é…çš„ Port Default Action - é»˜è®¤è·¯ç”±çš„ Target Group ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"3.1 Rule å¯¹äº ALBï¼Œåœ¨ Listener èŒƒå›´ä¸‹è¿˜å¯ä»¥æ·»åŠ  Ruleï¼Œè¿›ä¸€æ­¥çš„æ ¹æ®ä¿¡æ¯æ·»åŠ è·¯ç”±é¡¹ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª HTTP 80 ç«¯å£çš„ Listenerï¼Œç„¶ååˆ›å»ºä¸åŒçš„ HTTP Path çš„è·¯ç”±é¡¹ã€‚ æ¯æ¡ Rule æ”¯æŒå¦‚ä¸‹çš„æ–¹å¼è¿›è¡Œç»„åˆï¼š Host Header HTTP Header - è¯·æ±‚çš„ Header HTTP Request Method - è¯·æ±‚çš„ Method Path - è¯·æ±‚çš„ Path Query string Source IP - æº IP åœ°å€ Rule æŒ‰ç…§ç¼–å·ä»å°åˆ°å¤§è¿›è¡ŒåŒ¹é…ï¼Œå½“åŒ¹é…åˆ°äº†ä¹‹åå°±æ‰§è¡Œè·¯ç”±ï¼Œä¸å†åŒ¹é…ã€‚Listener åˆ›å»ºæ—¶æŒ‡å®šçš„è§„åˆ™ä¸º Default Actionï¼Œæ˜¯æœ€åä¸€ä¸ª Ruleã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:3:1","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"4 Target Group æ¯ä¸ª Listener(Rule) éƒ½éœ€è¦ç»‘å®šå¯¹åº”çš„ Target Groupã€‚Target Group æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œç”¨äºè¡¨æ˜æœ‰å“ªäº›åç«¯æœåŠ¡ã€‚ Target Group æœ‰å››ç§ç±»å‹ï¼š Instance - EC2 Instance é€‰æ‹©ä¸ LB åŒ Subnet çš„ EC2 Instance IP åœ°å€ - æŒ‡å®šå¤šä¸ªåç«¯æœåŠ¡çš„ IPv4 åœ°å€ Lambda å‡½æ•° - æŒ‡å®šè§¦å‘çš„ Lambda å‡½æ•°ï¼ˆä»… ALB æ”¯æŒï¼‰ ALB - åç«¯ç”± ALB å¤„ç† æŒ‡å®š Target Group æ—¶ï¼Œä¹Ÿéœ€è¦æŒ‡å®šè¯·æ±‚åç«¯æœåŠ¡çš„ Portã€‚ Note Listener çš„ Port ç”¨äºåˆ¤æ–­æ˜¯å¦å¤„ç†è¯·æ±‚ï¼ŒTarget Group çš„ Port æ˜¯è®¿é—® Target æŒ‡å®šçš„ç«¯å£ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:4:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"4.1 Health Check åˆ›å»º Target Group æ—¶ï¼Œéœ€è¦æŒ‡å®š Health Check æœºåˆ¶ã€‚LB ä¼šå‘¨æœŸæ€§å¯¹æ‰€æœ‰ Target è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚ Health Check çš„çŠ¶æ€å˜åŒ–æ˜¯å¹³æ»‘çš„ï¼š Healthy -\u003e Unhealthy: è¿ç»­ Health Check å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ â€œHealthy thresholdâ€ Unhealthy -\u003e Healthy: è¿ç»­ Health Check æˆåŠŸæ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ â€œHealthy thresholdâ€ å½“æŸä¸ª Target å˜ä¸º Unhealthy æ—¶ï¼ŒLB å°±ä¸ä¼šå°†æµé‡è·¯ç”±åˆ°è¯¥ Targetï¼Œç›´åˆ°é‡æ–°å˜ä¸º Healthyã€‚ Health Check æ”¯æŒä»¥ä¸‹åè®®ï¼š TCP - å¯¹äº TCP ç«¯å£å‘èµ·è¿æ¥è¯·æ±‚ï¼Œè¿æ¥æˆåŠŸå°±è¡¨æ˜å¥åº·æ£€æŸ¥æˆåŠŸ HTTP - å‘èµ·ä¸€ä¸ª HTTP Path çš„è¯·æ±‚ï¼Œæ£€æŸ¥å…¶å›å¤çš„ HTTP Code HTTP - å‘èµ·ä¸€ä¸ª HTTPs Path çš„è¯·æ±‚ï¼Œæ£€æŸ¥å…¶å›å¤çš„ HTTP Code Note å¯¹äº UDP NLBï¼Œä¹Ÿä»…ä»…åªèƒ½é€šè¿‡ TCP æ¥è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:4:1","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5 Application Load Balancer ALB æ˜¯åŸºäºä¸ƒå±‚çš„ä»£ç†ï¼Œåˆ›å»ºæ—¶éœ€è¦æŒ‡å®šå…¶æ‰€åœ¨çš„ VPCï¼Œä»¥åŠæŒ‡å®šè‡³å°‘ä¸¤ä¸ª AZ çš„ Subnetã€‚LB ä¼šåœ¨æ¯ä¸ª Subnet åˆ›å»ºä¸€ä¸ª ENIï¼Œç”¨äºä½œä¸º LB åŸŸåè§£æåçš„ IP ä¹‹ä¸€ã€‚ Note ä½¿ç”¨ nslookup \u003clb-addr\u003e è§£æ LB åŸŸåæ—¶ï¼Œå¾—åˆ°çš„å°±æ˜¯å„ä¸ª Subnet çš„ ENI çš„ IP åœ°å€ã€‚ å› ä¸º LB ä½¿ç”¨ ENI æ¥å®ç°ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä¸º LB è®¾ç½® Security Groupï¼Œæ¥æ§åˆ¶å‡ºå…¥ LB çš„æµé‡ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.1 LB çš„çŠ¶æ€ LB å¯èƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š provisioning - åˆ›å»º LB ä¸­ active - LB å·²ç»å°±ç»ªï¼Œå¹¶æ­£å¸¸è·¯ç”±æµé‡ä¸­ active_impaired - LB æ­£åœ¨è·¯ç”±æµé‡ï¼Œä½†æ˜¯æ²¡æœ‰æ‰©å±•æ‰€éœ€çš„èµ„æº failed - LB æ— æ³•åˆ›å»º ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:1","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.2 Access Log ELB å¯ä»¥æä¾› Access Logï¼Œç”¨äºæŸ¥çœ‹å‘é€åˆ° LB çš„è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ã€‚ Access Log åŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ç”¨å AWS ä¼šå°†è®¿é—®æ—¥å¿—å‹ç¼©ï¼Œå¹¶å­˜å‚¨åˆ°ç”¨æˆ·æŒ‡å®šçš„ S3 bucket è·¯å¾„ã€‚ä½¿ç”¨è®¿é—®æ—¥å¿—ä¸éœ€è¦é¢å¤–çš„ä»˜è´¹ï¼Œåªéœ€è¦ä¸º S3 çš„å­˜å‚¨ä»˜è´¹ã€‚ ELB é»˜è®¤æ¯ 5min ä¿å­˜ä¸€æ¬¡ LB çš„ Access Logï¼Œå­˜å‚¨çš„æ–‡ä»¶åæ ¼å¼å¦‚ä¸‹ï¼š \u003cbucket path\u003e/AWSLogs/\u003caws-account-id\u003e/elasticloadbalancing/\u003cregion\u003e/\u003cyear\u003e/\u003cmonth\u003e/\u003cday\u003e/\u003caccount_id\u003e_elasticloadbalancing_\u003cregion\u003e_\u003cload-balancer-id\u003e_\u003cend-time\u003e_\u003cip-address\u003e_\u003crandom-string\u003e.log.gz æ¯ä¸ªè®¿é—®è¯·æ±‚çš„ä¿¡æ¯åŒ…æ‹¬ è¯·æ±‚æ—¶é—´ã€å®¢æˆ·ç«¯ IPã€å»¶è¿Ÿã€æœåŠ¡å™¨å›å¤ç­‰ç­‰ï¼Œå®Œæ•´çš„åˆ—è¡¨è§ï¼šAccess Log Entryã€‚ çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¯ä¸ªä¿¡æ¯ä¹‹é—´é€šè¿‡ç©ºæ ¼éš”å¼€ï¼š http 2018-07-02T22:23:00.186641Z app/my-loadbalancer/50dc6c495c0c9188 192.168.131.39:2817 10.0.0.1:80 0.000 0.001 0.000 200 200 34 366 \"GET http://www.example.com:80/ HTTP/1.1\" \"curl/7.46.0\" - - arn:aws:elasticloadbalancing:us-east-2:123456789012:targetgroup/my-targets/73e2d6bc24d8a067 \"Root=1-58337262-36d228ad5d99923122bbe354\" \"-\" \"-\" 0 2018-07-02T22:22:48.364000Z \"forward\" \"-\" \"-\" 10.0.0.1:80 200 \"-\" \"-\" ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:2","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.3 Deletion Protection ä¸ºäº†é˜²æ­¢ LB æ„å¤–è¢«åˆ é™¤ï¼Œå¯ä»¥å¼€å¯ Deletion Protection åŠŸèƒ½ã€‚å¼€å¯åï¼Œéœ€è¦å…ˆå…³é—­ Deletion Protection åŠŸèƒ½ï¼Œç„¶åæ‰èƒ½åˆ é™¤ LBã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:3","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.4 Connection idle timeout å¯¹äº Client çš„è®¿é—®ï¼ŒLB ä¼šç»´æŠ¤ä¸¤ä¸ªè¿æ¥ï¼š Client ä¸ LB ä¹‹é—´çš„è¿æ¥ LB ä¸ Target ä¹‹é—´çš„è¿æ¥ å¯¹äºè¿™ä¸¤ä¸ªè¿æ¥ï¼Œä¸€æ—¦è¿æ¥ç©ºé—²ï¼ˆæœªå‘é€æˆ–æ¥æ”¶ä»»ä½•æ•°æ®ï¼‰æ—¶é—´è¶…è¿‡ idle timeout åï¼ŒLB å°±ä¼šå…³é—­è¿æ¥ã€‚é»˜è®¤çš„ idle timeout ä¸º 60sã€‚ å¯¹äº LB ä¸ Target ä¹‹é—´çš„è¿æ¥ï¼Œä¸ºäº†èƒ½å¤Ÿå¤ç”¨åç«¯è¿æ¥ï¼Œæ¨èå¼€å¯ HTTP keep aliveã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:4","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.5 Desync mitigation mode åœ¨ LB è¿™ç§æ¨¡å¼ä¸‹ï¼ŒHTTP çš„è®¿é—®æ˜¯ç”± LB å¼‚æ­¥å‘é€ç»™ Target è¿›è¡Œå¤„ç†çš„ã€‚Desync mitigation mode å°±æ˜¯ç”¨äºä¿æŠ¤ Target ä¸å—åˆ° HTTP å¼‚æ­¥çš„å½±å“ã€‚ LB ä¼šä½¿ç”¨ http_desync_guardian åº“ï¼Œå°†æ¯ä¸ªè¯·æ±‚è¿›è¡Œå¨èƒåˆ†çº§ï¼Œæ ¹æ® desync mitigation mode æ¥é€‰æ‹©æ˜¯å¦è½¬å‘æŸä¸ªè¯·æ±‚ã€‚ Classifications Monitor mode Defensive modeï¼ˆé»˜è®¤ï¼‰ Strictest mode Compliant Allowed Allowed Allowed Acceptable Allowed Allowed Blocked Ambiguous Allowed Allowed Blocked Severe Allowed Blocked Blocked ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:5","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.6 HEAD å¤„ç† ALB æ”¯æŒè½¬å‘è¯·æ±‚æ—¶æ·»åŠ  X-Forwarded ç›¸å…³çš„ HTTP HEADï¼Œç”¨äºæä¾›ç»™ Target ä¸€äº›æ— æ³•çœ‹åˆ°çš„ä¿¡æ¯ã€‚ X-Forwarded-For - åŒ…å« Client çš„ IP åœ°å€ å› ä¸º LB è´Ÿè´£ä¸ Target è¿›è¡Œé€šä¿¡ï¼Œå› æ­¤ Target æ— æ³•ä»åè®®ä¸Šçœ‹åˆ°å®¢æˆ·ç«¯çš„æº IP åœ°å€ã€‚ALB ä¼šåœ¨å‘é€ç»™ Target çš„è¯·æ±‚çš„ HTTP HEAD åŠ ä¸Š X-Forwarded-For ä»¥æä¾›ç»™ Target å®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚ è¿›ä¸€æ­¥çš„ï¼Œå¯ä»¥å¼€å¯ â€œå®¢æˆ·ç«¯ç«¯å£ä¿ç•™åŠŸèƒ½â€ï¼ŒX-Forwarded-For è¿˜ä¼šåŠ ä¸Š Client çš„æºç«¯å£ã€‚ X-Forwarded-Proto - åŒ…å« Client ä¸ ALB é€šä¿¡çš„åè®® X-Forwarded-Port - åŒ…å« Client è®¿é—® ALB çš„ç›®æ ‡ç«¯å£ å½“è¯·æ±‚åŒ…å«æ— æ•ˆæ ¼å¼ï¼ˆç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼ [-A-Za-z0-9]+ï¼‰ çš„ HTTP HEAD æ—¶ï¼Œé»˜è®¤ ALB è½¬å‘è¯·æ±‚æ—¶ä¼šå°†å…¶åˆ é™¤ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä¿ç•™æ— æ•ˆçš„ HTTP HEADã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:6","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"5.7 Sticky Sessions é»˜è®¤ä¸‹ï¼ŒALB ä¼šæ ¹æ®é€‰æ‹©çš„è´Ÿè½½å‡è¡¡ç®—æ³•å°†è¯·æ±‚è·¯ç”±åˆ° Target ä¸Šã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ Sticky Sessions åŠŸèƒ½ï¼Œä½¿å¾—å°† Session ç»‘å®šè·¯ç”±åˆ°æŸä¸ª Target ä¸Šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ Session æœŸé—´ï¼Œç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå‘é€åˆ°åŒä¸€ä¸ª Target æ¥å¤„ç†ã€‚ Note è¦ä½¿ç”¨ Sticky Sessionsï¼Œå®¢æˆ·ç«¯å¿…é¡»å¼€å¯ Cookieã€‚ ALB æ”¯æŒä¸¤ç§ç±»å‹ï¼š åŸºäºæŒç»­æ—¶é—´çš„ Cookie å½“ ALB ç¬¬ä¸€æ¬¡æ”¶åˆ° Client è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é€‰å®šç®—æ³•è·¯ç”±ç»™ Targetï¼Œå¹¶æ ¹æ®ç›¸å…³ä¿¡æ¯ç”Ÿæˆåä¸º AWSALB çš„åŠ å¯†çš„ Cookieã€‚Cookie æœ‰ç€ 7 å¤©çš„è¿‡æœŸæ—¶é—´ã€‚ åç»­ ALB æ”¶åˆ° Client è¯·æ±‚æ—¶ï¼Œå¦‚æœ Client åŒ…å« AWSALB Cookieï¼Œé‚£ä¹ˆä¼šå°†å…¶è§£å¯†ï¼Œæ ¹æ®ä¿¡æ¯å°†å…¶è·¯ç”±åˆ°åŒä¸€ä¸ª Targetã€‚å¦‚æœè¯¥ Target å·²ç»ä¸å­˜åœ¨æˆ–è€… unhealthyï¼Œé‚£ä¹ˆä¼šé€‰æ‹©ä¸€ä¸ªæ–°çš„ Targetï¼ŒåŒæ—¶æ›´æ–° Cookie çš„å€¼ã€‚ åŸºäºåº”ç”¨ç¨‹åºçš„ Cookie åŸºäºåº”ç”¨ç¨‹åºçš„ Cookie æ˜¯åœ¨ åŸºäºæŒç»­æ—¶é—´ çš„åŸºç¡€ä¸Šï¼Œè®©åº”ç”¨ç¨‹åºä¹ŸçŸ¥æ™“ Cookie çš„å­˜åœ¨ã€‚ å½“ ALB ç¬¬ä¸€æ¬¡æ”¶åˆ° Client è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é€‰å®šç®—æ³•è·¯ç”±ç»™ Targetï¼Œè€Œ Target è¿”å›å›å¤éœ€è¦åŒ…å«ä¸€ä¸ª Application Cookieã€‚ALB æ”¶åˆ° Application Cookie åï¼Œä¼šæ ¹æ®ä¿¡æ¯ä¸è¯¥ Cookie ç”Ÿæˆ AWSALB Cookieã€‚åŒæ ·ï¼Œè¯¥ Cookie æœ‰ç€ 7 å¤©çš„è¿‡æœŸæ—¶é—´ã€‚Client ä¼šæ”¶åˆ° Application Cookie ä¸ AWSALB Cookieã€‚ åç»­ ALB æ”¶åˆ° Client è¯·æ±‚æ—¶ï¼ŒLB ä¼šè§£å¯† AWSALB Cookieï¼Œæ ¹æ®ä¿¡æ¯å°†å…¶è·¯ç”±åˆ°åŒä¸€ä¸ª Targetï¼Œå¹¶ä¸”ä¼šä¼ é€’ Application Cookieã€‚Target å¯ä»¥æ ¹æ® Application Cookie ä»è€ŒçŸ¥æ™“è¿™æ˜¯ä¸€ä¸ªå­˜åœ¨ Sessionã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:5:7","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"6 Network Load Balancer NLB æ˜¯åŸºäºå››å±‚çš„è´Ÿè½½å‡è¡¡ï¼Œæ”¯æŒ TCP ä¸ UDP åè®®ã€‚ å¯¹äº TCP æµé‡ï¼ŒLB åŸºäºåè®®ã€æº IP åœ°å€ã€æºç«¯å£ã€ç›®æ ‡ IP åœ°å€ã€ç›®æ ‡ç«¯å£å’Œ TCP åºåˆ—å·ï¼Œä½¿ç”¨å“ˆå¸Œç®—æ³•é€‰æ‹© Targetã€‚æ¯ä¸ª TCP è¿æ¥åœ¨æœ‰æ•ˆæœŸå†…éƒ½ä¼šè·¯ç”±åˆ°åŒä¸€ä¸ª Targetã€‚ å¯¹äº UDP æµé‡ï¼ŒLB åŸºäºåè®®ã€æº IP åœ°å€ã€æºç«¯å£ã€ç›®æ ‡ IP åœ°å€ã€ç›®æ ‡ç«¯å£ï¼Œä½¿ç”¨å“ˆå¸Œç®—æ³•é€‰æ‹© Targetã€‚å¦‚æœ UDP æ•°æ®åŒ…æœ‰ç€ç›¸åŒçš„æºåœ°å€å’Œç›®æ ‡åœ°å€ï¼Œé‚£ä¹ˆå°±ä¼šè·¯ç”±åˆ°åŒä¸€ä¸ª Targetã€‚ åˆ›å»º NLB æ—¶éœ€è¦æŒ‡å®šå…¶æ‰€åœ¨çš„ VPCï¼Œä»¥åŠè‡³å°‘ä¸¤ä¸ª AZ çš„ Subnetã€‚LB ä¼šåœ¨æ¯ä¸ª Subnet åˆ›å»ºä¸€ä¸ª ENIï¼Œç”¨äºä½œä¸º LB åŸŸåè§£æåçš„ IP ä¹‹ä¸€ã€‚ Note ä½¿ç”¨ nslookup \u003clb-addr\u003e è§£æ LB åŸŸåæ—¶ï¼Œå¾—åˆ°çš„å°±æ˜¯å„ä¸ª Subnet çš„ ENI çš„ IP åœ°å€ã€‚ å› ä¸º LB ä½¿ç”¨ ENI æ¥å®ç°ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä¸º LB è®¾ç½® Security Groupï¼Œæ¥æ§åˆ¶å‡ºå…¥ LB çš„æµé‡ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:6:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"6.1 LB çš„çŠ¶æ€ LB å¯èƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š provisioning - åˆ›å»º LB ä¸­ active - LB å·²ç»å°±ç»ªï¼Œå¹¶æ­£å¸¸è·¯ç”±æµé‡ä¸­ failed - LB æ— æ³•åˆ›å»º ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:6:1","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"6.2 Access Log ELB å¯ä»¥æä¾› TLS è¯·æ±‚çš„ Access Logï¼Œç”¨äºæŸ¥çœ‹å‘é€åˆ° LB çš„è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ã€‚ Note ä»…ä»…å½“ LB å…·æœ‰ TLS Listenerï¼Œä¸”å®ƒä»¬ä»…ä»…åŒ…å« TLS è¯·æ±‚çš„ä¿¡æ¯æ—¶ï¼Œæ‰ä¼šåˆ›å»ºè®¿é—®æ—¥å¿—ã€‚ Access Log åŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ç”¨å AWS ä¼šå°†è®¿é—®æ—¥å¿—å‹ç¼©ï¼Œå¹¶å­˜å‚¨åˆ°ç”¨æˆ·æŒ‡å®šçš„ S3 bucket è·¯å¾„ã€‚ä½¿ç”¨è®¿é—®æ—¥å¿—ä¸éœ€è¦é¢å¤–çš„ä»˜è´¹ï¼Œåªéœ€è¦ä¸º S3 çš„å­˜å‚¨ä»˜è´¹ã€‚ ELB é»˜è®¤æ¯ 5min ä¿å­˜ä¸€æ¬¡ LB çš„ Access Logï¼Œå­˜å‚¨çš„æ–‡ä»¶åæ ¼å¼å¦‚ä¸‹ï¼š \u003cbucket path\u003e/AWSLogs/\u003caws-account-id\u003e/elasticloadbalancing/\u003cregion\u003e/\u003cyear\u003e/\u003cmonth\u003e/\u003cday\u003e/\u003caccount_id\u003e_elasticloadbalancing_\u003cregion\u003e_\u003cload-balancer-id\u003e_\u003cend-time\u003e_\u003cip-address\u003e_\u003crandom-string\u003e.log.gz æ¯ä¸ªè®¿é—®è¯·æ±‚çš„ä¿¡æ¯åŒ…æ‹¬ è¯·æ±‚æ—¶é—´ã€å®¢æˆ·ç«¯ IPã€å»¶è¿Ÿã€æœåŠ¡å™¨å›å¤ç­‰ç­‰ï¼Œå®Œæ•´çš„åˆ—è¡¨è§ï¼šAccess Log Entryã€‚ çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¯ä¸ªä¿¡æ¯ä¹‹é—´é€šè¿‡ç©ºæ ¼éš”å¼€ï¼š tls 2.0 2018-12-20T02:59:40 net/my-network-loadbalancer/c6e77e28c25b2234 g3d4b5e8bb8464cd 72.21.218.154:51341 172.100.100.185:443 5 2 98 246 - arn:aws:acm:us-east-2:671290407336:certificate/2a108f19-aded-46b0-8493-c63eb1ef4a99 - ECDHE-RSA-AES128-SHA tlsv12 - my-network-loadbalancer-c6e77e28c25b2234.elb.us-east-2.amazonaws.com - - - ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:6:2","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"6.3 Deletion Protection ä¸ºäº†é˜²æ­¢ LB æ„å¤–è¢«åˆ é™¤ï¼Œå¯ä»¥å¼€å¯ Deletion Protection åŠŸèƒ½ã€‚å¼€å¯åï¼Œéœ€è¦å…ˆå…³é—­ Deletion Protection åŠŸèƒ½ï¼Œç„¶åæ‰èƒ½åˆ é™¤ LBã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:6:3","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"6.4 è·¨ AZ è´Ÿè½½å‡è¡¡ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Subnet çš„ LB èŠ‚ç‚¹ä»…ä»…ä¸ºå½“å‰ AZ çš„ Target è·¯ç”±æµé‡ã€‚å¼€å¯ è·¨ AZ è´Ÿè½½å‡è¡¡ åŠŸèƒ½åï¼Œæ¯ä¸ª LB èŠ‚ç‚¹ä¼šä¸ºæ‰€æœ‰å¯ç”¨çš„ AZ çš„ Target ä¹‹é—´è·¯ç”±æµé‡ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:6:4","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"7 Gateway Load Balancer Gateway Load Balancer ä½œä¸ºä¸€ä¸ªé€æ˜ç½‘ç»œçš„ç½‘å…³è®¾å¤‡ï¼ˆç½‘ç»œä¸­çš„æ‰€æœ‰æµé‡çš„å•ä¸€å…¥å£ä¸å‡ºå£ç‚¹ï¼‰ï¼Œæ‰€æœ‰çš„æµé‡ä¼šç»è¿‡æ³¨å†Œçš„ç¬¬ä¸‰æ–¹è™šæ‹Ÿè®¾å¤‡çš„å¤„ç†ï¼ˆä¾‹å¦‚å®‰å…¨è®¾å¤‡å¯¹æµé‡çš„æ£€æŸ¥ï¼‰ã€‚GWLB åŸºäºç¬¬ä¸‰å±‚ï¼ˆç½‘ç»œå±‚ï¼‰å·¥ä½œï¼Œç›‘å¬æ‰€æœ‰ç«¯å£çš„ IP æ•°æ®åŒ…ï¼Œå°†æµé‡è·¯ç”±åˆ°æ³¨å†Œçš„ Targetã€‚ å¯¹äº TCP/UDP æµé‡ï¼ŒGWLB ä½¿ç”¨ 5 å…ƒç»„æ¥è·¯ç”±æµé‡ã€‚å¯¹äºé TCP/UDP æµé‡ï¼Œä½¿ç”¨ 3 å…ƒç»„æ¥è·¯ç”±æµé‡ã€‚ GWLB ä½¿ç”¨ GWLB Endpoint æ¥å®‰å…¨åœ°è·¨ VPC è¾¹ç•Œäº¤æ¢æµé‡ã€‚è¿›å‡º GWLB Endpoint çš„æµé‡ä½¿ç”¨ Route Table è¿›è¡Œé…ç½®ã€‚ ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼š ä» Internet åˆ° Application çš„æµé‡ï¼ˆè“è‰²ç®­å¤´ï¼‰ï¼š æµé‡è¿›å…¥ Internet Gateway è¿›å…¥ Public VPCï¼› æ ¹æ® Route Tableï¼Œæµé‡å‘é€ç»™äº† GWLB Endpointï¼› GWLB Endpoint å°†æµé‡ä¼ è¾“åˆ°äº† GWLBï¼› ç»è¿‡ Security Application æ£€æŸ¥åï¼Œæµé‡ä¼šå‘é€å› GWLB Endpointï¼› æµé‡è¢«å‘é€åˆ° Applicationï¼› ä» Application åˆ° Internet çš„æµé‡ï¼ˆæ©™è‰²ç®­å¤´ï¼‰ï¼š æ ¹æ® Route Table çš„é»˜è®¤è·¯ç”±ï¼Œ Application å‘å‡ºçš„æµé‡å‘é€åˆ°äº† GWLB Endpointï¼› æµé‡å°†å‘é€åˆ° GWLBï¼Œå¹¶ç»è¿‡äº† Security Application çš„æ£€æŸ¥ï¼› æ£€æŸ¥åï¼Œæµé‡å‘é€å› GWLB Endpointï¼› æ ¹æ® Route Tableï¼Œæµé‡å‘é€åˆ° Internet Gatewayï¼› æµé‡å‘é€åˆ° Internetï¼› ä½¿ç”¨ GWLB æ—¶ï¼Œé€šè¿‡å¯¹ Route Table çš„é…ç½®ï¼Œè®© Application æ‰€åœ¨çš„ç½‘æ®µçš„æµé‡éƒ½ç»è¿‡å¦ä¸€ä¸ª Subnet çš„ GWLB Endpointã€‚ä¾‹å¦‚ï¼š Destination Target 10.0.0.0/16 æœ¬åœ° 10.0.1.0/24 vpc-endpoint-id 0.0.0.0/0 internet-gateway-id å¯¹äº Application çš„è·¯ç”±è¡¨ï¼Œå°†é»˜è®¤è·¯ç”±æŒ‡å‘å¦ä¸€ä¸ª Subnet çš„ GWLB Endpointï¼Œä»è€Œè®©æ‰€æœ‰æµé‡ç»è¿‡ GWLBã€‚ä¾‹å¦‚ï¼š Destination Target 10.0.0.0/16 æœ¬åœ° 0.0.0.0/0 vpc-endpoint-id ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:7:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"7.1 LB çš„çŠ¶æ€ LB å¯èƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š provisioning - åˆ›å»º LB ä¸­ active - LB å·²ç»å°±ç»ªï¼Œå¹¶æ­£å¸¸è·¯ç”±æµé‡ä¸­ failed - LB æ— æ³•åˆ›å»º ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:7:1","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"7.2 Deletion Protection ä¸ºäº†é˜²æ­¢ LB æ„å¤–è¢«åˆ é™¤ï¼Œå¯ä»¥å¼€å¯ Deletion Protection åŠŸèƒ½ã€‚å¼€å¯åï¼Œéœ€è¦å…ˆå…³é—­ Deletion Protection åŠŸèƒ½ï¼Œç„¶åæ‰èƒ½åˆ é™¤ LBã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:7:2","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"7.3 è·¨ AZ è´Ÿè½½å‡è¡¡ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Subnet çš„ LB èŠ‚ç‚¹ä»…ä»…ä¸ºå½“å‰ AZ çš„ Target è·¯ç”±æµé‡ã€‚å¼€å¯ è·¨ AZ è´Ÿè½½å‡è¡¡ åŠŸèƒ½åï¼Œæ¯ä¸ª LB èŠ‚ç‚¹ä¼šä¸ºæ‰€æœ‰å¯ç”¨çš„ AZ çš„ Target ä¹‹é—´è·¯ç”±æµé‡ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:7:3","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"8 é™åˆ¶ å¦‚æœè¯·æ±‚ä¸å›å¤éƒ½æ˜¯åœ¨åŒä¸€ä¸ª LB ä»£ç†çš„ Nodeï¼ŒLB æ˜¯ä¸ä¼šå¤„ç†è¯¥è¯·æ±‚çš„ï¼Œè¿™æ˜¯ç”±äºè™šæ‹Ÿç½‘å¡çš„ hairpin æ¨¡å¼å¼•èµ·ã€‚ ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:8:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"å‚è€ƒ Application Load Balancer Network Load Balancer Gateway Load Balancer ","date":"2021-12-04","objectID":"/posts/cloud_computing/aws_learning/7-elb/:9:0","tags":["aws"],"title":"AWS å­¦ä¹  - 7 - Elastic Load Balancing","uri":"/posts/cloud_computing/aws_learning/7-elb/"},{"categories":["AWS å­¦ä¹ "],"content":"AWS IAM ç›¸å…³æ¦‚å¿µ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"ä½¿ç”¨ AWS æ—¶ï¼Œä¸åŒçš„å‘˜å·¥æˆ–è€…åº”ç”¨ç¨‹åºæœ‰ç€ä¸åŒçš„ AWS èµ„æºéœ€æ±‚ï¼Œé€šè¿‡ IAM å¯¹å…¶è®¿é—®æƒé™è¿›è¡Œæ§åˆ¶ã€‚ IAM æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†å®Œæˆä¸¤ä¸ªåŠŸèƒ½ï¼š Authentication - èº«ä»½è®¤è¯ï¼Œæ“ä½œèµ„æºå‰ç¡®è®¤è¯·æ±‚è€…æ˜¯ â€œè°â€ï¼› Authorization - æˆæƒï¼Œæ“ä½œè€…æ˜¯å¦æœ‰æƒé™æ“ä½œèµ„æºï¼› è¿™ä¸ª â€œè°â€ è¢«ç§°ä¸º Entityï¼Œåé¢çœ‹åˆ°çš„ Userã€User Groupã€Role éƒ½å±äº Entityã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:0:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"1 ä¸ AWS äº¤äº’ æœ‰å››ç§è®¿é—® AWS æœåŠ¡çš„æ–¹å¼ï¼Œæ‰€æœ‰çš„æ–¹å¼æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡è¯·æ±‚ AWS API æ¥è®¿é—®ï¼Œä¸åŒæ–¹å¼å‘é€æ—¶å¸¦æœ‰çš„å‡­è¯æ–¹å¼ä¸åŒã€‚ Console - Username + Password ç™»é™†ç½‘é¡µ CLI - Access Key + Secret Keyï¼ˆåç»­ç®€ç§°ä¸º AK/SKï¼‰ SDK - AK/SK AWS Service - Assume Role æ‰€æœ‰çš„ API è¯·æ±‚ä¼šå‘é€åˆ°å„ä¸ª Region çš„ AWS API ç»ˆç«¯èŠ‚ç‚¹ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç»è¿‡ IAM çš„èº«ä»½è®¤è¯ä¸æˆæƒæ£€æŸ¥ï¼Œä»¥åŠ CloudTrail çš„è®°å½•ã€‚ æ‰€æœ‰è®¿é—®æ–¹å¼å‘é€ API æ—¶éƒ½ä¼šå¸¦æœ‰ä¸€ä¸ªå‡­è¯ï¼Œå…¶å†…å®¹åŒ…æ‹¬ï¼š è¯·æ±‚ä¸»ä½“ï¼› ç­¾å - ç”± SK ä½œä¸ºç§é’¥ï¼Œå¯¹ è¯·æ±‚ä¸»ä½“ + å…ƒä¿¡æ¯ + æ—¶é—´æˆ³ ç­‰ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°ç­¾åï¼› è¯¥å‡­è¯å®ç°çš„ä½œç”¨ï¼š èº«ä»½éªŒè¯ - SK ç­¾åå®ç° - AWS æœåŠ¡ç«¯ä¼šæŸ¥æ‰¾å¯¹åº”çš„ AK è¿›è¡Œè§£å¯†ï¼Œä»è€ŒéªŒè¯æ˜¯å¦æ˜¯å¯¹åº”çš„ SK åŠ å¯†çš„ï¼› é˜²æ­¢ç¯¡æ”¹ - æ‘˜è¦ä¿¡æ¯å®ç° - AK è§£å¯†åå¾—åˆ°æ‘˜è¦ä¿¡æ¯ï¼Œé€šè¿‡å¯¹æ¯”æ‘˜è¦ä¿¡æ¯æ¥æ£€æŸ¥è¯·æ±‚ä¸»ä½“æ˜¯å¦è¢«ç¯¡æ”¹ï¼› é˜²æ­¢é‡æ”¾æ”»å‡» - æ—¶é—´æˆ³å®ç° - è¯·æ±‚ä¸­ä¼šå¸¦æœ‰ æ—¶é—´æˆ³ ä¿¡æ¯ï¼Œé€šè¿‡æ—¶é—´æˆ³ä¿¡æ¯æ¥åˆ¤æ–­è¯·æ±‚æœ‰æ•ˆæœŸï¼ˆé»˜è®¤ 5minï¼‰ï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»ï¼› AK/SK çš„ä½œç”¨ å¯ä»¥çœ‹åˆ°ï¼ŒAK ä½œç”¨ç±»ä¼¼äºå…¬é’¥ï¼ŒSK ä½œç”¨ç±»ä¼¼äºç§é’¥ã€‚ å½“ç„¶ï¼Œæ‰€æœ‰çš„å‡­è¯ç”Ÿæˆå¯¹äºç”¨æˆ·éƒ½æ˜¯é€æ˜çš„ï¼Œç”¨æˆ·åªéœ€è¦é…ç½®å¥½ AK/SK å³å¯è®¿é—® AWS æœåŠ¡ã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"2 Root User / IAM User / User Group ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"2.1 Root User åˆ›å»º AWS Account æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Root Userï¼Œå…¶æƒé™ä¸å—æ§åˆ¶ã€‚ å¯¹ Root Userï¼Œå› ä¸ºå…¶æƒé™å¤ªå¤§ï¼Œæ‰€ä»¥æ—¥å¸¸ä½¿ç”¨ä¸è¦ä½¿ç”¨ï¼ŒåŒæ—¶æ¨èå¯¹å…¶å¼€å¯ MFAï¼Œç™»é™†æ—¶è¦æ±‚ä¸¤æ­¥éªŒè¯ã€‚ Root User æƒé™æ”¶åˆ°æ§åˆ¶çš„æƒ…å†µ æœ‰ä¸ªä¾‹å¤–ï¼Œå½“ä½¿ç”¨ AWS Organization é™åˆ¶æ—¶ï¼ŒæŸä¸ª Account çš„ Root User ä¼šå—åˆ° Service Control Policy é™åˆ¶ã€‚ æœ€ä½³å®ç°æ˜¯ï¼šæœ€å¼€å§‹åˆ›å»º Account æ—¶ï¼Œå…ˆç”¨ Root User åˆ›å»º Admin IAM Userï¼ˆä½œä¸ºé¡¶çº§ç®¡ç†å‘˜ï¼‰ï¼Œç„¶åä½¿ç”¨ Admin IAM User å»åˆ›å»ºå„ä¸ª IAM Userã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:2:1","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"2.2 IAM User IAM User è®¿é—® AWS æœåŠ¡æ”¶åˆ° IAM çš„é™åˆ¶ï¼Œé€šè¿‡ IAM Policy æ¥é™åˆ¶å…¶è®¿é—®æƒé™ï¼Œä»¥æ»¡è¶³æœ€å°æƒé™åŸåˆ™ï¼ˆåªæœ‰ç”¨æˆ·è‡³å°‘éœ€è¦çš„æƒé™ï¼‰ã€‚ æ¯ä¸ª IAM User æœ‰ç€ç‹¬ç«‹çš„ Username/Password ä¸ AK/SKã€‚æ¯ä¸ª IAM User æœ€å¤šæœ‰ä¸¤å¥— AK/SKï¼Œä»¥æ–¹ä¾¿è½®æ¢å¯†é’¥ï¼šå…ˆåœç”¨å½“å‰ä½¿ç”¨çš„å¯†é’¥ï¼Œåˆ‡æ¢ä½¿ç”¨æ–°çš„å¯†é’¥ï¼Œååˆ é™¤æ—§çš„å¯†é’¥ã€‚ åé¢å°† IAM User ç›´æ¥ç®€ç§°ä¸ºäº† Userã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:2:2","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"2.3 User Group ä¸ºäº†æ›´åŠ è½»æ¾çš„ç®¡ç† User ä¸ä»–ä»¬æ‹¥æœ‰çš„æƒé™ï¼Œå¯ä»¥å°† User æ·»åŠ åˆ° User Group ä¸­ã€‚ å½“å°† IAM Policy é™„åŠ åˆ°æŸä¸ª Group ä¸­ï¼Œè¯¥ Group å†…çš„æ‰€æœ‰ User éƒ½å…·æœ‰äº†ç›¸åº”çš„æƒé™ã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:2:3","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"2.4 Service Control Policy ä½¿ç”¨ AWS Organization ç®¡ç†å¤šä¸ª Account æ—¶ï¼ŒOrganization å¯ä»¥é€šè¿‡ Service Control Policy æ§åˆ¶ä¸€ä¸ªæˆ–ä¸€ç»„ Account çš„è®¿é—®æƒé™ï¼ŒAccount ä¸‹æ‰€æœ‰ Entity æ“ä½œéƒ½ä¼šå—åˆ°è¯¥ Policyï¼ˆåŒ…æ‹¬ Root Userï¼‰æ§åˆ¶ Service Control Policy å°±æ˜¯ Policyï¼Œä¼šä½œç”¨äº IAM è¿›è¡Œ Policy è¯„ä¼°æ—¶ï¼ˆåç»­ä¼šçœ‹åˆ°ï¼‰ã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:2:4","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"3 Policy Policy å®šä¹‰äº†æƒé™è¿™ä¸ªæ¦‚å¿µï¼Œé€šè¿‡å°† Policy é™„åŠ åˆ° User/Roleï¼Œå°±å¯ä»¥é™åˆ¶å…¶å¯¹ AWS èµ„æºçš„è®¿é—®æƒé™ã€‚ Note Policy ä»…ä»…æ˜¯é™æ€çš„æƒé™å®šä¹‰ï¼Œèƒ½å¤Ÿé™åˆ¶ â€œè°â€ æ˜¯é é™„åŠ  Policy å®ç°çš„ï¼ˆé™¤äº† Resource-based Policyï¼‰ã€‚ å…¶æ ¼å¼ç±»ä¼¼äºï¼š { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": \"ec2:*\", \"Effect\": \"Allow\", \"Resource\": \"*\" }, { \"Effect\": \"Allow\", \"Action\": \"iam:CreateServiceLinkedRole\", \"Resource\": \"*\", \"Condition\": { \"StringEquals\": { \"iam:AWSServiceName\": [ \"autoscaling.amazonaws.com\", \"ec2scheduled.amazonaws.com\", \"elasticloadbalancing.amazonaws.com\", \"spot.amazonaws.com\", \"spotfleet.amazonaws.com\", \"transitgateway.amazonaws.com\" ] } } } ] } Statement - å„ä¸ªè¯­å¥æ•°ç»„ï¼Œå¤šä¸ªè§„åˆ™ä¹‹é—´ä¸º OR é€»è¾‘ï¼› Effect - æè¿°è¯¥è¯­å¥æ˜¯ Allow/Denyï¼› Action/NotAction - è¯­å¥é’ˆå¯¹å“ªäº› API è¿›è¡Œæ§åˆ¶ï¼Œæ”¯æŒé€šé…ç¬¦ï¼ˆä¾‹å¦‚ ec2:start*ï¼‰ï¼› Resource/NotResource - è¯­å¥é’ˆå¯¹å“ªäº›èµ„æºè¿›è¡Œæ§åˆ¶ï¼Œä½¿ç”¨ ARN åœ°å€ï¼› Condition - è¯­å¥ç”Ÿæ•ˆçš„é¢å¤–åŒ¹é…æ¡ä»¶ï¼Œå¤šä¸ªæ¡ä»¶ä¹‹å‰ä¸º AND é€»è¾‘ï¼› Principal - ï¼ˆä»…ç”¨äº Resource-based Policyï¼‰è¯­å¥ä½œç”¨äº User/Serviceï¼› Note æ³¨æ„ Resource ä¸ Principalï¼ŒResource æŒ‡æ“ä½œçš„ç›®æ ‡ï¼ŒPrincipal æŒ‡è°è¿›è¡Œæ“ä½œã€‚ç†è®ºæ¥è¯´ï¼ŒPrincipal å¯ä»¥ç”± Condition æ¥å®ç°ã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"3.1 Policy çš„ç±»å‹ æ ¹æ® Policy çš„ç®¡ç†æ–¹å¼ï¼Œåˆ†ä¸ºï¼š AWS æ‰˜ç®¡ - ç”± AWS è¿›è¡Œç»´æŠ¤ä¸æ›´æ–°ï¼ŒåŒ…å«å¤§å¤šæ•°å¸¸ç”¨çš„æƒé™è¯­å¥ï¼› å®¢æˆ·æ‰˜ç®¡ - ç”±å®¢æˆ·è‡ªå®šä¹‰ä¸ç»´æŠ¤ï¼Œæ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼› å†…è” - ï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰é’ˆå¯¹äº User/Role ç›´æ¥ç»‘å®šçš„ Policyï¼Œä¸å¯å¤ç”¨ï¼› æ ¹æ® Policy åº”ç”¨ä¸»ä½“ï¼Œåˆ†ä¸ºï¼š Identity-based Policy åŸºäºèº«ä»½çš„ç­–ç•¥ - å®šä¹‰ Policyï¼Œå¹¶é™„åŠ åˆ° User/Role æ¥å®ç°å¯¹å…¶æƒé™çš„æ§åˆ¶ï¼› Resource-based Policy åŸºäºèµ„æºçš„ç­–ç•¥ - ä¸ç‰¹å®šèµ„æºç»‘å®šçš„ Policyï¼Œé…ç½®åé™åˆ¶ â€œè°â€ èƒ½è®¿é—®è¯¥èµ„æº; ä¾‹å¦‚ S3 Bucket Policy é…ç½®åé™åˆ¶å“ªäº› Entity å¯ä»¥è®¿é—®è¿™ä¸ªå­˜å‚¨æ¡¶ï¼ŒLambda Policy é™åˆ¶å“ªäº› Entity å¯ä»¥è°ƒç”¨è¿™ä¸ª Lambdaã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:3:1","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"4 Role User æœ‰ç€é•¿æœŸä½¿ç”¨çš„ Username/Password ä¸ AK/SKï¼Œå¹¶ä¸é€‚åˆä¸´æ—¶æä¾›ç»™ä»–äººä½¿ç”¨ã€‚è€Œ Role å°±æ˜¯ç”¨äºè§£å†³ä¸´æ—¶çš„æˆæƒæ“ä½œï¼Œä¸»è¦ç”¨äºï¼š AWS æœåŠ¡ Assume Role åï¼Œèƒ½å¤Ÿæ‹¥æœ‰è®¿é—® AWS èµ„æºçš„æƒé™ï¼› Userï¼ˆå½“å‰è´¦æˆ· User æˆ–è€…å…¶ä»–è´¦æˆ· Userï¼‰Assume Role åï¼Œèƒ½å¤Ÿæ‹¥æœ‰è®¿é—® AWS èµ„æºçš„æƒé™ï¼› ä½¿ç”¨ Role çš„åŸºæœ¬è¿‡ç¨‹ä¸ºï¼š åˆ›å»º Roleï¼› å°† Policy é™„åŠ åˆ° Role ä¸Šï¼› User/Service è¿›è¡Œ Assume Role æ“ä½œï¼› Assume Role åï¼Œä¼šåœ¨ä¸€å®šæ—¶é—´åè¿‡æœŸï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨æ’¤é”€ï¼ˆRevokeï¼‰æ‰€æœ‰å·²ç»åˆ†é…ï¼ˆä¸å½±å“åç»­ä½¿ç”¨ï¼‰ã€‚ åˆ›å»ºä¸€ä¸ª Role å¹¶åˆ†é…äº† Policy åï¼Œå¯ä»¥å°† Role æˆäºˆæŸä¸ª User æˆ–è€… Resourceã€‚è¿™æ · User/Resource ä¼šä¸¢å¼ƒå·²æœ‰çš„æƒé™ï¼Œä»…æ‹¥æœ‰ Role å®šä¹‰çš„èµ„æºè®¿é—®æƒé™äº†ã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:4:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"4.1 Trust Relationship å¯ä»¥çœ‹åˆ°ï¼ŒUser/Service éœ€è¦æ‰§è¡Œ Assume Role æ“ä½œæ¥ä½œä¸ºä¸€ä¸ª Roleï¼Œè€Œä¸€ä¸ª Role çš„ Trust Relationship å°±æ˜¯æ§åˆ¶ â€œè°â€ èƒ½å¤Ÿ Assume è¿™ä¸ª Roleã€‚ Trust Relationship æœ¬è´¨å°±æ˜¯ä¸€ä¸ª Policyï¼Œå…¶æ§åˆ¶çš„æ˜¯ sts:AssumeRole/sts:AssumeRoleWithWebIdentity APIï¼Œä»è€Œå®ç°äº†å¯¹ Assume çš„æ§åˆ¶ã€‚ { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" }, \"Action\": \"sts:AssumeRole\" } ] } ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:4:1","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"4.2 Session Policy æ‰§è¡Œ Assume Role è¡Œä¸ºæ—¶ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ª Session Policyï¼Œä½œä¸ºæœ¬æ¬¡ Assume Role æœŸé—´é¢å¤–æ·»åŠ çš„ Policyã€‚é€šè¿‡ Session Policy å®ç°ä¸€æ¬¡æ€§çš„çº¦æŸã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:4:2","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"4.3 Assume Role Assume Role æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨ sts:AssumeRole/sts:AssumeRoleWithWebIdentity ç›¸å…³ APIï¼Œè°ƒç”¨æ—¶ä¼šæ£€æŸ¥ Trust Relationshipï¼ˆå®é™…ä¸Šå°±æ˜¯ IAM æ£€æŸ¥ Policyï¼‰ã€‚ Assume æˆåŠŸåï¼ŒUser/Service ä¼šå¾—åˆ°ä¸€ä¸ª AK/SK + Token ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶å¸¦æœ‰ç€è¶…æ—¶æ—¶é—´ã€‚è¿™äº›ä¿¡æ¯ä½œä¸ºä¸€ä¸ªä¸´æ—¶å‡­è¯ï¼Œæä¾›è®¿é—® AWS èµ„æºçš„æƒé™ã€‚è€Œè¯¥ä¸´æ—¶å‡­è¯ç”± AWS STS æ¥é¢å‘ã€‚ ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:4:3","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"5 Permission Boundary é»˜è®¤ä¸‹ï¼Œå½“ Admin User ä¿®æ”¹ Entity æƒé™ï¼ˆPolicyï¼‰æ—¶ï¼Œæ˜¯å¯èƒ½æä¾›è¿‡å¤§çš„æƒé™ã€‚è¿™æ ·æ“ä½œï¼Œä»…ä»…æ‹¥æœ‰ç®¡ç† IAM çš„ User é€šè¿‡åˆ›å»ºæƒé™å¾ˆå¤§çš„ User å¯ä»¥åšåˆ°ä»»ä½•æ“ä½œã€‚ Permission Boundary æœ¬è´¨ä¸Šå°±æ˜¯ä¸ºæŸä¸ª Entity æŒ‡å®šä¸€ä¸ªå…¨å±€çš„ Policyã€‚å½“åˆ›å»º User/Role æ—¶ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦è¦å¸¦ä¸Š Permission Boundaryï¼ˆå¯é€‰é¡¹ï¼‰ã€‚ å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ Permission Boundaryï¼šå³ä½¿ Permission Boundary æ˜¯å¯é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹æ‹¥æœ‰åˆ›å»º User/Role æƒé™çš„ User çš„ Policy è¿›è¡Œæ¡ä»¶çº¦æŸï¼Œè¦æ±‚å…¶è°ƒç”¨ iam:CreateUser ç­‰ API æ—¶ï¼Œå¿…é¡»è¦æ±‚å¸¦ä¸Š Permission Boundaryã€‚ { \"Effect\": \"Allow\", \"Action\": [ // -\u003e é’ˆå¯¹åˆ›å»º User ç­‰ç›¸å…³çš„ API \"iam:CreateUser\" // ... ] \"Condition\": { \"StringEqua1s\": { \"iam:permissionsBoundary\": \"arn:aws:iam::ACCOUNT_ID:policy/PolicyX\"ï¼Œ// -\u003e è¦æ±‚ Permission Boundary å¿…é¡»æŒ‡å®šäº†æŸä¸ª Policy } } } ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:5:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"6 Policy è¯„ä¼° æ€»ç»“ä¸€ä¸‹å‰é¢æåˆ°çš„æ‰€æœ‰ IAM ä¼šè¯„ä¼°çš„ Policyï¼š Identity-based Policy Resource-based Policy Session Policy Permission Boundary Service Control Policy æ¯ä¸ª IAM æ£€æŸ¥ API è¯·æ±‚æ—¶ï¼Œæ‰€æœ‰çš„è®¾ç½®äº†çš„ Policy éƒ½ä¼šè¢«è¯„ä¼°ï¼Œæ•´ä½“å¯ä»¥è§ä¸‹å›¾ï¼š çœ‹ç€æµç¨‹å¾ˆå¤æ‚ï¼Œä½†æ˜¯å¯è§æ€»ç»“ä¸€ä¸‹å…¶åˆ¤æ–­é€»è¾‘ï¼š æ˜¾å¼æ‹’ç» - ä»»ä½•å­˜åœ¨çš„ Policyï¼Œåªè¦åˆ¤æ–­å‡º Denyï¼Œä½†æ˜¯ç»“æœå°±æ˜¯ Denyï¼› åŸºäºèµ„æºç­–ç•¥æ˜¾å¼å…è®¸ - ä¸å­˜åœ¨æ˜¾ç¤ºæ‹’ç»æƒ…å†µä¸‹ï¼Œå¦‚æœ Resource-based Policy æ˜¯ Allowï¼Œé‚£ä¹ˆç»“æœæ˜¯å…è®¸ï¼ˆä¸å‚è€ƒå…¶ä»–çš„ Policyï¼‰ï¼› å…¶ä»–ç­–ç•¥äº¤é›†å–å…è®¸ - å…¶ä»–ç­–ç•¥è¦æ‰€æœ‰ç­–ç•¥éƒ½éœ€è¦æ˜¾å¼çš„ Allowï¼› éšå¼æ‹’ç» - æ‰€æœ‰ç­–ç•¥æ²¡æœ‰æ˜¾å¼ Allowï¼Œé‚£ä¹ˆç»“æœä¸º Denyï¼› Note æ‰€æœ‰ç­–ç•¥è¯„ä¼°éƒ½æ˜¯é’ˆå¯¹äºä½¿ç”¨äº†ç­–ç•¥æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰åº”ç”¨ç­–ç•¥é‚£ä¹ˆä¸ä¼šå¯¹ç»“æœæœ‰å½±å“ã€‚ ä»¥ä¼ªä»£ç æ–¹å¼çœ‹ï¼š if anyDeny { return Deny // æ˜¾å¼æ‹’ç» } if ResourceBasedAllow { return Allow // åŸºäºèµ„æºç­–ç•¥æ˜¾å¼å…è®¸ } if AllAllow { return allow // äº¤é›†å–å…è®¸ } return Deny // éšå¼æ‹’ç» ","date":"2021-12-01","objectID":"/posts/cloud_computing/aws_learning/6-iam/:6:0","tags":["aws"],"title":"AWS å­¦ä¹  - 6 - IAM","uri":"/posts/cloud_computing/aws_learning/6-iam/"},{"categories":["AWS å­¦ä¹ "],"content":"1 VPC Peering VPC Peering ç”¨äºè¿æ¥ä¸¤ä¸ªä¸åŒåœ°å€èŒƒå›´çš„ VPCï¼ŒVPC å¯ä»¥å¤„äºä¸åŒçš„ Regionï¼Œç”šè‡³ä¸åŒçš„ AWS è´¦æˆ·ã€‚ å½“ VPC Peering è¿æ¥ä¸¤ä¸ª VPC åï¼ŒVPC å†…éƒ¨çš„èµ„æºï¼ˆInstanceã€RDS ç­‰ï¼‰å¯ä»¥ç›´æ¥è®¿é—®åˆ°å¯¹ç«¯ VPC çš„èµ„æºã€‚ ä½†æ˜¯ï¼ŒVPC Peering æ˜¯ä¸å…·æœ‰ä¼ é€’æ€§çš„ã€‚ä»¥ä¸Šå›¾æ¥è¯´ï¼ŒVPC1 æ˜¯æ— æ³•é€šè¿‡ VPC2 ä¸ VPC3 é€šä¿¡çš„ã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"1.1 ä½¿ç”¨ VPC Peering ä½¿ç”¨ VPC Peering è¿æ¥ VPC éœ€è¦çš„å·¥ä½œï¼š ç”±æºç«¯ VPC å‘èµ· VPC Peeringï¼Œè¿æ¥åˆ°å¯¹ç«¯ VPCã€‚ å‘èµ·çš„ç§°ä¸º Requester VPCã€‚ å¯¹ç«¯ VPC æ¥å— VPC Peeringã€‚ å¯¹ç«¯çš„ç§°ä¸º Accepter VPCã€‚ é…ç½® Route Tableï¼Œå°†å¯¹æ–¹ VPC çš„æ•°æ®åŒ…å‘å¾€ VPC Peeringã€‚ Destination Target Status Propagated 172.31.0.0/16 pcx-1353251 Active No é…ç½®é“¾è·¯ä¸Šçš„ Network ACL ä¸ Instance çš„ Security Groupï¼Œä¸å½±å“æµé‡ã€‚ VPC åœ°å€èŒƒå›´ä¸èƒ½é‡å  å› ä¸ºè¦é€šè¿‡ IP åœ°å€å¯»å€è¡¨æ˜äº†ï¼ŒVPC ä¹‹é—´çš„åœ°å€èŒƒå›´ä¸èƒ½é‡å ã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:1:1","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"1.2 VPC Peering çš„çŠ¶æ€æµè½¬ ä»å‘èµ·è¯·æ±‚å¼€å§‹ï¼ŒVPC Peering ä¼šç»è¿‡å„ä¸ªé˜¶æ®µï¼š ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:1:2","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"2 Transit Gateway ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"3 Endpoint ä¸ Private Link å‰é¢åœ¨ Route Table çœ‹åˆ°ï¼ŒRoute Table æ§åˆ¶å°† Subnet å†…çš„æµé‡è½¬å‘åˆ° AWS èµ„æºã€‚ä½†æ˜¯ AWS æœ‰ç€è®¸å¤šçš„æœåŠ¡ï¼ŒæœåŠ¡ç±»å‹ä¹Ÿä¸æ–­å‡ºç°ç€ï¼Œç‰¹å®šçš„ Rule.Target æ— æ³•æ»¡è¶³å¢é•¿ã€‚ å› æ­¤ï¼Œä½ å¯ä»¥çœ‹åˆ° Rule.Target æœ‰ä¸€ç±» vpc-endpoint-idï¼Œè¿™å°±æ˜¯è¡¨æ˜è·¯ç”±åˆ°ä¸€ä¸ª Endpointã€‚ Endpoint å°±æ˜¯å„å¼å„æ ·çš„ Service çš„è¿æ¥ç‚¹çš„æŠ½è±¡ã€‚é€šè¿‡ Endpointï¼ŒInstance å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ Private IP è®¿é—®å„ç§ Service äº†ã€‚ Service Network Interface å¯ä»¥å°†å…¶ç†è§£ä¸º Endpoint å°±æ˜¯ Service çš„ â€œNetwork Interfaceâ€ï¼Œæœ‰äº† Endpoint å°±å¯ä»¥å°† Subnet çš„æµé‡å‘é€ç»™ Serviceã€‚ ç›®å‰ï¼ŒEndpoint åˆ†ä¸ºä¸‰ç±»ï¼š Gateway Endpoints Interface Endpoints Gateway Load Balancer Endpoints å…¶ä¸­ï¼Œç¬¬ä¸€ç§æµé‡ä¼šé€šè¿‡å…¬ç½‘ï¼Œè€Œåä¸¤ç§ä¸ä¼šé€šè¿‡å…¬ç½‘ï¼Œå…¶å®ç°æŠ€æœ¯ç§°ä¹‹ä¸º Private Linkã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"3.1 Gateway Endpoint ä½¿ç”¨ Gateway Endpoint åªèƒ½è¿æ¥ç‰¹å®šçš„ AWS æœåŠ¡ï¼šS3 ä¸ DynamoDBã€‚æˆ–è€…è¯´ï¼Œå½“ä½ åˆ›å»º Endpoint æ˜¯è¿æ¥çš„æ˜¯ S3 æˆ–è€… DynamoDB æœåŠ¡ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ Gateway Endpointã€‚ ä½¿ç”¨ Gateway Endpoint çš„æ­¥éª¤ï¼š åˆ›å»º Endpointï¼Œåˆ›å»ºæ—¶é€‰æ‹©ç›®æ ‡æœåŠ¡ä¸º Gateway ç±»å‹çš„ DynamoDB æˆ– S3ã€‚ é…ç½® Route Tableï¼Œæ˜¯æµé‡èƒ½å¤ŸæŒ‡å‘å¯¹åº” Endpoint çš„ vpce-idã€‚ Destination Target Status Propagated pl-6ea54007 vpc-a2984bc5 Active No Instance é€šè¿‡ Service åŸŸåæ¥è®¿é—® Endpointã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:3:1","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"3.2 Interface Endpoint å¤§å¤šæ•° AWS Service å¯ä»¥é€šè¿‡ Interface Endpoint è¿›è¡Œè¿æ¥ã€‚åˆ›å»º Interface Endpoint ç›¸å½“äºåˆ›å»ºä¸€ä¸ª Network Interfaceï¼Œæœ‰ç€ Private IP ä¸ Private DNSã€‚ ä½¿ç”¨ Interface Endpoint çš„æ­¥éª¤ï¼š åˆ›å»º Endpointï¼Œåˆ›å»ºæ—¶é€‰æ‹©éœ€è¦çš„ç›®æ ‡ AWS æœåŠ¡ã€‚ Instance é€šè¿‡ Private IP æˆ–è€… Private DNS æ¥è®¿é—® Serviceã€‚ æ”¯æŒ S3 ä¸ DynamoDB Interface Endpoint æ˜¯æ”¯æŒè¿æ¥ S3 ä¸ DynamoDB Service çš„ã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:3:2","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"3.3 Gateway Load Balancer Endpoint Gateway Load Balancer Endpoint èƒ½å¤Ÿå°†æµé‡è·¯ç”±åˆ° Gateway Load Balancerï¼Œç„¶åç”± Load Balancer è´Ÿè½½å‡è¡¡åˆ°ä¸‹æ¸¸çš„ Serviceã€‚ åˆ›å»º Endpoint çš„ç§°ä¸º Service Consumerï¼Œä¸‹æ¸¸çš„ Service ç§°ä¸º Service Providerã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:3:3","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"4 Endpoint Service ä½ ä¹Ÿå¯ä»¥å°†è‡ªå·±çš„ç¨‹åºä½œä¸ºä¸€ä¸ª Endpoint Serviceï¼Œä½¿å¾—åˆ«äººå¯ä»¥é€šè¿‡ Interface Endpoint æ¥è®¿é—®ä½ çš„æœåŠ¡ã€‚ Endpoint Service çš„å…¥å£æ˜¯ä¸€ä¸ª LBï¼šNetwork Load Balancer æˆ– Gateway Load Balancerã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:4:0","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"å‚è€ƒ AWS PrivateLink and VPC endpoints ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/:5:0","tags":["aws"],"title":"AWS å­¦ä¹  - 5 - VPC ä¸ Service é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/5-vpc-and-aws/"},{"categories":["AWS å­¦ä¹ "],"content":"Internet Gatewayã€NAT Device","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/","tags":["aws"],"title":"AWS å­¦ä¹  - 4 - VPC ä¸ Internet é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/"},{"categories":["AWS å­¦ä¹ "],"content":"1 Internet Gateway Internet Gateway ç”¨äºå°† VPC çš„æµé‡è½¬å‘ç»™å¤–ç½‘ï¼Œå¹¶å°†å¤–ç½‘çš„ä¸»åŠ¨è®¿é—®è½¬å‘ç»™æŒ‡å®šçš„ Instanceã€‚ ä½¿ç”¨ Internet Gateway çš„å¿…è¦æ“ä½œï¼š åˆ›å»º Internet Gateway å¹¶å…³è”åˆ° VPC ä¸Šã€‚ Instance æ‹¥æœ‰å…¬ç½‘ IP åœ°å€ï¼šPublic IPã€Elastic IP æˆ–è€… IPv6ã€‚ Route Table èƒ½å¤Ÿå°† Instance çš„æµé‡è½¬å‘åˆ° Internet Gatewayã€‚ Security Group ä¸ Network ACL ä¸ä¼šæ‹¦æˆª Instance çš„æµé‡ã€‚ Internet Gateway å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä»½ Public IP ä¸ Private IP çš„æ˜ å°„å…³ç³»ï¼Œå…¶åŸç†å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š å¯¹äº Outbound æµé‡ï¼ŒInternet Gateway ä¼šå°†æ•°æ®åŒ…æºåœ°å€ä» Private IP å˜ä¸ºå¯¹åº”çš„ Public IP/Elastic IPã€‚ å¯¹äº Inbound æµé‡ï¼ŒInternet Gateway ä¼šæ ¹æ®æ•°æ®åŒ…æºåœ°å€ï¼ŒåŒ¹é… Public IP/Elastic IPï¼Œç„¶åå°†ç›®çš„åœ°å€å˜ä¸º Private IP è½¬å‘ç»™ Instanceã€‚ Instance åªèƒ½çœ‹åˆ° Private IP è¦æ˜ç¡®ï¼Œæ‰€è°“çš„ Public IP ä¸ Elastic IP éƒ½æ˜¯é’ˆå¯¹äº Internet Gateway è®¾ç½®çš„ï¼Œå› ä¸º Instance æ ¹æœ¬å°±æ— æ³•çŸ¥æ™“è‡ªå·±æœ‰ç€å…¬ç½‘ IP åœ°å€ã€‚ æ„Ÿè§‰å°±å¥½åƒåœ¨è·¯ç”±å™¨ä¸Šè®¾ç½®äº†å†…ç½‘ IP åˆ°å¤–ç½‘ IP çš„ä¸€å¯¹ä¸€æ˜ å°„ã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 4 - VPC ä¸ Internet é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/"},{"categories":["AWS å­¦ä¹ "],"content":"2 Egress-only Internet Gateway å½“ Instance æœ‰ç€ IPv6 åœ°å€æ—¶ï¼Œèƒ½å¤Ÿé€šè¿‡ Internet Gateway è®¿é—®å¤–ç½‘ã€‚åŒæ—¶ï¼ŒIPv6 ä¹Ÿæ˜¯æš´éœ²åœ¨å…¬ç½‘çš„ï¼Œå¤–ç½‘å¯ä»¥ä¸»åŠ¨é€šè¿‡ IPv6 è®¿é—® Instanceã€‚ ä½¿ç”¨ Egress-only Internet Gateway å¯ä»¥é˜»æ­¢å¤–ç½‘ä¸»åŠ¨è®¿é—® IPv6ã€‚è¿™è¡¨æ˜ä½ çš„ Instance ä»…ä»…åªèƒ½ä½œä¸ºä¸€ä¸ª Clientï¼Œè€Œä¸èƒ½ä½œä¸º Serverã€‚ Egress-only Internet Gateway å½“ç„¶æ˜¯æœ‰çŠ¶æ€çš„ï¼Œèƒ½å°† response è½¬å‘ç»™å¯¹åº”çš„ Instanceã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 4 - VPC ä¸ Internet é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/"},{"categories":["AWS å­¦ä¹ "],"content":"3 NAT Device NAT Device å…è®¸ Private Subnet ä¸­çš„ Instance è®¿é—® Internetï¼ŒNAT Device ä¼šå°†æ•°æ®åŒ…çš„æºåœ°å€ IP æ›¿æ¢ä¸º NAT Device çš„ Elastic IPã€‚ NAT Device æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå½“å‘å®ä¾‹å‘é€å›å¤æ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œç›®æ ‡åœ°å€è½¬æ¢ï¼Œå¹¶è½¬å‘ç»™æŒ‡å®šçš„ Instanceã€‚ ","date":"2021-11-29","objectID":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 4 - VPC ä¸ Internet é€šä¿¡","uri":"/posts/cloud_computing/aws_learning/4-vpc-and-internet/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"CSI æ¦‚å¿µä¸å®ç°","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 è®¾è®¡åŸç† åœ¨ æºç é˜…è¯» - Volume å®ç° ä¸­çœ‹åˆ°ï¼Œæ‰€æœ‰çš„å­˜å‚¨æ’ä»¶å®ç°çš„éƒ½æ˜¯æ“ä½œ Volume çš„æ–¹æ³•ï¼š Provision Volume Attach Volume Mount Device Setup Volume CSI æ•´ä½“ä½“ç³»çš„æ¶æ„å¦‚ä¸‹å›¾ Sidecar å®¹å™¨ æ˜¯ä¸€ç»„ Kubernetes ç¤¾åŒºç»´æŠ¤çš„æ ‡å‡†å®¹å™¨ï¼Œä»¥å‡å°‘å®ç° CSI çš„é‡å¤ä»£ç ã€‚ CSI Driver å°±æ˜¯æˆ‘ä»¬éœ€è¦ç¼–å†™çš„ CSI æ’ä»¶äº†ï¼Œä¸€ä¸ª CSI æ’ä»¶åªæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥ gRPC æ–¹å¼å¯¹å¤–æä¾›ä¸‰ä¸ªæœåŠ¡ï¼š CSI Identity CSI Controller CSI Node ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 Sidecar Containers Sidecar å®¹å™¨ä¼šåŒ…å« Watch èµ„æºçš„å·¥ä½œï¼Œå¹¶æ‰§è¡Œ CSI Driver çš„å›è°ƒå‡½æ•°ï¼Œç„¶åæ›´æ–°ç›¸å…³çš„èµ„æºã€‚ é€šå¸¸ï¼Œè¿™äº›å®¹å™¨ç”¨äºä¸ CSI Driver çš„å®¹å™¨æ†ç»‘ï¼Œä½œä¸ºä¸€ä¸ª Pod éƒ¨ç½²åœ¨ä¸€èµ·ã€‚ ç›®å‰å¼€å‘çš„ CSI Sidecar å®¹å™¨åŒ…æ‹¬ï¼š node-driver-registrar å®¹å™¨è°ƒç”¨ CSI Node çš„ NodeGetInfo() æ¥å£ï¼Œå°† CSI Node æ³¨å†Œåˆ° Kubeletã€‚ external-provisioner å®¹å™¨ä¼š Watch PersistentVolumeClaim èµ„æºï¼Œå¹¶è°ƒç”¨ CSI Controller çš„ CreateVolume() æ¥å£æ¥åˆ›å»ºä¸€ä¸ª Volumeã€‚ external-attacher å®¹å™¨ä¼š Watch VolumeAttachment èµ„æºï¼Œå¹¶è°ƒç”¨ CSI Controller çš„ ControllerPublishVolume() ä¸ ControllerUnpublishVolume() æ¥å£ï¼Œå°† Volume Attach åˆ°æŒ‡å®šçš„ Nodeã€‚ Note external-attacher ä»…ä»…ç”¨äº Attach æ“ä½œï¼Œè€Œ Volume çš„ MountDevice ä¸ Setup æ“ä½œï¼Œéƒ½æ˜¯ç”± Kubelet ç›´æ¥è°ƒç”¨ CSI Node æ’ä»¶çš„æ¥å£å®ç°çš„ã€‚ external-snapshotter snapshot controller å®¹å™¨ä¼š Watch VolumeSnapshot ä¸ VolumeSnapshotContent èµ„æºï¼Œsnapshotter å®¹å™¨ä¼š Watch VolumeSnapshotConent èµ„æºï¼Œå¹¶è´Ÿè´£è°ƒç”¨ CSI Controller æ’ä»¶çš„ CreateSnapshot()ã€DeleteSnapshot() ä¸ ListSnapshot() æ¥å£ã€‚ external-resizer å®¹å™¨ Watch PersistentVolumeClaim èµ„æºçš„ä¿®æ”¹äº‹ä»¶ï¼Œå½“ç”¨æˆ·è¯·æ±‚æ‰©å®¹ PVC æ—¶ï¼Œè°ƒç”¨ CSI Controller çš„ ControllerExpandVolume() æ¥å£æ‰©å®¹ Volumeã€‚ livenessprobe å®¹å™¨ä¼šç›‘æ§ CSI æ’ä»¶çš„ç›‘æ§çŠ¶æ€ï¼Œå¹¶é€šè¿‡ Liveness Probe æä¾›ç»™ Kubernetesã€‚ Note æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ Kubernetes CSI Sidecar Containers æ¥äº†è§£å®Œæ•´çš„ Sidecar å®¹å™¨ã€‚ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.2 CSI Driver CSI Driver å…·ä½“å®ç°äº†å¯¹ Volume çš„æ‰€æœ‰æ“ä½œï¼Œæœ¬è´¨ä¸Šéœ€è¦å®ç°ä¸€ä¸ª gRPC Serverï¼Œç”± Kubernetes è°ƒç”¨å…·ä½“çš„æ¥å£ã€‚ Note å…·ä½“çš„åè®®å®šä¹‰è§ csi.proto 1.2.1 CSI Identity CSI Identity æœåŠ¡ç”¨äºæä¾›æ’ä»¶çš„ä¸€äº›ä¿¡æ¯ã€‚ service Identity { // è¿”å›æ’ä»¶çš„ name ä¸ version rpc GetPluginInfo(GetPluginInfoRequest) returns (GetPluginInfoResponse) {} // å¾—åˆ°æ’ä»¶æ‹¥æœ‰çš„åŠŸèƒ½ rpc GetPluginCapabilities(GetPluginCapabilitiesRequest) returns (GetPluginCapabilitiesResponse) {} // æŸ¥è¯¢æ’ä»¶æ˜¯å¦æ­£åœ¨è¿è¡Œä¸­ rpc Probe (ProbeRequest) returns (ProbeResponse) {}} 1.2.2 CSI Controller CSI Controller æœåŠ¡å®šä¹‰äº†å¯¹ Volume çš„ç®¡ç†æ¥å£ï¼ŒåŒ…æ‹¬ï¼šProvision/Deleteã€Attach/Detachã€Snapshot ç­‰æ“ä½œã€‚è¿™äº›æ“ä½œéƒ½æ˜¯å±äº Controller çš„æ“ä½œï¼Œåœ¨ Master èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚ service Controller { // åˆ›å»ºä¸€ä¸ª Volume rpc CreateVolume (CreateVolumeRequest) returns (CreateVolumeResponse) {} // åˆ é™¤ä¸€ä¸ª Volume rpc DeleteVolume (DeleteVolumeRequest) returns (DeleteVolumeResponse) {} // Attach Volume åˆ°æŒ‡å®šçš„ Node rpc ControllerPublishVolume (ControllerPublishVolumeRequest) returns (ControllerPublishVolumeResponse) {} // Detach Volume rpc ControllerUnpublishVolume (ControllerUnpublishVolumeRequest) returns (ControllerUnpublishVolumeResponse) {} // æ£€æŸ¥ä¸€ä¸ª Volume çš„èƒ½åŠ› rpc ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest) returns (ValidateVolumeCapabilitiesResponse) {} // æŸ¥è¯¢å·²ç»åˆ›å»ºçš„æ‰€æœ‰çš„ Volume rpc ListVolumes (ListVolumesRequest) returns (ListVolumesResponse) {} // æŸ¥è¯¢å­˜å‚¨æ± çš„å®¹é‡ rpc GetCapacity (GetCapacityRequest) returns (GetCapacityResponse) {} // æŸ¥è¯¢ Controller æ”¯æŒçš„åŠŸèƒ½ rpc ControllerGetCapabilities (ControllerGetCapabilitiesRequest) returns (ControllerGetCapabilitiesResponse) {} // åˆ›å»ºä¸€ä¸ª Snapshot rpc CreateSnapshot (CreateSnapshotRequest) returns (CreateSnapshotResponse) {} // åˆ é™¤ä¸€ä¸ª Snapshot rpc DeleteSnapshot (DeleteSnapshotRequest) returns (DeleteSnapshotResponse) {} // æŸ¥è¯¢æ‰€æœ‰åˆ›å»ºçš„ Snapshot rpc ListSnapshots (ListSnapshotsRequest) returns (ListSnapshotsResponse) {} // æ‰©å®¹ä¸€ä¸ª Volume rpc ControllerExpandVolume (ControllerExpandVolumeRequest) returns (ControllerExpandVolumeResponse) {} // æŸ¥è¯¢ä¸€ä¸ª Volume rpc ControllerGetVolume (ControllerGetVolumeRequest) returns (ControllerGetVolumeResponse) { option (alpha_method) = true; }} 1.2.3 CSI Node CSI Node æä¾›åœ¨ Node ä¸Šçš„æ“ä½œï¼ŒåŒ…æ‹¬ MountDevice ä¸ Setup ç­‰æ“ä½œã€‚ service Node { // å°† Volume æŒ‚è½½åˆ°ä¸€ä¸ªå…¨å±€ç›®å½•ï¼Œå³ MountDevice æ“ä½œ rpc NodeStageVolume (NodeStageVolumeRequest) returns (NodeStageVolumeResponse) {} // å°† Volume å–æ¶ˆæŒ‚è½½å…¨å±€ç›®å½• rpc NodeUnstageVolume (NodeUnstageVolumeRequest) returns (NodeUnstageVolumeResponse) {} // å°† Volume æŒ‚è½½åˆ° Pod ç›®å½•ï¼Œå³ Setup æ“ä½œ rpc NodePublishVolume (NodePublishVolumeRequest) returns (NodePublishVolumeResponse) {} // å°† Volume å–æ¶ˆæŒ‚è½½ Pod ç›®å½• rpc NodeUnpublishVolume (NodeUnpublishVolumeRequest) returns (NodeUnpublishVolumeResponse) {} // è¿”å› Volume ä¿¡æ¯ rpc NodeGetVolumeStats (NodeGetVolumeStatsRequest) returns (NodeGetVolumeStatsResponse) {} // æ‰©å®¹ Volume rpc NodeExpandVolume(NodeExpandVolumeRequest) returns (NodeExpandVolumeResponse) {} // è¿”å› Node æ’ä»¶åŠŸèƒ½ï¼Œä¾‹å¦‚æ˜¯å¦åªæ˜¯ stage/unstage rpc NodeGetCapabilities (NodeGetCapabilitiesRequest) returns (NodeGetCapabilitiesResponse) {} // è¿”å›æ’ä»¶å¯¹åº”çš„èŠ‚ç‚¹ä¿¡æ¯ rpc NodeGetInfo (NodeGetInfoRequest) returns (NodeGetInfoResponse) {}} ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 CSI ç›¸å…³èµ„æºå¯¹è±¡ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 CSIDriver CSIDriver ç”¨äºè®© Kubernetes å‘ç°è¯¥ CSI æ’ä»¶ï¼Œå¹¶çŸ¥æ™“å…¶æ‹¥æœ‰çš„åŠŸèƒ½ã€‚ apiVersion:storage.k8s.io/v1kind:CSIDrivermetadata:name:mycsidriver.example.comspec:attachRequired:truepodInfoOnMount:truefsGroupPolicy:File# added in Kubernetes 1.19, this field is GA as of Kubernetes 1.23volumeLifecycleModes:# added in Kubernetes 1.16, this field is beta- Persistent- EphemeraltokenRequests:# added in Kubernetes 1.20. See status at https://kubernetes-csi.github.io/docs/token-requests.html#status- audience:\"gcp\"- audience:\"\"# empty string means defaulting to the `--api-audiences` of kube-apiserverexpirationSeconds:3600requiresRepublish:true# added in Kubernetes 1.20. See status at https://kubernetes-csi.github.io/docs/token-requests.html#status name - CSI Driver çš„åå­— attachRequired - è¡¨ç¤º Volume æ˜¯å¦éœ€è¦ Attach æ“ä½œï¼ˆKubernetes æ˜¯å¦éœ€è¦åˆ›å»º VolumeAttachment èµ„æºï¼‰ podInfoOnMount - è¡¨æ˜å½“è°ƒç”¨ Mount æ“ä½œæ—¶ï¼Œæ˜¯å¦éœ€è¦ä¼ é€’é¢å¤–çš„ Pod ä¿¡æ¯ç»™ CSI Driver fsGroupPolicy - è¡¨ç¤º CSI Driver æ˜¯å¦æ”¯æŒï¼šå½“ Mount Volume æ—¶ï¼Œä¿®æ”¹ Volume çš„æ‰€æœ‰æƒä¸æƒé™ volumeLifecycleModes - Volume æ”¯æŒçš„æ¨¡å¼ tokenRequests - Kubelet è°ƒç”¨ CSI Node çš„ NodePublishVolume() æ¥å£æ—¶æ˜¯å¦éœ€è¦æä¾› Pod çš„ ServiceAccount requiresRepublish - ä¸º true æ—¶ï¼ŒKubelet ä¼šå‘¨æœŸæ€§è°ƒç”¨ CSI Node çš„ NodePublishVolume() æ¥å£ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 CSINode CSI Driver å¯ä»¥ç”Ÿæˆç‰¹å®šçš„å…³äº Node çš„ä¿¡æ¯ï¼Œå°†å…¶ä¿å­˜åˆ° CSINode å¯¹è±¡ä¸­ï¼Œè€Œä¸ç”¨å°†ä¿¡æ¯ä¿å­˜åˆ° Kubernetes Node å¯¹è±¡ä¸­ã€‚Kubernetes ä¼šåˆ›å»º CSINode å¯¹è±¡ï¼Œå¹¶æ ¹æ®å·²ç»æ³¨å†Œçš„ CSIDriver æ¥å¡«å…… CSINode ä¿¡æ¯ã€‚ kind:CSINodemetadata:name:kube-node-5ownerReferences:- apiVersion:v1kind:Nodename:kube-node-5uid:f442c38a-f0f3-4a79-8153-3e5bcd7c91a4spec:drivers:- name:hostpath.csi.k8s.ionodeID:kube-node-5topologyKeys:- topology.hostpath.csi/node drivers - è¯¥ Node ä¸Šè¿è¡Œçš„æ‰€æœ‰ CSI Driver name - CSI Driver çš„åå­— nodeID - Driver æä¾›çš„è¯¥ Node ID topologyKeys - é’ˆå¯¹äºè¯¥ CSI çš„ Topology Key ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 PersistentVolumeClaim å½“ç”¨æˆ·éƒ¨ç½²å¯¹åº” CSI æ’ä»¶çš„ PVC æ—¶ï¼Œç”± CSI Controller æ¥è´Ÿè´£åˆ›å»ºå¯¹åº”çš„ PV å¹¶ç»‘å®šåˆ°æŒ‡å®šçš„ PVCã€‚ç­‰å¾… PVC ä¸ PV ç›¸äº’ç»‘å®šåï¼ŒKubernetes å°±ç»§ç»­è¿›è¡Œ Attach ç­‰æµç¨‹äº†ã€‚ PV å®šä¹‰ä¸­ä½¿ç”¨ spec.csi å­—æ®µæ¥è¡¨æ˜è¯¥ PV æ˜¯ CSI æä¾›çš„ã€‚ apiVersion:v1kind:PersistentVolumemetadata:name:pv0003spec:# ...csi:driver:hostpath.csi.k8s.iovolumeHandle:5a760aab-d579-11eb-ba5c-fa03df0e077dreadonly:falsefsType:FilesystemvolumeAttributes:kind:standardstorage.kubernetes.io/csiProvisionerIdentity:1624246373313-8081-hostpath.csi.k8s.io-kube-node-5# controllerPublishSecretRef: []# nodeStageSecretRef: []# nodePublishSecretRef: [] driver - CSI Driver çš„åå­— volumeHandle - æ’ä»¶æä¾›çš„ Volume IDï¼Œç”¨äº Kubernetes ä¸æ’ä»¶å…±åŒæ ‡è¯†è¯¥ Volume readonly - è¡¨æ˜ Volume æ˜¯å¦æ˜¯åªè¯» fsType - Volume ç±»å‹ volumeAttributes - Volume çš„ä¸€äº›å…ƒä¿¡æ¯ï¼Œå°†é€šè¿‡ volume_context ä¼ é€’ç»™ CSI æ’ä»¶ controllerPublishSecretRef - è°ƒç”¨ CSI Controller çš„ ControllerPublishVolume() ä¸ ControllerUnpublishVolume() æ—¶ä¼ é€’çš„ Secret å¯¹è±¡ nodeStageSecretRef - è°ƒç”¨ CSI Node çš„ NodeStageVolume() æ—¶ä¼ é€’çš„ Secret å¯¹è±¡ nodePublishSecretRef - è°ƒç”¨ CSI Node çš„ NodePublishVolume() æ—¶ä¼ é€’çš„ Secret å¯¹è±¡ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 VolumeAttachment å½“ Kubernetes éœ€è¦ Attach Volume æ—¶ï¼Œå…¶ Kubernetes ä¼šåˆ›å»º VolumeAttachment èµ„æºè¡¨ç¤ºéœ€è¦è¿›è¡Œ Attachï¼Œè€Œ CSI Controller éœ€è¦ç›‘å¬ VolumeAttachment èµ„æºç„¶åè¿›è¡Œå®é™…çš„ Attach æ“ä½œã€‚ apiVersion:storage/v1kind:VolumeAttachmentmetadata:name:pv0003spec:attacher:www.example.csi.comnodeName:node-1source:persistentVolumeName:pvc0003inlineVolumeSpec:# pvc specstatus:attached:trueattachmentMetadata:{}# attachError:# time:# message:# detachError:# time:# message: spec attacher - éœ€è¦æ‰§è¡Œ Attach æ“ä½œçš„ CSI Driver nodeName - ç›®æ ‡ Node source persistentVolumeName - æŒ‡å®šè¢« Attach çš„ PVC inlineVolumeSpec - ä½¿ç”¨å†…è”çš„ PVC status attached - è¡¨æ˜æ˜¯å¦æˆåŠŸ Attach attachmentMetadata - Attach æˆåŠŸåå¡«å……çš„ä¸€äº›å…ƒä¿¡æ¯ï¼Œä»¥æä¾›ç»™åç»­çš„æ“ä½œ attachError - ä¸Šä¸€æ¬¡ Attach å¤±è´¥ä¿¡æ¯ detachError - ä¸Šä¸€æ¬¡ Detach å¤±è´¥ä¿¡æ¯ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 CSI å®ç° åœ¨ Kubernetes å®ç°ä¸­ï¼ŒCSI VolumePlugin å®ç°äº† VolumePlugin æ¥å£ï¼Œæä¾›äº† Attach ä¸ SetUp ç­‰æ“ä½œï¼Œå…¶æœ¬è´¨å°±æ˜¯åˆ›å»ºèµ„æºæˆ–è€…è°ƒç”¨ç‰¹å®š CSI æ’ä»¶çš„æ¥å£ï¼Œç±»ä¼¼äºä¸€ä¸ªä¸­é—´å±‚ã€‚ CSI æ’ä»¶ä¸éœ€è¦æ³¨å†Œåˆ° Controller å±‚ä¸­ï¼Œç›¸äº’ä¹‹é—´å®Œå…¨å›´ç»•ç€ Kubernetes èµ„æºè¿›è¡Œäº¤äº’ã€‚ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 Controller å±‚å®ç° ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒController å±‚ä¸»è¦æ‰§è¡Œäº† Create/Deleteã€Attach/Detach å’Œ Snapshot æ“ä½œã€‚Create/Delete æ“ä½œæ˜¯ç”± CSI Controller æ’ä»¶ç›‘å¬å¹¶æ‰§è¡Œï¼Œå› æ­¤ä¸éœ€è¦ Kubernetes ä¸­è¿›è¡Œä»£ç å®ç°ã€‚ è€Œ Attach/Detach å’Œ Snapshot æ“ä½œå°±æ˜¯åœ¨ VolumePlugin æ¥å£å®ç°ä¸Šï¼Œåˆ›å»ºå¯¹åº”çš„ VolumeAttachment å’Œ VolumeSnapshot ç­‰èµ„æºï¼Œç„¶åç­‰å¾… CSI Controller æ‰§è¡Œæ“ä½œã€‚ type csiPlugin struct { host volume.VolumeHost csiDriverLister storagelisters.CSIDriverLister serviceAccountTokenGetter func(namespace, name string, tr *authenticationv1.TokenRequest) (*authenticationv1.TokenRequest, error) volumeAttachmentLister storagelisters.VolumeAttachmentLister } // ProbeVolumePlugins returns implemented plugins func ProbeVolumePlugins() []volume.VolumePlugin { p := \u0026csiPlugin{ host: nil, } return []volume.VolumePlugin{p} } 3.1.1 Attacher csiPlugin å®ç°äº† CanAttach() æ¥å£ï¼Œç”¨äºè®© Kubernetes çŸ¥æ™“æ˜¯å¦éœ€è¦æ‰§è¡Œ Attach æ“ä½œã€‚ // CanAttach åˆ¤æ–­ Volume æ˜¯å¦éœ€è¦ Attach func (p *csiPlugin) CanAttach(spec *volume.Spec) (bool, error) { // inline Volume ä¸æ”¯æŒ inlineEnabled := utilfeature.DefaultFeatureGate.Enabled(features.CSIInlineVolume) if inlineEnabled { volumeLifecycleMode, err := p.getVolumeLifecycleMode(spec) if err != nil { return false, err } if volumeLifecycleMode == storage.VolumeLifecycleEphemeral { klog.V(5).Info(log(\"plugin.CanAttach = false, ephemeral mode detected for spec %v\", spec.Name())) return false, nil } } // å–å¾— PV å®šä¹‰ä¸ CSI Driver name pvSrc, err := getCSISourceFromSpec(spec) if err != nil { return false, err } driverName := pvSrc.Driver // æ£€æŸ¥è¯¥ CSI Driver æ˜¯å¦éœ€è¦ Attach skipAttach, err := p.skipAttach(driverName) if err != nil { return false, err } return !skipAttach, nil } func (p *csiPlugin) skipAttach(driver string) (bool, error) { // ... // å¾—åˆ°å¯¹åº”çš„ CSIDriver èµ„æº csiDriver, err := p.csiDriverLister.Get(driver) if err != nil { if apierrors.IsNotFound(err) { // CSIDriver å¯¹è±¡ä¸å­˜åœ¨ï¼Œé»˜è®¤ä¸ºéœ€è¦ Attach return false, nil } return false, err } // é€šè¿‡ spec.attachRequired åˆ¤æ–­æ˜¯å¦éœ€è¦ Attach if csiDriver.Spec.AttachRequired != nil \u0026\u0026 *csiDriver.Spec.AttachRequired == false { return true, nil } return false, nil } ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 Kubelet å±‚çš„å®ç° 3.2.1 Plugin Watcher - æ³¨å†Œæ’ä»¶ ä¸ Controller å±‚ä¸åŒï¼ŒKubelet éœ€è¦è°ƒç”¨ CSI Node çš„æ¥å£ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ³¨å†Œæœºåˆ¶ï¼Œè®© CSI æ’ä»¶æ³¨å†Œåˆ° Kubelet ä¸­ã€‚ Plugin Manager ä¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ª Plugin Watcherï¼ŒPlugin Watcher ä¼šç›‘æ§ä¸€ä¸ª socket æ ¹ç›®å½•åŠå…¶å­ç›®å½•ã€‚ä¸€æ—¦ç›®å½•æˆ–å­ç›®å½•ä¸­åˆ›å»ºäº† socket æ–‡ä»¶ï¼Œå°±è®¤å®šå…¶æ˜¯ä¸€ä¸ª â€œæ’ä»¶æ³¨å†Œâ€ äº‹ä»¶ï¼Œå°†å…¶ socket æ–‡ä»¶è·¯å¾„åŠ å…¥åˆ° desiredStateOfWorldï¼Œç­‰å¾…åç»­çš„åè°ƒå¤„ç†ã€‚ æ ¹ç›®å½•è·¯å¾„ æ’ä»¶æ³¨å†Œçš„æ ¹ç›®å½•è·¯å¾„ä¸º \u003ckubelet-root\u003e/plugins_registryï¼Œé»˜è®¤ä¸º /var/lib/kubelet/plugins_registryã€‚ // Watcher ç›‘æ§ Plugin çš„æ³¨å†Œ type Watcher struct { path string // æ ¹ç›®å½• fs utilfs.Filesystem fsWatcher *fsnotify.Watcher desiredStateOfWorld cache.DesiredStateOfWorld } Watcher.Start() ç»è¿‡åˆå§‹çš„æ‰«æä¸å¤„ç†åï¼Œä¼šå¯åŠ¨ä¸€ä¸ª Goroutine ç›‘æ§æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ï¼Œå¹¶å¤„ç†ã€‚ func (w *Watcher) Start(stopCh \u003c-chan struct{}) error { // åˆ›å»ºæ ¹ç›®å½• if err := w.init(); err != nil { return err } // åˆ›å»º fs watcher fsWatcher, err := fsnotify.NewWatcher() if err != nil { return fmt.Errorf(\"failed to start plugin fsWatcher, err: %v\", err) } w.fsWatcher = fsWatcher // æ‰«æå½“å‰æ ¹ç›®å½• if err := w.traversePluginDir(w.path); err != nil { klog.ErrorS(err, \"Failed to traverse plugin socket path\", \"path\", w.path) } // å¯åŠ¨ç›‘æ§æ–‡ä»¶ç³»ç»Ÿçš„ Groutine go func(fsWatcher *fsnotify.Watcher) { for { select { case event := \u003c-fsWatcher.Events: if event.Op\u0026fsnotify.Create == fsnotify.Create { // å¤„ç†æ–‡ä»¶åˆ›å»ºäº‹ä»¶ err := w.handleCreateEvent(event) } else if event.Op\u0026fsnotify.Remove == fsnotify.Remove { // å¤„ç†æ–‡ä»¶åˆ é™¤äº‹ä»¶ w.handleDeleteEvent(event) } continue case err := \u003c-fsWatcher.Errors: if err != nil { klog.ErrorS(err, \"FsWatcher received error\") } continue case \u003c-stopCh: w.fsWatcher.Close() return } } }(fsWatcher) return nil } func (w *Watcher) traversePluginDir(dir string) error { // æ·»åŠ æ ¹ç›®å½•çš„ç›‘æ§ err := w.fsWatcher.Add(dir) // éå†æ ¹ç›®å½•å¤„ç† return w.fs.Walk(dir, func(path string, info os.FileInfo, err error) error { // ... // do not call fsWatcher.Add twice on the root dir to avoid potential problems. if path == dir { return nil } switch mode := info.Mode(); { case mode.IsDir(): // æ ¹ç›®å½•ä¸‹çš„å­ç›®å½•é¡µåŠ å…¥ç›‘æ§ err := w.fsWatcher.Add(path) case mode\u0026os.ModeSocket != 0: // socket æ–‡ä»¶è¿›è¡Œå¤„ç† event := fsnotify.Event{ Name: path, Op: fsnotify.Create, } w.handleCreateEvent(event) } return nil }) } handleCreateEvent() ä¸ handleDeleteEvent() å°±æ˜¯å°† socket æ–‡ä»¶è·¯å¾„ æ·»åŠ /ç§»é™¤ åˆ° desiredStateOfWorldã€‚ func (w *Watcher) handleCreateEvent(event fsnotify.Event) error { // stat file fi, err := os.Stat(event.Name) // ... if !fi.IsDir() { isSocket, err := util.IsUnixDomainSocket(util.NormalizePath(event.Name)) // å¿½ç•¥å…¶ä»–ç±»å‹æ–‡ä»¶ if !isSocket { return nil } // å¦‚æœæ˜¯ socket æ–‡ä»¶ï¼Œæ³¨å†Œåˆ° desiredStateOfWorld return w.handlePluginRegistration(event.Name) } // å¦‚æœæ˜¯å­ç›®å½•ï¼Œç»§ç»­ç›‘æ§ä¸å¤„ç† return w.traversePluginDir(event.Name) } func (w *Watcher) handlePluginRegistration(socketPath string) error { err := w.desiredStateOfWorld.AddOrUpdatePlugin(socketPath) if err != nil { return fmt.Errorf(\"error adding socket path %s or updating timestamp to desired state cache: %v\", socketPath, err) } return nil } func (w *Watcher) handleDeleteEvent(event fsnotify.Event) { socketPath := event.Name w.desiredStateOfWorld.RemovePlugin(socketPath) } 3.2.2 Plugin Manager - æ’ä»¶ç®¡ç† Kubelet ä¸­å®ç°äº† Plugin Manager è¿›è¡Œæ’ä»¶çš„è®°å½•ä¸ç®¡ç†ï¼Œå…¶è¿˜æ˜¯ä¾é  actualStateOfWorld ä¸ desiredStateOfWorld åè°ƒï¼Œæ ¹æ® Add/Remove äº‹ä»¶è°ƒç”¨æ³¨å†Œçš„ RegisterPlugin() ä¸ DeRegisterPlugin() å›è°ƒã€‚ å…¶æ ¸å¿ƒé€»è¾‘ç”± Reconciler å®ç°ã€‚ // Reconciler runs a periodic loop to reconcile the desired state of the world // with the actual state of the world by triggering register and unregister // operations. Also provides a means to add a handler for a plugin type. type Reconciler interface { // è¿è¡Œ Reconciler Run(stopCh \u003c-chan struct{}) // æ³¨å†Œ Plugin äº‹ä»¶çš„å›è°ƒ AddHandler(pluginType string, pluginHandler cache.PluginHandler) } type reconciler struct { operationExecutor operationexecutor.OperationExecutor loopSleepDuration time.Duration desiredStateOfWorld cache.DesiredStateOfWorld actualStateOfWorld cache.ActualStateOfWorld handlers map[string]cache.PluginHandler // Plugin äº‹ä»¶å›è°ƒ sync.RWMutex } å‘¨æœŸæ€§çš„åè°ƒæµç¨‹ä¾æ—§æ˜¯å¯¹æ¯” actualStateOfWorld ä¸ desiredStateOfWorld è¿›è¡Œå¤„ç†ï¼Œå¹¶è°ƒç”¨å¯¹åº”æ³¨å†Œçš„ PluginHandlerã€‚ func (rc *reconciler) reconcile() { // éå† actualStateOfWorld for _, registeredPlugin := range rc.actualStateOfWorl","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.3 CSI Plugin å®ç° ä» æºç é˜…è¯» - Volume å®ç° ä¸­æˆ‘ä»¬çŸ¥æ™“äº†ï¼ŒKubelet åº•å±‚è¿˜æ˜¯ä½¿ç”¨æŸä¸ª VolumePlugin çš„å®ç°çš„æ¥å£è¿›è¡Œ Volume æ“ä½œã€‚è€Œåœ¨ CSI æƒ…å†µä¸‹ï¼Œå…¶è°ƒç”¨çš„å°±æ˜¯ CSI VolumePluginã€‚ CSI VolumePlugin æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª Plugin Managerï¼Œå…¶ä¼šæ ¹æ® Volume ç±»å‹è°ƒç”¨æŒ‡å®šçš„ CSI Plugin çš„æ¥å£ã€‚æˆ‘ä»¬ä»¥ CSI Mounter ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ€åè°ƒç”¨äº† CSI Node çš„ NodePublishVolume æ¥å£ã€‚ type csiPlugin struct { host volume.VolumeHost csiDriverLister storagelisters.CSIDriverLister serviceAccountTokenGetter func(namespace, name string, tr *authenticationv1.TokenRequest) (*authenticationv1.TokenRequest, error) volumeAttachmentLister storagelisters.VolumeAttachmentLister } func (c *csiMountMgr) SetUpAt(dir string, mounterArgs volume.MounterArgs) error { // å¾—åˆ° CSI Node csi, err := c.csiClientGetter.Get() // è§£æ Volume é…ç½® // åˆ›å»º Pod çš„ç›®å½• parentDir := filepath.Dir(dir) if err := os.MkdirAll(parentDir, 0750); err != nil { return errors.New(log(\"mounter.SetUpAt failed to create dir %#v: %v\", parentDir, err)) } // è¯»å– Secret nodePublishSecrets = map[string]string{} if secretRef != nil { nodePublishSecrets, err = getCredentialsFromSecret(c.k8s, secretRef) } // CSI Driver çš„ `podInfoOnMount` åŠŸèƒ½å®ç° podInfoEnabled, err := c.plugin.podInfoEnabled(string(c.driverName)) if podInfoEnabled { volAttribs = mergeMap(volAttribs, getPodInfoAttrs(c.pod, c.volumeLifecycleMode)) } // CSI Driver çš„ `tokenRequest` åŠŸèƒ½å®ç° serviceAccountTokenAttrs, err := c.podServiceAccountTokenAttrs() volAttribs = mergeMap(volAttribs, serviceAccountTokenAttrs) // CSI Driver çš„ `fsGroupPolicy` åŠŸèƒ½å®ç° driverSupportsCSIVolumeMountGroup := false var nodePublishFSGroupArg *int64 if utilfeature.DefaultFeatureGate.Enabled(features.DelegateFSGroupToCSIDriver) { driverSupportsCSIVolumeMountGroup, err = csi.NodeSupportsVolumeMountGroup(ctx) if driverSupportsCSIVolumeMountGroup { nodePublishFSGroupArg = mounterArgs.FsGroup } } // è°ƒç”¨ CSI Node æ¥å£ err = csi.NodePublishVolume( ctx, volumeHandle, readOnly, deviceMountPath, dir, accessMode, publishContext, volAttribs, nodePublishSecrets, fsType, mountOptions, nodePublishFSGroupArg, ) // ... return nil } é‚£æœ€åçš„é—®é¢˜å°±æ˜¯ï¼ŒCSI Plugin æ˜¯å¦‚ä½•æ³¨å†Œåˆ° CSI VolumePlugin ä¸­çš„ï¼ŸCSI VolumePlugin å®ç°äº†å‰é¢æ‰€è¯´çš„ PluginHandler æ¥å£ï¼Œå¹¶åœ¨ Kubelet å¯åŠ¨æ—¶æ³¨å†Œåˆ°äº† Plugin Manager ä¸­ã€‚ å› æ­¤å½“æ–°çš„ CSI Plugin åˆ›å»º socket æ–‡ä»¶åï¼ŒKubelet çš„ Plugin Manager ç›‘å¬åˆ°åˆ›å»ºäº‹ä»¶ï¼Œç„¶åå›è°ƒ CSI VolumePlugin çš„ RegisterPlugin() çš„æ¥å£ï¼Œè®°å½•ä¸‹æ¥ã€‚ // RegisterPlugin is called when a plugin can be registered func (h *RegistrationHandler) RegisterPlugin(pluginName string, endpoint string, versions []string) error { // è®°å½•ä¸‹ CSI Plugin csiDrivers.Set(pluginName, Driver{ endpoint: endpoint, highestSupportedVersion: highestSupportedVersion, }) // ... return nil } ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.4 æ€»ç»“ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:3:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 å®ç°ä¸€ä¸ª CSI æ’ä»¶ ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ ã€ŠKubernetes CSI Developer Documentã€‹ CSI Spec ","date":"2021-11-20","objectID":"/posts/cloud_computing/k8s_learning/11-csi/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 11 - CSI","uri":"/posts/cloud_computing/k8s_learning/11-csi/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"Kubernetes Volume çš„èƒŒååŸç†","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° ä»¥ä¸€ä¸ªäº‘å­˜å‚¨ä½œä¸º Volume ä¸ºä¾‹ï¼Œå…¶æ¶æ„å›¾å¦‚ä¸‹ï¼š Deploy PVC - ç”¨æˆ· Deploy PVC å¯¹è±¡ã€‚ Provision Volume - PV Controller åŸºäº StorageClass åˆ›å»ºä¸€ä¸ª Volumeï¼ˆæ— æ³•ç»‘å®šå·²æœ‰ PV çš„æƒ…å†µä¸‹ï¼‰ï¼Œå¹¶åˆ›å»º PV å¯¹è±¡ã€‚ Bind PV - PV Controller å°† PV ä¸ PVC ç»‘å®šã€‚ Attach Volume - AttachDetach Controller Attach Volume åˆ° Node ä¸Šï¼ŒNode ä¸Šçœ‹æ¥æ˜¯ä¸€ä¸ªå—è®¾å¤‡ã€‚ Mount Device - Kubelet å°†å—è®¾å¤‡ Mount åˆ°ä¸€ä¸ªå…¨å±€çš„ç›®å½•ã€‚ Setup Volume - Kubelet å‡†å¤‡ Pod ç‰¹å®šçš„ç›®å½•ï¼Œè¯¥ç›®å½•åç»­ç”¨äºæŒ‚è½½åˆ°å„ä¸ªå®¹å™¨ä¸­çš„ç›®å½•ã€‚ ä¸Šè¿°è¿‡ç¨‹æ˜¯ä¸€ä¸ªå®Œæˆçš„è¿‡ç¨‹ï¼Œä¸åŒçš„ Volume ç±»å‹å¯èƒ½åªä¼šæ‰§è¡Œå…¶ä¸­çš„å‡ æ­¥ï¼Œä¾‹å¦‚ä¸€äº› â€œç‰¹æ®Šâ€ çš„ Volumeï¼ˆä¾‹å¦‚ hostpathã€secretã€configmap ç­‰ï¼‰ï¼Œä»…ä»…å®ç°äº† SetUp æ­¥éª¤ã€‚ å¯¹åº”çš„ï¼Œé”€æ¯æµç¨‹å°±æ˜¯åˆ›å»ºæµç¨‹çš„ç›¸åæ“ä½œï¼š TearDown Volume - Kubelet ç§»é™¤ä¸º Pod å‡†å¤‡çš„ç›®å½•ã€‚ Unmount Device - Unmount å…¨å±€ç›®å½•ã€‚ Detach Volume - ä» Node ä¸Š Detach Volumeã€‚ Delete - ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œåˆ é™¤è¯¥ Volumeã€‚ Note ä¸Šè¿°æ­¥éª¤å¾ˆé‡è¦ï¼Œæ˜¯åç»­æ‰€æœ‰ç»„ä»¶æ‰§è¡Œçš„æ“ä½œã€‚ ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Volume Plugin æ— è®ºæ˜¯æ§åˆ¶é¢çš„ Controller è¿˜æ˜¯ Kubeletï¼Œæ¶‰åŠåˆ°å®é™…çš„ Volume æ“ä½œï¼ˆCreate/Deleteã€Attach/Detach ç­‰ï¼‰æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨å¯¹åº”çš„ VolumePlugin æ¥å£ã€‚VolumePlugin ä¸ºç®¡ç†ç»„ä»¶æä¾›äº† æ¦‚è¿° ä¸­çš„å…·ä½“æ“ä½œæ¥å£ã€‚ ç›®å‰ Kubernetes å†…ç½®äº†è®¸å¤šçš„ Volume Pluginï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š å†…ç½® Volume - åŒ…æ‹¬ ConfigMapã€HostPathã€ä»¥åŠå„ä¸ªäº‘å‚å•†çš„ Volumeï¼Œå…¶ä»£ç æ˜¯åŸç”Ÿå†…ç½®åœ¨ Controller Manager ä¸­çš„ï¼› CSI - Container Storage Interfaceï¼Œåœ¨ Controller Mananger ä¸­æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Volume Pluginï¼Œç”±è¯¥ Plugin æ¥è°ƒç”¨æ³¨å†Œçš„ CSI Pluginï¼› FlexVolume - é€šè¿‡å¯æ‰§è¡Œæ–‡ä»¶å®ç°çš„åŠ¨æ€æ³¨å†Œæ’ä»¶ ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 åŸºç¡€æ¥å£ å…ˆäº†è§£ä¸‹æœ€åŸºæœ¬æ‰§è¡Œå„ä¸ªæ“ä½œçš„æ¥å£ï¼Œè¿™äº›æ¥å£éƒ½æ˜¯ç”¨äºç‰¹å®š Pod æ‰§è¡Œç‰¹å®šçš„ Volume æ“ä½œï¼ˆPod ä¸ Volume éƒ½æ˜¯ç¡®å®šçš„äº†ï¼‰ï¼Œç”± VolumePlugin çš„æ–¹æ³•å¾—åˆ°ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå„ä¸ªæ¥å£å¯¹åº”äº†åœ¨ æ¦‚è¿° æ‰€å¯¹åº”çš„æ­¥éª¤ã€‚ Mounter CanMount() - SetUp() è°ƒç”¨å‰æ£€æŸ¥æ‰€éœ€çš„ç»„ä»¶ï¼ˆä¾‹å¦‚æ’ä»¶ç¨‹åºï¼‰æ˜¯å¦å‡†å¤‡å¥½ SetUp() ä¸ SetUpAt() - ä¸º Pod å‡†å¤‡å¥½å¯¹åº”çš„ Volume ç›®å½• Unmounter TearDown() ä¸ TearDownAt() - ç§»é™¤ä¸º Pod å‡†å¤‡çš„ Volume ç›®å½• CustomBlockVolumeMapper SetUpDevice() - ä¸º Pod å‡†å¤‡å¥½ Device MapPodDevice() - å°† Device æ˜ å°„ç»™ Pod CustomBlockVolumeUnmapper TearDownDevice() - ç§»é™¤ä¸º Pod å‡†å¤‡å¥½çš„ Device UnmapPodDevice() - å–æ¶ˆ Device æ˜ å°„ Provisioner Provision() - åˆ›å»ºä¸€ä¸ª Volume Deleter Delete() - åˆ é™¤ä¸€ä¸ª Volume Attacher Attach() - Attach Volume åˆ° Node ä¸Š VolumesAreAttached() - è¿”å› Node ä¸Šçš„ attached Volume Detacher Detach() - Detach Volume DeviceMounter MountDevice() - å°† attached Volume æŒ‚è½½åˆ°ä¸€ä¸ªå…¨å±€ç›®å½• DeviceUnmounter UnmountDevice() - å–æ¶ˆ attached Volume çš„å…¨å±€ç›®å½•æŒ‚è½½ // Volume represents a directory used by pods or hosts on a node. All method // implementations of methods in the volume interface must be idempotent. type Volume interface { // GetPath è¿”å› volume éœ€è¦çš„æŒ‚è½½è·¯å¾„ GetPath() string // MetricsProvider æä¾›ç»Ÿè®¡æ¥å£ MetricsProvider } // BlockVolume interface provides methods to generate global map path // and pod device map path. type BlockVolume interface { // GetGlobalMapPath returns a global map path which contains // bind mount associated to a block device. // ex. plugins/kubernetes.io/{PluginName}/{DefaultKubeletVolumeDevicesDirName}/{volumePluginDependentPath}/{pod uuid} GetGlobalMapPath(spec *Spec) (string, error) // GetPodDeviceMapPath returns a pod device map path // and name of a symbolic link associated to a block device. // ex. pods/{podUid}/{DefaultKubeletVolumeDevicesDirName}/{escapeQualifiedPluginName}/, {volumeName} GetPodDeviceMapPath() (string, string) SupportsMetrics() bool MetricsProvider } // Mounter æ¥å£ä¸º Pod æä¾› Volume å¯¹åº”çš„ç›®å½• type Mounter interface { Volume // CanMount ä¼˜å…ˆäº Setup è°ƒç”¨ï¼Œç”¨äºæ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦åŒ…å«èƒ½å¤Ÿ Mount çš„ç»„ä»¶ CanMount() error // SetUp ä¸º Pod æä¾› Volume çš„ç›®å½•ï¼Œç›®å½•è·¯å¾„ç”±è‡ªå·±å†³å®š SetUp(mounterArgs MounterArgs) error // SetUpAt ä¸º Pod æä¾› Volume çš„ç›®å½•ï¼Œç›®å½•è·¯å¾„ç”± dir æŒ‡å®š SetUpAt(dir string, mounterArgs MounterArgs) error // GetAttributes è¿”å› Volume çš„å±æ€§ GetAttributes() Attributes } // Unmounter interface provides methods to cleanup/unmount the volumes. type Unmounter interface { Volume // TearDown å–æ¶ˆä¸º Pod æä¾›çš„ç›®å½• TearDown() error // TearDown å–æ¶ˆä¸º Pod æä¾›çš„æŒ‡å®šç›®å½• TearDownAt(dir string) error } // BlockVolumeMapper interface is a mapper interface for block volume. type BlockVolumeMapper interface { BlockVolume } // CustomBlockVolumeMapper interface provides custom methods to set up/map the volume. type CustomBlockVolumeMapper interface { BlockVolumeMapper // SetUpDevice å‡†å¤‡ä¸º Pod æä¾›çš„å—è®¾å¤‡ SetUpDevice() (stagingPath string, err error) // MapPodDevice maps the block device to a path and return the path. MapPodDevice() (publishPath string, err error) // GetStagingPath returns path that was used for staging the volume // it is mainly used by CSI plugins GetStagingPath() string } // BlockVolumeUnmapper interface is an unmapper interface for block volume. type BlockVolumeUnmapper interface { BlockVolume } // CustomBlockVolumeUnmapper interface provides custom methods to cleanup/unmap the volumes. type CustomBlockVolumeUnmapper interface { BlockVolumeUnmapper // TearDownDevice ç§»é™¤ä¸º Pod æä¾›çš„å—è®¾å¤‡ TearDownDevice(mapPath string, devicePath string) error // UnmapPodDevice removes traces of the MapPodDevice procedure. UnmapPodDevice() error } type Provisioner interface { // Provision åˆ›å»ºä¸€ä¸ª Volume Provision(selectedNode *v1.Node, allowedTopologies []v1.TopologySelectorTerm) (*v1.PersistentVolume, error) } type Deleter interface { Volume // Deleter ç§»é™¤ä¸€ä¸ª Volume Delete() error } type Attacher interface { DeviceMounter // Attach Volume åˆ°æŒ‡å®šçš„ Node ä¸Š Attach(spec *Spec, nodeName types.NodeName) (string, error) // VolumesAreAttached æŸ¥è¯¢ Node ä¸Šçš„ attached Volume VolumesAreAttached(specs []*Spec, nodeName types.NodeName) (map[*Spec]bool, error) // WaitForAttach ç­‰å¾… attach ç»“æŸ WaitForAttach(spec *Spec, devicePath string, pod *v1.Pod, timeout time.Duration) (string, error) } type Device","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 VolumePlugin æ¥å£ VolumePlugin æ˜¯ Volume Plugin çš„æœ€åŸºæœ¬çš„ interfaceã€‚ type Spec struct { Volume *v1.Volume PersistentVolume *v1.PersistentVolume ReadOnly bool InlineVolumeSpecForCSIMigration bool Migrated bool } // VolumePlugin is an interface to volume plugins that can be used on a // kubernetes node (e.g. by kubelet) to instantiate and manage volumes. type VolumePlugin interface { // Init åˆå§‹åŒ– plugin Init(host VolumeHost) error // Name è¿”å› plugin name // å‘½åæ–¹å¼ä¸º \"example.com/volume\"ï¼Œ\"kubernetes.io\" ç”± kubernete å†…ç½® Volume é¢„ç•™ä½¿ç”¨ GetPluginName() string // GetVolumeName åŸºäº spec è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ volume name æˆ–è€… id // å¯¹äº Attach ä¸ Detach æ“ä½œä¼šä¼ é€’è¯¥ name æ¥è®© plugin è¯†åˆ« volume GetVolumeName(spec *Spec) (string, error) // CanSupport è¿”å› plugin æ˜¯å¦æ”¯æŒè¯¥ spec CanSupport(spec *Spec) bool // RequiresRemount è¡¨æ˜ plugin æ˜¯å¦æ”¯æŒ volume çš„é‡æ–°æŒ‚è½½ RequiresRemount(spec *Spec) bool // NewMounter åˆ›å»ºä¸€ä¸ª Mounter NewMounter(spec *Spec, podRef *v1.Pod, opts VolumeOptions) (Mounter, error) // NewUnmounter åˆ›å»ºä¸€ä¸ª UnMounter NewUnmounter(name string, podUID types.UID) (Unmounter, error) // ConstructVolumeSpec ç”± volume name å¾—åˆ°ä¸€ä¸ª spec ConstructVolumeSpec(volumeName, volumePath string) (*Spec, error) // SupportsMountOption è¡¨æ˜æ˜¯å¦æ”¯æŒæŒ‚è½½é€‰é¡¹ SupportsMountOption() bool // SupportsBulkVolumeVerification checks if volume plugin type is capable // of enabling bulk polling of all nodes. This can speed up verification of // attached volumes by quite a bit, but underlying pluging must support it. SupportsBulkVolumeVerification() bool } Mounter çš„ä½œç”¨ Mounter å¹¶ä¸æ˜¯è¿›è¡Œå—è®¾å¤‡çš„æŒ‚è½½çš„ï¼ˆè¿™æ˜¯ DeviceMounter çš„å·¥ä½œï¼‰ï¼Œè€Œæ˜¯ä¸ºç‰¹å®šçš„ Pod.Volume å‡†å¤‡ä¸€ä¸ªç›®å½•ï¼Œè€Œè¯¥ç›®å½•åç»­ç”± kubelet æŒ‚è½½ç»™ Pod çš„å„ä¸ªå®¹å™¨ã€‚ VolumePlugin æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„ interfaceï¼Œåœ¨ VolumePlugin ä¹‹ä¸Šè¿˜æ ¹æ®åŠŸèƒ½æœ‰ç€å„æ ·çš„ Plugin interfaceã€‚ PersistentVolumePlugin - Volume æ”¯æŒä¿å­˜æŒä¹…æ•°æ® RecyclableVolumePlugin - æ”¯æŒ Recycle Volume DeletableVolumePlugin - æ”¯æŒ Delete Volume ProvisionableVolumePlugin - æ”¯æŒ Provision Volume DeviceMountableVolumePlugin - éœ€è¦å…ˆæŒ‚è½½ Deviceï¼Œæ‰å¯ä»¥å°† Volume æŒ‚è½½ç»™ Pod AttachableVolumePlugin - éœ€è¦å…ˆ Attach åˆ° Nodeï¼Œå†æŒ‚è½½ Deviceï¼Œæ‰å¯ä»¥å°† Volume æŒ‚è½½ç»™ Pod ExpandableVolumePlugin - Volume æ”¯æŒä»æ§åˆ¶é¢è§¦å‘ Expand NodeExpandableVolumePlugin - Volume æ”¯æŒ Node è§¦å‘ Expand VolumePluginWithAttachLimits - é™åˆ¶ Node èƒ½å¤Ÿ Attach Volume çš„æ•°é‡ BlockVolumePlugin - æ”¯æŒ Block Volume // PersistentVolumePlugin is an extended interface of VolumePlugin and is used // by volumes that want to provide long term persistence of data type PersistentVolumePlugin interface { VolumePlugin // GetAccessModes describes the ways a given volume can be accessed/mounted. GetAccessModes() []v1.PersistentVolumeAccessMode } // RecyclableVolumePlugin is an extended interface of VolumePlugin and is used // by persistent volumes that want to be recycled before being made available // again to new claims type RecyclableVolumePlugin interface { VolumePlugin // Recycle knows how to reclaim this // resource after the volume's release from a PersistentVolumeClaim. // Recycle will use the provided recorder to write any events that might be // interesting to user. It's expected that caller will pass these events to // the PV being recycled. Recycle(pvName string, spec *Spec, eventRecorder recyclerclient.RecycleEventRecorder) error } // DeletableVolumePlugin is an extended interface of VolumePlugin and is used // by persistent volumes that want to be deleted from the cluster after their // release from a PersistentVolumeClaim. type DeletableVolumePlugin interface { VolumePlugin // NewDeleter creates a new volume.Deleter which knows how to delete this // resource in accordance with the underlying storage provider after the // volume's release from a claim NewDeleter(spec *Spec) (Deleter, error) } // ProvisionableVolumePlugin is an extended interface of VolumePlugin and is // used to create volumes for the cluster. type ProvisionableVolumePlugin interface { VolumePlugin // NewProvisioner creates a new volume.Provisioner which knows how to // create PersistentVolumes in accordance with the plugin's underlying // storage provider NewProvisioner(options VolumeOptions) (Provisioner, error) } // AttachableVolumePlugi","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 DynamicPluginProber æ¥å£ å¤§éƒ¨åˆ†å†…ç½®çš„æ’ä»¶éƒ½ä»¥ä»£ç æ–¹å¼å®ç°äº† VolumePlugin æ¥å£ï¼Œä»¥é™æ€æ–¹å¼æ³¨å†Œã€‚è€Œ FlexVolume æ˜¯ç”± DynamicPluginProber æ¥å£è¿›è¡Œ Probe åï¼Œä»¥åŠ¨æ€æ–¹å¼æ³¨å†Œã€‚ type ProbeEvent struct { Plugin VolumePlugin // VolumePlugin that was added/updated/removed. if ProbeEvent.Op is 'ProbeRemove', Plugin should be nil PluginName string Op ProbeOperation // The operation to the plugin } type DynamicPluginProber interface { Init() error // If an error occurs, events are undefined. Probe() (events []ProbeEvent, err error) } è°ƒç”¨ Probe() æ¥å£ä¼šå»æ’ä»¶ç›®å½•æŸ¥æ‰¾æ’ä»¶çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶åˆ›å»º flexVolumePlugin ç±»ï¼ŒflexVolumePlugin å³å®ç°äº† VolumePlugin æ¥å£ï¼Œå¯ä»¥æ³¨å†Œåˆ° VolumePluginMgr ä¸­ã€‚ æ’ä»¶ç›®å½• Probe() æ¥å£æŸ¥æ‰¾çš„ç›®å½•æ ¼å¼ä¸º \u003cplugindir\u003e/\u003cvendor~driver\u003e/\u003cdriver\u003eï¼Œ\u003cplugindir\u003e åœ¨ Kubelet ç”±å‚æ•° --volume-plugin-dir æŒ‡å®šï¼Œåœ¨ Controller Manager ç”±å‚æ•° --flex-volume-plugin-dirã€‚ é»˜è®¤ä¸ºè·¯å¾„ /usr/libexec/kubernetes/kubelet-plugins/volume/execã€‚ DynamicPluginProber å‘¨æœŸæ€§è¿›è¡Œ Probe() æ“ä½œï¼Œæ³¨å†Œæ–°å‘ç°çš„ flexVolumePluginï¼Œç§»é™¤ä¸å­˜åœ¨çš„ flexVolumePluginã€‚ å½“è°ƒç”¨ flexVolumePlugin çš„æ“ä½œæ¥å£ï¼ˆNewMounterã€NewAttacher ç­‰ï¼‰ï¼Œä¼šè½¬å‘è°ƒç”¨å„ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å‘½ä»¤ã€‚ä¾‹å¦‚ï¼š $ ./uds Usage: flexvoldrv [command] Available Commands: help Help about any command init Flex volume init command. mount Flex volume unmount command. unmount Flex volume unmount command. version Print version ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 VolumePluginMgr ç±» æ‰€æœ‰çš„ VolumePlugin ä¼šæ³¨å†Œåˆ° VolumePluginMgr å¯¹è±¡ä¸­ç®¡ç†ã€‚ type VolumePluginMgr struct { mutex sync.RWMutex plugins map[string]VolumePlugin // é™æ€æ³¨å†Œçš„ VolumePlugin prober DynamicPluginProber probedPlugins map[string]VolumePlugin // probe æ¢æµ‹å‡ºçš„ VolumePlugin loggedDeprecationWarnings sets.String Host VolumeHost } è€Œå¤§å¤šæ•° Controller ä½¿ç”¨æ—¶ï¼Œå°±ä¼šå…ˆé€šè¿‡å„ä¸ª Find å‡½æ•°æ¥æŸ¥æ‰¾å¯ç”¨çš„ VolumePluginï¼Œç„¶åè°ƒç”¨ VolumePlugin çš„æ–¹æ³•è¿›è¡Œå®é™…çš„æ“ä½œã€‚ // FindPluginBySpec æŸ¥æ‰¾èƒ½å¤Ÿæ”¯æŒ spec çš„ VolumePlugin func (pm *VolumePluginMgr) FindPluginBySpec(spec *Spec) (VolumePlugin, error) { pm.mutex.RLock() defer pm.mutex.RUnlock() if spec == nil { return nil, fmt.Errorf(\"could not find plugin because volume spec is nil\") } // è°ƒç”¨é™æ€æ³¨å†Œçš„ VolumePlugin.CanSupport() å‡½æ•°ç­›é€‰ matches := []VolumePlugin{} for _, v := range pm.plugins { if v.CanSupport(spec) { matches = append(matches, v) } } // è¿›è¡Œä¸€æ¬¡ Probe Plugin pm.refreshProbedPlugins() // è°ƒç”¨åŠ¨æ€æ³¨å†Œçš„ VolumePlugin.CanSupport() å‡½æ•°ç­›é€‰ for _, plugin := range pm.probedPlugins { if plugin.CanSupport(spec) { matches = append(matches, plugin) } } // æ²¡æœ‰ä»»ä½• Volume Plugin èƒ½å¤Ÿå¤„ç† if len(matches) == 0 { return nil, fmt.Errorf(\"no volume plugin matched\") } // å¤šä¸ª Volume Plugin èƒ½å¤Ÿå¤„ç† if len(matches) \u003e 1 { matchedPluginNames := []string{} for _, plugin := range matches { matchedPluginNames = append(matchedPluginNames, plugin.GetPluginName()) } return nil, fmt.Errorf(\"multiple volume plugins matched: %s\", strings.Join(matchedPluginNames, \",\")) } // è¿”å›å”¯ä¸€çš„ Volume Plugin // Issue warning if the matched provider is deprecated pm.logDeprecation(matches[0].GetPluginName()) return matches[0], nil } // FindPluginByName é€šè¿‡ plugin name æŸ¥æ‰¾ Volume Plugin func (pm *VolumePluginMgr) FindPluginByName(name string) (VolumePlugin, error) { pm.mutex.RLock() defer pm.mutex.RUnlock() // æŸ¥æ‰¾é™æ€æ³¨å†Œçš„ VolumePlugin // Once we can get rid of legacy names we can reduce this to a map lookup. matches := []VolumePlugin{} if v, found := pm.plugins[name]; found { matches = append(matches, v) } // è¿›è¡Œä¸€æ¬¡ Probe Plugin pm.refreshProbedPlugins() // æŸ¥æ‰¾åŠ¨æ€æ³¨å†Œçš„ VolumePlugin if plugin, found := pm.probedPlugins[name]; found { matches = append(matches, plugin) } // æ²¡æœ‰ä»»ä½• VolumePlugin æˆ–è€…å¤šä¸ª VolumePlugin è§†ä¸ºé”™è¯¯ if len(matches) == 0 { return nil, fmt.Errorf(\"no volume plugin matched name: %s\", name) } if len(matches) \u003e 1 { matchedPluginNames := []string{} for _, plugin := range matches { matchedPluginNames = append(matchedPluginNames, plugin.GetPluginName()) } return nil, fmt.Errorf(\"multiple volume plugins matched: %s\", strings.Join(matchedPluginNames, \",\")) } // è¿”å›å”¯ä¸€çš„ VolumePlugin // Issue warning if the matched provider is deprecated pm.logDeprecation(matches[0].GetPluginName()) return matches[0], nil } func (pm *VolumePluginMgr) FindPersistentPluginBySpec(spec *Spec) (PersistentVolumePlugin, error) { // ... } // å…¶ä»–å„ä¸ªç±»å‹çš„ VolumePlugin ... ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 PV Controller PV Controller ä¸»è¦è´Ÿè´£ PV ä¸ PVC çš„ç»‘å®šï¼Œå¹¶è´Ÿè´£äº† PV çš„åˆ›å»ºä¸é”€æ¯ã€‚ PV Controller å°±æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œç›‘å¬ç€ PV ä¸ PVC çš„äº‹ä»¶ï¼Œå¹¶å¯¹åº”è¿›è¡Œ PV ä¸ PVC çš„åè°ƒå¤„ç†ã€‚ ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 è§¦å‘é€»è¾‘ Controller åŸºæœ¬éƒ½æ˜¯é€šè¿‡ Informer å®ç°ï¼Œå‘¨æœŸæ€§ä¸äº‹ä»¶è§¦å‘ã€‚ // NewController åˆ›å»ºä¸€ä¸ª PV Controller å¯¹è±¡ func NewController(p ControllerParameters) (*PersistentVolumeController, error) { // æ„å»º Controller å¯¹è±¡ï¼ŒåŸºæœ¬çš„å‚æ•°éƒ½æ¥è‡ªäº ControllerParameters controller := \u0026PersistentVolumeController{ volumes: newPersistentVolumeOrderedIndex(), claims: cache.NewStore(cache.DeletionHandlingMetaNamespaceKeyFunc), kubeClient: p.KubeClient, eventRecorder: eventRecorder, runningOperations: goroutinemap.NewGoRoutineMap(true /* exponentialBackOffOnError */), cloud: p.Cloud, enableDynamicProvisioning: p.EnableDynamicProvisioning, clusterName: p.ClusterName, createProvisionedPVRetryCount: createProvisionedPVRetryCount, createProvisionedPVInterval: createProvisionedPVInterval, claimQueue: workqueue.NewNamed(\"claims\"), volumeQueue: workqueue.NewNamed(\"volumes\"), resyncPeriod: p.SyncPeriod, operationTimestamps: metrics.NewOperationStartTimeCache(), } // åˆå§‹åŒ–æ‰€æœ‰çš„ Volume Plugin if err := controller.volumePluginMgr.InitPlugins(p.VolumePlugins, nil /* prober */, controller); err != nil { return nil, fmt.Errorf(\"could not initialize volume plugins for PersistentVolume Controller: %w\", err) } // ç›‘å¬ PV äº‹ä»¶ï¼Œæ³¨å†Œå›è°ƒ p.VolumeInformer.Informer().AddEventHandler( cache.ResourceEventHandlerFuncs{ AddFunc: func(obj interface{}) { controller.enqueueWork(controller.volumeQueue, obj) }, UpdateFunc: func(oldObj, newObj interface{}) { controller.enqueueWork(controller.volumeQueue, newObj) }, DeleteFunc: func(obj interface{}) { controller.enqueueWork(controller.volumeQueue, obj) }, }, ) controller.volumeLister = p.VolumeInformer.Lister() controller.volumeListerSynced = p.VolumeInformer.Informer().HasSynced // ç›‘å¬ PVC äº‹ä»¶ï¼Œæ³¨å†Œå›è°ƒ p.ClaimInformer.Informer().AddEventHandler( cache.ResourceEventHandlerFuncs{ AddFunc: func(obj interface{}) { controller.enqueueWork(controller.claimQueue, obj) }, UpdateFunc: func(oldObj, newObj interface{}) { controller.enqueueWork(controller.claimQueue, newObj) }, DeleteFunc: func(obj interface{}) { controller.enqueueWork(controller.claimQueue, obj) }, }, ) controller.claimLister = p.ClaimInformer.Lister() controller.claimListerSynced = p.ClaimInformer.Informer().HasSynced // æ„å»ºå¯¹è±¡å…¶ä»–å±æ€§ // ... return controller, nil } // enqueueWork enqueueWork å°†å¯¹è±¡çš„ key æ”¾å…¥é˜Ÿåˆ— func (ctrl *PersistentVolumeController) enqueueWork(queue workqueue.Interface, obj interface{}) { // Beware of \"xxx deleted\" events if unknown, ok := obj.(cache.DeletedFinalStateUnknown); ok \u0026\u0026 unknown.Obj != nil { obj = unknown.Obj } objName, err := controller.KeyFunc(obj) if err != nil { return } queue.Add(objName) } å¯ä»¥çœ‹åˆ°ï¼ŒPV/PVC çš„äº‹ä»¶å›è°ƒéƒ½æ”¾å…¥äº†å¯¹åº”çš„ controller.volumeQueue/controller.claimQueue é˜Ÿåˆ—ã€‚ åœ¨ PV Controller çš„ Run å‡½æ•°æ—¶ï¼Œå¯åŠ¨äº†ä¸‰ä¸ªåç¨‹è¿›è¡Œå¤„ç†ï¼Œåˆ†åˆ«è¿›è¡Œï¼š resync å¤„ç† volumeQueue å¤„ç† claimQueueã€‚ // Run å¯åŠ¨ Controller çš„æ§åˆ¶å¾ªç¯ func (ctrl *PersistentVolumeController) Run(stopCh \u003c-chan struct{}) { defer utilruntime.HandleCrash() defer ctrl.claimQueue.ShutDown() defer ctrl.volumeQueue.ShutDown() // ç­‰å¾… cache å¡«å…… if !cache.WaitForNamedCacheSync(\"persistent volume\", stopCh, ctrl.volumeListerSynced, ctrl.claimListerSynced, ctrl.classListerSynced, ctrl.podListerSynced, ctrl.NodeListerSynced) { return } // åˆå§‹åŒ– ctrl.Store ctrl.initializeCaches(ctrl.volumeLister, ctrl.claimLister) // æ‰§è¡Œå„ä¸ªå·¥ä½œå‡½æ•° go wait.Until(ctrl.resync, ctrl.resyncPeriod, stopCh) go wait.Until(ctrl.volumeWorker, time.Second, stopCh) go wait.Until(ctrl.claimWorker, time.Second, stopCh) \u003c-stopCh } å…ˆçœ‹ä¸‹ resyncï¼Œå…¶ä½œç”¨å°±æ˜¯ä¸ºäº†æ¯” Informer æ›´çŸ­å‘¨æœŸçš„è¿›è¡Œå‘¨æœŸæ€§çš„æ§åˆ¶å¾ªç¯ã€‚å› ä¸º Shared Informer çš„è§¦å‘å‘¨æœŸæ˜¯æ‰€æœ‰ä½¿ç”¨è€…ç›¸åŒçš„ï¼Œæ‰€ä»¥è‡ªå·±å®ç°äº†ä¸€ä¸ª resync å‡½æ•°ã€‚ // resync supplements short resync period of shared informers - we don't want // all consumers of PV/PVC shared informer to have a short resync period, // therefore we do our own. func (ctrl *PersistentVolumeController) resync() { // List æ‰€æœ‰ PVCï¼Œæ”¾å…¥é˜Ÿåˆ— pvcs, err := ctrl.claimLister.List(labels.NewSelector()) if err != nil { return } for _, pvc := range pvcs { ctrl.enqueueWork(ctrl.claimQueue, pvc) } // List æ‰€æœ‰ PVï¼Œæ”¾å…¥é˜Ÿåˆ— pvs, err := ctrl.volumeLister.List(labels.NewSelector()) if err != nil { return } for _, pv := rang","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 PV çš„æ§åˆ¶å¾ªç¯ PV çš„æ§åˆ¶å¾ªç¯ä¸»è¦è´Ÿè´£äº† PV çš„çŠ¶æ€æ›´æ–°ï¼Œä»¥åŠ PV çš„å›æ”¶ã€‚è€Œ PV åˆ›å»ºä¸ç»‘å®šç›¸å…³éƒ½æ˜¯ç”±åç»­çš„ PVC çš„æ§åˆ¶å¾ªç¯å¤„ç†ã€‚ PV æ§åˆ¶å¾ªç¯å¤§æ¦‚å¯ä»¥åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š æ£€æŸ¥ PV çš„ç»‘å®šæƒ…å†µï¼š PV è¿˜æœªç»‘å®š PVC (PV spec.claimRef == nil)ï¼Œæ›´æ–° PV status.phase ä¸º â€œAvailableâ€ã€‚ PV ç»‘å®šäº† PVC (PV spec.claimRef == nil)ï¼š ç»‘å®šçš„ PVC è¿˜æœªåˆ›å»º (PV spec.claimRef.UID == â€œ\")ï¼Œæ›´æ–° PV status.phase ä¸º â€œAvailableâ€ï¼Œåç»­ä¸æ‰§è¡Œã€‚ ç»‘å®šçš„ PV åˆ›å»ºè¿‡äº† (PV spec.claimRef.UID != â€œ\")ï¼Œæ£€æŸ¥å®é™…çš„ PV æ˜¯å¦å­˜åœ¨ã€‚ ä¼šæŸ¥è¯¢ä¸‰ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæŸ¥è¯¢æˆåŠŸå³è¡¨æ˜å­˜åœ¨ Controller è‡ªå·±ç»´æŠ¤çš„ Store Informer.Cache APiServer å¦‚æœ PV å·²ç»ç»‘å®šäº† PVCï¼Œä½†æ˜¯ PVC ä¸å­˜åœ¨ï¼Œè¯´æ˜ PVC å·²ç»è¢«åˆ é™¤äº† æ›´æ–° PV status.phase ä¸º â€œReleasedâ€ã€‚ æ ¹æ® PV spec.persistentVolumeReclaimPolicyï¼Œæ‰§è¡Œå¯¹ PV çš„æ“ä½œï¼š â€œRetainâ€ - ä¸æ‰§è¡Œä»»ä½•æ“ä½œ â€œRecycleâ€ - è°ƒç”¨ CSI æ’ä»¶å›æ”¶ Volumeï¼Œè§£é™¤ PV ä¸ PVC çš„ç»‘å®š â€œDeleteâ€ - è°ƒç”¨ CSI æ’ä»¶åˆ é™¤ Volumeï¼Œå¹¶åˆ é™¤ PV å¯¹è±¡ å¦‚æœ PV å·²ç»ç»‘å®šäº† PVCï¼Œä½†æ˜¯ PVC è¿˜æœªç»‘å®š PV æ£€æŸ¥ PVC ä¸ PV çš„ VolumeMode æ˜¯å¦åŒ¹é… è§¦å‘ä¸€æ¬¡ syncClaim å¦‚æœ PV ä¸ PVC ç›¸äº’ç»‘å®šï¼Œé‚£ä¹ˆæ›´æ–° PV status.phase ä¸º â€œBoundâ€ã€‚ å¦‚æœ PV ä¸ PVC ç»‘å®šä¸å¯¹ç§°ï¼Œé‚£ä¹ˆè§£é™¤ç»‘å®šï¼Œå…è®¸çš„æƒ…å†µä¸‹è¿˜ä¼šåˆ é™¤ PVã€‚ func (ctrl *PersistentVolumeController) syncVolume(volume *v1.PersistentVolume) error { // .. if volume.Spec.ClaimRef == nil { // PV Spec æ²¡æœ‰æŒ‡å®šç»‘å®š PVCï¼Œé‚£ä¹ˆæ›´æ–° Volume Phase ä¸º \"Available\" if _, err := ctrl.updateVolumePhase(volume, v1.VolumeAvailable, \"\"); err != nil { return err } return nil } else /* pv.Spec.ClaimRef != nil */ { // PV Spec æŒ‡å®šäº†ç»‘å®šäº† PVC // ç»‘å®šçš„ PVC è¿˜æœªå­˜åœ¨ï¼ˆæ²¡æœ‰ UIDï¼‰ï¼Œè¡¨æ˜ç»™ PV æ˜¯é¢„ç•™çš„ï¼Œæ›´æ–° Volume Phase ä¸º \"Available\" if volume.Spec.ClaimRef.UID == \"\" { if _, err := ctrl.updateVolumePhase(volume, v1.VolumeAvailable, \"\"); err != nil { // Nothing was saved; we will fall back into the same // condition in the next call to this method return err } return nil } // åˆ°è¿™é‡Œï¼Œè¯´æ˜ç»‘å®šçš„ PVC å·²ç»å­˜åœ¨ // Get the PVC by _name_ var claim *v1.PersistentVolumeClaim claimName := claimrefToClaimKey(volume.Spec.ClaimRef) // æŸ¥è¯¢ PVC æ˜¯å¦è¿˜å­˜åœ¨ obj, found, err := ctrl.claims.GetByKey(claimName) if err != nil { return err } if !found { // å¦‚æœ PVC åœ¨è‡ªå·±çš„ store ä¸å­˜åœ¨ï¼Œè¿›è¡Œ double check // If the PV was created by an external PV provisioner or // bound by external PV binder (e.g. kube-scheduler), it's // possible under heavy load that the corresponding PVC is not synced to // controller local cache yet. So we need to double-check PVC in // 1) informer cache // 2) apiserver if not found in informer cache // to make sure we will not reclaim a PV wrongly. // Note that only non-released and non-failed volumes will be // updated to Released state when PVC does not exist. if volume.Status.Phase != v1.VolumeReleased \u0026\u0026 volume.Status.Phase != v1.VolumeFailed { obj, err = ctrl.claimLister.PersistentVolumeClaims(volume.Spec.ClaimRef.Namespace).Get(volume.Spec.ClaimRef.Name) if err != nil \u0026\u0026 !apierrors.IsNotFound(err) { return err } found = !apierrors.IsNotFound(err) if !found { obj, err = ctrl.kubeClient.CoreV1().PersistentVolumeClaims(volume.Spec.ClaimRef.Namespace).Get(context.TODO(), volume.Spec.ClaimRef.Name, metav1.GetOptions{}) if err != nil \u0026\u0026 !apierrors.IsNotFound(err) { return err } found = !apierrors.IsNotFound(err) } } } if !found { klog.V(4).Infof(\"synchronizing PersistentVolume[%s]: claim %s not found\", volume.Name, claimrefToClaimKey(volume.Spec.ClaimRef)) // Fall through with claim = nil } else { var ok bool claim, ok = obj.(*v1.PersistentVolumeClaim) if !ok { return fmt.Errorf(\"cannot convert object from volume cache to volume %q!?: %#v\", claim.Spec.VolumeName, obj) } klog.V(4).Infof(\"synchronizing PersistentVolume[%s]: claim %s found: %s\", volume.Name, claimrefToClaimKey(volume.Spec.ClaimRef), getClaimStatusForLogging(claim)) } if claim != nil \u0026\u0026 claim.UID != volume.Spec.ClaimRef.UID { claim = nil } if claim == nil { // å¦‚æœæœ€ç»ˆæ£€æŸ¥çš„è¯¥ PVC è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆ PVC å·²ç»è¢«åˆ é™¤äº† // æ›´æ–° Volume Phase ä¸º \"Released\" if volume.Status.Phase != v1.VolumeReleased \u0026\u0026 volume.Status.Phase != v1.VolumeFailed { if volume, err = ctrl.updateVolumePhase(volume, v1.VolumeReleased, \"\"); err != nil { // Nothing was saved; we will fall back into the same condition // in the next call to this method return err } } // æ ¹æ® ReclaimPolicy å†³å®šæ˜¯å¦é”€æ¯ PV if err = ctrl.reclaimVolume(volume); err != nil { return err } // å¦‚æœ ReclaimPolicy ä¸ºä¿ç•™ï¼Œåç»­æ“ä½œä¸æ‰§è¡Œ if volume.Spec.PersistentVolumeReclaimPolicy == v1.PersistentVolumeReclaimRetain { ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.3 PVC çš„æ§åˆ¶å¾ªç¯ PVC çš„æ§åˆ¶å¾ªç¯è´Ÿè´£ PVC ä¸ PV çš„ç»‘å®šï¼Œå¦‚æœ PVC æŒ‡å®š StorageClass è¿˜å¯èƒ½åˆ›å»ºä¸€ä¸ª PVã€‚ PVC æ§åˆ¶å¾ªç¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š PVC å·²ç»ç”± Controller ç»‘å®šäº† PVï¼ˆåˆ¤æ–­ PVC annotation â€œpv.kubernetes.io/bind-completedâ€ï¼‰ï¼Œæ‰§è¡Œ syncBoundClaim() æ–¹æ³•ã€‚ PVC è¿˜æœªç”± Controller ç»‘å®šäº† PVï¼ˆåˆ¤æ–­ PVC annotation â€œpv.kubernetes.io/bind-completedâ€ï¼‰ï¼Œæ‰§è¡Œ syncUnboundClaim() æ–¹æ³•ã€‚ å…ˆçœ‹ç®€å•çš„ syncBoundClaim() é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯æ£€æŸ¥ PV ä¸ PVC çš„ç»‘å®šå…³ç³»æ˜¯å¦æ­£å¸¸ã€‚ PVC spec.volumeName == â€œ\"ï¼Œè¯´æ˜ç»‘å®šå…³ç³»ä¸¢å¤±äº†ï¼Œæ›´æ–° PVC status.phase ä¸º â€œLostâ€ã€‚ æŸ¥è¯¢å¯¹åº”ç»‘å®šçš„ PVï¼Œå¦‚æœ PV ä¸å­˜åœ¨ï¼Œè¯´æ˜ PV ä¸¢å¤±ï¼Œæ›´æ–° PVC status.phase ä¸º â€œLostâ€ã€‚ å¯¹åº”çš„ PV å­˜åœ¨ï¼Œä½†æ˜¯ PV æœªç»‘å®šè¯¥ PVCï¼ˆPV spec.claimRef == nilï¼‰ï¼Œé‚£ä¹ˆæ‰§è¡Œç»‘å®šæ“ä½œã€‚ å¯¹åº”çš„ PV å­˜åœ¨ï¼Œä½†æ˜¯ PV ç»‘å®šçš„ä¸æ˜¯è¯¥ PVCï¼Œè¯´æ˜ç»‘å®šå…³ç³»ä¸¢å¤±äº†ï¼Œæ›´æ–° PVC status.phase ä¸º â€œLostâ€ã€‚ func (ctrl *PersistentVolumeController) syncBoundClaim(claim *v1.PersistentVolumeClaim) error { // Annotation è¡¨æ˜ PVC å·²ç»ç»‘å®šäº† PVï¼Œä½†æ˜¯ PVC Spec.VolumeName ä¸ºç©ºï¼Œè¯´æ˜ PV ä¸¢å¤±äº†ï¼Œæ›´æ–° Phase ä¸º \"Lost\" if claim.Spec.VolumeName == \"\" { if _, err := ctrl.updateClaimStatusWithEvent(claim, v1.ClaimLost, nil, v1.EventTypeWarning, \"ClaimLost\", \"Bound claim has lost reference to PersistentVolume. Data on the volume is lost!\"); err != nil { return err } return nil } // æŸ¥è¯¢ PVC ç»‘å®šçš„ PV obj, found, err := ctrl.volumes.store.GetByKey(claim.Spec.VolumeName) if err != nil { return err } if !found { // å¯¹åº”çš„ PV ä¸å­˜åœ¨ï¼Œè¡¨æ˜ PV ä¸¢å¤±äº†ï¼Œæ›´æ–° Phase ä¸º \"Lost\" if _, err = ctrl.updateClaimStatusWithEvent(claim, v1.ClaimLost, nil, v1.EventTypeWarning, \"ClaimLost\", \"Bound claim has lost its PersistentVolume. Data on the volume is lost!\"); err != nil { return err } return nil } else { volume, ok := obj.(*v1.PersistentVolume) if !ok { return fmt.Errorf(\"cannot convert object from volume cache to volume %q!?: %#v\", claim.Spec.VolumeName, obj) } if volume.Spec.ClaimRef == nil { // å¯¹åº” PV è¿˜æœªç»‘å®šï¼Œé‚£ä¹ˆå°†å¯¹åº” PV ç»‘å®šåˆ°è‡ªèº« PVC if err = ctrl.bind(volume, claim); err != nil { return err } return nil } else if volume.Spec.ClaimRef.UID == claim.UID { // PV ä¸ PVC éƒ½ç›¸äº’ç»‘å®šäº†ï¼Œè¿˜æ˜¯è°ƒç”¨ä¸€ä¸ª bind // NOTE: syncPV can handle this so it can be left out. // NOTE: bind() call here will do nothing in most cases as // everything should be already set. if err = ctrl.bind(volume, claim); err != nil { return err } return nil } else { // å¯¹åº”çš„ PV ç»‘å®šçš„ä¸æ˜¯è¯¥ PVCï¼Œæ›´æ–° Phase ä¸º \"Lost\" if _, err = ctrl.updateClaimStatusWithEvent(claim, v1.ClaimLost, nil, v1.EventTypeWarning, \"ClaimMisbound\", \"Two claims are bound to the same volume, this one is bound incorrectly\"); err != nil { return err } return nil } } } syncUnboundClaim() ä¸»è¦è´Ÿè´£ PV ä¸ PVC çš„ç»‘å®šå…³ç³»ï¼Œå¦‚æœæœªç»‘å®šä¼šæŸ¥æ‰¾åˆé€‚çš„ PVã€‚ PV spec.volumeName == â€œ\"ï¼Œå°è¯•ç»‘å®šä¸€ä¸ªåˆé€‚çš„ PV æ— æ³•æŸ¥æ‰¾åˆ°åˆé€‚çš„ PV å¦‚æœ PVC æŒ‡å®šäº† StorageClassï¼Œé‚£ä¹ˆå°è¯•åˆ›å»ºä¸€ä¸ª PVã€‚ å…¶ä»–æƒ…å†µï¼ŒPVC status.phase ä¸º â€œPendingâ€ã€‚ æ‰¾åˆ°äº†åˆé€‚çš„ PVï¼Œæ‰§è¡Œç»‘å®šæ“ä½œ PV spec.volumeName != â€œ\"ï¼Œè¯´æ˜æ˜¯ç”¨æˆ·éƒ¨ç½²æ—¶æŒ‡å®šäº† PVï¼Œé‚£ä¹ˆæ‰§è¡Œç»‘å®šæ“ä½œã€‚ func (ctrl *PersistentVolumeController) syncUnboundClaim(claim *v1.PersistentVolumeClaim) error { if claim.Spec.VolumeName == \"\" { // ç¡®å®æœªç»‘å®š PV // ç¡®è®¤ BindingMode æ˜¯å¦ä¸º \"WaitForFirstConsumer\" delayBinding, err := pvutil.IsDelayBindingMode(claim, ctrl.classLister) if err != nil { return err } // æŸ¥æ‰¾åˆé€‚çš„ PV volume, err := ctrl.volumes.findBestMatchForClaim(claim, delayBinding) if err != nil { return fmt.Errorf(\"error finding PV for claim %q: %w\", claimToClaimKey(claim), err) } if volume == nil { // æ²¡æ‰¾åˆ°åˆé€‚çš„ PV switch { case delayBinding \u0026\u0026 !pvutil.IsDelayBindingProvisioning(claim): // å»¶è¿Ÿç»‘å®šï¼Œå¹¶ä¸”è¿˜æœªè°ƒåº¦åˆ° Nodeï¼ˆé€šè¿‡ PVC annotation \"volume.kubernetes.io/selected-node\" åˆ¤æ–­ï¼‰ if err = ctrl.emitEventForUnboundDelayBindingClaim(claim); err != nil { return err } case storagehelpers.GetPersistentVolumeClaimClass(claim) != \"\": // PVC æŒ‡å®šäº† StorageClassï¼Œé‚£ä¹ˆå°è¯•åˆ›å»ºä¸€ä¸ª PV if err = ctrl.provisionClaim(claim); err != nil { return err } return nil default: ctrl.eventRecorder.Event(claim, v1.EventTypeNormal, events.FailedBinding, \"no persistent volumes available for this claim and no storage class is set\") } // æ›´æ–° PVC çŠ¶æ€ä¸º Pending if _, err = ctrl.updateClaimStatus(claim, v1.ClaimPending, nil); err != nil { return err } return nil } else /* pv != nil */ { // æ‰¾äº†ä¸€ä¸ªåˆé€‚çš„ PVï¼Œæ‰§è¡Œç»‘å®šæ“ä½œ claimKey := claimToClaimKey(claim) if err = ctrl.bind(volume, claim); err != nil { return err } return nil } } else /* pvc.Spec.VolumeName != nil */ { // PVC å·²ç»æŒ‡å®šç»‘å®šçš„ PVï¼Œè¯´æ˜æ˜¯ç”¨æˆ·æŒ‡å®šçš„ // æŸ¥æ‰¾å¯¹åº” PV","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 AttachDetach Controller å‰é¢ PV Controller è´Ÿè´£äº† PV çš„åˆ›å»ºä¸é”€æ¯ï¼Œä»¥åŠ PV ä¸ PVC çš„ç»‘å®šä¸è§£ç»‘ã€‚å½“ PVC ç»‘å®šåï¼Œå¹¶è¢« Pod ä½¿ç”¨åï¼Œç”± AttachDetach Controller è´Ÿè´£å°†å…¶ Attach åˆ° Node ä¸Šï¼Œä»¥åŠè´Ÿè´£ä» Node ä¸Š Detachã€‚ Note Attach è¡¨ç¤ºå°† Volume æä¾›åˆ° Node ä¸Šï¼Œä»¥ä¾¿åç»­ Node ä¸Šçš„ kubelet è¿›è¡Œå¤„ç†ã€‚ æ•´ä½“ AttachDetach Controller è¿˜æ˜¯åŸºäº Controller æ¨¡å¼ï¼Œä½†æ˜¯å…¶æ ¸å¿ƒæ˜¯ä¾èµ–äºä¸¤ä¸ª map çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼šactualStateOfWorld ä¸ desiredStateOfWorldã€‚å¤„ç†æµç¨‹å°±æ˜¯ï¼Œæ ¹æ®å½“å‰çŠ¶æ€ï¼Œæ‰§è¡Œæ“ä½œï¼Œå‘æœŸæœ›çŠ¶æ€é æ‹¢ã€‚ å› æ­¤ï¼ŒAttachDetach Controller çš„æ ¸å¿ƒé€»è¾‘å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š æ›´æ–° desiredStateOfWorld æ›´æ–° actualStateOfWorld Reconcile ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 æ›´æ–° desiredStateOfWorld desiredStateOfWorld è®°å½• Volume çš„æœŸæœ›çŠ¶æ€ï¼Œå³å“ªäº› Volume éœ€è¦ Attach åˆ°å“ªäº› Nodeã€‚ æ‰€æœ‰çš„æœŸæœ›çŠ¶æ€æ¥è‡ªäº Pod çš„ Spec å®šä¹‰ï¼ŒçŠ¶æ€æ›´æ–°æ¥è‡ªäºï¼š ç›‘å¬ Pod/PVC çš„äº‹ä»¶ï¼Œ å‘¨æœŸæ€§éå†æ‰€æœ‰çš„ Pod æ€»ä¹‹æœ€ç»ˆéƒ½ä¼šæ”¶æ•›åˆ°åŒä¸€ä¸ªå‡½æ•° ProcessPodVolumes() è¿›è¡Œå¤„ç†ã€‚ func ProcessPodVolumes(pod *v1.Pod, addVolumes bool, desiredStateOfWorld cache.DesiredStateOfWorld, volumePluginMgr *volume.VolumePluginMgr, pvcLister corelisters.PersistentVolumeClaimLister, pvLister corelisters.PersistentVolumeLister, csiMigratedPluginManager csimigration.PluginManager, csiTranslator csimigration.InTreeToCSITranslator) { if pod == nil { return } // å¦‚æœ Pod æ²¡æœ‰ä½¿ç”¨ Volumeï¼Œå•¥ä¹Ÿä¸å¹² if len(pod.Spec.Volumes) \u003c= 0 { klog.V(10).Infof(\"Skipping processing of pod %q/%q: it has no volumes.\", pod.Namespace, pod.Name) return } // æŸ¥è¯¢æ˜¯å¦è°ƒåº¦åˆ°äº†ä¸€ä¸ªå­˜åœ¨çš„ Node nodeName := types.NodeName(pod.Spec.NodeName) if nodeName == \"\" { return } else if !desiredStateOfWorld.NodeExists(nodeName) { // If the node the pod is scheduled to does not exist in the desired // state of the world data structure, that indicates the node is not // yet managed by the controller. Therefore, ignore the pod. return } // å¤„ç† Pod Spec ä¸­çš„ Volume for _, podVolume := range pod.Spec.Volumes { // åˆ›å»º Volume å¯¹è±¡ volumeSpec, err := CreateVolumeSpec(podVolume, pod, nodeName, volumePluginMgr, pvcLister, pvLister, csiMigratedPluginManager, csiTranslator) if err != nil { klog.V(10).Infof( \"Error processing volume %q for pod %q/%q: %v\", podVolume.Name, pod.Namespace, pod.Name, err) continue } // æ‰¾åˆ°å¯¹åº”çš„ CSI Plugin attachableVolumePlugin, err := volumePluginMgr.FindAttachablePluginBySpec(volumeSpec) if err != nil || attachableVolumePlugin == nil { klog.V(10).Infof( \"Skipping volume %q for pod %q/%q: it does not implement attacher interface. err=%v\", podVolume.Name, pod.Namespace, pod.Name, err) continue } uniquePodName := util.GetUniquePodName(pod) if addVolumes { // æ·»åŠ  Volume åˆ° desiredStateOfWorld _, err := desiredStateOfWorld.AddPod( uniquePodName, pod, volumeSpec, nodeName) } else { // ç§»é™¤ Volume ä» desiredStateOfWorld // Remove volume from desired state of world uniqueVolumeName, err := util.GetUniqueVolumeNameFromSpec( attachableVolumePlugin, volumeSpec) if err != nil { continue } desiredStateOfWorld.DeletePod( uniquePodName, uniqueVolumeName, nodeName) } } return } ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 æ›´æ–° actualStateOfWorld actualStateOfWorld è®°å½• Volume çš„å½“å‰çŠ¶æ€ï¼Œå³ Node ä¸Šçš„ Attached Volumeã€‚ å…¶çŠ¶æ€æ›´æ–°æœ¬è´¨æ¥è‡ªäºï¼š æ‰§è¡Œ Volume æ“ä½œåï¼Œæ›´æ–° actualStateOfWorldï¼› å¯åŠ¨æ—¶ä¸åç»­å‘¨æœŸæ€§æ‰§è¡Œ syncï¼Œæ›´æ–° actualStateOfWorldï¼› ç›‘å¬ Node çš„ Add/Update/Delete äº‹ä»¶ï¼Œæ›´æ–° actualStateOfWorldï¼› æœ€ç»ˆæ“ä½œä¼šæ”¶æ•›åˆ°å‡½æ•° processVolumesInUse()ã€‚ // nodeAdd å¤„ç† Node æ·»åŠ äº‹ä»¶ func (adc *attachDetachController) nodeAdd(obj interface{}) { node, ok := obj.(*v1.Node) // è½¬ä¸º Node çš„æ›´æ–°å¤„ç† nodeName := types.NodeName(node.Name) adc.nodeUpdate(nil, obj) // æ›´æ–° actualStateOfWorld çš„ Node adc.actualStateOfWorld.SetNodeStatusUpdateNeeded(nodeName) } // nodeUpdate å¤„ç† Node æ›´æ–°äº‹ä»¶ func (adc *attachDetachController) nodeUpdate(oldObj, newObj interface{}) { node, ok := newObj.(*v1.Node) // Node æ·»åŠ åˆ° desiredStateOfWorld nodeName := types.NodeName(node.Name) adc.addNodeToDswp(node, nodeName) adc.processVolumesInUse(nodeName, node.Status.VolumesInUse) } // nodeDelete å¤„ç† Node Delete äº‹ä»¶ func (adc *attachDetachController) nodeDelete(obj interface{}) { node, ok := obj.(*v1.Node) // ä» desiredStateOfWorld åˆ é™¤ Node nodeName := types.NodeName(node.Name) err := adc.desiredStateOfWorld.DeleteNode(nodeName) adc.processVolumesInUse(nodeName, node.Status.VolumesInUse) } func (adc *attachDetachController) processVolumesInUse( nodeName types.NodeName, volumesInUse []v1.UniqueVolumeName) { klog.V(4).Infof(\"processVolumesInUse for node %q\", nodeName) // è·å– Node ä¸Šå·²ç» Attached Volume for _, attachedVolume := range adc.actualStateOfWorld.GetAttachedVolumesForNode(nodeName) { mounted := false // æ£€æŸ¥ Volume æ˜¯å¦æ˜¯ Attached for _, volumeInUse := range volumesInUse { if attachedVolume.VolumeName == volumeInUse { mounted = true break } } // è®°å½•åˆ° actualStateOfWorld err := adc.actualStateOfWorld.SetVolumeMountedByNode(attachedVolume.VolumeName, nodeName, mounted) if err != nil { klog.Warningf( \"SetVolumeMountedByNode(%q, %q, %v) returned an error: %v\", attachedVolume.VolumeName, nodeName, mounted, err) } } } å¯åŠ¨æ—¶ä¸å‘¨æœŸè°ƒç”¨ Reconcile æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€éƒ¨åˆ† sync é€»è¾‘ï¼Œå…¶ä¸­ä¼šéå†æ‰€æœ‰ Node çš„ Volumeï¼Œè¿›è¡Œæ£€æŸ¥å¹¶æ›´æ–° actualStateOfWorldã€‚ func (rc *reconciler) sync() { defer rc.updateSyncTime() rc.syncStates() } func (rc *reconciler) updateSyncTime() { rc.timeOfLastSync = time.Now() } func (rc *reconciler) syncStates() { volumesPerNode := rc.actualStateOfWorld.GetAttachedVolumesPerNode() rc.attacherDetacher.VerifyVolumesAreAttached(volumesPerNode, rc.actualStateOfWorld) } ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.3 Reconcile æ ¸å¿ƒçš„ Reconcile ä¸­ä¸»è¦æ‰§è¡Œäº†ä¸¤ä¸ªæ“ä½œï¼š Detach Volume - Attached Volume å­˜åœ¨äº actualStateOfWorldï¼Œä½†æ˜¯ä¸å­˜åœ¨äº desiredStateOfWorld Attach Volume - Volume å­˜åœ¨äº desiredStateOfWorldï¼Œä½†æ˜¯ actualStateOfWorld ä¸­çŠ¶æ€ä¸º Unattached func (rc *reconciler) reconcile() { for _, attachedVolume := range rc.actualStateOfWorld.GetAttachedVolumes() { if !rc.desiredStateOfWorld.VolumeExists( attachedVolume.VolumeName, attachedVolume.NodeName) { // å¦‚æœ Attached Volume å­˜åœ¨äº actualStateOfWorldï¼Œä½†æ˜¯ä¸å­˜åœ¨äº desiredStateOfWorld // è¡¨æ˜ Volume éœ€è¦ detach // ... attachState := rc.actualStateOfWorld.GetAttachState(attachedVolume.VolumeName, attachedVolume.NodeName) if attachState == cache.AttachStateDetached { // å¦‚æœ attachState å·²ç»æ˜¯ Detached äº†ï¼Œè·³è¿‡å¤„ç† continue } // ... // å°† Volume æ ‡è®°ä¸º detached err = rc.actualStateOfWorld.RemoveVolumeFromReportAsAttached(attachedVolume.VolumeName, attachedVolume.NodeName) // æ›´æ–° Node Status err = rc.nodeStatusUpdater.UpdateNodeStatuses() if err != nil { continue } // æ‰§è¡Œ detach Volume klog.V(5).Infof(attachedVolume.GenerateMsgDetailed(\"Starting attacherDetacher.DetachVolume\", \"\")) verifySafeToDetach := !timeout err = rc.attacherDetacher.DetachVolume(attachedVolume.AttachedVolume, verifySafeToDetach, rc.actualStateOfWorld) // ... } } // attach Volume rc.attachDesiredVolumes() // Update Node Status err := rc.nodeStatusUpdater.UpdateNodeStatuses() } func (rc *reconciler) attachDesiredVolumes() { // Ensure volumes that should be attached are attached. for _, volumeToAttach := range rc.desiredStateOfWorld.GetVolumesToAttach() { // éå† desiredStateOfWorld // ... attachState := rc.actualStateOfWorld.GetAttachState(volumeToAttach.VolumeName, volumeToAttach.NodeName) if attachState == cache.AttachStateAttached { // Volume/Node exists, touch it to reset detachRequestedTime rc.actualStateOfWorld.ResetDetachRequestTime(volumeToAttach.VolumeName, volumeToAttach.NodeName) continue } // ... err := rc.attacherDetacher.AttachVolume(volumeToAttach.VolumeToAttach, rc.actualStateOfWorld) } } ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5 Kubelet çš„å¤„ç† Kubelet ä¸­å¯¹ Volume çš„å¤„ç†ä¹Ÿæ˜¯åŸºäº AttachDetach Controller çš„æ–¹å¼ï¼Œä¾èµ–äºä¸¤ä¸ª map çš„æ•°æ®è¿›è¡Œå‘¨æœŸæ€§åè°ƒï¼šactualStateOfWorld ä¸ desiredStateOfWorldã€‚ æˆ‘ä»¬ä¸å†è¯´æ˜ actualStateOfWorld ä¸ desiredStateOfWorld çš„å¡«å……ï¼Œåªçœ‹ä¸‹å…¶ Reconcile æµç¨‹ã€‚ ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.1 Reconcile reconcile() æ•´ä½“é€»è¾‘å°±æ˜¯ä¸‰æ­¥ï¼š unmountVolumes() mountAttachVolumes() unmountDetachDevices() func (rc *reconciler) reconcile() { // Unmounts are triggered before mounts so that a volume that was // referenced by a pod that was deleted and is now referenced by another // pod is unmounted from the first pod before being mounted to the new // pod. rc.unmountVolumes() // Next we mount required volumes. This function could also trigger // attach if kubelet is responsible for attaching volumes. // If underlying PVC was resized while in-use then this function also handles volume // resizing. rc.mountAttachVolumes() // Ensure devices that should be detached/unmounted are detached/unmounted. rc.unmountDetachDevices() } 5.1.1 unmountVolumes unmountVolumes è´Ÿè´£ unmount éœ€è¦çš„ volumeï¼Œé€šè¿‡åˆ¤æ–­ mounted volume æ˜¯å¦å­˜åœ¨äº actualStateOfWorldã€‚ func (rc *reconciler) unmountVolumes() { // éå†å½“å‰èŠ‚ç‚¹æ‰€æœ‰çš„ mounted volume for _, mountedVolume := range rc.actualStateOfWorld.GetAllMountedVolumes() { // æ£€æŸ¥è¯¥ volume ä¸ pod æ˜¯å¦å­˜åœ¨äº desiredStateOfWorld if !rc.desiredStateOfWorld.PodExistsInVolume(mountedVolume.PodName, mountedVolume.VolumeName) { // è¿›è¡Œ unmount volume æ“ä½œï¼ˆåº•å±‚è°ƒç”¨çš„æ˜¯ VolumePlugin.TearDownï¼‰ err := rc.operationExecutor.UnmountVolume( mountedVolume.MountedVolume, rc.actualStateOfWorld, rc.kubeletPodsDir) if err != nil \u0026\u0026 !nestedpendingoperations.IsAlreadyExists(err) \u0026\u0026 !exponentialbackoff.IsExponentialBackoff(err) { // Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected. // Log all other errors. klog.ErrorS(err, mountedVolume.GenerateErrorDetailed(fmt.Sprintf(\"operationExecutor.UnmountVolume failed (controllerAttachDetachEnabled %v)\", rc.controllerAttachDetachEnabled), err).Error()) } if err == nil { klog.InfoS(mountedVolume.GenerateMsgDetailed(\"operationExecutor.UnmountVolume started\", \"\")) } } } } operationExecutor.UnmountVolume() æ˜¯å¯¹ unmount è¿›è¡Œäº†å°è£…ï¼Œå…¶åº•å±‚ä¼šæŸ¥æ‰¾æ”¯æŒçš„ VolumePluginï¼Œå¹¶è°ƒç”¨ VolumePlugin.TearDown() æ¥å£ã€‚ 5.1.2 mountAttachVolumes mountAttachVolumes è´Ÿè´£å‡†å¤‡ volumeã€‚æœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š å¦‚æœ volume è¿˜æœª attachï¼Œè€Œ kubelet å…è®¸æ‰§è¡Œ attachï¼Œé‚£ä¹ˆè°ƒç”¨ Attach æ“ä½œã€‚ å¦‚æœ volume è¿˜æœª mountï¼Œé‚£ä¹ˆæ‰§è¡Œ MountDevice ä¸ SetUp æ“ä½œã€‚ func (rc *reconciler) mountAttachVolumes() { // éå† desiredStateOfWorld // Ensure volumes that should be attached/mounted are attached/mounted. for _, volumeToMount := range rc.desiredStateOfWorld.GetVolumesToMount() { // æŸ¥è¯¢ actualStateOfWorld å¯¹åº”çš„ volume çŠ¶æ€ volMounted, devicePath, err := rc.actualStateOfWorld.PodExistsInVolume(volumeToMount.PodName, volumeToMount.VolumeName) volumeToMount.DevicePath = devicePath // æ ¹æ® volMounted ä¸ errï¼Œæ‰§è¡Œæ“ä½œ if cache.IsVolumeNotAttachedError(err) { // å¦‚æœ err è¡¨æ˜ volume è¿˜æœªè¢« attache if rc.controllerAttachDetachEnabled || !volumeToMount.PluginIsAttachable { // volume æœªè¢« attachï¼Œè€Œ kubelet ä¸å…è®¸æ‰§è¡Œ attach æ“ä½œï¼Œé‚£ä¹ˆç­‰å¾… Contrller è¿›è¡Œ attach err := rc.operationExecutor.VerifyControllerAttachedVolume( volumeToMount.VolumeToMount, rc.nodeName, rc.actualStateOfWorld) // log } else { // volume æœªè¢« attachï¼Œè€Œ kubelet å…è®¸è¿›è¡Œ attach æ“ä½œï¼Œé‚£ä¹ˆç”± kubelet è°ƒç”¨ attach æ“ä½œ volumeToAttach := operationexecutor.VolumeToAttach{ VolumeName: volumeToMount.VolumeName, VolumeSpec: volumeToMount.VolumeSpec, NodeName: rc.nodeName, } err := rc.operationExecutor.AttachVolume(volumeToAttach, rc.actualStateOfWorld) // log } } else if !volMounted || cache.IsRemountRequiredError(err) { // å¦‚æœ volume è¿˜æœªè¢« mountï¼Œæˆ–è€… err éœ€è¦é‡æ–° mount // è°ƒç”¨ MountVolumeï¼Œåº•å±‚ä¼šè¿›è¡Œ MountDevice + SetUp æ“ä½œ remountingLogStr := \"\" isRemount := cache.IsRemountRequiredError(err) if isRemount { remountingLogStr = \"Volume is already mounted to pod, but remount was requested.\" } err := rc.operationExecutor.MountVolume( rc.waitForAttachTimeout, volumeToMount.VolumeToMount, rc.actualStateOfWorld, isRemount) // log } else if cache.IsFSResizeRequiredError(err) \u0026\u0026 utilfeature.DefaultFeatureGate.Enabled(features.ExpandInUsePersistentVolumes) { // å¦‚æœ volume ä¸ºéœ€è¦æ‰©å®¹ // è°ƒç”¨ ExpandInUseVolume è¿›è¡Œæ‰©å®¹ klog.V(4).InfoS(volumeToMount.GenerateMsgDetailed(\"Starting operationExecutor.ExpandInUseVolume\", \"\"), \"pod\", klog.KObj(vol","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:5:1","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ Blogï¼šè¯¦è§£ Kubernetes Volume çš„å®ç°åŸç† Blogï¼škubelet volume manager æºç åˆ†æ ","date":"2021-11-11","objectID":"/posts/cloud_computing/k8s_learning/volume-implementation/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"æºç é˜…è¯» - Volume å®ç°","uri":"/posts/cloud_computing/k8s_learning/volume-implementation/"},{"categories":["Security"],"content":"Cookieã€Sessionã€JWT","date":"2021-10-25","objectID":"/posts/security/credentials/","tags":["security"],"title":"å‡­è¯ Credential","uri":"/posts/security/credentials/"},{"categories":["Security"],"content":"åœ¨æˆæƒè¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬æ¯ç§æˆæƒæ¨¡å¼ç›®çš„å°±æ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªä»¤ç‰Œï¼Œä»¤ç‰Œå°±æ˜¯ å‡­è¯Credentialã€‚ç›®å‰ä¸»æµæœ‰ä¸¤ç§ä»¤ç‰Œå®ç°æ–¹å¼ï¼šCookie-Session å’Œ JWTã€‚ ","date":"2021-10-25","objectID":"/posts/security/credentials/:0:0","tags":["security"],"title":"å‡­è¯ Credential","uri":"/posts/security/credentials/"},{"categories":["Security"],"content":"1 Cookie-Session HTTP æ˜¯æ— çŠ¶æ€åè®®ï¼Œå®ç°äº†ç®€å•çš„ Web èµ„æºäº¤æ¢åŠŸèƒ½ã€‚ä½†æ˜¯ä¸€äº›æƒ…å†µä¸‹ä¹Ÿéœ€è¦ä¸€äº›æ‰‹æ®µï¼Œè®©æœåŠ¡å™¨æ¥æ”¶ HTTP è¯·æ±‚æ—¶èƒ½å¤Ÿå¾—ç”¨æˆ·çŸ¥ç›¸å…³çš„ä¸Šä¸‹æ–‡ã€‚ä¸ºæ­¤ï¼ŒRFC 6265 å®šä¹‰äº† HTTP çš„çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œåœ¨ HTTP åè®®ä¸­å¢åŠ äº† Set-Cookie æŒ‡ä»¤ã€‚ Set-Cookie æŒ‡ä»¤çš„å«ä¹‰æ˜¯ï¼šä»¥é”®å€¼å¯¹çš„æ–¹å¼å‘å®¢æˆ·ç«¯å‘é€ä¸€ç»„ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯å°†åœ¨æ­¤åæ¯æ¬¡ HTTP è¯·æ±‚ä¸­ï¼Œä»¥åä¸º Cookie çš„ Header å‘é€ç»™æœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯å°±å¯ä»¥æ ¹æ® Cookie å­—æ®µæ¥åŒºåˆ†å®¢æˆ·ç«¯ã€‚ Set-Cookie: id=icyfenix; Expires=Wed, 21 Feb 2020 07:28:00 GMT; Secure; HttpOnly æ”¶åˆ°è¯¥æŒ‡ä»¤åï¼Œå®¢æˆ·ç«¯å†æ¬¡è®¿é—®æ—¶ä¼šå¸¦æœ‰ Cookie Headerï¼Œä¾‹å¦‚ï¼š GET /index.html HTTP/2.0 Host: icyfenix.cn Cookie: id=icyfenix è¿™æ ·ï¼Œæ¯æ¬¡è¯·æ±‚ä¼ åˆ°æœåŠ¡å™¨çš„ Cookieï¼ŒæœåŠ¡ç«¯å°±èƒ½å¤Ÿè¯†åˆ«å‡ºæ˜¯å“ªä¸ªç”¨æˆ·ã€‚å› ä¸º Cookie æ˜¯ HTTP Headerï¼Œæ‰€ä»¥é€šå¸¸ Cookie çš„å€¼ä¸ºä¸€ä¸ª session idã€‚æœåŠ¡ç«¯æ ¹æ® session id åœ¨ä¿å­˜çš„ä¿¡æ¯ä¸­æ£€ç´¢å‡ºç”¨æˆ·å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å†åŠ ä¸Šä¸€äº›è¶…æ—¶è‡ªåŠ¨æ¸…ç†çš„ç®¡ç†æªæ–½ã€‚ è¿™ç§æœåŠ¡ç«¯çš„çŠ¶æ€æœºåˆ¶å°±ç§°ä¸º Sessionã€‚Cookie-Session å°±æ˜¯ç›®å‰æœ€ä¼ ç»Ÿä¹Ÿæœ€å¸¸ç”¨çš„å®¢æˆ·ç«¯æœåŠ¡ç«¯çŠ¶æ€ç®¡ç†æœºåˆ¶ã€‚ ä¼˜ç‚¹ï¼š å®‰å…¨æ€§ä¼˜åŠ¿ï¼Œå› ä¸ºçŠ¶æ€ä¿¡æ¯éƒ½å­˜å‚¨äºæœåŠ¡ç«¯ï¼› æœåŠ¡ç«¯ç®¡ç†çŠ¶æ€ä¿¡æ¯ï¼Œèƒ½å¤Ÿå®ç°çµæ´»çš„ç®¡ç†ï¼› ç¼ºç‚¹ï¼š ç”±äº Session å­˜å‚¨åœ¨æœåŠ¡å™¨å†…å­˜ä¸­ï¼ŒCookie-Session å½“é‡åˆ°å¤šèŠ‚ç‚¹ç¯å¢ƒæ—¶ï¼Œå„ä¸ªæœåŠ¡å™¨ä¹‹é—´çš„çŠ¶æ€ä¿¡æ¯åŒæ­¥å°±æ˜¯ä¸ªé—®é¢˜ï¼Œç±»ä¼¼äºåˆ†å¸ƒå¼çš„çŠ¶æ€é—®é¢˜ï¼› é€šå¸¸ï¼ŒCookie-Session é‡åˆ°å¤šèŠ‚ç‚¹çš„è§£å†³æ–¹æ¡ˆæœ‰ï¼š è´Ÿè½½å‡è¡¡ - æ¯ä¸ªç‰¹å®šç”¨æˆ·è¯·æ±‚åˆ†é…åˆ°ç‰¹å®šçš„æŸä¸ªæœåŠ¡å™¨ï¼› çŠ¶æ€åŒæ­¥ - æ¯ä¸ªæœåŠ¡å™¨å°† Session å˜åŠ¨åŒæ­¥åˆ°å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨ï¼› å•ç‚¹ - å°† Session é›†ä¸­æ”¾åœ¨ä¸€ä¸ªå•ç‚¹æœåŠ¡å™¨ï¼Œæ‰€æœ‰æœåŠ¡å™¨æ— çŠ¶æ€ï¼Œè®¿é—®å•ç‚¹ Session æœåŠ¡å™¨è¯»å–çŠ¶æ€ï¼› ","date":"2021-10-25","objectID":"/posts/security/credentials/:1:0","tags":["security"],"title":"å‡­è¯ Credential","uri":"/posts/security/credentials/"},{"categories":["Security"],"content":"2 JWT ä¸ Cookie-Session ä¿å­˜çŠ¶æ€ä¿¡æ¯çš„æ€è·¯ç›¸åï¼Œå½“æœåŠ¡å™¨å­˜åœ¨å¤šä¸ªæ—¶ï¼Œä¸€ä¸ªçŠ¶æ€ä¿¡æ¯å¯¹åº”å®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥æŠŠçŠ¶æ€ä¿¡æ¯ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡éšç€è¯·æ±‚å‘é€ç»™æœåŠ¡ç«¯ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ€è·¯çš„ç¼ºç‚¹æ˜¯æ— æ³•æºå¸¦å¤§é‡ä¿¡æ¯ï¼Œè€Œä¸”æœ‰ç€æ³„æ¼å’Œç¯¡æ”¹çš„é£é™©ã€‚ JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ç›®å‰å¹¿æ³›ä½¿ç”¨çš„ä»¤ç‰Œæ ¼å¼ï¼Œèƒ½å¤Ÿç¡®ä¿ä¼ è¾“ä¿¡æ¯ä¸è¢«ä¸­é—´äººç¯¡æ”¹ã€‚ Note JWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œå› ä¸ºä»…ä»…è§£å†³é˜²æ­¢ç¯¡æ”¹é—®é¢˜ï¼Œä¸è§£å†³æ³„æ¼é—®é¢˜ã€‚ JWT æœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼æ˜¯ä½œä¸ºåä¸º Authorization çš„ Header å‘é€æœåŠ¡ç«¯ã€‚å…¶å€¼å‰ç¼€å®šä¹‰ä¸º Bearerï¼Œç±»ä¼¼äºï¼š GET /restful/products/1 HTTP/1.1 Host: icyfenix.cn Connection: keep-alive Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJpY3lmZW5peCIsInNjb3BlIjpbIkFMTCJdLCJleHAiOjE1ODQ5NDg5NDcsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiIsIlJPTEVfQURNSU4iXSwianRpIjoiOWQ3NzU4NmEtM2Y0Zi00Y2JiLTk5MjQtZmUyZjc3ZGZhMzNkIiwiY2xpZW50X2lkIjoiYm9va3N0b3JlX2Zyb250ZW5kIiwidXNlcm5hbWUiOiJpY3lmZW5peCJ9.539WMzbjv63wBtx4ytYYw_Fo1ECG_9vsgAn8bheflL8 ","date":"2021-10-25","objectID":"/posts/security/credentials/:2:0","tags":["security"],"title":"å‡­è¯ Credential","uri":"/posts/security/credentials/"},{"categories":["Security"],"content":"2.1 JWT çš„æ ¼å¼ JWT ä¼ è¾“æ—¶æ˜¯ä»¥ Base64 ç¼–ç åä¼ è¾“ï¼Œå…¶åŸæ–‡æ ¼å¼ä»¥ JSON æ ¼å¼ã€‚æ€»ç»“åˆ’åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†é—´ç”¨ç‚¹å· â€œ.â€ åˆ†éš”ã€‚ ç¬¬ä¸€éƒ¨åˆ†æ˜¯ Headerï¼š { \"alg\": \"HS256\", \"typ\": \"JWT\" } alg - ç­¾åçš„ç®—æ³• typ - ä»¤ç‰Œç±»å‹ ç¬¬äºŒéƒ¨åˆ†æ˜¯ Payloadï¼Œå³ä»¤ç‰ŒçœŸæ­£ä¼ è¾“çš„ä¿¡æ¯ï¼Œç”¨æˆ·éšæ„å®šåˆ¶ã€‚ { \"username\": \"icyfenix\", \"authorities\": [ \"ROLE_USER\", \"ROLE_ADMIN\" ], \"scope\": [ \"ALL\" ], \"exp\": 1584948947, \"jti\": \"9d77586a-3f4f-4cbb-9924-fe2f77dfa33d\", \"client_id\": \"bookstore_frontend\" } JWT RFC ä¸­æ¨èäº†ä¸ƒé¡¹å†…å®¹ï¼š issï¼ˆIssuerï¼‰- ç­¾å‘äººï¼› expï¼ˆExpiration Timeï¼‰- ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼› subï¼ˆSubjectï¼‰- ä¸»é¢˜ï¼› audï¼ˆAudienceï¼‰- ä»¤ç‰Œå—ä¼—ï¼› nbfï¼ˆNot Beforeï¼‰- ä»¤ç‰Œç”Ÿæ•ˆæ—¶é—´ï¼› iatï¼ˆIssued Atï¼‰- ä»¤ç‰Œç­¾å‘æ—¶é—´ï¼› jtiï¼ˆJWT IDï¼‰- ä»¤ç‰Œ IDï¼› ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ Signatureï¼Œé€šè¿‡ Header ä¸­å®šä¹‰ç®—æ³•ï¼Œé€šè¿‡ç‰¹å®šå¯†é’¥ï¼ˆæœåŠ¡å™¨ä¿ç®¡ï¼‰å¯¹å‰é¢ä¸¤éƒ¨åˆ†è¿›è¡ŒåŠ å¯†è®¡ç®—ã€‚æœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ° JWT åï¼Œåªè¦å†…å®¹è¢«ç¯¡æ”¹è¿‡ï¼Œå…¶ç­¾åå°±æ— æ³•é€šè¿‡æ£€æŸ¥ã€‚ ä¼˜ç‚¹ï¼š æœåŠ¡ç«¯æ— çŠ¶æ€ ç¼ºç‚¹ï¼š ä»¤ç‰Œéš¾ä»¥ä¸»åŠ¨å¤±æ•ˆã€‚ä»¤ç‰Œç­¾å‘åï¼Œç†è®ºä¸Šå’Œè®¤è¯æœåŠ¡å™¨æ²¡æœ‰å…³è”äº†ï¼Œéš¾ä»¥ä¸»åŠ¨è®©æŸä¸ªä»¤ç‰Œå¤±æ•ˆã€‚é€šå¸¸ï¼Œä¼šä½¿ç”¨ Session æœºåˆ¶åœ¨æœåŠ¡ç«¯ç»´æŠ¤ä¸€ä¸ªé»‘åå•ï¼Œè¿‡æ»¤å¤±æ•ˆçš„ä»¤ç‰Œã€‚ å®¹æ˜“æ”¶åˆ°é‡æ”¾æ”»å‡»ã€‚ åªèƒ½æºå¸¦ä¼˜å…ˆçš„æ•°æ®ã€‚ å¿…é¡»è€ƒè™‘ä»¤ç‰Œåœ¨å®¢æˆ·ç«¯å¦‚ä½•å­˜å‚¨ã€‚ ","date":"2021-10-25","objectID":"/posts/security/credentials/:2:1","tags":["security"],"title":"å‡­è¯ Credential","uri":"/posts/security/credentials/"},{"categories":["Security"],"content":"RBACã€OAuth2","date":"2021-10-24","objectID":"/posts/security/authorization/","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"è®¤è¯è§£å†³äº†å¯¹ç”¨æˆ·èº«ä»½è®¤è¯çš„é—®é¢˜ï¼Œæˆç”¨äºè§£å†³ç”¨æˆ·æœ‰ç€å“ªäº›æƒé™çš„é—®é¢˜ã€‚æ¶‰åŠä¸¤ä¸ªç‹¬ç«‹çš„é—®é¢˜ï¼š ç¡®ä¿æˆæƒçš„è¿‡ç¨‹å¯é  - å¸¸ç”¨ OAuth2 å’Œ SAML 2.0 ç¡®ä¿æˆæƒçš„ç»“æœå¯æ§ - å¸¸ç”¨ DACã€ABAC å’Œ RBACã€‚ ","date":"2021-10-24","objectID":"/posts/security/authorization/:0:0","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"1 RBAC ","date":"2021-10-24","objectID":"/posts/security/authorization/:1:0","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"2 OAuth 2 OAuth 2 æ˜¯åœ¨ RFC 6749 ä¸­å®šä¹‰çš„å›½é™…æ ‡å‡†ï¼Œç”¨äºè§£å†³é¢å‘ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆThird-Party Applicationï¼‰çš„è®¤è¯æˆæƒåè®®ã€‚å½“ä¸€ä¸ªç¬¬ä¸‰æ–¹åº”ç”¨è¦è®¿é—®æŸä¸ªç³»ç»Ÿæ—¶ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å°†è´¦å·å¯†ç å‘ŠçŸ¥ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä½†æ˜¯è¿™æ ·æ˜¾ç„¶å¯¼è‡´äº†å¯†ç æ³„éœ²ï¼Œå¹¶ä¸”è¿˜æ— æ³•å¾ˆå¥½çš„å›æ”¶æƒé™ã€‚è¿™ä¹Ÿæ­£æ˜¯ OAuth 2 è¦è§£å†³çš„é—®é¢˜ã€‚ OAuth 2 æœ‰è®¸å¤šæ–¹å¼ï¼Œä¸è¿‡å…±åŒç‰¹å¾å°±æ˜¯ä»¥ ä»¤ç‰ŒToken ä»£æ›¿ç”¨æˆ·å¯†ç ä½œä¸ºå‡­è¯ã€‚ å“ªæ€•ä»¤ç‰Œæ³„éœ²ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å¯†ç æ³„éœ²ï¼› ä»¤ç‰Œå¯ä»¥è®¾å®šè®¿é—®èµ„æºçš„èŒƒå›´ï¼Œä»¥åŠæ—¶æ•ˆæ€§ï¼› æ¯ä¸ªåº”ç”¨éƒ½æœ‰ç‹¬ç«‹çš„ä»¤ç‰Œï¼Œå…¶ä¸­ä¸€ä¸ªæ³„éœ²ä¸ä¼šå¯¼è‡´å…¶ä»–åº”ç”¨æ”¶åˆ°å½±å“ï¼› ","date":"2021-10-24","objectID":"/posts/security/authorization/:2:0","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"2.1 åŸºæœ¬æ¦‚å¿µ ç¬¬ä¸‰æ–¹åº”ç”¨ Third-Party Application - éœ€è¦å¾—åˆ°æˆæƒï¼Œè®¿é—®æŸä¸ªèµ„æºçš„åº”ç”¨ï¼› æˆæƒæœåŠ¡å™¨ Authorization Server - æ ¹æ®ç”¨æˆ·æ„æ„¿æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨çš„æœåŠ¡å™¨ï¼› èµ„æºæœåŠ¡å™¨ Resource Server - ä¿å­˜ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦è®¿é—®èµ„æºçš„æœåŠ¡å™¨ï¼› èµ„æºæ‰€æœ‰è€… Resource Owner - æ‹¥æœ‰æˆæƒæƒé™çš„äººï¼› æ“ä½œä»£ç† User Agent - ç”¨æˆ·ç”¨æ¥è®¿é—®æœåŠ¡å™¨çš„å·¥å…·ï¼Œä¾‹å¦‚æµè§ˆå™¨ã€HTTPClientï¼› åŸºæœ¬çš„è®¿é—®æµç¨‹å¦‚ä¸‹å›¾ï¼Œä¸åŒæ–¹å¼åœ¨å…¶ä¸­æ­¥éª¤ä¸­æœ‰æ‰€å»¶å±•ï¼š ","date":"2021-10-24","objectID":"/posts/security/authorization/:2:1","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"2.2 æˆæƒç æ¨¡å¼ æˆæƒç æ¨¡å¼Authorization Code æ˜¯æœ€ä¸¥æ ¼çš„æ–¹å¼ï¼Œè€ƒè™‘äº†å‡ ä¹æ‰€æœ‰çš„æ•æ„Ÿä¿¡æ¯æ³„æ¼çš„é¢„é˜²å’Œåæœã€‚ å¼€å§‹æˆæƒå‰ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å…ˆè¦åˆ°æˆæƒæœåŠ¡å™¨æ³¨å†Œï¼Œä»æˆæƒæœåŠ¡å™¨ä¸­è·å¾—åº”ç”¨å¯¹åº”çš„ ClientID å’Œ ClientSecretã€‚ å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ - ç”¨æˆ·è®¿é—®æ—¶ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·å®šå‘åˆ°æˆæƒæœåŠ¡å™¨çš„æˆæƒé¡µé¢ï¼Œå‘æˆæƒæœåŠ¡å™¨æä¾› ClientIDï¼Œä»¥åŠç”¨æˆ·å¦‚æœåŒæ„æˆæƒåè¦è·³è½¬çš„ URIã€‚ ç”¨æˆ·æˆæƒ - æˆæƒæœåŠ¡å™¨æ ¹æ® ClientID ç¡®å®šç¬¬ä¸‰æ–¹åº”ç”¨èº«ä»½ï¼Œç”¨æˆ·å†³å®šæ˜¯å¦åŒæ„æˆæƒã€‚ å¾—åˆ°æˆæƒç  - åŠæ³•ç”¨æˆ·åŒæ„æˆæƒåï¼ŒæˆæƒæœåŠ¡å™¨å°†å®šå‘åˆ°ç¬¬ 1 æ­¥ä¸­çš„å›è°ƒ URIï¼Œå¹¶é™„å¸¦ä¸Šæˆæƒç çš„è·å–åœ°å€ä½œä¸ºå‚æ•°ã€‚ è·å–ä»¤ç‰Œ - ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®æˆæƒç åœ°å€å¾—åˆ°æˆæƒç ï¼Œå°†æˆæƒç ä¸è‡ªå·±çš„ ClientSecret ä½œä¸ºå‚æ•°ï¼Œè®¿é—®æˆæƒæœåŠ¡å™¨æ¥æ¢å–ä»¤ç‰Œã€‚ é¢å‘ä»¤ç‰Œ - æˆæƒæœåŠ¡å™¨æ£€æŸ¥æˆæƒç å’Œ ClientSecretï¼Œæ— è¯¯åé¢å‘ä»¤ç‰Œã€‚ä»¤ç‰ŒåŒ…æ‹¬è®¿é—®ä»¤ç‰Œä¸åˆ·æ–°ä»¤ç‰Œã€‚ èµ„æºæœåŠ¡å™¨æ£€æŸ¥è®¿é—®ä»¤ç‰Œä¸æˆæƒæƒé™ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨æä¾›èµ„æºã€‚ ","date":"2021-10-24","objectID":"/posts/security/authorization/:2:2","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"2.3 éšå¼æˆæƒæ¨¡å¼ éšå¼æˆæƒæ¨¡å¼Implicit çœç•¥äº†é€šè¿‡æˆæƒç æ¢å–ä»¤ç‰Œçš„æ­¥éª¤ï¼ˆåˆå¹¶äº†ä¸Šè¿°ç¬¬ 3 4 5 æ­¥ï¼‰ï¼Œå¹¶ä¸”æ˜ç¡®ç¦æ­¢å‘æ”¾åˆ·æ–°ä»¤ç‰Œã€‚ å¯ä»¥çœ‹åˆ°ï¼ŒæˆæƒæœåŠ¡å™¨ä¸ä¼šéªŒè¯ç¬¬ä¸‰æ–¹åº”ç”¨çš„èº«ä»½ï¼Œåœ¨å¾—åˆ°ç”¨æˆ·æˆæƒåï¼Œç›´æ¥è¿”å›è®¿é—®ä»¤ç‰Œç»™ç¬¬ä¸‰æ–¹å¼•ç”¨ã€‚æ˜¾ç„¶ï¼Œè¿™æ ·å‡ä½äº†å®‰å…¨æ€§ï¼Œä½†æ˜¯æ— éœ€æ³¨å†Œæå‡äº†çµæ´»æ€§ã€‚ å¦å¤–ï¼ŒRFC 6749 ä¸­æ˜ç¡®è¯´æ˜ä»¤ç‰Œå¿…é¡»æ˜¯é€šè¿‡ URI çš„ Fragment å¸¦å›çš„ã€‚ ","date":"2021-10-24","objectID":"/posts/security/authorization/:2:3","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"2.4 å¯†ç æ¨¡å¼ å¯†ç æ¨¡å¼Resource Owner Password Credentials æ•´åˆäº†è®¤è¯å’Œæˆæƒçš„è¿‡ç¨‹ã€‚ç¬¬ä¸‰æ–¹åº”ç”¨ç›´æ¥æ‹¿ç€è´¦æˆ·å’Œå¯†ç å‘æˆæƒæœåŠ¡å™¨æ¢å–ä»¤ç‰Œã€‚ ","date":"2021-10-24","objectID":"/posts/security/authorization/:2:4","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"2.5 å®¢æˆ·ç«¯æ¨¡å¼ å®¢æˆ·ç«¯æ¨¡å¼Client Credentials æŒ‡ç¬¬ä¸‰æ–¹åº”ç”¨ä»¥ç”¨æˆ·åä¹‰ï¼Œç›´æ¥å‘æˆæƒæœåŠ¡å™¨ç”³è¯·èµ„æºè®¸å¯ã€‚è¯¥æ¨¡å¼é€šå¸¸ç”¨äºç®¡ç†æ“ä½œæˆ–è€…è‡ªåŠ¨å¤„ç†çš„åœºæ™¯ä¸­ï¼Œå³å¸¸ç”¨äºæœåŠ¡é—´è®¤è¯æˆæƒã€‚ ","date":"2021-10-24","objectID":"/posts/security/authorization/:2:5","tags":["security"],"title":"æˆæƒ Authorization","uri":"/posts/security/authorization/"},{"categories":["Security"],"content":"è®¤è¯åŸºæœ¬æ¦‚å¿µï¼ŒåŸºæœ¬è®¤è¯æœºåˆ¶","date":"2021-10-23","objectID":"/posts/security/authentication/","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["Security"],"content":" æ–‡ç« å†…å®¹æ¥è‡ªäºã€Šå‡¤å‡°æ¶æ„ã€‹ï¼Œæ¨èé˜…è¯»ã€‚ è®¤è¯Authentication ç”¨æ¥è§£å†³ç³»ç»Ÿå¯¹ç”¨æˆ·èº«ä»½è®¤è¯çš„é—®é¢˜ï¼Œä¾‹å¦‚ç”¨æˆ·å¯†ç å°±æ˜¯æœ€ç®€å•çš„è®¤è¯æœºåˆ¶ã€‚ç”¨æˆ·ä¸ä»…ä»…æ˜¯äººï¼Œä¹Ÿå¯èƒ½æŒ‡å¤–éƒ¨çš„ä»£ç ã€‚ ä»ç½‘ç»œèµ„æºä¼ è¾“æµç¨‹ä¸Šï¼Œæœ‰ç€ä¸»è¦ä¸‰ä¸ªè®¤è¯æ–¹å¼ï¼š é€šä¿¡ä¿¡é“ä¸Šçš„è®¤è¯ï¼šå»ºç«‹ç½‘ç»œè¿æ¥æ—¶ï¼Œè¿›è¡Œèº«ä»½çš„è®¤è¯ã€‚å…¸å‹æ˜¯åŸºäº SSL/TLS çš„ä¼ è¾“å±‚è®¤è¯ã€‚ é€šä¿¡åè®®ä¸Šçš„è®¤è¯ï¼šè·å–èµ„æºæ—¶ï¼Œç”±åè®®è¿›è¡Œèº«ä»½çš„è®¤è¯ã€‚å…¸å‹æ˜¯åŸºäº HTTP åè®®çš„è®¤è¯ã€‚ é€šä¿¡å†…å®¹ä¸Šçš„è®¤è¯ï¼šè·å–èµ„æºæ—¶ï¼Œç”±ä¸šåŠ¡è¿›è¡Œèº«ä»½è®¤è¯ã€‚å…¸å‹æ˜¯åŸºäº Web å†…å®¹çš„è®¤è¯ã€‚ ","date":"2021-10-23","objectID":"/posts/security/authentication/:0:0","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["Security"],"content":"1 ä¼ è¾“å±‚çš„è®¤è¯ ","date":"2021-10-23","objectID":"/posts/security/authentication/:1:0","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["Security"],"content":"1.1 æ‘˜è¦ã€åŠ å¯†ä¸ç­¾å æ‘˜è¦digest é€šè¿‡å“ˆå¸Œç®—æ³•çš„æ˜“å˜æ€§ä¸ä¸å¯é€†æ€§ï¼Œç”¨äºåˆ¤æ–­æ•°æ®çš„çœŸä¼ªã€‚ æ˜“å˜æ€§ - å¦‚æœè¾“å…¥ç«¯å‘ç”Ÿä»»ä½•ä¸€ç‚¹å˜åŠ¨ï¼Œå“ˆå¸Œç»“æœéƒ½ä¼šäº§ç”Ÿæå¤§å˜åŒ–ã€‚é€šè¿‡å¯¹æ¯”æ‘˜è¦ï¼Œå¯ä»¥åˆ¤æ–­æ”¶åˆ°çš„æ•°æ®ä¸æºæ•°æ®æ˜¯å¦æ˜¯ä¸€è‡´çš„ã€‚ ä¸å¯é€†è¡Œ - ä»æ‘˜è¦æ— æ³•è¿˜åŸå‡ºæºæ•°æ®ï¼Œä¿è¯å…¬å¼€çš„æ‘˜è¦ä¸ä¼šæ³„æ¼æºæ•°æ®ã€‚ åŠ å¯†encryption ä¸æ‘˜è¦çš„æœ¬è´¨åŒºåˆ«æ˜¯ï¼ŒåŠ å¯†æ˜¯å¯é€†çš„ï¼Œé€šè¿‡è§£å¯†å¯ä»¥å¾—åˆ°åŸæ•°æ®ã€‚æ ¹æ®åŠ å¯†ä¸è§£å¯†æ˜¯å¦ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥ï¼Œå¯ä»¥åˆ†ä¸º å¯¹ç§°åŠ å¯†ç®—æ³• å’Œ éå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚ å¯¹ç§°åŠ å¯†ç®—æ³• - åŠ å¯†å’Œè§£å¯†æ—¶ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ æ€§èƒ½æ¯”éå¯¹ç§°åŠ å¯†é«˜ï¼Œä½†æ˜¯é¢ä¸´ç€å¯†é’¥ä¼ è¾“éš¾é¢˜ï¼ˆæ— æ³•ä¿è¯å¯†é’¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸æ³„éœ²ï¼‰ã€‚ éå¯¹ç§°åŠ å¯†ç®—æ³• - å¯†é’¥åˆ†ä¸ºå…¬é’¥ä¸ç§é’¥ï¼Œç§é’¥ç”±ç”¨æˆ·ä¿ç®¡ï¼Œå…¬é’¥å¯ä»¥ä¼ è¾“ç»™å¯¹ç«¯ã€‚å…¬é’¥åŠ å¯†æ•°æ®ï¼Œåªæœ‰ç§é’¥èƒ½è§£å¯†ã€‚ç§é’¥åŠ å¯†æ•°æ®ï¼Œåªæœ‰å…¬é’¥èƒ½è§£å¯†ã€‚ å› ä¸ºåŠ è§£å¯†ä½¿ç”¨ä¸åŒå¯†é’¥ï¼Œå…¬é’¥å°±å¯ä»¥é€šè¿‡ä¸å®‰å…¨çš„ä¿¡é“ä¼ è¾“ï¼Œè§£å†³äº†å¯†é’¥ä¼ è¾“éš¾é¢˜ã€‚ä½†æ˜¯ï¼Œéå¯¹ç§°åŠ å¯†æ€§èƒ½æ¯”å¯¹ç§°åŠ å¯†ä½å‡ ä¸ªæ•°é‡çº§ã€‚ ç›®å‰åœ¨åŠ å¯†æ–¹é¢ï¼Œç°åœ¨ä¸€ç‰ˆæœ¬ä¼šç»“åˆå¯¹ç§°ä¸éå¯¹ç§°åŠ å¯†çš„ä¼˜ç‚¹ï¼šç”¨éå¯¹ç§°åŠ å¯†ä¼ è¾“å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œç„¶åé‡‡ç”¨å¯¹ç§°åŠ å¯†æ¥è¿›è¡Œé€šä¿¡ã€‚ å› ä¸ºéå¯¹ç§°åŠ å¯†çš„åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥æä¾›ä¸¤ç§åŠŸèƒ½ï¼š å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯† - è¿™å°±æ˜¯åŠ å¯†ã€‚A å°†å…¬é’¥ä¼ è¾“ç»™ Bï¼ŒB ä½¿ç”¨å…¬é’¥åŠ å¯†æ•°æ®ä¼ è¾“ç»™ Aï¼ŒA ä½¿ç”¨ç§é’¥è§£å¯†ã€‚æ•´ä¸ªè¿‡ç¨‹æ˜¯å³ä½¿å…¬é’¥æˆ–è€…åŠ å¯†æ•°æ®æ³„æ¼ï¼Œé€šä¿¡è¿˜æ˜¯å®‰å…¨çš„ã€‚ ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯† - è¿™å°±æ˜¯ç­¾åã€‚å› ä¸ºç§é’¥åŠ å¯†åï¼Œåªæœ‰å…¬é’¥å¯ä»¥è§£å¯†ï¼Œé‚£ä¹ˆå…¬é’¥æŒæœ‰è€…å°±å¯ä»¥é€šè¿‡è§£å¯†æ¥éªŒè¯ç§é’¥æ˜¯å¦æ­£ç¡®ã€‚ ç­¾åsignature å°±æ˜¯ç±»ä¼¼äºå®¢æˆ·ç«¯é€šè¿‡è¯ä¹¦é‡Œçš„å…¬é’¥ï¼Œæ¥æ£€æŸ¥æœåŠ¡ç«¯çš„ç§é’¥æ˜¯å¦æ­£ç¡®ã€‚ ","date":"2021-10-23","objectID":"/posts/security/authentication/:1:1","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["Security"],"content":"1.2 æ•°å­—è¯ä¹¦ å‰é¢çœ‹åˆ°ï¼Œâ€œç­¾åâ€ çš„æ–¹æ³•æ˜¯è®©å…¬é’¥æŒæœ‰è€…éªŒè¯ç§é’¥æŒæœ‰è€…çš„èº«ä»½ï¼Œè€Œå…³é”®å°±åœ¨äºå…¬é’¥æŒæœ‰è€…ä¿å­˜çš„å…¬é’¥æ˜¯å¦æ˜¯å—ä¿¡ä»»çš„ã€‚ å†…éƒ¨æœåŠ¡ï¼Œå…¬é’¥å¯ä»¥æ¥è‡ªäºè‡ªç­¾åï¼Œé‚£ä¹ˆå…¬é’¥è‚¯å®šæ˜¯å—ä¿¡ä»»çš„ï¼Œå› ä¸ºæ˜¯å¼€å‘è€…è‡ªè¡Œä¿å­˜çš„ã€‚ å…¬å…±æœåŠ¡ï¼Œå…¬é’¥éœ€è¦ä¸€ä¸ªæƒå¨çš„å…¬è¯äººè¿›è¡Œä¸€æ¬¡ç­¾åï¼Œä¾‹å¦‚è¯ä¹¦æœºåˆ¶ä¸­çš„ CA å­˜åœ¨ã€‚æ‰€æœ‰çš„ç”¨æˆ·éƒ½ä¿¡ä»»å…¬è¯äººï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºå…¬è¯äººç­¾ååçš„å…¬é’¥æ˜¯å¯ä»¥ä¿¡ä»»çš„ã€‚ ç¬¬äºŒç§æ–¹å¼å¼•å‡ºäº†å…¬é’¥å¯ä¿¡åˆ†å‘çš„æ ‡å‡†ï¼Œç§°ä¸º å…¬å¼€å¯†é’¥åŸºç¡€è®¾ç½®Public Key Infrastructureï¼Œç®€ç§° PKIã€‚å…¶ä¸­ï¼Œæ•°å­—è¯ä¹¦è®¤è¯ä¸­å¿ƒ CA å°±æ˜¯æƒå¨çš„æœºæ„ï¼Œå¯ä»¥ç­¾å‘è¯ä¹¦ã€‚ è¯ä¹¦Certificate æ˜¯æƒå¨ CA å¯¹ç‰¹å®šå…¬é’¥çš„ç­¾åè¯ä¹¦ï¼Œå¯ä»¥ç†è§£ CA å°†æŸä¸ªå…¬é’¥ä½¿ç”¨äº† CA çš„ç§é’¥è¿›è¡ŒåŠ å¯†ã€‚ åœ¨è®¤è¯æ—¶ï¼Œç”¨æˆ·ä½¿ç”¨å†…ç½®åœ¨æœºå™¨çš„æ ¹è¯ä¹¦å¯¹è¯ä¹¦è¿›è¡Œè®¤è¯ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä½¿ç”¨æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥è§£å¯†è¯ä¹¦ã€‚è®¤è¯ï¼ˆè§£å¯†ï¼‰åï¼Œå°±å¯ä»¥è®¤ä¸ºè¯ä¹¦æ˜¯åˆæ³•çš„äº†ï¼Œè€Œåç»­å°±å¯ä»¥ä½¿ç”¨è¯ä¹¦ä¸­çš„å…¬é’¥è¿›è¡Œé€šä¿¡äº†ã€‚ Note å¯ä»¥çœ‹åˆ°ï¼Œè¯ä¹¦å°±æ˜¯ CA å¯¹å…¬é’¥ç­¾åï¼Œè€Œ CA çš„è¯ä¹¦ï¼ˆå…¬é’¥ï¼‰å†…ç½®åœ¨ç”¨æˆ·æœºå™¨ä¸Šã€‚ PKI ä¸­çš„è¯ä¹¦æ ¼å¼æ˜¯ X.509 æ ¼å¼ï¼Œé™¤äº†å…¬é’¥å†…å®¹å¤–è¿˜åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯ï¼š ç‰ˆæœ¬å· Version - è¯ä¹¦ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ X.509 æ ‡å‡†ï¼Œç›®å‰ç‰ˆæœ¬ä¸º 3ã€‚ Version: 3 (0x2) åºåˆ—å· Serial Number - ç»™è¯ä¹¦åˆ†é…çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ Serial Number: 04:00:00:00:00:01:15:4b:5a:c3:94 ç­¾åç®—æ³•æ ‡è¯†ç¬¦ Signature Algorithm ID - ç­¾åè¯ä¹¦ç®—æ³•æ ‡è¯†ï¼ŒåŒ…å«éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸æ‘˜è¦ç®—æ³•ã€‚ Signature Algorithm: sha1WithRSAEncryption è®¤è¯æœºæ„çš„æ•°å­—ç­¾å Certificate Signature - è¯ä¹¦é¢å‘è€…ä½¿ç”¨ç§é’¥å¯¹è¯ä¹¦çš„ç­¾åã€‚ è®¤è¯æœºæ„ Issuer Name - è¯ä¹¦é¢å‘è€…çš„åå­—ã€‚ Issuer: C=BE, O=GlobalSign nv-sa, CN=GlobalSign Organization Validation CA - SHA256 - G2 æœ‰æ•ˆæœŸé™ Validity Period - è¯ä¹¦èµ·å§‹æ—¥æœŸå’Œæ—¶é—´ï¼Œä»¥åŠç»ˆæ­¢æ—¥æœŸå’Œæ—¶é—´ã€‚ Validity Not Before: Nov 21 08:00:00 2020 GMT Not After : Nov 22 07:59:59 2021 GMT ä¸»é¢˜ä¿¡æ¯ Subject - è¯ä¹¦æŒæœ‰äººçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ Subject: C=CN, ST=GuangDong, L=Zhuhai, O=Awosome-Fenix, CN=*.icyfenix.cn å…¬é’¥ä¿¡æ¯ Public Key - è¯ä¹¦æŒæœ‰è€…çš„å…¬é’¥ï¼Œç®—æ³•æ ‡è¯†ç¬¦å’Œå…¶ä»–å¯†é’¥å‚æ•°ã€‚ ","date":"2021-10-23","objectID":"/posts/security/authentication/:1:2","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["Security"],"content":"2 HTTP è®¤è¯ RFC 7235 ä¸­å®šä¹‰äº† HTTP åè®®çš„é€šç”¨è®¤è¯æ¡†æ¶ï¼šåœ¨æœªæˆæƒç”¨æˆ·è®¿é—®ä¿æŠ¤åŒºåŸŸçš„èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨åº”è¿”å› 401 Unauthorized çš„çŠ¶æ€ç ï¼ŒåŒæ—¶åœ¨å›å¤ Header ä¸­é™„å¸¦ä»¥ä¸‹ä¸¤ä¸ª Header ä¹‹ä¸€ï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯é‡‡å–ä½•ç§æ–¹å¼è¿›è¡Œè®¤è¯ã€‚ WWW-Authenticate: \u003cè®¤è¯æ–¹æ¡ˆ\u003e realm=\u003cä¿æŠ¤åŒºåŸŸæè¿°ä¿¡æ¯\u003e Proxy-Authenticate: \u003cè®¤è¯æ–¹æ¡ˆ\u003e realm=\u003cä¿æŠ¤åŒºåŸŸæè¿°ä¿¡æ¯\u003e å®¢æˆ·ç«¯æ”¶åˆ°å›å¤åï¼Œéµå¾ªæœåŠ¡å™¨æŒ‡å®šçš„è®¤è¯æ–¹æ¡ˆï¼Œåœ¨è¯·æ±‚çš„ Header ä¸­åŠ å…¥èº«ä»½å‡­è¯ä¿¡æ¯ã€‚æœåŠ¡ç«¯éªŒè¯é€šè¿‡åè¿”å›èµ„æºï¼Œå¦åˆ™å°†è¿”å› 403 Forbidden é”™è¯¯ã€‚è¯·æ±‚ Header ä¸­åŒ…å«ä»¥ä¸‹ Header ä¹‹ä¸€ï¼š Authorization: \u003cè®¤è¯æ–¹æ¡ˆ\u003e \u003cå‡­è¯å†…å®¹\u003e Proxy-Authorization: \u003cè®¤è¯æ–¹æ¡ˆ\u003e \u003cå‡­è¯å†…å®¹\u003e ä»¥ç®€å•çš„å®¶æœ‰è·¯ç”±å™¨ä¸ºä¾‹ï¼Œç™»é™†è·¯ç”±å™¨æ—¶ï¼Œæµè§ˆå™¨ä¼šæ”¶åˆ°æœåŠ¡ç«¯åŸºäº HTTP Basic è®¤è¯çš„å›å¤ï¼š HTTP/1.1 401 Unauthorized Date: Mon, 24 Feb 2020 16:50:53 GMT WWW-Authenticate: Basic realm=\"example from icyfenix.cn\" æ¥ç€æµè§ˆå™¨ä¼šå¼¹å‡º HTTP Basic è®¤è¯å¯¹è¯æ¡†ï¼Œè¦æ±‚ç”¨æˆ·è¾“å…¥è´¦æˆ·ä¸å¯†ç ã€‚ç”¨æˆ·è¾“å…¥åï¼Œæµè§ˆå™¨å°†ä¿¡æ¯ç¼–ç ç„¶åå‘é€ç»™æœåŠ¡ç«¯ï¼š GET /admin HTTP/1.1 Authorization: Basic aWN5ZmVuaXg6MTIzNDU2 æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åï¼Œæ£€æŸ¥ç”¨æˆ·è´¦æˆ·å¯†ç æ˜¯å¦æ­£ç¡®ã€‚ é™¤äº† Basic è®¤è¯å¤–ï¼Œè¿˜å®šä¹‰äº†è®¸å¤šç”¨äºå®é™…ç”Ÿäº§ç¯å¢ƒçš„è®¤è¯æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼š Digest - RFC 7616ï¼ŒHTTP æ‘˜è¦è®¤è¯ï¼Œè§†ä¸º Basic è®¤è¯çš„æ”¹è‰¯ç‰ˆæœ¬ã€‚ Bearer - RFC 6750ï¼ŒåŸºäº OAuth2 æ¥å®Œæˆè®¤è¯ã€‚ HOBA - RFC 7486ï¼Œä¸€ç§åŸºäºè‡ªç­¾åè¯ä¹¦çš„è®¤è¯æ–¹æ¡ˆã€‚ HTTP è®¤è¯æ¡†æ¶æä¾›äº†åŸºæœ¬çš„æ¡†æ¶ï¼Œå…è®¸è‡ªè¡Œæ‰©å±•ï¼Œå¹¶ä¸è¦æ±‚ä½¿ç”¨ RFC è§„èŒƒæ¥å®šä¹‰ï¼Œåªè¦å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯èƒ½å¤Ÿè¯†åˆ«å¹¶å¤„ç†ç§æœ‰çš„è®¤è¯æ–¹æ¡ˆå³å¯ã€‚ ","date":"2021-10-23","objectID":"/posts/security/authentication/:2:0","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["Security"],"content":"3 Web è®¤è¯ å¯¹äºéæµè§ˆå™¨çš„ç”¨æˆ·è®¤è¯åœºæ™¯ä¸­ï¼Œé€šå¸¸æ˜¯å¸Œæœ›åç«¯ç³»ç»Ÿæ¥å®ç°è®¤è¯æ–¹å¼ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ HTTP åè®®çš„è®¤è¯æ–¹æ¡ˆã€‚è¿™äº›ä¾é å†…å®¹è€Œä¸æ˜¯ä¼ è¾“åè®®æ¥å®ç°çš„è®¤è¯æ–¹å¼ï¼Œç»Ÿç§°ä¸º â€œWeb è®¤è¯â€ã€‚ Web è®¤è¯æ²¡æœ‰ä»€ä¹ˆæ ‡å‡†ï¼Œç›´åˆ° 2019 å¹´ 3 æœˆï¼ŒWebAuthn å‡ºç°ã€‚WebAuthn ä¸é‡‡ç”¨ä¼ ç»Ÿçš„å¯†ç ç™»é™†ï¼Œè€Œæ˜¯ç›´æ¥é‡‡ç”¨ç”Ÿç‰©è¯†åˆ«ï¼ˆæŒ‡çº¹ã€äººè„¸ã€è™¹è†œã€å£°çº¹ï¼‰æˆ–è€…å®ä½“å¯†é’¥ï¼ˆUSBã€è“ç‰™ã€NFC è¿æ¥çš„ç‰©ç†å¯†é’¥å®¹å™¨ï¼‰ä½œä¸ºèº«ä»½å‡­è¯ã€‚ ","date":"2021-10-23","objectID":"/posts/security/authentication/:3:0","tags":["security"],"title":"è®¤è¯ Authentication","uri":"/posts/security/authentication/"},{"categories":["ç½‘ç»œ"],"content":"å®¢æˆ·ç«¯ç¼“å­˜ï¼ŒCDNï¼ŒæœåŠ¡ç«¯ç¼“å­˜","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":" æ–‡ç« å†…å®¹æ¥è‡ªäºã€Šå‡¤å‡°æ¶æ„ã€‹ï¼Œæ¨èé˜…è¯»ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:0:0","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"1 HTTP å®¢æˆ·ç«¯ç¼“å­˜ HTTP è®¾è®¡ä¹‹åˆå°±æ˜¯ç¡®å®šå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ â€œæ— çŠ¶æ€â€ çš„äº¤äº’åŸåˆ™ï¼Œæ‰€ä»¥ä¸å¯é¿å…åœ°å¯¼è‡´æºå¸¦é‡å¤æ•°æ®å¯¼è‡´ç½‘ç»œæ€§èƒ½é™ä½ã€‚å¯¹æ­¤ï¼ŒHTTP åè®®çš„è§£å†³æ–¹æ¡ˆæ˜¯å®¢æˆ·ç«¯ç¼“å­˜ã€‚ åœ¨ HTTP çš„æ¼”è¿›ä¸­ï¼Œå½¢æˆäº† â€œçŠ¶æ€ç¼“å­˜â€ â€œå¼ºåˆ¶ç¼“å­˜â€ â€œåå•†ç¼“å­˜â€ çš„æœºåˆ¶ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:1:0","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"1.1 çŠ¶æ€ç¼“å­˜ çŠ¶æ€ç¼“å­˜ æ˜¯æŒ‡ä¸é€šè¿‡æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯ç›´æ¥æ ¹æ®ç¼“å­˜çš„ä¿¡æ¯å¯¹ç›®æ ‡ç½‘ç«™åˆ¤æ–­ã€‚HTTP 301 æ°¸ä¹…é‡å®šå‘ å°±æ˜¯çŠ¶æ€ç¼“å­˜ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:1:1","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"1.2 å¼ºåˆ¶ç¼“å­˜ å¼ºåˆ¶ç¼“å­˜ çš„åŸºæœ¬åŸç†å¾ˆç›´æ¥ï¼šä¸€å®šæ—¶é—´å†…ï¼Œè¯·æ±‚çš„èµ„æºå†…å®¹å’ŒçŠ¶æ€ä¸ä¸€å®šä¼šæ”¹å˜ï¼Œå› æ­¤å®¢æˆ·ç«¯å¯ä»¥æ— éœ€å‘é€è¯·æ±‚ï¼Œåœ¨æ—¶é—´å†…ä¸€ç›´æŒæœ‰å’Œä½¿ç”¨è¯¥èµ„æºçš„æœ¬åœ°ç¼“å­˜ã€‚ æ ¹æ®çº¦å®šï¼Œå¼ºåˆ¶ç¼“å­˜åœ¨æµè§ˆå™¨çš„åœ°å€è¾“å…¥ã€é¡µé¢é“¾æ¥è·³è½¬ã€æ–°å¼€çª—å£ã€å‰è¿›å’Œåé€€ä¸­å‡å¯ä»¥ç”Ÿæ•ˆã€‚ä½†æ˜¯ï¼Œç”¨æˆ·ä¸»åŠ¨åˆ·æ–°é¡µé¢æ—¶åº”å½“å¤±æ•ˆã€‚ HTTP åè®®æœ‰ä¸¤ç±» Header å®ç°äº†å¼ºåˆ¶ç¼“å­˜æœºåˆ¶ï¼šExpiresã€Cache-Controlã€‚ 1.2.1 Expires Expires çš„å€¼ä¸ºä¸€ä¸ª Deadlineï¼Œè¡¨ç¤ºï¼šå½“æœåŠ¡å™¨å›å¤æ—¶å¸¦æœ‰è¯¥ Headerï¼Œæ„å‘³ç€æœåŠ¡å™¨æ‰¿è¯ºè¯¥èµ„æºåœ¨ Deadline ä¹‹é—´ä¸ä¼šå‘ç”Ÿå˜åŠ¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ç¼“å­˜å¹¶ä½¿ç”¨è¯¥å›å¤ã€‚ HTTP/1.1 200 OK Expires: Web, 8 Apr 2020 07:28:00 GMT Expires æ˜¯æœ€åˆçš„ HTTP ç¼“å­˜æœºåˆ¶ï¼Œå…¶è®¾è®¡éå¸¸ç®€å•ï¼Œä½†æ˜¯æ— æ³•å¤„ç†ç¼“å­˜æå‰å¤±æ•ˆç­‰é—®é¢˜ã€‚ 1.2.2 Cache-Control Cache-Control è¯­ä¹‰æ¯” Expires æ›´åŠ ä¸°å¯Œï¼Œä¸¤è€…åŒæ—¶å­˜åœ¨æ—¶ï¼Œè§„å®šå¿…é¡»ä»¥ Cache-Control ä¸ºå‡†ã€‚ HTTP/1.1 200 OK Cache-Control: max-age=60 Cache-Control åœ¨å®¢æˆ·ç«¯è¯·æ±‚ Header æˆ–è€…æœåŠ¡ç«¯å›å¤ Header ä¸­éƒ½å¯ä»¥å­˜åœ¨ï¼Œå…¶å€¼å¯ä»¥ä¸ºä¸€ç³»åˆ—å‚æ•°ï¼š max-age å’Œ s-maxage max-age=\u003cn\u003e - ç›¸å¯¹äºè¯·æ±‚æ—¶é—´ n ç§’å†…ï¼Œç¼“å­˜æ˜¯æœ‰æ•ˆçš„ã€‚ s-maxage=\u003cn\u003e - â€œå…±äº«â€ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´ï¼Œå³å…è®¸è¢« CDNã€ä»£ç†ç­‰æŒæœ‰çš„ç¼“å­˜æ—¶é—´ï¼Œç”±äºæç¤º CDN è¿™ç±»æœåŠ¡å™¨ç¼“å­˜çš„æœ‰æ•ˆäº‹ä»¶ã€‚ public å’Œ private æŒ‡æ˜èµ„æºæ˜¯å¦è®¾è®¡ç”¨æˆ·ç§æœ‰èµ„æºã€‚å¦‚æœæ˜¯ publicï¼Œå¯ä»¥è¢«ä»£ç†ã€CDN ç­‰ç¼“å­˜èµ„æºï¼›å¦‚æœæ˜¯ privateï¼Œåªèƒ½æœ‰ç”¨æˆ·å®¢æˆ·ç«¯è¿›è¡Œç¼“å­˜ã€‚ no-cache å’Œ no-store no-cache æŒ‡è¯¥èµ„æºä¸åº”è¯¥è¢«ç¼“å­˜ï¼Œå¼ºåˆ¶ä¼šè¯ç›¸åŒ URL èµ„æºä¹Ÿå¿…é¡»è¯·æ±‚è·å–ï¼Œä»¤å¼ºåˆ¶ç¼“å­˜å®Œå…¨å¤±æ•ˆï¼Œä½†ä¸å½±å“åå•†ç¼“å­˜ã€‚ no-store ä¸å¼ºåˆ¶ä¼šè¯ä¸­ç›¸åŒ URL èµ„æºé‡å¤è·å–ï¼Œä½†æ˜¯ç¦æ­¢æµè§ˆå™¨ã€CDN ç­‰ç¼“å­˜èµ„æºã€‚ no-transform ç¦æ­¢ä»¥ä»»ä½•å½¢å¼ä¿®æ”¹èµ„æºï¼Œä¸å…è®¸å¯¹ Content-Encodingã€Content-Rangeã€Content-Type ä»»ä½•å½¢å¼çš„ä¿®æ”¹ã€‚ä¾‹å¦‚ï¼Œç¦æ­¢ CDNã€ä»£ç†è‡ªåŠ¨å‹ç¼©å›¾ç‰‡æˆ–æ–‡æœ¬ã€‚ min-fresh å’Œ only-if-cached min-fresh=\u003cn\u003e - å»ºè®®æœåŠ¡å™¨è¿”å›ä¸€ä¸ªä¸å°‘äº n ç§’çš„ç¼“å­˜èµ„æºã€‚ only-if-cached è¡¨ç¤ºæœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯å¿…é¡»ä½¿ç”¨ç¼“å­˜èµ„æºï¼Œå¦‚æœç¼“å­˜ä¸èƒ½åå­—ï¼Œåˆ™è¿”å› 503/Service Unvailable é”™è¯¯ã€‚ must-revalidate å’Œ proxy-revalidate must-revalidate è¡¨ç¤ºç¼“å­˜èµ„æºè¿‡æœŸåï¼Œä¸€å®šè¦ä»æœåŠ¡å™¨è·å–ã€‚ proxy-revalidate ä¸ must-revalidate è¯­ä¹‰ç›¸åŒï¼Œä¸“ç”¨äºæç¤º CDNã€ä»£ç†ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:1:2","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"1.3 åå•†ç¼“å­˜ å¼ºåˆ¶ç¼“å­˜æ˜¯åŸºäºæ—¶æ•ˆæ€§ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åå•†å¥½ç¼“å­˜çš„æ—¶é—´ï¼Œä¸éœ€è¦è¿›è¡Œæ£€æŸ¥åˆ¤æ–­ç¼“å­˜æ˜¯å¦å¤±æ•ˆã€‚åå•†ç¼“å­˜ æ˜¯åŸºäºæ£€æŸ¥çš„ç¼“å­˜æœºåˆ¶ï¼Œæ¯æ¬¡è¯·æ±‚ä¼šæ£€æŸ¥ç¼“å­˜æ˜¯å¦å¤±æ•ˆï¼Œä»è€Œå†³å®šæ˜¯ä½¿ç”¨ç¼“å­˜èµ„æºè¿˜æ˜¯è¿›è¡Œè¯·æ±‚ã€‚ å¼ºåˆ¶ç¼“å­˜ä¸åå•†ç¼“å­˜ä¸æ˜¯äº’æ–¥çš„ å¼ºåˆ¶ç¼“å­˜ä¸åå•†ç¼“å­˜ä¸æ˜¯äº’æ–¥çš„ï¼Œä¾‹å¦‚å½“å¼ºåˆ¶ç¼“å­˜æ—¶é—´èŒƒå›´å†…ï¼Œç›´æ¥è¿”å›èµ„æºä¸æ£€æŸ¥ï¼›å½“å¼ºåˆ¶ç¼“å­˜å¤±æ•ˆï¼Œæˆ–è€…è¢«ç¦æ­¢ï¼ˆno-cache/no-storeï¼‰æ—¶ï¼Œä½¿ç”¨åå•†ç¼“å­˜ï¼Œå…ˆæ£€æŸ¥åå†³å®šã€‚ åå•†ç¼“å­˜æ£€æŸ¥å˜åŠ¨å­˜åœ¨ä¸¤ç§æ–¹å¼ï¼š åŸºäºèµ„æºçš„ä¿®æ”¹æ—¶é—´ åŸºäºèµ„æºçš„å”¯ä¸€æ ‡è¯† æ ¹æ®çº¦å®šï¼Œåå•†ç¼“å­˜ä¸ä»…ä»…åœ¨å¼ºåˆ¶ç¼“å­˜çš„åœºæ™¯ä¸­æœ‰æ•ˆï¼Œåœ¨ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰æ—¶ä¹Ÿæœ‰æ•ˆï¼Œåªæœ‰ç”¨æˆ·å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+F5ï¼‰æˆ–æ˜ç¡®ç¦ç”¨æ—¶æ‰å¤±æ•ˆã€‚ 1.3.1 Last-Modified å’Œ If-Modified-Since Last-Modified æ˜¯æœåŠ¡å™¨å›å¤çš„ Headerï¼Œç”¨æˆ·å‘ŠçŸ¥å®¢æˆ·ç«¯èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ã€‚å½“å®¢æˆ·ç«¯å†æ¬¡éœ€è¦è¯·æ±‚è¯¥èµ„æºæ—¶ï¼Œé€šè¿‡ If-Modified-Since æŠŠæ”¶åˆ°çš„æœ€åä¿®æ”¹æ—¶é—´å‘é€ç»™æœåŠ¡å™¨ã€‚ æœåŠ¡å™¨æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œå‘ç°èµ„æºæ²¡æœ‰ä¿®æ”¹è¿‡ï¼Œé‚£ä¹ˆè¿”å› 304/Not Modified å›å¤ï¼Œæ— é¡»åŒ…å«èµ„æºå†…å®¹ï¼Œè¡¨ç¤ºè®©å®¢æˆ·ç«¯ä½¿ç”¨ç¼“å­˜èµ„æºã€‚ HTTP/1.1 304 Not Modified Cache-Control: public, max-age=600 Last-Modified: Wed, 8 Apr 2020 15:31:30 GMT æœåŠ¡å™¨æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œå‘ç°èµ„æºå˜åŠ¨åï¼Œé‚£ä¹ˆè¿”å› 200/OK å›å¤ï¼Œå¹¶ä¸”åŒ…å«å®Œæ•´çš„èµ„æºå†…å®¹ã€‚ HTTP/1.1 200 OK Cache-Control: public, max-age=600 Last-Modified: Wed, 8 Apr 2020 15:31:30 GMT Content 1.3.2 ETag å’Œ If-None-Match Etag æ˜¯æœåŠ¡å™¨å›å¤çš„ Headerï¼Œå‘Šè¯‰å®¢æˆ·ç«¯è¯¥èµ„æºçš„å”¯ä¸€æ ‡è¯†ã€‚å½“å®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚è¯¥èµ„æºæ—¶ï¼Œä¼šé€šè¿‡ If-None-Match æŠŠæ”¶åˆ°çš„å”¯ä¸€æ ‡è¯†å‘é€å›æœåŠ¡ç«¯ã€‚ æœåŠ¡å™¨æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œå‘ç°èµ„æºçš„å”¯ä¸€æ ‡è¯†ä¸è¯·æ±‚ä¸­çš„ä¸€è‡´ï¼Œé‚£ä¹ˆè¿”å› 304/Not Modified å›å¤ï¼Œæ— é¡»åŒ…å«èµ„æºå†…å®¹ï¼Œè¡¨ç¤ºè®©å®¢æˆ·ç«¯ä½¿ç”¨ç¼“å­˜èµ„æºã€‚ HTTP/1.1 304 Not Modified Cache-Control: public, max-age=600 ETag: \"28c3f612-ceb0-4ddc-ae35-791ca840c5fa\" æœåŠ¡å™¨æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œå‘ç°èµ„æºå”¯ä¸€æ ‡è¯†æœ‰å˜åŠ¨ï¼Œå°±è¿”å› 200/OK ä¸å®Œæˆèµ„æºå†…å®¹ã€‚ HTTP/1.1 200 OK Cache-Control: public, max-age=600 ETag: \"28c3f612-ceb0-4ddc-ae35-791ca840c5fa\" Content å¯ä»¥çœ‹åˆ°ï¼ŒETag é€šè¿‡åˆ¤æ–­èµ„æºå”¯ä¸€è¡¨ç¤ºæ¥åˆ¤æ–­èµ„æºæ˜¯å¦å˜åŠ¨è¿‡ï¼Œå…¶ä¸€è‡´æ€§æ¯” Last-Modified æ›´é«˜ï¼ˆå¯èƒ½èµ„æºä¿®æ”¹è¿‡ä½†æ˜¯å†…å®¹æ¯å‘ç”Ÿå˜åŒ–ï¼Œè¿™æ · Last-Modified å…¶å®æ˜¯å¤±æ•ˆçš„ï¼‰ã€‚ ä½†æ˜¯ï¼Œå› ä¸ºæ¯æ¬¡éœ€è¦è®¡ç®—èµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼Œå› æ­¤å…¶æ€§èƒ½ä¹Ÿæ˜¯æœ€å·®çš„ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:1:3","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"1.4 å¤šç‰ˆæœ¬èµ„æºç¼“å­˜ å‰é¢æ‰€è¯´çš„éƒ½æ˜¯é’ˆå¯¹äº â€œå•ä¸ªèµ„æºâ€ çš„ç¼“å­˜ï¼Œä½†æ˜¯ä¸€ä¸ª URL å¯èƒ½å¯¹åº”ç€ä¸åŒç‰ˆæœ¬çš„èµ„æºã€‚ä¾‹å¦‚èµ„æºçš„ä¸åŒè¯­è¨€ç‰ˆæœ¬ï¼Œä¸åŒçš„ç¼–ç æ–¹å¼ï¼ˆContent-Typeï¼‰ç­‰ã€‚ å¯¹äºä¸€ä¸ª URL èƒ½å¤Ÿè·å–å¤šä¸ªèµ„æºçš„åœºæ™¯ï¼Œç¼“å­˜ä¹Ÿéœ€è¦æ˜ç¡®çš„è¡¨ç¤ºæ ¹æ®ä»€ä¹ˆå†…å®¹æ¥ç¼“å­˜èµ„æºï¼Œä½¿ç”¨ Vary Headerã€‚ HTTP/1.1 200 OK Vary: Accept, User-Agent ä»¥ä¸Šå›å¤å°±æ˜¯å‘ŠçŸ¥å®¢æˆ·ç«¯ï¼Œæ ¹æ® Accept ä¸ User-Agent æ¥ç¼“å­˜èµ„æºï¼Œä¸åŒ Accept å’Œ User-Agent çš„ç»„åˆç¼“å­˜ä¸åŒçš„èµ„æºã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:1:4","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"2 CDN å†…å®¹åˆ†å‘ç½‘ç»œï¼ˆContent Distribution Networkï¼ŒCDNï¼‰æ˜¯å°†å®¢æˆ·ç«¯ç¼“å­˜ã€åŸŸåè§£æç­‰ç»¼åˆè¿ç”¨çš„æ–¹å¼ã€‚CDN çš„å·¥ä½œè¿‡ç¨‹ï¼Œä¸»è¦æ¶‰åŠåˆ°è·¯ç”±è§£æã€å†…å®¹åˆ†å‘ã€è´Ÿè½½å‡è¡¡å’Œ CDN åº”ç”¨å››ä¸ªæ–¹é¢ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:2:0","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"2.1 è·¯ç”±è§£æ CDN å°†ç”¨æˆ·å¯¹æŸä¸ªåŸŸåçš„è¯·æ±‚è§£æåˆ° CDN çš„æœåŠ¡å™¨ä¸Šå¤„ç†ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¾é  DNS æœåŠ¡å™¨å®ç°çš„ã€‚ å°†ä½ çš„åŸŸåï¼ˆicyfenix.cnï¼‰åœ¨ CDN æœåŠ¡å™¨ä¸Šæ³¨å†Œä¸º â€œæºç«™â€ï¼Œæ³¨å†Œåå°±å¾—åˆ°äº†ä¸€ä¸ª CNAMEï¼ˆicyfenix.cn.cdn.dnsv1.comï¼‰ã€‚ å¤„ç†ä½ çš„åŸŸåçš„ DNS æœåŠ¡å•†ä¸Šä¸ªå°†å¾—åˆ°çš„ CNAME æ³¨å†Œä¸ºä¸€æ¡ CNAME è®°å½•ã€‚ ç”¨æˆ·è®¿é—®æ—¶ï¼ŒDNS æœåŠ¡å•†è§£æå‡º CNAME è¿”å›ç»™æœ¬åœ° DNSã€‚ æœ¬åœ° DNS æŸ¥è¯¢ CNAMEï¼ŒCDN æœåŠ¡å•†çš„ DNS æœåŠ¡å™¨è¿”å›åˆé€‚çš„ CDN æœåŠ¡å™¨ IP åœ°å€ã€‚ ç”¨æˆ·è®¿é—® CDN æœåŠ¡å™¨ã€‚CDN æœåŠ¡å™¨å¦‚æœæ²¡æœ‰ç¼“å­˜è¯·æ±‚çš„èµ„æºï¼Œå°±ä¼šè¯·æ±‚æºç«™ï¼Œå¹¶ç¼“å­˜ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:2:1","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"2.2 å†…å®¹åˆ†å‘ å¯ä»¥çœ‹åˆ°ï¼ŒCDN æœåŠ¡å™¨é€æ˜çš„æ¥ç®¡äº†ç”¨æˆ·å‘å‡ºçš„è®¿é—®èµ„æºï¼Œå¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯ CDN å¦‚ä½•è·å¾—æºç«™çš„èµ„æºã€‚ CDN è·å–æºç«™èµ„æºçš„è¿‡ç¨‹ç§°ä¸º â€œå†…å®¹åˆ†å‘â€ã€‚ä¸»è¦æœ‰ä¸¤ç§åˆ†å‘æ–¹å¼ï¼š ä¸»åŠ¨åˆ†å‘ï¼ˆPushï¼‰- åˆ†å‘ç”±æºç«™ä¸»åŠ¨å‘èµ·ï¼Œå°†å†…å®¹ä»æºç«™æé€åˆ°å„ä¸ª CDN ç¼“å­˜æœåŠ¡å™¨ä¸Šã€‚ ä¸»åŠ¨åˆ†å‘éœ€è¦æºç«™è°ƒç”¨ CDN æœåŠ¡çš„ APIï¼Œå› æ­¤å¯¹äºæºç«™ä¸æ˜¯é€æ˜çš„ã€‚ ä¸»åŠ¨åˆ†å‘ä¸€èˆ¬ç”¨äºç½‘ç«™è¦é¢„è½½å¤§é‡èµ„æºçš„åœºæ™¯ï¼Œä¾‹å¦‚å¤§å‹æ´»åŠ¨å‰ç¼“å­˜ç½‘ç«™çš„èµ„æºã€‚ è¢«åŠ¨å›æºï¼ˆPullï¼‰- è¢«åŠ¨å›æºæŒ‡ï¼Œå½“æŸä¸ªèµ„æºé¦–æ¬¡è¢«è¯·æ±‚æ—¶ï¼ŒCDN æœåŠ¡å™¨æ²¡æœ‰ç¼“å­˜è¯¥èµ„æºï¼Œé‚£ä¹ˆå°±ä¼šç«‹å³ä»æºç«™è·å–ã€‚ è¢«åŠ¨å›æºä¸­ï¼ŒCDN æœåŠ¡å™¨ç›¸å½“äºæ™®é€šç”¨æˆ·ï¼ˆä½†æ˜¯ç½‘ç»œç‰¹åˆ«çš„å¿«ï¼‰è®¿é—®æºç«™ï¼Œå› æ­¤å¯¹äºæºç«™ä¹Ÿæ˜¯é€æ˜çš„ã€‚ åœ¨ CDN æœåŠ¡å™¨ç¼“å­˜æºç«™èµ„æºåï¼Œè¿˜éœ€è¦è€ƒè™‘å¦‚ä½•ç®¡ç†ï¼ˆæ›´æ–°ï¼‰ç¼“å­˜çš„èµ„æºã€‚è¿™ä¸ªé—®é¢˜ç›®å‰æ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†å¯è¨€ï¼Œç›®å‰æœ€å¸¸è§çš„åšæ³•æ˜¯ â€œè¶…æ—¶è¢«åŠ¨å¤±æ•ˆâ€ ä¸ â€œæ‰‹åŠ¨ä¸»åŠ¨å¤±æ•ˆâ€ ç›¸ç»“åˆã€‚ è¶…æ—¶è¢«åŠ¨å¤±æ•ˆ - ç¼“å­˜èµ„æºæœ‰ä¸€å®šçš„è¿‡æœŸæ—¶é—´ï¼Œè¶…è¿‡æ—¶é—´å CDN åœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶é‡æ–°å›æºä¸€æ¬¡ã€‚ æ‰‹å·¥ä¸»åŠ¨å¤±æ•ˆ - CDN æœåŠ¡å•†æä¾›ç¼“å­˜å¤±æ•ˆ/æ›´æ–°æ¥å£ï¼Œç”±æºç«™ä¸»åŠ¨æ›´æ–°ç¼“å­˜èµ„æºã€‚ä¾‹å¦‚ç½‘ç«™å¯ä»¥åœ¨æ›´æ–°æ—¶é€šè¿‡ CD æ¥è‡ªåŠ¨è°ƒç”¨æ¥å£å®ç°ç¼“å­˜æ›´æ–°ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:2:2","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"2.3 CDN çš„åº”ç”¨ CDN æœ€åˆæ˜¯ä¸ºäº†å¿«é€Ÿåˆ†å‘é™æ€èµ„æºè®¾è®¡çš„ï¼Œè€Œç›®å‰ CDN èƒ½å¤Ÿåšæ›´å¤šçš„äº‹ã€‚ åŠ é€Ÿé™æ€èµ„æºåˆ†å‘ å®‰å…¨é˜²å¾¡ï¼šCDN å¯ä»¥çœ‹åšç½‘ç«™çš„å ¡å’æœºï¼Œæºç«™å¯ä»¥åªå¯¹ CDN æä¾›æœåŠ¡ï¼Œç”± CDN ä¸ºå¤–ç•Œç”¨æˆ·æä¾›æœåŠ¡ã€‚è¿™æ ·æ”»å‡»å°±ä¸å®¹æ˜“ç›´æ¥æ”»å‡»æºç«™ã€‚ åè®®å‡çº§ï¼šä¸å°‘ CDN æä¾›å•†å¯¹é˜µ SSL è¯ä¹¦æœåŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æºç«™åŸºäº HTTP åè®®ï¼Œè€Œå¯¹å¤–ç”¨æˆ·æä¾› HTTPS åè®®ã€‚ç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥æºç«™æä¾› HTTP/1.x åè®®ï¼ŒCDN å¯¹å¤–æä¾› HTTP/2 æˆ– HTTP/3 åè®®ç­‰ç­‰ã€‚ çŠ¶æ€ç¼“å­˜ï¼šCDN ä¸ä»…å¯ä»¥ç¼“å­˜ç½‘ç«™èµ„æºï¼Œè¿˜å¯ä»¥ç¼“å­˜æºç«™çš„ HTTP Statusã€‚ä¾‹å¦‚å¯ä»¥é€šè¿‡ CDN ç¼“å­˜æºç«™çš„ 301/302 æ¥è®©å®¢æˆ·ç«¯ç›´æ¥è·³è½¬ã€‚ ä¿®æ”¹èµ„æºï¼šCDN å¯ä»¥åœ¨è¿”å›èµ„æºæ—¶ä¿®æ”¹èµ„æºçš„ä»»æ„å†…å®¹ã€‚ä¾‹å¦‚å¯ä»¥å¯¹èµ„æºè‡ªåŠ¨å‹ç¼©å¹¶ä¿®æ”¹ Content-Encodingï¼Œä»¥èŠ‚çœå¸¦å®½ã€‚ è®¿é—®æ§åˆ¶ï¼šCDN å¯ä»¥å®ç° IP é»‘/ç™½ åå•çš„åŠŸèƒ½ï¼Œæ ¹æ® IP æ¥è¿›è¡Œæµé‡æ§åˆ¶ç­‰ã€‚ æ³¨å…¥åŠŸèƒ½ï¼šé€šè¿‡ä¿®æ”¹è¿”å›èµ„æºçš„å†…å®¹ï¼ŒCDN å¯ä»¥åœ¨ä¸ä¿®æ”¹æºç«™çš„æƒ…å†µä¸‹ï¼Œä¸ºæºç«™æ³¨å…¥å„ç§åŠŸèƒ½ã€‚ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:2:3","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["ç½‘ç»œ"],"content":"3 æœåŠ¡ç«¯ç¼“å­˜ ","date":"2021-10-11","objectID":"/posts/net/cache-mechanism/:3:0","tags":["ç½‘ç»œ"],"title":"Cache æœºåˆ¶","uri":"/posts/net/cache-mechanism/"},{"categories":["Kubernetes å®è·µ"],"content":"è·¨ Kubernetes é›†ç¾¤ç½‘ç»œè¿é€š","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":" Kubernetes å®è·µ ä¸»è¦è®°å½•ä¸€äº›è‡ªå·±çš„ä¸€äº›éƒ¨ç½²å®è·µã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"1 ç›®æ ‡ æœ€è¿‘åœ¨çœ‹ TiDB çš„ Multi Kubernetes é›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆï¼ŒTiDB æœ¬èº«æ˜¯çµæ´»æ‰©å®¹çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå› æ­¤éƒ¨ç½²å‰éœ€è¦ç¡®ä¿ Multi Kubernetes ä¹‹é—´æœåŠ¡çš„è¿é€šæ€§ã€‚ Kubernetes ä¸­ï¼ŒIP æ˜¯è™šæ‹Ÿä»¥åŠä¸æŒä¹…çš„ï¼Œå„ä¸ªæœåŠ¡ä¹‹é—´æ˜¯é  DomainåŸŸå ç›¸äº’è®¿é—®çš„ã€‚å› æ­¤ï¼ŒMulti Kubernetes ä¹‹é—´çš„è¿é€šæ€§å…³é”®å°±åœ¨äºï¼š ç‰©ç†ç½‘ç»œè¿é€š - æ‰€æœ‰æ–¹æ¡ˆæœ€åŸºæœ¬çš„ï¼Œå°±æ˜¯åº•å±‚çš„ç½‘ç»œå¯ä»¥è”é€šã€‚ DNS è§£æ - å› ä¸ºæœåŠ¡ä¹‹é—´é  Domain è®¿é—®ï¼Œå› æ­¤è®¿é—®å¦ä¸€ä¸ªé›†ç¾¤çš„æœåŠ¡æ—¶ï¼ŒDNS è¦èƒ½å¤Ÿè§£æä¸ºå¦ä¸€ä¸ªé›†ç¾¤çš„ Pod IPã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"2 ç‰©ç†ç½‘ç»œè¿é€š Multi Kubernetes ä¹‹é—´ç‰©ç†ç½‘ç»œçš„è¿é€šä¸åŒåœºæ™¯æœ‰ç€ä¸åŒçš„æ–¹æ¡ˆã€‚ ä½¿ç”¨ EKS æ—¶ï¼Œä¸åŒ VPC ä¸‹çš„ EKS é›†ç¾¤éƒ½è¿‡ VPC Peering è¿æ¥ï¼Œå®ç°ç‰©ç†ç½‘ç»œçš„è¿é€šæ€§ã€‚ ä½¿ç”¨ GKE æ—¶ï¼ŒGKE é›†ç¾¤ä¹‹é—´ç½‘ç»œå°±æ˜¯è”é€šçš„ã€‚ å…¶ä»–è‡ªå·±éƒ¨ç½²çš„ Multi Kubernetes é›†ç¾¤ï¼Œå¯èƒ½éœ€è¦ Tunnel æ¥æ„å»ºç‰©ç†ç½‘ç»œã€‚å¯ä»¥å‚è€ƒä¸‹é¡¹ç›® submariner-io/submarinerã€‚ ç‰©ç†ç½‘ç»œè¿é€šçš„æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯ï¼Œä¸€ä¸ª Kubernetes é›†ç¾¤çš„ Podï¼Œæ˜¯èƒ½å¤Ÿ â€œè®¿é—®â€ åˆ°å¦ä¸€ä¸ª Kubernetes é›†ç¾¤çš„ Pod çš„ã€‚ Note æœ€ç†æƒ³çš„ç½‘ç»œäº’é€šï¼Œåº”è¯¥æ˜¯å¤šä¸ª Kubernetes é›†ç¾¤å¤„äºåŒä¸€ä¸ªç½‘ç»œï¼Œä¸è¿‡è¿™åº”è¯¥å°±æ˜¯ä¸€ä¸ª Kubernetes é›†ç¾¤äº†ï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªäº†ã€‚ åœ¨è¿™ä¹‹ä¸‹ï¼Œä¸¤ä¸ª Kubernetes é›†ç¾¤ä¹‹é—´èƒ½å¤Ÿ â€œç›´æ¥â€ï¼ˆä¸éœ€è¦é€šè¿‡ NodePort æ˜ å°„ï¼‰ç›¸äº’è®¿é—®ã€‚å°±åƒä¸¤ä¸ªä¸åŒçš„ç½‘æ®µï¼Œä¸­é—´æœ‰è·¯ç”±å™¨æ¥è¿é€šè¿™ä¸¤ä¸ªç½‘æ®µã€‚ è€Œè¿™ä¸ª â€œè·¯ç”±å™¨â€ æœ‰ç€å¤šç§çš„å®ç°äº†ï¼šä¾‹å¦‚æœ€ç›´æ¥çš„ï¼ŒCluster1 ç½‘ç»œ -\u003e Node1 -\u003e Node2 -\u003e Cluster2 ç½‘ç»œï¼Œä¸­é—´é€šè¿‡ NodePort æ¥è½¬å‘ã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"3 DNS ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"3.1 DNS è§£ææµç¨‹ æ— è®ºæ˜¯ Pod DNS è¿˜æ˜¯ Service DNSï¼Œå…¶è§£æéƒ½ç”± CoreDNS è´Ÿè´£ã€‚æ‰€ä»¥ä¸€ä¸ª Cluster è¦è®¿é—®å¦ä¸€ä¸ª Cluster çš„æœåŠ¡æ—¶ï¼Œå…¶æœŸæœ›çš„æ­¥éª¤ä¸ºï¼š Cluster1 Pod -\u003e Cluster1 CoreDNS Cluster1 Pod å‘é€ DNS è¯·æ±‚åˆ° Cluster1 CoreDNSã€‚ Cluster1 CoreDNS -\u003e Cluster2 CoreDNS Cluster1 CoreDNS åˆ¤æ–­è¯·æ±‚çš„ Domain æ˜¯ Cluster2 çš„ï¼Œå› æ­¤è½¬å‘ç»™ Cluster2 CoreDNS è§£æã€‚ å› ä¸ºç‰©ç†ç½‘ç»œæ˜¯è¿é€šçš„ï¼Œæ‰€ä»¥è½¬å‘æ˜¯å¯ä»¥æˆåŠŸçš„ã€‚ Cluster2 CoreDNS -\u003e Cluster1 CoreDNS Cluster2 CoreDNS æ¥å—åˆ°è¯·æ±‚åï¼Œè§£æ Domainï¼Œå›å¤å¯¹åº” Cluster2 Pod IP ç»™ Cluster1 CoreDNSã€‚ å› ä¸ºç‰©ç†ç½‘ç»œæ˜¯è¿é€šçš„ï¼Œæ‰€ä»¥å›å¤æ˜¯å¯ä»¥æˆåŠŸçš„ã€‚ Cluster1 CoreDNS -\u003e Cluster1 Pod Cluster1 CoreDNS å°†è§£æç»“æœå›å¤ç»™ Cluster1 Podã€‚ Cluster1 Pod -\u003e Cluster2 Pod å› ä¸ºç‰©ç†ç½‘ç»œæ˜¯è¿é€šçš„ï¼Œæ‰€ä»¥è®¿é—®æ˜¯å¯ä»¥æˆåŠŸçš„ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬ CoreDNS èƒ½å¤ŸåŒ…å«æ‰€æœ‰ Cluster çš„è®°å½•ï¼Œé‚£ä¹ˆå¯èƒ½å¯ä»¥åŠ é€Ÿè§£æçš„æµç¨‹ã€‚ç›®å‰ä¸æ¸…æ¥šå¯ä¸å¯ä»¥è¿™æ ·é…ç½®ï¼Œæˆ–è€…æœ‰æ²¡æœ‰è¿™æ ·çš„å®ç°ã€‚ Note æ³¨æ„ï¼Œä¸Šè¿°ä¸­ç›´æ¥è®¿é—®è·¨ Kubernetes è®¿é—® Service æ˜¯å¯èƒ½æ— æ³•è”é€šçš„ï¼ŒçŒœæƒ³ä¸¤ç§æƒ…å†µï¼š Service IP ä¸ Pod ç½‘ç»œä¸æ˜¯ä¸€ä¸ªå¹³é¢çš„ï¼Œé‚£ä¹ˆå¦‚æœ Cluster1 Pod å‘å‡ºçš„åŒ…æ— æ³•è¢«è·¯ç”±åˆ° Cluster2 ä¸­ï¼ˆé™¤éé…ç½®å¥½è·¯ç”±è§„åˆ™ï¼Œä¾‹å¦‚ AWS GCP çš„ Routeï¼‰ã€‚ Service IP ä¸ Pod ç½‘ç»œæ˜¯ä¸€ä¸ªå¹³é¢çš„ï¼ŒCluster1 Pod å‘å‡ºçš„æ•°æ®åŒ…èƒ½å¤Ÿè·¯ç”±åˆ° Cluster2 ä¸­ï¼Œç”± Cluster2 ä¸­çš„ kube-proxy æ ¹æ® Service IP æˆåŠŸè½¬å‘äº†ã€‚ æ‰€ä»¥ï¼Œé—®é¢˜çš„å…³é”®è¿˜æ˜¯åœ¨äºæ•°æ®åŒ…èƒ½å¦è·¯ç”±åˆ° Cluster2 ç½‘ç»œä¸­ã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"3.2 é…ç½® CoreDNS åŸºäºä¸Šé¢çš„æµç¨‹ï¼Œæœ‰ä¸¤ä¸ªå…³é”®çš„é—®é¢˜ï¼š å¦‚ä½•åˆ¤æ–­è¯·æ±‚çš„ Domain æ˜¯ Cluster2 çš„ï¼Ÿ å¦‚ä½•é…ç½® CoreDNS è½¬å‘è¯·æ±‚ï¼Ÿ è¿™äº›éƒ½éœ€è¦é€šè¿‡ CoreDNS é…ç½®æ¥å®ç°ï¼Œå…ˆçœ‹å‚è€ƒæ–‡æ¡£ Customizing DNS Service çŸ¥æ™“å¦‚ä½•é…ç½® CoreDNSã€‚ ä» K8s å­¦ä¹  - 2 - Service æˆ‘ä»¬çŸ¥æ™“ï¼ŒKubernetes ä¸­çš„ Domain åˆ†ä¸º Pod ä¸ Serviceã€‚ Pod Domain \u003cpod_ip\u003e.\u003cnamespace\u003e.pod.\u003cclust-domain\u003e \u003cpod_ip\u003e.\u003cdepolyment/daemonset_name\u003e.svc.\u003ccluster_domain\u003e \u003chostname\u003e.\u003csubdomain\u003e.\u003cnamespace\u003e.svc.\u003ccluster_domain\u003e Service Domain \u003cservice\u003e.\u003cnamespace\u003e.svc.\u003ccluster_domain\u003e å› ä¸º DNS è§£ææ˜¯å°† Domain ä»åå‘å‰æŒ‰ç…§åŸŸè§£æçš„ï¼Œæ‰€ä»¥æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ï¼šå°† Multi Kubernetes çš„ Cluster Domain è®¾ç½®ä¸ºä¸åŒçš„ï¼Œç„¶åé…ç½® CoreDNS è½¬å‘ã€‚ apiVersion:v1kind:ConfigMapmetadata:name:corednsnamespace:kube-systemdata:Corefile:|.:53 { # default.. } \u003ctarget-cluster-domain\u003e:53 { # \u003c-- æŒ‡å‘å¯¹ç«¯çš„ Kubernetes Cluster Domain errors cache 30 forward . \u003ctarget-coredns-ip\u003e } é™¤äº†è‡ªå·±é›†ç¾¤çš„åŸŸåè§£æå¤–ï¼Œå¯¹äº â€œ\u003ctarget-cluster-domain\u003eâ€ çš„åŸŸåè§£æéƒ½è½¬å‘ç»™äº†å¯¹åº”é›†ç¾¤çš„ CoreDNSã€‚ æ”¹å˜ Kubernetes é›†ç¾¤çš„ Cluster Domain æ–¹å¼ï¼šéƒ¨ç½² Cluster æ—¶ï¼Œé€šè¿‡ kubelet å‚æ•° -cluster-domain=\u003cdefault-local-domain\u003e é…ç½®ã€‚ ä¸è¿‡ï¼Œæ”¹å˜ Cluster Domain æ–¹å¼éœ€è¦åœ¨éƒ¨ç½² Cluster æ—¶é…ç½®ï¼Œå¦‚æœä½ å·²ç»éƒ¨ç½²äº† Clusterï¼Œè¿™å¯èƒ½å°±ä¸å¤ªæ–¹ä¾¿äº†ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒMulti Kubernetes Cluster Domain éƒ½æ˜¯ â€œcluster.localâ€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ›´å‰é¢çš„åŸŸä¸Šæ¥åŒºåˆ†ï¼Œè‡ªç„¶æ˜¯ â€œ\u003cnamespace\u003e\"ã€‚ ä¾‹å¦‚ï¼Œä½ çš„ Pod è¦è®¿é—®å¦ä¸€ä¸ª Cluster çš„ Podï¼š apiVersion:v1kind:ConfigMapmetadata:name:corednsnamespace:kube-systemdata:Corefile:|.:53 { # default.. } \u003ctarget-namespace\u003e.svc.cluster.local:53 { # \u003c-- æŒ‡å‘å¯¹ç«¯ Kubernetes æœåŠ¡çš„ namespace errors cache 30 forward . \u003ctarget-coredns-ip\u003e } å¯ä»¥æƒ³åˆ°ï¼Œè¿™ç§è®¿é—®åŒ¹é…çš„èŒƒå›´æ›´å°ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä½¿å¾— Multi Cluster ä¹‹é—´çš„ namespace ä¸åº”è¯¥é‡å¤ã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"4 AWS ä¸Šçš„å®è·µ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"4.1 åˆ›å»º EKS é›†ç¾¤ å…ˆå»ºç«‹ä¸¤ä¸ª EKS é›†ç¾¤ï¼Œéœ€è¦æ³¨æ„ä¸¤ä¸ªé›†ç¾¤ VPC CIDR ä¸è¦ä¸è¦†ç›–ã€‚ $ eksctl create cluster --name test-cluster --with-oidc --ssh-access --managed --region us-west-2 --instance-types m5.xlarge --nodes 3 $ eksctl create cluster --name test-cluster-2 --with-oidc --ssh-access --managed --region us-west-2 --instance-types m5.xlarge --nodes 3 --vpc-cidr 10.0.0.0/16 æŸ¥è¯¢ä¸‹ä¸¤ä¸ª EKS é›†ç¾¤ä¿¡æ¯ï¼Œåé¢éœ€è¦ç”¨åˆ°ï¼š $ eksctl get cluster test-cluster NAME VERSION STATUS CREATED VPC SUBNETS SECURITYGROUPS test-cluster 1.20 ACTIVE 2021-09-30T11:53:19Z vpc-0409bd99d5e2b6f5b subnet-00d1a0abdaf60021b,subnet-0a9fca73d25257d90,subnet-0aee90db41909f538,subnet-0c81d647b53fe567a,subnet-0dcd3f3da03b5e767,subnet-0f80939acbdda6357 sg-00985dc11204cfeda $ eksctl get cluster test-cluster-2 NAME VERSION STATUS CREATED VPC SUBNETS SECURITYGROUPS test-cluster-2 1.20 ACTIVE 2021-09-30T12:19:39Z vpc-0e35ec388cb70e7fc subnet-012fa5481e326aafc,subnet-0586d236d85ed6893,subnet-0d5695aa8970fea2d,subnet-0d61b543c82d94d14,subnet-0d740e2366cf2778f,subnet-0def1a48342d72d32 sg-0d914515ffd1173b5 æˆ‘ä»¬åˆ›å»ºäº†åŒ Region ä¸‹ä¸åŒ VPC ä¸¤ä¸ª EKS é›†ç¾¤ï¼Œä¸åŒ Region ä¸‹åç»­æ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ åç»­æ“ä½œä¸­ï¼Œå„ä¸ªèµ„æºçš„ 1ã€2 åˆ†åˆ«ä»£è¡¨å¯¹åº”é›†ç¾¤çš„èµ„æºã€‚k1 ä¸ k2 åˆ†åˆ«ä»£è¡¨å¯¹åº”é›†ç¾¤çš„ kubectl æ“ä½œï¼ˆé€šè¿‡ â€“kubeconfig å‚æ•°ï¼‰ã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"4.2 æ„å»ºç½‘ç»œ EKS ä¸­ Pod æ˜¯ Host Networkï¼Œä¸ Node åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­ã€‚AWS VPC ä¸­å„ä¸ª Subnet ç½‘ç»œæ˜¯äº’é€šçš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æ„å»º VPC ä¹‹é—´çš„ç½‘ç»œäº’é€šã€‚ éœ€è¦åˆ›å»ºä¸é…ç½®ä»¥ä¸‹ AWS èµ„æºï¼š VPC Peering - è¿æ¥ VPC ä¹‹é—´çš„ç½‘ç»œ Route Table - èƒ½å¤Ÿå°†æµé‡æ­£ç¡®çš„è½¬å‘åˆ°å¦ä¸€ä¸ª VPC ACL - æµé‡åˆ°è¾¾ Subnet èƒ½å¤Ÿé€šè¿‡ ACL Security Group - æµé‡åˆ°è¾¾æ¯ä¸ª Instance èƒ½å¤Ÿé€šè¿‡ Security Group Note è¦ä½¿ç”¨ VPC Peering è¿é€š VPCï¼Œè¿™äº›èµ„æºéƒ½æ˜¯éœ€è¦é…ç½®çš„ã€‚ 4.2.1 åˆ›å»º VPC Peering Create VPC Peeringï¼Œæ„å»º VPC1 è¿é€š VPC2ã€‚ $ aws ec2 create-vpc-peering-connection \\ --vpc-id vpc-0409bd99d5e2b6f5b \\ --peer-vpc-id vpc-0e35ec388cb70e7fc { \"VpcPeeringConnection\": { \"AccepterVpcInfo\": { \"OwnerId\": \"385595570414\", \"VpcId\": \"vpc-0e35ec388cb70e7fc\", \"Region\": \"us-west-2\" }, \"ExpirationTime\": \"2021-10-07T12:53:36+00:00\", \"RequesterVpcInfo\": { \"CidrBlock\": \"192.168.0.0/16\", \"CidrBlockSet\": [ { \"CidrBlock\": \"192.168.0.0/16\" } ], \"OwnerId\": \"385595570414\", \"PeeringOptions\": { \"AllowDnsResolutionFromRemoteVpc\": false, \"AllowEgressFromLocalClassicLinkToRemoteVpc\": false, \"AllowEgressFromLocalVpcToRemoteClassicLink\": false }, \"VpcId\": \"vpc-0409bd99d5e2b6f5b\", \"Region\": \"us-west-2\" }, \"Status\": { \"Code\": \"pending-acceptance\", \"Message\": \"Pending Acceptance by 385595570414\" }, \"Tags\": [], \"VpcPeeringConnectionId\": \"pcx-094a1149b32ef0c05\" } } Accept VPC Peeringï¼Œå®Œæˆ VPC Peering æ„å»ºã€‚ $ aws ec2 accept-vpc-peering-connection \\ --vpc-peering-connection-id pcx-094a1149b32ef0c05 { \"VpcPeeringConnection\": { \"AccepterVpcInfo\": { \"CidrBlock\": \"10.0.0.0/16\", \"CidrBlockSet\": [ { \"CidrBlock\": \"10.0.0.0/16\" } ], \"OwnerId\": \"385595570414\", \"PeeringOptions\": { \"AllowDnsResolutionFromRemoteVpc\": false, \"AllowEgressFromLocalClassicLinkToRemoteVpc\": false, \"AllowEgressFromLocalVpcToRemoteClassicLink\": false }, \"VpcId\": \"vpc-0e35ec388cb70e7fc\", \"Region\": \"us-west-2\" }, \"RequesterVpcInfo\": { \"CidrBlock\": \"192.168.0.0/16\", \"CidrBlockSet\": [ { \"CidrBlock\": \"192.168.0.0/16\" } ], \"OwnerId\": \"385595570414\", \"PeeringOptions\": { \"AllowDnsResolutionFromRemoteVpc\": false, \"AllowEgressFromLocalClassicLinkToRemoteVpc\": false, \"AllowEgressFromLocalVpcToRemoteClassicLink\": false }, \"VpcId\": \"vpc-0409bd99d5e2b6f5b\", \"Region\": \"us-west-2\" }, \"Status\": { \"Code\": \"provisioning\", \"Message\": \"Provisioning\" }, \"Tags\": [], \"VpcPeeringConnectionId\": \"pcx-094a1149b32ef0c05\" } } 4.2.2 Route Table æ·»åŠ  Route é¡¹ ä¸ºäº† VPC ä¹‹é—´çš„è¿é€šæ€§ï¼Œéœ€è¦å‘å„ä¸ª VPC çš„ Route Table æ·»åŠ  Route é¡¹ï¼Œè½¬å‘æ•°æ®åŒ…åˆ° VPC Peeringã€‚ å…ˆæŸ¥è¯¢ä¸¤ä¸ª VPC å¯¹åº”çš„ Route Table IDã€‚ $ aws ec2 describe-route-tables --filters Name=vpc-id,Values=vpc-0409bd99d5e2b6f5b $ aws ec2 describe-route-tables --filters Name=vpc-id,Values=vpc-0e35ec388cb70e7fc æ·»åŠ  Route é¡¹ï¼ŒåŒ¹é…å¦ä¸€ä¸ªé›†ç¾¤ç½‘æ®µï¼Œè·¯ç”±åˆ° VPC Peeringã€‚ $ aws ec2 create-route \\ --route-table-id rtb-058ae03476f0eb62d \\ --destination-cidr-block 10.0.0.0/16 \\ --vpc-peering-connection-id pcx-094a1149b32ef0c05 { \"Return\": true } $ aws ec2 create-route \\ --route-table-id rtb-03e1023998c139fea \\ --destination-cidr-block 192.168.0.0/16 \\ --vpc-peering-connection-id pcx-094a1149b32ef0c05 { \"Return\": true } 4.2.3 é…ç½® ACL ä¸ Security Group æ¥ç€é…ç½® ACL ä¸ Security Groupï¼Œè®©æ•°æ®åŒ…ä¸è¢«é˜²ç«å¢™æ‰€æ‹¦æˆªã€‚ eksctl åˆ›å»º VPC æ—¶æ²¡æœ‰é…ç½® ACLï¼Œå› æ­¤é»˜è®¤çš„ ACL å…è®¸æ‰€æœ‰çš„è¿›å‡ºæµé‡ï¼Œæ‰€ä»¥ä¸éœ€è¦é…ç½®ã€‚ Instance çš„é»˜è®¤ Security Group æ˜¯ç¦æ­¢æ‰€æœ‰çš„ï¼Œeksctl æ·»åŠ äº† Node èŠ‚ç‚¹çš„ç™½åå•ï¼Œæˆ‘ä»¬éœ€è¦åŠ å…¥å¦ä¸€ä¸ª Cluster ç½‘æ®µçš„ Ruleã€‚ EKS ä¼šè®©å…¶ä¸‹ Instance å…±ç”¨ä¸€ä¸ª Security Groupï¼ˆeksctl get cluster æ—¶å¾—åˆ°ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦é…ç½®ä¸€ä¸ª Security Group å³å¯ã€‚ $ aws ec2 authorize-security-group-ingress \\ --group-id sg-01cde04b3896f32df \\ --protocol all \\ --cidr 10.0.0.0/16 $ aws ec2 authorize-security-group-ingress \\ --group-id sg-06cbf88ed5d56bd18 \\ --protocol all \\ --cidr 192.168.0.0/16 Note è¿™é‡Œçš„ Security Group ID éƒ¨ç½² eksctl get cluster å‘½ä»¤å¾—åˆ°çš„ï¼Œeksctl get cluster å¾—åˆ°æ˜¯æ§åˆ¶é¢çš„ Security Groupã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"4.3 Kubernetes DNS é…ç½® åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç‰©ç†è¿é€šæ€§æ„å»ºå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹äº Cluster ä¸­çš„ DNS é…ç½®äº†ã€‚å› ä¸º EKS é›†ç¾¤éƒ¨ç½²æ²¡æœ‰ä¿®æ”¹ Cluster Domain çš„æ–¹å¼ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘æ²¡æ‰¾åˆ°ï¼‰ï¼Œå¦‚ 3.2 é…ç½® CoreDNS æ‰€è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨ namespace æ¥åŒºåˆ† Domainã€‚ æˆ‘ä»¬å…ˆè¦çŸ¥é“ Cluster1 ä¸ Cluster2 ä¸­å„ä¸ª CoreDNS Pod çš„ IPï¼Œè¿™æ ·æ‰èƒ½é…ç½® CoreDNS è½¬å‘ã€‚ $ k1 get pods -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES coredns-86d9946576-72gcv 1/1 Running 0 112m 192.168.95.166 ip-192-168-85-158.us-west-2.compute.internal \u003cnone\u003e \u003cnone\u003e coredns-86d9946576-tk9nk 1/1 Running 0 112m 192.168.4.66 ip-192-168-24-153.us-west-2.compute.internal \u003cnone\u003e \u003cnone\u003e $ k2 get pods -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES coredns-86d9946576-79zvs 1/1 Running 0 87m 10.0.76.0 ip-10-0-77-8.us-west-2.compute.internal \u003cnone\u003e \u003cnone\u003e coredns-86d9946576-tqcbh 1/1 Running 0 87m 10.0.91.141 ip-10-0-77-8.us-west-2.compute.internal \u003cnone\u003e \u003cnone\u003e æ¥ç€é…ç½® CoreDNS1 ä¸ CoreDNS2ï¼Œé€šè¿‡å¯¹åº”çš„ ConfigMap æ¥é…ç½® Corefileã€‚é…ç½®åï¼ŒCoreDNS ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®ã€‚ $ k1 edit -n kube-system cm corednsapiVersion:v1kind:ConfigMap# ...data:Corefile:|.:53 { # default... } cluster-2.svc.cluster.local:53 { log errors cache 30 forward . 10.0.76.0 10.0.91.141 }$ k2 edit -n kube-system cm corednsapiVersion:v1kind:ConfigMap# ...data:Corefile:|.:53 { # default... } cluster-1.svc.cluster.local:53 { log errors cache 30 forward . 10.0.76.0 10.0.91.141 } è¿™é…ç½®è¡¨æ˜äº†ï¼Œåœ¨åˆ›å»ºæœåŠ¡æ—¶éƒ¨ç½²åœ¨ Cluster1 çš„ â€œcluster-1â€ namespace ä¸ Cluster2 çš„ â€œcluster-2â€ namespace æ—¶ï¼ŒåŸŸåè§£ææ‰èƒ½æ­£å¸¸ã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"4.4 æµ‹è¯• OKï¼Œä¸€åˆ‡éƒ½å®Œæˆäº†ï¼Œæˆ‘ä»¬æ¥ç®€å•çš„æµ‹è¯•ä¸‹ã€‚æˆ‘ä»¬åœ¨ Cluster1 éƒ¨ç½²ä¸€ä¸ª busybox Podï¼Œç”¨äºç­‰ä¼šè®¿é—® Cluster2 Service ä½¿ç”¨ã€‚ $ k1 apply -f https://raw.githubusercontent.com/kubernetes/kubernetes/master/hack/testdata/recursive/pod/pod/busybox.yaml åœ¨ Cluster2 éƒ¨ç½²ä¸€ä¸ª Serviceï¼ŒService å°†æ¶ˆæ¯è½¬å‘åˆ°ç™¾åº¦ã€‚éœ€è¦æ³¨æ„ï¼Œä¸€å®šè¦éƒ¨ç½²åœ¨ â€œcluster-2â€ namespaceã€‚ apiVersion:v1kind:Servicemetadata:name:proxy-to-baidunamespace:cluster-2spec:ports:- name:baiduport:8888protocol:TCPtype:ExternalNameexternalName:www.baidu.com# \u003c-- è½¬å‘ æµ‹è¯•ä¸‹åŸŸåè§£æï¼Œå¯ä»¥çœ‹åˆ°åŸŸåè§£æåˆ°äº†ç™¾åº¦çš„åŸŸåäº†ï¼Œè¯´æ˜è·¨ Kubernetes è”é€šäº†ï¼ $ k1 exec busybox1 -- nslookup proxy-to-baidu.cluster-2.svc.cluster.local Server: 10.100.0.10 Address: 10.100.0.10:53 proxy-to-baidu.cluster-2.svc.cluster.local canonical name = www.baidu.com www.baidu.com canonical name = www.a.shifen.com www.a.shifen.com canonical name = www.wshifen.com ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"5 GCP ä¸Šçš„å®è·µ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"5.1 åˆ›å»º VPC Network GCP ä¸ AWS ä¸åŒï¼Œå…¶ VPC æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„å…¨çƒçš„æ¦‚å¿µï¼Œå…¶ä¸‹çš„ Subnet æ˜¯å¤©ç„¶çš„è·¨ Region è”é€šçš„ã€‚å› æ­¤ï¼Œç‰©ç†ç½‘ç»œæˆ‘ä»¬ä¸éœ€è¦è¿‡å¤šçš„é…ç½®ä½¿å…¶è”é€šã€‚ å…ˆåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å­ç½‘çš„ VPCï¼š $ gcloud compute networks create ${network_name} --subnet-mode=custom åœ¨æ–°åˆ›å»ºçš„ VPC ç½‘ç»œä¸‹åˆ›å»ºä¸¤ä¸ªä¸ª Subnetï¼Œæ³¨æ„å„ä¸ª Subnet çš„ IP åœ°å€èŒƒå›´ä¸èƒ½ç›¸äº’é‡å ã€‚æ¯ä¸ª Subnet è¿˜åŒ…å«äº†åç»­ Kubernetes è¦ä½¿ç”¨çš„ Pod ä¸ Service çš„ IP åœ°å€èŒƒå›´ã€‚ $ gcloud compute networks subnets create ${subnet_1} \\ --region=${region_1} \\ --network=${network_name} \\ --range=10.0.0.0/16 \\ --secondary-range pods=10.10.0.0/16,services=10.100.0.0/16 $ gcloud compute networks subnets create ${subnet_1} \\ --region=${region_1} \\ --network=${network_name} \\ --range=10.2.0.0/16 \\ --secondary-range pods=10.12.0.0/16,services=10.102.0.0/16 ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:5:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"5.2 åˆ›å»º GKE é›†ç¾¤ åˆ›å»ºä¸¤ä¸ª Region çº§åˆ«çš„ GKE é›†ç¾¤ï¼š $ gcloud beta container clusters create ${cluster_1} \\ --region ${region_1} --num-nodes 1 \\ --network ${network_name} --subnetwork ${subnet_1} \\ --cluster-dns clouddns --cluster-dns-scope vpc \\ --cluster-dns-domain ${cluster_domain_1} --enable-ip-alias \\ --cluster-secondary-range-name=pods --services-secondary-range-name=services $ gcloud beta container clusters create ${cluster_2} \\ --region ${region_2} --num-nodes 1 \\ --network ${network_name} --subnetwork ${subnet_2} \\ --cluster-dns clouddns --cluster-dns-scope vpc \\ --cluster-dns-domain ${cluster_domain_2} --enable-ip-alias \\ --cluster-secondary-range-name=pods --services-secondary-range-name=services ä¸€äº›é‡è¦çš„å‚æ•°ï¼š --network ä¸ --subnetwork æŒ‡å®šäº†åŠ å…¥çš„ Subnetï¼› -cluster-dns clouddns å’Œ --cluster-dns-scope vpc å‚æ•°ä½¿ç”¨äº† Cloud DNS æœåŠ¡ï¼Œä»¥å®ç°è·¨ Kubernetes çš„ DNS è§£æï¼› --cluster-dns-domain ${cluster_domain_1} å®šä¹‰äº†åŸŸåè§£æä½¿ç”¨çš„ Cluster Domainï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦ä¸º Pod é…ç½®çš„ï¼› --cluster-secondary-range-name=pods --services-secondary-range-name=services æŒ‡å®šäº† Pod ä¸ Service ä½¿ç”¨çš„ IP åœ°å€èŒƒå›´ï¼› ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:5:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"5.3 é…ç½® Firewall æœ€åä¸€æ­¥å°±æ˜¯é…ç½® GKE é›†ç¾¤èŠ‚ç‚¹åº”ç”¨çš„ Firewallã€‚é»˜è®¤æƒ…å†µï¼Œåˆ›å»º GKE é›†ç¾¤ä¼šåˆ›å»ºé»˜è®¤æœ¬é›†ç¾¤ Pod è®¿é—®çš„ Firewallï¼ˆè§æ–‡æ¡£ è‡ªåŠ¨åˆ›å»ºçš„é˜²ç«å¢™è§„åˆ™ï¼‰ï¼Œå› æ­¤é›†ç¾¤è§ Pod ç›¸äº’è®¿é—®æ˜¯ä¸å…è®¸çš„ã€‚ å…ˆæ‰¾åˆ°é›†ç¾¤ç”¨äº Pod è§é€šä¿¡çš„ Firewall rulesã€‚ $ gcloud compute firewall-rules list --filter='name~gke-${cluster_1}-.*-all' NAME NETWORK DIRECTION PRIORITY ALLOW DENY DISABLED gke-${cluster_1}-b8b48366-all ${network} INGRESS 1000 tcp,udp,icmp,esp,ah,sctp False æ›´æ–°è¯¥é˜²ç«å¢™è§„åˆ™ï¼Œè®¾ç½® source range ä¸ºæ‰€æœ‰é›†ç¾¤çš„ Pod ç½‘ç»œçš„ IP åœ°å€èŒƒå›´ï¼š $ gcloud compute firewall-rules update gke-${cluster_1}-b8b48366-all --source-ranges 10.10.0.0/16,10.11.0.0/16 ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:5:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"6 Kind ä¸Šçš„å®è·µ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"6.1 åˆ›å»º Kubernetes é›†ç¾¤ ç¼–å†™ Kind Cluster é…ç½®æ–‡ä»¶ã€‚å› ä¸º Kind æ”¯æŒé…ç½® kubeadm çš„é…ç½®ï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ä¸¤ä¸ªé›†ç¾¤çš„ cluster domainã€‚ $ cat cluster-1.yamlkind:ClusterapiVersion:kind.x-k8s.io/v1alpha4networking:podSubnet:10.10.0.0/16serviceSubnet:10.40.0.0/16nodes:- role:control-plane- role:worker- role:workerkubeadmConfigPatches:- |kind: ClusterConfiguration networking: dnsDomain: \"cluster-1.com\"$ cat cluster-2.yamlkind:ClusterapiVersion:kind.x-k8s.io/v1alpha4networking:podSubnet:10.20.0.0/16serviceSubnet:10.50.0.0/16nodes:- role:control-plane- role:worker- role:workerkubeadmConfigPatches:- |kind: ClusterConfiguration networking: dnsDomain: \"cluster-2.com\" åˆ›å»ºä¸¤ä¸ªé›†ç¾¤ cluster-1 cluster-2ã€‚ $ kind create cluster --config cluster-1.yaml --name cluster-1 $ kind create cluster --config cluster-2.yaml --name cluster-2 WARN æ“ä½œæ—¶ï¼Œå‘ç°å¦‚æœ network.podSubnet è®¾ç½®ä¸º 10.0.0.0/16 ä¹‹å¤–çš„ç½‘æ®µï¼ŒKind çš„ CNI æ— æ³•éƒ¨ç½²æˆåŠŸã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:6:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"6.2 æ„å»ºç½‘ç»œ æ•´ä¸ªç½‘ç»œæ•°æ®åŒ…çš„æµè½¬ä¸ºï¼šPod A -\u003e Node A -\u003e Node B -\u003e Pod Bã€‚å…¶ä¸­ Pod -\u003e Node ä¹‹é—´çš„ç½‘ç»œæ˜¯è¿é€šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³çš„å…³é”®é—®é¢˜å°±æ˜¯ Node A -\u003e Node B çš„æ•°æ®åŒ…è½¬å‘ã€‚ Kind åˆ›å»ºçš„å¤šä¸ªé›†ç¾¤éƒ½æ˜¯åœ¨ä¸€ä¸ª Docker Bridge Networkï¼Œå› æ­¤ Node ä¹‹é—´çš„ç½‘ç»œæ˜¯å¤©ç„¶è”é€šçš„ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ Node ä¸Šæ·»åŠ è·¯ç”±é¡¹ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ­£ç¡®è½¬å‘å‘å¾€å¯¹æ–¹é›†ç¾¤çš„æ•°æ®åŒ…ã€‚æˆ‘ä»¬ä¸ºæ‰€æœ‰ Node æ·»åŠ æŒ‡å‘å¦ä¸€ä¸ªé›†ç¾¤ä¸‹çš„ Node çš„è·¯ç”±ï¼Œè·¯ç”±åŸºäº Node çš„ Pod CIDRã€‚ # æ‰¾åˆ° æ¯ä¸ª node çš„ IP ä¸ PodCIDR $ kubectl --context kind-cluster-1 get node -ojsonpath='{range .items[*]} {.metadata.name}{\"\\t\"} {.spec.podCIDR}{\"\\t\"} {.status.addresses[0].address}{\"\\n\"} {end}' cluster-1-control-plane 10.10.0.0/24 172.19.0.2 cluster-1-worker 10.10.2.0/24 172.19.0.4 cluster-1-worker2 10.10.1.0/24 172.19.0.3 $ kubectl --context kind-cluster-2 get node -ojsonpath='{range .items[*]} {.metadata.name}{\"\\t\"} {.spec.podCIDR}{\"\\t\"} {.status.addresses[0].address}{\"\\n\"} {end}' cluster-2-control-plane 10.20.0.0/24 172.19.0.7 cluster-2-worker 10.20.2.0/24 172.19.0.5 cluster-2-worker2 10.20.1.0/24 172.19.0.6 # ç»™èŠ‚ç‚¹æ·»åŠ è·¯ç”±é¡¹ $ for node in cluster-1-control-plane cluster-1-worker cluster-1-worker2 ; do docker exec ${node} ip route add 10.20.0.0/24 via 172.19.0.7; done $ for node in cluster-1-control-plane cluster-1-worker cluster-1-worker2 ; do docker exec ${node} ip route add 10.20.2.0/24 via 172.19.0.5; done $ for node in cluster-1-control-plane cluster-1-worker cluster-1-worker2 ; do docker exec ${node} ip route add 10.20.1.0/24 via 172.19.0.6; done $ for node in cluster-2-control-plane cluster-2-worker cluster-2-worker2 ; do docker exec ${node} ip route add 10.10.0.0/24 via 172.19.0.2; done $ for node in cluster-2-control-plane cluster-2-worker cluster-2-worker2 ; do docker exec ${node} ip route add 10.10.2.0/24 via 172.19.0.4; done $ for node in cluster-2-control-plane cluster-2-worker cluster-2-worker2 ; do docker exec ${node} ip route add 10.10.1.0/24 via 172.19.0.3; done Note è¿™é‡Œå°è¯•è¿‡ç»™å®¿ä¸»æœºä¸Šçš„ kind çš„ Bridge ç½‘å¡æ·»åŠ è·¯ç”±æ¥è½¬å‘ï¼Œè€Œä¸ç”¨ä¸ºæ¯ä¸ª Node è®¾ç½®è·¯ç”±ã€‚ä½†æ˜¯ï¼Œè¿™æ ·è®¾ç½®å¥½åå‘ç° UDP ICMP æ•°æ®åŒ…æ˜¯å¯ä»¥äº’é€šçš„ï¼Œä½†æ˜¯ TCP è¿æ¥æ— æ³•æˆåŠŸã€‚è¿˜ä¸æ¸…æ¥šåŸå› ã€‚ ä¸‹å›¾æ€»ç»“äº†ç›®å‰æ„å»ºçš„ç½‘ç»œï¼š Pod A å‘é€æ•°æ®åŒ…ï¼Œèµ° default è·¯ç”±ï¼Œç”± Bridge ç½‘å¡å¤„ç†ã€‚ æ ¹æ®è·¯ç”±ï¼Œå°†æ•°æ®åŒ…è½¬å‘ç»™ Control Plane Nodeã€‚ Control Plane Node è½¬å‘ç»™ Node Aï¼Œåå‘é€åˆ° Pod Aã€‚ Note Kind ç½‘ç»œä¸­ï¼ŒæŸä¸ªé›†ç¾¤ Pod è®¿é—®å…¶ä»–é›†ç¾¤æ—¶ï¼Œæ•°æ®åŒ…ä¼šè¢« Node è¿›è¡Œ SNATã€‚å› æ­¤ï¼Œåœ¨æŸäº›éœ€è¦ä½¿ç”¨æº IPï¼ˆä¾‹å¦‚è¯ä¹¦ host é…ç½®ï¼‰æ—¶ï¼Œéœ€è¦æ³¨æ„ã€‚ ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:6:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"6.3 Kubernetes DNS é…ç½® DNS é…ç½®ä¸ AWS ä¸­çš„ DNS é…ç½®ç±»ä¼¼ï¼Œä¸è¿‡å› ä¸ºè®¾ç½®äº†ä¸¤ä¸ªé›†ç¾¤çš„ cluster domainï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨ cluster domain é…ç½® CoreDNSã€‚ å…ˆçœ‹ä¸¤ä¸ªé›†ç¾¤çš„ CoreDNS Pod IPã€‚ $ kubectl --context kind-cluster-1 get pods -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES coredns-558bd4d5db-7kjdt 1/1 Running 0 65m 10.10.0.3 cluster-1-control-plane \u003cnone\u003e \u003cnone\u003e coredns-558bd4d5db-lb46f 1/1 Running 0 65m 10.10.0.2 cluster-1-control-plane \u003cnone\u003e \u003cnone\u003e $ kubectl --context kind-cluster-2 get pods -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES coredns-558bd4d5db-b8c46 1/1 Running 0 64m 10.20.0.2 cluster-2-control-plane \u003cnone\u003e \u003cnone\u003e coredns-558bd4d5db-w9p8g 1/1 Running 0 64m 10.20.0.3 cluster-2-control-plane \u003cnone\u003e \u003cnone\u003e æ¥ç€é…ç½® CoreDNS1 ä¸ CoreDNS2ï¼Œé€šè¿‡å¯¹åº”çš„ ConfigMap æ¥é…ç½® Corefileã€‚é…ç½®åï¼ŒCoreDNS ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®ã€‚ $ kubectl --context kind-cluster-1 edit -n kube-system cm corednsapiVersion:v1kind:ConfigMap# ...data:Corefile:|.:53 { # default... } cluster-2.com:53 { errors cache 30 forward . 10.20.0.2 10.20.0.3 # -\u003e å¯¹æ–¹é›†ç¾¤çš„ CoreDNS Pod IP } $ kubectl --context kind-cluster-2 edit -n kube-system cm corednsapiVersion:v1kind:ConfigMap# ...data:Corefile:|.:53 { # default... } cluster-1.com:53 { errors cache 30 forward . 10.10.0.2 10.10.0.3 # -\u003e å¯¹æ–¹é›†ç¾¤çš„ CoreDNS Pod IP } ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:6:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes å®è·µ"],"content":"å‚è€ƒ Doc: Customizing DNS Service Doc: DNS for Services and Pods Orchestrate CockroachDB Across Multiple Kubernetes Clusters ","date":"2021-09-30","objectID":"/posts/cloud_computing/k8s_practice/across-kubernetes/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - Network Across Cluster","uri":"/posts/cloud_computing/k8s_practice/across-kubernetes/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"kube-scheduler è´Ÿè´£é›†ç¾¤èµ„æºçš„è°ƒåº¦ï¼ŒåŸç”Ÿçš„ Kubernetes Scheduler å¯ä»¥æ»¡è¶³å¤§å¤šæ•°æƒ…å†µçš„éœ€æ±‚ã€‚ä¸è¿‡é’ˆå¯¹äºä¸åŒä¸šåŠ¡çš„ç‰¹æ®Šçš„è°ƒåº¦éœ€æ±‚ï¼ŒKubernetes æä¾›äº†å¤šç§æ‰©å±•è°ƒåº¦å™¨çš„æ–¹å¼ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 Scheduler æ‰©å±•ç‚¹ Scheduler Framework åœ¨æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹ä¸­æœ‰ç€ä¸€ç³»åˆ—çš„æ‰©å±•ç‚¹ï¼Œæ”¯æŒç”¨æˆ·ä»¥ Plugin çš„æ–¹å¼è¿›è¡Œæ‰©å±•ã€‚ æ•´ä¸ªçš„è°ƒåº¦æµç¨‹ä¸­çš„æ‰©å±•ç‚¹å¦‚ä¸‹å›¾ï¼š æ‰€æœ‰çš„æ‰©å±•ç‚¹éƒ½æ˜¯ç”± Plugin å®ç°çš„ï¼Œå…è®¸é…ç½®å¼€å¯æˆ–å…³é—­ï¼Œä¹Ÿå¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„ Pluginã€‚è¿™åœ¨åç»­çš„ KubeSchedulerConfiguration ä¸­æ·±å…¥è¯´æ˜ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.1 QueueSort è¯¥æ’ä»¶ç”¨äºå¯¹ scheduling queue ä¸­çš„ Pod è¿›è¡Œæ’åºï¼Œä¸€æ¬¡åªèƒ½å­˜åœ¨ä¸€ä¸ª QueueSort Pluginã€‚ ä¸€ä¸ª QueueSort Plugin æœ¬è´¨ä¸Šå°±æ˜¯æä¾›äº†ä¸€ä¸ª Less(Pod1, Pod2) å‡½æ•°ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.2 PreFilter è¯¥æ’ä»¶ç”¨äºå¯¹ Pod çš„ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†ï¼Œæˆ–è€…æ£€æŸ¥ä¸€äº›é›†ç¾¤æˆ– Pod å¿…é¡»æ»¡è¶³çš„å‰ææ¡ä»¶ã€‚ å¦‚æœ PreFilter Plugin è¿”å›ä¸€ä¸ª errorï¼Œé‚£ä¹ˆè°ƒåº¦æµç¨‹ç›´æ¥ç»ˆæ­¢ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.3 Filter è¯¥æ’ä»¶ç”¨äºè¿‡æ»¤ä¸èƒ½è¿è¡Œ Pod çš„ Nodeã€‚ å¯¹äºæ¯ä¸€ä¸ª Nodeï¼Œè°ƒåº¦å™¨å°†æŒ‰ç…§é¡ºåºæ‰§è¡Œ Filter Pluginã€‚å¦‚æœä»»æ„ä¸€ä¸ª Filter Plugin å°† Node æ ‡è®°ä¸ºä¸å¯è¡Œï¼Œé‚£ä¹ˆå‰©ä¸‹çš„ Filter Plugin å°±ä¸ä¼šå†è¿è¡Œã€‚ æ‰€æœ‰ Node ä¼šå¹¶è¡Œè¿›è¡Œ Filterã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.4 PostFilter è¿™äº›æ’ä»¶åœ¨ Filter é˜¶æ®µä¹‹åè¢«è°ƒç”¨ï¼Œåªæœ‰åœ¨æ²¡æœ‰ä¸º Pod æ‰¾åˆ°å¯è¿è¡Œçš„ Node æ—¶æ‰ä¼šè¿è¡Œã€‚æ‰€æœ‰æ’ä»¶æŒ‰ç…§é¡ºåºè¿è¡Œã€‚ å¦‚æœä»»æ„ä¸€ä¸ª PostFilter Plugin å°† Node æ ‡è®°ä¸º Schedulableï¼Œå‰©ä¸‹çš„ PostFilter Plugin å°±ä¸ä¼šå†è¿è¡Œã€‚ ä¸€ä¸ªå…¸å‹çš„ PostFilter Plugin æ˜¯æŠ¢å ï¼Œå®ƒé€šè¿‡æŠ¢å å…¶ä»– Pod æ¥è°ƒåº¦ Podã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.5 PreScore è¿™äº›æ’ä»¶ç”¨äºæ‰§è¡Œ â€œé¢„æ‰“åˆ†â€ å·¥ä½œï¼Œä¸º Score Plugin ç”Ÿæˆä¸€ä¸ªå¯å…±äº«çš„çŠ¶æ€ã€‚ å¦‚æœ PreScore æ’ä»¶è¿”å› errorï¼Œè°ƒåº¦æµç¨‹ç»ˆæ­¢ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.6 Score è¿™äº›æ’ä»¶ç”¨äºä¸ºæ‰€æœ‰å¯é€‰ Node æ‰“åˆ†ï¼Œè°ƒåº¦å™¨ä¼šä¸ºæ¯ä¸ª Node è°ƒç”¨æ¯ä¸ª Score Pluginã€‚ æ‰“åˆ†æœ‰ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„æ•´æ•°èŒƒå›´ï¼Œä»£è¡¨æœ€ä½å’Œæœ€é«˜åˆ†æ•°ã€‚ åœ¨ NormalizeScore é˜¶æ®µåï¼ŒScheduler å°†æ ¹æ®é…ç½®çš„æ’ä»¶æƒé‡ï¼Œåˆå¹¶æ‰€æœ‰æ’ä»¶çš„æ‰“åˆ†ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:6","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.7 NormalizeScore è¿™äº›æ’ä»¶ç”¨äºåœ¨æœ€ç»ˆæ’åº Node å‰ä¿®æ”¹æ¯ä¸ª Node çš„è¯„åˆ†ç»“æœã€‚ å½“ NormalizeScore Plugin è¢«è°ƒç”¨æ—¶ï¼Œå°†è·å¾—åŒä¸€ä¸ª Plugin ä¸­æ‰“åˆ†ç»“æœã€‚åœ¨æ¯ä¸ªè°ƒåº¦å‘¨æœŸåï¼Œæ¯ä¸ªæ’ä»¶ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚ ä¾‹å¦‚ï¼Œæ”¯æŒ Plugin BlinkingLightScorer æ ¹æ®æ¯ä¸ª Node æœ‰å¤šå°‘ä¸ª blinking lights è¿›è¡Œæ’åã€‚ func ScoreNode(_ *v1.pod, n *v1.Node) (int, error) { return getBlinkingLightCount(n) } ä½†æ˜¯ï¼Œä¸ NodeScoreMax ç›¸æ¯”ï¼Œblinking lights æ•°é‡ä¹Ÿå¯èƒ½å¾ˆå°‘ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒBlinkingLightScorer ä¹Ÿæ³¨å†Œäº†è¿™ä¸ªæ‰©å±•ç‚¹ã€‚ func NormalizeScores(scores map[string]int) { highest := 0 for _, score := range scores { highest = max(highest, score) } for node, score := range scores { scores[node] = score*NodeScoreMax/highest } } å¦‚æœä»»ä½• NormalizeScore Plugin è¿”å› errorï¼Œè°ƒåº¦å°†ç»ˆæ­¢ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:7","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.8 Reserve Reserve Plugin æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šReserve å’Œ Unreserveï¼Œä¼šå¸¦æœ‰ Reserve å’Œ Unreserve è°ƒåº¦é˜¶æ®µçš„ä¿¡æ¯ã€‚æœ‰çŠ¶æ€çš„æ’ä»¶å¯ä»¥ä½¿ç”¨è¯¥æ‰©å±•ç‚¹æ¥è·å¾— Node ä¸Šä¸º Pod é¢„ç•™çš„èµ„æºã€‚ è¯¥äº‹ä»¶å‘ç”Ÿåœ¨è°ƒåº¦å™¨å°† Pod ç»‘å®šåˆ° Node ä¹‹å‰ï¼Œç›®çš„æ˜¯é¿å…è°ƒåº¦å™¨åœ¨ç­‰ Pod ä¸ Node ç»‘å®šè¿‡ç¨‹ä¸­ï¼Œæœ‰æ–°çš„ Pod è°ƒåº¦åˆ°è¯¥ Node ä¸Šï¼Œå‘ç”Ÿå®é™…ä½¿ç”¨èµ„æºè¶…è¿‡å¯ç”¨èµ„æºçš„æƒ…å†µã€‚ï¼ˆå› ä¸ºç»‘å®š Pod æ˜¯å¼‚æ­¥çš„ï¼‰ è¿™æ˜¯è°ƒåº¦è¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼ŒPod è¿›å…¥ reserved çŠ¶æ€åï¼Œè¦ä¹ˆç»‘å®šå¤±è´¥è§¦å‘ Unreserveï¼Œè¦ä¹ˆç”± Postbind æ‰©å±•ç»“æŸç»‘å®šè¿‡ç¨‹ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:8","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.9 Permit Permit Plugin åœ¨è°ƒåº¦å‘¨æœŸçš„æœ€åè°ƒç”¨ï¼Œä¸ºäº†ç»„ç»‡æˆ–å»¶è¿Ÿç»‘å®šåå€™é€‰çš„ Nodeã€‚ Permit Plugin åšä»¥ä¸‹çš„äº‹æƒ…ï¼š approve ä¸€æ—¦æ‰€æœ‰ Permit Plugin approve ä¸€ä¸ª Podï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œç»‘å®šæ“ä½œã€‚ deny å¦‚æœä»»ä¸€ Permit Plugin deny ä¸€ä¸ª POodï¼Œé‚£ä¹ˆå°†å…¶é‡æ–°æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚è¿™ä¹Ÿä¼šè§¦å‘ Unreserve é˜¶æ®µã€‚ waitï¼ˆwith a timeoutï¼‰ å¦‚æœä¸€ä¸ª Permit Plugin è¿”å› waitï¼Œé‚£ä¹ˆè¯¥ Pod ä¼šåœ¨ waiting Pod list ä¸­ç­‰å¾…ï¼Œç›´åˆ°è¯¥ Pod è¢« approveã€‚ å¦‚æœ wait timeout è§¦å‘ï¼Œé‚£ä¹ˆå˜ä¸º deny Podã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:9","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.10 PreBind è¿™äº›æ’ä»¶ç”¨äºåœ¨ Pod è¢«ç»‘å®šå‰æ‰§è¡Œä¸€äº›å·¥ä½œã€‚ ä¾‹å¦‚ï¼ŒPreBind Plugin å¯ä»¥åˆ›å»º network volumeï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°ç›®æ ‡ Nodeã€‚ å¦‚æœä»»ä¸€ PreBind Plugin è¿”å› errorï¼ŒPod ä¼šè¢«æ‹’ç»ï¼Œç„¶åé‡æ–°æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:10","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.11 Bind è¿™äº›æ’ä»¶ç”¨äºå°† Pod ç»‘å®šåˆ° Nodeã€‚ æ¯ä¸ª Bind Plugin ä¼šæŒ‰ç…§é…ç½®é¡ºåºè°ƒç”¨ï¼Œæ¯ä¸ª Bind Plugin å¯ä»¥é€‰æ‹©æ˜¯å¦å¤„ç†è¯¥ Podã€‚å¦‚æœæŸä¸ª Bind Plugin å†³å®šå¤„ç†è¯¥ Podï¼Œåç»­çš„ Bind Plugin ä¼šè·³è¿‡ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:11","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.12 PostBind Post-bind Plugin åœ¨ç»‘å®šæˆåŠŸåè¢«è°ƒç”¨ï¼Œæ˜¯ç»‘å®šå‘¨æœŸçš„æœ€åä¸€ä¸ªé˜¶æ®µã€‚å¸¸å¸¸ç”¨äºæ¸…ç†ç›¸å…³èµ„æºã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:1:12","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 Scheduling Policy Scheduling Policy æ˜¯ä¸€ç§è€ç‰ˆæœ¬é…ç½®è°ƒåº¦å™¨çš„æ–¹å¼ï¼Œå¯ä»¥å®šåˆ¶ Predicates ä¸ Priorities ä½¿ç”¨çš„æ’ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Extender å¯¹é˜¶æ®µè¿›è¡Œæ‰©å±•ã€‚ Scheduling Policy å¯ä»¥ä¸º yaml æˆ–è€… json æ ¼å¼ï¼Œä¸€ä¸ªç¤ºä¾‹å¦‚ä¸‹ï¼š { \"kind\" : \"Policy\", \"apiVersion\" : \"v1\", \"predicates\": [ {\"name\": \"NoVolumeZoneConflict\"}, {\"name\": \"MaxEBSVolumeCount\"}, {\"name\": \"MaxAzureDiskVolumeCount\"}, {\"name\": \"NoDiskConflict\"}, {\"name\": \"GeneralPredicates\"}, {\"name\": \"PodToleratesNodeTaints\"}, {\"name\": \"CheckVolumeBinding\"}, {\"name\": \"MaxGCEPDVolumeCount\"}, {\"name\": \"MatchInterPodAffinity\"}, ], \"priorities\": [ {\"name\": \"SelectorSpreadPriority\", \"weight\": 1}, {\"name\": \"InterPodAffinityPriority\", \"weight\": 1}, {\"name\": \"LeastRequestedPriority\", \"weight\": 1}, {\"name\": \"BalancedResourceAllocation\", \"weight\": 1}, {\"name\": \"NodePreferAvoidPodsPriority\", \"weight\": 1}, {\"name\": \"NodeAffinityPriority\", \"weight\": 1}, {\"name\": \"TaintTolerationPriority\", \"weight\": 1} ], \"extenders\": [ { \"urlPrefix\": \"http://127.0.0.1:10262/scheduler\", \"filterVerb\": \"filter\", \"preemptVerb\": \"preempt\", \"weight\": 1, \"httpTimeout\": 30000000000, \"enableHttps\": false } ] } predicates å®šåˆ¶ Predicate é˜¶æ®µä½¿ç”¨çš„æ’ä»¶ï¼› priorities å®šåˆ¶ Priority é˜¶æ®µä½¿ç”¨çš„æ’ä»¶ï¼› extenders å®šåˆ¶æ‰©å±•çš„ Webhookï¼Œè°ƒåº¦å™¨ä¼šåœ¨å¯¹åº”çš„é˜¶æ®µè°ƒç”¨å¯¹åº”çš„ URLï¼› è¿è¡Œ kube-scheduler æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ kube-scheduler --policy-config-file \u003cfilename\u003e æŒ‡å®šä¸€ä¸ª Policy æ–‡ä»¶ï¼Œæˆ–è€…é€šè¿‡ kube-scheduler --policy-configmap \u003cConfigMap\u003e ----policy-configmap-namespace \u003cNamespace\u003e æŒ‡å®šä¸€ä¸ª ConfigMap è·å– Policyã€‚åŠ ä¸Š 1.22 ä¹‹å‰ kube-scheduler æ”¯æŒçš„ --scheduler-name å‚æ•°ï¼Œå¾ˆç®€å•çš„å®šä¹‰å‡ºä¸€ä¸ªæ–°çš„è°ƒåº¦å™¨ã€‚ $ kube-scheduler --port=10261 --leader-elect=true --lock-object-namespace=pingcap --lock-object-name=my-scheduler --scheduler-name=my-scheduler --policy-configmap=my-scheduler-policy --policy-configmap-namespace=pingcap ä½¿ç”¨ä¸Šè¿°å‘½ä»¤ï¼Œæˆ‘ä»¬è¿è¡Œäº†ä¸€ä¸ªåä¸º my-scheduler çš„è°ƒåº¦å™¨ï¼Œé€šè¿‡ Pod å®šä¹‰çš„ spec.schedulerName å¯ä»¥æŒ‡å®šä½¿ç”¨è¯¥è°ƒåº¦å™¨ã€‚ Scheduling Policy æ˜¯æ—§ç‰ˆæœ¬çš„ 1.22 åï¼Œkube-scheduler å·²ç»ä¸æ”¯æŒ --scheduler-name å‚æ•°äº†ï¼Œå› æ­¤å·²ç»æ— æ³•ä½¿ç”¨ Scheduler Policy æ¥å¾—åˆ°ä¸€ä¸ªæ–°çš„è°ƒåº¦å™¨äº†ã€‚ æ–°ç‰ˆå¤šè°ƒåº¦å™¨åªèƒ½é€šè¿‡ Multiple Profiles æ–¹å¼å®ç°ï¼Œè€Œå…¶ä¸ Scheduler Policy æ˜¯ä¸å…¼å®¹çš„ã€‚æ‰€ä»¥å¦‚æœä½ è¦è€ƒè™‘è¿è¡Œä¸€ä¸ªæ–°çš„è°ƒåº¦å™¨ï¼Œåº”è¯¥ç›´æ¥ä½¿ç”¨ Scheduling Profiles æ–¹å¼ã€‚ å½“ç„¶ï¼ŒSchedule Policy è¿˜æ˜¯èƒ½å¤Ÿå®ç°å®šåˆ¶ default scheduler çš„ä½œç”¨ï¼Œä¸è¿‡ Scheduling Profiles èƒ½å®ç°çš„æ›´å¤šã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 Scheduling Profiles æ— è®ºå“ªç§æ–¹å¼æ‰©å±•è°ƒåº¦å™¨ï¼Œéƒ½æ˜¯å›´ç»•ç€é€šè¿‡ Scheduling Profiles å¯¹ kube-scheduler è¿›è¡Œé…ç½®å®ç°çš„ã€‚ è¿è¡Œ kube-scheduler æ—¶ï¼Œé€šè¿‡ kube-scheduler --config \u003cfilename\u003e æŒ‡å®š Scheduling Profilesã€‚å…¶æ–‡ä»¶å†…å®¹æ˜¯ v1beta1 æˆ–è€… v1beta2 ç‰ˆæœ¬çš„ KubeSchedulerConfiguration ç»“æ„ã€‚ æœ€ç®€å•çš„é…ç½®å¦‚ä¸‹ï¼š apiVersion:kubescheduler.config.k8s.io/v1beta2kind:KubeSchedulerConfigurationclientConnection:kubeconfig:/etc/srv/kubernetes/kube-scheduler/kubeconfig ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.1 é…ç½® Plugin åœ¨ KubeSchedulerConfiguration å®šä¹‰ä¸­çš„ profiles å­—æ®µå¯¹ kube-scheduler çš„æ’ä»¶è¿›è¡Œé…ç½®ã€‚é…ç½®æ–¹å¼æŒ‰ç…§ Scheduler æ‰©å±•ç‚¹ ä¸­æ‰€å±çš„æ‰©å±•ç‚¹ã€‚ å¯¹äºæ¯ä¸ªæ‰©å±•ç‚¹ï¼Œä½ å¯ä»¥å…³é—­æŸäº›é»˜è®¤å¼€å¯çš„ Pluginï¼Œæˆ–è€…æ‰“å¼€ä½ è‡ªå·±å®šä¹‰çš„ Pluginã€‚ ä¾‹å¦‚ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œå…³é—­äº† Score æ‰©å±•ç‚¹çš„ NodeResourcesLeastAllocated Pluginï¼Œæ‰“å¼€ Score æ‰©å±•ç‚¹çš„ MyCustomPluginA Plugin ä¸ MyCustomPluginB Pluginã€‚ apiVersion:kubescheduler.config.k8s.io/v1beta2kind:KubeSchedulerConfigurationprofiles:- plugins:score:disabled:- name:NodeResourcesLeastAllocatedenabled:- name:MyCustomPluginAweight:2- name:MyCustomPluginBweight:1 profiles[].plugins.score - è¡¨æ˜é…ç½® score æ‰©å±•ç‚¹çš„æ’ä»¶ã€‚ disabled - å…³é—­æ’ä»¶ enabled - æ‰“å¼€æ’ä»¶ æ’ä»¶æ˜¯ç¼–è¯‘åˆ°ç¨‹åºä¸­çš„ åœ¨ profiles.plugins å­—æ®µä¸­é…ç½®çš„æ’ä»¶éƒ½æ˜¯é¢„ç¼–è¯‘åˆ° scheduler ä»£ç ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ éœ€è¦å…ˆé€šè¿‡ scheduler framework ç¼–å†™è‡ªå®šä¹‰ Plugin ä»£ç ï¼Œç¼–è¯‘æˆ scheduler é•œåƒï¼Œç„¶åæ‰èƒ½æ‰“å¼€ä½ å®šä¹‰çš„æ’ä»¶ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.2 Multiple Profiles å¯ä»¥é€šè¿‡ profiles å­—æ®µé…ç½®å¤šä¸ª Profileï¼Œæ¯ä¸ª Profile å°±ç±»ä¼¼ä¸ä¸€ä¸ª Scheduler çš„ â€œåˆ†èº«â€ï¼Œå¯ä»¥è¿›è¡Œä¸åŒæ‰©å±•ç‚¹ Plugin çš„é…ç½®ï¼Œå¹¶ä¸”æœ‰ç€ç‹¬ç«‹çš„ schedulerNameã€‚ å¦‚ä¸‹é…ç½®ä¸­ï¼Œå°†è¿è¡Œä¸¤ä¸ª Schedulerï¼šdefault-scheduler è¿è¡Œæ‰€æœ‰é»˜è®¤ Pluginï¼Œno-scoring-scheduler å…³é—­äº†æ‰€æœ‰çš„ Score Pluginã€‚ apiVersion:kubescheduler.config.k8s.io/v1beta2kind:KubeSchedulerConfigurationprofiles:- schedulerName:default-scheduler- schedulerName:no-scoring-schedulerplugins:preScore:disabled:- name:'*'score:disabled:- name:'*' å¤šä¸ªè°ƒåº¦å™¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ Pod å®šä¹‰ä¸­çš„ .spec.schedulerName å­—æ®µæ¥æŒ‡å®šæœŸæœ›çš„è°ƒåº¦å™¨ã€‚ é»˜è®¤ä¸‹ï¼Œä¸€ä¸ª Profile çš„ scheduler name ä¸º â€œdefault-schedulerâ€ï¼Œä¹Ÿå°±æ˜¯ Kubernetes ä¸­é»˜è®¤çš„è°ƒåº¦å™¨åå­—ï¼ˆPod æ²¡æœ‰æŒ‡å®š .spec.schedulerName å­—æ®µæ—¶ï¼Œè‡ªåŠ¨å°†å…¶è®¾ç½®ä¸º â€œdefault-schedulerâ€ï¼‰ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.3 Extender ä¸Šé¢éƒ½æ˜¯åŸºäºå†…ç½®çš„ Plugin è¿›è¡Œé…ç½®ï¼ŒScheduling Profile ä¹Ÿå®Œå…¨èƒ½å¤Ÿå®ç° Scheduling Policy çš„ Webhook æ‰©å±•åŠŸèƒ½ã€‚ apiVersion:kubescheduler.config.k8s.io/v1beta1kind:KubeSchedulerConfigurationleaderElection:leaderElect:trueresourceNamespace:namespaceresourceName:my-schedulerprofiles:- schedulerName:my-schedulerextenders:- urlPrefix:http://127.0.0.1:10262/schedulerfilterVerb:filterpreemptVerb:preemptweight:1enableHTTPS:falsehttpTimeout:30s extenders å­—æ®µç”¨äºå®šåˆ¶æ‰©å±•çš„ Webhookï¼Œè°ƒåº¦å™¨ä¼šåœ¨å¯¹åº”çš„é˜¶æ®µè°ƒç”¨å¯¹åº”çš„ URLã€‚è¿™å¯¹äºæ‰€æœ‰çš„ profiles éƒ½æ˜¯ç”Ÿæ•ˆçš„ã€‚ æŒ‰ç…§ç¤ºä¾‹ä¸­çš„å®šä¹‰ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°è°ƒåº¦å™¨åªéœ€è¦ä¸€ä¸ªé…ç½®ï¼š $ kube-scheduler --config \u003cconfig-file\u003e ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4 æ–¹æ¡ˆ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.1 å¦‚ä½•é…ç½® Scheduler ä»å‰é¢æ‰€è¿°çŸ¥è¯†çœ‹åˆ°ï¼Œé…ç½®ä¸€ä¸ª Scheduler æœ‰ç€å‡ ç§æ–¹å¼ï¼š åŸºäº kube-scheduler çš„ä»£ç æ¡†æ¶ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„ Pluginï¼Œç„¶åç¼–è¯‘éƒ¨ç½²ï¼ˆå¯èƒ½éœ€è¦åœ¨ Scheduling Profiles é…ç½®å¼€å¯ Pluginï¼‰ï¼› å¦‚æœæˆ‘ä»¬éœ€è¦å¾ˆç»†è‡´çš„å®šåˆ¶è°ƒåº¦ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å¯¹ kube-scheduler è¿›è¡Œç‰ˆæœ¬ç»´æŠ¤ã€‚ é€šè¿‡ Scheduling Policy å®šåˆ¶ï¼› ä¸åº”è¯¥æ˜¯ä¼˜å…ˆè€ƒè™‘çš„æ–¹å¼ï¼Œé™¤é Kubernetes ç‰ˆæœ¬ä¸æ”¯æŒå…¶ä»–æ–¹å¼ã€‚ é€šè¿‡ Scheduling Profiles å®šåˆ¶å†…ç½®çš„ Pluginï¼› å¦‚æœ kube-scheduler å†…ç½®çš„ Plugin èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œä»…ä»…éœ€è¦é…ç½®ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ é€šè¿‡ Scheduling Porfiles ä¸­çš„ Extender åŠŸèƒ½é…ç½®è‡ªå®šä¹‰çš„ Webhookã€‚ éœ€è¦ç®€å•çš„å®šåˆ¶è°ƒåº¦ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ ç¬¬ä¸€ç§ä¸ç¬¬å››ç§éƒ½å¯ä»¥è®©æˆ‘ä»¬å®ç°æˆ‘ä»¬è‡ªå·±çš„è°ƒåº¦ï¼ŒåŒºåˆ«åœ¨äº Plugin å¯ä»¥åŸºäºæ‰€æœ‰çš„æ‰©å±•ç‚¹å®ç°ï¼Œè€Œ Extender åªèƒ½åŸºäºå¤§çš„é˜¶æ®µè¿›è¡Œå®šåˆ¶ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.2 å¦‚ä½•è¿è¡Œ Multiple Schedulers Multiple Schedulers æ˜¯åŸºäºé…ç½® Scheduler çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå®šåˆ¶çš„ Scheduler å‘½åï¼Œå¯ä»¥ä¸ Kubernetes åŸç”Ÿçš„ Schedulerï¼ˆåä¸º default-schedulerï¼‰åŒæ—¶è¿è¡Œã€‚æ‰€ä»¥å…³é”®å°±æ˜¯å¦‚ä½•å‘½å Scheduler äº†ã€‚ ç›®å‰æœ‰ä¸¤ç§æ–¹å¼æ¥å‘½å Schedulerï¼š ç‰ˆæœ¬ \u003c 1.22 å¯ä»¥ä½¿ç”¨ kube-scheduler --scheduler-name \u003cname\u003e ç»™è°ƒåº¦å™¨å‘½åï¼› ç‰ˆæœ¬ \u003e= 1.19 å¯ä»¥ä½¿ç”¨ Scheduling Profiles é…ç½®æ–‡ä»¶ä¸­çš„ profiles[].schedulerName ç»™è°ƒåº¦å™¨å‘½åï¼Œå¹¶ä¸”æ”¯æŒä¸€ä¸ª kube-scheduler ç¨‹åºè¿è¡Œå¤šä¸ªè°ƒåº¦å™¨ã€‚ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"5 å®ç° Plugin ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6 å®ç° Extender ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ Doc: Scheduling Policies Ooc: Scheduler Configuration Doc: Scheduling Framework Blog: è‡ªå®šä¹‰ Kubernetes è°ƒåº¦å™¨ ","date":"2021-09-22","objectID":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 8 - Custom Scheduler","uri":"/posts/cloud_computing/k8s_programming/8-extend-scheduler/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ ä¸‹é¢ä»£ç éƒ½æ¥è‡ªäº agnhost/webhookï¼Œè¿™æ˜¯å®˜æ–¹çš„ Admission Webhook çš„ç¤ºä¾‹ åœ¨ Custom APIServer/Admission ä¸€èŠ‚ä¸­çœ‹åˆ°ï¼ŒAPISever æä¾›äº† Admission Plugin æœºåˆ¶æ¥è¿›è¡Œ Mutating ä¸ Validating çš„æ’ä»¶å¼æ‰©å±•ã€‚ä¸è¿‡ Admission Plugin æ˜¯è¦é‡æ–°ç¼–è¯‘ APISever æ¥å®ç°çš„ï¼Œå› æ­¤ APISever æä¾›äº†æ›´åŠ çµæ´»çš„ Admission Webhookã€‚ Admission Webhook çš„è°ƒç”¨æ—¶æœºåœ¨ Admission Plugin çš„å°¾éƒ¨ï¼Œåœ¨ Quota Plugin ä¹‹å‰ã€‚ Admission Webhook çš„ä½¿ç”¨åŒ…å«ï¼š éƒ¨ç½² Webhook Serverï¼Œç”¨äº APISever è½¬å‘è¯·æ±‚ï¼› éƒ¨ç½² ValidatingWebhookConfiguration/MutatingWebhookConfiguration èµ„æºï¼Œå‘ APISever æ³¨å†Œ Webhook Serverï¼› RBACï¼ˆå¦‚æœ Webhook Server éœ€è¦ï¼‰ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 WebhookConfiguration é€šè¿‡éƒ¨ç½² ValidatingWebhookConfiguration/MutatingWebhookConfiguration æ¥å‘ APIServer æ³¨å†Œ Validating/Mutating Webhook Serverã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª ValidatingWebhookConfiguration ç¤ºä¾‹ï¼Œè€Œ MutatingWebhookConfiguration æ˜¯ç±»ä¼¼çš„ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:ValidatingWebhookConfigurationmetadata:name:\"pod-policy.example.com\"webhooks:- name:\"pod-policy.example.com\"# objectSelector:# matchLabels:# foo: bar# namespaceSelector:# matchExpressions:# - key: runlevel# operator: NotIn# values: [\"0\",\"1\"]matchPolicy:Equivalentrules:- apiGroups:[\"\"]apiVersions:[\"v1\"]operations:[\"CREATE\"]resources:[\"pods\"]scope:\"Namespaced\"clientConfig:# url: \" https://my-webhook.example.com:9443/my-webhook-path\"service:namespace:\"example-namespace\"name:\"example-service\"caBundle:\"Ci0tLS0tQk...\u003c`caBundle` is a PEM encoded CA bundle which will be used to validate the webhook's server certificate.\u003e...tLS0K\"admissionReviewVersions:[\"v1\",\"v1beta1\"]sideEffects:NonetimeoutSeconds:5reinvocationPolicy:IfNeededfailurePolicy:Fail webhooks: å®šä¹‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª webhook servers name - å®šä¹‰å¤šä¸ª webhook æƒ…å†µä¸‹ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„ name clientConfig - å®šä¹‰ APIServer è½¬å‘çš„ç›®æ ‡ï¼Œå¯ä»¥ä¸º URL æˆ–è€… Service admissionReviewVersions - è¡¨æ˜ webhook server æ”¯æŒçš„ AdmissionReview çš„ç‰ˆæœ¬ sideEffects - è¡¨æ˜ Webhook æ˜¯å¦æ”¯æŒ Side effect timeoutSecondsï¼ˆ1-30) - é…ç½® APIServer ç­‰å¾… webhook server å›å¤çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åæ ¹æ® failure policy å¤„ç† rules - å®šä¹‰è½¬å‘çš„åŒ¹é…è§„åˆ™ objectSelector - æ ¹æ® object çš„ label æ¥ç­›é€‰ APIServer éœ€è¦è½¬å‘çš„è¯·æ±‚ namespaceSelector - æ ¹æ® namespace æ¥ç­›é€‰ APIServer éœ€è¦è½¬å‘çš„è¯·æ±‚ matchPolicy - å®šä¹‰ rule å¦‚ä½•åŒ¹é…è¯·æ±‚ reinvocationPolicy - å®šä¹‰æ˜¯å¦éœ€è¦é‡è·‘ webhookï¼Œåœ¨ object ä¿®æ”¹å failurePolicy - å®šä¹‰è¯·æ±‚å¤±è´¥åçš„è¡Œä¸º ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.1 è¯·æ±‚åŒ¹é…è§„åˆ™ 1.1.1 rules æ¯ä¸ª webhook å¿…é¡»æŒ‡å®šä¸€ç»„ rulesï¼Œç”¨ä»¥è®© APIServer å†³å®šæ˜¯å¦è½¬å‘è¯·æ±‚ç»™ webhook serverã€‚å½“ä¸€ä¸ªè¯·æ±‚èƒ½å¤ŸåŒ¹é… operationã€groupã€versionã€resourceã€scopeï¼Œé‚£ä¹ˆè¯·æ±‚å°±ä¼šè½¬å‘ã€‚ rules:- apiGroups:[\"\"]apiVersions:[\"v1\"]operations:[\"CREATE\"]resources:[\"pods\"]scope:\"Namespaced\" operations - åŒ¹é…è¯·æ±‚çš„æ“ä½œï¼Œæ”¯æŒ CREATE UPDATE DELETE CONNECT * apiGroups - åŒ¹é…è¯·æ±‚çš„æ“ä½œçš„ API Groupï¼Œ\"\" è¡¨ç¤º core APIï¼Œ\"*\" åŒ¹é…æ‰€æœ‰çš„ API Group apiVersions - åŒ¹é… API Group ä¸‹çš„å¤šä¸ªç‰ˆæœ¬ï¼Œ\"*\" åŒ¹é…æ‰€æœ‰ç‰ˆæœ¬ resources - åŒ¹é… API Group ä¸‹å¤šä¸ª resource â€œ*â€ è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ resourceï¼Œä½†æ˜¯ä¸åŒ…å« subresource â€œ*/â€ è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ resource ä¸ subresource â€œpods/â€ è¡¨ç¤ºåŒ¹é… Pod ä¸‹çš„æ‰€æœ‰ subresource â€œ*/statusâ€ è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ resource ä¸‹çš„ status subresource scope - å®šä¹‰éœ€è¦åŒ¹é… resource ä¸ subresource çš„èŒƒå›´ï¼Œæ”¯æŒ Cluster Namespaced * 1.1.2 objectSelector é€šè¿‡ objectSelector æ ¹æ®è¯·æ±‚æ“ä½œçš„ object çš„ label æ¥ç­›é€‰è¯·æ±‚ï¼ŒæˆåŠŸåŒ¹é…çš„è¯·æ±‚æ‰ä¼šè¢«è½¬å‘ã€‚ ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œç»è¿‡ rules åŒ¹é…åçš„è¯·æ±‚ï¼Œè¿˜ä¼šç»è¿‡ objectSelector ç­›é€‰ï¼ˆéœ€è¦åŒ…å« label foo:barï¼‰ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comobjectSelector:matchLabels:foo:barrules:- operations:[\"CREATE\"]apiGroups:[\"*\"]apiVersions:[\"*\"]resources:[\"*\"]scope:\"*\"# ... 1.1.3 namespaceSelector é€šè¿‡ namespaceSelector æ ¹æ®è¯·æ±‚æ“ä½œçš„ object çš„ namespace æ¥ç­›é€‰è¯·æ±‚ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comnamespaceSelector:matchExpressions:- key:runleveloperator:NotInvalues:[\"0\",\"1\"]rules:- operations:[\"CREATE\"]apiGroups:[\"*\"]apiVersions:[\"*\"]resources:[\"*\"]scope:\"Namespaced\"# ... 1.1.4 matchPolicy ä¸€ä¸ªèµ„æºå¯èƒ½å±äºå¤šä¸ª API Groupï¼Œè¿™åœ¨å‡çº§èµ„æºç‰ˆæœ¬æ—¶å¾ˆå¸¸è§ã€‚ä¾‹å¦‚ï¼ŒDeployment æ”¯æŒ extensions/v1beta1ï¼Œapps/v1beta1 ç­‰ã€‚ matchPolicy ç”¨äºå®šä¹‰ rules å¦‚ä½•åŒ¹é…è¯·æ±‚ï¼Œå…¶å€¼å¯ä»¥ä¸ºï¼š Exact - è¡¨ç¤ºè¯·æ±‚éœ€è¦å®Œå…¨åŒ¹é… Equivalentï¼ˆé»˜è®¤å€¼ï¼‰ - è¡¨ç¤ºè¯·æ±‚å¯ä»¥åŒ¹é…ä¸åŒ APIGroup çš„ç›¸åŒèµ„æº ä¾‹å¦‚ä¸‹é¢ç¤ºä¾‹ï¼Œé€šè¿‡ matchPolicy ä¹Ÿå¯ä»¥åŒ¹é… extensions/v1beta1 çš„ Deployment äº†ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:ValidatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.commatchPolicy:Equivalentrules:- operations:[\"CREATE\",\"UPDATE\",\"DELETE\"]apiGroups:[\"apps\"]apiVersions:[\"v1\"]resources:[\"deployments\"]scope:\"Namespaced\"# ... å¦‚ä½•å®ç°çš„ï¼Ÿ è¿™æ˜¯æ ¹æ®èµ„æºç‰ˆæœ¬è½¬æ¢çš„å®ç°ï¼Œå› ä¸º extensions/v1beta1 Deployment åœ¨ APIServer ä¸­ä¼šè¢«è½¬åŒ–ä¸º v1 è¯·æ±‚ï¼Œä»è€Œå¯ä»¥åŒ¹é…åˆ° Webhook è½¬å‘ã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.2 ä¸ Webhook é€šä¿¡æ–¹å¼ 1.2.1 URL URL ä¸ºä¸€ä¸ª webhook server åœ°å€ï¼Œä»¥æ ‡å‡†çš„ URL æ ¼å¼ã€‚ä½†æ˜¯ï¼Œä¸å…è®¸ä½¿ç”¨ç”¨æˆ·æˆ–è€…åŸºæœ¬èº«ä»½è®¤è¯ï¼ˆä¾‹å¦‚ URL ä¸­çš„ user:password@ï¼‰ï¼Œä¹Ÿä¸å…è®¸ URL ä¸­ä½¿ç”¨ # å’Œ ? ä¼ å‚ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comclientConfig:url:\" https://my-webhook.example.com:9443/my-webhook-path\"# ... 1.2.2 Service å¦‚æœ Webhook Server è¿è¡Œåœ¨é›†ç¾¤ä¸­ï¼Œå¯ä»¥æŒ‡å®š Service æ¥è½¬å‘è¯·æ±‚ã€‚å…¶ port é»˜è®¤ä¸º 443ï¼Œpath é»˜è®¤ä¸º â€œ/\"ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comclientConfig:caBundle:\"Ci0tLS0tQk...\u003cbase64-encoded PEM bundle containing the CA that signed the webhook's serving certificate\u003e...tLS0K\"service:namespace:my-service-namespacename:my-service-namepath:/my-pathport:1234# ... ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.3 Side effects æœ‰äº›æƒ…å†µä¸‹ï¼ŒWebhook Server ä¸ä»…ä»…æ˜¯å¤„ç† AdmissionReview å¯¹è±¡ï¼Œè€Œè¦è¿›è¡Œä¸€äº› â€œå¸¦å¤–â€ æ“ä½œï¼ˆæŒ‡æ“ä½œå®é™…çš„èµ„æºï¼‰ï¼Œè¿™ä¹Ÿè¢«ç§°ä¸º Side effectã€‚ sideEffects å­—æ®µç”¨äºæŒ‡å®š Webhook Server èƒ½å¦å¤„ç† dryRun çš„ è¯·æ±‚ï¼ˆdryRun:trueï¼‰ã€‚å€¼å¯ä»¥ä¸ºï¼š Unknown - æœªçŸ¥ï¼Œå¯¹äº dryRun è¯·æ±‚è¦è½¬å‘ç»™ Webhook çš„ï¼Œç›´æ¥è§†ä¸ºè¯·æ±‚å¤±è´¥ã€‚ None - è¡¨æ˜ Webhook æ²¡æœ‰ Side effectã€‚ Some - è¡¨æ˜ Webhook æœ‰ä¸€äº› side effectï¼Œå¯¹äº dryRun è¯·æ±‚è¦è½¬å‘ç»™ Webhook çš„ï¼Œå°†ç›´æ¥è§†ä¸ºè¯·æ±‚å¤±è´¥ã€‚ NoneOnDryRun - è¡¨æ˜ Webhook æœ‰ä¸€äº› side effectï¼Œè€Œ Webhook èƒ½å¤Ÿå¤„ç† dryRun è¯·æ±‚ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:ValidatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comsideEffects:NoneOnDryRun# ... ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.4 Reinvocation policy å¯¹äº Mutating Admission Pluginï¼Œé¡ºåºè°ƒç”¨ä¸é€‚ç”¨äºæ‰€æœ‰çš„æƒ…å†µã€‚å¯èƒ½ Webhook ä¿®æ”¹äº†å¯¹è±¡çš„ç»“æ„ï¼Œä½†æ˜¯å…¶ä»– Mutating Plugin å¯¹äºå…¶æ–°ç»“æ„æ˜¯æ‹’ç»çš„ï¼ˆä½†æ˜¯å…¶å·²ç»è¢«è°ƒç”¨è¿‡äº†ï¼Œå› æ­¤ä¸å†è¢«è°ƒç”¨ï¼‰ã€‚ è€Œ 1.15 åï¼Œå¦‚æœ Mutating Webhook æ›´æ”¹å¯¹è±¡ï¼Œå†…ç½®çš„ Mutating Admission Plugin ä¼šé‡è·‘ã€‚ reinvocationPolicy å­—æ®µå¯ä»¥æ§åˆ¶ Webhook Server åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯å¦éœ€è¦é‡è·‘ã€‚å€¼å¯ä»¥ä¸ºï¼š Never - ä¸€æ¬¡ä¸­ Admission Control ä¸èƒ½å¤šæ¬¡è°ƒç”¨ Webhookã€‚ IfNeeded - Webhook è°ƒç”¨åçš„å¯¹è±¡åˆè¢«å…¶ä»– Admission Plugin ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆ Webhook ä¼šå†æ¬¡é‡è·‘ã€‚ apiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comreinvocationPolicy:IfNeeded# ... ä¸è¿‡éœ€è¦æ³¨æ„ï¼š ä¸ä¿è¯é¢å¤–è°ƒç”¨æ¬¡æ•°æ˜¯ä¸€æ¬¡ å¦‚æœé¢å¤–è°ƒç”¨ï¼Œå¯¼è‡´å¯¹è±¡å†ä¸€æ¬¡è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆä¸ä¿è¯è¿˜ä¼šå†æ¬¡è°ƒç”¨ Webhook ä½¿ç”¨æ­¤é€‰é¡¹çš„ Webhook å¯èƒ½ä¼šè¢«é‡æ–°æ’åºï¼Œä»¥å‡å°‘é¢å¤–è°ƒç”¨æ•°ã€‚ è¦ä¿è¯ä¿®æ”¹åéªŒè¯å¯¹è±¡ï¼Œåº”è¯¥ä½¿ç”¨ Validate Admission Webhook è¿™ä¹Ÿè¡¨æ˜äº†ï¼ŒMutating Webhook å¿…é¡»æ˜¯å¹‚ç­‰çš„ã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:1:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.5 Failure policy failurePolicy å­—æ®µå®šä¹‰äº†ï¼Œå½“ APIServer è¯·æ±‚ Webhook å¤±è´¥åï¼Œå¦‚ä½•å¤„ç†ï¼ˆåŒ…æ‹¬è¶…æ—¶é”™è¯¯ï¼‰ã€‚ Ignore - Webhook è¿”å›çš„é”™è¯¯ä¼šè¢«å¿½ç•¥ï¼ŒAPI è¯·æ±‚ç»§ç»­ Failï¼ˆé»˜è®¤ï¼‰ - Webhook è¿”å›é”™è¯¯ï¼ŒAPI è¯·æ±‚è¢«æ‹’ç» apiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfiguration# ...webhooks:- name:my-webhook.example.comfailurePolicy:Fail# ... ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:1:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 Request ä¸ Response ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.1 Request APIServer å‘é€ POST HTTP è¯·æ±‚ï¼Œå…¶è®¾ç½®äº† HTTP Header ä¸­ Content-Type: application/jsonï¼Œbody å†…å®¹ä¸º AdmissionReview å¯¹è±¡çš„ JSON æ ¼å¼ï¼Œè®¾ç½®äº†å…¶ä¸­çš„ â€œrequestâ€ å­—æ®µã€‚ ä¸‹é¢ç¤ºä¾‹å±•ç¤ºäº†å¯¹äº apps/v1 Deployment scale å­èµ„æºçš„è°ƒç”¨è¯·æ±‚ï¼Œå¯¹åº”çš„ AdmissionReview å¯¹è±¡å†…å®¹ã€‚ { \"apiVersion\": \"admission.k8s.io/v1\", \"kind\": \"AdmissionReview\", \"request\": { # éšæœº uidï¼Œç”¨äºæ ‡è¯†è¿™æ¬¡ admission è°ƒç”¨ \"uid\": \"705ab4f5-6393-11e8-b7cc-42010a800002\", # è¯·æ±‚ä¸­å¯¹è±¡çš„ GVK \"kind\": {\"group\":\"autoscaling\",\"version\":\"v1\",\"kind\":\"Scale\"}, # è¯·æ±‚ä¸­å¯¹è±¡çš„ GVR \"resource\": {\"group\":\"apps\",\"version\":\"v1\",\"resource\":\"deployments\"}, # è¯·æ±‚å¯¹è±¡çš„ subresource \"subResource\": \"scale\", # è¯·æ±‚æºå¯¹è±¡çš„ GVK # å› ä¸º `matchPolicy: Equivalent` å¯èƒ½ä¼šè®©è¯·æ±‚è½¬å˜ï¼Œè€Œè¿™é‡Œä¿å­˜è½¬å˜å‰çš„ GVK \"requestKind\": {\"group\":\"autoscaling\",\"version\":\"v1\",\"kind\":\"Scale\"}, # è¯·æ±‚æºå¯¹è±¡çš„ GVR # å› ä¸º `matchPolicy: Equivalent` å¯èƒ½ä¼šè®©è¯·æ±‚è½¬å˜ï¼Œè€Œè¿™é‡Œä¿å­˜è½¬å˜å‰çš„ GVR # Fully-qualified group/version/kind of the resource being modified in the original request to the API server. # This only differs from `resource` if the webhook specified `matchPolicy: Equivalent` and the # original request to the API server was converted to a version the webhook registered for. \"requestResource\": {\"group\":\"apps\",\"version\":\"v1\",\"resource\":\"deployments\"}, # è¯·æ±‚æºå¯¹è±¡çš„ subresource # å› ä¸º `matchPolicy: Equivalent` å¯èƒ½ä¼šè®©è¯·æ±‚è½¬å˜ï¼Œè€Œè¿™é‡Œä¿å­˜è½¬å˜å‰çš„ subresource \"requestSubResource\": \"scale\", # è¯·æ±‚å¯¹è±¡çš„ name \"name\": \"my-deployment\", # è¯·æ±‚å¯¹è±¡çš„ namespace \"namespace\": \"my-namespace\", # è¯·æ±‚çš„æ“ä½œï¼ŒCREATE UPDATE DELETE CONNECT \"operation\": \"UPDATE\", \"userInfo\": { # APIServer èº«ä»½è®¤è¯çš„ username \"username\": \"admin\", # APIServer èº«ä»½è®¤è¯çš„ uid \"uid\": \"014fbff9a07c\", # APIServer èº«ä»½è®¤è¯çš„ group \"groups\": [\"system:authenticated\",\"my-admin-group\"], # Arbitrary extra info associated with the user making the request to the API server. # This is populated by the API server authentication layer and should be included # if any SubjectAccessReview checks are performed by the webhook. \"extra\": { \"some-key\":[\"some-value1\", \"some-value2\"] } }, # è¯·æ±‚æ“ä½œçš„å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ scheme è§£æä¸ºå…·ä½“çš„ç»“æ„ \"object\": {\"apiVersion\":\"autoscaling/v1\",\"kind\":\"Scale\",...}, # å½“å‰é›†ç¾¤ä¸­çš„å¯¹è±¡ # It is null for CREATE and CONNECT operations. \"oldObject\": {\"apiVersion\":\"autoscaling/v1\",\"kind\":\"Scale\",...}, # æ“ä½œçš„ Optionï¼ŒåŒ…å« CreateOptionsã€UpdateOptionsã€DeleteOptions \"options\": {\"apiVersion\":\"meta.k8s.io/v1\",\"kind\":\"UpdateOptions\",...}, # dryRun è¡¨æ˜è¯·æ±‚æ˜¯å¦æ˜¯ dry run mode # See http://k8s.io/docs/reference/using-api/api-concepts/#make-a-dry-run-request for more details. \"dryRun\": false } } ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.2 Response Webhook server åº”è¯¥è¿”å› 200 HTTP codeï¼Œå¹¶è®¾ç½®äº† HTTP Header ä¸­ Content-Type: application/jsonï¼Œbody å†…å®¹ä¸º AdmissionReview å¯¹è±¡çš„ JSON æ ¼å¼ï¼Œè®¾ç½®äº†å…¶ä¸­çš„ â€œresponseâ€ å­—æ®µã€‚ ä¸åŒçš„æ“ä½œå¯èƒ½æœ‰ç€ä¸åŒçš„ responseï¼Œä¸è¿‡è‡³å°‘å…¶å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š { \"apiVersion\": \"admission.k8s.io/v1\", \"kind\": \"AdmissionReview\", \"response\": { \"uid\": \"\u003cvalue from request.uid\u003e\", \"allowed\": true } } uid - å¤åˆ¶ request.uid allowed - è®¾ç½®ä¸º true æˆ–è€… falseï¼Œè¡¨æ˜å…è®¸æˆ–è€…ç¦æ­¢ æ‹’ç»è¯·æ±‚æ—¶ï¼Œé€šè¿‡ status å­—æ®µå¯ä»¥æä¾›éœ€è¦ APIServer è¿”å›ç»™ client çš„ HTTP code ä¸ messageã€‚ { \"apiVersion\": \"admission.k8s.io/v1\", \"kind\": \"AdmissionReview\", \"response\": { \"uid\": \"\u003cvalue from request.uid\u003e\", \"allowed\": false, \"status\": { \"code\": 403, \"message\": \"You cannot do this because it is Tuesday and your name starts with A\" } } } å¯¹äº MutatingWebhook å¯ä»¥å¯¹å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ˜¯é€šè¿‡ JSON Patch å®ç°çš„ã€‚ { \"apiVersion\": \"admission.k8s.io/v1\", \"kind\": \"AdmissionReview\", \"response\": { \"uid\": \"\u003cvalue from request.uid\u003e\", \"allowed\": true, \"patchType\": \"JSONPatch\", \"patch\": \"W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvcmVwbGljYXMiLCAidmFsdWUiOiAzfV0=\" } } patchType - æŒ‡å®š patch ç±»å‹ï¼Œç›®å‰ä»…ä»…æ”¯æŒ JSONPatch patch - patch æ“ä½œçš„ base64 ç¼–ç ï¼Œç¤ºä¾‹ä¸­ä¸º â€œ[{â€œopâ€: â€œaddâ€, â€œpathâ€: â€œ/spec/replicasâ€, â€œvalueâ€: 3}]â€ 1.19 åï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è¿”å›ä¸€ä¸ª WARN ä¿¡æ¯ï¼Œé€šè¿‡ warnings å­—æ®µã€‚ { \"apiVersion\": \"admission.k8s.io/v1\", \"kind\": \"AdmissionReview\", \"response\": { \"uid\": \"\u003cvalue from request.uid\u003e\", \"allowed\": true, \"warnings\": [ \"duplicate envvar entries specified with name MY_ENV\", \"memory request less than 4MB specified for container mycontainer, which will not start successfully\" ] } } warn ä¿¡æ¯ä¸èƒ½è¶…è¿‡ 120 å­—èŠ‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 ä¸ APIServer çš„é‰´æƒæ–¹å¼ Admission Webhook ä¸ APIServer æ”¯æŒä¸‰ç§é‰´æƒæ–¹å¼ï¼šbasic authã€bearer tokenã€certã€‚ éœ€è¦ä¸‰ä¸ªé˜¶æ®µæ¥è¿›è¡Œé…ç½®ï¼š å¯åŠ¨ APIServer æ—¶ï¼Œé€šè¿‡ \"â€“admission-control-config-fileâ€ å‚æ•°æŒ‡å®š Admission Control é…ç½®æ–‡ä»¶ã€‚ åœ¨ Admission Control é…ç½®æ–‡ä»¶ä¸­ï¼ŒæŒ‡å®š MutatingAdmissionWebhook Controller ä¸ ValidatingAdmissionWebhook Controller è¯»å–çš„è¯ä¹¦ã€‚ åœ¨é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ kubeConfigFile å­—æ®µæŒ‡å®šå¯¹åº”çš„ kubeconfig æ–‡ä»¶ã€‚ apiVersion:apiserver.config.k8s.io/v1kind:AdmissionConfigurationplugins:- name:ValidatingAdmissionWebhookconfiguration:apiVersion:apiserver.config.k8s.io/v1kind:WebhookAdmissionConfigurationkubeConfigFile:\"\u003cpath-to-kubeconfig-file\u003e\"- name:MutatingAdmissionWebhookconfiguration:apiVersion:apiserver.config.k8s.io/v1kind:WebhookAdmissionConfigurationkubeConfigFile:\"\u003cpath-to-kubeconfig-file\u003e\" åœ¨æŒ‡å®šçš„ kubeConfig æ–‡ä»¶ä¸­ï¼Œæä¾›éœ€è¦çš„è¯ä¹¦ apiVersion:v1kind:Configusers:# name should be set to the DNS name of the service or the host (including port) of the URL the webhook is configured to speak to.# If a non-443 port is used for services, it must be included in the name when configuring 1.16+ API servers.## For a webhook configured to speak to a service on the default port (443), specify the DNS name of the service:# - name: webhook1.ns1.svc# user: ...## For a webhook configured to speak to a service on non-default port (e.g. 8443), specify the DNS name and port of the service in 1.16+:# - name: webhook1.ns1.svc:8443# user: ...# and optionally create a second stanza using only the DNS name of the service for compatibility with 1.15 API servers:# - name: webhook1.ns1.svc# user: ...## For webhooks configured to speak to a URL, match the host (and port) specified in the webhook's URL. Examples:# A webhook with `url: https://www.example.com`:# - name: www.example.com# user: ...## A webhook with `url: https://www.example.com:443`:# - name: www.example.com:443# user: ...## A webhook with `url: https://www.example.com:8443`:# - name: www.example.com:8443# user: ...#- name:'webhook1.ns1.svc'user:client-certificate-data:\"\u003cpem encoded certificate\u003e\"client-key-data:\"\u003cpem encoded key\u003e\"# The `name` supports using * to wildcard-match prefixing segments.- name:'*.webhook-company.org'user:password:\"\u003cpassword\u003e\"username:\"\u003cname\u003e\"# '*' is the default match.- name:'*'user:token:\"\u003ctoken\u003e\" Note é…ç½®ä¸­ä»…ä»…é…ç½®äº† client è¯ä¹¦ä¸ç§é’¥ï¼Œè€Œåœ¨ ValidatingWebhookConfiguration/MutatingWebhookConfiguration å®šä¹‰ä¸­æŒ‡å®šäº† CA Bundleï¼Œå³ CA è¯ä¹¦ã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4 å®ç° æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ Webhook Server çš„å®ç°ï¼Œå¹¸è¿çš„æ˜¯ï¼Œå…¶æ¯” Custom APIServer è¦ç®€å•çš„å¤šã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.1 HTTP Server Webhook Server æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª HTTP Serverï¼Œå› æ­¤å…¶ main å‡½æ•°ä¸­ï¼Œä¸»è¦å°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ª HTTP Serverã€‚ func main(cmd *cobra.Command, args []string) { config := Config{ CertFile: certFile, KeyFile: keyFile, } // å®šä¹‰ HTTP handle // ä¸‹é¢æ¯ä¸ª Handle éƒ½æ˜¯ä¸€ä¸ª Admission Webhook // ** åªè¦ä¸€ä¸ª HTTP Endpoint èƒ½å¤Ÿå¤„ç† AdmissionReview å¯¹è±¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½œä¸ºä¸€ä¸ª Admission Webhook ** http.HandleFunc(\"/always-allow-delay-5s\", serveAlwaysAllowDelayFiveSeconds) http.HandleFunc(\"/always-deny\", serveAlwaysDeny) http.HandleFunc(\"/add-label\", serveAddLabel) http.HandleFunc(\"/pods\", servePods) http.HandleFunc(\"/pods/attach\", serveAttachingPods) http.HandleFunc(\"/mutating-pods\", serveMutatePods) http.HandleFunc(\"/mutating-pods-sidecar\", serveMutatePodsSidecar) http.HandleFunc(\"/configmaps\", serveConfigmaps) http.HandleFunc(\"/mutating-configmaps\", serveMutateConfigmaps) http.HandleFunc(\"/custom-resource\", serveCustomResource) http.HandleFunc(\"/mutating-custom-resource\", serveMutateCustomResource) http.HandleFunc(\"/crd\", serveCRD) http.HandleFunc(\"/readyz\", func(w http.ResponseWriter, req *http.Request) { w.Write([]byte(\"ok\")) }) // åˆ›å»ºè¢«å¯åŠ¨ APIServer server := \u0026http.Server{ Addr: fmt.Sprintf(\":%d\", port), TLSConfig: configTLS(config), } err := server.ListenAndServeTLS(\"\", \"\") if err != nil { panic(err) } } ä¸Šé¢çš„ HTTP Server æ³¨å†Œäº†è®¸å¤šçš„ HTTP APIã€‚å› ä¸ºæ¯ä¸ª API éƒ½å¯ä»¥å¤„ç† AdmissionReview è¯·æ±‚ï¼Œæ‰€ä»¥å°±å¯ä»¥ä½œä¸ºä¸€ä¸ª Admission Webhookã€‚å½“å¯¹åº”çš„ Webhook Configuration å®šä¹‰éƒ¨ç½²åï¼Œå°±å¯ä»¥ä½¿ç”¨ã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.2 é€šç”¨å¤„ç†é€»è¾‘ serve æ‰€æœ‰çš„ HTTP Endpoint HandleFunc éƒ½æ˜¯åŸºäº serve çš„è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š func serveAlwaysAllowDelayFiveSeconds(w http.ResponseWriter, r *http.Request) { serve(w, r, newDelegateToV1AdmitHandler(alwaysAllowDelayFiveSeconds)) } å› ä¸ºæ‰€æœ‰çš„ Webhook æœ‰ç€æœ€åŸºæœ¬çš„ç¼–è§£ç çš„é€»è¾‘ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯ç›¸åŒçš„ï¼Œè€Œ server å°±æ˜¯å¤„ç†è¿™éƒ¨åˆ†é€»è¾‘çš„ã€‚ // serve å¤„ç† HTTP è¯·æ±‚ï¼Œä» body ä¸­è§£æå¾—åˆ° AdmissionReviewï¼Œç„¶åè°ƒç”¨ admit å›è°ƒå¤„ç†ï¼Œæœ€åå°†ç»“æœå›å¤ func serve(w http.ResponseWriter, r *http.Request, admit admitHandler) { // read http body var body []byte if r.Body != nil { if data, err := ioutil.ReadAll(r.Body); err == nil { body = data } } // æ£€æŸ¥ Header Content-Typeï¼ŒWebhook åªæ”¯æŒ \"application/json\" contentType := r.Header.Get(\"Content-Type\") if contentType != \"application/json\" { klog.Errorf(\"contentType=%s, expect application/json\", contentType) return } klog.V(2).Info(fmt.Sprintf(\"handling request: %s\", body)) // è§£æ body -\u003e runtime.Object // å› ä¸º AdmissionReview ä¹Ÿæ˜¯ä¸€ä¸ª Kubernetes èµ„æºï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ Kubernetes è¿›è¡Œè§£æ deserializer := codecs.UniversalDeserializer() obj, gvk, err := deserializer.Decode(body, nil, nil) if err != nil { msg := fmt.Sprintf(\"Request could not be decoded: %v\", err) klog.Error(msg) http.Error(w, msg, http.StatusBadRequest) return } // è¿›ä¸€æ­¥å¾—åˆ° Admission Request var responseObj runtime.Object switch *gvk { case v1beta1.SchemeGroupVersion.WithKind(\"AdmissionReview\"): // v1beta1 ç‰ˆæœ¬ AdmissionReview å¯¹è±¡æ”¯æŒ requestedAdmissionReview, ok := obj.(*v1beta1.AdmissionReview) if !ok { klog.Errorf(\"Expected v1beta1.AdmissionReview but got: %T\", obj) return } // å¾—åˆ°çœŸæ­£çš„ v1beta1.AdmissionReview å¯¹è±¡ responseAdmissionReview := \u0026v1beta1.AdmissionReview{} responseAdmissionReview.SetGroupVersionKind(*gvk) // è°ƒç”¨å›è°ƒå¤„ç†ï¼Œè¿”å›å€¼ä¸º AdmissionReview.Response responseAdmissionReview.Response = admit.v1beta1(*requestedAdmissionReview) // è®¾ç½®å¥½ Response responseAdmissionReview.Response.UID = requestedAdmissionReview.Request.UID responseObj = responseAdmissionReview case v1.SchemeGroupVersion.WithKind(\"AdmissionReview\"): // v1 ç‰ˆæœ¬ AdmissionReview å¯¹è±¡æ”¯æŒ requestedAdmissionReview, ok := obj.(*v1.AdmissionReview) if !ok { klog.Errorf(\"Expected v1.AdmissionReview but got: %T\", obj) return } // å¾—åˆ°çœŸæ­£çš„ v1.AdmissionReview å¯¹è±¡ responseAdmissionReview := \u0026v1.AdmissionReview{} responseAdmissionReview.SetGroupVersionKind(*gvk) // è°ƒç”¨å›è°ƒå¤„ç†ï¼Œè¿”å›å€¼ä¸º AdmissionReview.Response responseAdmissionReview.Response = admit.v1(*requestedAdmissionReview) // è®¾ç½®å¥½ Response responseAdmissionReview.Response.UID = requestedAdmissionReview.Request.UID responseObj = responseAdmissionReview default: msg := fmt.Sprintf(\"Unsupported group version kind: %v\", gvk) klog.Error(msg) http.Error(w, msg, http.StatusBadRequest) return } // ç¼–ç  http response klog.V(2).Info(fmt.Sprintf(\"sending response: %v\", responseObj)) respBytes, err := json.Marshal(responseObj) if err != nil { klog.Error(err) http.Error(w, err.Error(), http.StatusInternalServerError) return } // å›å¤ w.Header().Set(\"Content-Type\", \"application/json\") if _, err := w.Write(respBytes); err != nil { klog.Error(err) } } ä»ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥æ€»ç»“å‡ºåŸºæœ¬çš„ Webhook å¤„ç†é€»è¾‘ï¼š è¯»å– HTTP è¯·æ±‚çš„ bodyã€‚ æ£€æŸ¥ HTTP è¯·æ±‚çš„ Content-Type æ˜¯å¦ä¸º application/jsonã€‚ å°† body è§£æä¸º AdmissionReview å¯¹è±¡ã€‚ ä¸šåŠ¡å¤„ç†ï¼Œå¾—åˆ° AdmissionReview Responseã€‚ å°†å›å¤çš„ AdmissionReview å¯¹è±¡ JSON ç¼–ç ã€‚ è®¾ç½®å¥½ Content-Type:application/json åå›å¤ã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.3 ä¸šåŠ¡å¤„ç†é€»è¾‘ admitHandler åœ¨ serve ä¸­çœ‹åˆ°ï¼ŒæŠ½è±¡äº† admitHandler æ¥è¿›è¡Œä¸šåŠ¡é€»è¾‘çš„å¤„ç†ã€‚å…¶åŒ…å«å¤„ç† v1beta1 ä¸ v1 ç‰ˆæœ¬çš„ AdmissionReview å¯¹è±¡çš„å›è°ƒã€‚ // admitv1beta1Func handles a v1beta1 admission type admitv1beta1Func func(v1beta1.AdmissionReview) *v1beta1.AdmissionResponse // admitv1beta1Func handles a v1 admission type admitv1Func func(v1.AdmissionReview) *v1.AdmissionResponse // admitHandler æ˜¯ Webhook handler çš„æŠ½è±¡ï¼Œéœ€è¦èƒ½å¤Ÿå¤„ç† v1beta1 v1 ç‰ˆæœ¬ AdmissionReview å¯¹è±¡ type admitHandler struct { v1beta1 admitv1beta1Func v1 admitv1Func } ä¸ºäº†è®©å¤§éƒ¨åˆ†çš„å¤„ç†å‡½æ•°ä»…ä»…åªéœ€è¦æ”¯æŒ v1 ç‰ˆæœ¬çš„ AdmissionReview å¯¹è±¡ï¼Œå†…ç½®äº† newDelegateToV1AdmitHandler å‡½æ•°ï¼š // newDelegateToV1AdmitHandler è¿”å›èƒ½å¤Ÿè‡ªåŠ¨æ”¯æŒ v1beta1 ç‰ˆæœ¬ AdmissionReview çš„ Handler func newDelegateToV1AdmitHandler(f admitv1Func) admitHandler { return admitHandler{ v1beta1: delegateV1beta1AdmitToV1(f), v1: f, } } func delegateV1beta1AdmitToV1(f admitv1Func) admitv1beta1Func { return func(review v1beta1.AdmissionReview) *v1beta1.AdmissionResponse { in := v1.AdmissionReview{Request: convertAdmissionRequestToV1(review.Request)} // å°† v1beta1 AdmissionReview Request è½¬æ¢ä¸º v1 ç‰ˆæœ¬ out := f(in) return convertAdmissionResponseToV1beta1(out) // å°† v1 AdmissionReview Response è½¬æ¢ä¸º v1beta1 ç‰ˆæœ¬ } } func convertAdmissionRequestToV1(r *v1beta1.AdmissionRequest) *v1.AdmissionRequest { return \u0026v1.AdmissionRequest{ Kind: r.Kind, Namespace: r.Namespace, Name: r.Name, Object: r.Object, Resource: r.Resource, Operation: v1.Operation(r.Operation), UID: r.UID, DryRun: r.DryRun, OldObject: r.OldObject, Options: r.Options, RequestKind: r.RequestKind, RequestResource: r.RequestResource, RequestSubResource: r.RequestSubResource, SubResource: r.SubResource, UserInfo: r.UserInfo, } } func convertAdmissionResponseToV1beta1(r *v1.AdmissionResponse) *v1beta1.AdmissionResponse { var pt *v1beta1.PatchType if r.PatchType != nil { t := v1beta1.PatchType(*r.PatchType) pt = \u0026t } return \u0026v1beta1.AdmissionResponse{ UID: r.UID, Allowed: r.Allowed, AuditAnnotations: r.AuditAnnotations, Patch: r.Patch, PatchType: pt, Result: r.Result, Warnings: r.Warnings, } } é€šè¿‡æä¾›çš„ convert ç›¸å…³å‡½æ•°ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ Webhook ä¸šåŠ¡é€»è¾‘ä»…ä»…åªéœ€è¦æ”¯æŒ v1 AdmissionReview å³å¯ã€‚ ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.4 ä¸šåŠ¡é€»è¾‘ 4.4.1 Validate å¯¹è¯·æ±‚è¿›è¡Œ Validateï¼Œå¹¶å…è®¸è¯·æ±‚ã€‚æ ¸å¿ƒå°±æ˜¯è®¾ç½® Reponse.Allowed å­—æ®µï¼š // alwaysAllowDelayFiveSeconds æ˜¯ä¸€ä¸ª v1 AdmissionReview Handlerï¼Œsleep 5s åè¿”å› allowed response func alwaysAllowDelayFiveSeconds(ar v1.AdmissionReview) *v1.AdmissionResponse { klog.V(2).Info(\"always-allow-with-delay sleeping for 5 seconds\") time.Sleep(5 * time.Second) klog.V(2).Info(\"calling always-allow\") reviewResponse := v1.AdmissionResponse{} reviewResponse.Allowed = true // è®¾ç½® Response.Allowed ä¸º trueï¼Œè¡¨æ˜è¯·æ±‚å…è®¸ reviewResponse.Result = \u0026metav1.Status{Message: \"this webhook allows all requests\"} return \u0026reviewResponse } æ‹’ç»è¯·æ±‚ä¹Ÿæ˜¯ç±»ä¼¼ï¼š // alwaysDeny æ‹’ç»æ‰€æœ‰è¯·æ±‚ func alwaysDeny(ar v1.AdmissionReview) *v1.AdmissionResponse { klog.V(2).Info(\"calling always-deny\") reviewResponse := v1.AdmissionResponse{} reviewResponse.Allowed = false // è¿”å› allowed ä¸º false è¡¨æ˜æ‹’ç»è¯·æ±‚ reviewResponse.Result = \u0026metav1.Status{Message: \"this webhook denies all requests\"} return \u0026reviewResponse } å¤æ‚ä¸€ç‚¹ï¼Œå°±éœ€è¦é€šè¿‡ç¼–ç å™¨å¯¹ Request.Object.Raw è¿›è¡Œè§£æï¼Œå¾—åˆ°ä¸€ä¸ªå…·ä½“çš„ Resource å¯¹è±¡ã€‚ // admitPods æ£€æŸ¥ Pod çš„ image func admitPods(ar v1.AdmissionReview) *v1.AdmissionResponse { // åˆ¤æ–­èµ„æºæ˜¯å¦æ˜¯ Pod klog.V(2).Info(\"admitting pods\") podResource := metav1.GroupVersionResource{Group: \"\", Version: \"v1\", Resource: \"pods\"} if ar.Request.Resource != podResource { err := fmt.Errorf(\"expect resource to be %s\", podResource) klog.Error(err) return toV1AdmissionResponse(err) } // è§£ç ï¼Œè§£æä¸º Pod raw := ar.Request.Object.Raw pod := corev1.Pod{} deserializer := codecs.UniversalDeserializer() if _, _, err := deserializer.Decode(raw, nil, \u0026pod); err != nil { klog.Error(err) return toV1AdmissionResponse(err) } reviewResponse := v1.AdmissionResponse{} reviewResponse.Allowed = true var msg string if v, ok := pod.Labels[\"webhook-e2e-test\"]; ok { if v == \"webhook-disallow\" { reviewResponse.Allowed = false msg = msg + \"the pod contains unwanted label; \" } if v == \"wait-forever\" { reviewResponse.Allowed = false msg = msg + \"the pod response should not be sent; \" \u003c-make(chan int) // Sleep forever - no one sends to this channel } } for _, container := range pod.Spec.Containers { if strings.Contains(container.Name, \"webhook-disallow\") { reviewResponse.Allowed = false msg = msg + \"the pod contains unwanted container name; \" } } if !reviewResponse.Allowed { reviewResponse.Result = \u0026metav1.Status{Message: strings.TrimSpace(msg)} } return \u0026reviewResponse } å¯¹äº Subresource çš„è¯·æ±‚ï¼Œå°±éœ€è¦ç”¨åˆ° Request.SubResourceï¼Œä»¥åŠæ˜ç¡® HTTP body çš„å†…å®¹ï¼š // denySpecificAttachment æ£€æŸ¥ Pod attch å‚æ•° func denySpecificAttachment(ar v1.AdmissionReview) *v1.AdmissionResponse { klog.V(2).Info(\"handling attaching pods\") if ar.Request.Name != \"to-be-attached-pod\" { return \u0026v1.AdmissionResponse{Allowed: true} } // æ£€æŸ¥ Resource ä¸º Pod podResource := metav1.GroupVersionResource{Group: \"\", Version: \"v1\", Resource: \"pods\"} if e, a := podResource, ar.Request.Resource; e != a { err := fmt.Errorf(\"expect resource to be %s, got %s\", e, a) klog.Error(err) return toV1AdmissionResponse(err) } // æ£€æŸ¥è¯·æ±‚çš„ SubResource ä¸º attach if e, a := \"attach\", ar.Request.SubResource; e != a { err := fmt.Errorf(\"expect subresource to be %s, got %s\", e, a) klog.Error(err) return toV1AdmissionResponse(err) } // è§£ç ï¼Œè½¬å˜ä¸º PodAttachOptions raw := ar.Request.Object.Raw podAttachOptions := corev1.PodAttachOptions{} deserializer := codecs.UniversalDeserializer() if _, _, err := deserializer.Decode(raw, nil, \u0026podAttachOptions); err != nil { klog.Error(err) return toV1AdmissionResponse(err) } // validate klog.V(2).Info(fmt.Sprintf(\"podAttachOptions=%#v\\n\", podAttachOptions)) if !podAttachOptions.Stdin || podAttachOptions.Container != \"container1\" { return \u0026v1.AdmissionResponse{Allowed: true} } return \u0026v1.AdmissionResponse{ Allowed: false, Result: \u0026metav1.Status{ Message: \"attaching to pod 'to-be-attached-pod' is not allowed\", }, } } 4.4.2 Mutate Mutate å¯ä»¥åœ¨ Validate åŸºç¡€ä¸Šå¯ä»¥å¯¹å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œæ ¸å¿ƒæ˜¯è®¾ç½®å¥½ Response.Patch ä¸ Response.PatchType å­—æ®µã€‚ const ( podsInitContainerPatch string = `[ {\"op\":\"add\",\"path\":\"/spec/initContainers\",\"value\":[{\"image\":\"webhook-added-image\",\"name\":\"webhook-adde","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ ã€ŠProgramming Kubernetesã€‹ Dynamic Admission Control ","date":"2021-09-21","objectID":"/posts/cloud_computing/k8s_programming/7-admission-webhook/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 7 - Admission Webhook","uri":"/posts/cloud_computing/k8s_programming/7-admission-webhook/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ Custom APIServer å¯ä»¥ä½œä¸º CRD çš„æ›¿ä»£å“ï¼Œå®ƒå¯ä»¥åƒ Kubernetes çš„åŸç”Ÿçš„ APIServer ä¸€æ ·ä¸º API Group æä¾›æœåŠ¡ã€‚ ä¸‹é¢ä»£ç éƒ½æ¥è‡ªäº kubernetes/sample-apiserverï¼Œè¿™æ˜¯å®˜æ–¹çš„ Custom APIServer çš„ç¤ºä¾‹ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 Custom APISever çš„é€‚ç”¨åœºæ™¯ è‡ªå®šä¹‰ APIServer ä»¥ä¸€å®šå¼€å‘ä¸ä½¿ç”¨å¤æ‚æ€§çš„ä»£ä»·ï¼Œè€Œåšåˆ°ååˆ†çµæ´»çš„åŠŸèƒ½ã€‚æˆ‘ä»¬é€šè¿‡å¯¹æ¯” CRD ä¸ APIServer æ¥çœ‹ä¸€ä¸‹å…¶ç‰¹æœ‰çš„å¥½å¤„ï¼š CRD çš„ç¼ºé™·ï¼š åªèƒ½ä½¿ç”¨ Kubernetes ä½¿ç”¨çš„å­˜å‚¨æ–¹å¼ï¼ˆé»˜è®¤ etcdï¼‰ ä¸æ”¯æŒ protobufï¼Œåªæ”¯æŒ JSON ä»…ä»…æ”¯æŒ /status å’Œ /scale ä¸¤ç§å­èµ„æº ä¸æ”¯æŒå¹³æ»‘åˆ é™¤ï¼Œä½ éœ€è¦é  Finalizer æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¡Œä¸º æ˜¾è‘—å¢åŠ äº† Kubernetes APIServer çš„ CPU è´Ÿè½½ï¼Œå› ä¸ºæ‰€æœ‰ç®—æ³•éƒ½ç”¨ä¸€ä¸ªé€šç”¨æ–¹å¼å®ç° å¯¹ API HTTP Endpoint ä»…ä»…å®ç°äº†æ ‡å‡†çš„ CRUD è¯­ä¹‰ï¼Œä¸èƒ½æ‰©å±• ä¸æ”¯æŒèµ„æºå…±æ –ï¼ˆå³ä¸åŒ APIGroup çš„èµ„æºæˆ–ä¸åŒåå­—çš„èµ„æºåœ¨åº•å±‚å…±æ –å­˜å‚¨ï¼‰ APIServer å¯ä»¥å®ç°ï¼š å¯ä»¥ä½¿ç”¨ä»»ä½•å­˜å‚¨ä½œä¸ºåç«¯å­˜å‚¨ å¯ä»¥å®ç° Protobuf æ”¯æŒ å¯ä»¥æä¾›ä»»æ„è‡ªå®šä¹‰çš„å­èµ„æºï¼Œä¾‹å¦‚ /execã€/logsã€/port-forward ç­‰ å¯ä»¥å®ç°å¹³æ»‘åˆ é™¤é€»è¾‘ å¯ä»¥ç”¨ Go é«˜æ•ˆçš„å®ç°æ‰€æœ‰æ“ä½œï¼ŒåŒ…æ‹¬éªŒè¯ã€å‡†å…¥å’Œè½¬æ¢ å¯ä»¥è‡ªå®šä¹‰è¯­ä¹‰ï¼Œå³å®šä¹‰ CRUD ä¹‹å¤–çš„ API å¯ä»¥ä¸ºç›¸åŒå­˜å‚¨æœºåˆ¶çš„ä¸åŒ APIGroup æˆ–ä¸åŒåç§°èµ„æºæä¾›æœåŠ¡ï¼Œä¾‹å¦‚ Deployment æœ€åˆå­˜å‚¨åœ¨ extension/v1 ç»„ï¼Œåæ¥æŒªåˆ°äº† apps/v1 ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 æ¶æ„ è‡ªå®šä¹‰ APIServer æ˜¯ä¸º APIGroup æä¾›æœåŠ¡çš„è¿›ç¨‹ï¼Œé€šå¸¸ä¼šä½¿ç”¨ k8s.io/apiserver è¿™ä¸ªåº“æ¥å®ç°ã€‚ è‡ªå®šä¹‰ APIServer å¯ä»¥åœ¨ Kubernetes é›†ç¾¤å†…è¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨é›†ç¾¤å¤–è¿è¡Œã€‚é€šå¸¸å®ƒä»¬è¿è¡Œåœ¨ Pod ä¸­ï¼Œå¹¶é€šè¿‡ Service æä¾›æœåŠ¡ã€‚ Kubernetes åŸç”Ÿçš„ APIServer ç§°ä¸º kube-apiserverã€‚å½“ client è¯·æ±‚è‡ªå®šä¹‰ APIServer æ—¶ï¼Œè¯·æ±‚é¦–å…ˆä¼šè®¿é—® kube-apiserverï¼Œç„¶åç”±å…¶è½¬å‘ç»™è‡ªå®šä¹‰ APIServerã€‚è¿™ä¹Ÿä»£è¡¨äº†ï¼Œkube-apiserver çŸ¥é“æ‰€æœ‰çš„è‡ªå®šä¹‰ APIServerã€‚ åœ¨ kube-apiserver å®ç°ä¸­ï¼Œè¿™ä¸ªè½¬å‘ä»£ç†çš„ç»„ä»¶ç§°ä¸º kube-aggregatorï¼Œä»£ç† API è¯·æ±‚çš„è¿‡ç¨‹ç§°ä¸º API Aggregateã€‚ å‘è‡ªå®šä¹‰ APIServer å‘èµ·è¯·æ±‚çš„è¿‡ç¨‹å¦‚ä¸‹ï¼ˆä¸‹å›¾ä¸­æœ€å·¦ä¾§çš„æµç¨‹ï¼‰ï¼š kube-apiserver æ”¶åˆ°è¯·æ±‚ã€‚ è¯·æ±‚ç»è¿‡å¤„ç†é“¾å¤„ç†ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€å®¡è®¡æ—¥å¿—ã€åˆ‡æ¢ç”¨æˆ·ã€é™æµã€æˆæƒç­‰æµç¨‹ã€‚ kube-apiserver å¯¹ç›¸å…³ /apis/\u003caggregate-API-group-name\u003e HTTP Path ä¸‹çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªã€‚ å°†æ‹¦æˆªä¸‹æ¥çš„è¯·æ±‚è½¬å‘ç»™è‡ªå®šä¹‰ APIServerã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œkube-aggregator æä¾›ä¸¤ç§åŠŸèƒ½ï¼š Proxy - å¯ä»¥ä¸ºæŸä¸ª HTTP Path ä¸‹çš„ä¸€ä¸ªç‰¹å®šç‰ˆæœ¬æä¾›ä»£ç†æœåŠ¡ï¼Œä¾‹å¦‚ \"/apis/group-name/version\" Discovery - kube-aggregator å¯ä»¥ä¸ºæ‰€æœ‰èšåˆçš„ APIServer æä¾› Discovery Endpointï¼Œä¹Ÿæ˜¯å°±è¯´ï¼Œä½ å¯ä»¥é€šè¿‡ \"/apis\" å’Œ \"/apis/group-name\" æ‰¾åˆ°æ‰€æœ‰çš„è‡ªå®šä¹‰ APIServerã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.1 APIService å¦‚åŒ CRD ä¸€æ ·ï¼Œä¸ºäº†è®© Kubernetes APIServer çŸ¥é“ä¸€ä¸ªè‡ªå®šä¹‰ APIServer çš„å­˜åœ¨ï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ª APIService å¯¹è±¡ã€‚ apiVersion:apiregistration.k8s.io/v1kind:APIService metadata:name:name spec:group:API-group-name version:API-group-version service:namespace:custom-API-server-service-namespace name:API-server-serviceport:1234caBundle:base64-caBundlegroupPriorityMinimum:2000versionPriority:20 spec.service - æŒ‡å®šè‡ªå®šä¹‰ APIServer çš„ serviceï¼Œå¯ä»¥æ˜¯é›†ç¾¤å†…æ™®é€šçš„ ClusterIP Serviceï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨çš„ ExternalName Serviceã€‚ spec.caBundle - ç”¨äºè®¾ç½®è®¿é—®è‡ªå®šä¹‰ APIServer æ‰€éœ€è¦çš„è¯ä¹¦ã€‚ spec.groupPriorityMinimum - Group çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœå¤šä¸ªä¸åŒç‰ˆæœ¬ APIService è®¾ç½®äº†ä¸åŒçš„å€¼ï¼Œå€¼æœ€å¤§çš„ä¼šå®é™…ç”Ÿæ•ˆã€‚ å¦‚æœå­˜åœ¨å†²çªçš„èµ„æºåç§°æˆ–è€…çŸ­åç§°ï¼Œåˆ™æ‹¥æœ‰æœ€å¤§ groupPriorityMinimum å€¼çš„èµ„æºä¼šç”Ÿæ•ˆã€‚ spec.versionPriority - ç»™ Group ä¸‹å„ä¸ªç‰ˆæœ¬æ’åºï¼Œç”¨äºå†³å®šå®¢æˆ·ç«¯ä¼˜å…ˆä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ã€‚ ä¸‹é¢æ˜¯ Kubernetes API ç»„çš„ groupPriorityMinimum å€¼ï¼š var apiVersionPriorities = map[schema.GroupVersion]priority{ {Group: \"\", Version: \"v1\"}: {group: 18000, version: 1}, // to my knowledge, nothing below here collides {Group: \"apps\", Version: \"v1\"}: {group: 17800, version: 15}, {Group: \"events.k8s.io\", Version: \"v1\"}: {group: 17750, version: 15}, {Group: \"events.k8s.io\", Version: \"v1beta1\"}: {group: 17750, version: 5}, {Group: \"authentication.k8s.io\", Version: \"v1\"}: {group: 17700, version: 15}, {Group: \"authorization.k8s.io\", Version: \"v1\"}: {group: 17600, version: 15}, {Group: \"autoscaling\", Version: \"v1\"}: {group: 17500, version: 15}, {Group: \"autoscaling\", Version: \"v2beta1\"}: {group: 17500, version: 9}, {Group: \"autoscaling\", Version: \"v2beta2\"}: {group: 17500, version: 1}, {Group: \"batch\", Version: \"v1\"}: {group: 17400, version: 15}, {Group: \"batch\", Version: \"v1beta1\"}: {group: 17400, version: 9}, {Group: \"batch\", Version: \"v2alpha1\"}: {group: 17400, version: 9}, {Group: \"certificates.k8s.io\", Version: \"v1\"}: {group: 17300, version: 15}, {Group: \"networking.k8s.io\", Version: \"v1\"}: {group: 17200, version: 15}, {Group: \"policy\", Version: \"v1\"}: {group: 17100, version: 15}, {Group: \"policy\", Version: \"v1beta1\"}: {group: 17100, version: 9}, {Group: \"rbac.authorization.k8s.io\", Version: \"v1\"}: {group: 17000, version: 15}, {Group: \"storage.k8s.io\", Version: \"v1\"}: {group: 16800, version: 15}, {Group: \"storage.k8s.io\", Version: \"v1beta1\"}: {group: 16800, version: 9}, {Group: \"storage.k8s.io\", Version: \"v1alpha1\"}: {group: 16800, version: 1}, {Group: \"apiextensions.k8s.io\", Version: \"v1\"}: {group: 16700, version: 15}, {Group: \"admissionregistration.k8s.io\", Version: \"v1\"}: {group: 16700, version: 15}, {Group: \"scheduling.k8s.io\", Version: \"v1\"}: {group: 16600, version: 15}, {Group: \"coordination.k8s.io\", Version: \"v1\"}: {group: 16500, version: 15}, {Group: \"node.k8s.io\", Version: \"v1\"}: {group: 16300, version: 15}, {Group: \"node.k8s.io\", Version: \"v1alpha1\"}: {group: 16300, version: 1}, {Group: \"node.k8s.io\", Version: \"v1beta1\"}: {group: 16300, version: 9}, {Group: \"discovery.k8s.io\", Version: \"v1\"}: {group: 16200, version: 15}, {Group: \"discovery.k8s.io\", Version: \"v1beta1\"}: {group: 16200, version: 12}, {Group: \"flowcontrol.apiserver.k8s.io\", Version: \"v1beta1\"}: {group: 16100, version: 12}, {Group: \"flowcontrol.apiserver.k8s.io\", Version: \"v1alpha1\"}: {group: 16100, version: 9}, {Group: \"internal.apiserver.k8s.io\", Version: \"v1alpha1\"}: {group: 16000, version: 9}, // Append a new group to the end of the list if unsure. // You can use min(existing group)-100 as the initial value for a group. // Version can be set to 9 (to have space around) for a new group. } æ›¿æ¢åŸç”Ÿçš„ API å¦‚æœä½ æ›¿æ¢åŸç”Ÿçš„ API Groupï¼Œå°±å¯ä»¥å¯¹è‡ªå®šä¹‰ APIService æŒ‡å®šä¸ºæ¯”ä¸Šè¡¨ä¸­æ›´ä½çš„ä¼˜å…ˆçº§å®ç°ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.2 Custom APIServer çš„å†…éƒ¨æ¶æ„ Custom APIServer å¤§ä½“ä¸Šä¸ Kubernetes APIServer ç›¸åŒï¼Œä¸è¿‡æ²¡æœ‰åµŒå…¥ kube-aggregator å’Œ apiextension-apiserverã€‚ æ€»ç»“ä¸€ä¸‹è‡ªå®šä¹‰ APIServer çš„ç‰¹ç‚¹ï¼š ä¸ Kubernetes APIServer å†…éƒ¨ç»“æ„ä¸€è‡´ã€‚ æ‹¥æœ‰è‡ªå·±çš„å¤„ç†é“¾ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€å®¡è®¡ã€åˆ‡æ¢ç”¨æˆ·ç­‰ æ‹¥æœ‰è‡ªå·±çš„èµ„æºå¤„ç†æµæ°´çº¿ï¼ŒåŒ…æ‹¬è§£ç ã€è½¬æ¢ã€å‡†å…¥ã€REST æ˜ å°„å’Œç¼–ç ã€‚ ä¼šè°ƒç”¨ Webhookã€‚ å¯ä»¥å†™ etcdï¼Œæˆ–è€…å…¶ä»–çš„åç«¯å­˜å‚¨ã€‚ æ‹¥æœ‰è‡ªå·±çš„ Scheme å¹¶å®ç°äº†è‡ªå®šä¹‰ API ç»„çš„ Registryã€‚ å†æ¬¡è¿›è¡Œèº«ä»½è®¤è¯ã€‚é€šå¸¸ä¼šå‘é€ä¸€ä¸ª TokenAccessReview è¯·æ±‚å¯¹ Kubernetes APIServer å›è°ƒï¼Œå®ç°åŸºäº client çš„è¯ä¹¦è®¤è¯å’Œ token è®¤è¯ã€‚ è‡ªå·±è¿›è¡Œå®¡è®¡ã€‚ ä½¿ç”¨ SubjectAccessReview è¯·æ±‚ Kubernetes APIServer å®Œæˆæˆæƒã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.3 èº«ä»½è®¤è¯æœºåˆ¶ Custom APIServer çš„å¤„ç†åœ¨äº Kubernetes APIServer ä¹‹åï¼Œæ‰€ä»¥ Kubernetes APIServer ä¼šå…ˆå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯ï¼Œé€šè¿‡åå†è½¬å‘ç»™è‡ªå®šä¹‰ APIServerã€‚ Kubernetes APIServer ä¼šå°†èº«ä»½è®¤è¯çš„ç»“æœä¿å­˜åœ¨ HTTP è¯·æ±‚å¤´é‡Œï¼Œé€šå¸¸æ˜¯ X-Remote-User å’Œ X-Remote-Group Headã€‚ Note é€šè¿‡ APIServer çš„å¯åŠ¨å‘½ä»¤å‚æ•° \"â€“requestheader-username-headers\" å’Œ \"â€“requestheader-group-headers\" å¯ä»¥é…ç½®ã€‚ ä¸ºäº†è®© Custom APIServer ä¿¡ä»»è¿™ä¸¤ä¸ª HTTP Headï¼ŒCustom APIServer ä¼šéªŒè¯å‘é€è¯·æ±‚è€…çš„ CAã€‚å› æ­¤ï¼Œéœ€è¦é€šè¿‡ä¸€ä¸ª ConfigMap é…ç½® Kubernetes APIServer çš„è¯ä¹¦ï¼Œè¯ä¹¦è¦ä¸ Custom APIServer ç›¸åŒçš„æ ¹è¯ä¹¦ç­¾åï¼š apiVersion:v1 kind:ConfigMap metadata:name:extension-apiserver-authentication namespace:kube-system data:client-ca-file:| -----BEGIN CERTIFICATE----- ... -----END CERTIFICATE----- requestheader-allowed-names:'[\"aggregator\"]'requestheader-client-ca-file:| -----BEGIN CERTIFICATE----- ... -----END CERTIFICATE----- requestheader-extra-headers-prefix:'[\"X-Remote-Extra-\"]'requestheader-group-headers:'[\"X-Remote-Group\"]'requestheader-username-headers:'[\"X-Remote-User\"]' è¿™æ ·è®¤è¯çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š Kubernetes APIServer å°±ä¼šä½¿ç”¨ data.client-ca-file æŒ‡å®šçš„å®¢æˆ·ç«¯è¯ä¹¦å‘èµ·è¯·æ±‚ï¼Œè¿›è¡Œ â€œé¢„è®¤è¯â€ é¢„è®¤è¯åéœ€è¦é€šè¿‡ data.requestheader-client-ca-file è¯ä¹¦å‘èµ·è½¬å‘è¯·æ±‚ï¼ŒåŒæ—¶è®¾ç½®å¥½ç›¸å…³çš„ Headã€‚ æœ€åï¼ŒCustom APIServer ä¼šé€šè¿‡ TokenAccessReview çš„æœºåˆ¶å‘é€ Bearer Tokenï¼ˆé€šè¿‡ HTTP Headï¼šAuthorization: bearer tokenï¼‰ç»™ Kubernetes APIServer æ¥éªŒè¯æ˜¯å¦åˆæ³•ã€‚ Note ä¸Šé¢è¿™äº›è¿‡ç¨‹ä¸»è¦æ˜¯ç”± k8s.io/apiserver åº“è‡ªåŠ¨å®Œæˆï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½®å¥½è¯ä¹¦ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.4 æˆæƒ å®Œæˆèº«ä»½è®¤è¯åï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦æˆæƒï¼ŒKubernetes çš„æˆæƒæœºåˆ¶æ˜¯åŸºäº RBAC æ¥å®Œæˆçš„ã€‚ RBAC å°†èº«ä»½æ˜ å°„åˆ°è§’è‰²ï¼Œå†å°†è§’è‰²æ˜ å°„åˆ°æˆæƒè§„åˆ™ï¼Œæˆæƒè§„åˆ™æœ€ç»ˆå†³å®šæ¥å—æˆ–è€…æ‹’ç»è¯·æ±‚ã€‚æˆ‘ä»¬éœ€è¦ç†è§£ï¼Œè‡ªå®šä¹‰ APIServer æ˜¯é€šè¿‡ SubjectAccessReview ä»£ç†æˆæƒæ¥å¯¹è¯·æ±‚æˆæƒçš„ï¼Œå®ƒè‡ªèº«ä¸ä¼šå¤„ç† RBAC è§„åˆ™ï¼Œè€Œæ˜¯å§”æ‰˜ç»™ Kubernetes APIServer å®Œæˆçš„ã€‚ ä¸ºäº†ä»€ä¹ˆéœ€è¦ APIServer æˆæƒ ç”±äºå¯èƒ½å‘é€ç»™ Custom APIServer çš„è¯·æ±‚æ˜¯æ²¡æœ‰ç»è¿‡æˆæƒçš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ Kubernetes APIServer æ¥è¿›è¡Œæˆæƒã€‚ è‡ªå®šä¹‰ APIServer ä¼šå‘é€ä¸€ä¸ª SubjectAccessReview è¯·æ±‚åˆ° Kubernetes APIServerã€‚ apiVersion:authorization.k8s.io/v1 kind:SubjectAccessReview spec:resourceAttributes:group:apps resource:deployments verb:create namespace:default version:v1 name:example user:michael groups:- system:authenticated - admins - authors Kubernetes APIServer æ”¶åˆ°è¯·æ±‚åï¼Œå°†åŸºäº RBAC è§„åˆ™è¿›è¡Œåˆ¤å®šï¼Œç»“æœè¿˜æ˜¯è¿”å›ä¸€ä¸ª SubjectAccessReview å¯¹è±¡ã€‚å…¶ä¸­ï¼Œä¼šè®¾ç½®å…³é”®çš„ status å­—æ®µã€‚ apiVersion:authorization.k8s.io/v1 kind:SubjectAccessReview status:allowed:truedenied:falsereason:\"rule foo allowed this request\" status.allowed - è¡¨æ˜æ˜¯å¦å…è®¸ status.denied - è¡¨æ˜æ˜¯å¦æ‹’ç»è¯·æ±‚ Note allowed ä¸ denied å¯èƒ½åŒæ—¶ä¸º falseï¼Œè¿™è¡¨æ˜ Kubernetes APIServer æ— æ³•å¯¹è¯·æ±‚åšå‡ºåˆ¤æ–­ã€‚è¿™åº”è¯¥ä¾é è‡ªå®šä¹‰ APIServer é‡Œçš„æƒé™é€»è¾‘è¿›è¡Œåˆ¤æ–­ã€‚ æ³¨æ„ï¼Œå¤„äºæ€§èƒ½æ–¹é¢è€ƒè™‘ï¼Œå§”æ‰˜æˆæƒæœºåˆ¶åœ¨æ¯ä¸ª Custom APIServer ä¸­éƒ½ç»´æŠ¤äº†ä¸€ä¸ªæœ¬åœ°ç¼“å­˜ï¼š é»˜è®¤ç¼“å­˜ 1024 ä¸ªæˆæƒæ¡ç›®ã€‚ æ‰€æœ‰é€šè¿‡çš„æˆæƒè¯·æ±‚ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 5minã€‚ æ‰€æœ‰æ‹’ç»çš„æˆæƒè¯·æ±‚ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 30sã€‚ Note å¯ä»¥é€šè¿‡ \"â€“authorization-webhook-cache-authorized-ttl\" å’Œ \"â€“authorization-webhook-cache-unauthorized-ttl\" æ¥è¿›è¡Œé…ç½®ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 å¤šç‰ˆæœ¬ç±»å‹å®ç° ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.1 å¤„ç†æµç¨‹ æ¯ä¸ª APIServer éƒ½å¯ä»¥æä¾›å¤šä¸ªèµ„æºå’Œç‰ˆæœ¬çš„æ¥å£ã€‚ä¸ºäº†è®©ä¸€ä¸ªèµ„æºçš„å¤šç‰ˆæœ¬å…±å­˜ç§°ä¸ºå¯èƒ½ï¼ŒAPIServer éœ€è¦å°†èµ„æºåœ¨å¤šä¸ªç‰ˆæœ¬ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ APIServer åœ¨çœŸæ­£å®ç° API é€»è¾‘æ—¶ï¼Œä¼šä½¿ç”¨ä¸€ä¸ª å†…éƒ¨ç‰ˆæœ¬internal versionï¼Œä¹Ÿç§°ä¸º ä¸­æ¢ç‰ˆæœ¬hub versionã€‚å®ƒå¯ä»¥ç”¨ä½œæ¯ä¸ªç‰ˆæœ¬éƒ½å¯ä»¥ä¸ä¹‹è½¬æ¢çš„ä¸­é—´ç‰ˆæœ¬ï¼Œæ‰€ä»¥å†…éƒ¨ API é€»è¾‘éƒ½æ˜¯æ ¹æ®ä¸­æ¢ç‰ˆæœ¬å®ç°çš„ã€‚ æ‰€ä»¥ï¼ŒAPIServer ä¸­å­˜åœ¨ä¸‰ä¸ªç‰ˆæœ¬çš„æ¦‚å¿µï¼š External Version - èƒ½å¤Ÿå¤„ç†çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚ v1beta1 v1 ç­‰ï¼› Internal Version - ç”¨äº External Version ä¹‹é—´è½¬æ¢çš„ä¸­é—´ç‰ˆæœ¬ï¼› Storage Version - ä¿å­˜åˆ°åç«¯å­˜å‚¨ï¼ˆetcdï¼‰çš„ç‰ˆæœ¬ï¼Œå±äº External Version å…¶ä¸­ä¸€ä¸ªï¼ˆé€šè¿‡ CRD å®šä¹‰è®¾ç½®ï¼‰ï¼› ä¸‹å›¾å±•ç¤ºäº† APIServer åœ¨ä¸€ä¸ª API è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¸‰ä¸ªç‰ˆæœ¬ä¹‹é—´çš„è½¬æ¢æƒ…å†µï¼š ç”¨æˆ·å‘é€ä¸€ä¸ªç‰¹å®šç‰ˆæœ¬çš„è¯·æ±‚ï¼ˆä¾‹å¦‚ v1ï¼Œä½†æ˜¯å¯ä»¥æ˜¯ä»»ä½•æ”¯æŒçš„ç‰ˆæœ¬ï¼‰ã€‚[External Version] APIServer å°†è¯·æ±‚è§£ç ï¼Œå¹¶è½¬æ¢ä¸ºå†…éƒ¨ç‰ˆæœ¬ã€‚[External Version -\u003e Internal Version] APIServer å¯¹å†…éƒ¨ç‰ˆæœ¬è¿›è¡Œå‡†å…¥æ£€æµ‹ä¸éªŒè¯ã€‚[Internal Version] æ³¨å†Œè¡¨ä¸­çš„ API é€»è¾‘éƒ½æ˜¯ä½¿ç”¨å†…éƒ¨ç‰ˆæœ¬çš„ã€‚[Internal Version] etcd è¯»å†™æˆ–å†™å…¥ç‰¹å®šç‰ˆæœ¬å¯¹è±¡ï¼ˆä¾‹å¦‚ä½¿ç”¨ v2 ä½œä¸ºå­˜å‚¨ç‰ˆæœ¬ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒéœ€è¦ä¸å†…éƒ¨ç‰ˆæœ¬è¿›è¡Œäº’è½¬ã€‚[Internal Version -\u003e Storage Version] ç»“æœè½¬æ¢ä¸ºè¯·æ±‚ä¸­çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚ v1ã€‚[Internal Version -\u003e External Version] ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ¬¡å†™è¯·æ±‚æ“ä½œä¸­ï¼Œè‡³å°‘è¦åšä¸‰æ¬¡è½¬æ¢ï¼ˆæ­¥éª¤ 2 5 6ï¼‰ã€‚å¦‚æœéƒ¨ç½²äº† admission webhookï¼Œè¿˜ä¼šå‘ç”Ÿæ›´å¤šæ¬¡çš„è½¬æ¢ã€‚ é™¤äº†è½¬æ¢ï¼Œä¸‹å›¾ä¸­å±•ç¤ºäº†é»˜è®¤å€¼ä¼šä½•æ—¶å¤„ç†ï¼ŒDefault å¡«å……æœªè®¾ç½®å€¼å­—æ®µçš„è¿‡ç¨‹ã€‚é»˜è®¤å€¼å¤„ç†æ€»æ˜¯å’Œè½¬æ¢ä¸€èµ·å‡ºç°ï¼Œå¹¶ä¸”æ€»æ˜¯åœ¨ç”¨æˆ·è¯·æ±‚ã€etcd æˆ–è€… admission webhook æ—¶çš„ External Version è¿›è¡Œï¼ˆä¹Ÿå°±æ˜¯åªåœ¨External Version è½¬æ¢åˆ° Internal Version æ—¶è¿›è¡Œï¼‰ï¼Œä¸ä¼šå‘ç”Ÿåœ¨ä¸­æ¢ç‰ˆæœ¬å‘å¤–éƒ¨ç‰ˆæœ¬è½¬æ¢è¿‡ç¨‹ä¸­ã€‚ Note å¯ä»¥çœ‹åˆ°ï¼Œè½¬æ¢æ˜¯è‡³å…³é‡è¦çš„ï¼Œæ‰€æœ‰çš„ä¸¤ä¸ªæ–¹å‘çš„è½¬æ¢éƒ½å¿…é¡»æ˜¯æ­£ç¡®çš„ï¼Œå³æ˜¯ åŒç¨‹çš„roundtrippableã€‚roundtrippable æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¯¹ä»»æ„çš„å€¼åœ¨æ•´ä¸ªç‰ˆæœ¬ä¸­æ¥å›è½¬æ¢ï¼Œè€Œä¸ä¸¢å¼ƒä»»ä½•ä¿¡æ¯ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.2 Internal Version ç±»å‹å®ç° æˆ‘ä»¬çœ‹ä¸‹ Internal Version å®ç°ï¼Œä½äº â€œpkg/apis/\u003cgroup\u003e/types.goâ€ æ–‡ä»¶ä¸­ï¼š // +genclient // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object type Flunder struct { metav1.TypeMeta metav1.ObjectMeta Spec FlunderSpec Status FlunderStatus } // +genclient // +genclient:nonNamespaced // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // Fischer is an example type with a list of disallowed Flunder.Names type Fischer struct { metav1.TypeMeta metav1.ObjectMeta // DisallowedFlunders holds a list of Flunder.Names that are disallowed. DisallowedFlunders []string } // ... æ²¡æœ‰æ ‡ç­¾ æ³¨æ„ï¼ŒInternal Version ç±»å‹æ˜¯æ²¡æœ‰ JSON å’Œ protobuf æ ‡ç­¾çš„ã€‚å› ä¸º JSON æ ‡ç­¾ä¼šè¢«ä¸€äº›ç”Ÿæˆå™¨ç”¨äºæ¢æµ‹ä¸€ä¸ª types.go æ–‡ä»¶æ˜¯å¯¹åº”å†…éƒ¨ç‰ˆæœ¬è¿˜æ˜¯å¤–éƒ¨ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸èƒ½åŒ…å«æ ‡ç­¾ã€‚ åœ¨å°† Internal Version ç±»å‹æ³¨å†Œåˆ° Scheme æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶æ³¨å†Œçš„ GroupVersion æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ runtime.APIVersionInternalï¼š var SchemeGroupVersion = schema.GroupVersion{Group: GroupName, Version: runtime.APIVersionInternal} // Adds the list of known types to the given scheme. func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes(SchemeGroupVersion, \u0026Flunder{}, \u0026FlunderList{}, \u0026Fischer{}, \u0026FischerList{}, ) return nil } é™¤äº†åŸºæœ¬çš„ç±»å‹ä¸å¯¹åº”çš„ DeepCopy ç›¸å…³çš„å®ç°ï¼ŒInternal Version ç±»å‹ä¸éœ€è¦æ›´å¤šçš„ä»£ç å®ç°äº†ã€‚Convert ä¸ Default ç›¸å…³éƒ½æ˜¯é’ˆå¯¹ç‰¹å®šçš„External Version ç±»å‹éœ€è¦å®ç°çš„ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.3 External Version ç±»å‹å®ç° åœ¨ sample-apiserver ä¸­å®ç°äº† v1alpha1 v1beta1 ä¸¤ä¸ª External Versionã€‚æˆ‘ä»¬ä»¥ v1alpha1 ç‰ˆæœ¬ä¸»è¦è¯´æ˜ã€‚ ä¸€ä¸ª External Version ç±»å‹æ”¾ç½®äº â€œpkg/apis/\u003cgroup\u003e/\u003cversion\u003e/types.goâ€ æ–‡ä»¶ä¸­ã€‚å½“ç„¶ï¼Œå…¶æ˜¯å¿…é¡»åŒ…å« JSON æ ‡ç­¾çš„ã€‚ // +genclient // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object type Flunder struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\" protobuf:\"bytes,1,opt,name=metadata\"` Spec FlunderSpec `json:\"spec,omitempty\" protobuf:\"bytes,2,opt,name=spec\"` Status FlunderStatus `json:\"status,omitempty\" protobuf:\"bytes,3,opt,name=status\"` } // +genclient // +genclient:nonNamespaced // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object type Fischer struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\" protobuf:\"bytes,1,opt,name=metadata\"` // DisallowedFlunders holds a list of Flunder.Names that are disallowed. DisallowedFlunders []string `json:\"disallowedFlunders,omitempty\" protobuf:\"bytes,2,rep,name=disallowedFlunders\"` } // ... ä¸ Internal Version ä¸åŒäº†ï¼Œå…¶æ³¨å†Œåˆ° Scheme çš„ GroupVersion å°±æ˜¯å¯¹åº”ç‰ˆæœ¬çš„ string äº†ã€‚ var SchemeGroupVersion = schema.GroupVersion{Group: GroupName, Version: \"v1alpha1\"} func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes(SchemeGroupVersion, \u0026Flunder{}, \u0026FlunderList{}, \u0026Fischer{}, \u0026FischerList{}, ) metav1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil } 3.3.1 Convert åœ¨ 3.1 å¤„ç†æµç¨‹ ä¸­çœ‹åˆ°ï¼ŒAPIServer å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­æœ‰ç€å¤šæ¬¡ External Version ä¸ Internal Version åŒå‘çš„è½¬æ¢ï¼Œå› æ­¤å…¶éœ€è¦æ³¨å†Œå¯¹åº”çš„è½¬æ¢å‡½æ•°ï¼Œå…¶æ³¨å†Œå‡½æ•°ä¼šè‡ªåŠ¨ç”Ÿæˆä½äº â€œpkg/apis/\u003cgroup\u003e/\u003cversion\u003e/zz_generated.conversion.goâ€ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå…¶ç±»å‹è½¬æ¢å‡½æ•°é€šè¿‡ Scheme.AddGeneratedConversionFunc() æ¥å£æ³¨å†Œåˆ° Scheme ä¸­ã€‚è€Œåœ¨ APIServer æŠ½è±¡å®ç°ä¸­ï¼Œä¼šæŒ‰ç…§ 3.1 å¤„ç†æµç¨‹ ä¸­çš„è¯·æ±‚å¤„ç†æµç¨‹è°ƒç”¨ Scheme.Convert() æ¥å£è¿›è¡Œè½¬æ¢ã€‚ func init() { // æ³¨å†Œè½¬æ¢å‡½æ•° localSchemeBuilder.Register(RegisterConversions) } // RegisterConversions adds conversion functions to the given scheme. // Public to allow building arbitrary schemes. func RegisterConversions(s *runtime.Scheme) error { // Scheme.AddGeneratedConversionFunc(a, b interface{}, fn conversion.ConversionFunc) ç”¨äºæ³¨å†Œä¸€ä¸ªè½¬æ¢å‡½æ•° // è¡¨æ˜ fn ä¼šç”¨äºå°† a -\u003e b // // fn ä¸º type ConversionFunc func(a, b interface{}, scope Scope) error // å®ç°å®é™…çš„å°† a -\u003e bï¼Œscope è¡¨ç¤ºèŒƒå›´ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸ä½¿ç”¨ï¼‰ if err := s.AddGeneratedConversionFunc((*Fischer)(nil), (*wardle.Fischer)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_v1alpha1_Fischer_To_wardle_Fischer(a.(*Fischer), b.(*wardle.Fischer), scope) }); err != nil { return err } if err := s.AddGeneratedConversionFunc((*wardle.Fischer)(nil), (*Fischer)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_wardle_Fischer_To_v1alpha1_Fischer(a.(*wardle.Fischer), b.(*Fischer), scope) }); err != nil { return err } if err := s.AddGeneratedConversionFunc((*FischerList)(nil), (*wardle.FischerList)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_v1alpha1_FischerList_To_wardle_FischerList(a.(*FischerList), b.(*wardle.FischerList), scope) }); err != nil { return err } if err := s.AddGeneratedConversionFunc((*wardle.FischerList)(nil), (*FischerList)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_wardle_FischerList_To_v1alpha1_FischerList(a.(*wardle.FischerList), b.(*FischerList), scope) }); err != nil { return err } if err := s.AddGeneratedConversionFunc((*Flunder)(nil), (*wardle.Flunder)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_v1alpha1_Flunder_To_wardle_Flunder(a.(*Flunder), b.(*wardle.Flunder), scope) }); err != nil { return err } if err := s.AddGeneratedConversionFunc((*wardle.Flunder)(nil), (*Flunder)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_wardle_Flunder_To_v1alpha1_Flunder(a.(*wardle.Flunder), b.(*Flunder), scope) }); err != nil { return err } if err := s.AddGeneratedConversionFunc((*FlunderList)(nil), (*wardle.FlunderList)(nil), func(a, b interface{}, scope conversion.Scope) error { return Convert_v1alpha1_FlunderList_To_wardle_FlunderList(a.(*FlunderList), b.(*wardle.Flund","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.4 å‘ Scheme æ³¨å†Œ æœ€ååœ¨è¯´æ˜ä¸€ä¸‹ç±»å‹ã€Convert å‡½æ•°ã€Default å‡½æ•°æ˜¯å¦‚ä½•æ³¨å†Œåˆ° Scheme ä¸­çš„ã€‚è¿™ä¸‰ç±»éƒ½ä¼šæ³¨å†Œåˆ°ä»£ç ç”Ÿæˆçš„ä¸€ä¸ª SchemeBuilder å¯¹è±¡ï¼Œå…¶ä½œç”¨å°±æ˜¯ç”¨äºè°ƒç”¨æ³¨å†Œçš„ funcs (scheme *Scheme) error å»è®¾ç½® Schemeã€‚ è€Œå‰é¢çœ‹åˆ°çš„å„ä¸ª Register å‡½æ•°éƒ½æ˜¯æ³¨å†Œåˆ° SchemeBuilder å¯¹è±¡ä¸­ã€‚ var ( SchemeBuilder runtime.SchemeBuilder localSchemeBuilder = \u0026SchemeBuilder // AddToScheme is a common registration function for mapping packaged scoped group \u0026 version keys to a scheme AddToScheme = localSchemeBuilder.AddToScheme ) func init() { // We only register manually written functions here. The registration of the // generated functions takes place in the generated files. The separation // makes the code compile even when the generated files are missing. localSchemeBuilder.Register(addKnownTypes, addDefaultingFuncs) } // addKnownTypes æ³¨å†Œç±»å‹ func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes(SchemeGroupVersion, \u0026Flunder{}, \u0026FlunderList{}, \u0026Fischer{}, \u0026FischerList{}, ) metav1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil } // addDefaultingFuncs æ³¨å†Œ Default å‡½æ•° func addDefaultingFuncs(scheme *runtime.Scheme) error { return RegisterDefaults(scheme) } func init() { localSchemeBuilder.Register(RegisterConversions) // æ³¨å†Œ Convert å‡½æ•° } æ‰€æœ‰ç‰ˆæœ¬çš„ AddToScheme éƒ½æ˜¯åœ¨ â€œpkg/apis/\u003cgroup\u003e/install/install.goâ€ ä¸­ä¸€ä¸ªè¾…åŠ©å‡½æ•° Install ä¸­æ³¨å†Œï¼š // Install registers the API group and adds types to a scheme func Install(scheme *runtime.Scheme) { // æ³¨å†Œ Internal Version utilruntime.Must(wardle.AddToScheme(scheme)) // æ³¨å†Œ v1beta1 utilruntime.Must(v1beta1.AddToScheme(scheme)) // æ³¨å†Œ v1alpha1 utilruntime.Must(v1alpha1.AddToScheme(scheme)) // è®¾ç½®ä¼˜å…ˆçº§ï¼ˆä¼˜å…ˆçº§ç”¨äºå®¢æˆ·ç«¯é€‰æ‹©ç‰ˆæœ¬ï¼‰ utilruntime.Must(scheme.SetVersionPriority(v1beta1.SchemeGroupVersion, v1alpha1.SchemeGroupVersion)) } Install å‡½æ•°åœ¨ APIServer åŒ…ä¸­ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºè¿è¡Œä¸€å¼€å§‹å°±å°†æ‰€æœ‰ Scheme ç›¸å…³çš„æ³¨å†Œå¤„ç†å¥½äº†ã€‚ var ( // Scheme defines methods for serializing and deserializing API objects. Scheme = runtime.NewScheme() ) func init() { install.Install(Scheme) // ... } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:3:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4 Registry ä¸ Strategy APIServer æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª HTTP Serverï¼Œclient é€šè¿‡è®¿é—®ä»¥ Resource ä¸ºå•ä½çš„ RESTful æ¥å£æ¥è¿›è¡Œäº¤äº’ã€‚åœ¨ Custom APIServer ä¸­ï¼Œä¸ºäº†è®© Custom APIServer èƒ½å¤Ÿå¤„ç† CR ç›¸å…³çš„æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œç›¸å…³æ¥å£çš„ HTTP Handleã€‚ k8s.io/apiserver åº“æä¾›äº†è¯¥åŠŸèƒ½çš„é«˜åº¦å°è£…ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ Registryã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.1 APIServer å¯¹è±¡ åœ¨ Custom APIServer å®ç°ä¸­ï¼Œä¸éœ€è¦è‡ªå·±å®šä¹‰ HTTP Serverï¼Œå¯ä»¥ç›´æ¥å†…åµŒæä¾›çš„ GenericAPIServer ç±»ã€‚ import genericapiserver \"k8s.io/apiserver/pkg/server\" // WardleServer contains state for a Kubernetes cluster master/api server. type WardleServer struct { GenericAPIServer *genericapiserver.GenericAPIServer } åœ¨æ•´ä¸ª Custom APIServer ç¨‹åºå¯åŠ¨æµç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ GenericAPIServer.PrepareRun().Run() è¿è¡Œä¸€ä¸ª HTTP Serverã€‚ï¼ˆæ•´ä¸ªå¯åŠ¨æµç¨‹å¾ˆé•¿ï¼Œåé¢å•ç‹¬è¯´æ˜ï¼‰ åœ¨åˆ›å»º WardleServer è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»º APIGroupInfo å¯¹è±¡ï¼Œè€Œå°†å…¶æ³¨å†Œåˆ° GenericAPIServer å¯¹è±¡ä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå®Œæˆäº†æŸä¸ª Group ä¸‹æ‰€æœ‰ Resource å¯¹åº”çš„ HTTP Handle æ³¨å†Œã€‚ func (c completedConfig) New() (*WardleServer, error) { // CompletedConfig å¾—åˆ°ä¸€ä¸ª GenericAPIServer genericServer, err := c.GenericConfig.New(\"sample-apiserver\", genericapiserver.NewEmptyDelegate()) if err != nil { return nil, err } // Custom APIServer å¯¹è±¡ s := \u0026WardleServer{ GenericAPIServer: genericServer, } // æ„å»º APIGroupInfo apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(wardle.GroupName, Scheme, metav1.ParameterCodec, Codecs) // æ„å»º APIGroup v1alpha1storage := map[string]rest.Storage{} v1alpha1storage[\"flunders\"] = wardleregistry.RESTInPeace(flunderstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) v1alpha1storage[\"fischers\"] = wardleregistry.RESTInPeace(fischerstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) apiGroupInfo.VersionedResourcesStorageMap[\"v1alpha1\"] = v1alpha1storage v1beta1storage := map[string]rest.Storage{} v1beta1storage[\"flunders\"] = wardleregistry.RESTInPeace(flunderstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) apiGroupInfo.VersionedResourcesStorageMap[\"v1beta1\"] = v1beta1storage // æ³¨å†Œ APIGroup åˆ° Kubernetes APIServer if err := s.GenericAPIServer.InstallAPIGroup(\u0026apiGroupInfo); err != nil { return nil, err } return s, nil } Note è¿™é‡Œæš‚æ—¶ä¸å»æ·±å…¥äº†è§£ APIGroupInfo æ˜¯å¦‚ä½•æ˜ å°„åˆ° HTTP Handle çš„ï¼Œå› ä¸ºè¿™æ˜¯ k8s.io/apiserver åº“æä¾›çš„å°è£…ã€‚ï¼ˆå…¶å®æˆ‘ä¹Ÿä¸æ‡‚ï¼‰ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.2 APIGroupInfo APIGroupInfo èƒ½å¤Ÿå˜ä¸ºä¸€ä¸ª Group ä¸‹æ‰€æœ‰ Version æ‰€æœ‰ Resource çš„çš„ HTTP Handleã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œæˆ‘ä»¬æä¾›ç»™ APIGroupInfo ä»€ä¹ˆä¿¡æ¯ï¼š è¯¥ Group æ”¯æŒçš„æ‰€æœ‰ Versionï¼Œä»¥åŠæ¯ä¸ª Version æ”¯æŒçš„æ‰€æœ‰ Resourceï¼› ç”±è°ƒç”¨ genericapiserver.NewDefaultAPIGroupInfo() ä¼ å…¥çš„ Group + Scheme + Codecs æä¾›ã€‚è¿™æ ·ï¼Œå¤„ç† HTTP è¯·æ±‚æ—¶èƒ½å¤Ÿå°†æ•°æ®åºåˆ—åŒ–ä¸ºç‰¹å®šçš„å¯¹è±¡ã€‚ GroupVersionResource ç»´åº¦çš„ RESTful HTTP Handleï¼› é€šè¿‡å°† rest.Storage æ³¨å†Œåˆ° APIGroupInfo.VersionedResourcesStorageMap ä¸­ã€‚rest.Storage ä¸ºä¸€ä¸ª RESTful HTTP Handle çš„å®ç°ã€‚ // æ„å»º APIGroupInfo apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(wardle.GroupName, Scheme, metav1.ParameterCodec, Codecs) // æ„å»º APIGroup // ä¸€ä¸ª rest.Storage å¯¹åº”äº†ä¸€ä¸ª HTTP API Endpoint // å³ /apis/\u003cgroup\u003e/\u003cversion\u003e/\u003cresource\u003e // ä¸‹é¢æ³¨å†Œäº†ä¸¤ä¸ª Endpoint // + /apis/wardle.example.com/v1alpha1/flunders // + /apis/wardle.example.com/v1alpha1/fischers v1alpha1storage := map[string]rest.Storage{} v1alpha1storage[\"flunders\"] = wardleregistry.RESTInPeace(flunderstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) v1alpha1storage[\"fischers\"] = wardleregistry.RESTInPeace(fischerstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) apiGroupInfo.VersionedResourcesStorageMap[\"v1alpha1\"] = v1alpha1storage // æ³¨å†Œåˆ° APIGroupInfo v1alpha1 ç‰ˆæœ¬ // ä¸‹é¢æ³¨å†Œäº†ä¸€ä¸ª Endpoint // + /apis/wardle.example.com/v1beta1/flunders v1beta1storage := map[string]rest.Storage{} v1beta1storage[\"flunders\"] = wardleregistry.RESTInPeace(flunderstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) apiGroupInfo.VersionedResourcesStorageMap[\"v1beta1\"] = v1beta1storage // æ³¨å†Œåˆ° APIGroupInfo v1beta1 ç‰ˆæœ¬ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.3 rest.Storage ç»ˆäºï¼Œæˆ‘ä»¬çœ‹ä¼¼æ¥åˆ°äº†è¿™ä¸ªå°è£…çš„æœ€åº•å±‚ rest.Storageï¼Œæä¾› REST é£æ ¼å„ä¸ª Handle çš„ç±»ã€‚rest.Storage æœ¬èº«çš„ interface å®ç°å¾ˆç®€å•ï¼Œä»…ä»…åªéœ€è¦æä¾› New() æ–¹æ³•å°±å¥½äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª Resource HTTP Endpoint è‡³å°‘è¦æä¾›ä¸€ä¸ª Create/Update æ¥å£ã€‚ // Storage is a generic interface for RESTful storage services. // Resources which are exported to the RESTful API of apiserver need to implement this interface. It is expected // that objects may implement any of the below interfaces. type Storage interface { // New returns an empty object that can be used with Create and Update after request data has been put into it. // This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object) New() runtime.Object } å®ç° Custom APIServer æ—¶ï¼Œä¸ºäº†èƒ½å¤Ÿæ”¯æŒå¤šä¸ª HTTP Endpointï¼Œä½¿ç”¨çš„æ˜¯ rest.StandardStorage interfaceã€‚ // StandardStorage is an interface covering the common verbs. Provided for testing whether a // resource satisfies the normal storage methods. Use Storage when passing opaque storage objects. type StandardStorage interface { Getter Lister CreaterUpdater GracefulDeleter CollectionDeleter Watcher } // Getter is an object that can retrieve a named RESTful resource. type Getter interface { // Get finds a resource in the storage by name and returns it. // Although it can return an arbitrary error value, IsNotFound(err) is true for the // returned error value err when the specified resource is not found. Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) } // Lister is an object that can retrieve resources that match the provided field and label criteria. type Lister interface { // NewList returns an empty object that can be used with the List call. // This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object) NewList() runtime.Object // List selects resources in the storage which match to the selector. 'options' can be nil. List(ctx context.Context, options *metainternalversion.ListOptions) (runtime.Object, error) // TableConvertor ensures all list implementers also implement table conversion TableConvertor } // CreaterUpdater is a storage object that must support both create and update. // Go prevents embedded interfaces that implement the same method. type CreaterUpdater interface { Creater Update(ctx context.Context, name string, objInfo UpdatedObjectInfo, createValidation ValidateObjectFunc, updateValidation ValidateObjectUpdateFunc, forceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) } // Creater is an object that can create an instance of a RESTful object. type Creater interface { // New returns an empty object that can be used with Create after request data has been put into it. // This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object) New() runtime.Object // Create creates a new version of a resource. Create(ctx context.Context, obj runtime.Object, createValidation ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) } // GracefulDeleter knows how to pass deletion options to allow delayed deletion of a // RESTful object. type GracefulDeleter interface { // Delete finds a resource in the storage and deletes it. // The delete attempt is validated by the deleteValidation first. // If options are provided, the resource will attempt to honor them or return an invalid // request error. // Although it can return an arbitrary error value, IsNotFound(err) is true for the // returned error value err when the specified resource is not found. // Delete *may* return the object that was deleted, or a status object indicating additional // information about deletion. // It also returns a boolean which is set to true if the resource was instantly // deleted or false if it will be deleted asynchronously. Delete(ctx context.Context, name string, deleteValidation ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) } // CollectionDeleter is an object that can delete a collection // of RESTful resources. type CollectionDelet","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.4 registry.Store ä¸ Strategy è¦å®ç° rest.Storage interfaceï¼ŸKubernetes ä¾æ—§æä¾›äº†å®ç°äº† rest.Storage çš„ç±» registry.Storeã€‚æˆ‘ä»¬çœŸæ­£è¦åšçš„å°±æ˜¯å°†ä¸€ä¸ªå›è°ƒå‡½æ•°è®¾ç½®åˆ° Store å¯¹è±¡ä¸­ã€‚ // Store implements k8s.io/apiserver/pkg/registry/rest.StandardStorage. It's // intended to be embeddable and allows the consumer to implement any // non-generic functions that are required. This object is intended to be // copyable so that it can be used in different ways but share the same // underlying behavior. // // All fields are required unless specified. // // The intended use of this type is embedding within a Kind specific // RESTStorage implementation. This type provides CRUD semantics on a Kubelike // resource, handling details like conflict detection with ResourceVersion and // semantics. The RESTCreateStrategy, RESTUpdateStrategy, and // RESTDeleteStrategy are generic across all backends, and encapsulate logic // specific to the API. // // TODO: make the default exposed methods exactly match a generic RESTStorage type Store struct { // ... } æˆ‘ä»¬ä»…ä»…å…³æ³¨åœ¨å¦‚ä½•ä½¿ç”¨ rest.Storeï¼Œä»¥ Flunder çš„ REST å®ç°ä¸ºä¾‹: // REST implements a RESTStorage for API services against etcd type REST struct { *genericregistry.Store } func NewREST(scheme *runtime.Scheme, optsGetter generic.RESTOptionsGetter) (*registry.REST, error) { strategy := NewStrategy(scheme) store := \u0026genericregistry.Store{ NewFunc: func() runtime.Object { return \u0026wardle.Flunder{} }, NewListFunc: func() runtime.Object { return \u0026wardle.FlunderList{} }, PredicateFunc: MatchFlunder, DefaultQualifiedResource: wardle.Resource(\"flunders\"), CreateStrategy: strategy, UpdateStrategy: strategy, DeleteStrategy: strategy, // TODO: define table converter that exposes more than name/creation timestamp TableConvertor: rest.NewDefaultTableConvertor(wardle.Resource(\"flunders\")), } options := \u0026generic.StoreOptions{RESTOptions: optsGetter, AttrFunc: GetAttrs} if err := store.CompleteWithOptions(options); err != nil { return nil, err } return \u0026registry.REST{store}, nil } Store å·²ç»å®ç°äº† Createrã€Updater ç­‰ interfaceï¼Œç¡®åˆ‡çš„è¯´æ˜¯ rest.StandardStorageã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒStore å°†æœ€åŸºæœ¬çš„ CRUD é€»è¾‘å®ç°äº†ï¼Œæˆ‘ä»¬éœ€è¦å®ç°çš„å°±æ˜¯æ‰©å±•ç‚¹çš„å‡½æ•°ã€‚ æ¯ä¸ªæ“ä½œçš„æ‰©å±•ç‚¹å°±ç§°ä¸º Strategyï¼ˆæ€»ç®—çœ‹åˆ°äº†æ ‡é¢˜ï¼‰ã€‚çœ‹ä¸‹æˆ‘ä»¬è‡ªå·±å®ç°çš„ Strategy: type flunderStrategy struct { runtime.ObjectTyper names.NameGenerator } func (flunderStrategy) NamespaceScoped() bool { return true } func (flunderStrategy) PrepareForCreate(ctx context.Context, obj runtime.Object) { } func (flunderStrategy) PrepareForUpdate(ctx context.Context, obj, old runtime.Object) { } // Validate ç”¨äºå¯¹å¯¹è±¡è¿›è¡ŒéªŒè¯ func (flunderStrategy) Validate(ctx context.Context, obj runtime.Object) field.ErrorList { flunder := obj.(*wardle.Flunder) return validation.ValidateFlunder(flunder) } // WarningsOnCreate returns warnings for the creation of the given object. func (flunderStrategy) WarningsOnCreate(ctx context.Context, obj runtime.Object) []string { return nil } func (flunderStrategy) AllowCreateOnUpdate() bool { return false } func (flunderStrategy) AllowUnconditionalUpdate() bool { return false } func (flunderStrategy) Canonicalize(obj runtime.Object) { } func (flunderStrategy) ValidateUpdate(ctx context.Context, obj, old runtime.Object) field.ErrorList { return field.ErrorList{} } // WarningsOnUpdate returns warnings for the given update. func (flunderStrategy) WarningsOnUpdate(ctx context.Context, obj, old runtime.Object) []string { return nil } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.5 æ€»ç»“ å…œå…œç»•ç»•äº†ä¸€åœˆï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹è¿™ä¸ªå¤æ‚çš„ç»“æ„ï¼š æ•´ä¸ª APIServer å°±æ˜¯ä¸€ä¸ª HTTP Serverï¼› HTTPServer ç”±å¤šä¸ª APIGroupInfoï¼Œæ¯ä¸ª APIGroupInfo ä»£è¡¨äº†ä¸€ç»„ HTTP æ¥å£ï¼Œå³ \"/apis/\u003cgroup\u003e\"ï¼› æ¯ä¸ª APIGroupInfo åŒ…å«å¤šä¸ªç‰ˆæœ¬ï¼Œå³ \"/apis/\u003cgroup\u003e/\u003cversion\u003e\"ï¼› æ¯ä¸ªç‰ˆæœ¬å¯ä»¥åŒ…å«å¤šä¸ª Resource å¯¹åº”çš„ rest.Storage å®ç°ï¼Œä¸€ä¸ª rest.Storage å°±æ˜¯è¯¥ Resource çš„ REST HTTP Handleï¼Œå³ \"/apis/\u003cgroup\u003e/\u003cversion\u003e/\u003cresource\u003e\"ã€‚ registry.Store æ˜¯ Kubernetes åº“æä¾›çš„å®ç°äº† rest.Storage çš„ç±»ï¼Œå…¶æä¾›å¤šä¸ªæ‰©å±•ç‚¹ï¼Œæ‰©å±•ç‚¹å°±ç§°ä¸º Strategyã€‚ æˆ‘ä»¬å†å›å¤´çœ‹ï¼Œå…¶å®è¿™æ ·å¤æ‚çš„ç»“æ„å®ç°å°±æ˜¯ä¸ºèƒ½å¤Ÿå®ç°äº† /apis/\u003cgroup\u003e/\u003cversion\u003e/\u003cresource\u003e ä»¥åŠå¤„ç†å‡½æ•°çš„æŠ½è±¡ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:4:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"5 Validate å‡†å…¥è¿‡ç¨‹ä¸­çš„ Validate èƒ½å¤Ÿå®ç°é’ˆå¯¹å­—æ®µåŠ¨æ€éªŒè¯ï¼Œæ¯” CRD å®šä¹‰ä¸­çš„é™æ€éªŒè¯æ›´åŠ çµæ´»ã€‚ç”±ä¸‹å›¾å¯è§ï¼ŒValidate è¿‡ç¨‹æ˜¯åœ¨ Mutate Plugin ä¸ Validate Plugin ä¹‹é—´å®Œæˆçš„ã€‚ å› æ­¤ Validate åªéœ€è¦ä¸º Internal Version å®ç°ä¸€æ¬¡ï¼Œä¸è®¸ä¸ºå„ä¸ª External Version åˆ†åˆ«å®ç°ã€‚Registry ä¸ Strategy ä¸ºæˆ‘ä»¬å°è£…äº†ä¸Šé¢çš„çœŸä¸ª Resource Handlerï¼Œå› æ­¤ Validate çš„å…¥å£å…¶å®å°±æ˜¯ Strategy ä¸­å¯¹äº Create/Update çš„æ£€æŸ¥ã€‚ type flunderStrategy struct { runtime.ObjectTyper names.NameGenerator } // ... // Validate ç”¨äºå¯¹ Create Object æ—¶è¿›è¡ŒéªŒè¯ func (flunderStrategy) Validate(ctx context.Context, obj runtime.Object) field.ErrorList { flunder := obj.(*wardle.Flunder) return validation.ValidateFlunder(flunder) } åç»­å°±æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ Validate é€»è¾‘ï¼Œè¿™é‡Œä½¿ç”¨äº† field.ErrorList è¿™æ ·çš„æ–¹å¼æ¥æ–¹ä¾¿çš„å±•ç¤ºå‡ºé”™è¯¯çš„å­—æ®µã€‚ // ValidateFlunder validates a Flunder. func ValidateFlunder(f *wardle.Flunder) field.ErrorList { allErrs := field.ErrorList{} // åµŒå¥—çš„å±æ€§è®¤è¯ allErrs = append(allErrs, ValidateFlunderSpec(\u0026f.Spec, field.NewPath(\"spec\"))...) // field.NewPath(è®°å½•å±æ€§è·¯å¾„) return allErrs } ç”±äº Validate é€»è¾‘éƒ½æ˜¯åœ¨ä»£ç ä¸­ç¼–å†™çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¯¹æ¯”å¤šä¸ªå­—æ®µæ¥è¿›è¡Œ Validateï¼Œçµæ´»æ€§é¡µæ›´é«˜ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6 Admission è¿˜æ˜¯ä¸‹å›¾ï¼Œæ¯ä¸ªè¯·æ±‚åœ¨ç»è¿‡ååºåˆ—åŒ–ã€é»˜è®¤å€¼å¤„ç†ã€è½¬æ¢ä¸º Internal Version åï¼Œéƒ½ä¼šç»è¿‡ Admission Plugin Chain å¤„ç†ï¼ˆå›¾ä¸­çš„ Admission ä¸€å—ï¼‰ã€‚ Admission Plugin å› ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åˆ†ä¸ºä¸¤ç±»æ’ä»¶ï¼š Mutate Plugin Validate Plugin ä¸€ä¸ª Admission Plugin å¯ä»¥åŒæ—¶å±äºè¿™ä¸¤ç±»ï¼Œé‚£ä¹ˆåœ¨ Admission Controll è¿‡ç¨‹ä¸­ï¼Œè¯¥æ’ä»¶ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼ˆè¦ä¹ˆåŒæ—¶å¯åŠ¨ã€è¦ä¹ˆåŒæ—¶ç¦ç”¨ï¼‰ã€‚ Mutate é˜¶æ®µï¼Œæ‰€æœ‰ Mutate Plugin ä¼šä¾æ¬¡è°ƒç”¨ï¼› Validate é˜¶æ®µï¼Œæ‰€æœ‰ Validate Plugin ä¼šè¢«è°ƒç”¨ï¼ˆå¯èƒ½å¹¶å‘åœ°è°ƒç”¨ï¼‰ï¼› Webhook Admission è¿™é‡Œæ‰€è¯´çš„éƒ½æ˜¯ç»§æ‰¿åˆ° APIServer ä»£ç å†…éƒ¨çš„ Admission Pluginï¼ŒKubernetes ä¹Ÿæä¾›äº†å¤–éƒ¨åŸºäº Webhook çš„ Admission Controlï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­è°ƒç”¨å¤–éƒ¨æœåŠ¡çš„åœ°æ–¹ã€‚ ä¸‹é¢ä»å…¥å£å¼€å§‹çœ‹ Admission Plugin å¦‚ä½•å®ç°çš„ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6.1 Admission Plugin é€‰é¡¹ åœ¨ APIServer ä¸­ï¼Œæ‰€æœ‰çš„ Admission Plugin ä»¥åŠç›¸å…³é€‰é¡¹éƒ½è®°å½•åœ¨ APIServer Option RecommendedOptions.Admission å­—æ®µä¸­ï¼Œå…¶æ˜¯ AdmissionOptions ç±»å‹ã€‚ // AdmissionOptions holds the admission options type AdmissionOptions struct { // RecommendedPluginOrder holds an ordered list of plugin names we recommend to use by default RecommendedPluginOrder []string // DefaultOffPlugins is a set of plugin names that is disabled by default DefaultOffPlugins sets.String // EnablePlugins indicates plugins to be enabled passed through `--enable-admission-plugins`. EnablePlugins []string // DisablePlugins indicates plugins to be disabled passed through `--disable-admission-plugins`. DisablePlugins []string // ConfigFile is the file path with admission control configuration. ConfigFile string // Plugins contains all registered plugins. Plugins *admission.Plugins // Decorators is a list of admission decorator to wrap around the admission plugins Decorators admission.Decorators } RecommendedPluginOrder - Plugin æ‰§è¡Œé¡ºåº EnablePlugins - é€šè¿‡å‘½ä»¤è¡Œå‚æ•° --enable-admission-plugins æ‰“å¼€çš„ Plugin DisablePlugins - é€šè¿‡å‘½ä»¤è¡Œå‚æ•° --disable-admission-plugins å…³é—­çš„ Plugin Plugins - æ‰€æœ‰æ³¨å†Œäº†çš„ Plugin ä¸ Kubernetes APIServer åŒ…å«çš„ Plugin ä¸åŒï¼ŒNewAdmissionOptions() ä»…ä»…åŒ…å«ä¸‰ä¸ªé»˜è®¤çš„ Pluginï¼š NamespaceLifecycle - æ ¹æ® namespace é˜¶æ®µæ¥æ‰§è¡Œä¸€äº›çº¦æŸï¼ŒåŒ…æ‹¬ï¼šç¦æ­¢åœ¨åˆ é™¤ä¸­çš„ namespace ä¸­åˆ›å»ºæ–°å¯¹è±¡ï¼Œå¯¹ä¸å­˜åœ¨çš„ namespace è¯·æ±‚æ‹’ç»ï¼Œç¦æ­¢åˆ é™¤ defaultã€kube-systemã€kube-public ä¸‰ä¸ª namespaceã€‚ ValidatingAdmissionWebhook - å…è®¸æ³¨å†Œä¸ä½¿ç”¨ Validating Admission Webhookã€‚ MutatingAdmissionWebhook - å…è®¸æ³¨å†Œä¸ä½¿ç”¨ Mutating Admission Webhookã€‚ Note Kubernetes APIServer æä¾›äº†è®¸å¤šçš„ Admission Pluginï¼Œå…·ä½“è§ ä½¿ç”¨å‡†å…¥æ§åˆ¶å™¨ ä»£ç ä¸­ï¼Œåœ¨ APIServer å¯åŠ¨è¿‡ç¨‹ä¸­çš„ Complete() æ—¶ä¼šè¿›è¡Œè‡ªå®šä¹‰ Plugin çš„æ³¨å†Œï¼Œè°ƒç”¨ *admission.Plugins.Register() å³å¯ // Complete fills in fields required to have valid data func (o *WardleServerOptions) Complete() error { // æ³¨å†Œ BanFlunder çš„ Admission Plugin // register admission plugins banflunder.Register(o.RecommendedOptions.Admission.Plugins) // è®°å½•åˆ° Plugins ä¸­ // add admission plugins to the RecommendedPluginOrder o.RecommendedOptions.Admission.RecommendedPluginOrder = append(o.RecommendedOptions.Admission.RecommendedPluginOrder, \"BanFlunder\") return nil } // banflunder.Register // Register registers a plugin func Register(plugins *admission.Plugins) { plugins.Register(\"BanFlunder\", func(config io.Reader) (admission.Interface, error) { return New() }) } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:6:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6.2 Admission Plugin Interface è¦å®ç°ä¸€ä¸ª Admission Plugin éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š addmission.Interface - ç”¨äºæ³¨å†Œåˆ° Plugin Chain ä¸­ addmission.MutatingInterfaceï¼ˆå¯é€‰ï¼‰- èƒ½å¤Ÿåœ¨ Mutate é˜¶æ®µè¢«è°ƒç”¨ addmission.ValidationInterfaceï¼ˆå¯é€‰ï¼‰- èƒ½å¤Ÿåœ¨ Validate é˜¶æ®µè¢«è°ƒç”¨ è¿™ä¸‰ä¸ªæ¥å£éƒ½åœ¨ â€œk8s.io/apiserver/pkg/admissionâ€ åŒ…ä¸­ï¼š // Interface is an abstract, pluggable interface for Admission Control decisions. type Interface interface { // Handles returns true if this admission controller can handle the given operation // where operation can be one of CREATE, UPDATE, DELETE, or CONNECT Handles(operation Operation) bool } type MutationInterface interface { Interface // Admit makes an admission decision based on the request attributes. // Context is used only for timeout/deadline/cancellation and tracing information. Admit(ctx context.Context, a Attributes, o ObjectInterfaces) (err error) } // ValidationInterface is an abstract, pluggable interface for Admission Control decisions. type ValidationInterface interface { Interface // Validate makes an admission decision based on the request attributes. It is NOT allowed to mutate // Context is used only for timeout/deadline/cancellation and tracing information. Validate(ctx context.Context, a Attributes, o ObjectInterfaces) (err error) } Interface.Handles() æ ¹æ®æ“ä½œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œå› æ­¤å¯ä»¥é’ˆå¯¹ç‰¹å®šçš„è¯·æ±‚æ‰è¿›è¡Œ Mutate ä¸ Validate é˜¶æ®µï¼› MutationInterface.Admit() éªŒè¯è¯·æ±‚ï¼Œå¹¶å…è®¸å˜æ›´å¯¹è±¡ï¼› ValidationInterface.Validate() ä»…ä»…éªŒè¯è¯·æ±‚ï¼› ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:6:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6.3 å®ç° Admission Plugin å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“åœ¨å“ªé‡Œæ³¨å†Œ Pluginï¼Œä»¥åŠ Plugin åº”è¯¥å®ç°å“ªäº›æ¥å£äº†ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹ä¸€ä¸ª Plugin çš„å®ç°ï¼š // New creates a new ban flunder admission plugin func New() (*DisallowFlunder, error) { return \u0026DisallowFlunder{ Handler: admission.NewHandler(admission.Create), }, nil } // DisallowFlunder is a ban flunder admission plugin type DisallowFlunder struct { *admission.Handler lister listers.FischerLister } // SetInternalWardleInformerFactory gets Lister from SharedInformerFactory. // The lister knows how to lists Fischers. func (d *DisallowFlunder) SetInternalWardleInformerFactory(f informers.SharedInformerFactory) { d.lister = f.Wardle().V1alpha1().Fischers().Lister() d.SetReadyFunc(f.Wardle().V1alpha1().Fischers().Informer().HasSynced) } // ValidateInitialization checks whether the plugin was correctly initialized. func (d *DisallowFlunder) ValidateInitialization() error { if d.lister == nil { return fmt.Errorf(\"missing fischer lister\") } return nil } admission.Handler - å†…åµŒ admission.Handler çš„å¯¹è±¡å®ç°äº† Interface.Handles() æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦æ³¨å†Œæˆ‘ä»¬æ„Ÿå…´è¶£çš„ Operationï¼ˆCreateï¼‰ï¼› SetInternalWardleInformerFactory - ä¼ å…¥éœ€è¦çš„ Lister Admit() å®ç°å°±å¾ˆç®€å•äº†ï¼Œè¿›è¡Œä¸€äº›æ£€æŸ¥ï¼š func (d *DisallowFlunder) Admit(ctx context.Context, a admission.Attributes, o admission.ObjectInterfaces) error { // æ£€æŸ¥ GVK // we are only interested in flunders if a.GetKind().GroupKind() != wardle.Kind(\"Flunder\") { return nil } // ç­‰å¾… Lister å‡†å¤‡å¥½ if !d.WaitForReady() { return admission.NewForbidden(a, fmt.Errorf(\"not yet ready to handle request\")) } // è¿›è¡Œä¸šåŠ¡ä¸Šçš„ Validate metaAccessor, err := meta.Accessor(a.GetObject()) if err != nil { return err } flunderName := metaAccessor.GetName() fischers, err := d.lister.List(labels.Everything()) if err != nil { return err } // é»‘åå•æ£€æŸ¥ for _, fischer := range fischers { for _, disallowedFlunder := range fischer.DisallowedFlunders { if flunderName == disallowedFlunder { return errors.NewForbidden( a.GetResource().GroupResource(), a.GetName(), fmt.Errorf(\"this name may not be used, please change the resource name\"), ) } } } return nil } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:6:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6.4 åŸºç¡€ç»„ä»¶ Admission Plugin é€šå¸¸éœ€è¦ client å’Œ Informer å»è®¿é—®å…¶ä»–èµ„æºï¼Œå¯ä»¥åœ¨æ’ä»¶çš„åˆå§‹åŒ–é€»è¾‘ä¸­å‡†å¤‡å¥½è¿™äº›åŸºç¡€ç»„ä»¶ã€‚ åº“ä¸­æä¾›äº† admission.PluginInitializer interface æŠ½è±¡æ¥è¿›è¡Œ Plugin çš„åˆå§‹åŒ–æ“ä½œï¼Œåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šå¯¹æ‰€æœ‰çš„ Plugin è°ƒç”¨æ¯ä¸ª PluginInitializer.Initialize()ã€‚ // PluginInitializer is used for initialization of shareable resources between admission plugins. // After initialization the resources have to be set separately type PluginInitializer interface { Initialize(plugin Interface) } æ ¹æ®å‰é¢çš„ Plugin å®ç°ä¸­çš„ SetInternalWardleInformerFactory() æ¥å£ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°äº†è‡ªå·±çš„ Initializer æ¥ä¼ é€’ Informer å³å¯ï¼š type pluginInitializer struct { informers informers.SharedInformerFactory } // New creates an instance of wardle admission plugins initializer. func New(informers informers.SharedInformerFactory) pluginInitializer { return pluginInitializer{ informers: informers, } } // Initialize checks the initialization interfaces implemented by a plugin // and provide the appropriate initialization data func (i pluginInitializer) Initialize(plugin admission.Interface) { if wants, ok := plugin.(WantsInternalWardleInformerFactory); ok { wants.SetInternalWardleInformerFactory(i.informers) // å°† Informer ä¼ é€’ç»™ Plugin } } // WantsInternalWardleInformerFactory defines a function which sets InformerFactory for admission plugins that need it type WantsInternalWardleInformerFactory interface { SetInternalWardleInformerFactory(informers.SharedInformerFactory) admission.InitializationValidator } WantsInternalWardleInformerFactory - ä»…ä»…æ˜¯ç‰¹é’ˆå¯¹äº Informer çš„ interface å®ç°ï¼Œä¹Ÿæ˜¯ä¸ºäº†å•å‘çš„æŠ½è±¡ï¼Œè¿™æ ·å¦‚æœå¤šä¸ª Plugin ä¾èµ–äºåŒä¸€ä¸ª Informerï¼Œé‚£ä¹ˆè‡³éœ€è¦åˆ›å»ºä¸€ä¸ª Initializer æœ€åï¼Œæ‰€æœ‰ admission.PluginInitializer è®°å½•åˆ° RecommendedOptions.ExtraAdmissionInitializers å­—æ®µï¼Œè¿™æ ·å°±ä¼šè‡ªåŠ¨è°ƒç”¨è¿›è¡Œåˆå§‹åŒ–ã€‚ o.RecommendedOptions.ExtraAdmissionInitializers = func(c *genericapiserver.RecommendedConfig) ([]admission.PluginInitializer, error) { // åˆ›å»º ClientSet client, err := clientset.NewForConfig(c.LoopbackClientConfig) if err != nil { return nil, err } // åˆ›å»º CustomResource Informerï¼Œå¹¶è®°å½•åˆ° Option ä¸­ informerFactory := informers.NewSharedInformerFactory(client, c.LoopbackClientConfig.Timeout) o.SharedInformerFactory = informerFactory // æ„å»º Admission Plugin Initializerï¼Œä¼ é€’äº† Informer // Initializer.Initialize å°† Informer ä¼ é€’ç»™äº† Admission Plugin return []admission.PluginInitializer{wardleinitializer.New(informerFactory)}, nil } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:6:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6.5 æ€»ç»“ åˆæ˜¯ä¸€ä¸ªå¤æ‚çš„æ¡†æ¶æ¬çš„å®ç°ï¼Œçœ‹ä¸‹é‡è¦çš„å‡ ä¸ªç‚¹ï¼š RecommendedOptions.Admission è®°å½•ç€æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ Admission Pluginï¼Œè‡ªå·±ç¼–å†™çš„ä¹Ÿæ˜¯æ³¨å†Œåˆ°å…¶ä¸­ã€‚ RecommendedOptions.ExtraAdmissionInitializers è®°å½•ç€åˆå§‹åŒ– Plugin çš„å®ç°ï¼Œç”¨äºåœ¨ä»£ç ä¸­å‘å„ä¸ª Plugin ä¼ é€’ Informer ç­‰åŸºç¡€ç»„ä»¶ã€‚ æˆ‘ä»¬éœ€è¦ç¼–å†™ç±»å®ç° admission.Interface + admission.MutationInterface + admission.ValidationInterfaceã€‚åœ¨ Admit() å‡½æ•°ä¸­è¿›è¡Œ Mutateï¼Œåœ¨ Validate() å‡½æ•°ä¸­è¿›è¡Œ Validateã€‚ å¦‚æœæˆ‘ä»¬çš„ Plugin éœ€è¦ä½¿ç”¨ Informer è¿™æ ·çš„ç»„ä»¶ï¼Œè¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªç±»å®ç° admission.PluginInitializerï¼Œç”¨äºä¼ é€’ Informerã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:6:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7 åˆå§‹åŒ–ä¸å¯åŠ¨ çœ‹ main å‡½æ•°ï¼Œä¸€åˆ‡çš„å…¥å£æ˜¯ä¸€ä¸ª Option: func main() { // åˆå§‹åŒ–æ—¥å¿— logs.InitLogs() defer logs.FlushLogs() // æ³¨å†Œ SIGTERM ä¸ SIGINT ä¿¡å· stopCh := genericapiserver.SetupSignalHandler() // æ„å»º Option options := server.NewWardleServerOptions(os.Stdout, os.Stderr) // å¾—åˆ° cmd å‘½ä»¤è¡Œ cmd := server.NewCommandStartWardleServer(options, stopCh) cmd.Flags().AddGoFlagSet(flag.CommandLine) if err := cmd.Execute(); err != nil { klog.Fatal(err) } } NewCommandStartWardleServer å¾—åˆ°ä¸€ä¸ª cobra.Commandï¼Œæ‰€ä»¥å…¶çœŸæ­£çš„è¿è¡Œå…¥å£åœ¨è¿™é‡Œé¢ï¼š // NewCommandStartWardleServer provides a CLI handler for 'start master' command // with a default WardleServerOptions. func NewCommandStartWardleServer(defaults *WardleServerOptions, stopCh \u003c-chan struct{}) *cobra.Command { o := *defaults cmd := \u0026cobra.Command{ Short: \"Launch a wardle API server\", Long: \"Launch a wardle API server\", RunE: func(c *cobra.Command, args []string) error { if err := o.Complete(); err != nil { return err } if err := o.Validate(args); err != nil { return err } if err := o.RunWardleServer(stopCh); err != nil { return err } return nil }, } // æ³¨å†Œå‘½ä»¤è¡Œå‚æ•°ï¼ŒOption ä¸­æ‰€æœ‰å­—æ®µéƒ½å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°é…ç½® flags := cmd.Flags() o.RecommendedOptions.AddFlags(flags) utilfeature.DefaultMutableFeatureGate.AddFlag(flags) return cmd } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.1 Options å¯åŠ¨ Server çš„ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯å¾—åˆ° Optionï¼Œä»£ç ä¸­åˆ›å»ºçš„æ˜¯ WardleServerOptionsï¼Œå…¶æœ€é‡è¦çš„å°±æ˜¯åŒ…å«äº† RecommendedOptionsï¼Œè¿™æ˜¯ k8s.io/apiserver åº“æä¾›çš„åŒ…å«æ‰€æœ‰æœ€åŸºæœ¬çš„ APIServer é…ç½®ã€‚ // WardleServerOptions contains state for master/api server type WardleServerOptions struct { // RecommendedOptions è®°å½•å®˜æ–¹çš„é…ç½®ï¼ŒåŒ…å«å¤§å¤šæ•° APIServer æŒ‡å®šçš„é…ç½® RecommendedOptions *genericoptions.RecommendedOptions SharedInformerFactory informers.SharedInformerFactory StdOut io.Writer StdErr io.Writer } // RecommendedOptions contains the recommended options for running an API server. // If you add something to this list, it should be in a logical grouping. // Each of them can be nil to leave the feature unconfigured on ApplyTo. type RecommendedOptions struct { Etcd *EtcdOptions // åç«¯å­˜å‚¨ç›¸å…³ SecureServing *SecureServingOptionsWithLoopback // HTTPS ç›¸å…³é…ç½® Authentication *DelegatingAuthenticationOptions Authorization *DelegatingAuthorizationOptions Audit *AuditOptions // å®¡è®¡ç›¸å…³ï¼Œé»˜è®¤å…³é—­ï¼Œå¼€å¯åå¯ä»¥è¾“å‡ºå®¡è®¡æ—¥å¿—æˆ–è€…å‘é€å®¡è®¡äº‹ä»¶åˆ°å¤–éƒ¨åç«¯ç³»ç»Ÿ Features *FeatureOptions // å¼€å¯æˆ–ç¦ç”¨æŸäº› Alpha æˆ– Beta åŠŸèƒ½ CoreAPI *CoreAPIOptions // è®¿é—® Kubernetes APIServer çš„ kubeconfig æ–‡ä»¶è·¯å¾„ // FeatureGate is a way to plumb feature gate through if you have them. FeatureGate featuregate.FeatureGate // ExtraAdmissionInitializers is called once after all ApplyTo from the options above, to pass the returned // admission plugin initializers to Admission.ApplyTo. ExtraAdmissionInitializers func(c *server.RecommendedConfig) ([]admission.PluginInitializer, error) Admission *AdmissionOptions // API Server Egress Selector is used to control outbound traffic from the API Server EgressSelector *EgressSelectorOptions // Traces contains options to control distributed request tracing. Traces *TracingOptions } æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä½¿ç”¨ RecommendedOptionsï¼Œä½¿ç”¨æä¾›çš„ genericoptions.NewRecommendedOptions() æ¥åˆ›å»ºï¼š const defaultEtcdPathPrefix = \"/registry/wardle.example.com\" // NewWardleServerOptions returns a new WardleServerOptions func NewWardleServerOptions(out, errOut io.Writer) *WardleServerOptions { o := \u0026WardleServerOptions{ // NewRecommendedOptions åˆ›å»º APIServer æ¨èçš„é…ç½®ï¼Œå¤§å¤šæ•°éƒ½åŒ…å«äº†é»˜è®¤çš„é…ç½® RecommendedOptions: genericoptions.NewRecommendedOptions( defaultEtcdPathPrefix, // å­˜åœ¨ Etcd ä¸­çš„ path å‰ç¼€ apiserver.Codecs.LegacyCodec(v1alpha1.SchemeGroupVersion), // æ³¨å†Œè§£ç å™¨ ), StdOut: out, StdErr: errOut, } o.RecommendedOptions.Etcd.StorageConfig.EncodeVersioner = runtime.NewMultiGroupVersioner(v1alpha1.SchemeGroupVersion, schema.GroupKind{Group: v1alpha1.GroupName}) return o } L13 - å®šä¹‰ ETCD å­˜å‚¨çš„ç‰ˆæœ¬ 7.1.1 Complete Option å¯åŠ¨ Server çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è°ƒç”¨ WardleServerOptions.Complete()ï¼Œå…¶ä¸­ä¸»è¦ä½œç”¨å°±æ˜¯æ³¨å†Œè‡ªå®šä¹‰çš„ Admission Pluginï¼š // Complete fills in fields required to have valid data func (o *WardleServerOptions) Complete() error { // æ³¨å†Œ BanFlunder çš„ Admission Plugin // register admission plugins banflunder.Register(o.RecommendedOptions.Admission.Plugins) // è®°å½•åˆ° Plugins ä¸­ // add admission plugins to the RecommendedPluginOrder o.RecommendedOptions.Admission.RecommendedPluginOrder = append(o.RecommendedOptions.Admission.RecommendedPluginOrder, \"BanFlunder\") return nil } 7.1.2 Validate Option å¯åŠ¨ Server çš„ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨ WardleServerOptions.Validate() è¿›è¡Œå‚æ•°éªŒè¯ã€‚å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨é¢å¤–çš„å‚æ•°ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨ RecommendedOptions.Validate(): // Validate validates WardleServerOptions func (o WardleServerOptions) Validate(args []string) error { errors := []error{} // éªŒè¯ Option çš„åˆæ³•æ€§ï¼Œæ‰§è¡Œå„ä¸ª XXXOptions.Validate() errors = append(errors, o.RecommendedOptions.Validate()...) return utilerrors.NewAggregate(errors) } 7.1.3 Run Server å¯åŠ¨ Server çš„ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨ WardleServerOptions.RunWardleServer è¿è¡Œä¸€ä¸ª Serverã€‚å…¶æµç¨‹ä¸ºï¼šOptions -\u003e Config -\u003e APIServerï¼Œæœ€åçœŸæ­£è¿è¡Œï¼š // RunWardleServer starts a new WardleServer given WardleServerOptions func (o WardleServerOptions) RunWardleServer(stopCh \u003c-chan struct{}) error { // Option è½¬åŒ–ä¸º APIServer Config config, err := o.Config() if err != nil { return err } // config.Complete() å¡«å……ä¸€äº›é»˜è®¤çš„å‚æ•° // New() å¾—åˆ°ä¸€ä¸ª Server å¯¹è±¡ï¼Œå¹¶æ³¨å†Œ APIGroup åˆ° Kubernetes APIServer // NOTE: Custom APIServer çš„å…³é”®å°±åœ¨è¿™é‡Œï¼Œæ³¨å†Œäº†ä¸€ä¸ª APIGroupï¼ŒKubernetes APIServer // ä¼šæ ¹æ®æ³¨å†Œçš„ APIGroup æ¥è½¬å‘è¯·æ±‚ server, err := config.Complete().New() if err != nil { return err } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:7:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.2 Config å¯åŠ¨ Server çš„ç¬¬äºŒé˜¶æ®µæ˜¯ Config ç±»ï¼Œä¸ Option ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¼šåŒ…å« k8s.io/apiserver åº“æä¾›çš„ RecommendedConfig: type Config struct { GenericConfig *genericapiserver.RecommendedConfig ExtraConfig ExtraConfig } RecommendedConfig æœ‰ç€è®¸å¤šçš„é…ç½®é¡¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æ·±å…¥å…¶å®ç°ï¼Œä¸»è¦è§‚å¯Ÿå¦‚ä½•ä½¿ç”¨å®ƒã€‚ä¹Ÿå°±æ˜¯å¦‚ä½•ä» Configï¼Œå¾—åˆ° APIServer å¯¹è±¡ã€‚ æ­£å¦‚ä¹‹å‰çœ‹åˆ°çš„ï¼Œç”± Option è½¬åŒ–ä¸º Config å¯¹è±¡ï¼š // æ–°å»º RecommendedConfig serverConfig := genericapiserver.NewRecommendedConfig(apiserver.Codecs) // é…ç½®ç”Ÿæˆ OpenAPI ç›¸å…³é…ç½® serverConfig.OpenAPIConfig = genericapiserver.DefaultOpenAPIConfig(sampleopenapi.GetOpenAPIDefinitions, openapi.NewDefinitionNamer(apiserver.Scheme)) serverConfig.OpenAPIConfig.Info.Title = \"Wardle\" serverConfig.OpenAPIConfig.Info.Version = \"0.1\" // å°† Option è½¬æ¢ä¸º Config if err := o.RecommendedOptions.ApplyTo(serverConfig); err != nil { return nil, err } // å¾—åˆ° APIServer Config // åŒ…å«: // 1. RecommendedConfig - é¢„å®šçš„é€šç”¨ Config // 2. ExtraConfig - è‡ªèº«å¯ä¼ é€’çš„ä¸€äº› Config config := \u0026apiserver.Config{ GenericConfig: serverConfig, ExtraConfig: apiserver.ExtraConfig{}, } ä» Config å¾—åˆ° Server å¯¹è±¡å°±å¾ˆç®€å•äº†ï¼š server, err := config.Complete().New() if err != nil { return err } 7.2.1 Complete Config Complete è¿‡ç¨‹ä¾æ—§ç®€å•ï¼Œæ‰§è¡Œ GenericConfig.Complete() ä»¥åŠè®¾ç½®åˆ°ç‰ˆæœ¬å·å³å¯ï¼Œè¿”å›ä¸€ä¸ª CompletedConfig å¯¹è±¡ï¼š // CompletedConfig embeds a private pointer that cannot be instantiated outside of this package. type CompletedConfig struct { *completedConfig } func (cfg *Config) Complete() CompletedConfig { c := completedConfig{ cfg.GenericConfig.Complete(), \u0026cfg.ExtraConfig, } c.GenericConfig.Version = \u0026version.Info{ Major: \"1\", Minor: \"0\", } return CompletedConfig{\u0026c} } ä¸ºä½•ä½¿ç”¨æ–°çš„å¯¹è±¡ CompletedConfig? CompletedConfig æ‰åŒ…å« New() æ–¹æ³•ï¼Œè¿™æ ·èƒ½ä¿è¯ New APIServer æ—¶ä¸€å®šæ˜¯ç»è¿‡ Complete Config çš„ã€‚ 7.2.2 New APIServer New APIServer è¿‡ç¨‹åœ¨åˆ›å»ºä¸€ä¸ª APIServer å¯¹è±¡åï¼Œå°±å®Œæˆäº† HTTP API Handle çš„æ³¨å†Œäº†ï¼Œè€Œè¿™å°±æ˜¯æœ€å…³é”®çš„åœ°æ–¹ï¼š // New returns a new instance of WardleServer from the given config. func (c completedConfig) New() (*WardleServer, error) { // CompletedConfig å¾—åˆ°ä¸€ä¸ª GenericAPIServer genericServer, err := c.GenericConfig.New(\"sample-apiserver\", genericapiserver.NewEmptyDelegate()) if err != nil { return nil, err } // Custom APIServer å¯¹è±¡ s := \u0026WardleServer{ GenericAPIServer: genericServer, } // æ„å»º APIGroupInfo apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(wardle.GroupName, Scheme, metav1.ParameterCodec, Codecs) // æ„å»º APIGroup // ä¸€ä¸ª rest.Storage å¯¹åº”äº†ä¸€ä¸ª HTTP API Endpoint // å³ /apis/\u003cgroup\u003e/\u003cversion\u003e/\u003cresource\u003e // ä¸‹é¢æ³¨å†Œäº†ä¸¤ä¸ª Endpoint // + /apis/wardle.example.com/v1alpha1/flunders // + /apis/wardle.example.com/v1alpha1/fischers v1alpha1storage := map[string]rest.Storage{} v1alpha1storage[\"flunders\"] = wardleregistry.RESTInPeace(flunderstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) v1alpha1storage[\"fischers\"] = wardleregistry.RESTInPeace(fischerstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) apiGroupInfo.VersionedResourcesStorageMap[\"v1alpha1\"] = v1alpha1storage // ä¸‹é¢æ³¨å†Œäº†ä¸€ä¸ª Endpoint // + /apis/wardle.example.com/v1beta1/flunders v1beta1storage := map[string]rest.Storage{} v1beta1storage[\"flunders\"] = wardleregistry.RESTInPeace(flunderstorage.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)) apiGroupInfo.VersionedResourcesStorageMap[\"v1beta1\"] = v1beta1storage // æ³¨å†Œ APIGroup åˆ° Kubernetes APIServer if err := s.GenericAPIServer.InstallAPIGroup(\u0026apiGroupInfo); err != nil { return nil, err } return s, nil } ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:7:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.3 Server æ€»ç®—æ¥åˆ°æœ€åçš„é˜¶æ®µï¼ŒServer å¯¹è±¡å°±æ˜¯ä¸€ä¸ª APIServer çš„å®ç°äº†ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨åº“æä¾›çš„ GenericAPIServer å®ç°çš„ PrepareRun() ä¸ Run() æ¥å£å®ç°å³å¯è¿è¡Œã€‚ server, err := config.Complete().New() if err != nil { return err } // æ³¨å†Œä¸€ä¸ª PostStart Hook // Hook ä¼šåœ¨ HTTPs Server å¯åŠ¨å¹¶ç›‘å¬åè¢«è°ƒç”¨ server.GenericAPIServer.AddPostStartHookOrDie(\"start-sample-server-informers\", func(context genericapiserver.PostStartHookContext) error { // å¯åŠ¨åŸç”Ÿå¯¹è±¡çš„ SharedInformer config.GenericConfig.SharedInformerFactory.Start(context.StopCh) // å¯åŠ¨ Custom Resource Informer o.SharedInformerFactory.Start(context.StopCh) return nil }) // PrepareRun æ‰§è¡Œå¯åŠ¨å‰çš„å‡†å¤‡å·¥ä½œ // Run è¿è¡Œ HTTPs Server return server.GenericAPIServer.PrepareRun().Run(stopCh) ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:7:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"8 éƒ¨ç½² ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:8:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"8.1 éƒ¨ç½²æ¸…å• æ¸…å•ï¼š APIService Service Deployment ServiceAccount + ClusterRole + ClusterRoleBinding ä¹‹å‰æåˆ°ï¼ŒAPIService å¯¹è±¡å‘åŸç”Ÿ Kubernetes APIServer æ³¨å†Œä¸€ä¸ª Custom APISeverã€‚å› æ­¤è¿™æ˜¯å¿…é¡»è¦éƒ¨ç½²çš„ã€‚ apiVersion:apiregistration.k8s.io/v1kind:APIServicemetadata:name:v1alpha1.wardle.example.comspec:insecureSkipTLSVerify:truegroup:wardle.example.comgroupPriorityMinimum:1000versionPriority:15service:name:apinamespace:wardleversion:v1alpha1 æ³¨æ„ï¼Œæµ‹è¯•ç¯å¢ƒæˆ‘ä»¬å°† spec.insecureSkipTLSVerify è®¾ä¸º trueï¼Œè€Œç”Ÿäº§ç¯å¢ƒä¸èƒ½è¿™ä¹ˆåšã€‚ APIService ä»…ä»…æ˜¯è®© Kubernetes APIServer çŸ¥æ™“ Custom APIServer å­˜åœ¨ï¼Œä¸ºäº†èƒ½å¤Ÿè½¬å‘è¯·æ±‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦éƒ¨ç½² Custom APIServer ä½¿ç”¨çš„ Service å¯¹è±¡ã€‚ apiVersion:v1kind:Servicemetadata:name:apinamespace:wardlespec:ports:- port:443protocol:TCPtargetPort:443selector:apiserver:\"true\" è¿è¡Œæˆ‘ä»¬ Custom APIServer ç¨‹åºçš„ Deploymentã€‚ apiVersion:apps/v1kind:Deploymentmetadata:name:wardle-servernamespace:wardlelabels:apiserver:\"true\"spec:replicas:1selector:matchLabels:apiserver:\"true\"template:metadata:labels:apiserver:\"true\"spec:serviceAccountName:apiservercontainers:- name:wardle-server# build from staging/src/k8s.io/sample-apiserver/artifacts/simple-image/Dockerfile# or# docker pull k8s.gcr.io/e2e-test-images/sample-apiserver:1.17.4# docker tag k8s.gcr.io/e2e-test-images/sample-apiserver:1.17.4 kube-sample-apiserver:latestimage:kube-sample-apiserver:latestimagePullPolicy:Neverargs:[\"--etcd-servers=http://localhost:2379\"]- name:etcdimage:quay.io/coreos/etcd:v3.5.0 Note APIServer æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥å¦‚æœä½ åªéƒ¨ç½²ä¸€ä¸ª etcd ä½œä¸ºåç«¯å­˜å‚¨æƒ…å†µä¸‹ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ª Custom APIServerï¼Œå¹¶ä¸”ä¸éœ€è¦è¿›è¡Œé€‰ä¸¾ã€‚ è®¿é—® Kubernetes APIServer ä½¿ç”¨çš„ ServiceAccountï¼š kind:ServiceAccountapiVersion:v1metadata:name:apiservernamespace:wardle ClusterRole æä¾›ç›¸å…³çš„è®¿é—®æƒé™ï¼Œä¸»è¦åŒ…æ‹¬ï¼š namespace - ä¸ºäº†å®ç° Namespace åˆ é™¤æ—¶ï¼Œå…¶ä¸‹ç›¸å…³å¯¹è±¡ä¹Ÿè¢«åˆ é™¤ï¼Œéœ€è¦ namespace ç›¸å…³æƒé™ admission webhook - ä¸ºäº†èƒ½å¤Ÿæ”¯æŒ admission webhook kind:ClusterRoleapiVersion:rbac.authorization.k8s.io/v1metadata:name:aggregated-apiserver-clusterrolerules:- apiGroups:[\"\"]resources:[\"namespaces\"]verbs:[\"get\",\"watch\",\"list\"]- apiGroups:[\"admissionregistration.k8s.io\"]resources:[\"mutatingwebhookconfigurations\",\"validatingwebhookconfigurations\"]verbs:[\"get\",\"watch\",\"list\"] ClusterRoleBinding è¿æ¥ ClusterRole ä¸ ServiceAccountï¼Œå¹¶ä¸”è¿˜éœ€è¦ç»‘å®šä¸€äº›é¢„åˆ›å»ºçš„ ClusterRoleã€‚ apiVersion:rbac.authorization.k8s.io/v1kind:ClusterRoleBindingmetadata:name:sample-apiserver-clusterrolebindingroleRef:apiGroup:rbac.authorization.k8s.iokind:ClusterRolename:aggregated-apiserver-clusterrolesubjects:- kind:ServiceAccountname:apiservernamespace:wardleapiVersion:rbac.authorization.k8s.io/v1kind:ClusterRoleBindingmetadata:name:wardle:system:auth-delegatorroleRef:apiGroup:rbac.authorization.k8s.iokind:ClusterRolename:system:auth-delegatorsubjects:- kind:ServiceAccountname:apiservernamespace:wardle# ä¸ºäº†ä»£ç†è®¤è¯å’ŒæˆæƒapiVersion:rbac.authorization.k8s.io/v1kind:RoleBindingmetadata:name:wardle-auth-readernamespace:kube-systemroleRef:apiGroup:rbac.authorization.k8s.iokind:Rolename:extension-apiserver-authentication-readersubjects:- kind:ServiceAccountname:apiservernamespace:wardle ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:8:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"8.2 é…ç½®è¯ä¹¦ å‰é¢æˆ‘ä»¬ä½¿ç”¨ APIService ä¸­çš„ spec.insecureSkipTLSVerify ä¸º false æ¥è®© Custom APIServer ä¸ Kubernetes APIServer ä¹‹å‰é€šä¿¡è·³è¿‡ TLS é‰´æƒã€‚ å¦‚æœéœ€è¦é…ç½® TLSï¼Œå¯ä»¥åœ¨ APIService ä¸­çš„ spec.caBundle å­—æ®µé…ç½® Custom APISever çš„æ ¹è¯ä¹¦ï¼Œè¿™æ · Kubernetes APIServer å°±ä¼šä½¿ç”¨è¯¥è¯ä¹¦æ¥å¯¹ Custom APISever è¿›è¡Œé‰´æƒã€‚ å¯¹äº Custom APIServerï¼Œæˆ‘ä»¬åˆ›å»ºå¥½ Server çš„è¯ä¹¦ä¸ç§é’¥åï¼Œåˆ›å»ºä¸€ä¸ª Secret å¯¹è±¡ï¼Œç„¶åå°†å…¶æŒ‚è½½åˆ° Pod çš„ /var/run/apiserver/serving-cert/tls.{crt,key} æ–‡ä»¶ä¸­ã€‚ Note /var/run/apiserver/serving-cert/tls.{crt,key} æ˜¯é»˜è®¤çš„æ”¾ç½® APIServer è¯ä¹¦ä¸ç§é’¥çš„ç›®å½•ã€‚ ä½ å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•° â€“cert-dir â€œdirâ€ æŒ‡å®šè¯ä¹¦ä¸ç§é’¥çš„ç›®å½•ã€‚ æˆ–è€…ï¼Œé€šè¿‡ â€“tls-cert-file â€œfileâ€ ä¸ â€“tls-private-key-file â€œfileâ€ æŒ‡å®šè¯ä¹¦æ–‡ä»¶ä¸ç§é’¥æ–‡ä»¶ã€‚ ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:8:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ k8s.io/apiserver ã€ŠProgramming Kubernetesã€‹ Configure the Aggregation Layer ","date":"2021-08-22","objectID":"/posts/cloud_computing/k8s_programming/6-custom-api-server/:9:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 6 - Custom APIServer","uri":"/posts/cloud_computing/k8s_programming/6-custom-api-server/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 æ‰“åŒ… ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.1 Helm Helm å·²ç»æˆä¸º Kubernetes åŒ…ç®¡ç†å™¨çš„äº‹å®æ ‡å‡†ã€‚é€šè¿‡å¼•å…¥ä¸€ä¸ª Chart çš„æ¦‚å¿µï¼Œå¸®åŠ©å®‰è£…ä¸å‡çº§ Kubernetes åº”ç”¨ã€‚ Chart å®è´¨ä¸Šæ˜¯ä¸€ä¸ªå‚æ•°åŒ–çš„ YAML æ–‡ä»¶ï¼Œä¸‹é¢æ˜¯ Chart ä¸€ä¸ª template æ–‡ä»¶çš„ä¾‹å­ï¼š apiVersion:apps/v1 kind:Deployment metadata:name:{{include \"flagger.fullname\" . }} # ... spec:replicas:1strategy:type:Recreate selector:matchLabels:app.kubernetes.io/name:{{template \"flagger.name\" . }} app.kubernetes.io/instance:{{.Release.Name }} template:metadata:labels:app.kubernetes.io/name:{{template \"flagger.name\" . }} app.kubernetes.io/instance: {{ .Release.Name }} spec:serviceAccountName:{{template \"flagger.serviceAccountName\" . }} containers:- name:flagger securityContext:readOnlyRootFilesystem:truerunAsUser:10001image:\"{{ .Values.image.repository }}:{{ .Values.image.tag }}\" å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½ä»¥ {{ .Some.value.here }} çš„æ ¼å¼è¡¨ç¤ºã€‚ é€šè¿‡ helm install å‘½ä»¤ï¼Œå°±å¯ä»¥å®‰è£…ä¸€ä¸ª Chartã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯å®‰è£…å®˜æ–¹å‘å¸ƒçš„ä¸€äº› Chartï¼š # get the latest list of charts: $ helm repo update # install MySQL: $ helm install stable/mysql Released smiling-penguin # list running apps: $ helm ls NAME VERSION UPDATED STATUS CHART smiling-penguin 1 Wed Sep 28 12:59:46 2016 DEPLOYED mysql-0.1.0 # remove it: $ helm delete smiling-penguin Removed smiling-penguin æƒ³è¦å‘å¸ƒçš„ä½ çš„ Controllerï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ª Helm Chart å¹¶ä¸Šä¼ åˆ°å…¬å…±ä»“åº“ã€‚é»˜è®¤æƒ…å†µï¼Œä½ å¯ä»¥æŠŠå®ƒå‘å¸ƒåˆ° Artifact Hub æä¾›çš„å…¬å…±ä»“åº“ã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.2 Kustomize Kustomize æä¾›äº†å¯¹èµ„æºæ–‡ä»¶çš„ä¸€ç§å£°æ˜å¼çš„é…ç½®æ–¹æ³•ã€‚ Kustomize å¯ä»¥å¸®åŠ©ä½ è‡ªå®šä¹‰ YAML æ–‡ä»¶ï¼Œè€Œä¸ç”¨ä¿®æ”¹åŸå§‹çš„æ–‡ä»¶ã€‚ ä¾‹å¦‚ï¼Œä½ å…ˆå®šä¹‰ä¸€ä¸ª kustomization.yaml æ–‡ä»¶ï¼š imageTags:- name:quay.io/programming-kubernetes/cnat-operator newTag:0.1.0resources:- cnat-controller.yaml ç„¶ååˆ›å»ºåŸå§‹çš„æ–‡ä»¶ cnat-controller.yaml ä¸Šï¼š apiVersion:apps/v1beta1 kind:Deployment metadata:name:cnat-controller spec:replicas:1template:metadata:labels:app:cnat spec:containers:- name:custom-controller image:quay.io/programming-kubernetes/cnat-operator ä½¿ç”¨ kustomize build å‘½ä»¤ï¼Œcat-controller.yaml æ–‡ä»¶ä¸å˜ï¼Œä½†æ˜¯ä¼šè¾“å‡ºå¦‚ä¸‹é…ç½®ï¼š apiVersion:apps/v1beta1 kind:Deployment metadata:name:cnat-controller spec: replicas:1template:metadata:labels:app:cnat spec:containers:- name:custom-controller image:quay.io/programming-kubernetes/cnat-operator:0.1.0l ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.3 æœ€ä½³æ‰“åŒ…å®è·µ æ— è®ºä½ ç”¨ä»€ä¹ˆæœºåˆ¶ï¼Œä¸‹é¢è¿™äº›ç»éªŒéƒ½å¾ˆé€‚ç”¨ï¼š æä¾›ä¸€ä¸ªåˆé€‚çš„æƒé™æ§åˆ¶è®¾ç½®ï¼šä¸€ä¸ªä¸“é—¨çš„ ServiceAccountï¼ŒServiceAccount ç»‘å®šæœ€å°æƒé™çš„ RBAC è®¸å¯ã€‚ ç¡®è®¤ä½ çš„ Controller çš„æ§åˆ¶èŒƒå›´ï¼Œä¸€ä¸ªå‘½åç©ºé—´è¿˜æ˜¯å¤šä¸ªå‘½åç©ºé—´ã€‚å‚è€ƒ Twitter ä¸­çš„è®¨è®ºã€‚ æµ‹è¯•å’Œåˆ†æä½ çš„ Controller ä½¿å¾—ä½ å¯¹å®ƒè¿è¡Œæ‰€éœ€è¦çš„èµ„æºæœ‰æ‰€æ¦‚å¿µã€‚ä¾‹å¦‚ï¼ŒRed Hat åœ¨ OperatorHub æœ‰ç€è¯¦ç»†çš„è§„å®šä¸è¯´æ˜ã€‚ ç¡®ä¿ CRD å’Œ Controller æœ‰ç€é½å…¨çš„æ–‡æ¡£ã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 ç”Ÿå‘½å‘¨æœŸç®¡ç† ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„åŸºæœ¬æ€æƒ³ï¼šè€ƒè™‘ä»å¼€å‘åˆ°å‘å¸ƒåˆ°å‡çº§çš„æ•´ä¸ªé“¾è·¯ï¼ŒæŠŠè¿™ä¸ªè¿‡ç¨‹çš„è‡ªåŠ¨åŒ–åšåˆ°æè‡´ã€‚ä¸ºäº†å®‰è£…å’Œå‡çº§ Operatorï¼Œä½ éœ€è¦ä¸€ä¸ªä¸“é—¨çš„ Operator æ¥å¤„ç†å…¶ä»–çš„ Operatorã€‚è€Œè¿™å°±æ˜¯æ‰€è°“çš„ Operator Lifecycle Managerï¼Œç®€ç§° OLMã€‚ ç®€è€Œè¨€ä¹‹ï¼ŒOLM æä¾›äº†ä¸€ç§å£°æ˜å¼çš„æ–¹å¼æ¥å®‰è£…å’Œå‡çº§ Operator ä»¥åŠå…¶ä¾èµ–ã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 éƒ¨ç½² ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.1 å°†æƒé™è®¾ç½®æ­£ç¡® CRD Controller éœ€è¦ä¸€ç³»åˆ—æ­£ç¡®çš„æƒé™ï¼Œé€šè¿‡ RBAC ç›¸å…³çš„è®¾ç½®æ¥å®ç°ã€‚ å…¶é‡ç‚¹æ˜¯ï¼šä½ éœ€è¦åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ ServiceAccount æ¥è¿è¡Œ Controllerï¼Œè€Œä¸è¦ä½¿ç”¨ default ServiceAccountã€‚ æœ€ä½³å®è·µæ˜¯ï¼šå®šä¹‰ä¸€ä¸ªæ‹¥æœ‰å¿…è¦çš„ RBAC è§„åˆ™çš„ ClusterRole å’Œä¸€ä¸ª RoleBindingï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°æŒ‡å®šçš„å‘½åç©ºé—´ã€‚å¹¶ä¸”åªèµ‹äºˆ Controller å·¥ä½œçš„æœ€å°æƒé™ã€‚ ä¸€äº›å®è·µçš„ç»éªŒæ˜¯ï¼ŒController ä¸åº”è¯¥å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š å¯¹ä»£ç é‡Œé€šå¸¸æ˜¯åªè¯»èµ„æºçš„å†™æƒé™ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åªéœ€è¦ watch Service å’Œ Deploymentï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦æä¾› createã€update ç­‰æƒé™ã€‚ è®¿é—®æ‰€æœ‰çš„ Secretï¼Œé™åˆ¶ Role åªèƒ½è®¿é—®å¿…è¦çš„ Secretã€‚ å†™å…¥ MutatingWebhookConfiguration æˆ– ValidatingWebhook çš„æƒé™ã€‚æœ‰äº†è¿™ä¸¤ä¸ªåŸå‹éƒ½ç­‰äºæ‹¥æœ‰äº†å¯¹é›†ç¾¤é‡Œæ‰€æœ‰èµ„æºçš„è®¿é—®æƒé™ä¸€æ ·ã€‚ å†™å…¥ CustomResourceDefinition çš„æƒé™ã€‚CRD çš„åˆ›å»ºåº”è¯¥æ˜¯ç”±å¦å¤–çš„è¿›ç¨‹åˆ›å»ºï¼Œè€Œä¸æ˜¯æ§åˆ¶å™¨è‡ªèº«ã€‚ å†™å…¥è‡ªå·±ä¸è´Ÿè´£ç®¡ç†çš„å¤–éƒ¨èµ„æºçš„ /status å­èµ„æºã€‚ audit2rbac audit2rbac å·¥å…·é€šè¿‡åˆ†æå®¡è®¡æ—¥å¿—æ¥è‡ªåŠ¨ç”Ÿæˆåˆé€‚çš„æƒé™ï¼Œè¿™å¯ä»¥å¸®åŠ©ä½ è¿›è¡Œæƒé™çš„æ§åˆ¶ã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.2 è‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯• å½“ä½ çš„ Controller å¼€å‘å¤„äºç¨³å®šæ—¶ï¼Œå°±å¯ä»¥ä¸”å¿…é¡»å¼€å§‹å„ç§æµ‹è¯•ï¼š Kubernetes è‡ªèº«ä½¿ç”¨æ€§èƒ½ç›¸å…³æµ‹è¯•ï¼Œä»¥åŠ kboom å·¥å…·ï¼Œéƒ½å¯ä»¥ç”¨äºæ€§èƒ½ç³»ç›¸å…³æµ‹è¯•ã€‚ æµ¸æ³¡æµ‹è¯•ï¼Œç”¨äºå‘ç°é•¿æœŸä½¿ç”¨åœºæ™¯ä¸‹æ˜¯å¦å‡ºç°èµ„æºæ³„æ¼é—®é¢˜ã€‚ ä½œä¸ºæœ€ä½³å®è·µï¼Œè¿™äº›æµ‹è¯•åº”è¯¥æ˜¯ä½ çš„ CI æµç¨‹çš„ä¸€éƒ¨åˆ†ã€‚å»ºè®®çœ‹çœ‹è¿™ç¯‡æ–‡ç«  Spawning Kubernetes Clusters in CI for Integration and E2E testsã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.3 å¯è§‚æµ‹æ€§ 3.3.1 æ—¥å¿— åŸºäºå®¹å™¨çš„éƒ¨ç½²æ–¹æ¡ˆä¸­ï¼Œæ—¥å¿—ä¸€èˆ¬éƒ½æ‰“å°åœ¨ stdout ä¸Šï¼Œé€šè¿‡ kubectl logs å‘½ä»¤æŸ¥çœ‹ã€‚ åœ¨ Kubernetes ä»£ç åº“ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¹¿æ³›ä½¿ç”¨çš„æ–¹æ³•ï¼š logger interfaceï¼Œhttplog.go é‡Œæä¾›äº†è¯¥ interfaceï¼Œä»¥åŠä¸€ä¸ªå…·ä½“çš„å®ç°ï¼ˆrespLoggerï¼‰ï¼Œå®ƒå¯ä»¥æ•æ‰çŠ¶æ€æˆ–é”™è¯¯ç­‰ä¿¡æ¯ã€‚ klogï¼ŒGoogle glog çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œæ˜¯ Kubernetes é¡¹ç›®ä¸­ä½¿ç”¨çš„ç»“æ„åŒ–æ—¥å¿—ã€‚ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ ã€ŠProgramming Kubernetesã€‹ ","date":"2021-08-20","objectID":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 5 - å‘å¸ƒ Operator","uri":"/posts/cloud_computing/k8s_programming/5-shipping-controllers/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ æœ€ç®€å•çš„æ–¹å¼æ˜¯è°ƒç”¨ generate-groups.sh æˆ–è€… hack/update-codegen.sh è„šæœ¬æ¥ç”Ÿæˆã€‚ $ vendor/k8s.io/code-generator/generate-groups.sh all \\ github.com/programming-kubernetes/cnat/cnat-client-go/pkg/generated \\ github.com/programming-kubernetes/cnat/cnat-client-go/pkg/apis \\ cnat:v1alpha1 \\ --output-base \"${GOPATH}/src\" \\ --go-header-file \"hack/boilerplate.go.txt\" arg2 - æŒ‡å®šè¦ç”Ÿæˆçš„ clientã€listã€informer çš„åŒ…åï¼› arg3 - APIGroup æ‰€åœ¨çš„åŒ…ï¼› arg4 - Group:Versionï¼› â€“output-base ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ‰€æœ‰ generatorï¼Œä½œä¸ºæŸ¥æ‰¾åŒ…çš„åŸºç¡€è·¯å¾„ï¼› â€“go-header æä¾›ç”Ÿæˆä»£ç ååŠ ä¸Šçš„ç‰ˆæƒå¤´ä¿¡æ¯ï¼› all å‚æ•°æ„å‘³ç€ä¼šè°ƒç”¨å››ç§æ ‡å‡†çš„ code generatorï¼š deepcopy-gen - ç”Ÿæˆ func(t *T) DeepCopy() å’Œ func(t *T) DeepCopyInto(*T) æ–¹æ³•ï¼Œç”¨äºå¯¹è±¡æ·±æ‹·è´ã€‚ client-gen - ç”Ÿæˆå¼ºç±»å‹çš„ clientsetã€‚ informer-gen - ç”Ÿæˆè‡ªå®šä¹‰èµ„æºçš„ Informerã€‚ lister-gen - ç”Ÿæˆè‡ªå®šä¹‰èµ„æºçš„ Lister å¯¹è±¡ï¼Œä¸º Get å’Œ List è¯·æ±‚æä¾›åªè¯»ç¼“å­˜å±‚ã€‚ å¦å¤–ï¼Œcode-generator è¿˜æœ‰ä¸€äº›é¢å¤–çš„ generatorï¼Œå½“ä½ éœ€è¦å¼€å‘è‡ªå·±çš„ APIServer æ—¶å¯èƒ½ä¼šç”¨åˆ°ï¼š conversion-go - åˆ›å»ºç”¨äºè½¬æ¢å†…éƒ¨ç±»å‹ä¸å¤–éƒ¨ç±»å‹çš„å‡½æ•°ã€‚ defaulter-gen - ç”Ÿæˆå¤„ç†é»˜è®¤å€¼å­—æ®µçš„ä»£ç ã€‚ verify-codegen.sh ä»£ç ä»“åº“ä¸­è¿˜ä¼šåŒ…å« hack/verify-codegen.shï¼Œç”¨äºæ£€æŸ¥ç”Ÿäº§çš„ä»£ç æ˜¯å¦æ˜¯æœ€æ–°çš„ï¼Œå¸¸å¸¸ç”¨äº CI ä¸­ã€‚ é™¤äº†é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ï¼Œå¯ä»¥é€šè¿‡åœ¨æºç ä¸­ä½¿ç”¨ç‰¹å®šçš„æ ‡ç­¾æ¥æ§åˆ¶ä»£ç ç”Ÿæˆã€‚æ ‡ç­¾åˆ†ä¸ºä¸¤ç§ï¼š doc.go æ–‡ä»¶ä¸­ package è¡Œå‰é¢çš„å…¨å±€æ ‡ç­¾ ç±»å£°æ˜å‰çš„å±€éƒ¨æ ‡ç­¾ã€‚ ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 å…¨å±€æ ‡ç­¾ å…¨å±€æ ‡ç­¾ ä¼šå†™åœ¨ doc.go æ–‡ä»¶ä¸­ã€‚ // +k8s:deepcopy-gen=package // Package v1 is the v1alpha1 version of the API. // +groupName=cnat.programming-kubernetes.info package v1alpha1 L1 - è¡¨æ˜è¦ä¸ºåŒ…ä¸­çš„æ‰€æœ‰ç±»å‹ç”Ÿæˆ DeepCopy() æ–¹æ³•ã€‚ å¦‚æœåç»­æŸäº›ç±»å‹ä¸éœ€è¦ç”Ÿæˆ DeepCopyï¼Œå¯ä»¥é€šè¿‡ // +k8s:deepcopy-gen=false è¡¨æ˜ã€‚ L4 - å®šä¹‰äº† APIGroup çš„å…¨åï¼Œå¦‚æœ Go çš„åŒ…åä¸éµå¾ª Group çš„å‘½åï¼Œé‚£ä¹ˆå¯ä»¥ç”¨è¿™ä¸ªæ ‡ç­¾æŒ‡å®š Groupã€‚ é€šè¿‡ // +groupName æ ‡ç­¾ï¼Œä»£ç ç”Ÿæˆå™¨æ‰èƒ½ä½¿ç”¨æ­£ç¡®çš„ HTTP API Pathã€‚ +groupGoName é™¤äº† +groupNameï¼Œè¿˜æœ‰ // +groupGoName å¯ä»¥è‡ªå®šä¹‰ CR ç±»å‹çš„ Kindã€‚é»˜è®¤ä¸‹ï¼Œå˜é‡ä¸ç±»å‹çš„åå­—ä¸ Kind ç›¸åŒï¼Œéƒ½æ˜¯ä»¥é¦–å­—æ¯å¤§å†™ä½œä¸ºè¡¨ç¤ºã€‚ ä¾‹å¦‚ Cnatï¼Œæ›´å¥½çš„å‘½ååº”è¯¥æ˜¯ CNAtï¼Œé€šè¿‡ // +groupGoName=CNAtï¼Œclient-gen ç”Ÿæˆçš„ä»£ç å°±æ˜¯ä¸‹é¢æ ·å­ï¼š type Interface interface { Discovery() discovery.DiscoveryInterface CNatV1() atv1alpha1.CNatV1alpha1Interface } ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 å±€éƒ¨æ ‡ç­¾ å±€éƒ¨æ ‡ç­¾ å†™åœ¨ API ç±»å‹çš„å‰é¢ï¼Œæˆ–è€…å®ƒå‰é¢ç¬¬äºŒä¸ªæ³¨é‡Šå—ä¸­ï¼š // AtSpec defines the desired state of At type AtSpec struct { // Schedule is the desired time the command is supposed to be executed. // Note: the format used here is UTC time https://www.utctime.net Schedule string `json:\"schedule,omitempty\"` // Command is the desired command (executed in a Bash shell) to be executed. Command string `json:\"command,omitempty\"` // Important: Run \"make\" to regenerate code after modifying this file } // AtStatus defines the observed state of At type AtStatus struct { // Phase represents the state of the schedule: until the command is executed // it is PENDING, afterwards it is DONE. Phase string `json:\"phase,omitempty\"` // Important: Run \"make\" to regenerate code after modifying this file } // +genclient // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // At runs a command at a given schedule. type At struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\"` Spec AtSpec `json:\"spec,omitempty\"` Status AtStatus `json:\"status,omitempty\"` } // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // AtList contains a list of At type AtList struct { metav1.TypeMeta `json:\",inline\"` metav1.ListMeta `json:\"metadata,omitempty\"` Items []At `json:\"items\"` } ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 deepcopy-gen æ ‡ç­¾ é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ // +k8s:deepcopy-gen=package é»˜è®¤ä¸ºæ‰€æœ‰ç±»å‹éƒ½ç”Ÿæˆ DeepCopy() æ–¹æ³•ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸€ä¸ªç‰¹å®šçš„ç±»å‹ç¦æ­¢ç”Ÿæˆ DeepCopy() æ–¹æ³•ã€‚ // +k8s:deepcopy-gen=false // // Helper is a helper struct, not an API type. type Helper struct { ... } ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4 runtime.Object ä¸ DeepCopyObject // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object å‰é¢æåˆ°ï¼Œruntime.Object å¿…é¡»å®ç° DeepCopyObject() æ–¹æ³•ï¼Œè€Œè¯¥æ ‡ç­¾ä¸ºç±»å‹ç”Ÿæˆå¯¹åº”çš„ DeepCopyObject æ–¹æ³•ã€‚ æˆ‘ä»¬åº”è¯¥ä¸ºæ‰€æœ‰çš„ â€é¡¶çº§å¯¹è±¡â€œï¼ˆå†…åµŒäº† metav1.TypeMetaï¼‰ä½¿ç”¨è¯¥æ ‡ç­¾ã€‚ ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"5 client-gen æ ‡ç­¾ // +genclient æ ‡ç­¾ç”¨äºå‘Šè¯‰ client-gen éœ€è¦ä¸ºè¿™ä¸ªç±»å‹åˆ›å»ºä¸€ä¸ª clientã€‚ä½†æ˜¯ï¼Œä½ ä¸éœ€è¦ä¹Ÿä¸èƒ½æŠŠè¿™ä¸ªæ ‡ç­¾ç”¨åˆ° List ç±»å‹ä¸Šã€‚ // +genclient å¦‚æœæœ‰äº›ç±»å‹æ²¡æœ‰ status å­—æ®µï¼Œæˆ–è€…æ²¡æœ‰è¿›è¡Œ spec-status åˆ†ç¦»ã€‚è¿™äº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ // +genclient:noStatus æ ‡ç­¾æ¥é¿å…ç”Ÿæˆ UpdateStatus() æ–¹æ³•ã€‚ // +genclient:noStatus Note å¦‚æœæ²¡æœ‰è¿™ä¸ªæ ‡ç­¾ï¼Œclient-gen ä¼šç›´æ¥ç”Ÿæˆ UpdateStatus() æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œåªæœ‰ä½¿ç”¨äº† /status å­èµ„æºï¼Œæ‰ä¼šåˆ†ç¦»å‡º /statusã€‚ å¦‚æœæ²¡æœ‰å¼€å¯ /status å­èµ„æºï¼Œè°ƒç”¨è¯¥æ¥å£åªä¼šç›´æ¥è¿”å›é”™è¯¯ã€‚ å¯¹äºé›†ç¾¤èŒƒå›´çš„èµ„æºï¼ˆä¸å±äº namespaceï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢æ ‡ç­¾ï¼š // +genclient:noNamespaced å¦‚æœä½ æƒ³è¦æ§åˆ¶ client èƒ½å¤Ÿè®¿é—®çš„ HTTP æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—æ ‡ç­¾æŒ‡å®šï¼š // +genclient:noVerbs // +genclient:onlyVerbs=create,delete // +genclient:skipVerbs=get,list,create,update,patch,delete,watch // +genclient:method=Create,verb=create, // result=k8s.io/apimachinery/pkg/apis/meta/v1.Status å¤§å¤šæ•°çœ‹åå­—å°±èƒ½ç†è§£ï¼Œæœ€åéœ€è¦ä¸€äº›è§£é‡Šï¼šæŒ‡å®šäº† L5 æ ‡ç­¾åï¼Œç”Ÿæˆçš„ Create æ–¹æ³•ä¸­åªä¼šæ‰§è¡Œåˆ›å»ºåŠ¨ä½œï¼Œå¹¶è¿”å›ä¸€ä¸ª metav1.Status å¯¹è±¡ï¼Œè€Œä¸æ˜¯å®ƒè‡ªèº«çš„ API ç±»å‹å¯¹è±¡ã€‚å¯¹äºè‡ªå®šä¹‰ APIServer æ¥è¯´ï¼Œå¯èƒ½ä¼šç”¨åˆ°è¿™æ ·çš„èµ„æºã€‚ ä½¿ç”¨ // +genclient:method çš„å¸¸è§åœºæ™¯æ˜¯ä¸ºèµ„æºå¢åŠ  scale ç›¸å…³æ–¹æ³•ã€‚åœ¨å¯åŠ¨ /scale å­èµ„æºåï¼Œä¸‹é¢æ ‡ç­¾å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„ client æ–¹æ³•ã€‚ // +genclient:method=GetScale,verb=get,subresource=scale,\\ // result=k8s.io/api/autoscaling/v1.Scale // +genclient:method=UpdateScale,verb=update,subresource=scale,\\ // input=k8s.io/api/autoscaling/v1.Scale,result=k8s.io/api/autoscaling/v1.Scale ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6 informer-gen å’Œ lister-gen informer-gen å’Œ lister-gen éƒ½ä¼šå¤„ç† client-gen çš„ // +genclient æ ‡ç­¾ï¼Œæ‰€æœ‰æŒ‡å®šäº†ç”Ÿæˆå®¢æˆ·ç«¯çš„ç±»å‹éƒ½ä¼šè‡ªé¡¶ç”Ÿæˆç›¸åº”çš„ Informer å’Œ Listerã€‚ ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ ã€ŠProgramming Kubernetesã€‹ ","date":"2021-08-19","objectID":"/posts/cloud_computing/k8s_programming/4-generate-code/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 4 - ä»£ç ç”Ÿæˆ","uri":"/posts/cloud_computing/k8s_programming/4-generate-code/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 è‡ªå®šä¹‰èµ„æºå®šä¹‰ ä» 1.7 ç‰ˆæœ¬è€ƒè¯•ï¼ŒKubernetes æä¾›äº† CR çš„åŠŸèƒ½ï¼ŒCR ä¼šä¸å…¶ä»–å…ƒç´ çš„ Kubernetes èµ„æºå­˜æ”¾åœ¨åŒä¸€ä¸ª etcd ä¸­ï¼Œå¹¶ç”± APISever ä¸ºå…¶æä¾› HTTP API æœåŠ¡ã€‚ å…·ä½“å®ç°ä¸Šï¼ŒAPIServer ä¸­çš„ apiextensions-apiserver ä¼šå¯¹ CR ç›¸å…³çš„ HTTP è¯·æ±‚è¿›è¡Œå¤„ç†ï¼š CR ç”± CustomResourceDefinitionï¼ˆç®€ç§° CRDï¼‰æ¥å®šä¹‰ï¼Œå…¶æœ¬èº«å°±æ˜¯ä¸€ç§ Kubernetes èµ„æºï¼Œç”¨äºæè¿°å¯ä»¥åœ¨å½“å‰é›†ç¾¤ä½¿ç”¨çš„ CRã€‚ apiVersion:apiextensions.k8s.io/v1beta1 kind:CustomResourceDefinition metadata:name:ats.cnat.programming-kubernetes.info spec:group:cnat.programming-kubernetes.info names:kind:At listKind:AtList plural:ats singular:at scope:Namespaced subresources:status:{}version:v1alpha1 versions:- name:v1alpha1 served:truestorage:true å…³äº CR ä¸ CRD æ›´å¤šçš„ä¿¡æ¯è§ K8s å­¦ä¹  - CRDã€‚ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 æœåŠ¡å‘ç°ä¿¡æ¯ å½“éƒ¨ç½² CRD åï¼Œkubectl å°±å¯ä»¥å‘ç°å¯¹åº”çš„ CR äº†ã€‚ä¸€ä¸ªå…³é”®çš„é—®é¢˜æ˜¯ï¼škubectl å¦‚ä½•å‘ç°ä¸€ä¸ªæ–°çš„ CR çš„ï¼Ÿ é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¡å…¶ kubectl æ‰§è¡Œæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£å…·ä½“çš„ç»†èŠ‚ï¼š $ kubectl get tidbcluster -v=7 kubectl é€šè¿‡è¯·æ±‚ APIServer çš„ /apis æŸ¥è¯¢æ‰€æœ‰çš„ API Groupã€‚ $ curl -H \"Authorization: Bearer $TOKEN\" --insecure $APISERVER/apis { \"kind\": \"APIGroupList\", \"apiVersion\": \"v1\", \"groups\": [ { \"name\": \"apiregistration.k8s.io\", \"versions\": [ { \"groupVersion\": \"apiregistration.k8s.io/v1\", \"version\": \"v1\" }, { \"groupVersion\": \"apiregistration.k8s.io/v1beta1\", \"version\": \"v1beta1\" } ], \"preferredVersion\": { \"groupVersion\": \"apiregistration.k8s.io/v1\", \"version\": \"v1\" } }, // ... å¯¹äºæ‰€æœ‰çš„ API Groupï¼Œè¯·æ±‚ä¸€æ¬¡ /apis/group/version æŸ¥è¯¢è¯¥ GroupVersion ä¸‹æ”¯æŒçš„æ‰€æœ‰ Resourceã€‚æ‰¾åˆ°ç¬¦åˆå‘½åå¯¹åº”çš„ Resourceã€‚ $ curl --insecure -H \"Authorization: Bearer $TOKEN\" $APISERVER/apis/pingcap.com/v1alpha1 { \"kind\": \"APIResourceList\", \"apiVersion\": \"v1\", \"groupVersion\": \"pingcap.com/v1alpha1\", \"resources\": [ { \"name\": \"tidbclusters\", \"singularName\": \"tidbcluster\", \"namespaced\": true, \"kind\": \"TidbCluster\", \"verbs\": [ \"delete\", \"deletecollection\", \"get\", \"list\", \"patch\", \"create\", \"update\", \"watch\" ], \"shortNames\": [ \"tc\" ], \"storageVersionHash\": \"2dlERqlmc8s=\" }, // ... kubectl å°†è·å–åˆ°çš„ä¿¡æ¯è½¬æ¢ä¸ºä¸‰å…ƒç»„ï¼š Groupï¼ˆå¦‚ pingcap.comï¼‰ Versionï¼ˆå¦‚ v1alpha1ï¼‰ Resourceï¼ˆå¦‚ tidbclustersï¼‰ å¯ä»¥æƒ³åˆ°ï¼Œè¿™äº›æ˜ å°„å…³ç³»åœ¨ä»£ç ä¸­éƒ½æ˜¯é ç€ RESTMapper å®ç°çš„ã€‚ kubectl çš„ç¼“å­˜ kubectl è¿˜ä¼šåœ¨ \"~/.kube/cache\" ç›®å½•ä¸­ç¼“å­˜ä¸€ä»½ Resource çš„åˆ—è¡¨ï¼Œæœ‰æ•ˆæœŸä¸º 10minã€‚ æ‰€ä»¥å¦‚ä½• CRD å‘ç”Ÿå˜åŒ–ï¼Œæœ€å¤šéœ€è¦ 10min æ‰ä¼šåœ¨ CLI ä¸­ä½“ç°å‡ºæ¥ã€‚ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 CustomResourceDefinition ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.1 åŸºæœ¬å®šä¹‰ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.2 é«˜çº§åŠŸèƒ½ 3.2.1 CRD åˆæ³•æ€§éªŒè¯ åˆ›å»ºå’Œæ›´æ–° CR æ—¶ï¼Œä¼šç”± APIServer è¿›è¡Œåˆæ³•æ€§éªŒè¯ã€‚è¯¥éªŒè¯åŸºäº CRD å®šä¹‰ä¸­çš„ validation å­—æ®µæ‰€æŒ‡å®šçš„ OpenAPI v3 Schema è¿›è¡Œã€‚ æ›´å¤æ‚çš„éªŒè¯ CRD ä¸­çš„éªŒè¯åªèƒ½åšåˆ°ç±»å‹ä¸å€¼çš„åˆæ³•æ€§éªŒè¯ï¼Œå¦‚æœéœ€è¦æ›´å¤æ‚çš„éªŒè¯ï¼Œå¯ä»¥é€šè¿‡ Admission Webhook åšåˆ°ã€‚Webhook ä¼šåœ¨åŸºäº OpenAPI çš„éªŒè¯é€»è¾‘å®Œæˆåç«‹å³è¢«è°ƒç”¨ã€‚ åœ¨ 1.14 ä¹‹å‰ï¼ŒOpenAPI v3 Schema æ˜¯å¯é€‰çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¸ç”¨åœ¨ Schema ä¸­æŒ‡å®šæ‰€æœ‰çš„å­—æ®µã€‚ ä» 1.15 å¼€å§‹ï¼ŒCRD Schema ä¼šä½œä¸º Kubernetes APIServer çš„ OpenAPI ä¸€éƒ¨åˆ†å‘å¸ƒï¼Œå½“ä½¿ç”¨ kubectl æ—¶ï¼Œå®ƒå°†ç”¨äºå®¢æˆ·ç«¯éªŒè¯ï¼Œå¯ä»¥åŠæ—¶å‘ç°æœªå®šä¹‰çš„å­—æ®µã€‚ä¾‹å¦‚ï¼Œç”¨äºåœ¨å¯¹è±¡ä¸­ä½¿ç”¨äº† foo:bar ç±»å‹ï¼Œä½†æ˜¯ OpenAPI Schema ä¸­å´æ²¡æœ‰å®šä¹‰ foo ç±»å‹ï¼Œé‚£ä¹ˆ kubectl å°±ä¼šæ‹’ç»è¯¥å¯¹è±¡ã€‚ æœªæ¥ï¼Œæœªåœ¨ Schema ä¸­æŒ‡å®šè¿‡çš„å­—æ®µä¹Ÿå°†ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œå› æ­¤å¿…é¡»ä¸º CRD æŒ‡å®š OpenAPI Schema æ¥ä¿è¯å…¶åˆæ³•æ€§ã€‚ 3.2.2 ShortName ä¸ Category CRD ä¹Ÿå¯ä»¥ä½¿ç”¨ ShortNameï¼Œä¹Ÿç§°ä¸ºåˆ«åã€‚ä¸€ç§èµ„æºå¯ä»¥ç”±å¤šä¸ªåˆ«åã€‚ kubectl api-resource å‘½ä»¤å¯ä»¥åˆ—å‡ºæ‰€æœ‰çŸ­åå­—ï¼š $ kubectl api-resource NAME SHORTNAMES APIVERSION NAMESPACED KIND bindings v1 true Binding componentstatuses cs v1 false ComponentStatus configmaps cm v1 true ConfigMap endpoints ep v1 true Endpoints events ev v1 true Event limitranges limits v1 true LimitRange namespaces ns v1 false Namespace CRD ä¸­ä¹Ÿå¯ä»¥æŒ‡å®š categories å­—æ®µï¼ŒåŠ å…¥ä¸€ä¸ªç±»åˆ«ã€‚è¿™æ · kubectl get \u003ccategory\u003e å°±å¯ä»¥åˆ—å‡ºä¸€ä¸ªç±»åˆ«ä¸‹çš„æ‰€æœ‰èµ„æºäº†ã€‚ apiVersion:apiextensions.k8s.io/v1beta1 kind:CustomResourceDefinition metadata:name:ats.cnat.programming-kubernetes.info spec:# ... categories:- all 3.2.3 æ‰“å°åˆ— 3.2.4 SubResource SubResource æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ HTTP Endpointï¼Œåœ¨æ™®é€šèµ„æºçš„ HTTP API Path ååŠ ä¸Šä¸€ä¸ªåç¼€å¾—åˆ°çš„ï¼Œä¾‹å¦‚ /logsã€/portforwardã€/exex ç­‰ã€‚ ç›®å‰ CRD æ”¯æŒä¸¤ç§ SubResourceï¼š/scale ä¸ /statusã€‚ (1) Status /status ç”¨äºç”¨æˆ·å°† CR å®ä¾‹çš„ spec ä¸ status å­—æ®µæƒé™éš”ç¦»ã€‚å› ä¸º: ç”¨æˆ·ä¸€èˆ¬ä¸ä¼šæ›´æ–° status å­—æ®µã€‚ Controller ä¸åº”è¯¥æ›´æ–° spec å­—æ®µã€‚ RBAC æ— æ³•åšåˆ°æ§åˆ¶è¿™ä¸¤ä¸ªå­—æ®µçš„æƒé™ï¼Œè€Œå¼•å…¥ /status SubResource ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¯ç”¨ status SubResource åï¼Œstatus çš„æ›´æ–°ä¸è¯»å–å°±ä¼šåŸºäº /status APIï¼Œè€Œ RBAC å¯ä»¥åšåˆ°æ§åˆ¶ HTTP endpoint çš„æƒé™ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒRBAC + status SubResource å®ç°äº† spec ä¸ status å­—æ®µçš„æƒé™éš”ç¦»ã€‚ apiVersion:rbac.authorization.k8s.io/v1 kind:Role metadata:#... rules:- apiGroups:[\"\"]resources:[\"ats/status\"]verbs:[\"update\",\"patch\"] å½“ä½ å¼€å¯ status Resource æ—¶ï¼Œä½ éœ€è¦æ³¨æ„çš„ä¸€äº›å˜åŒ–ï¼š ä¸» HTTP Endpoint ä¸Šåˆ›å»ºæˆ–æ›´æ–°èµ„æºæ—¶ï¼Œä¼šè‡ªåŠ¨å¿½ç•¥ status å­—æ®µçš„å€¼ã€‚ å¯¹åº”çš„ï¼Œ /status HTTP Endpoint çš„ä»»ä½•æ“ä½œéƒ½ä¼šå¿½ç•¥ status å­—æ®µä»¥å¤–çš„å€¼ã€‚ å½“ metadata å’Œ status ä»¥å¤–çš„å­—æ®µå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé€’å¢ metadata.generation å­—æ®µçš„å€¼ï¼ˆè¿™è¡¨æ˜äº† spec å‘ç”Ÿå˜åŒ–ï¼‰ã€‚ ä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ä¸º CRD å¼€å¯ status SubResourceï¼š apiVersion:apiextensions.k8s.io/v1beta1 kind:CustomResourceDefinition spec:subresources:status:{} WARN å¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨ status å­èµ„æºä¼šå¯¼è‡´æ›´æ–° status å­—æ®µçš„ HTTP API å‘ç”Ÿå˜åŒ–ã€‚è¿™å°±è¡¨æ˜äº†ï¼Œä½ ä¸èƒ½å¼€å¯ /status SubResource åçƒ­æ›´æ–° CRDï¼Œå› ä¸ºæ­£åœ¨è¿è¡Œä¸­çš„ Controller è¿˜æ˜¯ä¼šè¯·æ±‚ä¸» HTTP Endpoint æ¥æ›´æ–° status å­—æ®µï¼Œè€Œæ›´æ–°åè¿™å°†å¤±è´¥ã€‚ å¯¹æ­¤ï¼Œä½ å¯èƒ½éœ€è¦å‡çº§ CRD çš„ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼š apiVersion:apiextensions.k8s.io/v1beta1 kind:CustomResourceDefinition spec:# ... versions:- name:v1alpha1 served:truestorage:true- name:v1beta1 served:truesubresources:status:{} (2) Scale scale å­èµ„æºç”¨äºæŸ¥çœ‹æˆ–ä¿®æ”¹èµ„æºä¸­å®šä¹‰çš„å‰¯æœ¬æ•°é‡ã€‚è¿™ä¸ªå­èµ„æºä¸»è¦æ˜¯ç”¨äºç±»ä¼¼ Deployment å’Œ ReplicaSet è¿™æ ·æœ‰å‰¯æœ¬æ•°çš„èµ„æºï¼Œé€šè¿‡å®ƒå¯ä»¥å¯¹èµ„æºè¿›è¡Œæ‰©å®¹å’Œç¼©å®¹ã€‚ kubectl scale å°±æ˜¯é€šè¿‡ /scale å­èµ„æºæ¥å®ç°çš„ã€‚ $ kubectl scale --replicas=3 your-custom-resource -v=7 I0429 21:17:53.138353 66743 round_trippers.go:383] PUT https://host/apis/group/v1/your-custom-resource/scale apiVersion:apiextensions.k8s.io/v1beta1 kind:CustomResourceDefinition spec:subresources:scale:specReplicasPath:.spec.replicas statusReplicasPath:.status.replicas labelSelectorPath:.status.labelSelector ... å½“ç„¶ï¼Œ/scale åªèƒ½ä¿®æ”¹ replica çš„å€¼ï¼Œè€Œå…¶å…·ä½“çš„æ“ä½œè¿˜æ˜¯éœ€è¦è‡ªå®šä¹‰ Controller å®ç°çš„ã€‚ /scale HTTP Endpoint è¯»å–æˆ–å†™å…¥çš„å¯¹è±¡ Kind ä¸º Scaleï¼Œå±äº autoscaling/v1 APIGroupã€‚ // Scale represents a scaling request for a resource. type Scale struct { metav1.TypeMeta `json:\",inline\"` // Standard object metadata; More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata. // +optional metav1.ObjectMeta `json:\"metadata,omitempty\" protobuf:\"bytes,1,opt,name=metadata\"` // defines the behavior of the scale. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status. // +optional Spec ScaleSpec `json:\"spec,omitempty\" protobuf:\"bytes,2,opt,name=spec\"` // current status of the scale. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status. Read-only. // +optional Status ScaleStatus `json:\"status,omitempty\" protobuf:\"bytes,3,opt,name=status\"` } // ScaleSpec describes the attributes of a scale subresource type ScaleSpec struct { // desired num","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4 ä»£ç ä¸­ä½¿ç”¨ CR åœ¨ Golang ä¸­æœ‰ç€ä»¥ä¸‹æ–¹å¼å¯ä»¥è®¿é—® CRï¼š ä½¿ç”¨ client-go çš„ dynamic clientï¼ˆæ— å¼ºç±»å‹ï¼‰ã€‚ kubernetes/controller-runtime æä¾›çš„ clientï¼Œåœ¨ Operator SDK ä¸ Kubebuilder ä¸­ä½¿ç”¨ã€‚ client-gen ç”Ÿæˆçš„ clientï¼Œä¸ client-go åŒ…ä¸­ä½¿ç”¨çš„ä¸€æ ·ã€‚ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.1 dynamic client â€œk8s.io/client-go/dynamicâ€ ä¸­æä¾›äº† client å¯ä»¥å¯¹ GVK å®Œå…¨æ— æ„ŸçŸ¥ã€‚å®ƒåªä¼šä½¿ç”¨ unstructured.Unstructured ç»“æ„ã€‚ dynamic client ä¸ä½¿ç”¨ Scheme ä¸ RESTMapperï¼Œéœ€è¦æ‰‹åŠ¨è¿›è¡Œ GVR çš„æ³¨å†Œã€‚ gvr := schema.GroupVersionResource{ Group: \"apps\", Version: \"v1\", Resource: \"deployments\", } client, err := NewForConfig(cfg) client.Resource(gvr). Namespace(namespace).Get(\"foo\", metav1.GetOptions{}) å…¶è¾“å…¥ä¸è¾“å‡ºéƒ½æ˜¯ *unstructured.Unstructured å¯¹è±¡ï¼Œæ•°æ®ç»“æ„ä¸ json.Unmarshal ååºåˆ—åŒ–åè¾“å‡ºä¸€æ ·ï¼š å¯¹è±¡é€šè¿‡ map[string]interface{} è¡¨ç¤ºã€‚ æ•°ç»„é€šè¿‡ []interface{} è¡¨ç¤ºã€‚ åŸºç¡€æ•°æ®ç±»å‹ä¸ºï¼šstringã€boolã€float64ã€int64ã€‚ UnstructuredContent() æä¾›äº†è®¿é—® unstructed å¯¹è±¡å†…éƒ¨æ•°æ®çš„åŠŸèƒ½ï¼š name, found, err := unstructured.NestedString(u.Object, \"metadata\", \"name\") å¯ä»¥çœ‹åˆ°ï¼Œdynamic client æä¾›äº†ä¸€ç§æŠ½è±¡è®¿é—®èµ„æºçš„æ–¹æ³•ï¼Œå› æ­¤ä¸»è¦åœ¨é€šç”¨ç±»å‹çš„æ§åˆ¶å™¨ä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚åƒåœ¾å›æ”¶æ§åˆ¶å™¨ï¼Œå¯ä»¥åˆ é™¤ä»»ä½•èµ„æºè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥éœ€è¦ dynamic clientã€‚ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.2 å¼ºç±»å‹ client å¼ºç±»å‹ client ä¸ºæ¯ç§ GVK éƒ½é‡‡ç”¨äº†å…·ä½“çš„ Golang ç±»ã€‚å®ƒä»¬ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼Œä¹Ÿèƒ½æ›´åŠ å®‰å…¨ã€‚ä¸è¿‡å› ä¸ºå…¶ç±»éƒ½éœ€è¦åœ¨ç¼–è¯‘æœŸéƒ½ç¡®å®šï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å·¥å…·å»ç”Ÿæˆå¯¹åº”çš„ç±»ã€‚ 4.2.1 ç±»å‹é£æ ¼ å¯¹åº”èµ„æºçš„ç»“æ„ä½“é€šå¸¸ä¸ Kind ç›¸åŒåå­—å‘½åï¼Œå¹¶ä¸”æ”¾åœ¨æ‰€å± GVK çš„ Group + Version å¯¹åº”åŒ…ä¸­ã€‚ä¾‹å¦‚ï¼Œgroup/verion.Kind ä¼šæ”¾åœ¨åŒ… â€œpkg/apis/group/versionâ€ ã€‚ é€šå¸¸ï¼Œå¯¹åº”çš„ç»“æ„ä½“ä¼šæ”¾åœ¨ â€œtypes.goâ€ æ–‡ä»¶ã€‚å¦‚ä¹‹å‰æåˆ°çš„ï¼ŒCR çš„å®šä¹‰ä¹Ÿè¦åŒ…å« TypeMeta ä¸ ObjectMeta ç»“æ„ä½“ï¼Œé€šå¸¸ä¹Ÿä¼šåŒ…å« Spec ä¸ Status å­—æ®µã€‚ ä¾‹å¦‚ Deployment å¯¹è±¡æ”¾åœ¨ â€œk8s.io/kubernetes/apps/v1/types.goâ€ æ–‡ä»¶é‡Œï¼š type Deployment struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\"` Spec DeploymentSpec `json:\"spec,omitempty\"` Status DeploymentStatus `json:\"status,omitempty\"` } 4.2.2 åŒ…ç»“æ„ é™¤äº† types.go æ–‡ä»¶ï¼Œè¿˜éœ€è¦äº†è§£ä¸€äº›å…¶ä»–æ–‡ä»¶ã€‚ â€œdoc.goâ€ æ–‡ä»¶æè¿° API çš„åŠŸèƒ½ï¼Œå¹¶åŒ…å«äº†ä¸€ç³»åˆ—å…¨å±€çš„ä»£ç ç”Ÿæˆæ ‡ç­¾ï¼š // Package v1alpha1 contains the cnat v1alpha1 API group // // +k8s:deepcopy-gen=package // +groupName=cnat.programming-kubernetes.info package v1alpha1 â€œregister.goâ€ æ–‡ä»¶åŒ…å«ä¸€äº›ç”¨äºæŠŠ CRD æ³¨å†Œåˆ° Scheme ä¸­çš„è¾…åŠ©å‡½æ•°ï¼š package version import ( metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/apimachinery/pkg/runtime\" \"k8s.io/apimachinery/pkg/runtime/schema\" group \"repo/pkg/apis/group\" ) // SchemeGroupVersion is group version used to register these objects var SchemeGroupVersion = schema.GroupVersion{ Group: group.GroupName, Version: \"version\", } // Kind takes an unqualified kind and returns back a Group qualified GroupKind func Kind(kind string) schema.GroupKind { return SchemeGroupVersion.WithKind(kind).GroupKind() } // Resource takes an unqualified resource and returns a Group // qualified GroupResource func Resource(resource string) schema.GroupResource { return SchemeGroupVersion.WithResource(resource).GroupResource() } var ( SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes) AddToScheme = SchemeBuilder.AddToScheme ) // Adds the list of known types to Scheme. func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes(SchemeGroupVersion, \u0026SomeKind{}, \u0026SomeKindList{}, ) metav1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil } â€œzz_generated.deepcopy.goâ€ ä¸ºè‡ªå®šä¹‰èµ„æºå¯¹åº”çš„ç±»å®šä¹‰äº† DeepCopy() æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¶æ‰€æœ‰çš„å­ç»“æ„ä½“ï¼ˆä¾‹å¦‚ spec ä¸ statusï¼‰ã€‚ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4.3 controller-runtime client controller-runtime æä¾›çš„ client ç”¨äºå¤„ç†ä»»ä½•åœ¨ Scheme ä¸­æ³¨å†Œçš„ Kindï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¹Ÿæ˜¯åŠ¨æ€çš„ã€‚ å®ƒä½¿ç”¨ APIServer æä¾›çš„å‘ç°ä¿¡æ¯ï¼Œå°†ä¸åŒçš„ Kind æ˜ å°„åˆ°ä¸åŒçš„ HTTP API Path ä¸Šã€‚ import ( \"flag\" corev1 \"k8s.io/api/core/v1\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/client-go/kubernetes/scheme\" \"k8s.io/client-go/tools/clientcmd\" runtimeclient \"sigs.k8s.io/controller-runtime/pkg/client\" ) // è¯»å– config kubeconfig = flag.String(\"kubeconfig\", \"~/.kube/config\", \"kubeconfig file path\") flag.Parse() config, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig) // åˆ›å»º client cl, _ := runtimeclient.New(config, client.Options{ Scheme: scheme.Scheme, }) // æŸ¥æ‰¾ Pods podList := \u0026corev1.PodList{} err := cl.List(context.TODO(), client.InNamespace(\"default\"), podList) å¯ä»¥çœ‹åˆ°ï¼ŒList() æ–¹æ³•å¯ä»¥ä½œç”¨äºä»»æ„æŒ‡å®š Scheme ä¸­æ³¨å†Œè¿‡çš„ï¼Œå°†ç»“æœè§£æåˆ°ä¼ é€’çš„ç±»å‹ä¸­ã€‚ å¯¹äº CRï¼Œé€šè¿‡è‡ªå®šä¹‰çš„ Scheme åˆ›å»º client å³å¯ï¼š import ( \"flag\" corev1 \"k8s.io/api/core/v1\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/client-go/kubernetes/scheme\" \"k8s.io/client-go/tools/clientcmd\" runtimeclient \"sigs.k8s.io/controller-runtime/pkg/client\" cnatv1alpha1 \"github.com/.../cnat/cnat-kubebuilder/pkg/apis/cnat/v1alpha1\" ) kubeconfig = flag.String(\"kubeconfig\", \"~/.kube/config\", \"kubeconfig file\") flag.Parse() config, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig) // æ³¨å†Œ CR Scheme crScheme := runtime.NewScheme() cnatv1alpha1.AddToScheme(crScheme) // åˆ›å»º client cl, _ := runtimeclient.New(config, client.Options{ Scheme: crScheme, }) // æ“ä½œ CR list := \u0026cnatv1alpha1.AtList{} err := cl.List(context.TODO(), client.InNamespace(\"default\"), list) ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ ã€ŠProgramming Kubernetesã€‹ ","date":"2021-08-17","objectID":"/posts/cloud_computing/k8s_programming/3-custom-resource/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 3 - Custom Resource","uri":"/posts/cloud_computing/k8s_programming/3-custom-resource/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 æ ¸å¿ƒä»£ç åº“ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.1 k8s.io/client-go ç¼–å†™ Operator ä»£ç æ—¶ï¼Œæœ€æ ¸å¿ƒçš„åº“å°±æ˜¯ k8s.io/client-goï¼Œå…¶æä¾›äº†è®¿é—® Kubernetes æœ€åŸºæœ¬çš„ client å®ç°ã€‚ client-go ä¸ Kubernetes åŒæ—¶å‘å¸ƒï¼Œå¯¹åº” Kubernetes 1.x.y ç‰ˆæœ¬å°±ä¼šæœ‰ç€å¯¹åº”çš„ client-go ç‰ˆæœ¬ã€‚ä¸è¿‡ client-go è¿˜ä¼šå‘å¸ƒç‹¬ç«‹çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ client-go 9.0.0ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.2 k8s.io/api k8s.io/api åº“åŒ…å«äº†æ‰€æœ‰ Kubernetes åŸºæœ¬å¯¹è±¡çš„ç»“æ„ä½“ï¼Œå…¶æŒ‰ç…§ GroupVersion è¿›è¡Œç»„ç»‡ã€‚ ä¾‹å¦‚ Pod ä¸€ç±»çš„æœ€åŸºæœ¬çš„å¯¹è±¡ï¼ŒåŒ…å«åœ¨ core Group ä¸­ï¼Œå› æ­¤æ”¾åœ¨ k8s.io/api/core/v1 åŒ…ä¸­çš„ types.go æ–‡ä»¶ä¸­ã€‚å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯ç±»ä¼¼ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.3 k8s.io/apimachinery k8s.io/apimachinery æä¾›äº† Kubernetes API æ‰€éœ€è¦çš„ä¸€äº›é€šç”¨ä»£ç ã€‚ apimachinery ä¹ŸåŒ…å«äº†å¾ˆå¤šé€šç”¨çš„ API ç±»å‹ï¼Œä¾‹å¦‚ ObjectMetaã€TypeMetaã€GetOptionsã€‚ Tip å› ä¸º API Machinery çš„è®¾è®¡ä¼˜ç§€ï¼Œä½ å¯ä»¥åœ¨ä»»ä½• API ç›¸å…³çš„ä¸šåŠ¡ä»£ç ä¸Šå°è¯•ä½¿ç”¨è¯¥åº“ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 ä½¿ç”¨ client-go ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.1 åˆ›å»ºå¹¶ä½¿ç”¨ ä¸‹é¢æ˜¯æœ€åŸºæœ¬åœ¨ä¸€ä¸ª Go é¡¹ç›®ä¸­ä½¿ç”¨ client-go çš„æ–¹å¼ï¼ˆçœç•¥äº†å¼‚å¸¸å¤„ç†ï¼‰ï¼š import ( metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/client-go/tools/clientcmd\" \"k8s.io/client-go/kubernetes\" ) // è¯»å– config kubeconfig = flag.String(\"kubeconfig\", \"~/.kube/config\", \"kubeconfig file\") flag.Parse() config, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig) // åˆ›å»º client set clientset, err := kubernetes.NewForConfig(config) // é€šè¿‡ client set è®¿é—®èµ„æº pod, err := clientset.CoreV1().Pods(\"book\").Get(\"example\", metav1.GetOptions{}) åœ¨é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰çš„èµ„æºï¼ˆåŒ…æ‹¬ CRï¼‰éƒ½æ˜¯é€šè¿‡ ClientSet ç±»çš„å¯¹è±¡æ¥è®¿é—®ã€‚ClientSet åŒ…å«äº†å¤šä¸ª Group å¤šä¸ª Version çš„ Clientã€‚ åœ¨é›†ç¾¤å†…éƒ¨ Pod ä¸­ï¼Œæ¯ä¸ªå®¹å™¨ä¼šæŒ‚è½½ä¸€ä¸ª ServiceAccountï¼Œè·¯å¾„ä¸ºç›®å½• /var/run/secrets/kubernetes.io/serviceaccountã€‚é€šè¿‡è¯¥ç›®å½•ä¸‹æä¾›çš„è¯ä¹¦ä¸ Tokenï¼Œå¯ä»¥æ›¿ä»£ kubeconfig æ–‡ä»¶æ¥åˆ›å»º ClientSetï¼Œç”¨äºè®¿é—® Kubernetesã€‚ // è¯»å– ServiceAccount çš„ç›®å½•åˆ›å»º config config, err := rest.InClusterConfig() if err != nil { // å›æ»šä½¿ç”¨ kubeconfig æ–‡ä»¶åˆ›å»º config kubeconfig := filepath.Join(\"~\", \".kube\", \"config\") if envvar := os.Getenv(\"KUBECONFIG\"); len(envvar) \u003e0 { kubeconfig = envvar } config, err = clientcmd.BuildConfigFromFlags(\"\", kubeconfig) if err != nil { fmt.Printf(\"The kubeconfig cannot be loaded: %v\\n\", err os.Exit(1) } } // åˆ›å»º client set clientset, err := kubernetes.NewForConfig(config) é»˜è®¤ä¸‹æ‰€æœ‰ Client ä»¥ JSON æ ¼å¼ä¸ APIServer è¿›è¡Œé€šä¿¡ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ Protobuf æ ¼å¼ï¼š cfg, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig) cfg.AcceptContentTypes = \"application/vnd.kubernetes.protobuf,application/json\" // å…è®¸å›å¤çš„æ ¼å¼ cfg.ContentType = \"application/vnd.kubernetes.protobuf\" // å‘é€è¯·æ±‚çš„æ ¼å¼ clientset, err := kubernetes.NewForConfig(cfg) ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.2 ç‰ˆæœ¬ä¸å…¼å®¹æ€§ å¯ä»¥çœ‹åˆ°ï¼ŒClientSet ä½¿ç”¨çš„èµ„æºç±»å‹éƒ½æ˜¯é™æ€é€šè¿‡ api åº“å¯¼å…¥çš„ï¼Œä¸ APIServer ä½¿ç”¨çš„èµ„æºç±»å‹æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ client-go åº“ä¸ Kubernetes APIServer å¯¹åº”çš„ç‰ˆæœ¬ä¸åŒï¼Œé‚£ä¹ˆå°±å¯èƒ½åŒæ–¹ä½¿ç”¨çš„èµ„æºå®šä¹‰ä¸åŒã€‚ ä¸ºæ­¤ï¼Œclient-go ä»“åº“çš„ README ä¸­ï¼Œä¼šå‘å¸ƒä¸€ä¸ªå…¼å®¹æ€§çŸ©é˜µã€‚ âˆš è¡¨ç¤º client-go ä¸ Kubernetes é›†ç¾¤æœ‰ç€å®Œå…¨ç›¸åŒçš„ API ç»„ç‰ˆæœ¬ã€‚ + è¡¨ç¤º client-go åŒ…å«ä¸€äº›åŠŸèƒ½æˆ–è€… API å¯¹è±¡ï¼ŒKubernetes é›†ç¾¤è¿˜ä¸æ”¯æŒã€‚ä¸è¿‡å…¬å…±çš„éƒ¨åˆ†è¿˜æ˜¯èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚ - è¡¨ç¤º Kubernetes çš„ä¸€äº›ç‰¹æ€§ client-go ä¸èƒ½ä½¿ç”¨ã€‚ä¸è¿‡å¤§éƒ¨åˆ†å…¬å…±çš„éƒ¨åˆ†èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚ å› æ­¤ï¼Œå½“ä½ ä½¿ç”¨çš„ client-go åº“ä¸ Kubernetes ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶ï¼Œéœ€è¦æ¸…æ¥šæŸäº›ç‰¹æ€§æ˜¯å¦èƒ½å¤Ÿå…¼å®¹ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.3 API å…¼å®¹æ€§ä¿è¯ åœ¨ Kubernetes é£æ ¼ä¸­ï¼ŒAPI å¯èƒ½åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬ï¼š Alpha - v1alpha1ã€v1aplpha2 ç­‰ç§°ä¸º Alpha ç‰ˆæœ¬ï¼Œè¡¨ç¤ºä¸ç¨³å®šçš„ç‰ˆæœ¬ã€‚ è¿™äº›ç‰ˆæœ¬å¯èƒ½éšæ—¶ä¼šæ¶ˆå¤±æˆ–è€…è¿›è¡Œä¸å…¼å®¹çš„æ”¹å˜ã€‚é»˜è®¤æ˜¯è¢«ç¦ç”¨çš„ï¼Œéœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨å¯ç”¨å®ƒä»¬ã€‚ Beta - v1beta1ã€v1beta2ã€v2beta1 ç­‰ç§°ä¸º Beta ç‰ˆæœ¬ï¼Œè¡¨ç¤ºç›¸å¯¹ç¨³å®šçš„ç‰ˆæœ¬ã€‚ é€šå¸¸ä¸ä¼šå‘ç”Ÿä¸å…¼å®¹çš„æ”¹åŠ¨ï¼Œä½†æ˜¯ä¸æ˜¯ä¸¥æ ¼ä¿è¯ã€‚Beta ç‰ˆæœ¬åŠŸèƒ½é»˜è®¤ä¼šè¢«å¯ç”¨ã€‚ GA - v1ã€v2 ç­‰ä¸å¸¦åç¼€çš„éƒ½æ˜¯ç¨³å®šç‰ˆæœ¬ã€‚ ä¼šä¸€ç›´å­˜åœ¨ï¼Œå¹¶ä¸”ä¸€ç›´ä¿æŒå…¼å®¹æ€§ã€‚ åœ¨è¿›è¡Œé¡¹ç›®å¼€å‘æ—¶ï¼Œè¦è®°ä½ä¸¤ç‚¹ï¼š ä»£ç ä¸­ä¸€ä¸ªèµ„æºå®šä¹‰çš„æŸäº›å­—æ®µä¹Ÿå¯èƒ½å‡†è®¸ä¸Šè¿°ç‰ˆæœ¬å®šä¹‰ï¼ˆæ³¨é‡Šä¸­è¯´æ˜ï¼‰ã€‚ è®¿é—® APIServer æ—¶ï¼ŒAPIServer ä¼šåœ¨ç›¸åŒçš„èµ„æºä¸åŒç‰ˆæœ¬é—´è‡ªåŠ¨è¿›è¡Œè½¬æ¢ã€‚ ä¾‹å¦‚ï¼ŒæŸä¸ªèµ„æºæ˜¯ç”± v1beta1 ç‰ˆæœ¬çš„ API åˆ›å»ºçš„ï¼Œä½†æ˜¯ä½ å¯ä»¥é€šè¿‡ v1 ç‰ˆæœ¬çš„ API æ¥è®¿é—®è¯¥èµ„æºã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3 Kubernetes å¯¹è±¡ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.1 Object Go è¯­è¨€ä¸­çš„ Kubernetes å¯¹è±¡éƒ½å®ç°äº† runtime.Object interfaceï¼Œè¯¥æ¥å£ä½äº k8s.io/apimachinery/pkg/runtime åŒ…ï¼š // Object interface must be supported by all API types registered with Scheme. Since objects in a scheme are // expected to be serialized to the wire, the interface an Object must provide to the Scheme allows // serializers to set the kind, version, and group the object is represented as. An Object may choose // to return a no-op ObjectKindAccessor in cases where it is not expected to be serialized. type Object interface { GetObjectKind() schema.ObjectKind DeepCopyObject() Object } GetObjectKind() - å¾—åˆ° ObjectKindï¼Œç”¨ä»¥è¿”å›æˆ–è®¾ç½® GVK DeepCopyObject() - æ·±æ‹·è´å¾—åˆ°ä¸€ä¸ª Object schema.ObjectKind å°±æ˜¯ä»£è¡¨ä¸€ä¸ªå…·æœ‰ Kind çš„ Objectï¼š // All objects that are serialized from a Scheme encode their type information. This interface is used // by serialization to set type information from the Scheme onto the serialized version of an object. // For objects that cannot be serialized or have unique requirements, this interface may be a no-op. type ObjectKind interface { // SetGroupVersionKind sets or clears the intended serialized kind of an object. Passing kind nil // should clear the current setting. SetGroupVersionKind(kind GroupVersionKind) // GroupVersionKind returns the stored group, version, and kind of an object, or an empty struct // if the object does not expose or provide these fields. GroupVersionKind() GroupVersionKind } SetGroupVersionKind() - è®¾ç½® Object çš„ GVK GroupVersionKind() - å¾—åˆ° Object çš„ GVK æ€»ç»“ä¸€ä¸‹ï¼ŒObject å¯¹è±¡å¯ä»¥å¾—åˆ°å¯¹åº”çš„ Kindï¼Œä»¥åŠå…è®¸è¿›è¡Œæ·±æ‹·è´ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.2 TypeMeta Object ä»…ä»…æ˜¯ä¸€ä¸ª interfaceï¼Œæ‰€æœ‰å®é™…çš„ Kubernetes å¯¹è±¡éƒ½æ˜¯é€šè¿‡å†…åµŒ metav1.TypeMeta ç»“æ„æ¥åŒ…å« GroupVersionKind æ–¹æ³•çš„ã€‚ // TypeMeta describes an individual object in an API response or request // with strings representing the type of the object and its API schema version. // Structures that are versioned or persisted should inline TypeMeta. // // +k8s:deepcopy-gen=false type TypeMeta struct { // Kind is a string value representing the REST resource this object represents. // Servers may infer this from the endpoint the client submits requests to. // Cannot be updated. // In CamelCase. // More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds // +optional Kind string `json:\"kind,omitempty\" protobuf:\"bytes,1,opt,name=kind\"` // APIVersion defines the versioned schema of this representation of an object. // Servers should convert recognized schemas to the latest internal value, and // may reject unrecognized values. // More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources // +optional APIVersion string `json:\"apiVersion,omitempty\" protobuf:\"bytes,2,opt,name=apiVersion\"` } func (obj *TypeMeta) GetObjectKind() schema.ObjectKind { return obj } Kind - å¯¹è±¡çš„ç±»å‹ï¼› APIVersion - å¯¹è±¡çš„ API ç‰ˆæœ¬ï¼› è¿™ä¹Ÿå°±æ˜¯ä½ åœ¨èµ„æºå®šä¹‰ YAML æ—¶çœ‹åˆ°çš„ apiVersion ä¸ kind å­—æ®µäº†ï¼š apiVersion:v1kind:Pod# ... Core Group Version Pod ä»¥åŠä¸€äº›å…¶ä»–ç±»å‹æ˜¯ Kubernetes å¾ˆæ—©å°±æœ‰çš„ Core Groupï¼Œå®ƒä»¬çš„ Group ä¸ºç©ºï¼Œå› æ­¤ apiVersion å°±æ˜¯ v1ã€‚ åæ¥ï¼ŒKubernetes å¼•å…¥äº† API Group çš„æ¦‚å¿µï¼ŒapiVersion é€šè¿‡ \u003cGroup\u003e/\u003cversion\u003e è¡¨ç¤ºï¼Œä¾‹å¦‚ apps/v1ã€‚ è€Œ Core Group å› ä¸ºå†å²åŸå› å…¶ Group ä¸ºç©ºï¼Œæ‰€ä»¥ apiVersion çš„å€¼çœ‹ä¸Šå»å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚ ä¸è¦ç›´æ¥ä½¿ç”¨ Kind ä¸ Version å­—æ®µ åœ¨å‰é¢ä½¿ç”¨ç¤ºä¾‹è·å– Pod åï¼Œä½ ä¼šå‘ç°è¿”å›çš„ Pod å¯¹è±¡å¹¶æ²¡æœ‰è®¾ç½® Kind ä¸ Version å­—æ®µã€‚è¿™æ˜¯ Kubernetes åœ¨è§£ç æ—¶æ•…æ„æŠ¹å»çš„ã€‚ // Decode does not do conversion. It removes the gvk during deserialization. func (d WithoutVersionDecoder) Decode(data []byte, defaults *schema.GroupVersionKind, into Object) (Object, *schema.GroupVersionKind, error) { obj, gvk, err := d.Decoder.Decode(data, defaults, into) if obj != nil { kind := obj.GetObjectKind() // clearing the gvk is just a convention of a codec kind.SetGroupVersionKind(schema.GroupVersionKind{}) } return obj, gvk, err } ä¸æ¸…æ¥šä¸ºå•¥ï¼Œç›®å‰å¯ä»¥é€šè¿‡è¿™ä¸ª issue è·Ÿè¿›è¿™ä¸ªé—®é¢˜ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.3 ObjectMeta é™¤äº† TypeMetaï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª metav1.ObjectMeta ç±»å‹çš„å­—æ®µï¼š // ObjectMeta is metadata that all persisted resources must have, which includes all objects // users must create. type ObjectMeta struct {Clayton Coleman, 5 years ago: â€¢ iQEcBAABCAAGBQJYfoneAAoJED0WkGtPHFyzBGEH/ROjâ€¦ Name string `json:\"name,omitempty\" protobuf:\"bytes,1,opt,name=name\"` GenerateName string `json:\"generateName,omitempty\" protobuf:\"bytes,2,opt,name=generateName\"` Namespace string `json:\"namespace,omitempty\" protobuf:\"bytes,3,opt,name=namespace\"` // DEPRECATED SelfLink string `json:\"selfLink,omitempty\" protobuf:\"bytes,4,opt,name=selfLink\"` UID types.UID `json:\"uid,omitempty\" protobuf:\"bytes,5,opt,name=uid,casttype=k8s.io/kubernetes/pkg/types.UID\"` ResourceVersion string `json:\"resourceVersion,omitempty\" protobuf:\"bytes,6,opt,name=resourceVersion\"` Generation int64 `json:\"generation,omitempty\" protobuf:\"varint,7,opt,name=generation\"` CreationTimestamp Time `json:\"creationTimestamp,omitempty\" protobuf:\"bytes,8,opt,name=creationTimestamp\"` DeletionTimestamp *Time `json:\"deletionTimestamp,omitempty\" protobuf:\"bytes,9,opt,name=deletionTimestamp\"` DeletionGracePeriodSeconds *int64 `json:\"deletionGracePeriodSeconds,omitempty\" protobuf:\"varint,10,opt,name=deletionGracePeriodSeconds\"` Labels map[string]string `json:\"labels,omitempty\" protobuf:\"bytes,11,rep,name=labels\"` Annotations map[string]string `json:\"annotations,omitempty\" protobuf:\"bytes,12,rep,name=annotations\"` OwnerReferences []OwnerReference `json:\"ownerReferences,omitempty\" patchStrategy:\"merge\" patchMergeKey:\"uid\" protobuf:\"bytes,13,rep,name=ownerReferences\"` Finalizers []string `json:\"finalizers,omitempty\" patchStrategy:\"merge\" protobuf:\"bytes,14,rep,name=finalizers\"` ClusterName string `json:\"clusterName,omitempty\" protobuf:\"bytes,15,opt,name=clusterName\"` ManagedFields []ManagedFieldsEntry `json:\"managedFields,omitempty\" protobuf:\"bytes,17,rep,name=managedFields\"` } Name - Object çš„å‘½åã€‚ GenerateName - ç”ŸæˆåŸºäº GenerateName çš„éšæœºåå­—ï¼Œå¡«å……åˆ° Nameã€‚ Namespace - å¯¹è±¡æ‰€å±çš„ namespaceï¼Œå¯¹äº namespace ä¸‹çš„å¯¹è±¡ï¼Œç©ºä»£è¡¨ç€ â€œdefaultâ€ã€‚ UID - å¯¹è±¡çš„çš„å”¯ä¸€ IDã€‚ ç³»ç»Ÿå¡«å……ï¼Œåªè¯»ä¸å…è®¸æ›´æ”¹ã€‚ ResourceVersion - å¯¹è±¡çš„ç‰ˆæœ¬å·ï¼Œå¯ç”¨äº client åˆ¤æ–­èµ„æºæ˜¯å¦å‘ç”Ÿå˜æ›´ã€‚ å¯ä»¥ç”¨äºä¹è§‚å¹¶å‘ï¼Œå˜æ›´æ£€æµ‹ï¼Œwatch æ“ä½œæ—¶ä½¿ç”¨ï¼Œclient å¿…é¡»å°†å…¶åŸå°ä¸åŠ¨ä¼ é€’ç»™ APIServerã€‚ ç³»ç»Ÿå¡«å……ï¼Œåªè¯»ä¸å…è®¸æ›´æ”¹ã€‚ Generation - èµ„æºæœŸæœ›çŠ¶æ€çš„åºåˆ—å·ã€‚ ç³»ç»Ÿå¡«å……ï¼Œåªè¯»ä¸å…è®¸æ›´æ”¹ã€‚ CreationTimestamp - Server åˆ›å»ºå¯¹è±¡çš„æ—¶é—´ã€‚ ç³»ç»Ÿå¡«å……ï¼Œåªè¯»ä¸å…è®¸æ›´æ”¹ã€‚ DeletionTimestamp - å¯¹è±¡å°†è¢«åˆ é™¤çš„æ—¶é—´ã€‚ å½“ç”¨æˆ·ä¼˜é›…åˆ é™¤ä¸€ä¸ªèµ„æºæ—¶ï¼Œç”±ç³»ç»Ÿè®¾ç½®ã€‚èµ„æºå°†é¢„è®¡åœ¨è¯¥æ—¶é—´åè¢«åˆ é™¤ã€‚ å¦‚æœå­˜åœ¨ç€ finalizerï¼Œåˆ é™¤ä¼šé˜»å¡ç­‰å¾… finalizer å»é™¤ã€‚ ä¸€æ—¦è°ƒç”¨åˆ é™¤ä¹‹åï¼Œæ— æ³•å–æ¶ˆåˆ é™¤ã€‚ DeletionGracePeriodSeconds - ä¼˜é›…åœæ­¢æ—¶é—´ã€‚å½“ DeletionTimestamp è®¾ç½®æ—¶æ‰ä¼šè®¾ç½®ã€‚ Labels - å¯¹è±¡çš„ labelã€‚ Annotations - å¯¹è±¡çš„ annotationã€‚ OwnerReferences - æ­¤å¯¹è±¡ä¾èµ–çš„å¯¹è±¡çš„åˆ—è¡¨ã€‚ å¦‚æœåˆ—è¡¨ä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½è¢«åˆ é™¤ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šè¢«åƒåœ¾å›æ”¶ã€‚ å¦‚æœè¯¥å¯¹è±¡è¦ç”± Controller æ¥ç®¡ç†ï¼Œå°†åˆ—è¡¨ä¸­å…¶ä¸­ä¸€ä¸ªå¯¹è±¡æŒ‡å‘ Controllerï¼Œå¹¶è®¾ç½® controler å­—æ®µã€‚ Finalizers - åœ¨å¯¹è±¡è¢«é›†ç¾¤åˆ é™¤å‰ï¼ŒFinalizers å¿…é¡»ä¸ºç©ºã€‚ ä¸€æ—¦ DeletionTimestamp è¢«è®¾ç½®åï¼Œè¡¨æ˜ç»„ä»¶å¯ä»¥å¼€å§‹è¿›è¡Œæ¸…ç†æ“ä½œï¼Œæ¸…ç†å®Œæˆååˆ é™¤å¯¹åº”çš„ Finalizerã€‚ ClusterName - å¯¹è±¡æ‰€å±çš„é›†ç¾¤åå­—ï¼Œç”¨äºåŒºåˆ†ä¸åŒé›†ç¾¤å†…åŒååŒ namespace çš„èµ„æºã€‚ ç›®å‰è¯¥èµ„æºæ²¡æœ‰è¢« APIServer ä½¿ç”¨åˆ°ã€‚ ManagedFields - ?? ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"3.4 Spec ä¸ Status å‡ ä¹æ‰€æœ‰é¡¶çº§å¯¹è±¡éƒ½åŒ…å« spec ä¸ status å­—æ®µï¼Œè¿™ä½“ç°äº† Kubernetes çš„å£°æ˜å¼ API è®¾è®¡ã€‚ spec æ˜¯ç”¨æˆ·æœŸæœ›çš„å¯¹è±¡çš„çŠ¶æ€ï¼Œstatus æ˜¯å¯¹è±¡çš„å½“å‰çŠ¶æ€ã€‚ spec é€šå¸¸ç”±ç”¨æˆ·éƒ¨ç½²æ—¶é…ç½®ï¼Œstatus ä¸»è¦ç”±ç³»ç»Ÿä¸­çš„ Controller è¿›è¡Œå¡«å……ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:3:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"4 ClientSet åœ¨å‰é¢çš„ä¾‹å­ï¼Œé€šè¿‡ kubernetes.NewForConfig(config) ä¼šè¿”å›ä¸€ä¸ª ClientSetã€‚ClientSet åŒ…å«å¯ä»¥è®¿é—®å¤šä¸ª APIGroup çš„èµ„æºã€‚ å¯¹äº client-go è¿”å›çš„ ClientSetï¼Œå‡ ä¹å¯ä»¥è®¿é—® Kubernetes APIServer çš„æ‰€æœ‰èµ„æºï¼ˆé™¤äº† APIService ä¸ CRDï¼‰ã€‚å…¶ä¸»è¦çš„æ¥å£å¦‚ä¸‹ï¼š type Interface interface { Discovery() discovery.DiscoveryInterface AdmissionregistrationV1() admissionregistrationv1.AdmissionregistrationV1Interface AdmissionregistrationV1beta1() admissionregistrationv1beta1.AdmissionregistrationV1beta1Interface InternalV1alpha1() internalv1alpha1.InternalV1alpha1Interface AppsV1() appsv1.AppsV1Interface AppsV1beta1() appsv1beta1.AppsV1beta1Interface AppsV1beta2() appsv1beta2.AppsV1beta2Interface AuthenticationV1() authenticationv1.AuthenticationV1Interface AuthenticationV1beta1() authenticationv1beta1.AuthenticationV1beta1Interface AuthorizationV1() authorizationv1.AuthorizationV1Interface AuthorizationV1beta1() authorizationv1beta1.AuthorizationV1beta1Interface AutoscalingV1() autoscalingv1.AutoscalingV1Interface AutoscalingV2beta1() autoscalingv2beta1.AutoscalingV2beta1Interface AutoscalingV2beta2() autoscalingv2beta2.AutoscalingV2beta2Interface BatchV1() batchv1.BatchV1Interface BatchV1beta1() batchv1beta1.BatchV1beta1Interface CertificatesV1() certificatesv1.CertificatesV1Interface CertificatesV1beta1() certificatesv1beta1.CertificatesV1beta1Interface CoordinationV1beta1() coordinationv1beta1.CoordinationV1beta1Interface CoordinationV1() coordinationv1.CoordinationV1Interface CoreV1() corev1.CoreV1Interface DiscoveryV1() discoveryv1.DiscoveryV1Interface DiscoveryV1beta1() discoveryv1beta1.DiscoveryV1beta1Interface EventsV1() eventsv1.EventsV1Interface EventsV1beta1() eventsv1beta1.EventsV1beta1Interface ExtensionsV1beta1() extensionsv1beta1.ExtensionsV1beta1Interface FlowcontrolV1alpha1() flowcontrolv1alpha1.FlowcontrolV1alpha1Interface FlowcontrolV1beta1() flowcontrolv1beta1.FlowcontrolV1beta1Interface NetworkingV1() networkingv1.NetworkingV1Interface NetworkingV1beta1() networkingv1beta1.NetworkingV1beta1Interface NodeV1() nodev1.NodeV1Interface NodeV1alpha1() nodev1alpha1.NodeV1alpha1Interface NodeV1beta1() nodev1beta1.NodeV1beta1Interface PolicyV1() policyv1.PolicyV1Interface PolicyV1beta1() policyv1beta1.PolicyV1beta1Interface RbacV1() rbacv1.RbacV1Interface RbacV1beta1() rbacv1beta1.RbacV1beta1Interface RbacV1alpha1() rbacv1alpha1.RbacV1alpha1Interface SchedulingV1alpha1() schedulingv1alpha1.SchedulingV1alpha1Interface SchedulingV1beta1() schedulingv1beta1.SchedulingV1beta1Interface SchedulingV1() schedulingv1.SchedulingV1Interface StorageV1beta1() storagev1beta1.StorageV1beta1Interface StorageV1() storagev1.StorageV1Interface StorageV1alpha1() storagev1alpha1.StorageV1alpha1Interface } å¯ä»¥çœ‹åˆ°ï¼ŒåŒ…å«äº†æ‰€æœ‰ Kubernetes åŸç”Ÿçš„ GroupVersion æ¥å£ï¼Œç”¨äºæ“ä½œæ‰€æœ‰ GroupVersion ä¸‹çš„èµ„æºã€‚ åœ¨æ¯ä¸ª GroupVersion æ–¹æ³•å†…éƒ¨ï¼ˆä¾‹å¦‚ AppsV1beta1ï¼‰ï¼Œå°±æ˜¯è¯¥ APIGroup ä¸‹çš„æ‰€æœ‰èµ„æºäº†ï¼š type AppsV1beta1Interface interface { RESTClient() rest.Interface ControllerRevisionsGetter DeploymentsGetter StatefulSetsGetter } RESTClient æ˜¯ä¸€ä¸ªé€šç”¨çš„ REST Clientï¼š // Interface captures the set of operations for generically interacting with Kubernetes REST apis. type Interface interface { GetRateLimiter() flowcontrol.RateLimiter Verb(verb string) *Request Post() *Request Put() *Request Patch(pt types.PatchType) *Request Get() *Request Delete() *Request APIVersion() schema.GroupVersion } è€Œå…¶ä»–èµ„æºæ¥å£å°±æ˜¯å¯ä»¥æ“ä½œå¯¹åº”çš„èµ„æºäº†ï¼š // DeploymentsGetter has a method to return a DeploymentInterface. // A group's client should implement this interface. type DeploymentsGetter interface { Deployments(namespace string) DeploymentInterface } // DeploymentInterface has methods to work with Deployment resources. type DeploymentInterface interface { Create(ctx context.Context, deployment *v1beta1.Deployment, opts v1.CreateOptions) (*v1beta1.Deployment, error) Update(ctx context.Context, deployment *v1beta1.Deployment, opts v1.UpdateOptions) (*v1beta1.Deployment, error) UpdateStatus(ctx context.Context, deployment *v1beta1.Deployment, opts v1.UpdateOptions) (*v1beta1.Deployment, error) Delete(ctx context.Context, name","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"5 Informer Controller å¦‚æœæ¯æ¬¡éœ€è¦æŸ¥è¯¢å°±å»è®¿é—® APIServerï¼Œä¼šé€ æˆæ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚Informer æä¾›äº†å¯¹è±¡çš„ å†…å­˜ç¼“å­˜ï¼Œè€Œé€šè¿‡ Watch æœºåˆ¶æ¥ç›‘å¬å¯¹è±¡çš„å³æ—¶å˜åŒ–ã€‚ Informer å†…éƒ¨å®ç°äº†å®Œå–„çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼šå½“ä¸ APIServer Watch çš„é•¿è¿æ¥å‘ç”Ÿæ–­å¼€æ—¶ï¼Œå®ƒä¼šé€šè¿‡ä¸€ä¸ªæ–°çš„ Watch è¯·æ±‚å°è¯•æ¢å¤ï¼Œä»äº‹ä»¶ä¸­æ‰¾åˆ°æ­£ç¡®çš„äº‹ä»¶ç»§ç»­å¤„ç†ã€‚ä¹Ÿå°±æ˜¯ä¸ä¼šä¸¢å¤±äº‹ä»¶ã€‚å¦‚æœè¿æ¥æ–­å¼€æ—¶é—´å¾ˆé•¿ï¼ŒInformer ä¼šè·å–å®Œæ•´çš„å¯¹è±¡åˆ—è¡¨é‡æ–°æ„å»ºç¼“å­˜ã€‚ Informer è¿˜æä¾›äº† resync çš„æœºåˆ¶ï¼šæ²¡ç»è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œå®ƒå°±ä¼šè°ƒç”¨æ³¨å†Œè¿‡çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼ˆUpdate å›è°ƒï¼‰ï¼Œæä¾›å®Œæˆçš„å¯¹è±¡åˆ—è¡¨ã€‚ Note resync ä¹Ÿæ˜¯åŸºäº Informer å†…å­˜ç¼“å­˜æä¾›çš„å¯¹è±¡åˆ—è¡¨ï¼Œä¸ä¼šå‘ APIServer å‘èµ·è¯·æ±‚ã€‚ ä¸ºäº†å‡å°‘ç¨‹åºä¸­ä½¿ç”¨å¤šä¸ª Informer å¸¦æ¥çš„å¼€é”€ï¼Œå¯ä»¥é€šè¿‡ SharedInformerFactory æ¥æ–¹ä¾¿åœ°å¯¹ Informer è¿›è¡Œå¤ç”¨ã€‚SharedInformerFactory å…è®¸åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­å¤ç”¨ Informerï¼Œè¿™æ ·åº•å±‚åªæœ‰ä¸€ä¸ªä¸ APIServer æ„å»ºçš„ Watch è¿æ¥ã€‚ é€šè¿‡ ClientSet å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ›å»ºä¸€ä¸ª SharedInformerFactoryï¼š import ( // ... \"k8s.io/client-go/informers\" ) clientset, err := kubernetes.NewForConfig(config) // åˆ›å»º SharedInformerFactoryï¼š informerFactory := informers.NewSharedInformerFactory(clientset, time.Second*30) // æ³¨å†Œäº‹ä»¶å›è°ƒ podInformer := informerFactory.Core().V1().Pods() podInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: func(new interface{}) {...}, UpdateFunc: func(old, new interface{}) {...}, DeleteFunc: func(obj interface{}) {...}, }) // å¯åŠ¨ informerFactory.Start(wait.NeverStop) // Cache åŒæ­¥ informerFactory.WaitForCacheSync(wait.NeverStop) // ä½¿ç”¨ï¼ˆçº¯å†…å­˜çš„æŸ¥è¯¢ï¼‰ pod, err := podInformer.Lister().Pods(\"programming-kubernetes\").Get(\"client-go\") AddEventHandler - æ·»åŠ äº‹ä»¶å›è°ƒï¼Œè¿™ä¹Ÿæ˜¯ Controller çš„åŸºç¡€ã€‚ Start - å¯åŠ¨ InformerFactoryï¼Œå†…éƒ¨ä¼šå¯åŠ¨ä¸€äº› groutine å»è®¿é—® APIServerã€‚ WaitForCacheSync - è®©ä»£ç åœä¸‹æ¥ï¼Œç­‰å¾… InformerFactory ç¬¬ä¸€æ¬¡åŒæ­¥æ‰€æœ‰çš„ç¼“å­˜ã€‚ ä¾‹å­ä¸­è®¾ç½®äº† 30s çš„ resync å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯æ¯éš” 30s Informer é’ˆå¯¹æ‰€æœ‰çš„å¯¹è±¡ä¼šï¼Œè§¦å‘ä¸€æ¬¡ UpdateFunc å‡½æ•°å›è°ƒã€‚å› æ­¤ï¼ŒUpdateFunc å¯èƒ½éœ€è¦é€šè¿‡ ObjectMeta.resourceVersion å­—æ®µæ¥åˆ¤æ–­æ˜¯å¦æ˜¯çœŸæ­£çš„æ›´æ–°äº‹ä»¶ã€‚ ReadOnly ç¨‹åºåªèƒ½ä» Informer ä¸­è¯»å–ã€æŸ¥è¯¢å¯¹è±¡ï¼Œä¸èƒ½é€šè¿‡ Informer ä¿®æ”¹å¯¹è±¡ï¼ˆéœ€é€šè¿‡ ClientSetï¼‰ï¼Œè€Œä¸”ä¹Ÿä¸èƒ½ä¿®æ”¹ Informer è¿”å›çš„å¯¹è±¡ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡æ˜¯ç”± Informer ç®¡ç†çš„ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"6 WorkQueue client-go åº“ä¸­åœ¨ â€œk8s.io/client-go/util/workqueueâ€ ä¸­æä¾›äº†ä¸€ç§å¼ºå¤§çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œå¯ä»¥å®ç°è®©æ§åˆ¶å˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚ æ‰€æœ‰çš„ WorkQueue éƒ½å®ç°äº†ä¸‹é¢çš„ interfaceï¼š type Interface interface { Add(item interface{}) Len() int Get() (item interface{}, shutdown bool) Done(item interface{}) ShutDown() ShuttingDown() bool } Add(item) - ç”¨äºæ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œåå¤æ·»åŠ åŒä¸€ä¸ªæœªå‡ºé˜Ÿçš„ item åªä¼šå¯¹è¯¥å…ƒç´ æ‰“ä¸Šæ ‡è®°ã€‚ Len() - è¿”å›é˜Ÿåˆ—çš„å½“å‰é•¿åº¦ã€‚ Get() - è¿”å›ä¸€ä¸ªæœ€é«˜ä¼˜å…ˆçº§çš„å…ƒç´ ï¼ŒGet() å¹¶ä¸ä»£è¡¨å…ƒç´ ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚ Done(item) - è¡¨æ˜å…ƒç´ å¤„ç†å®Œæˆï¼Œä»é˜Ÿåˆ—ä¸­ç§»å‡ºã€‚ DelayingInterface æ˜¯åŸºäºåŸºç¡€ interface çš„æ‰©å±•ï¼Œç”¨äºå»¶è¿Ÿæ·»åŠ å…ƒç´ ã€‚è¿™é€‚ç”¨äºå¾ˆæ–¹ä¾¿åœ°æŠŠå¤„ç†å¤±è´¥çš„å…ƒç´ å»¶æ—¶é‡æ–°åŠ å…¥é˜Ÿåˆ—ã€‚ // DelayingInterface is an Interface that can Add an item at a later time. This makes it easier to // requeue items after failures without ending up in a hot-loop. type DelayingInterface interface { Interface // AddAfter adds an item to the workqueue after the indicated duration has passed AddAfter(item interface{}, duration time.Duration) } AddAfter() - åœ¨æŒ‡å®šæ—¶é—´åå°†å…ƒç´ é‡æ–°åŠ å…¥é˜Ÿåˆ—ã€‚ RateLimitingInterface æ˜¯æ›´åŠ å¸¸ç”¨çš„ interface çš„æ‰©å±•ï¼Œå¯¹å…ƒç´ åŠ å…¥é˜Ÿåˆ—è¿›è¡Œé¢‘ç‡é™æµï¼š // RateLimitingInterface is an interface that rate limits items being added to the queue. type RateLimitingInterface interface { DelayingInterface // AddRateLimited adds an item to the workqueue after the rate limiter says it's ok AddRateLimited(item interface{}) // Forget indicates that an item is finished being retried. Doesn't matter whether it's for perm failing // or for success, we'll stop the rate limiter from tracking it. This only clears the `rateLimiter`, you // still have to call `Done` on the queue. Forget(item interface{}) // NumRequeues returns back how many times the item was requeued NumRequeues(item interface{}) int } AddRateLimited() - æ·»åŠ å…ƒç´ åˆ°é˜Ÿåˆ—ï¼Œæ”¶åˆ°é¢‘ç‡é™åˆ¶ã€‚ Forget() - è¡¨æ˜ä¸€ä¸ªå…ƒç´ å¤„ç†ç»“æŸï¼Œé‡ç½®è¯¥å…ƒç´ çš„é™é¢‘å€¼ï¼ˆä»…ä»…é’ˆå¯¹é¢‘ç‡é™åˆ¶ï¼Œè¿˜æ˜¯ä¾æ—§è¦è°ƒç”¨ Done()ï¼‰ã€‚ NumRequeues() - è¿”å›ä¸€ä¸ªå…ƒç´ å…¥é˜Ÿçš„æ¬¡æ•°ã€‚ client-go æä¾›äº†å¤šç§æ–¹å¼çš„é™é¢‘ç®—æ³•ï¼ŒåŒ…æ‹¬ï¼š BucketRateLimiter ItemExponentialFailureRateLimiter ItemFastSlowRateLimiter MaxOfRateLimiter ä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½åªéœ€è¦ä½¿ç”¨ func DefaultControllerRateLimiter() *RateLimiter æŒ‡æ•°çº§çš„é€€é¿ç­–ç•¥ï¼Œä» 5ms è€ƒè¯•ï¼Œæœ€å¤§ 1000sï¼Œæ¯æ¬¡é€€é¿æ—¶é—´ç¿»å€ã€‚ å…è®¸æ¯ç§’å‘é˜Ÿåˆ—ä¸­æ·»åŠ  10 ä¸ªå…ƒç´ ï¼Œå…è®¸çªå‘æ·»åŠ  100 ä¸ªå…ƒç´ ã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7 åŸºæœ¬ç±»å‹ç³»ç»Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ç€ä¸‹å›¾ï¼Œæœ‰ç€åœ¨å¯¹ä»£ç ä¸­ç±»å‹ç³»ç»Ÿçš„è½¬åŒ–è·¯å¾„çš„æ•´ä½“æ¦‚å¿µï¼š ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ Scheme å¾—åˆ°å¯¹åº”çš„ GroupVersionKind ä» GroupVersionKindï¼Œé€šè¿‡ RESTMapper å¯ä»¥æ˜ å°„åˆ°å¯¹åº”çš„ GroupVersionResource client åŸºäº GroupVersionResource å°±å¯ä»¥è¯·æ±‚å¯¹åº”çš„ HTTP API Path ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.1 GroupVersionKind åœ¨ API åŸºæœ¬æ¦‚å¿µ - Kind ä¸­è¯´è¿‡ï¼ŒKind è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ã€‚å› ä¸ºå¯¹è±¡éƒ½æ˜¯åŸºäº GroupVersion æ¥è¯´çš„ï¼Œæ‰€ä»¥åœ¨ä»£ç ä¸­ï¼ŒKind çš„ä»£è¡¨å°±æ˜¯æ ¸å¿ƒæ¦‚å¿µï¼šGroupVersionKindï¼Œç®€å†™ä¸º GVKã€‚ çœ‹ä¸‹å…·ä½“çš„ç»“æ„ï¼š // GroupVersionKind unambiguously identifies a kind. It doesn't anonymously include GroupVersion // to avoid automatic coercion. It doesn't use a GroupVersion to avoid custom marshalling type GroupVersionKind struct { Group string Version string Kind string } ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:7:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.2 GroupVersionResource åœ¨ API åŸºæœ¬æ¦‚å¿µ - Resource ä¸­è¯´æ˜äº† Resource çš„æ¦‚å¿µï¼ŒResource ä¹Ÿæ˜¯åŸºäº GroupVersion æ¥è¯´çš„ï¼Œæ‰€ä»¥ä»£ç ä¸­ä¹Ÿæœ‰ç€å¯¹åº”çš„ GroupVersionResource çš„æ¦‚å¿µï¼Œç®€å†™ä¸º GVRã€‚ // GroupVersionResource unambiguously identifies a resource. It doesn't anonymously include GroupVersion // to avoid automatic coercion. It doesn't use a GroupVersion to avoid custom marshalling type GroupVersionResource struct { Group string Version string Resource string } // GroupKind specifies a Group and a Kind, but does not force a version. This is useful for identifying // concepts during lookup stages without having partially valid types type GroupKind struct { Group string Kind string } æ¯ä¸ª GVR éƒ½å¯¹åº”äº†ä¸€ä¸ª HTTP API Pathã€‚ä¾‹å¦‚ apps/v1.deployments è¿™ä¸ª GVR å¯¹åº”äº HTTP APi /apis/apps/v1/$namespace/deploymentsã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:7:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.3 REST Map å¤§å¤šæ•° Kind ä¸ Resource å­˜åœ¨ç€ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œç”¨äºè®°å½• GVK ä¸ GVR ä¹‹é—´çš„æ˜ å°„å…³ç³»è¢«ç§°ä¸º REST Mapã€‚ ä»£ç ä¸­ RestMapper ä¸ºè®°å½• RESTMap çš„æŠ½è±¡ interfaceï¼Œå…¶æä¾›å¤šä¸ªç”¨äº GVK ä¸ GVR ä¹‹é—´è½¬æ¢çš„æ–¹æ³•ï¼š // RESTMapper allows clients to map resources to kind, and map kind and version // to interfaces for manipulating those objects. It is primarily intended for // consumers of Kubernetes compatible REST APIs as defined in docs/devel/api-conventions.md. // // The Kubernetes API provides versioned resources and object kinds which are scoped // to API groups. In other words, kinds and resources should not be assumed to be // unique across groups. // // TODO: split into sub-interfaces type RESTMapper interface { // KindFor takes a partial resource and returns the single match. Returns an error if there are multiple matches KindFor(resource schema.GroupVersionResource) (schema.GroupVersionKind, error) // KindsFor takes a partial resource and returns the list of potential kinds in priority order KindsFor(resource schema.GroupVersionResource) ([]schema.GroupVersionKind, error) // ResourceFor takes a partial resource and returns the single match. Returns an error if there are multiple matches ResourceFor(input schema.GroupVersionResource) (schema.GroupVersionResource, error) // ResourcesFor takes a partial resource and returns the list of potential resource in priority order ResourcesFor(input schema.GroupVersionResource) ([]schema.GroupVersionResource, error) // RESTMapping identifies a preferred resource mapping for the provided group kind. RESTMapping(gk schema.GroupKind, versions ...string) (*RESTMapping, error) // RESTMappings returns all resource mappings for the provided group kind if no // version search is provided. Otherwise identifies a preferred resource mapping for // the provided version(s). RESTMappings(gk schema.GroupKind, versions ...string) ([]*RESTMapping, error) ResourceSingularizer(resource string) (singular string, err error) } KindFor() - éƒ¨åˆ† GVR è½¬æ¢ä¸ºå•ä¸ª GVK KindsFor() - éƒ¨åˆ† GVR è½¬æ¢ä¸ºæ‰€æœ‰ GVK ResourceFor() - éƒ¨åˆ† GVR è½¬æ¢ä¸ºå•ä¸ª GVR ResourcesFor() - éƒ¨åˆ† GVR è½¬æ¢ä¸ºæ‰€æœ‰ GVR RESTMapping() - ä»ä¸€ä¸ª Kind å¾—åˆ°å¯¹åº”æœ€ä¼˜å…ˆçš„ RestMapping RESTMappings() - ä»ä¸€ä¸ª Kind å¾—åˆ°æ‰€æœ‰å¯¹åº”çš„ RestMapping éƒ¨åˆ† GVR éƒ¨åˆ† GVR æŒ‡çš„æ˜¯ä»…ä»…è®¾ç½®äº†éƒ¨åˆ†å­—æ®µçš„ GVRã€‚ä¾‹å¦‚ kubectl get pods æ—¶ï¼Œæ²¡æœ‰æŒ‡å®š Group ä¸ Versionï¼Œä½†æ˜¯èƒ½å¤Ÿæ˜ å°„åˆ° v1 Pod è¿™æ ·çš„ Kindã€‚ RESTMapping å°±ä»£è¡¨äº†ä¸€ä¸ª GVK ä¸ GVR çš„ä¸€å¯¹ä¸€æ˜ å°„ï¼š // RESTMapping contains the information needed to deal with objects of a specific // resource and kind in a RESTful manner. type RESTMapping struct { // Resource is the GroupVersionResource (location) for this endpoint Resource schema.GroupVersionResource // GroupVersionKind is the GroupVersionKind (data format) to submit to this endpoint GroupVersionKind schema.GroupVersionKind // Scope contains the information needed to deal with REST Resources that are in a resource hierarchy Scope RESTScope } RESTMapper interface æœ‰ç€è®¸å¤šçš„ implementï¼Œä¸è¿‡åœ¨ç¼–å†™ Operator æ—¶ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨åŸºäºå‘ç°æœºåˆ¶çš„ DeferredDiscoveryRESTMapper å®ç°ã€‚å®ƒé€šè¿‡è°ƒç”¨ APIServer çš„æ¥å£åŠ¨æ€è§£æ REST Mappingã€‚ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:7:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"7.4 Scheme Scheme åº”è¯¥æ˜¯ç¼–å†™ä»£ç æ—¶æœ€é‡è¦çš„ç»“æ„äº†ã€‚å…¶åŒ…å«äº†å¤šä¸ª Golang ç±»å‹ä¸ GVK çš„æ˜ å°„ï¼Œå¹¶ä¸”ç‰¹å®šçš„ Kindï¼Œå¯ä»¥æ³¨å†Œä¸åŒç‰ˆæœ¬çš„è½¬æ¢å‡½æ•°ï¼Œä»¥åŠè®¾ç½®é»˜è®¤å€¼çš„å‡½æ•°ã€‚ æ€»ç»“ä¸€ä¸‹å…¶ä¸»è¦ä½œç”¨ï¼š GVK ä¸ Golang ç±»å‹çš„è½¬æ¢ï¼› æ³¨å†Œ Convert å‡½æ•°ï¼Œç”¨äº Kind ä¸åŒç‰ˆæœ¬å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ï¼› æ³¨å†Œ Default å‡½æ•°ï¼Œç”¨äºè®¾ç½®å¯¹è±¡çš„é»˜è®¤å€¼ï¼› Note å½“æˆ‘ä»¬éœ€è¦å®ç° Custom APIServer æ—¶ï¼Œå°±ä¼šè¦äº†è§£åˆ° Convert ä¸ Defaultã€‚ 7.4.1 ç±»å‹è½¬æ¢ Scheme æä¾› GVK ä¸ç‰¹å®šç±»å‹è½¬æ¢åŠŸèƒ½ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ Scheme.AddKnownTypes æ¥å£æ¥æ³¨å†Œ Golang ç±»å‹ä¸ GroupVersionã€‚é€šå¸¸ï¼Œä»£ç ç”Ÿæˆå™¨ä¼šåœ¨ register.go æ–‡ä»¶ä¸­ç”Ÿæˆè¯¥ä»£ç ã€‚ // SchemeGroupVersion is group version used to register these objects var SchemeGroupVersion = schema.GroupVersion{Group: groupName, Version: \"v1alpha1\"} func init() { // We only register manually written functions here. The registration of the // generated functions takes place in the generated files. The separation // makes the code compile even when the generated files are missing. localSchemeBuilder.Register(addKnownTypes) } func addKnownTypes(scheme *runtime.Scheme) error { Scheme = scheme // Scheme æ˜¯å…¨å±€çš„ Scheme å¯¹è±¡ scheme.AddKnownTypes(SchemeGroupVersion, \u0026TidbCluster{}, // è‡ªå®šä¹‰çš„ç±»å‹ ) metav1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil } é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªå…¨å±€çš„ Scheme å¯¹è±¡ï¼Œç„¶åé€šè¿‡å‘å…¶ä¸­æ³¨å†Œ Golang ç±»å‹ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ Scheme.New æ–¹æ³•ä»ä¸€ä¸ª GVK å¾—åˆ°ä¸€ä¸ª Golang å¯¹è±¡ï¼Œç„¶åé€šè¿‡ç±»å‹æ–­è¨€è½¬æ¢ä¸ºç‰¹å®šçš„ç±»å‹ã€‚ robj, err := t.scheme.New(gvk) // å¾—åˆ° GVK å¯¹åº”çš„ç©ºçš„å¯¹è±¡ cobj, ok := robj.(*TidbCluster) // ç±»å‹æ–­è¨€å¾—åˆ°å…·ä½“çš„å¯¹è±¡ æ€»ç»“ä¸€ä¸‹ï¼ŒScheme æä¾›çš„ç›¸å…³æ¥å£ï¼š // AddKnownTypeWithName æ³¨å†Œ GVK ä¸ç±»å‹ï¼ˆobj çš„ç±»å‹ï¼‰ func (s *Scheme) AddKnownTypeWithName(gvk schema.GroupVersionKind, obj Object) // AddKnownTypes æ³¨å†Œ GV ä¸å…¶ä¸‹çš„å¤šä¸ªç±»å‹ï¼ŒKind å°±æ˜¯ç±»å‹çš„åå­— func (s *Scheme) AddKnownTypes(gv schema.GroupVersion, types ...Object) // KnownTypes ä» GV ä¸­å–å‡ºåŒ…å«çš„ç±»å‹ func (s *Scheme) KnownTypes(gv schema.GroupVersion) map[string]reflect.Type // New æ ¹æ® GVK åˆ›å»ºä¸€ä¸ªå¯¹åº”ç±»å‹çš„å¯¹è±¡ func (s *Scheme) New(kind schema.GroupVersionKind) (Object, error) // ObjectKinds è¿”å›å¯¹è±¡å¯¹åº”çš„å¯èƒ½çš„ GVKï¼Œå¦‚æœæ˜¯ unversioned object è¿”å› trueï¼Œå¦‚æœç±»å‹æœªæ³¨å†Œè¿”å›é”™è¯¯ func (s *Scheme) ObjectKinds(obj Object) ([]schema.GroupVersionKind, bool, error) // PreferredVersionAllGroups è¿”å›æ¯ä¸ª Group çš„ä¼˜å…ˆçº§æœ€é«˜ Version func (s *Scheme) PreferredVersionAllGroups() []schema.GroupVersion // PrioritizedVersionsForGroup æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºè¿”å›æ‰€æœ‰çš„ GroupVersion func (s *Scheme) PrioritizedVersionsForGroup(group string) []schema.GroupVersion // PrioritizedVersionsForGroup æŒ‰ç…§ä¼˜å…ˆçº§è¿”å›ä¸€ä¸ª group æ‰€æœ‰çš„ version func (s *Scheme) PrioritizedVersionsForGroup(group string) []schema.GroupVersion // Recognizes GVK æ˜¯å¦æ˜¯æ³¨å†Œè¿‡çš„ func (s *Scheme) Recognizes(gvk schema.GroupVersionKind) bool // SetVersionPriority è®¾ç½®ä¸€ä¸ª Group ä¸‹çš„ Version çš„ä¼˜å…ˆçº§ // NOTE: versions å¿…é¡»æ˜¯åŒä¸€ä¸ª Group ä¸‹çš„ä¸åŒ Version func (s *Scheme) SetVersionPriority(versions ...schema.GroupVersion) error å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ ·å°±å®ç°äº† Kind ä¸å¯¹è±¡ç±»å‹çš„äº’è½¬ã€‚è¿™ä¹Ÿå°±æ˜¯ Client ä¸ APIServer é€šä¿¡æ—¶ï¼Œè¿›è¡Œæ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ ¸å¿ƒã€‚ 7.4.2 ä¸åŒç‰ˆæœ¬ç±»å‹é—´è½¬æ¢ å‰é¢å¯ä»¥çœ‹åˆ°ï¼ŒScheme å­˜å‚¨ç€è®¸å¤š Groupï¼Œå…¶ Group ä¸‹å¯ä»¥æœ‰ç€ä¸åŒ Version çš„ç±»å‹ã€‚åœ¨ APIServer ä¸­ï¼Œä¸ºäº†èƒ½å¤Ÿå¤„ç†å¤šä¸ª Version å…±å­˜çš„æƒ…å†µï¼Œåˆæœ‰ç€ä¸€ä¸ª Internal Versionã€‚ä½œä¸ºä¸åŒ Version é—´è½¬æ¢ä¸­è½¬ã€‚ è€Œ Scheme ä¹Ÿæ˜¯ä¿å­˜ç€å„ä¸ªç‰ˆæœ¬ä¹‹é—´è½¬æ¢çš„åœ°æ–¹ï¼ˆå› ä¸ºå…¶çŸ¥é“æ‰€æœ‰ç‰ˆæœ¬çš„ç±»å‹ï¼‰ï¼Œé€šè¿‡ä»¥ä¸‹å‡½æ•°æä¾›åŠŸèƒ½ï¼š // AddConversionFunc æ³¨å†Œä¸€ä¸ªè½¬æ¢è·¯å¾„ï¼Œå¯¹åº” a ç±»å‹åˆ° b ç±»å‹çš„è½¬æ¢ï¼Œä½¿ç”¨ fn è¿›è¡Œè½¬æ¢ func (s *Scheme) AddConversionFunc(a, b interface{}, fn conversion.ConversionFunc) error func (s *Scheme) AddFieldLabelConversionFunc(gvk schema.GroupVersionKind, conversionFunc FieldLabelConversionFunc) error func (s *Scheme) AddGeneratedConversionFunc(a, b interface{}, fn conversion.ConversionFunc) error func (s *Scheme) AddIgnoredConversionType(from, to interface{}) error // Convert å°† in ç±»å‹å¯¹è±¡è½¬æ¢ä¸º out ç±»å‹å¯¹è±¡ func (s *Scheme) Convert(in, out interface{}, context interface{}) error func (s *Scheme) ConvertFieldLabel(gvk schema.GroupVersionKind, label, value string) (string, string, error) // ConvertToVersion å°† in ç±»å‹å¯¹è±¡è½¬åŒ–ä¸º taget æŒ‡å®šçš„ç‰ˆæœ¬å¯¹è±¡ func (s *Scheme) ConvertToVersion(in Object, target GroupVersioner) (Object, error) æˆ‘ä»¬å°†åœ¨åé¢çš„ Custom APIServer ç¼–å†™ä¸­çœ‹åˆ°ä½•æ—¶ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚ 7.4.3 è®¾ç½®é»˜è®¤å€¼ Scheme åœ¨å¤„ç†æ•°æ®ç±»å‹åºåˆ—åŒ–ï¼Œå’Œå¤„ç†æ•°æ®ç±»å‹è½¬æ¢æ—¶ï¼Œä¼šé€šè¿‡é»˜è®¤å€¼ç›¸å…³å‡½æ•°è®¾ç½®å¯¹è±¡çš„é»˜è®¤å€¼ã€‚é€šè¿‡ä»¥ä¸‹å‡½æ•°ï¼š // AddTypeDefaultingFunc æ³¨å†Œä¸€ä¸ªå¯¹è±¡çš„é»˜è®¤å€¼å¤„ç†å‡½æ•° func (s *Scheme) AddTypeDefaultingFunc(srcType Object, fn func(interface{})) // Default è®¾ç½®ä¸€ä¸ªå¯¹è±¡çš„é»˜è®¤å€¼ï¼Œå°±æ˜¯ä½¿ç”¨æ³¨å†Œçš„é»˜è®¤å€¼å¤„ç†å‡½æ•° func (s *Scheme) Default(src Object) Note æ³¨æ„ï¼Œé»˜è®¤å€¼è®¾ç½®åœ¨ APIServer è½¬æ¢æ—¶æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œè€Œ Scheme ä¸­ä»…ä»…æ˜¯ç”¨äº Default() æ¥å£ï¼Œä¸ä¼šè‡ªåŠ¨è¿›è¡Œã€‚ å› æ­¤ï¼Œåœ¨ç¼–å†™ Custom APIServer æ—¶è¦æ­£ç¡®è®¾ç½®å¥½è®¾ç½®é»˜è®¤å€¼çš„å‡½æ•°ã€‚ æˆ‘ä»¬å°†åœ¨åé¢çš„ Custom APIServe","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:7:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ ã€ŠProgramming Kubernetesã€‹ ","date":"2021-08-10","objectID":"/posts/cloud_computing/k8s_programming/2-client-go/:8:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 2 - ç¼–ç¨‹åŸºç¡€","uri":"/posts/cloud_computing/k8s_programming/2-client-go/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"K8s ç¼–ç¨‹éœ€è¦çŸ¥æ™“çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":" Kubernetes ç¼–ç¨‹ç³»åˆ— ä¸»è¦è®°å½•ä¸€äº›å¼€å‘ Controller æ‰€ç›¸å…³çš„çŸ¥è¯†ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºã€ŠProgramming Kubernetesã€‹ï¼ˆæ¨èç›´æ¥é˜…è¯»ï¼‰ã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1 Controller æ¨¡å¼ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.1 Control Loop æ‰€æœ‰ Controller çš„åŸºæœ¬é€»è¾‘éƒ½æ˜¯æ‰§è¡Œ æ§åˆ¶å¾ªç¯Control Loopï¼Œå…¶åŸºæœ¬é€»è¾‘ä¸ºï¼š è¯»å–èµ„æºçš„çŠ¶æ€ã€‚ é‡‡ç”¨ Watch æ–¹å¼ç›‘å¬èµ„æºï¼Œèµ„æºå˜æ›´æ—¶ä¼šè§¦å‘ã€‚ æ”¹å˜é›†ç¾¤ä¸­çš„å¯¹è±¡çš„çŠ¶æ€ï¼Œæˆ–è€…é›†ç¾¤å¤–éƒ¨å¯¹è±¡çš„çŠ¶æ€ã€‚ ä¾‹å¦‚ï¼Œå¯åŠ¨ä¸€ä¸ª Podã€åˆ›å»ºäº‘ä¸Šèµ„æºç­‰ã€‚ é€šè¿‡ APIServer æ›´æ–°èµ„æºçš„çŠ¶æ€ã€‚ å¾ªç¯æ‰§è¡Œè¿™äº›é€»è¾‘ã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.2 äº‹ä»¶é©±åŠ¨æ¨¡å¼ å¤§å¤šæ•°åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æ˜¯ RPC æ¥è§¦å‘ä¸€ä¸ªåŠ¨ä½œï¼Œè€Œ Kubernetes ä¸­éƒ½ä¼šé€šè¿‡ APIServer çš„ Watch åŠŸèƒ½æ¥ç›‘å¬å¯¹è±¡çš„å˜åŒ–ã€‚ ä»¥é€šè¿‡ä¸€ä¸ª Deployment æ¥å¯åŠ¨ Pod ä¸ºä¾‹ï¼š Deployment Controller Watch äº† Deployment çš„äº‹ä»¶ï¼Œå› æ­¤è§¦å‘åå‘ç°ç”¨æˆ·åˆ›å»ºäº†ä¸€ä¸ª Deploymentï¼Œæ‰§è¡Œç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼šåˆ›å»ºä¸€ä¸ª ReplicaSet å¯¹è±¡ã€‚ ReplicaSet Controller Watch äº† ReplicaSet çš„äº‹ä»¶ï¼Œå› æ­¤è§¦å‘åå‘ç°æ–°åˆ›å»ºäº†ä¸€ä¸ª ReplicaSetï¼Œæ‰§è¡Œç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼šåˆ›å»ºä¸€ä¸ª Pod å¯¹è±¡ã€‚ Scheduler æœ¬èº«ä¹Ÿæ˜¯ Controllerï¼Œé€šè¿‡ Watch æœºåˆ¶å‘ç°æœ‰ä¸€ä¸ªæ–°åˆ›å»ºçš„ Podï¼Œå¹¶ä¸” Pod çš„ spec.nodeName æ˜¯ç©ºå€¼ï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚ Scheduler å°† Pod è°ƒåº¦åˆ°ä¸€ä¸ªåˆé€‚çš„ Nodeï¼Œå°† Node æ›´æ–°åˆ° Pod çš„ spec.nodeName å­—æ®µï¼Œç„¶åæŠŠå®ƒå†™å…¥ APIServerã€‚ kubectl Watch äº† Pod äº‹ä»¶ï¼Œå› æ­¤è§¦å‘åå‘ç° Pod çš„ spec.nodeName ä¸è‡ªå·±æ‰€åœ¨ Node ç›¸åŒï¼Œé‚£ä¹ˆå°±ä¼šæ„å»ºç¯å¢ƒå¹¶å¯åŠ¨ Podã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Controller éƒ½æ˜¯è¿è¡Œç€ç‹¬ç«‹çš„ Control Loopï¼Œå¯¹è±¡çŠ¶æ€çš„å˜åŒ–é€šè¿‡ä¼šä»¥äº‹ä»¶çš„æ–¹å¼é€šçŸ¥åˆ° Controllerã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.3 ä¹è§‚å¹¶å‘ åœ¨ç³»ç»Ÿä¸­ï¼ŒController å¯èƒ½å­˜åœ¨ç€å¤šä¸ªå‰¯æœ¬ï¼Œå› æ­¤å¹¶å‘çš„æ›´æ–°èµ„æºæ“ä½œå¯èƒ½ä¼šäº§ç”Ÿå†™å…¥å†²çªã€‚ å¯¹æ­¤ï¼ŒKubernetes APIServer ä½¿ç”¨ ä¹è§‚å¹¶å‘Optimistic Concurrency æ–¹å¼æ¥è§£å†³å†²çªã€‚ ç®€å•åœ°è¯´ï¼Œå¦‚æœ APIServer å‘ç°äº†ä¸¤ä¸ªå¹¶å‘çš„å†™è¯·æ±‚ï¼Œå®ƒå°±ä¼šæ‹’ç»åé¢çš„è¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œè€Œå‘é€è¯·æ±‚çš„ Client è¦å¤„ç†è¿™ç§å¤±è´¥ã€‚ var err error for retries := 0; retries \u003c 10; retries++ { foo, err = client.Get(\"foo\", metav1.GetOptions{}) if err != nil { break } // æ›´æ–°æ“ä½œ ... _, err = client.Update(foo) if err != nil \u0026\u0026 errors.IsConflict(err) { // å¤„ç†å†²çª ... continue } else if err != nil { break } } é—®é¢˜æ˜¯å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªå†™æ“ä½œæ˜¯å†²çªçš„ï¼Ÿç­”æ¡ˆæ˜¯æ¯ä¸ª Kubernetes èµ„æºå¯¹è±¡éƒ½ä¼šåŒ…å«çš„ metadata.resourceVersion å­—æ®µã€‚ kind:Podmetadata:name:fooresourceVersion:57spec:#...status:#... ä¾‹å¦‚ï¼Œä½ æƒ³è¦æ›´æ–°è¯¥ Pod å¯¹è±¡ï¼Œå…¶ metadata.resourceVersion: 57ï¼ŒAPIServer æŒ‰æ­¤å°è¯•å°†æ•°æ®å†™å…¥ etcdï¼Œè€Œ etcd ä¸­å­˜å‚¨çš„è¯¥ Pod ä¸º metadata.resourceVersion: 58ã€‚ etcd å‘ç°è¯¥èµ„æºç‰ˆæœ¬ä¸è‡ªå·±ä¿å­˜çš„ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±ä¼šæ‹’ç»å†™å…¥ã€‚ å†™å…¥å†²çªå®Œå…¨æ˜¯å¾ˆæ­£å¸¸çš„äº‹æƒ…ï¼Œå› æ­¤ä½ ç¼–å†™çš„ Controller ä»£ç ä¸­å¿…é¡»æ­£ç¡®å¤„ç†å†²çªçš„åœºæ™¯ã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"1.4 Operator Operator æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Controllerï¼Œåªæ˜¯æ¯”ä¸€èˆ¬çš„ Controller å¤æ‚ï¼Œè¦è´Ÿè´£ä¸€äº›äº§å“çš„è¿ç»´æ“ä½œã€‚ ä¸€èˆ¬ Operator åŒ…å«ï¼š ä¸€ç»„ CRDï¼Œç”¨äºå®šä¹‰ç‰¹å®šé¢†åŸŸçš„ Schemaã€‚ ä¸€ä¸ªæˆ–å¤šä¸ª Controllerï¼Œç”¨äºå®Œæˆç‰¹å®šçš„è¿ç»´æ“ä½œã€‚ å¯ä»¥åœ¨ OperatorHub æ¥æŸ¥æ‰¾ç‰¹å®šé¢†åŸŸçš„å‘å¸ƒçš„ Operatorã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:1:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2 API åŸºç¡€ Kubernetes çš„æ ¸å¿ƒæ˜¯ APIServerï¼Œå…¶ä¸»è¦æä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼š ä¸ºæ‰€æœ‰ç»„ä»¶æä¾› APIã€‚ æä¾› Proxy åŠŸèƒ½ã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.1 HTTP API å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼ŒAPIServer æä¾›äº†ä¸€ä¸ª RESTful HTTP APIï¼Œå¯ä»¥è¿”å› JSON/Protobuf æ ¼å¼çš„å†…å®¹ã€‚ ç¼–ç æ–¹å¼ ç”±äºæ€§èƒ½è€ƒè™‘ï¼Œé›†ç¾¤å†…éƒ¨ç»„ä»¶é€šä¿¡ä¸»è¦ä½¿ç”¨ Protobufã€‚è€Œå®¢æˆ·ç«¯è®¿é—®ä¸ºäº†é€šç”¨æ€§ï¼Œé»˜è®¤ä½¿ç”¨ JSON æ ¼å¼ã€‚ åŸºäº RESTï¼Œæ¯ä¸ª HTTP è¯·æ±‚çš„é€šè¿‡ä¸åŒçš„ HTTP Verbï¼ˆä¹Ÿç§° Methodï¼‰æ¥è¡¨ç¤ºä¸åŒç±»å‹çš„æ“ä½œï¼š HTTP GET - æŸ¥è¯¢ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šçš„èµ„æºï¼› HTTP POST - åˆ›å»ºèµ„æºï¼› HTTP PUT - ä¿®æ”¹å·²æœ‰çš„èµ„æºï¼Œæä¾›èµ„æºå®Œæ•´çš„å®šä¹‰ï¼› HTTP PATCH - éƒ¨åˆ†æ›´æ–°å·²æœ‰çš„èµ„æºï¼Œåªæä¾›èµ„æºéƒ¨åˆ†å®šä¹‰å³å¯ï¼› HTTP DELETE - åˆ é™¤ä¸€ä¸ªèµ„æºï¼› ä½ å¯ä»¥é€šè¿‡ API å‚è€ƒæ–‡æ¡£ çœ‹åˆ°æ‰€æœ‰ HTTP APIï¼Œä»¥åŠå¯¹åº”çš„ç¤ºä¾‹ï¼ˆæ³¨æ„ç‰ˆæœ¬ï¼‰ã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"2.2 API åŸºæœ¬æ¦‚å¿µ 2.2.1 Kind Kind è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šåŒ…å« Kind å­—æ®µï¼ˆJSON ä¸­ä¸º kindï¼ŒGolang ä¸­ä¸º Kindï¼‰ã€‚ kind:Pod ç›®å‰å­˜åœ¨ç€ä¸‰ç§é‚£ç±»å‹çš„ kindï¼š ç‰¹å®šçš„å¯¹è±¡ï¼Œä¾‹å¦‚ Podï¼› å¯¹è±¡çš„é›†åˆï¼Œä¾‹å¦‚ PodListsã€NodeListsï¼› ç‰¹å®šè¡Œä¸ºæˆ–è€…éæŒä¹…åŒ–çš„å®ä½“ï¼Œä¾‹å¦‚ /scaleã€Statusï¼› 2.2.2 API Group Group ä¸ºä¸€ç»„ Kind çš„é›†åˆã€‚ä¾‹å¦‚ï¼Œæ‰¹é‡ä»»åŠ¡ç›¸å…³ï¼ˆJob æˆ–è€… ScheduledJobï¼‰éƒ½åŒ…å«åœ¨ â€œbatchâ€ è¿™ä¸ª API Groupã€‚ 2.2.3 Version æ¯ä¸ª API Group å¯ä»¥æœ‰ç€å¤šä¸ª Versionã€‚ ç‰¹å®šç‰ˆæœ¬çš„ï¼ˆæ¯”å¦‚ v1beta1ï¼‰åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥åœ¨å…¶ä»–æ”¯æŒçš„ç‰ˆæœ¬ä¸­è·å–å¹¶ä½¿ç”¨ï¼ŒAPIServer æ”¯æŒå°†å¯¹è±¡åœ¨å¤šä¸ªç‰ˆæœ¬é—´è¿›è¡Œæ— æŸè½¬æ¢ã€‚ Storage Version åç»­å¯ä»¥çœ‹åˆ°ï¼ŒAPIServer ä½¿ç”¨ â€œStorage Versionâ€ ä½œä¸ºå¤šä¸ªç‰ˆæœ¬ä¹‹é—´çš„å†…éƒ¨ç‰ˆæœ¬ã€‚ 2.2.4 Resource åœ¨ HTTP API Endpoint ä¸­ï¼Œä¼šä½¿ç”¨å°å†™å¤æ•°çš„å•è¯ï¼Œä¾‹å¦‚ â€¦/podsã€‚åœ¨ HTTP ä¸­è¯¥ Endpoint å°±è¢«ç§°ä¸º Resourceã€‚ æœ‰äº› Resource æœ‰ç€æ›´å¤šçš„ Endpoint æ¥è¡¨ç¤ºä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ ../pod/nginx/port-forwardã€../pod/nginx/logs ç­‰ã€‚è¿™äº› Endpoint å°±è¢«ç§°ä¸º SubResourceã€‚ CRD ä¸­çš„ SubResource ç°åœ¨ï¼Œå¯ä»¥ç†è§£ä¸ºå•¥ CRD ä¸­æœ‰ä¸ª subresouces å­—æ®µäº†ï¼š # ...spec:group:stable.example.comversions:- name:v1subresources:status:{}scale:specReplicasPath:.spec.replicas Kind ä¸ Resource æ˜¯ä¸ä¸€æ ·çš„æ¦‚å¿µï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºï¼š Resource ä¼šå¯¹åº”ä¸€ä¸ª HTTP API Pathï¼› Kind æ˜¯ç”¨äºä¿å­˜åœ¨å¯¹åº”å®šä¹‰ä¸­çš„ï¼Œä¹Ÿä¼šä¿å­˜åœ¨ etcd ä¸­ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒKind ä¸ Resource æ˜¯ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ã€‚ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Kubernetes ç¼–ç¨‹"],"content":"å‚è€ƒ OperatorHub API å‚è€ƒæ–‡æ¡£ ã€ŠProgramming Kubernetesã€‹ ","date":"2021-08-06","objectID":"/posts/cloud_computing/k8s_programming/1-basic/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s ç¼–ç¨‹ - 1 - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/k8s_programming/1-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"Grafana åŸºç¡€","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1 åŸºæœ¬æ¦‚å¿µ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.1 æ•°æ®æº Data Source Grafana æ”¯æŒå¤šç§ä¸åŒç±»å‹çš„æ—¶åºæ•°æ®åº“ï¼Œç§°ä¸ºæ•°æ®æºData Sourceã€‚ç›®å‰å®˜æ–¹æ”¯æŒï¼šGraphiteã€InfluxDBã€OpenTSDBã€Prometheusã€Elasticsearchã€CloudWatchã€‚ å¯ä»¥å°†å¤šä¸ªæ•°æ®æºçš„æ•°æ®åˆå¹¶åˆ°ä¸€ä¸ªå•ç‹¬çš„ä»ªè¡¨ç›˜ï¼ˆDashboardï¼‰ä¸Šï¼Œä½†æ˜¯æ¯ä¸ªé¢æ¿ï¼ˆPanelï¼‰éƒ½ç»‘å®šåˆ°å±äºç‰¹å®šç»„ç»‡çš„ç‰¹å®šæ•°æ®æºã€‚ æ·»åŠ ä¸€ä¸ªæ•°æ®æºæ—¶ï¼Œåˆ†ä¸ºä¸¤ç§è®¿é—®æ¨¡å¼ï¼š Server æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä»æµè§ˆå™¨å‘é€åˆ° Grafana åç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨å°†è¯·æ±‚è½¬å‘åˆ°æ•°æ®æºã€‚ Browser æ¨¡å¼ï¼šæµè§ˆå™¨è®¿é—®æ¨¡å¼ï¼Œæ‰€æœ‰è¯·æ±‚ç›´æ¥ä»æµè§ˆå™¨å‘é€åˆ°æ•°æ®æºã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.2 ç»„ç»‡ Organization Grafana å¯ä»¥æ”¯æŒåˆ›å»ºå¤šä¸ªç»„ç»‡Organizationï¼Œæ¯ä¸ªç»„ç»‡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®æºã€‚æ‰€æœ‰çš„ä»ªè¡¨ç›˜éƒ½å½’ç‰¹å®šç»„ç»‡æ‹¥æœ‰ã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.3 ç”¨æˆ· User ç”¨æˆ·Useræ˜¯ Grafana çš„è´¦æˆ·ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥éš¶å±äºä¸€ä¸ªæˆ–å¤šä¸ªç»„ç»‡ï¼Œé€šè¿‡è§’è‰²ï¼ˆRoleï¼‰ä¸ºå…¶åˆ†é…ä¸åŒçº§åˆ«çš„æƒé™ã€‚ Grafana ä¹Ÿæ”¯æŒå„ç§ç”¨æˆ·è®¤è¯æ–¹å¼ã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:3","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.4 é¢æ¿ Panel é¢æ¿Panelæ˜¯æœ€åŸºæœ¬çš„å¯è§†åŒ–æ¨¡å—ã€‚æ¯ä¸ªé¢æ¿æ ¹æ®æŸ¥è¯¢ç¼–è¾‘å™¨ï¼ˆä¾‹å¦‚ Prometheus å°±æ˜¯ PromQLï¼‰æŸ¥è¯¢æ•°æ®ï¼Œå¹¶æä¾›å±•ç¤ºå›¾è¡¨ã€‚ ç›®å‰ï¼ŒGrafana æ”¯æŒçš„é¢æ¿è®¸å¤šé¢æ¿ç±»å‹ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ Time seriesï¼Œå±•ç¤ºåŸºäºæ—¶é—´çš„æ ·æœ¬æ•°æ®ã€‚ å¯ä»¥é€šè¿‡å‘ Grafana ç”¨æˆ·åˆ†äº«é“¾æ¥ï¼Œæˆ–è€…ä½¿ç”¨å¿«ç…§åŠŸèƒ½å°†æ­£åœ¨æŸ¥çœ‹çš„æ•°æ®ç¼–ç ä¸ºé™æ€å’Œäº¤äº’å¼ JSON æ–‡ä»¶ï¼Œæ¥å‘å…¶ä»–äººåˆ†äº«é¢æ¿ä»¥åŠæ•°æ®ã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:4","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.5 è¡Œ Row è¡ŒRowç”¨äºåœ¨ä»ªè¡¨ç›˜ç•Œé¢ç»„ç»‡å¤šä¸ªé¢æ¿ï¼Œä¸€èˆ¬ä¸º 12 å•ä½çš„å®½åº¦ã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:5","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.6 æŸ¥è¯¢ç¼–è¾‘å™¨ Query Editor æ¯ä¸ªé¢æ¿éƒ½æœ‰ç€ä¸€ä¸ªæˆ–å¤šä¸ª Query Editorï¼Œé€šè¿‡ç¼–å†™è¯­å¥æ¥è¯»å–æ•°æ®æºçš„æ ·æœ¬ï¼Œå°†å…¶å±•ç¤ºåˆ°é¢æ¿ä¸Šã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:6","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.7 ä»ªè¡¨ç›˜ Dashboard å¤šä¸ªé¢æ¿æˆ–è€…å¤šä¸ªè¡Œæ„æˆä¸€ä¸ªä»ªè¡¨ç›˜Dashboardï¼Œç”¨äºåˆ†ç±»ä¸åŒçš„æŒ‡æ ‡é¡¹ã€‚ é€šè¿‡åˆ†äº«é“¾æ¥æˆ–è€…é€šè¿‡å¿«ç…§åŠŸèƒ½ï¼Œå¯ä»¥å‘ä»–äººåˆ†æä»ªè¡¨ç›˜ä»¥åŠæ•°æ®ã€‚ ä½ ä¹Ÿå¯ä»¥ä»…ä»…é€šè¿‡ Export åŠŸèƒ½ï¼Œå°†ä»ªè¡¨ç›˜ç»“æ„å¯¼å‡ºä¸º JSON æ–‡ä»¶ã€‚ä»–äººå¯ä»¥é€šè¿‡ Import è¯¥ JSON æ–‡ä»¶ç›´æ¥æ„å»ºå¯¹åº”çš„ä»ªè¡¨ç›˜ã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:1:7","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2 å®šåˆ¶å›¾è¡¨ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:2:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.1 å®šåˆ¶ä»ªè¡¨ç›˜ åˆ›å»ºæ–°çš„ä»ªè¡¨ç›˜ ç‚¹å‡» â€œCreateâ€ èœå•æ åˆ›å»ºæ–°çš„ Dashboardã€‚ç‚¹å‡» â€œSettingâ€ æŒ‰é’®è¿›è¡Œé…ç½®ã€‚ é…ç½® General é¡¹ General é¡¹åŒ…å«ä»ªè¡¨ç›˜åç§°å’Œä¸€äº›å¸¸è§„é…ç½®ã€‚ Name - ä»ªè¡¨ç›˜åç§° Description - ä»ªè¡¨ç›˜æè¿° Tages - ä»ªè¡¨ç›˜ label Editable - Editable å¯ä»¥ç¼–è¾‘ä»ªè¡¨ç›˜ï¼ŒRead-only ä¸å…è®¸ç¼–è¾‘ä»ªè¡¨ç›˜ Timezone - é…ç½®æ—¶åŒº Auto-refresh - å®šåˆ¶ç›¸å¯¹æ—¶é—´æ˜¾ç¤ºå’Œè‡ªåŠ¨åˆ·æ–°é€‰é¡¹ï¼Œé»˜è®¤å³å¯ é…ç½® Variables é€‰é¡¹ å¯ä»¥ä¸ºä»ªè¡¨ç›˜é…ç½®å¤šä¸ªæ¨¡æ¿å˜é‡ï¼Œåœ¨é¢æ¿ä¸­å¯ä»¥ä½¿ç”¨æ¨¡æ¿å˜é‡ï¼Œå˜é‡ä¼šåœ¨ä»ªè¡¨ç›˜é¡¶éƒ¨å±•ç¤ºä¸ºä¸‹æ‹‰é€‰æ‹©æ¡†ã€‚ Variables çš„ç±»å‹åŒ…æ‹¬ï¼š Interval - è¡¨ç¤ºæ—¶é—´è·¨åº¦ï¼Œæ¥åŠ¨æ€æ”¹å˜è¡¨è¾¾å¼ä¸­çš„æ—¶é—´æ®µ Query - å…è®¸ç”¨æˆ·ç¼–å†™æ•°æ®æºæŸ¥è¯¢è¯­å¥ï¼Œæ ¹æ®æŸ¥è¯¢ç»“æœå˜ä¸ºå˜é‡çš„å¯é€‰å€¼ Datasource - å…è®¸ç”¨æˆ·é€šè¿‡å˜é‡æ›´æ”¹æ•´ä¸ªä»ªè¡¨ç›˜çš„æ•°æ®æº Custom - ç”¨æˆ·è‡ªå®šä¹‰ç‰¹å®šçš„å¯é€‰å˜é‡å€¼ Constant - å®šä¹‰éšè—å¸¸é‡ Ad hoc filter - ä»…ç”¨äºæŸäº›ç‰¹å®šæ•°æ®æº Text box - å…·æœ‰å¯é€‰é»˜è®¤å€¼çš„æ–‡æœ¬è¾“å…¥å­—æ®µ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:2:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.2 å®šåˆ¶é¢æ¿ 2.2.1 Graph é¢æ¿ é…ç½® Query é¡¹ Data source - ä½¿ç”¨çš„æ•°æ®æº Query options - è®¾ç½®æŸ¥è¯¢æ•°æ®ç›¸å…³çš„å‚æ•°ï¼Œä¾‹å¦‚æœ€å°æ—¶é—´é—´éš”ç­‰ Query - è®¾ç½®æŸ¥è¯¢è¯­å¥ï¼Œå±•ç¤ºçš„æ•°æ®å°±æ¥è‡ªäºé€šè¿‡æŸ¥è¯¢è¯­å¥æŸ¥è¯¢æ•°æ®æº Legend format - å¯è§†åŒ–å›¾æŠ˜çº¿çš„åç§° é…ç½® Panel options Title - é¢æ¿åç§° Description - é¢æ¿æè¿° é…ç½® Axes Axes ç”¨äºé…ç½®åæ ‡æŠ½çš„æ˜¾ç¤ºã€‚å¯ä»¥ä½¿ç”¨åæ ‡è½´å·¦å³ä¸¤ä¾§ Y è½´çš„å•ä½ã€‚ é…ç½® Legend é…ç½®å›¾ä¾‹çš„æ˜¾ç¤ºæ–¹å¼ï¼Œå¯ä»¥å±•ç¤ºä¸€äº›ç‰¹æ®Šçš„å€¼ã€‚ é…ç½® Display Display é€‰é¡¹ç”¨äºæˆ˜æœ¯æ˜¾ç¤ºçš„æ ·å¼ã€‚ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:2:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"å‚è€ƒ ã€ŠPrometheus ç›‘æ§æŠ€æœ¯ä¸å®è·µã€‹ ","date":"2021-07-17","objectID":"/posts/cloud_computing/prometheus-learning/grafana-basic/:3:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - Grafana åŸºç¡€","uri":"/posts/cloud_computing/prometheus-learning/grafana-basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"PromQL æ¦‚å¿µä»¥åŠè¯­æ³•","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1 æ•°æ®ç±»å‹ é¦–å…ˆï¼Œè¿˜æ˜¯å…ˆç†è§£ æ—¶é—´åºåˆ— è¿™ä¸ªæ¦‚å¿µï¼š ^ - â”‚ . . . . . . . . . . . . . . . |.| . . . â”‚ . . . . . . . . . . . . . . |.| . . . . â”‚ . . . . . . . . . . . . . |.| . . . . â”‚ . . . . . . . . . . . . . . |.| . . . v - \u003c------------------ æ—¶é—´ ----------------\u003e ä¸Šå›¾ä¸­ï¼Œæ¨ªè½´æ˜¯æ—¶é—´ï¼Œçºµè½´æ˜¯æ—¶é—´çº¿ï¼Œæ¯ä¸€ä¸ªç‚¹å°±æ˜¯ä¸€ä¸ª æ ·æœ¬ã€‚è€Œ Prometheus æ¯æ¬¡æ¥å—æ•°æ®æ—¶ï¼Œæ”¶åˆ°çš„å°±æ˜¯å›¾ä¸­çºµå‘çš„ä¸€æ¡çº¿ã€‚è€Œè¿™ä¸€ç»„åŒæ—¶é—´è®°å½•çš„æ•°æ®ï¼Œå°±æ˜¯ æ—¶é—´åºåˆ—ã€‚ åœ¨å®é™…ä¸­ï¼Œæ—¶é—´åºåˆ—å°±æ˜¯ Metric é¡¹çš„ä¸åŒ label çš„ç»„åˆã€‚ PromQL å°†æ•°æ®å½’ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼š å³æ—¶å‘é‡instant vector - åŒä¸€æ—¶åˆ»çš„ä¸€ç»„æ—¶é—´åºåˆ—ã€‚å¯ä»¥ç†è§£ä¸ºå°±æ˜¯ç¬æ—¶çš„æ ·æœ¬çš„é›†åˆã€‚ æ³¨æ„æ˜¯æ ·æœ¬çš„é›†åˆï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ ·æœ¬ï¼Œå¯ä»¥ç†è§£ä¸ºæ—¶é—´åºåˆ—ã€‚ åŒºé—´å‘é‡range vector - ä¸€å®šæ—¶é—´èŒƒå›´å†…çš„ä¸€ç»„æ—¶é—´åºåˆ—ã€‚å¯ä»¥ç†è§£ä¸ºæ—¶é—´èŒƒå›´çš„æ ·æœ¬çš„é›†åˆã€‚ æ³¨æ„æ˜¯æ—¶é—´èŒƒå›´å†…çš„æ ·æœ¬é›†åˆï¼Œå¯ä»¥ç†è§£ä¸ºè¿ç»­çš„å¤šç»„æ—¶é—´åºåˆ—ã€‚ æ ‡é‡scalar - çº¯é‡æ•°æ®ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ²¡æœ‰æ—¶é—´æˆ³ã€‚ å­—ç¬¦ä¸²string - æœªè¢«ä½¿ç”¨çš„çº¯å­—ç¬¦ä¸²å€¼ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:1:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2 Selector ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:2:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.1 Instant Vector Selector Instant Vector Selector æŸ¥è¯¢æŸä¸€æ—¶é—´ï¼ˆé»˜è®¤æœ€æ–°æ—¶é—´ï¼‰çš„æ—¶é—´åºåˆ—ï¼Œå¹¶é€šè¿‡ label å¯¹å…¶è¿›è¡Œæ ·æœ¬ç­›é€‰ï¼Œå¾—åˆ°ä¸€ä¸ªå³æ—¶å‘é‡ã€‚ é€šè¿‡ {} ä¸­æ·»åŠ  label åŒ¹é…è¿ç®—ï¼Œæ¥è¿›è¡Œæ ·æœ¬çš„ç­›é€‰ã€‚å¤šä¸ªåŒ¹é…ä¹‹é—´é€šè¿‡ , å·åˆ†éš”ã€‚ è¿ç®—ç¬¦ åŒ¹é…è¿ç®—ç¬¦ ç¤ºä¾‹ = ç›¸ç­‰åŒ¹é… job=â€œmysqld_nodeâ€ != ä¸ç›¸ç­‰åŒ¹é… job!=â€œredis_expoterâ€ =~ æ­£åˆ™åŒ¹é… job=~â€œnode_.*â€ !~ æ­£åˆ™ä¸åŒ¹é… job!~â€œnginx-.*â€ ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æŸ¥æ‰¾ /mnt ç›®å½•ä¸‹é™¤äº† /mnt/local_pv ä¸‹çš„æ‰€æœ‰æŒ‚è½½ç‚¹çš„å¤§å°ï¼š node_filesystem_size_bytes{mountpoint=~\"/mnt/.*\",mountpoint!~\"/mnt/local_pv/.*\"} __name__ Metric Name åœ¨ Prometheus åº•å±‚ä¼šä½¿ç”¨ label â€œnameâ€ è®°å½•ï¼Œå› æ­¤é€šè¿‡ {name=â€œxxxâ€} å¯ä»¥ç­›é€‰ Metric é¡¹ã€‚ ä¸è¿‡è¯¥æ“ä½œä¼šéå†æ‰€æœ‰çš„ Metric æ¥è¿‡æ»¤ï¼Œæ‰€ä»¥è¦æ³¨æ„æ€§èƒ½ã€‚ é»˜è®¤ä¼šæŸ¥è¯¢æœ€æ–°æ—¶é—´çš„æ—¶é—´åºåˆ—ï¼Œå¯ä»¥é€šè¿‡ offset æ¥è¿›è¡ŒåŸºå‡†æ—¶é—´åç§»ã€‚å¦‚ä¸‹ç¤ºä¾‹æŸ¥è¯¢å½“å‰æ—¶é—´å‰ä¸€å¤©çš„æ ·æœ¬ï¼š node_filesystem_size_bytes{mountpoint=~\"/mnt/.*\"}offset1d ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:2:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.2 Range Vector Selectors Range Vector Selectors æŸ¥è¯¢ä¸€æ®µæ—¶é—´èŒƒå›´å†…çš„æ—¶é—´åºåˆ—ï¼Œå¹¶é€šè¿‡ label åŒ¹é…è¿›è¡Œæ ·æœ¬è¿‡æ»¤ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªåŒºé—´å‘é‡ã€‚ åœ¨æœ«å°¾åŠ ä¸Š [\u003cduration\u003e] çš„æ–¹å¼æ¥æŒ‡å®šè·å–è¿‡å» duration æ—¶é—´çš„æ ·æœ¬ã€‚æ—¶é—´å•ä½æ”¯æŒï¼šs(ç§’) m(åˆ†) h(å°æ—¶) d(å¤©) w(å‘¨) y(å¹´)ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢åœ¨å‰é¢åŸºç¡€ä¸ŠæŸ¥è¯¢è¿‡å» 1m çš„æ ·æœ¬ï¼š node_filesystem_size_bytes{mountpoint=~\"/mnt/.*\",mountpoint!~\"/mnt/local_pv/.*\"}[1m] Note è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå³æ—¶å‘é‡æ˜¯æ¯ä¸ªæ ·æœ¬åªæœ‰ä¸€ä¸ªå€¼ï¼ŒåŒºé—´å‘é‡æ˜¯æ¯ä¸ªæ ·æœ¬åŒ…å«ä¸€ç»„çš„å€¼ã€‚ åŒæ ·ï¼Œå¯ä»¥ç”¨ â€œoffsetâ€ æ¥æŒ‡å®šåŸºå‡†æ—¶é—´ï¼š node_filesystem_size_bytes{mountpoint=~\"/mnt/.*\",mountpoint!~\"/mnt/local_pv/.*\"}[1m]offset1d ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:2:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"3 èšåˆæ“ä½œ Prometheus æä¾›äº†è®¸å¤šå†…ç½®çš„èšåˆæ“ä½œï¼Œèšåˆæ“ä½œä»…ä»…é€‚ç”¨äºä¸€ä¸ªå³æ—¶å‘é‡ã€‚é€šè¿‡èšåˆæ“ä½œï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„å³æ—¶å‘é‡ã€‚ Note å¯ä»¥ç†è§£ä¸ºå¯¹å³ä½¿å‘é‡è¿›è¡Œä¸€äº›æ“ä½œï¼Œå¾—åˆ°ä¸€ç»„æ–°çš„å³ä½¿å‘é‡ã€‚ èšåˆæ“ä½œçš„è¯­æ³•å¦‚ä¸‹ï¼š \u003caggr-op\u003e([param,] \u003cvector\u003e) [without/by \u003clabel list\u003e] aggr-op - èšåˆæ“ä½œåç§° param - ä¼ é€’ç»™æ“ä½œçš„å‚æ•° vector - å³æ—¶å‘é‡ without/by - æ“ä½œå³æ—¶å‘é‡å‰ï¼Œé€šè¿‡ label åŒ¹é…å¯¹æ ·æœ¬è¿›ä¸€æ­¥è¿›è¡Œè¿‡æ»¤/ç­›é€‰ without æŒ‰åŒ¹é…åˆ°çš„ä¹‹å¤–çš„ label åˆ†ç»„ï¼Œè¾“å‡ºä¿ç•™ label by æŒ‰åŒ¹é…åˆ°çš„ label åˆ†ç»„ï¼Œè¾“å‡ºä¿ç•™ label Note å¦‚æœä¸ä½¿ç”¨ without æˆ–è€… byï¼Œé»˜è®¤ä¸º by()ï¼Œä¹Ÿå°±æ˜¯å»é™¤æ‰€æœ‰çš„ labelã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢ä½¿ç”¨ without å¾—åˆ°èŠ‚ç‚¹æ‰€æœ‰ CPU æ ·æœ¬çš„å¹³å‡å€¼ï¼š avg(node_cpu_seconds_total)without(cpu){instance=\"localhost:9101\",job=\"prometheus\",mode=\"idle\"}2701333.81{instance=\"localhost:9101\",job=\"prometheus\",mode=\"iowait\"}1696.59625{instance=\"localhost:9101\",job=\"prometheus\",mode=\"irq\"}0{instance=\"localhost:9101\",job=\"prometheus\",mode=\"nice\"}1214.26125{instance=\"localhost:9101\",job=\"prometheus\",mode=\"softirq\"}4898.343750000001{instance=\"localhost:9101\",job=\"prometheus\",mode=\"steal\"}3861.9112499999997{instance=\"localhost:9101\",job=\"prometheus\",mode=\"system\"}49185.7{instance=\"localhost:9101\",job=\"prometheus\",mode=\"user\"}101896.9975 without å»é™¤äº†å³æ—¶å‘é‡ä¸­æ‰€æœ‰æ ·æœ¬çš„ â€œcpuâ€ labelï¼Œè€ŒæŒ‰ç…§å‰©ä¸‹çš„ label è¿›è¡Œåˆ†ç»„ï¼Œç›¸åŒçš„ label æ ·æœ¬è¿›è¡Œèšåˆæ±‚å¹³å‡å€¼ã€‚ åŒæ ·ï¼Œä½¿ç”¨ by å°†æ‰€æœ‰èŠ‚ç‚¹æ‰€æœ‰ CPU çš„æŒ‰ç…§ mode åˆ†ç»„ï¼Œæ±‚å¹³å‡ï¼š avg(node_cpu_seconds_total)by(mode){mode=\"user\"}101910.36750000001{mode=\"idle\"}2701600.49625{mode=\"iowait\"}1696.73375{mode=\"irq\"}0{mode=\"nice\"}1214.3175{mode=\"softirq\"}4899.33375{mode=\"steal\"}3862.2212499999996{mode=\"system\"}49191.16 by å°†å³æ—¶å‘é‡æ‰€æœ‰æ ·æœ¬çš„å…¶ä»– label å»é™¤ï¼Œä»…ä»…ä¿ç•™ label â€œmodeâ€ï¼Œç„¶åæŒ‰ç…§ â€œmodeâ€ åˆ†ç»„èšåˆæ ·æœ¬ï¼Œå¹¶æ±‚å¹³å‡å€¼ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:3:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"3.1 èšåˆæ“ä½œç¬¦ ä¸‹é¢åˆ—å‡ºäº† Prometheus æä¾›çš„èšåˆæ“ä½œç¬¦ï¼š åç§° æè¿° sum(\u003cvector\u003e) å°†å³æ—¶å‘é‡æ‰€æœ‰æ ·æœ¬å€¼ç›¸åŠ  max(\u003cvector\u003e) å¾—åˆ°å³æ—¶å‘é‡æ‰€æœ‰æ ·æœ¬çš„æœ€å¤§å€¼ min(\u003cvector\u003e) å¾—åˆ°å³æ—¶å‘é‡æ‰€æœ‰æ ·æœ¬çš„æœ€å°å€¼ avg(\u003cvector\u003e) å¾—åˆ°å³æ—¶å‘é‡æ‰€æœ‰æ ·æœ¬çš„å¹³å‡å€¼ stddev(\u003cvector\u003e) æ ‡å‡†å·®ï¼Œå¯¹ä¸€ç»„æ•°å­—åˆ†å¸ƒæƒ…å†µçš„ç»Ÿè®¡åº¦é‡ï¼Œç”¨äºæ£€æŸ¥å¼‚å¸¸å€¼ stdvar(\u003cvector\u003e) æ ‡å‡†æ–¹å·®ï¼Œæ ‡å‡†å·®çš„å¹³æ–¹ count(\u003cvector\u003e) è®¡æ•°ï¼Œè®¡ç®—æ ·æœ¬çš„æ•°é‡ count_values(â€œlabelâ€, \u003cvector\u003e) å¯¹ç›¸åŒçš„ value è¿›è¡Œè®¡æ•°ï¼Œç»Ÿè®¡æ¯ä¸€ä¸ªæ ·æœ¬å€¼å‡ºç°çš„æ¬¡æ•°ã€‚ count_values ä¸ºæ ¹æ® value æ·»åŠ ç”±å‚æ•°æŒ‡å®šçš„ label bottomk(N, \u003cvector\u003e) å¯¹æ ·æœ¬å€¼è¿›è¡Œå°åˆ°å¤§æ’åºï¼Œè¿”å›å‰ N ä¸ªæ ·æœ¬ï¼ˆå…¶å®ä¸æ˜¯èšåˆæ“ä½œï¼Œå› æ­¤ without ä¸ by ä»…ä»…ç”¨äºæ’åºåˆ†ç»„ï¼‰ topk(N, \u003cvector\u003e) å¯¹æ ·æœ¬å€¼è¿›è¡Œå¤§åˆ°å°æ’åºï¼Œè¿”å›å‰ N ä¸ªæ ·æœ¬ï¼ˆå…¶å®ä¸æ˜¯èšåˆæ“ä½œï¼Œå› æ­¤ without ä¸ by ä»…ä»…ç”¨äºæ’åºåˆ†ç»„ï¼‰ quantile(N, \u003cvector\u003e) åœ¨ (0, N * 100%) ä¸­æ ·æœ¬çš„åˆ†å¸ƒæ¬¡æ•°ï¼Œç±»ä¼¼äº Histogram çš„æ¦‚å¿µ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:3:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"3.2 èšåˆæ“ä½œç†è§£ è¿™é‡Œæ€»ç»“ä¸€ä¸‹èšåˆæ“ä½œå¤§æ¦‚çš„å«ä¹‰ï¼š é€šè¿‡ without ä¸ by å¯¹å³æ—¶å‘é‡ä¸­æ‰€æœ‰æ ·æœ¬è¿‡æ»¤/ä¿ç•™ labelï¼› æŒ‰ç…§å‰©ä½™çš„ label è¿›è¡Œåˆ†ç»„ï¼Œlabel å€¼ç›¸åŒçš„ä¸ºåŒä¸€ç»„ï¼› æŒ‰ç…§ç»„çš„ç»´åº¦ï¼Œå¯¹æ¯ç»„æ ·æœ¬è¿›è¡Œèšåˆæ“ä½œï¼› æœ€åæŒ‰ç…§ç»„å¾—åˆ°äº†æ–°çš„å³æ—¶å‘é‡ï¼› ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:3:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"4 PromQL è¿ç®—ç¬¦ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:4:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"4.1 ç®—æœ¯è¿ç®—ç¬¦ ç®—æœ¯è¿ç®—ç¬¦å¯¹å€¼è¿›è¡Œç®—æœ¯è¿ç®—ï¼Œç›®å‰åŒ…å« 6 ç§ç®—æœ¯è¿ç®—ç¬¦ï¼š è¿ç®—ç¬¦ æè¿° + ç›¸åŠ  - ç›¸å‡ * ç›¸ä¹˜ / ç›¸é™¤ % æ±‚ä½™ ^ å¹‚ç­‰è¿ç®— æ ‡é‡ ä¸ æ ‡é‡ -\u003e æ ‡é‡ (5+1)*3scalar18 å³æ—¶å‘é‡ ä¸ æ ‡é‡ -\u003e å³æ—¶å‘é‡ å¯¹å³æ—¶å‘é‡ä¸­æ¯ä¸ªæ ·æœ¬ä¼šä¸æ ‡é‡è¿›è¡Œç®—æœ¯è¿ç®—ï¼Œå› æ­¤å¾—åˆ°ä¸€ç»„æ–°çš„å€¼çš„å³æ—¶å‘é‡ã€‚ node_disk_read_bytes_total/1024/1024{device=\"dm-0\",instance=\"localhost:9101\",job=\"prometheus\"}26745.40966796875{device=\"dm-1\",instance=\"localhost:9101\",job=\"prometheus\"}3.28515625{device=\"dm-2\",instance=\"localhost:9101\",job=\"prometheus\"}2623.3681640625{device=\"sda\",instance=\"localhost:9101\",job=\"prometheus\"}29390.4736328125 å³æ—¶å‘é‡ ä¸ å³æ—¶å‘é‡ -\u003e å³æ—¶å‘é‡ ä¸¤ä¸ªå³æ—¶å‘é‡è¿›è¡Œç®—æœ¯è¿ç®—æ—¶ï¼Œä¼šéå†å·¦è¾¹å³æ—¶å‘é‡ä¸­æ ·æœ¬ï¼ŒæŒ‰ç…§ label å®Œå…¨åŒ¹é…å³è¾¹å³æ—¶å‘é‡æ ·æœ¬ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„æ ·æœ¬ï¼Œé‚£ä¹ˆè¿›è¡Œå€¼çš„è¿ç®—ï¼Œå¦åˆ™ç›´æ¥ä¸¢å¼ƒæ ·æœ¬ã€‚ node_disk_read_bytes_total+node_disk_written_bytes_total{device=\"dm-0\",instance=\"localhost:9101\",job=\"prometheus\"}700855357952{device=\"dm-1\",instance=\"localhost:9101\",job=\"prometheus\"}3444736{device=\"dm-2\",instance=\"localhost:9101\",job=\"prometheus\"}240470945280{device=\"sda\",instance=\"localhost:9101\",job=\"prometheus\"}941364913152 ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:4:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"4.2 å…³ç³»è¿ç®—ç¬¦ å…³ç³»è¿ç®—ç¬¦ç”¨äºå€¼ä¹‹é—´çš„å¤§å°æ¯”è¾ƒï¼Œç›®å‰åŒ…å« 6 ç§å…³ç³»è¿ç®—ç¬¦ï¼š è¿ç®—ç¬¦ æè¿° == ç›¸ç­‰ != ä¸ç­‰ \u003e å¤§äº \u003c å°äº \u003e= å¤§äºç­‰äº \u003c= å°äºç­‰äº æ ‡é‡ ä¸ æ ‡é‡ -\u003e æ ‡é‡ 0(false)/1(true) æ ‡é‡ä¹‹é—´ä½¿ç”¨å…³ç³»è¿ç®—ç¬¦å¿…é¡»åŠ ä¸Š bool ä¿®é¥°ç¬¦ã€‚ 99\u003e=bool80scalar1 å³æ—¶å‘é‡ ä¸ æ ‡é‡ -\u003e å³æ—¶å‘é‡ å¯¹å³ä½¿å‘é‡ä½¿ç”¨å…³ç³»è¿ç®—æ˜¯ç”¨äºç­›é€‰æ ·æœ¬çš„ã€‚å¯¹å³ä½¿å‘é‡çš„æ¯ä¸ªæ ·æœ¬ï¼Œä¼šå»æ¯”è¾ƒæ ‡é‡ã€‚å¦‚æœæ¯”è¾ƒç»“æœä¸º true é‚£ä¹ˆå°±ä¿ç•™æ ·æœ¬ï¼Œå¦åˆ™å°±ä¼šä¸¢å¼ƒæ ·æœ¬ã€‚ node_disk_write_time_seconds_total\u003e=100node_disk_write_time_seconds_total{device=\"dm-0\",instance=\"localhost:9101\",job=\"prometheus\"}118100.283node_disk_write_time_seconds_total{device=\"dm-2\",instance=\"localhost:9101\",job=\"prometheus\"}10610.281node_disk_write_time_seconds_total{device=\"sda\",instance=\"localhost:9101\",job=\"prometheus\"}88011.634 å³æ—¶å‘é‡ ä¸ å³æ—¶å‘é‡ -\u003e å³æ—¶å‘é‡ ä¸¤ä¸ªå³æ—¶å‘é‡ä¹‹å‰çš„å…³ç³»è¿ç®—ï¼Œä¼šéå†å·¦è¾¹å³æ—¶å‘é‡ä¸­æ ·æœ¬ï¼ŒæŒ‰ç…§ label å®Œå…¨åŒ¹é…å³è¾¹å³æ—¶å‘é‡æ ·æœ¬ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„æ ·æœ¬ï¼Œé‚£ä¹ˆè¿›è¡Œå€¼çš„æ¯”è¾ƒï¼Œå¦åˆ™ç›´æ¥ä¸¢å¼ƒæ ·æœ¬ã€‚ label å®Œå…¨åŒ¹é…çš„æ ·æœ¬æ¯”è¾ƒå¦‚æœç»“æœä¸º trueï¼Œé‚£ä¹ˆä¿ç•™æ ·æœ¬ï¼Œå¦åˆ™åˆ é™¤æ ·æœ¬ã€‚ node_disk_written_bytes_total\u003enode_disk_read_bytes_totalnode_disk_written_bytes_total{device=\"dm-0\",instance=\"localhost:9101\",job=\"prometheus\"}673182207488node_disk_written_bytes_total{device=\"dm-2\",instance=\"localhost:9101\",job=\"prometheus\"}237730660864node_disk_written_bytes_total{device=\"sda\",instance=\"localhost:9101\",job=\"prometheus\"}910928728576 ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:4:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"4.3 å‘é‡åŒ¹é… ä¹‹å‰çœ‹åˆ°ï¼Œä¸¤ä¸ªå³æ—¶å‘é‡ä¹‹é—´åšè¿ç®—æ—¶ï¼Œéƒ½æ˜¯éµå¾ª label å®Œå…¨åŒ¹é…çš„æ ·æœ¬è¿›è¡Œè®¡ç®—ã€‚è¿™ç§å³æ—¶å‘é‡çš„åŒ¹é…è§„åˆ™ç§°ä¸º å‘é‡åŒ¹é…ã€‚ Prometheus æä¾›äº†ä¸¤ç§å‘é‡åŒ¹é…æ¨¡å¼ï¼š one-to-one ä¸¤ä¸ªå³æ—¶å‘é‡è¿ç®—æ—¶ï¼Œé™¤äº† name labelï¼Œå…¶ä»– label å®Œå…¨åŒ¹é…çš„æ ·æœ¬è¿›è¡Œè®¡ç®—ã€‚ å¯ä»¥ä½¿ç”¨å…³é”®å­— on æŒ‡å®šç”¨äºåŒ¹é…çš„ labelï¼Œæˆ–è€…ä½¿ç”¨å…³é”®å­— ignoring å¿½ç•¥æŒ‡å®šçš„ label. many-to-one å’Œ one-to-many å¤šå¯¹ä¸€å’Œä¸€å¯¹å¤šåŒ¹é…æ¨¡å¼ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ ·æœ¬åŒ¹é…åˆ°å¤šä¸ªæ ·æœ¬çš„ labelã€‚é€šè¿‡ group_left æˆ– group_right ä¿®é¥°ç¬¦æ˜ç¡®æŒ‡å®šå“ªä¸ªå‘é‡å…·æœ‰æ›´é«˜çš„åŸºæ•°ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:4:3","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"4.4 é€»è¾‘è¿ç®—ç¬¦ é€»è¾‘è¿ç®—ç¬¦ç”¨äºå‘é‡ä¸å‘é‡ä¹‹é—´ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡ã€‚Prometheus æä¾›äº†ä¸‰ç§é€»è¾‘è¿ç®—ç¬¦ï¼šandã€orã€unlessã€‚ Note é€»è¾‘è¿ç®—ç¬¦æ˜¯ä»¥ label æ¥ä¿ç•™æ ·æœ¬çš„ï¼Œä¸ä¼šå¯¹å€¼è¿›è¡Œè¿ç®—ã€‚ and and é€»è¾‘è¿ç®—ç¬¦å¯¹ä¸¤ä¸ªå³æ—¶å‘é‡è¿›è¡Œäº¤é›†è¿ç®—ã€‚æ–°çš„å³æ—¶å‘é‡ä¸­åŒ…å« vector1 å®Œå…¨åŒ¹é… vector2 çš„æ ·æœ¬ã€‚ or or é€»è¾‘è¿ç®—ç¬¦å¯¹ä¸¤ä¸ªå³æ—¶å‘é‡è¿›è¡Œå¹¶é›†è¿ç®—ã€‚æ–°çš„å³ä½¿å‘é‡ä¸­åŒ…å« vector1 çš„æ‰€æœ‰åŸå§‹æ ·æœ¬ï¼Œä»¥åŠ vector2 ä¸­ä¸ä¸ vector1 å®Œå…¨åŒ¹é…çš„æ ·æœ¬ã€‚ unless unless é€»è¾‘è¿ç®—ç¬¦å¯¹ä¸¤ä¸ªå³æ—¶å‘é‡è¿›è¡Œå·®é›†è¿ç®—ã€‚æ–°çš„å³ä½¿å‘é‡ä¸­ï¼ŒåªåŒ…å« vector1 ç‹¬æœ‰çš„æ ·æœ¬ã€‚ Note å¯ä»¥çœ‹åˆ°ï¼Œé€»è¾‘è¿ç®—å°±æ˜¯æ•°å­¦é›†åˆçš„è¿ç®—ï¼Œç›¸åŒå…ƒç´ çš„åˆ¤æ–­æ¡ä»¶å°±æ˜¯ label å®Œå…¨åŒ¹é…ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:4:4","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"5 PromQL å‡½æ•° ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:5:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"5.1 æ•°å­¦å‡½æ•° abs(v vector) è¾“å…¥å³æ—¶å‘é‡ï¼Œè¿”å›å…¶æ¯ä¸ªå€¼çš„ç»å¯¹å€¼ã€‚ sqrt(v vector) å¯¹å³æ—¶å‘é‡çš„æ¯ä¸ªæ ·æœ¬å€¼è¿›è¡Œå¹³æ–¹æ ¹ã€‚ round(v vector) å³æ—¶å‘é‡æ¯ä¸ªæ ·æœ¬å€¼å››èˆäº”å…¥åˆ°æœ€è¿‘çš„æ•´æ•°ã€‚ clamp_max(v vector, max scalar) å’Œ clamp_minx(min scalar) å¯¹å³æ—¶å‘é‡æ¯ä¸ªæ ·æœ¬çš„å€¼è®¾ç½®ä¸Šé™å’Œä¸‹é™ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:5:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"5.2 æ—¶é—´å‡½æ•° time() æŸ¥è¯¢çš„è®¡ç®—æ—¶é—´ä»¥ç§’ä¸ºå•ä½è¿”å›ã€‚ æ—¶é’Ÿå’Œæ—¥å†ç±»å‡½æ•° ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:5:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"5.3 æ ‡ç­¾æ“ä½œå‡½æ•° label_replace(v vector, dst_label string, replacement string, src_label strig, regex string) å¯¹å³æ—¶å‘é‡ vï¼Œå°†æ­£åˆ™è¡¨è¾¾å¼ regex ä¸ src_label æ ‡ç­¾çš„å€¼è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™å°† dst_label æ ‡ç­¾çš„å€¼ï¼ˆä¸å­˜åœ¨ä¼šæ·»åŠ ï¼‰æ›¿æ¢ä¸º replacement æŒ‡å®šçš„ã€‚ label_join(v vector, dst_label string, separator string, src_label string, src_label_2 string â€¦) label_join ä½¿ç”¨åˆ†éš”ç¬¦ separator å°†æ‰€æœ‰ src_label çš„å€¼è¿æ¥åœ¨ä¸€èµ·ï¼Œå˜ä¸º dst_label çš„å€¼ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:5:3","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"5.4 Counter æŒ‡æ ‡å¢é•¿ç‡ increase(v range-vector) increase å‡½æ•°åªèƒ½å¯¹ counter ç±»å‹çš„åŒºé—´å‘é‡ã€‚å…¶è·å–åŒºé—´å‘é‡ä¸­ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ ·æœ¬ï¼Œå¹¶è¿”å›å…¶å¢é•¿é‡ã€‚ rate(v range-vector) rate å‡½æ•°åªèƒ½å¯¹ counter ç±»å‹çš„åŒºé—´å‘é‡è°ƒç”¨ã€‚ç”¨äºè®¡ç®—åŒºé—´å‘é‡ä¸­æ—¶é—´åºåˆ—æ¯ç§’çš„å¹³å‡å¢é•¿ç‡ã€‚ irate(v range-vector) irate å‡½æ•°è®¡ç®—åŒºé—´å‘é‡ä¸­æ—¶é—´åºåˆ—çš„æ¯ç§’å¢é•¿ç‡ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:5:4","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"5.5 Gauge æŒ‡æ ‡è¶‹åŠ¿å˜åŒ–é¢„æµ‹ predict_linear(v range-vector, t scalar) predict_linear åŸºäºåŒºé—´å‘é‡ï¼Œä½¿ç”¨ç®€å•çš„çº¿æ€§å›å½’é¢„æµ‹æ—¶é—´åºåˆ— t ç§’çš„å€¼ï¼Œä»è€Œå¯¹æ—¶é—´åºåˆ—çš„å˜åŒ–è¶‹åŠ¿åšå‡ºé¢„æµ‹ã€‚ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:5:5","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"å‚è€ƒ ã€ŠPrometheus ç›‘æ§æŠ€æœ¯ä¸å®è·µã€‹ ","date":"2021-07-08","objectID":"/posts/cloud_computing/prometheus-learning/promql/:6:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - PromQL","uri":"/posts/cloud_computing/prometheus-learning/promql/"},{"categories":["Prometheus å­¦ä¹ "],"content":"Prometheus çš„åŸºæœ¬æ¦‚å¿µ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1 æ•°æ®æ¨¡å‹ Prometheus ä¿å­˜çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ æ—¶é—´åºåˆ—time series æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ•°æ®ä¼šå¸¦æœ‰ä¸€ä¸ªæ—¶é—´æˆ³ã€‚ é€šè¿‡å›¾è¡¨å¯ä»¥ç†è§£å…¶æ¨¡å‹ï¼š å›¾è¡¨ä¸­æ¯ä¸ªç‚¹éƒ½æ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®ï¼Œä¹Ÿç§°ä¸º æ ·æœ¬Sampleã€‚ ä¸åŒçš„ label ä¸ Metric name ç»„åˆæ ‡è¯†äº†ä¸€ä¸ªæ•°æ®æµï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å›¾è¡¨çš„ä¸€æ¡çº¿ã€‚ æ‰€æœ‰çš„æ•°æ®éƒ½è¡¨ç¤º prometheus_http_request_total é¡¹ç»Ÿè®¡ã€‚ æ‰€ä»¥ï¼Œå…¶æ•°æ®æ¨¡å‹ä¸ºï¼š Metric - ç»Ÿè®¡é¡¹ Metric Name ä¸ Labels - ç»Ÿè®¡é¡¹ä¸‹çš„ä¸€ä¸ªæ•°æ®æµ Sample - æ•°æ®æµä¸­çš„æŸä¸ªæ•°æ® ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:1:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.1 Metric Metric å®šä¹‰äº†æŸä¸ªç›‘æ§æŒ‡æ ‡ï¼Œéƒ½ç”±å¦‚ä¸‹æ ¼å¼è¡¨ç¤ºï¼š \u003cmetric name\u003e{\u003clabel name\u003e=\u003clabel value\u003e, ...} è¯¥æ ¼å¼æ ‡è¯†ä¹Ÿè¢«ç§°ä¸º Notationã€‚ Metric name è¡¨ç¤ºç›‘æ§é¡¹çš„å«ä¹‰ï¼ŒLabels åæ˜ äº†æ ·æœ¬çš„ç‰¹å¾ç»´åº¦ï¼š node_cpu_seconds_total{cpu=\"0\",mode=\"idle\"} 2.01377426e+06 node_cpu_seconds_total{cpu=\"0\",mode=\"iowait\"} 1639.03 node_cpu_seconds_total{cpu=\"1\",mode=\"idle\"} 1.9973224e+06 node_cpu_seconds_total{cpu=\"1\",mode=\"iowait\"} 1535.02 å¯ä»¥çœ‹åˆ°ï¼ŒLabels æ˜¯ä¸åŒå€¼çš„ç»„åˆï¼Œéƒ½æ˜¯ä¸€ä¸ª Metric å®ä¾‹åŒ–ã€‚å› æ­¤ Metric name ä¸ Labels çš„ç»„åˆæ‰ä»£è¡¨ä¸€ä¸ªå”¯ä¸€çš„æ•°æ®ã€‚ å…¶ä¸­ï¼Œ__ ä½œä¸ºå‰ç¼€çš„ label æ˜¯ç³»ç»Ÿä¿ç•™çš„ï¼Œåªèƒ½åœ¨ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ã€‚ä¾‹å¦‚ Prometheus åº•å±‚å®ç°ä¸­æŒ‡æ ‡åç§°å®é™…ä¸Šæ˜¯ä»¥ __name__=\u003cmetric name\u003e å½¢å¼ä¿å­˜çš„ï¼š {__name__=\"node_cpu_seconds_total\", cpu=\"0\",mode=\"idle\"} ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:1:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"1.3 Sample Sample ä¸ºæ ·æœ¬ï¼Œå¯ä»¥ç†è§£ä¸ºæŸä¸ªé‡‡é›†é¡¹æŸæ¬¡é‡‡é›†çš„æ•°æ®ã€‚æŒ‰ç…§æ—¶é—´æ’åºçš„ Sample å½¢æˆäº†å®é™…çš„æ•°æ®åºåˆ—æ•°æ®åˆ—è¡¨ã€‚ æ¯ä¸ª Sample åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š metric - metric name ä¸å½“å‰æ ·æœ¬çš„ labelsets value - é‡‡é›†çš„æ•°æ®ï¼Œfloat64 timestamp - é‡‡é›†æ•°æ®çš„æ—¶é—´ï¼Œms Prometheus ä¼šæŒ‰ç…§æ—¶é—´é¡ºåºæ¥å­˜å‚¨ sampleï¼Œå¦‚æœ sample ä¸æ˜¯é¡ºåºæ”¶é›†çš„ï¼Œä¼šå°†å…¶ä¸¢å¼ƒã€‚ ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:1:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2 Metric ç±»å‹ ç›®å‰ï¼ŒPrometheus æä¾›äº† 4 ç§ Metric ç±»å‹ã€‚ Counter Gauge Histogram Summary ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:2:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.1 Counter Counter ä»£è¡¨ä¸€ä¸ªç´¯åŠ æ•°æ®ï¼Œé€šå¸¸ç”¨äºè·Ÿè¸ªäº‹ä»¶æ¬¡æ•°ï¼Œç´¯è®¡æ—¶é—´ç­‰ã€‚ å…¶ç‰¹ç‚¹å¦‚ä¸‹ï¼š å€¼åªèƒ½ä» 0 å¼€å§‹å¢åŠ ï¼Œä¸èƒ½å‡å°‘ã€‚ é‡å¯è¿›ç¨‹åï¼Œåªä¼šé‡ç½®ä¸º 0ã€‚ é€šå¸¸ï¼ŒCounter ç±»æŒ‡æ ‡ä¼šå‘½åä¸º â€œxxx_totalâ€ã€‚ # TYPE node_cpu_seconds_total counter node_cpu_seconds_total{cpu=\"0\",mode=\"idle\"} 2.01526517e+06 node_cpu_seconds_total{cpu=\"0\",mode=\"iowait\"} 1640.01 ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:2:1","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.2 Gauge Gauge åæ˜ ä¸€ä¸ªç¬æ—¶æµ‹é‡å€¼ï¼Œå…¶å€¼å¯èƒ½éšç€æ—¶é—´å˜åŒ–ä¸Šä¸‹æ³¢åŠ¨ã€‚ å…¶ç‰¹ç‚¹å¦‚ä¸‹ï¼š æµ‹é‡å€¼æ˜¯ç¬æ—¶å€¼ï¼Œå¯ä»¥ä»»æ„å˜åŒ–ã€‚ é‡å¯è¿›ç¨‹åï¼Œä¼šè¢«é‡ç½®ã€‚ Gauge æ˜¯é€‚åˆè®°å½•æ— è§„å¾‹å˜åŒ–çš„æ•°æ®ã€‚ # HELP node_load1 1m load average. # TYPE node_load1 gauge node_load1 1.6 # HELP node_load15 15m load average. # TYPE node_load15 gauge node_load15 1.01 ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:2:2","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.3 Histogram Histogram è¡¨ç¤ºç›´æ–¹å›¾ï¼Œä¼šåœ¨ä¸€æ®µæ—¶é—´èŒƒå›´å†…å¯¹æ•°æ®è¿›è¡Œé‡‡æ ·ï¼Œå¹¶å°†å…¶è®¡å…¥ bucket ä¸­ã€‚ histogram ä¸­æœ‰ä¸‰ç±»å€¼ï¼š bucketï¼šå€¼å°äº â€œleâ€ ä¸‹ï¼Œç»Ÿè®¡åˆ°çš„æ•°æ®æ¬¡æ•° sumï¼šç»Ÿè®¡å€¼çš„ç´¯è®¡å’Œ countï¼šç»Ÿè®¡æ¬¡æ•° çœ‹ä¸ªä¾‹å­ï¼Œä¸‹é¢æ•°æ®è¡¨æ˜äº†å¯¹äº / çš„ HTTP è¯·æ±‚çš„ # HELP prometheus_http_request_duration_seconds Histogram of latencies for HTTP requests. # TYPE prometheus_http_request_duration_seconds histogram prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"0.1\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"0.2\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"0.4\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"1\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"3\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"8\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"20\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"60\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"120\"} 1 prometheus_http_request_duration_seconds_bucket{handler=\"/\",le=\"+Inf\"} 1 prometheus_http_request_duration_seconds_sum{handler=\"/\"} 0.000184525 prometheus_http_request_duration_seconds_count{handler=\"/\"} 1 bucket le=â€œ0.1â€ - è¯·æ±‚å¤„ç†æ—¶é—´å°äº 0.1s çš„æ¬¡æ•°ä¸º 1 æ¬¡ le=â€œ0.2â€ - è¯·æ±‚å¤„ç†æ—¶é—´å°äº 0.2s çš„æ¬¡æ•°ä¸º 1 æ¬¡ â€¦ le=\"+Inf\" - è¯·æ±‚å¤„ç†æ—¶é—´å°äº +Inf çš„æ¬¡æ•°ä¸º 1 æ¬¡ sum æ‰€æœ‰è¯·æ±‚çš„å¤„ç†å®é™…çš„æ€»å’Œä¸º 0.000184525 count ç»Ÿè®¡çš„è¯·æ±‚æ¬¡æ•°ä¸º 1 æ¬¡ å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº bucket çš„ç»Ÿè®¡ç»“æœæ˜¯ç´¯è®¡çš„ã€‚ ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:2:3","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"2.4 Summary summary ä¸ºæ¦‚ç‡å›¾ï¼ŒåŒ…å«äº†å„ç™¾åˆ†æ¯”æ ·æœ¬çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ ·æœ¬çš„å€¼çš„åˆ†å¸ƒåŒºé—´ã€‚ summary åŒ…å«ä¸‰ç±»æ•°æ®ï¼š bucketï¼šç™¾åˆ†æ¯”èŒƒå›´æ ·æœ¬çš„å€¼ï¼Œâ€œquantileâ€ è¡¨ç¤ºç™¾åˆ†æ¯” sumï¼šç»Ÿè®¡å€¼çš„ç´¯è®¡å’Œ counterï¼šç»Ÿè®¡æ¬¡æ•° çœ‹ä¸ªç¤ºä¾‹ï¼Œä¸‹é¢æ•°æ®è¡¨æ˜äº†æ‰€æœ‰ wal_fsync æ“ä½œçš„è€—æ—¶åˆ†å¸ƒåŒºé—´ï¼š # HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync. # TYPE prometheus_tsdb_wal_fsync_duration_seconds summary prometheus_tsdb_wal_fsync_duration_seconds{quantile=\"0.5\"} 0.012352463 prometheus_tsdb_wal_fsync_duration_seconds{quantile=\"0.9\"} 0.014458005 prometheus_tsdb_wal_fsync_duration_seconds{quantile=\"0.99\"} 0.017316173 prometheus_tsdb_wal_fsync_duration_seconds_sum 2.888716127000002 prometheus_tsdb_wal_fsync_duration_seconds_count 216 bucket quantile=â€œ0.5â€ - 50% çš„ wal_fsync æ“ä½œè€—æ—¶å°äº 0.012352463 quantile=â€œ0.9â€ - 90% çš„ wal_fsync æ“ä½œè€—æ—¶å°äº 0.014458005 quantile=â€œ0.99â€ - 99% çš„ wal_fsync æ“ä½œè€—æ—¶å°äº 0.017316173 sum æ‰€æœ‰ wal_fsync æ“ä½œè€—æ—¶æ€»å’Œ 2.888716127000002 count ç»Ÿè®¡ wal_fsync æ“ä½œ 216 æ¬¡ å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº bucket çš„ç»Ÿè®¡ç»“æœæ˜¯ç´¯è®¡çš„ã€‚ ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:2:4","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"3 ä»»åŠ¡æ¨¡å‹ åœ¨ Prometheus ä¸­ï¼Œä»»ä½•è¢«é‡‡é›†çš„ç›®æ ‡ï¼ˆå¾€å¾€æ˜¯ä¸€ä¸ª IP:Portï¼‰è¢«ç§°ä¸º Intsanceã€‚è€Œå°†ç›¸åŒé‡‡é›†é¡¹è¿›è¡Œåˆ†ç»„ï¼Œæ¯ä¸ªç»„å°±ç§°ä¸º Jobã€‚ çœ‹ä¸‹ prometheus.yml é…ç½®æ–‡ä»¶æ¥ç†è§£è¿™ä¸ªæ¦‚å¿µï¼š scrape_configs:- job_name:'prometheus'static_configs:- targets:['localhost:9090']- job_name:'node'static_configs:- targets:['localhost:9100'] scrape_configs.job_name æè¿°äº†ä¸€ä¸ªè„šæœ¬ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ª jobï¼Œåˆ†åˆ«è¡¨ç¤ºé‡‡é›† Prometheus ä¸ Nodeã€‚ scrape_configs.static_configs.targets ä¸­å°±è¡¨æ˜äº†éœ€è¦é‡‡é›†çš„ Instanceã€‚ Prometheus æ‹‰å–ä¸€ä¸ªé‡‡é›†æ ·æœ¬æ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨æ—¶åºçš„åŸºç¡€ä¸Šæ·»åŠ  \"job\" ä¸ \"instance\" ä¸¤ä¸ª labelï¼Œç”¨äºè¯†åˆ«è¢«é‡‡é›†çš„ç›®æ ‡ã€‚ prometheus_http_requests_total{code=\"200\", handler=\"/-/ready\", instance=\"localhost:9090\", job=\"prometheus\"} Note å¦‚æœè¿™ä¸¤ä¸ª label å·²ç»å­˜åœ¨äº†ï¼Œé‚£ä¹ˆä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ honor_label é…ç½®æ¥å†³å®šå¦‚ä½•å¤„ç†ã€‚ å¯¹äºæ¯ä¸ªè¢«é‡‡é›†çš„ Instanceï¼ŒPrometheus ä¹Ÿä¼šæœ‰ç€ä¸€äº›ç»Ÿè®¡æ•°æ®ã€‚ up - å¦‚æœ Instance èƒ½å¤Ÿè¢«æ­£å¸¸é‡‡é›†ï¼Œé‚£ä¹ˆå€¼ä¸º 1 ï¼Œå¦åˆ™ä¸º 0 up{instance=\"localhost:9090\", job=\"prometheus\"} 1 scrape_duration_seconds - é‡‡é›† Instance ç´¯è®¡çš„ä½¿ç”¨æ—¶é—´ scrape_duration_seconds{instance=\"localhost:9090\", job=\"prometheus\"} 0.006962203 scrape_samples_post_metric_relabeling - Instance çš„é‡‡é›†æ•°æ®è¢« relabel åï¼Œå‰©ä½™çš„é‡‡é›†æ•°é‡ç´¯è®¡ scrape_samples_post_metric_relabeling{instance=\"localhost:9090\", job=\"prometheus\"} 723 scrape_samples_scraped - ä»è¯¥ Instance é‡‡é›†æ•°æ®çš„æ¬¡æ•° scrape_samples_scraped{instance=\"localhost:9090\", job=\"prometheus\"} 723 ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:3:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Prometheus å­¦ä¹ "],"content":"å‚è€ƒ å®˜æ–¹æ–‡æ¡£ Blog: ä¸€æ–‡ææ‡‚ Prometheus çš„ç›´æ–¹å›¾ ","date":"2021-07-05","objectID":"/posts/cloud_computing/prometheus-learning/basic/:4:0","tags":["prometheus","monitor"],"title":"Prom å­¦ä¹  - åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/prometheus-learning/basic/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° Kubernetes ä¸­æ‰€æœ‰çš„èµ„æºè®¿é—®ä¸æ“ä½œéƒ½æ˜¯é€šè¿‡ API Server æ‰§è¡Œçš„ï¼Œå› æ­¤ API Server æœ‰ç€ä¸€å¥—å®‰å…¨æœºåˆ¶ã€‚ APIServer çš„æƒé™æ£€æŸ¥ä»å¤§ä½“ä¸Šåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š Authentication ï¼šèº«ä»½è®¤è¯ï¼Œç”¨äºéªŒè¯è¯·æ±‚è€…çš„èº«ä»½æ˜¯å¦åˆæ³•ã€‚ Authorization ï¼šæƒé™è®¤è¯ï¼ŒéªŒè¯è¯·æ±‚è€…æ˜¯å¦åŒ…å«å¯¹åº”èµ„æºçš„æ§åˆ¶æƒé™ã€‚ Admission Control ï¼šå¯æ‰©å±•çš„é€šç”¨æ£€æŸ¥ã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Subject å®¢æˆ·ç«¯è®¿é—® API Server é€šå¸¸åŒ…å«ä¸‰ç§é€”å¾„ï¼škubectlã€client åº“ã€REST APIã€‚è€Œè¿™äº›æ­¤ç±»è¯·æ±‚çš„å¯¹è±¡é€šå¸¸ä¸ºï¼šUserAccount å’Œ ServiceAccountã€‚ Note UserAccount ä¸ ServiceAccount ä»…ä»…æ˜¯èº«ä»½ï¼Œè€Œéœ€è¦é€šè¿‡æˆæƒæ‰èƒ½è®¿é—® APIServerã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 UserAccount UserAccount æ˜¯ç‹¬ç«‹äº Kubernetes ä¹‹å¤–çš„ç”¨æˆ·è´¦å·ï¼ŒåŒ…æ‹¬ è´Ÿè´£åˆ†å‘ç§é’¥çš„ç®¡ç†å‘˜ ç±»ä¼¼ Keystone æˆ–è€… Google Account è¿™ç±»çš„æ•°æ®åº“ åŒ…å«ç”¨æˆ·åå¯†ç çš„æ–‡ä»¶ Kubernetes ä¸ä¼šå­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè€Œæ˜¯é€šè¿‡å…¶ CA è¯ä¹¦æ¥è¿›è¡Œèº«ä»½é™åˆ¶ã€‚è¯ä¹¦ä¸­çš„ Subject Common Name ä¼šè¢«ä½œç”¨ç”¨æˆ·åï¼Œä¾‹å¦‚ â€œCN=bobâ€ã€‚ 2.1.1 åˆ›å»º UserAccount ä¸‹é¢å°è¯•æ–°å»ºä¸€ä¸ª Userï¼Œè®©å…¶èƒ½å¤Ÿè®¿é—® Kubernetes: ä½¿ç”¨ Kubernetes çš„æ ¹è¯ä¹¦ç­¾å‘ UserAccount ä½¿ç”¨è¯ä¹¦ï¼š $ openssl genrsa -out shiori.key 2048 $ openssl req -new -key shiori.key -out shiori.csr -subj \"/CN=shiori\" $ openssl x509 -req -in shiori.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out shiori.crt -days 3650 åœ¨ Kubernetes ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·ï¼Œä¼ å…¥å¯¹åº”çš„è¯ä¹¦ä¸ç§é’¥ $ kubectl config set-credentials shiori --client-certificate=./shiori.crt --client-key=./shiori.key --embed-certs=true User \"shiori\" set. åˆ›å»ºä¸€ä¸ª contextï¼ŒæŒ‡å®šå…¶ç”¨æˆ·ã€‚è¿™æ ·æˆ‘ä»¬æ¥ä¸‹æ¥æ¥ä½¿ç”¨çš„å°±æ˜¯æ–°ç”¨æˆ·æ¥è®¿é—® APIServer äº†ã€‚ $ kubectl config set-context shiori@kubernetes --cluster=kubernetes --user=shiori $ kubectl config use-context shiori@kubernetes ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 ServiceAccount ServiceAccount æ˜¯ Kubernetes ç®¡ç†çš„è´¦å·ï¼Œæä¾›ç»™ Pod é‡Œçš„è¿›ç¨‹ä½¿ç”¨ï¼Œä¸º Pod é‡Œçš„è¿›ç¨‹æä¾›èº«ä»½è¯æ˜ã€‚ Note ä¸€å®šè¦æ˜ç¡® ServiceAccount å¯¹ä¸ºäº† Pod ä¸­è¿›ç¨‹è€Œè®¾è®¡çš„ ä¸€ä¸ª ServiceAccount çš„åŸºæœ¬å®šä¹‰å¦‚ä¸‹ï¼š apiVersion:v1kind:ServiceAccountmetadata:name:local-storage-adminnamespace:kube-systemspec:automountServiceAccountToken:false spec.automountServiceAccountToken è¡¨æ˜ä¸è¿›è¡Œè‡ªåŠ¨åˆ›å»ºå¯¹åº” Secret å¯¹è±¡ 2.2.1 Service Account Atuh åœ¨ Pod ä¸­è®¿é—® Kubernetes APIServer æ—¶ï¼Œä¼šä½¿ç”¨ Kubernetes å†…ç½®çš„ HTTP Token è®¤è¯æ–¹å¼ Service Account Authã€‚ Note ä½¿ç”¨ HTTP Bearer Token çš„æ–¹å¼ å¯¹äº APIServer çš„è®¤è¯ï¼ŒPod å†…è¿›ç¨‹ä½¿ç”¨ä¸‹å‘çš„æ ¹è¯ä¹¦ï¼Œæ¥éªŒè¯ APIServer çš„è¯ä¹¦æ˜¯å¦åˆæ³•ã€‚ æ ¹è¯ä¹¦æ•°æ®æŒ‚è½½åˆ° Pod å†… /run/secrets/kubernetes.io/serviceaccount/ca.crtï¼Œå¯ä»¥çœ‹åˆ°å…¶å’Œ APIServer å¯åŠ¨ä½¿ç”¨çš„æ ¹è¯ä¹¦å†…å®¹æ˜¯ä¸€è‡´çš„ã€‚ $ cat /etc/kubernetes/pki/ca.crt $ kubectl exec -it ${POD} -c ${CONTAINER} -- cat /run/secrets/kubernetes.io/serviceaccount/ca.crt å¯¹äº Pod å†…è¿›ç¨‹çš„è®¤è¯ï¼Œé€šè¿‡ HTTP Header ä¸­çš„ Token å­—ç¬¦ä¸²æ•°æ®ï¼Œæ¥éªŒè¯ Pod å†…è¿›ç¨‹ã€‚ Token ä¸ºKubernetes Controller è¿›ç¨‹ç”¨ APIServer çš„ç§é’¥ï¼ˆâ€“service-account-private-key-file æŒ‡å®šï¼‰ç”Ÿæˆçš„ä¸€ä¸ª JWT Secretã€‚ æ•°æ®ä¼šæŒ‚è½½åˆ° Pod å†… /run/secrets/kubernetes.io/serviceaccount/token æ–‡ä»¶ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ ServiceAccount æ—¶æ¶‰åŠåˆ°çš„ Pod å†…çš„ä¸‰ä¸ªæ–‡ä»¶ï¼š /run/secrets/kubernetes.io/serviceaccount/ca.crt /run/secrets/kubernetes.io/serviceaccount/token /run/secrets/kubernetes.io/serviceaccount/namespaceï¼ˆClient ä½¿ç”¨è¯¥ namespace ä½œä¸ºè°ƒç”¨ API çš„å‚æ•°ï¼‰ $ kubectl exec -it ${POD} -c ${CONTAINER} -- ls /run/secrets/kubernetes.io/serviceaccount ca.crt namespace token 2.2.2 ServiceAccount ä¸ Secret å¯¹è±¡ ä¸Šè¿°çš„æ–‡ä»¶éƒ½æ˜¯ Kubernetes Secret å¯¹è±¡ä¼ é€’çš„ï¼Œå½“åˆ›å»ºä¸€ä¸ª ServiceAccount æ—¶ï¼Œè‡ªåŠ¨ä¼šåˆ›å»ºå¯¹åº”çš„ Secret å¯¹è±¡ã€‚è€Œ Secret å¯¹è±¡å°±åŒ…å«è¿™ä¸‰ä¸ªæ•°æ®ã€‚ $ kubectl get secrets NAME TYPE DATA AGE default-token-4l585 kubernetes.io/service-account-token 3 16d $ kubectl get secrets default-token-4l585 -o yaml apiVersion: v1 data: ca.crt: ... namespace: ... token: ... kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: a4d19cee-45e3-41ac-af66-ca8b070fa5d9 creationTimestamp: \"2021-06-16T09:25:37Z\" name: default-token-4l585 namespace: tidb-cluster-dev resourceVersion: \"3996078\" uid: a068d2ad-79b9-4b3c-be8c-c6e245c1865f type: kubernetes.io/service-account-token å¯ä»¥çœ‹åˆ°ï¼Œå¯¹åº”çš„ Secret å¯¹è±¡åä¸º \u003cservice_account\u003e-token-\u003crandom\u003eï¼Œtype ä¸º kubernetes.io/service-account-tokenã€‚Secret ä¸­ä¹Ÿé€šè¿‡ä¸¤ä¸ª annotations æ¥è¡¨æ˜å…¶æ‰€å±çš„ ServiceAccountã€‚ 2.2.3 ä½¿ç”¨ ServiceAccount Pod å®šä¹‰ä¸­é€šè¿‡ spec.serviceAccountName å¯ä»¥æŒ‡å®šä½¿ç”¨çš„ ServiceAccountï¼ˆé»˜è®¤ defaultï¼‰ã€‚ spec:# ...serviceAccountName:myserviceaccount æ¥ç€ï¼Œå¯¹åº”çš„æ–‡ä»¶å°±ä¼šè¢«æŒ‚è½½åˆ° Pod å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨ Client åº“æˆ–è€… HTTP è®¿é—®ç­‰æ–¹å¼ï¼Œå°±å¯ä»¥è®¿é—® APIServer äº†ï¼š $ TOKEN=$(cat token) \u0026\u0026 curl \"https://kubernetes.default/api/v1/namespaces/mycluster/pods/\" --cacert ./ca.crt -H \"Authorization: Bearer $TOKEN\" { \"kind\": \"PodList\", \"apiVersion\": \"v1\", \"metadata\": { \"resourceVersion\": \"1589287\" }, \"items\": [ // â€¦ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 Authentication APIServer å®‰å…¨çš„ç¬¬ä¸€æ­¥æ£€æŸ¥æ˜¯ Authenticationï¼Œç”¨äºéªŒè¯è¯·æ±‚çš„èº«ä»½ã€‚ ç›®å‰åŒ…å«ä»¥ä¸‹èº«ä»½éªŒè¯æ–¹å¼ï¼š X509 å®¢æˆ·è¯ä¹¦è®¤è¯ï¼šåŸºäº Kubernetes æ ¹è¯ä¹¦ç­¾åçš„åŒå‘è®¤è¯æ–¹å¼ HTTP Bearer Token è®¤è¯ï¼šé€šè¿‡ Bearer Token è¯†åˆ«åˆæ³•ç”¨æˆ· OpenID Connect Token ç¬¬ä¸‰æ–¹è®¤è¯ï¼šé€šè¿‡ç¬¬ä¸‰æ–¹ OIDC åè®®è¿›è¡Œè®¤è¯ Webhook Token è®¤è¯ï¼šé€šè¿‡å¤–éƒ¨ Webhook æœåŠ¡è¿›è¡Œè®¤è¯ Authenticating Proxy è®¤è¯ï¼šé€šè¿‡è®¤è¯ä»£ç†ç¨‹åºè¿›è¡Œè®¤è¯ å½“å¼€å¯äº†å¤šä¸ªèº«ä»½è®¤è¯æ¨¡å—æ—¶ï¼Œåªéœ€è¦ä»»ä¸€æ¨¡å—è®¤è¯é€šè¿‡ã€‚APISever ä¸ä¼šä¿è¯èº«ä»½è®¤è¯æ¨¡å—çš„è¿è¡Œé¡ºåºã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 X509 å®¢æˆ·è¯ä¹¦è®¤è¯ é€šè¿‡ APIServer å¯åŠ¨å‚æ•° \"â€“client-ca-file=SOMEFILE\"ï¼Œå¯ä»¥å¯åŠ¨å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯æ–¹å¼ã€‚å…¶å‚æ•°æŒ‡å®šäº†ç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„æ ¹è¯ä¹¦æ–‡ä»¶ã€‚ è¯ä¹¦éªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯è¯ä¹¦ä¸­ Subject Common Name ä¼šè¢«ç”¨ä½œè¯·æ±‚çš„ç”¨æˆ·åï¼Œç”¨äºåç»­çš„æˆæƒæ£€æŸ¥ã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 HTTP Bearer Token è®¤è¯ é€šè¿‡ APIServer å¯åŠ¨å‚æ•° \"â€“token-auth-file=SOMEFILE\"ï¼ŒæŒ‡å®šå…¶ä½¿ç”¨çš„é™æ€ Token æ–‡ä»¶ã€‚æ–‡ä»¶ä¸º CSV æ–‡æœ¬æ ¼å¼ï¼Œæ¯è¡Œå­—æ®µä¸ºï¼š # token,user,uid[,groupnames] 31ada4df-abedx-a11z-123z-124sgtszxvr3,join,2,\"group1,group2\" token - Token å­—ç¬¦ä¸² user - ç”¨æˆ·å uid - ç”¨æˆ· ID groupnames - ç”¨æˆ·ç»„ é€šè¿‡ HTTP è®¿é—® APIServer æ—¶ï¼Œå…¶ HTTP Header ä¸­ Token å­—æ®µæ¥è¡¨æ˜å®¢æˆ·èº«ä»½ã€‚APIServer é€šè¿‡è¯»å–è¯¥ Token æ¥ä¿å­˜çš„ Token ä¸­è¿›è¡ŒéªŒè¯ï¼Œå°±å¯ä»¥æ£€æŸ¥å…¶èº«ä»½ï¼Œå¹¶çŸ¥æ™“å¯¹åº”çš„ç”¨æˆ·äº†ã€‚ ServiceAccount ServiceAccount å°±æ˜¯ä½¿ç”¨ Bearer Token æ–¹å¼è®¤è¯ï¼Œåªæ˜¯å…¶ Token æ˜¯ç”± Kubernetes åŠ¨æ€ç”Ÿæˆçš„ã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.3 OpenID Connect Token ç¬¬ä¸‰æ–¹è®¤è¯ Kubernetes ä¹Ÿæ”¯æŒä½¿ç”¨ OpenID Conntect åè®®ï¼ˆç®€ç§° OIDCï¼‰ è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä¸è¿‡æ²¡æœ‰ä½¿ç”¨ OIDC çš„æƒé™ç®¡ç†ã€‚ ç”¨æˆ·é€šè¿‡ OIDC Sever å¾—åˆ°ä¸€ä¸ªåˆæ³•çš„ ID Tokenï¼Œè¯·æ±‚æ—¶ä¼ é€’ç»™ APIServerã€‚APIServer é€šè¿‡éªŒè¯è¯¥ Token æ˜¯å¦åˆæ³•æ¥éªŒè¯ç”¨æˆ·çš„èº«ä»½ã€‚ è¦ä½¿ç”¨ OIDC Token è®¤è¯æ–¹å¼ï¼ŒAPIServer éœ€è¦é…ç½®ä¸€äº›å‚æ•°ï¼Œè§ é…ç½® API æœåŠ¡å™¨ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.4 Webhook Token è®¤è¯ Kubernetes ä¹Ÿæ”¯æŒé€šè¿‡å¤–éƒ¨ Webhook è®¤è¯æœåŠ¡å™¨ï¼Œé…ç½® HTTP Bearer Token æ¥å®ç°è‡ªå®šä¹‰çš„ç”¨æˆ·èº«ä»½è®¤è¯åŠŸèƒ½ã€‚ å…¶å·¥ä½œæ­¥éª¤å¦‚ä¸‹ï¼š å¼€å¯å¹¶é…ç½® API Server çš„ Webhook Token Authentication åŠŸèƒ½ã€‚ APIServer æ¥å—åˆ°ä¸€ä¸ªéœ€è¦è®¤è¯çš„è¯·æ±‚åï¼Œä» HTTP Header ä¸­å–å‡º Token ä¿¡æ¯ï¼Œç„¶åå°†åŒ…å«è¯¥ Token çš„ TokenReview èµ„æºä»¥ HTTP POST æ–¹æ³•å‘é€åˆ°è¿œç¨‹ Webhook æœåŠ¡è¿›è¡Œè®¤è¯ã€‚ APIServer æ ¹æ® Webhook è¿”å›çš„ç»“æœåˆ¤æ–­æ˜¯å¦è®¤è¯æˆåŠŸã€‚ è¿œç«¯ Webhook æœåŠ¡å›å¤ä¹Ÿéœ€è¦æ˜¯ä¸€ä¸ª TokenReview èµ„æºå¯¹è±¡ï¼Œå¹¶ä¸” apiVersion è¦ä¸ APIServer å‘é€çš„ apiVersion ä¸€è‡´ã€‚ è¦ä½¿ç”¨ Webhook Token è®¤è¯æ–¹å¼ï¼ŒAPIServer éœ€è¦ä»¥ä¸‹å¯åŠ¨å‚æ•°ï¼š \"â€“authentication-token-webhook-config-file\": æŒ‡å‘ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°äº†å¦‚ä½•è®¿é—®è¿œç¨‹çš„ Webhook æœåŠ¡ \"â€“authentication-token-webhook-cache-ttl\": ç¼“å­˜ Webhook æœåŠ¡è¿”å›çš„ç»“æœçš„æ—¶é—´ï¼Œé»˜è®¤ä¸º 2min \"-authentication-token-webhook-version\": å‘é€ç»™ Webhook æœåŠ¡çš„ TokenReview èµ„æº API ç‰ˆæœ¬å·ï¼Œâ€œv1beta1â€ æˆ– â€œv1â€ é…ç½®æ–‡ä»¶ä½¿ç”¨ kubeconfig æ–‡ä»¶æ ¼å¼ï¼š apiVersion:v1kind:Configclusters:- name:name-of-remote-authn-servicecluster:certificate-authority:/path/to/ca.pem # ç”¨æ¥éªŒè¯è¿œç¨‹æœåŠ¡çš„ CAserver:https://authn.example.com/authenticate# è¦æŸ¥è¯¢çš„è¿œç¨‹æœåŠ¡ URLã€‚å¿…é¡»ä½¿ç”¨ 'https'ã€‚users:- name:name-of-api-serveruser:client-certificate:/path/to/cert.pem# Webhook æ’ä»¶è¦ä½¿ç”¨çš„è¯ä¹¦client-key:/path/to/key.pem # ä¸è¯ä¹¦åŒ¹é…çš„å¯†é’¥# kubeconfig Contextcurrent-context:webhookcontexts:- context:cluster:name-of-remote-authn-serviceuser:name-of-api-severname:webhook clusters: è®¾ç½® Webhook è¿œç¨‹æœåŠ¡ users: APIServer ä½¿ç”¨çš„ Webhook é…ç½® APIServer æ˜¯æ”¶åˆ°è¯·æ±‚ï¼Œæå–å‡º Token åï¼Œå°†å‘é€å¦‚ä¸‹ TokenReview èµ„æºå¯¹è±¡å¹¶å‘é€ã€‚ { \"apiVersion\": \"authentication.k8s.io/v1beta1\", \"kind\": \"TokenReview\", \"status\": { \"authenticated\": true, \"user\": { \"username\": \"janedoe@example.com\", \"uid\": \"42\", \"groups\": [ \"developers\", \"qa\" ], \"extra\": { \"extrafield1\": [ \"extravalue1\", \"extravalue2\" ] } } } } å›å¤ä¸­é€šè¿‡ status.authenticated å­—æ®µæ¥è¡¨æ˜æ˜¯å¦æˆæƒæˆåŠŸï¼š { \"apiVersion\": \"authentication.k8s.io/v1beta1\", \"kind\": \"TokenReview\", \"status\": { \"authenticated\": true, \"user\": { \"username\": \"janedoe@example.com\", \"uid\": \"42\", \"groups\": [ \"developers\", \"qa\" ], \"extra\": { \"extrafield1\": [ \"extravalue1\", \"extravalue2\" ] } } } } { \"apiVersion\": \"authentication.k8s.io/v1beta1\", \"kind\": \"TokenReview\", \"status\": { \"authenticated\": false } } ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.5 Authenticating Proxy APIServer å¯ä»¥é…ç½®ä¸ºä» HTTP Headerï¼ˆä¾‹å¦‚ X-Remote-Userï¼‰æ¥è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚ç”± Authenticating Proxy ç¨‹åºè®¾ç½® HTTP Header ç›¸å…³çš„å€¼ã€‚ é¦–å…ˆï¼ŒAuthenticating Proxy éœ€è¦å‘ APIServer é…ç½®å¯¹åº”çš„å®¢æˆ·ç«¯ CA è¯ä¹¦ï¼Œä¿è¯ Proxy èƒ½ä¸ APIServer è¿›è¡Œ HTTPS è¿æ¥ã€‚ é€šè¿‡ä»¥ä¸‹ APIServer å¯åŠ¨å‚æ•°é…ç½®ï¼š â€“requestheader-client-ca-file: Authenticating Proxy å®¢æˆ·ç«¯ CA è¯ä¹¦æ–‡ä»¶è·¯å¾„ â€“requestheader-allowed-names: ï¼ˆå¯é€‰ï¼‰è®¾ç½®å…è®¸çš„ Common Name åˆ—è¡¨ â€“requestheader-username-headers: è®¾ç½®ç”¨æˆ·åçš„ Headerï¼Œé€šå¸¸ä¸º â€œX-Remote-Userâ€ â€“requestheader-group-headersï¼š è®¾ç½®ç”¨æˆ·ç»„çš„ Headerï¼Œé€šå¸¸ä¸º â€œX-Remote-Groupâ€ â€“requestheader-extra-headers-prefix: Header å­—æ®µå‰ç¼€ç”¨äºç¡®å®šç”¨æˆ·ä¸€äº›å…¶ä»–ä¿¡æ¯ï¼Œé€šå¸¸ä¸º â€œX-Remote-Extra-â€ HTTPS è¿æ¥å»ºç«‹åï¼ŒAPIServer æ‰ä¼šæ ¡éªŒ HTTP Header ä¸­è®¾ç½®çš„ç”¨æˆ·åã€‚ä¸€ä¸ªè¯·æ±‚ç±»ä¼¼äºï¼š GET / HTTP/1.1 X-Remote-User: fido X-Remote-Group: dogs X-Remote-Group: dachshunds X-Remote-Extra-Acme.com%2Fproject: some-project X-Remote-Extra-Scopes: openid X-Remote-Extra-Scopes: profile ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.6 Anonymous Requests è¯·æ±‚ä¸­æ²¡æœ‰è¢«ä»»ä½•å·²é…ç½®çš„èº«ä»½è®¤è¯æ–¹æ³•æ‹’ç»ï¼Œé‚£ä¹ˆä¼šè¢«è§†ä¸º Anonymous Requestsã€‚è¿™ç±»è¯·æ±‚ä¼šè¢«è§†ä¸ºç”¨æˆ· system:anonymous å’Œ å¯¹åº”çš„ç”¨æˆ·ç»„ system:unauthenticatedã€‚ 1.6 ç‰ˆæœ¬åï¼Œå¦‚æœæ‰€ä½¿ç”¨çš„é‰´æƒæ¨¡å¼ä¸æ˜¯ AlwaysAllowï¼Œåˆ™åŒ¿åè®¿é—®é»˜è®¤æ˜¯è¢«å¯ç”¨çš„ã€‚å¯¹äºåŒ¿åè¯·æ±‚ï¼ŒABAC å’Œ RBAC è¦æ±‚å¿…é¡»ç»™å‡ºæ˜¾å¼çš„æƒé™åˆ¤å®šã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:6","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.7 User Impersonation ä¸€ä¸ªç”¨æˆ·å¯ä»¥é€šè¿‡ Impersonation Header æ¥ä»¥å¦ä¸€ä¸ªç”¨æˆ·èº«ä»½æ‰§è¡Œæ“ä½œã€‚ ç”¨æˆ·å‘èµ· API è¯·æ±‚ï¼Œæä¾›è‡ªèº«çš„è®¤è¯ï¼ŒåŒæ—¶æä¾›è¦ä¼ªè£…çš„å¤´éƒ¨å­—æ®µä¿¡æ¯ã€‚ APIServer å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½è®¤è¯ã€‚ APIServer ç¡®è®¤ç”¨æˆ·æœ‰ç€ä¼ªè£…çš„æƒé™ã€‚ è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯è¢«æ›¿æ¢ä¸ºä¼ªè£…çš„ç”¨æˆ·ä¿¡æ¯ã€‚ é’ˆå¯¹ä¼ªè£…çš„ç”¨æˆ·è¿›è¡ŒéªŒè¯ä¸æˆæƒç®¡ç†ã€‚ å¯ä»¥é€šè¿‡ä¸€ä¸‹ HTTP Header æ¥è¿›è¡Œä¼ªè£…ï¼š Impersonate-Userï¼šè¦ä¼ªè£…æˆçš„ç”¨æˆ·å Impersonate-Groupï¼šè¦ä¼ªè£…æˆçš„ç”¨æˆ·ç»„åã€‚å¯ä»¥å¤šæ¬¡æŒ‡å®šä»¥è®¾ç½®å¤šä¸ªç”¨æˆ·ç»„ Impersonate-Extra-\u003cé™„åŠ åç§°\u003eï¼šä¸€ä¸ªåŠ¨æ€çš„å¤´éƒ¨å­—æ®µï¼Œç”¨æ¥è®¾ç½®ä¸ç”¨æˆ·ç›¸å…³çš„é™„åŠ å­—æ®µ è¦ä¼ªè£…ä¸ºæŸä¸ªç”¨æˆ·æˆ–ç”¨æˆ·ç»„æ—¶ï¼Œéœ€è¦æœ‰ç€ â€œimpersonateâ€ æƒé™ï¼Œåˆ©ç”¨ RBAC è®¾ç½®å¯¹åº”çš„ Role å¦‚ä¸‹ï¼š apiVersion:rbac.authorization.k8s.io/v1kind:ClusterRolemetadata:name:impersonatorrules:- apiGroups:[\"\"]resources:[\"users\",\"groups\",\"serviceaccounts\"]verbs:[\"impersonate\"] ä½¿ç”¨ kubectl æ—¶ï¼Œå¯ä»¥é€šè¿‡ â€“as å‚æ•°è®¾ç½® Impersonate-Userï¼Œé€šè¿‡ â€“as-group å‚æ•°è®¾ç½® Impersonate-Groupã€‚ $ kubectl drain mynode --as=superman --as-group=system:masters ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:3:7","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 Authorization ç»è¿‡äº†èº«ä»½è®¤è¯åï¼ŒAPIServer å°±ä¼šè¿›è¡Œæˆæƒæ£€æŸ¥çš„æµç¨‹ï¼Œå³é€šè¿‡æˆæƒç­–ç•¥ï¼ˆAuthorization Policyï¼‰å†³å®šæ˜¯å¦æœ‰æƒé™è¿›è¡Œè°ƒç”¨ã€‚ APIServer ç›®å‰æœ‰ä»¥ä¸‹æˆæƒç­–ç•¥ï¼š AlwaysDeny: æ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œä»…ç”¨äºæµ‹è¯• AlwaysAllow: å…è®¸æ‰€æœ‰è¯·æ±‚ ABACï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ RBACï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ Webhookï¼šé€šè¿‡è°ƒç”¨å¤–éƒ¨çš„ REST æœåŠ¡å¯¹ç”¨æˆ·æˆæƒ Nodeï¼šå¯¹ kubelet è¿›è¡Œçš„æˆæƒçš„ç‰¹æƒæ¨¡å¼ é€šè¿‡ APIServer å¯åŠ¨å‚æ•° \"â€“authorization-mode\" é…ç½®å¤šç§æˆæƒç­–ç•¥ã€‚é»˜è®¤ä½¿ç”¨ Node ä¸ RBAC ç­–ç•¥ã€‚ --authorization-mode=Node,RBAC å½“ç³»ç»Ÿé…ç½®äº†å¤šä¸ªæˆæƒæ¨¡å¼æ—¶ï¼ŒKubernetes å°†æŒ‰é¡ºåºä½¿ç”¨æ¯ä¸ªæ¨¡å¼ã€‚ å¦‚æœä»»ä½•é‰´æƒæ¨¡å—æ‰¹å‡†æˆ–æ‹’ç»è¯·æ±‚ï¼Œåˆ™ç«‹å³è¿”å›è¯¥å†³å®šï¼Œå¹¶ä¸”ä¸ä¼šä¸å…¶ä»–æˆæƒæ¨¡å¼åå•†ã€‚ å¦‚æœæ‰€æœ‰æ¨¡å—å¯¹è¯·æ±‚æ²¡æœ‰æ„è§ï¼Œåˆ™æ‹’ç»è¯¥è¯·æ±‚ã€‚ å½“è¯·æ±‚è¢«æ‹’ç»æ—¶ï¼Œä¼šè¿”å› HTTP Code 403ã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 ABAC æˆæƒæ¨¡å¼ ABACï¼ˆAttribute-Based Access Controlï¼‰ æ˜¯åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ã€‚ 4.1.1 æˆæƒç­–ç•¥æ–‡ä»¶ é›†ç¾¤ç®¡ç†å‘˜é€šè¿‡å¯åŠ¨å‚æ•° \"â€“authorization-policy-file=SOME_FILENAME\" æŒ‡å®šæˆæƒç­–ç•¥æ–‡ä»¶çš„è·¯å¾„ã€‚ æˆæƒç­–ç•¥æ–‡ä»¶æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ª Map ç±»å‹ JSON å¯¹è±¡ï¼Œç§°ä¸º â€œç­–ç•¥å¯¹è±¡â€ã€‚ {\"apiVersion\": \"abac.authorization.kubernetes.io/v1beta1\", \"kind\": \"Policy\", \"spec\": {\"user\": \"alice\", \"namespace\": \"somenamespace\", \"resource\": \"*\", \"apiGroup\": \"*\"}} {\"apiVersion\": \"abac.authorization.kubernetes.io/v1beta1\", \"kind\": \"Policy\", \"spec\": {\"group\":\"system:authenticated\", \"nonResourcePath\": \"*\", \"readonly\": true}} apiVersionï¼šæœ‰æ•ˆå€¼ä¸º â€œabac.authorization.kubernetes.io/v1beta1â€ kind: æœ‰æ•ˆå€¼ä¸º â€œPolicyâ€ spec.user: ç”¨æˆ·åï¼Œæ¥è‡ªäº â€“token-auth-file æ–‡ä»¶ä¸­è®°å½•çš„ user spec.group: è®¾ç½®ä¸º â€œsystem:authenticatedâ€ æ—¶ï¼Œè¡¨ç¤ºåŒ¹é…æ‰€æœ‰å·²è®¤è¯è¯·æ±‚ï¼›è®¾ç½®ä¸º â€œsystem:unauthenticatedâ€ æ—¶ï¼Œè¡¨ç¤ºåŒ¹é…æ‰€æœ‰æœªè®¤è¯å»å“ªä¸ªåŒº spec.readonly: è¡¨æ˜ä»…ç”¨äº get list watch æ“ä½œ åŒ¹é…èµ„æº spec.apiGroup: è¡¨ç¤ºåŒ¹é…å“ªäº› API Group spec.namespace: è¡¨ç¤ºå…è®¸è®¿é—®å“ªä¸ª namespace ä¸‹çš„èµ„æº spec.resource: è¡¨æ˜è¦åŒ¹é…çš„ API èµ„æºå¯¹è±¡ åŒ¹é…éèµ„æº spec.nonResourcePath: å¦‚æœåŒ¹é…éèµ„æºï¼Œè¡¨æ˜è¦åŒ¹é…çš„è¯·æ±‚è·¯å¾„ 4.1.2 æˆæƒç®—æ³• APIServer æ”¶åˆ°è¯·æ±‚åï¼Œè¯†åˆ«å‡ºè¯·æ±‚çš„ç­–ç•¥å¯¹è±¡å±æ€§ã€‚ æ ¹æ®åœ¨ç­–ç•¥æ–‡ä»¶ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œé€æ¡è¿›è¡ŒåŒ¹é…ï¼Œä»¥åˆ¤æ–­æ˜¯å¦å…è®¸æˆæƒã€‚ å¦‚æœè‡³å°‘ä¸€æ¡æˆåŠŸï¼Œé‚£ä¹ˆå°±é€šè¿‡æˆæƒã€‚ 4.1.3 ç¤ºä¾‹ Alice å¯ä»¥å¯¹æ‰€æœ‰èµ„æºåšä»»ä½•äº‹æƒ…ï¼š {\"apiVersion\": \"abac.authorization.kubernetes.io/v1beta1\", \"kind\": \"Policy\", \"spec\": {\"user\": \"alice\", \"namespace\": \"*\", \"resource\": \"*\", \"apiGroup\": \"*\"}} Kubelet å¯ä»¥è¯»å†™äº‹ä»¶ï¼š {\"apiVersion\": \"abac.authorization.kubernetes.io/v1beta1\", \"kind\": \"Policy\", \"spec\": {\"user\": \"kubelet\", \"namespace\": \"*\", \"resource\": \"events\"}} ä»»ä½•äººéƒ½å¯ä»¥å¯¹æ‰€æœ‰éèµ„æºè·¯å¾„è¿›è¡Œåªè¯»è¯·æ±‚ï¼š {\"apiVersion\": \"abac.authorization.kubernetes.io/v1beta1\", \"kind\": \"Policy\", \"spec\": {\"group\": \"system:authenticated\", \"readonly\": true, \"nonResourcePath\": \"*\"}} {\"apiVersion\": \"abac.authorization.kubernetes.io/v1beta1\", \"kind\": \"Policy\", \"spec\": {\"group\": \"system:unauthenticated\", \"readonly\": true, \"nonResourcePath\": \"*\"}} 4.1.4 å¯¹ Service Account è¿›è¡Œæˆæƒ ServiceAccount ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª ABAC ç”¨æˆ·åï¼Œå‘½åè§„åˆ™å¦‚ä¸‹ï¼š system:serviceaccount:\u003cnamespace\u003e:\u003cserviceaccountname\u003e å› æ­¤ï¼Œå¯ä»¥é€šè¿‡ ABAC å¯¹æŸä¸ª ServiceAccount è¿›è¡Œè®¿é—®æ§åˆ¶ã€‚ä¾‹å¦‚å¸Œæœ› kube-system namespace ä¸­çš„ â€œdefaultâ€ æœ‰å…¨éƒ¨æƒé™ï¼Œä¿®æ”¹ç­–ç•¥æ–‡ä»¶: {\"apiVersion\":\"abac.authorization.kubernetes.io/v1beta1\",\"kind\":\"Policy\",\"spec\":{\"user\":\"system:serviceaccount:kube-system:default\",\"namespace\":\"*\",\"resource\":\"*\",\"apiGroup\":\"*\"}} å½“ç„¶ï¼Œéœ€è¦é‡å¯ APIServer æ¥é‡æ–°åŠ è½½ç­–ç•¥æ–‡ä»¶ã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 RBAC æˆæƒæ¨¡å¼ è§ K8s å­¦ä¹  - RBAC æˆæƒæœºåˆ¶ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.3 Webhook æˆæƒæ¨¡å¼ Webhook æ¨¡å¼ä½¿ç”¨å‚æ•° â€“authorization-webhook-config-file=SOME_FILE æ¥å¼€å¯ï¼Œæ–‡ä»¶ä¸º kubeconfig æ–‡ä»¶æ ¼å¼ã€‚ # Kubernetes API ç‰ˆæœ¬apiVersion:v1# API å¯¹è±¡ç§ç±»kind:Config# clusters ä»£è¡¨è¿œç¨‹æœåŠ¡ã€‚clusters:- name:name-of-remote-authz-servicecluster:# å¯¹è¿œç¨‹æœåŠ¡è¿›è¡Œèº«ä»½è®¤è¯çš„ CAã€‚certificate-authority:/path/to/ca.pem# è¿œç¨‹æœåŠ¡çš„æŸ¥è¯¢ URLã€‚å¿…é¡»ä½¿ç”¨ 'https'ã€‚server:https://authz.example.com/authorizeusers:- name:name-of-api-serveruser:client-certificate:/path/to/cert.pem# webhook plugin ä½¿ç”¨ certclient-key:/path/to/key.pem # cert æ‰€å¯¹åº”çš„ keycurrent-context:webhookcontexts:- context:cluster:name-of-remote-authz-serviceuser:name-of-api-servername:webhook user è®¾ç½®äº† API Server çš„é…ç½® cluster è®¾ç½®äº†è¿œç«¯ Webhook æœåŠ¡å™¨çš„é…ç½® 4.3.1 è¯·æ±‚ æˆæƒæ—¶ï¼ŒAPIServer ä¼šç”Ÿæˆä¸€ä¸ª SubjectAccessReview å¯¹è±¡ï¼Œé€šè¿‡ JSON æ ¼å¼ä»¥ HTTP POST å‘é€ç»™ Webhook æœåŠ¡å™¨ã€‚ SubjectAccessReview å¯¹è±¡ä¸­åŒ…å«äº†ç”¨æˆ·è®¿é—®èµ„æºè¯·æ±‚åŠ¨ä½œçš„æè¿°ï¼Œä»¥åŠè®¿é—®çš„èµ„æºä¿¡æ¯ã€‚ å¯¹äºèµ„æºçš„è®¿é—®è¯·æ±‚å¦‚ä¸‹ï¼š { \"apiVersion\": \"authorization.k8s.io/v1beta1\", \"kind\": \"SubjectAccessReview\", \"spec\": { \"resourceAttributes\": { \"namespace\": \"kittensandponies\", \"verb\": \"get\", \"group\": \"unicorn.example.org\", \"resource\": \"pods\" }, \"user\": \"jane\", \"group\": [ \"group1\", \"group2\" ] } } spec.resourceAttributes è¡¨æ˜è®¿é—®çš„èµ„æºçš„ï¼Œä»¥åŠè®¿é—®çš„æ“ä½œ spec.user è¯·æ±‚çš„ç”¨æˆ· spec.group è¯·æ±‚çš„ç”¨æˆ·ç»„ å¯¹äºéèµ„æºçš„è®¿é—®è¯·æ±‚å¦‚ä¸‹ï¼š { \"apiVersion\": \"authorization.k8s.io/v1beta1\", \"kind\": \"SubjectAccessReview\", \"spec\": { \"nonResourceAttributes\": { \"path\": \"/debug\", \"verb\": \"get\" }, \"user\": \"jane\", \"group\": [ \"group1\", \"group2\" ] } } spec.nonResourceAttributes å¯¹ API çš„è®¿é—®ä¸æ“ä½œ Note å› ä¸º apiVersion ä½¿ç”¨ â€œauthorization.k8s.io/v1beta1â€ï¼Œå› æ­¤ APIServer éœ€è¦å¼€å¯è¯¥ API Groupï¼ˆâ€“runtime-config=authorization.k8s.io/v1beta1=trueï¼‰ã€‚ 4.3.2 å›å¤ Webhook æœåŠ¡å™¨è¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ª SubjectAccessReview å¯¹è±¡ï¼Œä½†æ˜¯éœ€è¦è®¾ç½®å…¶ä¸­çš„ status å­—æ®µã€‚ å…è®¸è®¿é—®ï¼ˆallowed=trueï¼‰ { \"apiVersion\": \"authorization.k8s.io/v1beta1\", \"kind\": \"SubjectAccessReview\", \"status\": { \"allowed\": true } } ä¸å…è®¸è®¿é—®ï¼ˆallowed=falseï¼‰ï¼Œä½†æ˜¯å¦‚æœæœ‰å…¶ä»–æˆæƒè€…ï¼Œç»§ç»­å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œæˆæƒ { \"apiVersion\": \"authorization.k8s.io/v1beta1\", \"kind\": \"SubjectAccessReview\", \"status\": { \"allowed\": false, \"reason\": \"user does not have read access to the namespace\" } } ä¸å…è®¸è®¿é—®ï¼ˆallowed=falseï¼‰ï¼ŒåŒæ—¶ç«‹åˆ»æ‹’ç»å…¶ä»–æˆæƒè€…ï¼ˆdenied=trueï¼‰ { \"apiVersion\": \"authorization.k8s.io/v1beta1\", \"kind\": \"SubjectAccessReview\", \"status\": { \"allowed\": false, \"denied\": true, \"reason\": \"user does not have read access to the namespace\" } } ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.4 Node æˆæƒæ¨¡å¼ Node æˆæƒæ¨¡å¼ä»…ä»…é’ˆå¯¹ Subject ä¸º Nodeï¼Œä¸“é—¨å¯¹ kubelet å‘èµ·çš„ API è¯·æ±‚è¿›è¡Œæˆæƒçš„ç®¡ç†æ¨¡å¼ã€‚ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5 Admission Control ç»è¿‡èº«ä»½è®¤è¯ä¸æˆæƒåï¼Œè¯·æ±‚æœ€åè¿˜è¦é€šè¿‡ Admission Controlï¼ˆå‡†å…¥æ§åˆ¶ï¼‰ çš„æ§åˆ¶é“¾ã€‚ Admission Control æœ‰ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨çš„æ’ä»¶åˆ—è¡¨ï¼Œå‘é€ç»™ APIServer ä»»ä½•è¯·æ±‚éƒ½éœ€è¦ç»è¿‡åˆ—è¡¨ä¸­æ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨çš„æ£€æŸ¥ã€‚ä»»ä¸€ä¸€ä¸ªæ§åˆ¶å™¨æ£€æŸ¥ä¸é€šè¿‡ï¼Œé‚£ä¹ˆ APIServer å°±ä¼šæ‹’ç»æ¬¡è°ƒç”¨ã€‚ å‡†å…¥æ§åˆ¶å™¨è¿˜èƒ½å¤Ÿä¿®æ”¹è¯·æ±‚å‚æ•°ï¼Œæ¥å®ç°ä¸€äº›è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚ é€šè¿‡ APIServer å¯åŠ¨å‚æ•°ï¼Œå¯ä»¥é…ç½®å“ªäº›å‡†å…¥æ§åˆ¶å™¨å¯ç”¨ï¼Œå“ªäº›å‡†å…¥æ§åˆ¶å™¨å…³é—­ï¼š \"â€“enable-admission-plugins\" å‚æ•°é…ç½®å¼€å¯çš„å‡†å…¥æ§åˆ¶å™¨ï¼š kube-apiserver --enable-admission-plugins=NamespaceLifecycle,LimitRanger ... \"â€“disable-admission-plugins\" ç”¨ä»¥é…ç½®å…³é—­çš„å‡†å…¥æ§åˆ¶å™¨ï¼Œä»¥æ­¤å¯ä»¥å…³é—­é»˜è®¤å¼€å¯çš„å‡†å…¥æ§åˆ¶å™¨ï¼š kube-apiserver --disable-admission-plugins=PodNodeSelector,AlwaysDeny ... ç›®å‰ï¼ŒKubernetes å†…ç½®çš„å‡†å…¥æ§åˆ¶å™¨æœ‰ 30 å¤šä¸ªï¼Œè§ï¼šWhat does each admission controller do? ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.1 åŠ¨æ€å‡†å…¥æ§åˆ¶ é™¤äº†å†…ç½®çš„å‡†å…¥æ§åˆ¶å™¨ï¼Œå¯ä»¥é€šè¿‡ Webhook æ–¹å¼å¯¹æ¥å¤–éƒ¨çš„ Admission Webhook æœåŠ¡ã€‚ å¯ä»¥å°†å…¶åˆ†ä¸ºä¸¤ç±»ï¼š Mutating Admission Webhook: é’ˆå¯¹è¯·æ±‚å‚æ•°è¿›è¡Œä¿®æ”¹ Validating Admission Webhookï¼šé’ˆå¯¹è¯·æ±‚è¿›ç¨‹æ£€æŸ¥ å…·ä½“éƒ¨ç½²æ–¹å¼è§ï¼šåŠ¨æ€å‡†å…¥æ§åˆ¶ ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:5:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ å®˜æ–¹æ–‡æ¡£ï¼šç”¨æˆ·è®¤è¯ Blog: åŸºäº oAuth2 çš„ OIDC åŸç† å­¦ä¹ ç¬”è®° ","date":"2021-07-03","objectID":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 10 - API Server è®¤è¯","uri":"/posts/cloud_computing/k8s_learning/10-apiserver-auth/"},{"categories":["Golang"],"content":"Ginkgo åŸºæœ¬ç”¨æ³•","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"1 æ¦‚è¿° ginkgo æ˜¯ä¸€ä¸ª BDD æ¡†æ¶ï¼ŒKubernetes çš„ E2E æµ‹è¯•ä½¿ç”¨è¯¥æ¡†æ¶å®ç°é›†ç¾¤çš„æµ‹è¯•ã€‚ ginkgo æ˜¯é›†æˆåœ¨ Go æµ‹è¯•æ¡†æ¶çš„ï¼Œåœ¨ç›®å½•ä¸‹æ‰§è¡Œ ginkgo bootstrap å°±ä¼šæ„å»ºæµ‹è¯•çš„å…¥å£ï¼š package ginkgo_test import ( \"testing\" . \"github.com/onsi/ginkgo\" . \"github.com/onsi/gomega\" ) func TestGinkgo(t *testing.T) { // Gomega è¿æ¥ Ginkgo // ä½¿å¾— Gomega æ–­è¨€èƒ½å¤Ÿé€šçŸ¥åˆ° Ginkgo RegisterFailHandler(Fail) // æµ‹è¯•å…¥å£ RunSpecs(t, \"Ginkgo Suite\") } æ¥ç€ï¼Œæˆ‘ä»¬åœ¨åŒç›®å½•ä¸‹å¯ä»¥åˆ›å»ºæµ‹è¯• Specï¼Œç„¶åé€šè¿‡ ginkgo å’Œ go test å‘½ä»¤å°±å¯ä»¥æ‰§è¡Œæµ‹è¯•ã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:1:0","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"2 æ„å»º Spec 2.1 Describe Context It ä¸ºäº†æ›´å¥½çš„æ„å»ºæµ‹è¯•çš„ç»“æ„ï¼Œginkgo æä¾›äº†ä¸‰ä¸ªæ¥å£æ¥æ„å»ºæµ‹è¯•é¡¹çš„ç»“æ„ï¼š Describe: å®šä¹‰ä¸€ä¸ªæµ‹è¯•é¡¹ Context: å®šä¹‰ä¸€ä¸ªæµ‹è¯•é¡¹ä¸‹çš„ä¸€ç§æƒ…å†µ It: çœŸæ­£æ‰§è¡Œçš„æµ‹è¯•ä»£ç  ä»¥ä¸‹é¢ä¸ºä¾‹ï¼ŒDescribe å®šä¹‰äº†é¡¶å±‚çš„æµ‹è¯•é¡¹ä¸å…¶ä¸­ä¸€ä¸ªæ–¹é¢çš„æµ‹è¯•é¡¹ï¼Œä¸¤ä¸ª Context ä¸ºä¸¤ä¸ªæµ‹è¯•çš„æƒ…å†µï¼Œè€Œ It åŒ…å«äº†å…·ä½“çš„æµ‹è¯•ä»£ç ã€‚ // Root Describe var _ = Describe(\"Book\", func() { // Sub Describe Describe(\"Categorizing book length\", func() { // Context1 Context(\"With more than 300 pages\", func() { It(\"should be a novel\", func() { // æµ‹è¯•ä»£ç  + æ–­è¨€ }) }) // Context2 Context(\"With fewer than 300 pages\", func() { It(\"should be a short story\", func() { // æµ‹è¯•ä»£ç  + æ–­è¨€ }) }) }) }) Note ä¹Ÿå¯ä»¥ç®€å•çš„å°† Describe ä¸ Context ç†è§£ä¸ºå°†æµ‹è¯•åˆ†ç±»ï¼Œå¤ç”¨ä¸€äº›æè¿°æƒ…å†µã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:2:0","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"2.2 BeforeEach AfterEach BeforeEach ä¼šåœ¨æ¯ä¸ª It æ‰§è¡Œä¹‹å‰æ‰§è¡Œï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•è¿›è¡Œæ•°æ®çš„åˆå§‹åŒ–ã€‚ // Root Describe var _ = Describe(\"Book\", func() { var ( // é€šè¿‡é—­åŒ…åœ¨ BeforeEach å’Œ It ä¹‹é—´å…±äº«æ•°æ® longBook Book shortBook Book ) BeforeEach(func() { longBook = Book{ Title: \"Les Miserables\", Author: \"Victor Hugo\", Pages: 1488, } shortBook = Book{ Title: \"Fox In Socks\", Author: \"Dr. Seuss\", Pages: 24, } }) // Sub Describe Describe(\"Categorizing book length\", func() { // Context1 Context(\"With more than 300 pages\", func() { It(\"should be a novel\", func() { // æµ‹è¯•ä»£ç  + æ–­è¨€ }) }) // Context2 Context(\"With fewer than 300 pages\", func() { It(\"should be a short story\", func() { // æµ‹è¯•ä»£ç  + æ–­è¨€ }) }) }) }) ç›¸åï¼ŒAfterEach ä¼šåœ¨æ¯ä¸ª It æ‰§è¡Œå®Œæˆåæ‰§è¡Œï¼Œç”¨äºæ•°æ®çš„é”€æ¯ã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:2:1","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"2.3 JustBeforeEach JustAfterEach JustBeforeEach ä¼šåœ¨æ¯ä¸ª It æ‰§è¡Œä¹‹å‰æ‰§è¡Œï¼Œåœ¨å¯¹åº”çš„ BeforeEach ä¹‹åæ‰§è¡Œã€‚ JustBeforeEach å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†æŠ½è±¡å‡ºåˆå§‹åŒ–æ•°æ®çš„é€»è¾‘ï¼Œä½¿å¾—åªéœ€è¦ BeforeEach æä¾›åˆå§‹åŒ–æ•°æ®æ¥æºã€‚ ä¾‹å¦‚ä¸‹é¢ä¾‹å­ï¼Œè¿‡ JustBeforeEach å°±å¯ä»¥å°†åŸæ¥çš„ä¸¤æ¬¡ BeforeEach ä¸­çš„ NewBookFromJSON è°ƒç”¨ï¼Œå‡å°‘ä¸ºä¸€æ¬¡ã€‚ var _ = Describe(\"Book\", func() { var ( book Book err error json string ) BeforeEach(func() { // å‡†å¤‡æ•°æ® json = `{ \"title\":\"Les Miserables\", \"author\":\"Victor Hugo\", \"pages\":1488 }` }) JustBeforeEach(func() { // æ‰§è¡Œæ•°æ®æ„å»º book, err = NewBookFromJSON(json) }) Describe(\"loading from JSON\", func() { Context(\"when the JSON parses succesfully\", func() { }) Context(\"when the JSON fails to parse\", func() { BeforeEach(func() { // è¦†ç›–æ•°æ® json = `{ \"title\":\"Les Miserables\", \"author\":\"Victor Hugo\", \"pages\":1488oops }` }) }) }) }) å¯¹åº”çš„ï¼ŒJustAfterEach åœ¨æ¯ä¸ª It ä¹‹åè°ƒç”¨ï¼Œåœ¨ AfterEach ä¹‹å‰è°ƒç”¨ã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:2:2","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"2.4 BeforeSuite AfterSuite BeforeSuite ä¼šåœ¨æ‰€æœ‰çš„æµ‹è¯•æ‰§è¡Œå‰æ‰§è¡Œï¼ŒAfterSuite åœ¨æ‰€æœ‰çš„æµ‹è¯•æ‰§è¡Œåæ‰§è¡Œï¼š func TestBooks(t *testing.T) { RegisterFailHandler(Fail) RunSpecs(t, \"Books Suite\") } var _ = BeforeSuite(func() { dbClient = db.NewClient() err = dbClient.Connect(dbRunner.Address()) Expect(err).NotTo(HaveOccurred()) }) var _ = AfterSuite(func() { dbClient.Cleanup() }) ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:2:3","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"2.5 SynchronizedBeforeSuite SynchronizedAfterSuite SynchronizedBeforeSuite ç”¨äºæŒ‡å®šåœ¨ä¸»è¿›ç¨‹æ‰§è¡Œçš„å‡½æ•°ï¼Œä»¥åŠåœ¨å„ä¸ªå­è¿›ç¨‹æ‰§è¡Œçš„å‡½æ•°ã€‚å‡½æ•°éƒ½åœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰æ‰§è¡Œã€‚ Note å¦‚æœæ²¡æœ‰é€šè¿‡ \"â€“nodes \" æŒ‡å®šè¿›ç¨‹æ•°é‡ï¼Œé‚£ä¹ˆé»˜è®¤å°±æ˜¯ä¸€ä¸ªä¸»è¿›ç¨‹ï¼Œä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œæµ‹è¯•ã€‚ å› æ­¤ï¼ŒSynchronizedBeforeSuite/SynchronizedAfterSuite ç±»ä¼¼äº BeforeSuite/AfterSuite ä¼šè¢«æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢ç¤ºä¾‹åœ¨å­è¿›ç¨‹åˆ›å»ºå‰ï¼Œè¿è¡Œåˆ›å»ºæ•°æ®åº“ã€‚åœ¨å„ä¸ªå­è¿›ç¨‹è¿è¡Œæµ‹è¯•å‰ï¼Œæ‰§è¡Œåˆ›å»º clientã€‚ var _ = SynchronizedBeforeSuite(func() []byte { // åœ¨ä¸»è¿›ç¨‹ä¸­æ‰§è¡Œ port := 4000 + config.GinkgoConfig.ParallelNode dbRunner = db.NewRunner() err := dbRunner.Start(port) Expect(err).NotTo(HaveOccurred()) return []byte(dbRunner.Address()) }, func(data []byte) { // åœ¨æ¯ä¸ªå­è¿›ç¨‹ä¸­æ‰§è¡Œ dbAddress := string(data) dbClient = db.NewClient() err = dbClient.Connect(dbAddress) Expect(err).NotTo(HaveOccurred()) }) ç›¸åçš„ï¼Œé€šè¿‡ SynchronizedAfterSuite æ¥è¿›ç¨‹å›æ»šã€‚ var _ = SynchronizedAfterSuite(func() { // åœ¨æ¯ä¸ªå­è¿›ç¨‹ä¸­æ‰§è¡Œ dbClient.Cleanup() }, func() { // åœ¨ä¸»è¿›ç¨‹ä¸­æ‰§è¡Œ dbRunner.Stop() }) ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:2:4","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"2.6 By By å‡½æ•°ç”¨äºæ·»åŠ ä¸€äº›å—æ–‡æ¡£ï¼Œå¦‚æœæµ‹è¯•å¤±è´¥æ—¶ä¼šæ‰“å°å‡ºæ¥ã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºé”™è¯¯æ—¥å¿—ã€‚ var _ = Describe(\"Browsing the library\", func() { BeforeEach(func() { By(\"Fetching a token and logging in\") }) It(\"should be a pleasant experience\", func() { By(\"Entering an aisle\") }) }) ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:2:5","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"3 Spec Runner ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:3:0","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"3.1 Pending Spec å®šä¹‰ä¸€ä¸ª Spec æˆ–å®¹å™¨æ—¶ï¼Œè°ƒç”¨ P/X å‰ç¼€çš„æ¥å£ï¼Œä¼šå®šä¹‰ä¸€ä¸ª Pending Specã€‚é»˜è®¤ä¸ä¼šæ‰§è¡Œ PDescribe(\"some behavior\", func() { ... }) PContext(\"some scenario\", func() { ... }) PIt(\"some assertion\") PMeasure(\"some measurement\") XDescribe(\"some behavior\", func() { ... }) XContext(\"some scenario\", func() { ... }) XIt(\"some assertion\") XMeasure(\"some measurement\") é€šè¿‡å‘½ä»¤è¡Œå‚æ•° â€“noisyPendings=false å¯ä»¥å°†å…¶æ‰§è¡Œã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:3:1","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"3.2 Skiping Spec é€šè¿‡ Skip æ¥å£ï¼Œä½ å¯ä»¥åœ¨ä»£ç ä¸­è¿è¡Œæ—¶è·³è¿‡æŸä¸ª Specã€‚ It(\"should do something, if it can\", func() { if !someCondition { // è·³è¿‡æ­¤ Specï¼Œä¸éœ€è¦ Return è¯­å¥ Skip(\"special condition wasn't met\") } }) æˆ–è€…ï¼Œä½ å¯ä»¥é€šè¿‡ â€“skip= è·³è¿‡è¿è¡ŒåŒ¹é…çš„ Specã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:3:2","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"3.3 Focused Specs é€šè¿‡ F å‰ç¼€çš„æ¥å£ï¼Œå¯ä»¥é»˜è®¤ä»…ä»…æ‰§è¡Œ Focused Spec FDescribe(\"some behavior\", func() { ... }) FContext(\"some scenario\", func() { ... }) FIt(\"some assertion\", func() { ... }) æˆ–è€…ï¼Œä½ å¯ä»¥åœ¨æ‰§è¡Œå‘½ä»¤æ—¶é€šè¿‡ â€“focus= æŒ‡å®šè¿è¡Œ Specã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:3:3","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"3.3 Parallel Specs é»˜è®¤ä¸‹ï¼ŒGinkgo æ‰§è¡Œæµ‹è¯•æ˜¯ä¸²è¡Œçš„ï¼Œä½ å¯ä»¥é€šè¿‡ ginkgo -p å¼€å¯å¹¶è¡Œæµ‹è¯•ï¼ŒGinkgo ä¼šè‡ªåŠ¨åˆ›å»ºé€‚å½“æ•°é‡çš„è¿›ç¨‹æ¥å¹¶è¡Œæ‰§è¡Œã€‚é€šè¿‡ ginkgo -nodes=N ä¹Ÿå¯ä»¥æ‰§è¡Œè¿›ç¨‹æ•°é‡ã€‚ å¤šä¸ª go test å­è¿›ç¨‹ä¼šæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„ Spec å¹¶è¡Œæ‰§è¡Œã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:3:4","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"4 Gomega Gomega åº“æä¾›äº†æ–­è¨€çš„åŠŸèƒ½ï¼Œ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:4:0","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"4.1 æ–­è¨€ Î© ä¸ Expect éƒ½æä¾›æ–­è¨€çš„åŠŸèƒ½ï¼Œå®Œå…¨ç›¸åŒã€‚ é€šè¿‡ Should/To æ¥è¿›è¡Œ â€œåº”è¯¥â€ é€»è¾‘çš„æ–­è¨€ï¼Œé€šè¿‡ ShouldNot/NotTO/ToNot è¿›è¡Œ â€œä¸åº”è¯¥â€ é€»è¾‘çš„æ–­è¨€ã€‚ Expect(ACTUAL).Should(Equal(EXPECTED)) Expect(ACTUAL).To(Equal(EXPECTED)) Expect(ACTUAL).ShouldNot(Equal(EXPECTED)) Expect(ACTUAL).ToNot(Equal(EXPECTED)) Expect(ACTUAL).NoTo(Equal(EXPECTED)) Should ç­‰å‡½æ•°åè·Ÿç€ Matcher interface å˜é‡ï¼Œä»£è¡¨ä¸€ä¸ªè¡¨è¾¾å¼ã€‚ ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:4:1","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["Golang"],"content":"4.2 Matcher 4.2.1 åˆ¤æ–­ç±»å‹ä¸å€¼ç›¸ç­‰ Equal ä½¿ç”¨ reflect.DeepEqual è¿›è¡Œæ¯”è¾ƒã€‚ BeEquivalentTo ä¼šå…ˆå°† ACTUAL è½¬æ¢ä¸º EXPECTED çš„ç±»å‹ï¼Œç„¶åä½¿ç”¨ reflect.DeepEqual è¿›è¡Œæ¯”è¾ƒã€‚ Expect(ACTUAL).Should(Equal(EXPECTED)) Expect(ACTUAL).Should(BeEquivalentTo(EXPECTED)) 4.2.2 æ¥å£ç›¸å®¹ BeAssignableToTypeOf ä»…ä»…ç”¨äºåˆ¤æ–­èƒ½å¦å°† EXPECTED èµ‹å€¼ç»™ ACTUALã€‚å¸¸ç”¨äºåˆ¤æ–­ interface æ˜¯å¦æ»¡è¶³ã€‚ 4.2.3 ç©ºå€¼ä¸é›¶å€¼ BeNil åˆ¤æ–­æ˜¯å¦ä¸º nil BeZero åˆ¤æ–­æ˜¯å¦ä¸ºé›¶å€¼ Expect(ACTUAL).Should(BeNil()) Expect(ACTUAL).Should(BeZero()) 4.2.4 å¸ƒå°”å€¼ BeTrue åˆ¤æ–­ä¸º true BeFalse åˆ¤æ–­ä¸º false Expect(ACTUAL).Should(BeTrue()) Expect(ACTUAL).Should(BeFalse()) 4.2.5 error å¤„ç† HaveOccurred åˆ¤æ–­ error ä¸º nil Succeed åˆ¤æ–­ error ä¸ä¸º nil MatchError ä»¥åˆ¤æ–­ error æˆ–è€… string æ˜¯å¦ç›¸åŒ Expect(err).ShouldNot(HaveOccurred()) Expect(err).Should(Succeed()) Expect(err).Should(MatchError(\"an error\")) //asserts that err.Error() == \"an error\" Expect(err).Should(MatchError(SomeError)) //asserts that err == SomeError (via reflect.DeepEqual) 4.2.6 channel å¤„ç† BeClosed åˆ¤æ–­ channel å·²ç»å…³é—­ï¼Œä¼šè¯»å– channel æ•°æ®æ¥åˆ¤æ–­ Receive åˆ¤æ–­ channel ä¸­èƒ½å¦è¯»å–åˆ°æ•°æ® BeSent åˆ¤æ–­ channel èƒ½å¦æ— é˜»å¡å‘é€æ¶ˆæ¯ Expect(ch).Should(BeClosed()) Expect(ch).Should(Receive(\u003coptionalPointer\u003e)) Expect(ch).Should(BeSent(VALUE)) 4.2.7 æ–‡ä»¶å¤„ç† BeAnExistingFile åˆ¤æ–­æ–‡ä»¶/ç›®å½•æ˜¯å¦å­˜åœ¨ BeARegularFile åˆ¤æ–­æ˜¯å¦ä¸ºæ™®é€šæ–‡ä»¶ BeADirectory åˆ¤æ–­æ˜¯å¦ä¸ºç›®å½• Expect(ACTUAL).Should(BeAnExistingFile()) Expect(ACTUAL).Should(BeARegularFile()) Expect(ACTUAL).Should(BeADirectory()) 4.2.8 å­—ç¬¦ä¸²å¤„ç† ContainSubstring åˆ¤æ–­æ˜¯å¦åŒ…å«å­ä¸² HavePrefix åˆ¤æ–­æ˜¯å¦åŒ…å«å‰ç¼€ HaveSuffix åˆ¤æ–­æ˜¯å¦åŒ…å«åç¼€ MatchRegexp è¿›è¡Œæ­£åˆ™åŒ¹é… Expect(ACTUAL).Should(ContainSubstring(STRING, ARGS...)) Expect(ACTUAL).Should(HavePrefix(STRING, ARGS...)) Expect(ACTUAL).Should(HaveSuffix(STRING, ARGS...)) Expect(ACTUAL).Should(MatchRegexp(STRING, ARGS...)) 4.2.9 JSON/XML/YAML å¤„ç† MatchJSON åˆ¤æ–­ JSON æ˜¯å¦ç›¸åŒ MatchXML åˆ¤æ–­ XML æ˜¯å¦ç›¸åŒ MatchYAML åˆ¤æ–­ YAML æ˜¯å¦ç›¸åŒ 4.2.10 é›†åˆ string array map chan slice å¤„ç† BeEmpty åˆ¤æ–­ä¸ºç©º HaveLen åˆ¤æ–­é•¿åº¦ HaveCap åˆ¤æ–­å®¹é‡ ContainElement åˆ¤æ–­æ˜¯å¦åŒ…å«å…ƒç´  BeElementOf åˆ¤æ–­å€¼æ˜¯å¦åœ¨é›†åˆå…¶ä¸­ä¸€ä¸ª ConsistOf åˆ¤æ–­ä¸¤ä¸ªé›†åˆå…ƒç´ æ˜¯å¦ç›¸åŒï¼Œä¸è€ƒè™‘é¡ºåº HaveKey åˆ¤æ–­ map æ˜¯å¦åŒ…å«æŒ‡å®šçš„ key HaveKeyWithValue åˆ¤æ–­ map æ˜¯å¦åŒ…å«æŒ‡å®šçš„ key/value ints := []int{1, 2, 3} m := map[string]string{} Expect(ints).Should(BeEmpty()) Expect(ints).Should(HaveLen(1)) Expect(ints).Should(HaveCap(2)) Expect(ints).Should(ContainElement(3)) Expect(1).Should(BeElementOf(ints) Expect(ints).Should(ConsistOf(1, 2, 3)) Expect(ints).Should(ConsistOf([]int{3, 2, 1})) Expect(m).Should(HaveKey(\"a\")) Expect(m).Should(HaveKeyWithValue(\"a\", \"b\")) 4.2.11 æ•°å­—/æ—¶é—´å¤„ç† BeNumerically è¿›è¡Œæ•°å€¼çš„æ¯”è¾ƒï¼ŒåŒ…å«ä»¥ä¸‹è¿ç®—ç¬¦: == åˆ¤æ–­æ•°å€¼æ˜¯å¦ç›¸ç­‰ ~ åˆ¤æ–­æ•°å€¼æ˜¯å¦ç›¸ä¼¼ï¼ˆä¸€å®šèŒƒå›´å†…ï¼‰ \u003e \u003e= \u003c \u003c= æ¯”è¾ƒå¤§å° BeBetween åˆ¤æ–­æ˜¯å¦åœ¨èŒƒå›´å†… BeTemporally è¿›è¡Œ time.Time ç±»å‹æ¯”è¾ƒï¼Œæ–¹å¼ä¸ BeNumerically ç›¸åŒ a := 1 b := 2 Expect(a).Should(BeNumerically(\"==\", b)) Expect(a).Should(BeNumerically(\"~\", b, 1)) Expect(a).Should(BeNumerically(\"\u003e\", b)) Expect(a).Should(BeNumerically(\"\u003e=\", b)) Expect(a).Should(BeNumerically(\"\u003c\", b)) Expect(a).Should(BeNumerically(\"\u003c=\", b)) Expect(a).Should(BeBetween(0, 10)) 4.2.12 panic Panic åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¼šå‘ç”Ÿ panic Expect(func(){}).Should(Panic()) 4.2.13 é€»è¾‘ç»„åˆ SatisfyAll/And è¿›è¡Œé€»è¾‘ä¸çš„ç»„åˆ SatisfyAny/Or è¿›è¡Œé€»è¾‘æˆ–çš„ç»„åˆ Expect(msg).To(And(Equal(\"Success\"), MatchRegexp(`^Error .+$`))) Expect(msg).To(Or(Equal(\"Success\"), MatchRegexp(`^Error .+$`))) ","date":"2021-06-27","objectID":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/:4:2","tags":["Test"],"title":"Ginkgo å­¦ä¹ ","uri":"/posts/language/golang/ginkgo-%E5%AD%A6%E4%B9%A0/"},{"categories":["AWS å­¦ä¹ "],"content":"VPC åŸºæœ¬æ¦‚å¿µï¼ŒåŒ…æ‹¬ï¼šVPCã€Subnetã€ENIã€ACLã€Security Group ç­‰","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"1 VPC ä¸ Subnet äº‘ä¸Šçš„ç½‘ç»œæ˜¯ç”± VPCVirtual Private Cloud ä¸ Subnet ç»„æˆçš„ï¼š VPC æ˜¯é’ˆå¯¹ Region çº§åˆ«ï¼Œå…¶ç”±ä¸€ä¸ª CIDR Block æ¥æŒ‡å®š IP åœ°å€èŒƒå›´ã€‚ Subnet æ˜¯ VPC ç½‘æ®µçš„å­ç½‘ï¼ŒAZ çº§åˆ«èµ„æºï¼ˆæ— æ³•è·¨ AZ è¦†ç›–ï¼‰ã€‚ EC2 Instance å¯åŠ¨ä¼šåŠ å…¥ä¸€ä¸ª Subnetï¼Œè¿™æ ·æ‰èƒ½å®Œæˆç½‘ç»œçš„è¿æ¥ã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"1.1 Default ä¸ Nondefault å¯¹äºæ¯ä¸ª Regionï¼Œéƒ½ä¼šè‡ªåŠ¨ä¸ºè´¦æˆ·åˆ›å»ºä¸€ä¸ª Default VPCã€‚Default VPC é»˜è®¤åŒ…å«ä¸€ä¸‹èµ„æºï¼š Internet Gateway Default Network ACL æ¯ä¸ª AZ ä¸€ä¸ª Default Subnet å½“å¯åŠ¨ Instance æ²¡æœ‰æŒ‡å®š VPC æ—¶ï¼Œå°±ä¼šé»˜è®¤ä½¿ç”¨ Default VPC ä¸ Default Subnetã€‚ ç›¸åï¼Œæ‰‹åŠ¨åˆ›å»ºçš„ VPC ä¸ Subnet éƒ½ç§°ä¸º Nondefault VPC æˆ–è€… Nondefault Subnetã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:1:1","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"1.2 Public ä¸ Private èƒ½å¤Ÿè¿æ¥ Internet Gateway çš„ Subnet ç§°ä¸º Public Subnetã€‚åä¹‹å°±ç§°ä¹‹ä¸º Private Subnetã€‚ åŒæ ·ï¼Œå¦‚æœ VPC æµé‡å¯ä»¥è½¬å‘åˆ° Internet Gatewayï¼Œè¡¨æ˜å¯ä»¥è¿æ¥åˆ°å¤–ç½‘ï¼Œç§°ä¸º Public VPCã€‚åä¹‹ï¼Œæµé‡æ— æ³•é€šå‘å¤–ç½‘ï¼Œç§°ä¸º Private VPCã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:1:2","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"2 IP ç±»å‹ Private IP - VPC èŒƒå›´å†…çš„å†…ç½‘ IPã€‚ Instance æ“ä½œç³»ç»Ÿå±‚é¢èƒ½å¤Ÿçœ‹åˆ°çš„éƒ½æ˜¯ Private IPï¼ŒPublic IP å¦‚è¦ä» AWS æœåŠ¡ä¸­è¯»å–ã€‚ Public IP - â€œä¸´æ—¶â€çš„å…¬ç½‘ IPï¼ŒInstance é‡å¯åé‡æ–°åˆ†é…ã€‚ å¦‚æœ Subnet é…ç½®äº† â€œAuto-assign public IPv4 addressâ€ åŠŸèƒ½ï¼Œæˆ–è€…åˆ›å»º Instance æ—¶æŒ‡å®šï¼Œé‚£ä¹ˆ Instance ä¼šç»‘å®š Public IPã€‚ Elastic IP - å›ºå®šç”Ÿå‘½å‘¨æœŸçš„å…¬ç½‘ IP Elastic IP ç‹¬ç«‹äº Instanceï¼Œé€šè¿‡ç»‘å®šä¸è§£ç»‘ä¸ Instance è¿›è¡Œäº¤äº’ã€‚ å¦‚æœ VPC æœ‰ç€ IPv6 åœ°å€èŒƒå›´ï¼Œé‚£ä¹ˆ Instance èƒ½å¤Ÿè¢«åˆ†é… IPv6 åœ°å€ï¼Œä¹Ÿæ˜¯å…¬ç½‘ IPv6 åœ°å€ã€‚ Tip ä¸‹é¢æ‰€è¯´çš„ IP éƒ½æ˜¯æŒ‡ IPv4ï¼ŒIPv6 ä¼šæ˜¾å¼è¯´æ˜ã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"3 Route Table VPC å†…çš„è·¯ç”±è§„åˆ™éƒ½æ˜¯ç”± Route Table æ§åˆ¶ã€‚ Main Route Table - VPC åˆ›å»ºåé»˜è®¤åˆ›å»ºçš„å…¨å±€è·¯ç”±è¡¨ï¼Œæ‰€æœ‰æœªç»‘å®š Route Table çš„ Subnet é»˜è®¤ä¼šä½¿ç”¨ Main Route Table Custom Route Table - è‡ªå®šä¹‰çš„ Route Table å¦‚æœä¸€ä¸ª Subnet ç»‘å®šäº† Custom Route Tableï¼Œé‚£ä¹ˆè¿›å‡ºçš„æµé‡å°±ç”±è¯¥è·¯ç”±è¡¨æ§åˆ¶ï¼Œå¦åˆ™å°±ç”± Main Route Table æ§åˆ¶äº†ã€‚ æŒ‰ç…§ Route Table å…³è”çš„å¯¹è±¡ä¸åŒï¼Œåˆåˆ†ä¸ºï¼š Subnet Route Table ï¼šå…³è”åˆ° Subnet Gateway Route Table ï¼šå…³è”åˆ° Internet Gateway Local Gateway Route Table ï¼šå…³è”åˆ° Local Gateway ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"3.1 Route Rule Route Table ç”±å¤šä¸ª Route Rule ç»„æˆã€‚ Destination Target Status Propagated 172.31.0.0/16 local Active No 0.0.0.0/0 igw-3518715d Active No Destination ï¼šè¦åŒ¹é…æµé‡çš„ç›®çš„åœ°å€èŒƒå›´ï¼ŒåŒ…æ‹¬ 0.0.0.0/0 ï¼šCIDR åœ°å€èŒƒå›´ pl-id ï¼šPrefix Lists Target ï¼šè½¬å‘çš„ç›®æ ‡ï¼ŒåŒ…æ‹¬ æ ¼å¼ ç›®æ ‡ local Subnet å†…éƒ¨ igw-id Internet Gateway nat-gateway-id NAT Device vgw-id Virtual Private Gateway lgw-id Outposts Local Gateway cagw-id Carrier Gateway pcx-id VPC Peering Connection eigw-id Egress-only Internet Gateway tgw-id Transit Gateway eni-id Network Interface vpce-id Gateway Endpoint vpc-endpoint-id VPC Endpointï¼ˆç½‘å…³è·¯ç”±è¡¨ä½¿ç”¨ï¼‰ Propagated ï¼šæ˜¯å¦å…è®¸ Virtual Private Gateway å°†è·¯ç”±ä¼ æ’­åˆ° Route Table Route Tableï¼Ÿ å¯ä»¥å‘ç°ï¼Œå¹¶ä¸æ”¯æŒæŒ‡å®šåœ°å€æˆ–è€…æŒ‡å®š Subnet çš„è·¯ç”±ï¼Œå› ä¸º VPC ä¸‹é»˜è®¤æ‰€æœ‰ Subnet ä¹‹é—´éƒ½æ˜¯äº’é€šçš„ã€‚ ä¸ºæ­¤ï¼Œå¯ä»¥ç†è§£ä¸º Route Table æ˜¯ç”¨äº Subnet å†…å°†æµé‡è·¯ç”±åˆ° AWS èµ„æºçš„ã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:3:1","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"4 Elastic Network Interface ENIElastic Network Interface æ˜¯ VPC ç½‘ç»œä¸­çš„è™šæ‹Ÿç½‘å¡ã€‚æ— è®º Private IP è¿˜æ˜¯ Public IPï¼Œå…¶éƒ½æ˜¯å°†å…¶ç»‘å®šåˆ° ENI ä¸Šçš„ã€‚ ENI åŒ…å«ä»¥ä¸‹å±æ€§ï¼š ä¸€ä¸ªæˆ–å¤šä¸ª Private IP ä¸€ä¸ªæˆ–å¤šä¸ª Public/Elastic IPï¼Œæ¯ä¸ª Public IP éƒ½è¦å¯¹åº”ä¸€ä¸ª Private IP ä¸€ä¸ªæˆ–å¤šä¸ª IPv6 åœ°å€ MAC åœ°å€ ä¸€ä¸ªæˆ–å¤šä¸ª Security Group æ¯ä¸ª Instance çš„ç¬¬ä¸€ä¸ª ENI ç§°ä¸º Primary Network Interfaceï¼Œå¯ä»¥æ¥è‡ªäºï¼š è‡ªåŠ¨åˆ›å»º - Instance åˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»ºçš„ ENI æŒ‡å®š - Instance åˆ›å»ºæ—¶æŒ‡å®šå·²ç»å­˜åœ¨çš„ ENI ä½œä¸º Primary ENI æ¯ä¸ª Instance å¯ä»¥è¢«é™„åŠ ä¸Šå¤šä¸ª ENIï¼Œå…¶æ•°é‡ä¸Šé™å–å†³ä¸ Instance ç±»å‹ï¼Œå…·ä½“è§ æ–‡æ¡£ã€‚ Note å¤§å¤šæ•°æƒ…å†µåœ¨æè¿° IP ä¸ Security Group æ—¶éƒ½æ˜¯ç›´æ¥è¯´ Instance æ—¶ï¼Œè€Œä¼šå¿½ç•¥ ENIã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:4:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"5 Security Group Security Group ç”¨äºå®šä¹‰è¿›å‡º ENI æ•°æ®åŒ…çš„ç™½åå•ã€‚åˆ†ä¸º Inbound rules ä¸ Outbound rulesã€‚ Inbound rules - å…¥ ENI æ•°æ®åŒ…çš„ç™½åå•ã€‚ é»˜è®¤è§„åˆ™ä¸ºæ‹’ç»æ‰€æœ‰ä¸»åŠ¨è®¿é—®æµé‡ã€‚éœ€è¦é€šè¿‡é…ç½® Inbound rules æ¥ä¸€ä¸ªä¸ªæ‰“å¼€é…ç½®ã€‚ Outbound rules - å‡º ENI æ•°æ®åŒ…çš„ç™½åå•ã€‚ é»˜è®¤è§„åˆ™ä¸ºå…è®¸æ‰€æœ‰å‡ºçš„æµé‡ã€‚ä¸€æ—¦é…ç½®äº†è§„åˆ™äº†ï¼Œé»˜è®¤ä¼šä¸ºæ‹’ç»æ‰€æœ‰å‡ºçš„æµé‡ã€‚ ä¸€ä¸ª Rule ç±»ä¼¼äºï¼š Type Protocol Port Range Destination/Source Description SSH TCP 22 0.0.0.0/0 Allow SSH Type ï¼šå¸¸ç”¨çš„ç«¯å£ï¼Œæˆ–è€…è‡ªå·±é…ç½® Protocol ï¼šåè®®ï¼ŒTCP/UDP/ICMP Port Range ï¼šå…è®¸çš„ç«¯å£èŒƒå›´ï¼ŒALL è¡¨ç¤ºå…¨éƒ¨ç«¯å£ Destination/Source ï¼šåŒ¹é…æµé‡çš„ ç›®çš„/æº åœ°å€èŒƒå›´ å¯¹äº Inbound Rule å°±æ˜¯ Sourceï¼Œå¯¹äº Outbound Rule å°±æ˜¯ Destination ç‰¹åˆ«çš„æ³¨æ„ï¼ŒSecurity Group æ˜¯æœ‰çŠ¶æ€çš„ï¼š å¯¹äº Outbound æµé‡ï¼Œè‡ªåŠ¨å…è®¸å¯¹åº”çš„ Inbound æµé‡ å¯¹äº Inbound æµé‡ï¼Œè‡ªåŠ¨å…è®¸å¯¹åº”çš„ Outbound æµé‡ \"å¯¹åº”çš„\"æ„æ€ æ‰€æœ‰ â€œå¯¹åº”â€ å°±æ˜¯æŒ‡ Source IP/Port ä¸ Destination IP/Port ç›¸åã€‚ç±»ä¼¼äºç«¯å£é™åˆ¶å‹çš„ NATã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:5:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"6 Network ACL Network ACL ç”¨äºæ§åˆ¶å‡ºå…¥ Subnet çš„æµé‡ï¼Œä¹Ÿåˆ†ä¸º Inbound rules ä¸ Outbound rulesã€‚ Inbound rules - å…¥ Subnet æ•°æ®åŒ…çš„è¿‡æ»¤è§„åˆ™ï¼Œæ”¯æŒ Allow ä¸ Deny è§„åˆ™ã€‚ Outbound rules - å‡º Subnet æ•°æ®åŒ…çš„è¿‡æ»¤è§„åˆ™ï¼Œæ”¯æŒ Allow ä¸ Deny è§„åˆ™ã€‚ å½“åˆ›å»º VPC æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤ ACLï¼Œè€Œç”¨æˆ·å¯ä»¥è‡ªå·±åˆ›å»º ACL å¹¶ç»‘å®šåˆ° Subnet ä¸Šã€‚ é»˜è®¤ ACL - VPC åˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»ºï¼Œé»˜è®¤å…è®¸æ‰€æœ‰å‡ºå…¥æµé‡ã€‚ æœªç»‘å®š ACL çš„ Subnet è‡ªåŠ¨å…³è”åˆ°é»˜è®¤ ACLã€‚ è‡ªå®šä¹‰ ACL - ç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºçš„ ACLï¼Œé»˜è®¤æ‹’ç»æ‰€æœ‰å‡ºå…¥æµé‡ã€‚ ä¸ Security Group ä¸åŒï¼ŒNetwork ACL æ˜¯æ— çŠ¶æ€çš„ï¼Œå‡ºå…¥æ•°æ®åŒ…éƒ½ä¼šå®Œå…¨ç»è¿‡ Inbound/Outbound rules çš„è¿‡æ»¤ã€‚ Network ACL çš„ Rule ç±»ä¼¼äºï¼š Rule Number Type Protocol Port Range Destination/Source Allow/Deny 100 Custome TCP TCP 123 0.0.0.0/0 Allow * All traffic All All 0.0.0.0/0 Deny Rule Number ï¼šè§„åˆ™çš„ç¼–å· Type ï¼šå¸¸ç”¨çš„ç«¯å£æˆ–è€…è‡ªå®šä¹‰ Protocol ï¼šä¼ è¾“å±‚åè®® Port Range ï¼šåŒ¹é…çš„ç«¯å£èŒƒå›´ Destination/Source ï¼šåŒ¹é…çš„ ç›®çš„/æº åœ°å€èŒƒå›´ï¼Œå¯¹äº Inbound Rule å°±æ˜¯ Sourceï¼Œå¯¹äº Outbound å°±æ˜¯ Destination Allow/Deny ï¼šå…è®¸è¿˜æ˜¯ç¦æ­¢ åŒ¹é…æµé‡æ—¶ï¼Œä¼šæŒ‰ç…§ Rule Number ä»å°åˆ°å¤§çš„é¡ºåºè¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸ŠæŸä¸€æ¡ Rule ï¼ˆæ— è®º Allow æˆ– Denyï¼‰å°±ä¸å†åŒ¹é…å…¶ä»–çš„ Rule äº†ã€‚ é¢„ç•™ Rule Number å»ºè®®ä»¥ 100 é—´éš”æ¥æ·»åŠ  Ruleï¼Œä¸ºä¸­é—´é¢„ç•™å¯æ’å…¥çš„ç¼–å·ã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:6:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"5 VPC ä¸­çš„ DNS å¯¹æ¯ä¸ª VPC ä¼šæœ‰ä¸€ä¸ª Route 53 Resolver ä½œä¸º DNS æœåŠ¡å™¨ï¼Œä¼šæ¯ä¸ª Instance çš„æ¯ä¸ª IP åœ°å€ï¼ˆä¸åŒ…æ‹¬ IPv6ï¼‰æä¾› DNS ä¸»æœºåï¼ŒåŒ…æ‹¬å†…ç½‘ IP ä¸å…¬ç½‘ IPã€‚ Private DNS ä¸»æœºåæ”¯æŒåŒ VPC è§£æåˆ°å¯¹åº”çš„ IPï¼Œæ ¼å¼ä¸ºï¼š å¯¹äº Region us-east-1ï¼Œæ ¼å¼ä¸º ip-\u003cprivate_ip\u003e.ec2.internal å…¶ä»– Region å½¢å¼ä¸º ip\u003cprivate_ip\u003e.\u003cregion\u003e.compute.internal Public DNS ä¸»æœºåæ”¯æŒå¤–ç½‘è®¿é—®ï¼Œæ ¼å¼ä¸ºï¼š å¯¹äº Region us-east-1ï¼Œæ ¼å¼ä¸º ec2-\u003cpublic-ip\u003e.compute-1.amazonaws.com å…¶ä»– Region æ ¼å¼ä¸º ec2-\u003cpublic-ip\u003e.region.compute.amazonaws.com å…³é—­ DNS è§£æ å¯ä»¥é€šè¿‡è®¾ç½® VPC çš„ enableDnsSupport å±æ€§æ¥å…³é—­ DNS è§£æåŠŸèƒ½ï¼Œé€šè¿‡è®¾ç½® VPC çš„ enableDnsHostnames å±æ€§æ¥ä¸ä¸º Public IP æä¾› DNS ä¸»æœºåã€‚ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:7:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"å‚è€ƒ VPC å®˜æ–¹æ–‡æ¡£ ","date":"2021-06-25","objectID":"/posts/cloud_computing/aws_learning/3-vpc/:8:0","tags":["aws"],"title":"AWS å­¦ä¹  - 3 - VPC åŸºæœ¬æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/3-vpc/"},{"categories":["AWS å­¦ä¹ "],"content":"Regionã€AZã€DC","date":"2021-06-23","objectID":"/posts/cloud_computing/aws_learning/1-introduction/","tags":["aws"],"title":"AWS å­¦ä¹  - 1 - åœ°ç†æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/1-introduction/"},{"categories":["AWS å­¦ä¹ "],"content":"1 Region å°†æ‰€æœ‰çš„èµ„æºéƒ½æ”¾åœ¨ä¸€ä¸ª Data Centerï¼ˆç®€ç§° DCï¼‰ä¸èƒ½ä¿è¯å¯ç”¨æ€§ï¼Œå¦‚æœè¯¥æ•°æ®ä¸­å¿ƒå‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆæ„å‘³æ‰€æœ‰çš„åº”ç”¨ç¨‹åºå‡ºç°é—®é¢˜ã€‚ ä¸ºæ­¤ï¼ŒAWS åœ¨ä¸–ç•Œå„åœ°ä¸åŒåœ°æ–¹æ„å»ºäº†è®¸å¤šçš„ DCï¼Œæ¯ä¸ªåœ°æ–¹ç§°ä¸º Regionã€‚ä¾‹å¦‚ us-westã€us-eastã€eu-west ç­‰ã€‚ æ‰€æœ‰ Region ä¹‹é—´çš„ç½‘ç»œæ˜¯å¯ä»¥è¿é€šçš„ï¼Œä½†æ˜¯é»˜è®¤ä¸‹ Region ä¹‹é—´ç½‘ç»œæ˜¯éš”ç¦»çš„ã€‚è¯¥ç‰¹æ€§æ˜¯ä¸ºäº†æ•°æ®å¤„ç†çš„åˆæ³•åˆè§„ã€‚ åœ¨å­¦ä¹ ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯çŸ¥æ™“æ˜¯ Regionalï¼Œè¿˜æ˜¯ Zonalã€‚ä¸€ä¸ª Regional Service è¡¨æ˜æ˜¯å…¶ Region ä¸‹æ‰€æœ‰ AZ å…±äº«çš„ï¼Œç”± AWS ä¿è¯äº† Service çš„é«˜å¯ç”¨ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/aws_learning/1-introduction/:1:0","tags":["aws"],"title":"AWS å­¦ä¹  - 1 - åœ°ç†æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/1-introduction/"},{"categories":["AWS å­¦ä¹ "],"content":"2 Available Zone Region ç”±ä¸€ç»„ Available Zoneï¼ˆç®€ç§° AZï¼‰ï¼ŒAZ è¡¨ç¤ºä¸€ä¸ªæˆ–ä¸€ç»„åˆ†ç¦»çš„ DCã€‚ä¾‹å¦‚ us-west-1ã€us-west-2 ç­‰ã€‚ ä¸€ä¸ª Region ä¸‹çš„å¤šä¸ª AZ ä¹‹é—´ç›¸éš”æ•°åè‹±é‡Œï¼Œè¯¥è·ç¦»ä¿è¯å¤šä¸ª AZ ä¹‹é—´é€šä¿¡è¿˜æ˜¯ä½å»¶æ—¶çš„ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/aws_learning/1-introduction/:2:0","tags":["aws"],"title":"AWS å­¦ä¹  - 1 - åœ°ç†æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/1-introduction/"},{"categories":["AWS å­¦ä¹ "],"content":"3 Region AZ DC ä¹‹é—´å…³ç³» ä¸‰è€…ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š ä¸€ä¸ª Region åŒ…å«å¤šä¸ª AZï¼Œå„ä¸ª AZ ä¹‹é—´ç‰©ç†ä½ç½®ä¸Šåˆ†ç¦»ï¼› ä¸€ä¸ª AZ åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª IDCï¼› å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†å®¹ç¾ï¼Œä¸šåŠ¡åº”è¯¥è‡³å°‘åœ¨ä¸€ä¸ª Region ä¸‹çš„ä¸¤ä¸ª AZ ä¸­éƒ¨ç½²ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/aws_learning/1-introduction/:3:0","tags":["aws"],"title":"AWS å­¦ä¹  - 1 - åœ°ç†æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/1-introduction/"},{"categories":["AWS å­¦ä¹ "],"content":"4 Edge Location Edge Location æ˜¯åˆ†å¸ƒåœ¨ä¸–ç•Œå„åœ°çš„è¾¹ç¼˜ç«™ç‚¹ï¼Œç”¨äºæ”¯æŒä¸€äº›åŠ é€Ÿç”¨æˆ·è®¿é—®çš„æœåŠ¡ã€‚ ä¾‹å¦‚ï¼ŒCloudFront ä¸ Route53 éƒ½å¯ä»¥éƒ¨ç½²åœ¨ Edge Locationã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/aws_learning/1-introduction/:4:0","tags":["aws"],"title":"AWS å­¦ä¹  - 1 - åœ°ç†æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/1-introduction/"},{"categories":["AWS å­¦ä¹ "],"content":"5 ç®¡ç†åˆ†åŒº AWS æŒ‰ç…§åˆè§„æ€§è¦æ±‚å°†å…¨çƒæœåŠ¡åˆ†ä¸ºä¸‰ä¸ªç®¡ç†åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºä¹‹é—´æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚åŒ…æ‹¬ï¼š æµ·å¤–åˆ†åŒº aws.amazon.com - 21 ä¸ª Region ç»„æˆï¼Œæ¯ä¸ª Region ä¹‹é—´ä½¿ç”¨ AWS è‡ªè¡Œç»´æŠ¤çš„éª¨å¹²ç½‘ç»œç›¸è¿ï¼› ä¸­å›½åˆ†åŒº amazonaws.cn - åŒ—äº¬å’Œå®å¤ä¸¤ä¸ª Region ç»„æˆï¼Œä½†æ˜¯æ²¡æœ‰éª¨å¹²ç½‘ç»œç›¸è¿æ¥ï¼› govcloud ","date":"2021-06-23","objectID":"/posts/cloud_computing/aws_learning/1-introduction/:5:0","tags":["aws"],"title":"AWS å­¦ä¹  - 1 - åœ°ç†æ¦‚å¿µ","uri":"/posts/cloud_computing/aws_learning/1-introduction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"Pod è°ƒåº¦ï¼ŒæŠ¢å ä¸é©±é€","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° æ— è®ºæ˜¯åŸºæœ¬çš„å‰¯æœ¬æ§åˆ¶å™¨ï¼Œè¿˜æ˜¯è‡ªå®šä¹‰èµ„æºï¼Œå…¶æ§åˆ¶çš„åº•å±‚ Pod çš„è°ƒåº¦éƒ½æ˜¯éƒ½é€šè¿‡ Scheduler å®Œæˆçš„ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Schedule ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 nodeSelector Pod çš„ spec.nodeSelector å¯ä»¥ç”¨äºæ§åˆ¶ Pod èƒ½è¢«è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Šã€‚å…¶å†…å®¹æ˜¯ä¸€ç»„ kv é”®å€¼å¯¹ï¼Œåªæœ‰èŠ‚ç‚¹ label åŒ…å«æ‰€æœ‰è®¾å®šçš„ kvï¼Œæ‰å¯ä»¥è¢«è°ƒåº¦ Podã€‚ apiVersion:v1kind:Podmetadata:name:nginxlabels:env:testspec:containers:- name:nginximage:nginximagePullPolicy:IfNotPresentnodeSelector:disktype:ssd # åªæœ‰ label åŒ…å« disktype:ssd çš„èŠ‚ç‚¹æ‰èƒ½è¢«è°ƒåº¦ é™¤äº†ä½ æ‰‹åŠ¨ä¸ºèŠ‚ç‚¹æ·»åŠ  label å¤–ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šé»˜è®¤æ·»åŠ ä¸Šä¸€äº› labelï¼š kubernetes.io/hostname failure-domain.beta.kubernetes.io/zone failure-domain.beta.kubernetes.io/region topology.kubernetes.io/zone topology.kubernetes.io/region beta.kubernetes.io/instance-type node.kubernetes.io/instance-type kubernetes.io/os kubernetes.io/arch ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 nodeName spec.nodeName æ˜¯æœ€ç®€å•çš„é€‰æ‹©èŠ‚ç‚¹æ–¹æ³•ï¼ŒæŒ‡å®š Pod åªèƒ½åœ¨ä¸€ä¸ªæŒ‡å®šèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ apiVersion:v1kind:Podmetadata:name:nginxspec:containers:- name:nginximage:nginxnodeName:kube-01 # æŒ‡å®šè°ƒåº¦åˆ°èŠ‚ç‚¹ kube-01 ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 affinity 2.3.1 nodeAffinity spec.affinity.nodeAffinity ä¸ nodeSelector ç±»ä¼¼ï¼Œå¯ä»¥æ ¹æ®èŠ‚ç‚¹çš„ label æ¥æ§åˆ¶ Pod è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ã€‚ ç›®å‰åŒ…å«ä¸¤ç§ç±»å‹çš„èŠ‚ç‚¹äº²å’Œæ€§ï¼š requiredDuringSchedulingIgnoredDuringExecution ï¼šæŒ‡å®šè°ƒåº¦åˆ°çš„èŠ‚ç‚¹å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œä¸ nodeSelector ä¸€æ ·ä½†æ˜¯è¡¨è¾¾æ€§æ›´é«˜ï¼› preferredDuringSchedulingIgnoredDuringExecution ï¼šæŒ‡å®šè°ƒåº¦åˆ°èŠ‚ç‚¹çš„åå¥½æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¼˜å…ˆè°ƒåº¦åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼› åªå½±å“è°ƒåº¦ ç›®å‰ä¸¤ç§ç±»å‹èŠ‚ç‚¹äº²å’Œæ€§éƒ½ä»…ä»…å½±å“è°ƒåº¦æ—¶çš„é€‰æ‹©ï¼Œè€Œä¸ä¼šé©±é€å·²ç»è¿è¡Œçš„ Podã€‚ apiVersion:v1kind:Podmetadata:name:with-node-affinityspec:affinity:nodeAffinity:requiredDuringSchedulingIgnoredDuringExecution:# å¿…é¡»æ»¡è¶³æ¡ä»¶nodeSelectorTerms:- matchExpressions:- key:kubernetes.io/e2e-az-nameoperator:Invalues:- e2e-az1- e2e-az2preferredDuringSchedulingIgnoredDuringExecution:# ä¼˜å…ˆçº§æ¡ä»¶- weight:1preference:matchExpressions:- key:another-node-label-keyoperator:Invalues:- another-node-label-valuecontainers:- name:with-node-affinityimage:k8s.gcr.io/pause:2.0 nodeSelectorTerms ä¸‹çš„æ•°ç»„ä¹‹é—´æ˜¯ â€œæˆ–â€ å…³ç³»ï¼Œä¹Ÿå°±æ˜¯æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥è¢«è°ƒåº¦ã€‚ matchExpressions ä¸‹çš„æ•°ç»„ä¹‹é—´æ˜¯ â€œä¸â€ å…³ç³»ï¼Œéœ€è¦æ»¡è¶³æ‰€æœ‰æ¡ä»¶æ‰å¯ä»¥è¢«è°ƒåº¦ã€‚ weight å­—æ®µèŒƒå›´ 1-100ï¼Œå¦‚æœæ»¡è¶³å…¶æŒ‡å®šçš„æ¡ä»¶ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼˜é€‰ç®—åˆ†æ—¶å°±ä¼šåŠ ä¸Š weight çš„å€¼ã€‚ 2.3.2 Pod äº²å’Œæ€§ä¸åäº²å’Œæ€§ spec.affinity.podAffinity äº²å’Œæ€§å…è®¸æ ¹æ®èŠ‚ç‚¹ä¸Šå·²ç»è¿è¡Œçš„ Pod çš„ label æ¥æ§åˆ¶æ˜¯å¦è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚ Pod äº²å’Œæ€§ä¹ŸåŒ…å«ä¸¤ç§ç±»å‹ï¼š requiredDuringSchedulingIgnoredDuringExecution ï¼šå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ preferredDuringSchedulingIgnoredDuringExecution ï¼šä¼˜é€‰çš„æ¡ä»¶ spec.affinity.podAntiAffinity ä¸äº²å’Œæ€§ç›¸åï¼Œè¡¨æ˜å°† Pod å°½é‡ä¸å…¶ä»– Pod åˆ†å¼€éƒ¨ç½²ã€‚ å¯¹äº Pod äº²å’Œæ€§ä¸åäº²å’Œæ€§ï¼Œåˆ¤æ–­èŒƒå›´éƒ½æ˜¯é’ˆå¯¹æ‹“æ‰‘åŸŸæ¥è¯´çš„ã€‚é€šè¿‡ topologyKey æŒ‡å®šåˆ¤æ–­æ‹“æ‰‘åŸŸçš„ labelï¼Œå…·æœ‰ç›¸åŒ : çš„èŠ‚ç‚¹ä¼šè®¤ä¸ºå±äºç”¨ä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹ï¼š topologyKey:topology.kubernetes.io/zone # å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„ topology.kubernetes.io/zone:\u003cval\u003e çš„ labelï¼Œé‚£ä¹ˆå®ƒä»¬å±äºåŒä¸€ä¸ªæ‹“æ‰‘åŸŸã€‚ æ‰€ä»¥ï¼ŒèŠ‚ç‚¹äº²å’Œæ€§çš„è§„åˆ™ä¸ºï¼šå¯¹å°†è¢«è°ƒåº¦çš„èŠ‚ç‚¹ï¼Œå¦‚æœå…¶ç›¸åŒæ‹“æ‰‘åŸŸä¸‹çš„æŸä¸ªèŠ‚ç‚¹è¿è¡Œç€æ»¡è¶³æ¡ä»¶çš„ Podï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚ å¯¹åº”çš„ï¼ŒèŠ‚ç‚¹åäº²å’Œæ€§çš„è§„åˆ™ä¸ºï¼šå¯¹å°†è¢«è°ƒåº¦çš„èŠ‚ç‚¹ï¼Œå¦‚æœå…¶ç›¸åŒæ‹“æ‰‘åŸŸä¸‹çš„æŸä¸ªèŠ‚ç‚¹è¿è¡Œç€æ»¡è¶³æ¡ä»¶çš„ Podï¼Œé‚£ä¹ˆå°±å°½é‡ä¸è¦è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚ apiVersion:apps/v1kind:Deploymentmetadata:name:web-serverspec:selector:matchLabels:app:web-storereplicas:3template:metadata:labels:app:web-storespec:affinity:podAntiAffinity:requiredDuringSchedulingIgnoredDuringExecution:- labelSelector:matchExpressions:- key:appoperator:Invalues:- web-storetopologyKey:\"kubernetes.io/hostname\"# æ‹“æ‰‘åŸŸä¸ºèŠ‚ç‚¹podAffinity:requiredDuringSchedulingIgnoredDuringExecution:- labelSelector:matchExpressions:- key:appoperator:Invalues:- storetopologyKey:\"kubernetes.io/hostname\"containers:- name:web-appimage:nginx:1.16-alpine ä¸Šé¢ä¾‹å­ä¸­ï¼ŒpodAntiAffinity è¡¨æ˜ä¸è¦è°ƒåº¦åˆ°åŒèŠ‚ç‚¹å·²ç»è¿è¡Œç€ app:web-store çš„ Pod çš„èŠ‚ç‚¹ä¸Šï¼ŒpodAffinity è¡¨æ˜è°ƒåº¦åˆ°åŒèŠ‚ç‚¹è¿è¡Œç€ app:store çš„ Pod çš„èŠ‚ç‚¹ä¸Šã€‚é€šä¿—ç‚¹è¯´ï¼Œè¯¥ Pod ä¸èƒ½é‡å¤éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ¨ç½²è¦ä¸ app:store çš„ Pod ç»‘å®šã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 taint ä¸ tolerations ä¸ affinity ç›¸åï¼Œtaint ä½¿èŠ‚ç‚¹æ’æ–¥ä¸€ç±»ç‰¹å®šçš„ Podã€‚ ä¸ºäº†èƒ½ä½¿ taint èŠ‚ç‚¹èƒ½å¤Ÿè¢«è°ƒåº¦åˆ°ä¸€äº›ç‰¹æ®Šçš„ Podï¼Œå¯ä»¥è®¾ç½® Pod çš„ tolerationï¼Œè¡¨æ˜ä¸åœ¨æ„æŸäº›èŠ‚ç‚¹çš„ taint ã€‚ 2.4.1 taint é€šè¿‡ kubectl taint ä¸ºèŠ‚ç‚¹å¢åŠ ä¸€ä¸ª taintï¼š $ kubectl taint nodes node1 key1=value1:NoSchedule ä¸º node1 æ·»åŠ  key1:value1 çš„ traintï¼Œå…¶è§¦å‘çš„æ•ˆæœæ˜¯ä¸èƒ½è¢«è°ƒåº¦ï¼ˆNoScheduleï¼‰ å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºåˆ é™¤æŸä¸ªèŠ‚ç‚¹çš„ taintï¼š kubectl taint nodes node1 key1=value1:NoSchedule- ç»“å°¾çš„ - å·è¡¨ç¤ºæ˜¯åˆ é™¤ä¸€ä¸ª taintï¼› è®¾ç½®çš„ kv å¯¹ç”¨äºæ¥åˆ¤æ–­ toleration æ˜¯å¦åŒ¹é… taintã€‚ ç›®å‰åŒ…å«å‡ ç§ç±»å‹çš„ effect ï¼š NoSchedule ï¼šä¸å°† Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸å½±å“å·²ç»è¿è¡Œçš„ Podï¼› PreferNoSchedule ï¼šå°½é‡ä¸é™ Pod åˆ†é…åˆ°è¯¥èŠ‚ç‚¹ï¼Œæ˜¯ä¸ªè½¯æ€§æ¡ä»¶ï¼› NoExecute ï¼šä¸å°† Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¼šé©±é€å·²ç»è¿è¡Œå¹¶ä¸”ä¸èƒ½å®¹å¿æ±¡ç‚¹çš„ Podï¼› Kubernetes ä¼šåœ¨ä¸€äº›æ¡ä»¶ä¸‹ï¼Œè‡ªåŠ¨ä¼šèŠ‚ç‚¹æ·»åŠ ä¸€äº›å†…ç½®çš„æ±¡ç‚¹ï¼š node.kubernetes.io/not-ready + NoExecute ï¼šèŠ‚ç‚¹ä¸ºå‡†å¤‡å¥½ï¼ŒReady ä¸º falseï¼› node.kubernetes.io/unreachable + NoExecute ï¼šèŠ‚ç‚¹ä¸å¯è¾¾ï¼ŒReady ä¸º unknownï¼› node.kubernetes.io/memory-pressure + ï¼šèŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ›ï¼› node.kubernetes.io/disk-pressure + NoSchedule ï¼šèŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ›ï¼› node.kubernetes.io/pid-pressure + NoSchedule ï¼šèŠ‚ç‚¹ PID å‹åŠ›ï¼› node.kubernetes.io/network-unavailable + NoSchedule ï¼šèŠ‚ç‚¹ç½‘ç»œä¸å¯ç”¨ï¼› node.kubernetes.io/unschedulable + NoSchedule ï¼šèŠ‚ç‚¹ä¸å¯è°ƒåº¦ï¼› node.cloudprovider.kubernetes.io/uninitialized + NoSchedule ï¼šèŠ‚ç‚¹æœªè¢«äº‘å¹³å°åˆå§‹åŒ–ï¼› DaemonSet åˆ›å»ºçš„ Pod DaemonSet åˆ›å»ºçš„ Pod ä¼šè‡ªåŠ¨åŠ ä¸Šä¸Šé¢ä¸¤ä¸ª NoExecute çš„ taintï¼Œä½¿å¾—å…¶ Pod ä¸ä¼šè¢«é©±é€ã€‚ 2.4.2 tolerations å½“ Pod è®¾ç½®çš„ spec.tolerations èƒ½å¤Ÿ â€œåŒ¹é…â€ èŠ‚ç‚¹æŸä¸ª taint æ—¶ï¼Œå°±å¯ä»¥è®¤ä¸ºè¯¥ taint ä¸å­˜åœ¨ã€‚ â€œåŒ¹é…â€ æœ‰ä¸¤ä¸ªå«ä¹‰ï¼š å¦‚æœ operator æ˜¯ Existï¼Œé‚£ä¹ˆç›¸åŒçš„ key å³å¯ã€‚å¦‚æœ operator ä¸º Equalï¼Œé‚£ä¹ˆ key val éƒ½è¦ç›¸åŒ effect ç›¸åŒ apiVersion:v1kind:Podmetadata:name:nginxlabels:env:testspec:containers:- name:nginximage:nginximagePullPolicy:IfNotPresenttolerations:- key:\"example-key\"operator:\"Exists\"effect:\"NoSchedule\" å¯ä»¥å®¹å¿ key ä¸º â€œexample-keyâ€ï¼Œeffect ä¸º â€œNoScheduleâ€ çš„ taintï¼› é€šè¿‡ spec.tolerations.tolerationSeconds å¯ä»¥æŒ‡å®šåŒ¹é…åˆ°å®¹å¿çš„æ±¡ç‚¹åï¼Œèƒ½å¤ŸæŒç»­å®¹å¿çš„æ—¶é—´ã€‚ tolerations:- key:\"key1\"operator:\"Equal\"value:\"value1\"effect:\"NoExecute\"tolerationSeconds:3600# åŒ¹é…åˆ° taint åï¼Œ3600 å†…ä¸ä¼šè¢«é©±é€ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 Eviction ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 èŠ‚ç‚¹å‹åŠ›é©±é€ kubelet ä¼šç›‘æ§ CPUã€Memã€ç£ç›˜ç©ºé—´ã€æ–‡ä»¶ç³»ç»Ÿ inode æ•°é‡ç­‰èµ„æºï¼Œä¸€æ—¦æŸä¸ªèµ„æºæ¶ˆè€—è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼ï¼Œkubelet ä¼šä¸»åŠ¨é©±é€èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ª Podï¼Œä»¥å›æ”¶èµ„æºã€‚ é©±é€æ—¶ï¼Œkubelet ä¼šå°† Pod è®¾ç½®ä¸º Failed çŠ¶æ€ï¼Œå¹¶åœæ­¢ Podï¼Œè€Œä¸Šå±‚çš„å‰¯æœ¬æ§åˆ¶å™¨å¯èƒ½ä¼šåœ¨å…¶ä»–åœ°æ–¹åˆ›å»º Pod æ¥æ›¿ä»£ã€‚ é©±é€çš„é˜ˆå€¼åˆ†ä¸ºï¼š soft eviction thresholds ï¼šè¾¾åˆ°è½¯é˜ˆå€¼åå¹¶æŒç»­äº†ä¸€æ®µæ—¶é—´æ²¡æœ‰æ¢å¤ï¼Œå°±ä¼šé€šè¿‡ graceful çš„æ–¹å¼é©±é€ä¸€äº› Podï¼› hard eviction thresholds ï¼šä¸€æ—¦è§¦å‘é˜ˆå€¼ï¼Œç«‹å³é€šè¿‡ force æ–¹å¼è¿›è¡Œé©±é€ï¼› 3.1.2 é…ç½®é©±é€å‚æ•° é©±é€ç›¸å…³çš„é…ç½®å‚æ•°éƒ½éœ€è¦é…ç½® kubelet çš„å¯åŠ¨å‚æ•°æ¥è¿›è¡Œé…ç½®ã€‚ 3.1.3 é©±é€ç­–ç•¥ kubelet ä¼šæŒ‰ç…§ä¸‹é¢å‚æ•°æ¥å†³å®šé©±é€ pod çš„é¡ºåºï¼š Pod èµ„æºä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡ spec.requestï¼› Pod ä¼˜å…ˆçº§ï¼› Pod ç›¸å¯¹äº spec.request çš„èµ„æºä½¿ç”¨æƒ…å†µï¼› å› æ­¤ï¼Œkubelet ä¼šæŒ‰ç…§ä¸‹é¢é¡ºåºè¿›è¡Œé©±é€ï¼šã€‚ å¦‚æœ BestEffort æˆ–è€… Burstable Pod èµ„æºä½¿ç”¨é‡è¶…è¿‡ requestã€‚è¶…å‡ºçš„è¶Šå¤šçš„ Pod ä¼˜å…ˆè¢«é©±é€ï¼› å¦‚æœéƒ½æ˜¯ Guaranteed å’Œ Burstable Pod å¹¶å°äº requestï¼Œé‚£ä¹ˆåŸºäº Pod Priority é©±é€ã€‚ BestEffort Burstable Guaranteed æ˜¯ QosClassã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 API é©±é€ ä¸èŠ‚ç‚¹å‹åŠ›é©±é€çš„ä¸åŒï¼ŒAPI é©±é€æ˜¯æŒ‡é€šè¿‡ Eviction API æ¥è¿›è¡Œä¸»åŠ¨çš„é©±é€ï¼Œå¹¶ä¸”åœæ­¢ Pod æ˜¯ gracefulã€‚ kubectl drain å°±æ˜¯é€šè¿‡ API è¿›è¡Œé©±é€ï¼Œåœæ­¢æŸä¸ªèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Podã€‚ API é©±é€ä¼šå—åˆ° PodDisruptionBudgets å’Œ terminationGracePeriodSeconds çš„æ§åˆ¶ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.3 æ±¡ç‚¹é©±é€ åœ¨ç¬¬ 2 éƒ¨åˆ†çœ‹åˆ°ï¼Œè‡ªå®šä¹‰çš„æ±¡ç‚¹ä¹Ÿä¼šå¯¼è‡´ Pod çš„é©±é€ï¼Œä¸èƒ½å®¹å¿ NoExecute æ±¡ç‚¹çš„ Pod éƒ½ä¼šè¢«é©±é€ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 Preemption Pods å¯ä»¥è¢«æä¾›ä¸€ä¸ªä¼˜å…ˆçº§ã€‚é«˜ä¼˜å…ˆçº§çš„ Pod ä¼šè¢«ä¼˜å…ˆè°ƒåº¦ï¼Œscheduler ç”šè‡³ä¼šå°è¯•æŠ¢å ä½ä¼˜å…ˆçº§çš„ Podï¼Œæ¥è®©é«˜ä¼˜å…ˆçº§çš„ Pod å…ˆè¿è¡Œã€‚ è¦ä½¿ç”¨ä¼˜å…ˆçº§ä¸æŠ¢å åŠŸèƒ½ï¼š åˆ›å»º PriorityClassï¼› Pod æˆ–è€… Pod template å®šä¹‰ä¸­æŒ‡å®š spec.priorityClassName ä¸ºä¸€ä¸ªç‰¹å®šçš„ PriorityClassesã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 PriorityClass PriorityClass æ˜¯ä¸€ä¸ª non-namespaced èµ„æºï¼Œå…¶åŒ…å«ä¸€ä¸ª value æ¥æè¿°ä¼˜å…ˆçº§ã€‚ Kubernetes å†…ç½®ä¸¤ä¸ª PriorityClass ï¼šsystem-cluster-critical system-node-criticalï¼Œè¡¨æ˜æ˜¯ç³»ç»Ÿå…³é”®çš„ç»„ä»¶ã€ ä¸€ä¸ªåŸºæœ¬çš„ PriorityClass ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š apiVersion:scheduling.k8s.io/v1kind:PriorityClassmetadata:name:high-priorityvalue:1000000globalDefault:falsedescription:\"This priority class should be used for XYZ service pods only.\" value ï¼šä¼˜å…ˆçº§å€¼ï¼Œ32 ä½æ•´å‹ï¼Œè¶Šå¤§è¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚ globalDefault ï¼šæ˜¯å¦æ˜¯ç³»ç»Ÿé»˜è®¤ä¼˜å…ˆçº§ï¼Œæ²¡æœ‰æŒ‡å®š PriorityClass çš„ Pod ä½¿ç”¨é»˜è®¤ä¼˜å…ˆçº§ï¼› å¦‚æœç³»ç»Ÿæ²¡æœ‰è®¾ç½® globalDefaultï¼Œé‚£ä¹ˆé»˜è®¤ä¼˜å…ˆçº§æ˜¯ 0ã€‚ description ï¼šæ–‡æœ¬æè¿°ï¼› ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 Pod ä¼˜å…ˆçº§ åˆ›å»º Pod æ—¶é€šè¿‡æŒ‡å®š spec.priorityClassName æ¥æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„ PriorityClassã€‚ apiVersion:v1kind:Podmetadata:name:nginxlabels:env:testspec:containers:- name:nginximage:nginximagePullPolicy:IfNotPresentpriorityClassName:high-priority å½“ Pod ä¼˜å…ˆçº§è®¾ç½®åï¼Œscheduler ä¼šæŒ‰ç…§ä¼˜å…ˆçº§å¯¹ pending Pods è¿›è¡Œæ’åºï¼Œé«˜ä¼˜å…ˆçº§çš„ pending Pod ä¼˜å…ˆäºä½ä¼˜å…ˆçº§çš„è¿›è¡Œå¤„ç†ã€‚ å¦‚æœé«˜ä¼˜å…ˆçº§çš„ Pod æ— æ³•è¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ scheduler æ‰ä¼šç»§ç»­è°ƒåº¦åˆ°ä½ä¼˜å…ˆçº§ Podã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.3 æŠ¢å  å½“ scheduler å‘ç°ä¸€ä¸ª Pod æ— æ³•è¢«è°ƒåº¦åˆ°ä»»ä½•èŠ‚ç‚¹æ—¶ï¼Œå°±ä¼šè§¦å‘æŠ¢å çš„é€»è¾‘ã€‚scheduler ä¼šå°è¯•è®¡ç®—ï¼šæ˜¯å¦ç§»é™¤æŸä¸ªèŠ‚ç‚¹çš„ä¸€ä¸ªæˆ–å¤šä¸ªä½ä¼˜å…ˆçº§çš„ Podï¼Œä½¿å¾—èŠ‚ç‚¹èƒ½å¤Ÿæ»¡è¶³è¢«è°ƒåº¦çš„æ¡ä»¶ã€‚ å¦‚æœèƒ½å¤Ÿæ‰¾åˆ°è¯¥èŠ‚ç‚¹ï¼Œæ–° Pod çŠ¶æ€ä¿¡æ¯ä¸­çš„ nominatedNodeName ä¸ºè¢«è®¾ç½®ä¸ºèŠ‚ç‚¹åï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥çœ‹åˆ°æŠ¢å ä¿¡æ¯ã€‚ ä¹‹åï¼ŒèŠ‚ç‚¹ä¸Šè¢«ä½ä¼˜å…ˆçº§çš„ Pod ä¼šè¢«é©±é€ï¼ˆgraceful stop 30sï¼‰ã€‚å› æ­¤ï¼Œè¿™é‡Œä¼šå¯¼è‡´æ–° Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¹‹é—´æœ‰ä¸€ä¸ªéœ€è¦ç­‰å¾…çš„æ—¶é—´å·®ã€‚ æ‰€ä»¥ï¼ŒNominated Node è¿™ä¸ä»£è¡¨æ–° Pod å¿…å®šä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä¹Ÿè®¸é©±é€æœŸé—´å‡ºç°åˆ«çš„èŠ‚ç‚¹æ»¡è¶³è°ƒåº¦æ¡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šè¢«è°ƒåº¦ã€‚ å¦‚æœæ–° Pod ä¸å°†è¢«é©±é€çš„ Pod ä¹‹é—´æœ‰ pod affinity å…³ç³»ï¼Œé‚£ä¹ˆæŠ¢å åäº²å’Œæ€§å…³ç³»å°±ä¸å†ä¼šè¢«æ»¡è¶³ï¼Œå› æ­¤ scheduler ä¸ä¼šé€‰æ‹©è¿™æ ·çš„èŠ‚ç‚¹æ¥è¿›è¡ŒæŠ¢å ã€‚åŒæ ·ï¼Œæ¨èåœ¨åŒä¼˜å…ˆçº§æˆ–è€…é«˜ä¼˜å…ˆçº§çš„ Pod é—´è®¾ç½® pod affinityã€‚ åŒæ ·ï¼Œé’ˆå¯¹æ‹“æ‰‘åŸŸä¸‹çš„ pod affinityï¼Œä¹Ÿä¼šæœ‰ä¸Šè¿°çš„é—®é¢˜ï¼Œå› æ­¤ scheduler ä¸ä¼šè¿›è¡Œè·¨èŠ‚ç‚¹æŠ¢å ã€‚ ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ Blogï¼šk8s èŠ‚ç‚¹èµ„æºé¢„ç•™ä¸ pod é©±é€ å®˜æ–¹æ–‡æ¡£ï¼šScheduling, Preemption and Eviction ","date":"2021-06-23","objectID":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 9 - Schedule Preemption Eviction","uri":"/posts/cloud_computing/k8s_learning/9-schedule-preemption-eviction/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"API ç‰ˆæœ¬ç®¡ç†è§„åˆ™ä¸æ‰©å±•æ–¹å¼","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 ç»„ç»‡å¯¹è±¡çš„æ–¹å¼ Kubernetes ä¸­ï¼Œç»„ç»‡å¯¹è±¡çš„æ–¹å¼ï¼Œå°±æ˜¯æŒ‰ç…§ Groupã€Versionã€Resource ä¸‰ä¸ªå±‚çº§ã€‚ Group ç”¨ä»¥æ¥å¯¹ API è¿›è¡Œåˆ†ç»„ï¼ˆåˆ†ç±»ï¼‰ï¼› Version ç”¨ä»¥å¯¹ç›¸åŒçš„ API è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼› Resource ä»£è¡¨ç€ä¸€ä¸ªå…·ä½“çš„èµ„æºå¯¹è±¡çš„ APIï¼› etcd ä¸­å¦‚ä½•ç»„ç»‡å¯¹è±¡ è¿™ä¸æ˜¯åœ¨ etcd ä¸­ç»„ç»‡èµ„æºå¯¹è±¡çš„æ–¹å¼ï¼Œetcd ä¸­è¿˜æ˜¯æŒ‰ç…§èµ„æºç±»å‹ï¼Œä»¥åŠå‘½åæ¥è¿›è¡Œåˆ†ç±»å­˜å‚¨ $ alias edctl=\"etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key $edctl get /registry --prefix --keys-only /registry/pingcap.com/tidbinitializers/mycluster/mycluster-init /registry/pingcap.com/tidbmonitors/mycluster/mycluster /registry/pods/kube-system/coredns-7c7788d75c-cggn5 â€¦ è¿™ä¸‰ä¸ªå±‚æ¬¡ï¼Œä¹Ÿä¼šä½“ç°åœ¨èµ„æºå®šä¹‰çš„ yaml æ–‡ä»¶ä¸­ï¼š apiVersion:batch/v2alpha1 # Group/Versionkind:CronJob # Resource# â€¦ è€Œ Kubernetes å°±æ˜¯é€šè¿‡æ¯”è¾ƒ Group Version Resourceï¼Œå†åŠ ä¸Šèµ„æºå¯¹è±¡çš„ name æ¥å¯»æ‰¾ä¸€ä¸ªèµ„æºã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.2 REST é£æ ¼ Kubernetes ç³»ç»Ÿå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒAPI å®šä¹‰å’Œæ ‡å‡†éƒ½ç¬¦åˆ HTTP REST æ ‡å‡†ï¼Œå³é€šè¿‡ POSTã€PUTã€GETã€DELETE ç­‰ HTTP method æ¥è¿›è¡Œå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚ ç›®å‰ï¼ŒKubernetes ä½¿ç”¨ OpenAPI æ–‡æ¡£æ ¼å¼ç”Ÿæˆæ¥å£æ–‡æ¡£ã€‚ä½ å¯ä»¥é€šè¿‡ https://\u003cmaster_ip\u003e:\u003cmaster_port\u003e/openapi/v2 æ¥è®¿é—® API æ–‡æ¡£ã€‚ # è·å– TOEKN $ TOKEN=$(kubectl describe secrets $(kubectl get secrets -n kube-system |grep admin |cut -f1 -d ' ') -n kube-system |grep -E '^token' |cut -f2 -d':'|tr -d '\\t'|tr -d ' ') # è·å– APIServer åœ°å€ $ APISERVER=$(kubectl config view |grep server|cut -f 2- -d \":\" | tr -d \" \") $ curl -H \"Authorization: Bearer $TOKEN\" $APISERVER/openapi/v2 -k | jq | more { \"swagger\": \"2.0\", \"info\": { \"title\": \"Kubernetes\", \"version\": \"v1.21.1\" }, \"paths\": { # ... ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 ç‰ˆæœ¬æ§åˆ¶ Kubernetes å¯¹äºç‰ˆæœ¬çš„æ§åˆ¶ä½“ç°åœ¨ URL ä¸­ï¼Œæ¯ä¸ª API å¯¹åº”çš„ URL åŸºäº /apis/\u003cgroup\u003e/\u003cversion\u003e/namespaces/\u003cns\u003e/\u003cresource\u003e çš„æ ¼å¼æ„å»ºï¼Œæ‰€ä»¥ä¸åŒçš„ç‰ˆæœ¬æœ‰ç€ä¸åŒçš„ URLã€‚ å¯¹äºä¸€ä¸ªç‰¹å®šçš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚ v1ï¼ŒåŒ…å«ä¸‰ç§çº§åˆ«çš„ç‰ˆæœ¬ï¼š Alpha ï¼šé¢„è§ˆç‰ˆæœ¬ version ä»¥ \u003cv\u003ealpha\u003cnr\u003e æ ¼å¼ï¼Œä¾‹å¦‚ v1alpha1ã€‚ è¡¨æ˜è½¯ä»¶æ˜¯ä¸ç¨³å®šï¼Œè½¯ä»¶å¯èƒ½ä¼šæœ‰ Bugï¼ŒæŸäº›æ–°å¢ç‰¹æ€§æ”¯æŒå¯èƒ½éšæ—¶è¢«åˆ é™¤ï¼ŒæŸäº›æ–°å¢ API å¯èƒ½ä¼šå‡ºç°ä¸å…¼å®¹æ€§æ›´æ”¹ã€‚ å› æ­¤ä»…ä»…ä½¿ç”¨äºæµ‹è¯•é›†ç¾¤ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚ Beta ï¼šæµ‹è¯•ç‰ˆæœ¬ version ä»¥ \u003cv\u003ebeta\u003cnr\u003e æ ¼å¼ï¼Œä¾‹å¦‚ v2beta3ã€‚ è¡¨æ˜è½¯ä»¶ç»è¿‡æµ‹è¯•ï¼Œå¹¶ä¸”ç‰¹æ€§éƒ½æ˜¯å®‰å…¨çš„ã€‚å¦‚æœç‰¹æ€§ä¸ API å‘ç”Ÿå…¼å®¹æ€§æ›´æ”¹ï¼Œé‚£ä¹ˆä¼šæä¾›è¿ç§»çš„è¯´æ˜ã€‚ GA ï¼šç¨³å®šç‰ˆæœ¬ verison ä»¥ \u003cv\u003e æ ¼å¼ï¼Œä¾‹å¦‚ v1ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 API Groups ä¸ºäº†æ›´å®¹æ˜“æ‰©å±• APIï¼ŒKubernetes å°† API åˆ†ç»„ä¸ºå¤šä¸ªé€»è¾‘é›†åˆï¼Œç§°ä¸º API Groupsã€‚ å½“å‰æ”¯æŒä¸¤ç±»çš„ API Groupsï¼š Core Groupsï¼ˆæ ¸å¿ƒç»„ï¼‰ åˆç§°ä¸º Legacy Groupsï¼Œå¤§éƒ¨åˆ†æ ¸å¿ƒèµ„æºå¯¹è±¡éƒ½åœ¨è¯¥ç»„é‡Œï¼Œä¾‹å¦‚ Containerã€Podã€Service ç­‰ã€‚ å…¶ URL è·¯å¾„å‰ç¼€ä¸º /api/v1ã€‚å…¶ Group ä¸ºç©ºï¼Œå› æ­¤ä½¿ç”¨ spec.apiVersion : v1ã€‚ å…¶ä»– API Groups URL è·¯å¾„å‰ç¼€ä¸º /apis/\u003cGroup\u003e/\u003cVersion\u003eï¼Œä½¿ç”¨ spec.apiVersion: \u003cGroup\u003e/\u003cVersion\u003eã€‚ å¸¸è§çš„åˆ†ç»„åŒ…æ‹¬ï¼š apps/v1 ï¼šä¸»è¦åŒ…å«ä¸ç”¨æˆ·å‘å¸ƒã€éƒ¨ç½²æœ‰å…³èµ„æºï¼ŒåŒ…æ‹¬ Deploymentsï¼ŒRollingUpdatesï¼ŒReplicaSetã€‚ extensions/\u003cVersion\u003e ï¼šæ‰©å±• API ç»„ï¼ŒåŒ…æ‹¬ DaemonSetã€ReplicaSetï¼ŒIngressesã€‚ batch/\u003cVersion\u003e ï¼šæ‰¹å¤„ç†å’Œä½œä¸šä»»åŠ¡çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ Jobã€‚ autoscaling\u003cVersion\u003e ï¼šHPA ç›¸å…³èµ„æºå¯¹è±¡ã€‚ certificate.k8s.io/\u003cVersion\u003e ï¼šé›†ç¾¤è¯ä¹¦æ“ä½œç›¸å…³èµ„æºå¯¹è±¡ã€‚ rbac.authorization.k8s.io/v1 ï¼šRBAC æƒé™ç›¸å…³èµ„æºå¯¹è±¡ã€‚ policy/\u003cVersion\u003e ï¼šPod æƒé™æ€§ç›¸å…³çš„èµ„æºã€‚ å…¶ä»– CRD å®šä¹‰çš„åˆ†ç»„ Kubernetes å†…ç½®çš„æ‰€æœ‰ API Group å¯ä»¥è§ API å‚è€ƒæ–‡æ¡£ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 å¯ç”¨æˆ–ç¦ç”¨ API Group æ‰€æœ‰ API Group é»˜è®¤æƒ…å†µéƒ½æ˜¯å¯ç”¨çš„ã€‚å¯ä»¥é€šè¿‡ API Server å¯åŠ¨é…ç½®å¼€å¯ç”¨æˆ–ç¦ç”¨æŸä¸ª API ç»„ã€‚ ä¾‹å¦‚ â€“runtime-config=batch/v1=false è¡¨æ˜ç¦ç”¨ batch/v1 ä¸‹çš„æ‰€æœ‰ APIã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 å¯¹è±¡ Kubernetes API æ‰€æœ‰èµ„æºç±»å‹éƒ½æ˜¯ä»¥ å¯¹è±¡ æ–¹å¼çœ‹å¾…ï¼Œå¹¶ä¸”ä»¥ REST æ–¹å¼æä¾› HTTP API æ¥å£ã€‚ æ¯ä¸ªå¯¹è±¡çš„ API ä»¥ä»¥ä¸‹æ ¼å¼è¡¨ç¤ºï¼š non-namespace èµ„æºï¼š GET /apis/\u003cGroup\u003e/\u003cVersion\u003e/\u003cResource\u003e ï¼šè¿”å›èµ„æºé›†åˆ GET /apis/\u003cGroup\u003e/\u003cVersion\u003e/\u003cResource\u003e/\u003cName ï¼šæ“ä½œæŒ‡å®š name çš„èµ„æºå¯¹è±¡ namespace èµ„æºï¼š GET /apis/\u003cGroup\u003e/\u003cVersion\u003e/\u003cResource\u003e ï¼šè¿”å›æ‰€æœ‰ namespace ä¸‹èµ„æºå¯¹è±¡ GET /apis/\u003cGroup\u003e/\u003cVersion\u003e/namespaces/\u003cNamespace\u003e/\u003cResource\u003e ï¼šè¿”å›æŒ‡å®š namespace ä¸‹çš„æ‰€æœ‰èµ„æºå¯¹è±¡ GET /apis/\u003cGroup\u003e/\u003cVersion\u003e/namespaces/\u003cNamespace\u003e/\u003cResource\u003e/\u003cName\u003e ï¼šè¿”å› namespace ä¸‹æŒ‡å®š name çš„èµ„æºå¯¹è±¡ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 watch å¯¹è±¡ åŸºäº etcd çš„æœºåˆ¶ï¼Œæ¯ä¸ª Kubernetes å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª resourceVersion å­—æ®µï¼Œä»£è¡¨ç€èµ„æºåœ¨ etcd ä¸­å­˜å‚¨çš„ç‰ˆæœ¬ã€‚ å› æ­¤ï¼Œåœ¨ client çš„ watch è¿æ¥æ–­å¼€ï¼Œé‡æ–°è¿æ¥åï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š resourceVersion æ¥å¾—åˆ°æ–­è¿æœŸé—´å…¶å¯¹è±¡æ‰€æœ‰çš„æ›´æ”¹ã€‚ GET /api/v1/namespaces/test/pods?watch=1\u0026resourceVersion=10245 --- 200 OK Transfer-Encoding: chunked Content-Type: application/json { \"type\": \"ADDED\", \"object\": {\"kind\": \"Pod\", \"apiVersion\": \"v1\", \"metadata\": {\"resourceVersion\": \"10596\", ...}, ...} } { \"type\": \"MODIFIED\", \"object\": {\"kind\": \"Pod\", \"apiVersion\": \"v1\", \"metadata\": {\"resourceVersion\": \"11020\", ...}, ...} } ... å½“ç„¶ï¼Œetcd åªä¼šä¿å­˜ä¸€å®šæ—¶é—´å†…çš„èµ„æºå˜æ›´å†å²ï¼ˆé»˜è®¤ 5minï¼‰ã€‚å¦‚æœè¯·æ±‚çš„å†å²ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¼šè¿”å› HTTP Code 410 Goneã€‚ æ‰€ä»¥ client å¿…é¡»èƒ½å¤Ÿå¤„ç† 410 é”™è¯¯ï¼Œæ¸…ç†æœ¬åœ°å¯¹è±¡ç¼“å­˜ï¼Œè°ƒç”¨ list æ“ä½œï¼Œé‡æ–°å»ºç«‹ watchã€‚ Reflector å®˜æ–¹æä¾›äº†å°è£…å¥½è¿™äº›åŠŸèƒ½çš„ä»£ç ç»„ä»¶ï¼Œä¾‹å¦‚ Go ä¸­ Reflector ç»„ä»¶å·²ç»å®ç°äº†è¿™äº›é€»è¾‘ ä¸ºäº†è§£å†³å†å²çª—å£å¤ªçŸ­çš„é—®é¢˜ï¼Œä¸º event å¼•å…¥äº† bookmark event çš„æ¦‚å¿µã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 æŸ¥è¯¢å¯¹è±¡ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢å¯¹è±¡åªéœ€è¦ä½¿ç”¨ HTTP GET URL å°±å¯ä»¥å¯¹è±¡é›†åˆæˆ–è€…æŒ‡å®šå¯¹è±¡ã€‚ ä¸è¿‡æœ‰æ—¶å€™ï¼Œå½“ä½ æŸ¥è¯¢å¤§é‡çš„å¯¹è±¡æ—¶ï¼Œå¯èƒ½è¿”å›çš„æ•°æ®å¾ˆå¤§ï¼Œä½¿å¾—æµªè´¹ç½‘ç»œèµ„æºã€‚ä» 1.9 å¼€å§‹ï¼ŒKubernetes æ”¯æŒåˆ†æ®µæŸ¥è¯¢å¯¹è±¡ã€‚ åœ¨è¿›è¡ŒæŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œå¯ä»¥æŒ‡å®š limit å’Œ continue å‚æ•°ã€‚ æŸ¥è¯¢ 500 ä¸ª Podï¼ŒæŒ‡å®š â€œlimit=500â€ã€‚ GET /api/v1/pods?limit=500 --- 200 OK Content-Type: application/json { \"kind\": \"PodList\", \"apiVersion\": \"v1\", \"metadata\": { \"resourceVersion\":\"10245\", \"continue\": \"ENCODED_CONTINUE_TOKEN\", ... }, \"items\": [...] // returns pods 1-500 } ç»§ç»­å‰é¢è°ƒç”¨ï¼ŒæŸ¥è¯¢å‰©ä½™çš„ Podï¼ŒæŒ‡å®š â€œcontinue=ENCODED_CONTINUE_TOKENâ€ è¡¨æ˜ç»§ç»­ä¸Šä¸€æ¬¡æŸ¥è¯¢ã€‚ GET /api/v1/pods?limit=500\u0026continue=ENCODED_CONTINUE_TOKEN --- 200 OK Content-Type: application/json { \"kind\": \"PodList\", \"apiVersion\": \"v1\", \"metadata\": { \"resourceVersion\":\"10245\", \"continue\": \"\", // continue token is empty because we have reached the end of the list ... }, \"items\": [...] // returns pods 1001-1253 } æ³¨æ„ï¼Œå½“ä½ ä½¿ç”¨ continue ç»§ç»­æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢çš„æ°¸è¿œæ˜¯åŒä¸€ä¸ª resourceVersion çš„å¯¹è±¡ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.3 å¯¹è±¡è¡¨ç°å½¢å¼ é»˜è®¤ Kubernetes éƒ½æ˜¯é€šè¿‡ JSON æ ¼å¼æ¥è¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚é€šè¿‡ä¸‹é¢æ–¹å¼ï¼Œå…è®¸ client ä½¿ç”¨ protobuf å½¢å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚ è¯·æ±‚æ•°æ®æ—¶ï¼Œæ·»åŠ å¤´éƒ¨ Accept: application/vnd.kubernetes.protobuf è¡¨æ˜æœŸæœ›è¿”å› protobuf ç±»å‹æ•°æ®ï¼› å‘é€æ•°æ®æ—¶ï¼Œé€šè¿‡æŒ‡å®š Content-Type: application/vnd.kubernetes.protobuf è¡¨æ˜ä¼ è¾“çš„æ˜¯ä¸€ä¸ª protobuf ç±»å‹æ•°æ®ï¼› ä¸è¿‡ï¼Œéƒ¨åˆ† CRD æˆ–è€… API æ‰©å±•åŠ å…¥çš„èµ„æºä¸æ”¯æŒ Protobufï¼Œå¯ä»¥ä½¿ç”¨ Accept å¤´éƒ¨æŒ‡å®šå¤šç§ç±»å‹æ¥å…è®¸å›é€€ã€‚ Accept: application/vnd.kubernetes.protobuf, application/json ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.4 å¯¹è±¡çš„åˆ é™¤ èµ„æºå¯¹è±¡åˆ é™¤ç»è¿‡ä¸¤ä¸ªé˜¶æ®µï¼š finalization ç»ˆæ­¢ èµ„æºçš„ metadata.deletionTimestamp è¢«è®¾ç½®ï¼Œç„¶åéšæœºé¡ºåºæ‰§è¡Œ Finalizersã€‚ delete åˆ é™¤ å½“æ‰€æœ‰ Finalizers æ‰§è¡Œç»“æŸåï¼Œèµ„æºæ‰ä» etcd ä¸­è¢«çœŸæ­£åˆ é™¤ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5 è®¿é—®æ§åˆ¶ Kubernetes å¯¹ API æœ‰ç€ä¸‰ç§è®¿é—®æ§åˆ¶æ–¹å¼ï¼š è®¤è¯Authentication æˆæƒAuthorization å‡†å…¥æ§åˆ¶Admission Control è¿™é‡Œä»…ä»…ä¼šä»‹ç»ä¸‰ç§æ–¹å¼çš„æ¦‚å¿µï¼Œæ›´å¤šçš„ç»†èŠ‚åé¢æ‰æ·±å…¥å»å­¦ä¹ ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.1 Authentication Authentication ç”¨äºéªŒè¯è¯·æ±‚è€…æ˜¯å¦æ˜¯åˆæ³•çš„ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥èº«ä»½ã€‚ æ¯æ¬¡æ”¶åˆ°è¯·æ±‚æ—¶ï¼ŒAPIServer éƒ½ä¼šé€šè¿‡ä»¤æ’é“¾è¿›è¡Œè®¤è¯ï¼ŒæŸä¸€ä¸ªè®¤è¯æˆåŠŸå³å¯ï¼š x509 å¤„ç†ç¨‹åº ï¼šè®¤è¯ HTTP è¯·æ±‚çš„è¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼› bearer token å¤„ç†ç¨‹åº ï¼šéªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼› åŸºæœ¬è®¤è¯å¤„ç†ç¨‹åº ï¼šç¡®ä¿ HTTP è¯·æ±‚çš„åŸºæœ¬è®¤è¯å‡­è¯ä¸æœ¬åœ°çš„çŠ¶æ€åŒ¹é…ï¼› ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:5:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.2 Authorization Authorization ç”¨äºéªŒè¯è¯·æ±‚è€…æ˜¯å¦ç”±å¯¹åº”æ“ä½œçš„æƒé™ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥æƒé™ã€‚ APIServer ä¼šç»„åˆä¸€ç³»åˆ—æˆæƒæ–¹æ³•ï¼Œåªè¦æœ‰ä¸€ä¸ªæˆæƒè€…æ‰¹å‡†äº†æ“ä½œï¼Œé‚£ä¹ˆè¯·æ±‚å°±å¯ä»¥ç»§ç»­ã€‚ ä½¿ç”¨å“ªäº›æˆæƒæ–¹æ³•ï¼Œå¯ä»¥åœ¨ APIServer å¯åŠ¨æ—¶é€šè¿‡ --authorization_mode å‚æ•°è®¾ç½® ç›®å‰æ”¯æŒçš„å‡ ç§æˆæƒæ–¹æ³•ï¼š webhook ï¼šå…è®¸é›†ç¾¤å¤–çš„ HTTP(s) æœåŠ¡è¿›è¡Œæˆæƒï¼› ABAC ï¼šæ‰§è¡Œé™æ€æ–‡ä»¶ä¸­å®šä¹‰çš„ç­–ç•¥ï¼› RBAC ï¼šé€šè¿‡ RBAC æœºåˆ¶è¿›è¡Œæˆæƒï¼Œè¿™å…è®¸ç®¡ç†å‘˜è¿›è¡ŒåŠ¨æ€çš„é…ç½®ï¼› Node ï¼šç¡®ä¿ kubelet åªèƒ½è®¿é—®è‡ªå·±èŠ‚ç‚¹ä¸Šèµ„æºï¼› ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:5:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.3 Admission Control Admission Control æ˜¯ä½œä¸ºå¯¹æˆæƒæ¨¡å—çš„è¡¥å……ï¼Œç”¨äºæ‹¦æˆªè¯·æ±‚ä»¥ç¡®ä¿å…¶ç¬¦åˆé›†ç¾¤çš„æœŸæœ›ä¸è§„åˆ™ã€‚ å‡†å…¥æ§åˆ¶ä»…ä»…å¯¹äºå¯¹è±¡çš„åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ã€è¿æ¥è¯·æ±‚å…¶ä½œç”¨ï¼Œå¯¹äºå¯¹è±¡è¯»å–æ“ä½œä¸èµ·ä½œç”¨ã€‚ åªæœ‰æ‰€æœ‰çš„å‡†å…¥æ§åˆ¶å™¨éƒ½é€šè¿‡ï¼Œè¯·æ±‚æ‰èƒ½ç»§ç»­ã€‚å¦‚æœä»»ä¸€å‡†å…¥æ§åˆ¶å™¨æ£€æŸ¥ä¸é€šè¿‡ï¼Œè¯·æ±‚å°±ä¼šè¢«ç«‹å³æ‹’ç»ã€‚ å‡†å…¥æ§åˆ¶æ˜¯æœ€åçš„å…³å¡ï¼Œä¸€æ—¦é€šè¿‡åï¼Œèµ„æºå¯¹è±¡å°±ä¼šå†™å…¥ etcd ä¸­ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:5:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"6 æ‰©å±• API Kubernetes æä¾›äº†å¾ˆå®Œå–„çš„ API æ‰©å±•æœºåˆ¶ï¼Œä½¿å¾—ä½ ä¸éœ€è¦ä¿®æ”¹ Kubernetes çš„ä»£ç ï¼Œå¯ä»¥åŠ¨æ€çš„æ·»åŠ ä½ è‡ªå·±çš„èµ„æºå¯¹è±¡ã€‚ ç›®å‰ä¸»è¦åŒ…å«ä¸¤ç§æ‰©å±• API çš„æ–¹å¼ï¼š CRD ï¼šå¤ç”¨ Kubernetes çš„ API Serverã€‚ç”¨æˆ·åªéœ€è¦å®šä¹‰ CRDï¼Œå¹¶å®ç°ä¸€ä¸ª CRD Controllerï¼Œå°±èƒ½å¤Ÿé€šè¿‡ Kubernetes ç®¡ç†è‡ªå®šä¹‰èµ„æºå¯¹è±¡ã€‚ API Aggregate ï¼šç”¨æˆ·éœ€è¦ç¼–å†™é¢å¤–çš„ API Serverï¼Œå¯¹èµ„æºè¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚ CRD ç›¸å…³è§æ–‡ç« ï¼šCRD ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"6.1 API Aggregate é€šè¿‡ API Aggregate æœºåˆ¶ï¼Œèƒ½å¤Ÿå°†ç”¨æˆ·æ‰©å±•çš„ API æ³¨å†Œåˆ° kube-apiserver ä¸Šã€‚ ä¸ºäº†å®ç°è¯¥æœºåˆ¶ï¼Œkube-apiserver ä¸­å¼•å…¥äº†ä¸€ä¸ª API èšåˆå±‚ï¼Œå¯ä»¥å°† API çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°ç”¨æˆ·æä¾›çš„ API Server ä¸Šï¼Œç”±ç”¨æˆ· API Server å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†ã€‚ 6.1.1 å¼€å¯ API Aggregate åŠŸèƒ½ ä¸ºäº†è®© kube-apiserver å¼€å¯ API Aggregate åŠŸèƒ½ï¼Œéœ€è¦é…ç½®ä¸€äº›å¯åŠ¨å‚æ•°ï¼Œå…·ä½“è§æ–‡æ¡£ï¼šå¯ç”¨-kubernetes-apiserver-æ ‡å¿—ã€‚ 6.1.2 æ³¨å†Œ APIService èµ„æºå¯¹è±¡ ç”¨æˆ·éœ€è¦åˆ›å»ºä¸€ä¸ª APIService èµ„æºå¯¹è±¡ï¼Œæ¥æ³¨å†Œè‡ªå·±çš„ API Serviceã€‚ ä¸‹é¢ç¤ºä¾‹è¡¨æ˜ï¼Œå°† /apis/custom.metrics.k8s.io/v1beta1 çš„è½¬å‘åˆ°åä¸º custom-metrics-server çš„ Serviceã€‚ apiVersion:apiregistration.k8s.io/v1kind:APIServicemetadata:name:v1beta1.custom.metrics.k8s.iospec:insecureSkipTLSVerify:truegroup:custom.metrics.k8s.iogroupPriorityMinimum:1000versionPriority:15service:name:custom-metrics-servernamespace:custom-metricsversion:v1beta1 spec.service ï¼šæŒ‡å®šå°†è¯·æ±‚è½¬å‘åˆ°çš„ Service spec.version ï¼šAPI çš„ version spec.group ï¼šAPI çš„ group å½“ç„¶ï¼ŒAPIService ä»…ä»…è´Ÿè´£å°†è¯·æ±‚è½¬å‘åˆ° Serviceï¼Œè€Œ Service åç«¯çš„ Pod å°±éœ€è¦ç”¨æˆ·è‡ªå·±éƒ¨ç½²äº†ã€‚ ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:6:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ Blogï¼šKubernetes API çš„ç‰ˆæœ¬æ§åˆ¶ï¼Œåˆ†ç»„ï¼Œå¯¹è±¡ï¼Œè®¿é—®æ§åˆ¶ å®˜æ–¹æ–‡æ¡£ï¼šKubernetes API Concepts Blog: what-happens-when-k8s ","date":"2021-06-12","objectID":"/posts/cloud_computing/k8s_learning/8-api/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 8 - API","uri":"/posts/cloud_computing/k8s_learning/8-api/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"CRD æ¦‚å¿µä¸ä½¿ç”¨","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° Kubernetes ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç¼–æ’æ¡†æ¶ï¼Œæ›´æ˜¯æä¾›äº†æå¤§çš„æ‰©å±•æ€§ï¼Œå¯ä»¥çœ‹åšä¸€ä¸ªèµ„æºæ¡†æ¶ã€‚ä½ å¯ä»¥åŸºäº k8s æä¾›çš„ç§ç§åŠŸèƒ½ï¼Œæ¥æ»¡è¶³ä½ åº”ç”¨çš„éœ€è¦ã€‚ å…¶ä¸­ CRD å°±æ˜¯å…è®¸ä½ æ¥è‡ªå®šä¹‰ Resourceï¼Œå¯ä»¥ä¸ä¿®æ”¹ Kubernetes ä»£ç æ¥å®ç°ç±»ä¼¼äº NetworkPolicy è¿™æ ·çš„èµ„æºã€‚ Note å¯ä»¥ç†è§£ Kubernetes æä¾›äº†åŸºç¡€çš„æ¡†æ¶ï¼ŒPod Service Volume ç­‰éƒ½æ˜¯æœ€åŸºç¡€çš„ç»„ä»¶ï¼Œè€Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›ç»„ä»¶ä¹‹ä¸Šè¿›è¡Œå†æ¬¡æŠ½è±¡ä¸ç»„åˆï¼Œå°†å…¶èµ‹äºˆä¸€ä¸ªç‰¹å®šçš„æ¦‚å¿µ CustomResource ä»¥è´µå¸ TiDB Operator æ¥ä¸¾ä¸ªä¾‹å­ï¼ŒOperator ç”¨äºç®¡ç† TiDB çš„é›†ç¾¤ï¼Œå…¶æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ PDã€TiDBã€TiKV ç¨‹åºã€‚è¿™äº›æ ¸å¿ƒç»„ä»¶åœ¨æœ€åº•å±‚éƒ½æ˜¯ä»¥ Pod æ–¹å¼è¿è¡Œçš„ï¼Œå¹¶ä¸”æ˜¯å¤šå‰¯æœ¬å½¢å¼ã€‚è€Œæˆ‘ä»¬å°†æ‰€æœ‰çš„ Pod + Service ç­‰ç»„åˆåœ¨ä¸€èµ·ï¼Œæ„æˆäº† TiDBCluster è¿™ä¸ª CustomResourceã€‚ æ‰€ä»¥ï¼Œå½“ä½ æƒ³éƒ¨ç½² TiDB é›†ç¾¤æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹ TiDBCluster è¿™ä¸ªèµ„æºçš„é…ç½®ï¼Œç„¶åæäº¤åˆ° Kubernetes ä¸­ã€‚TiDB Operatorï¼ˆCRD Controllerï¼‰å°±ä¼šæ ¹æ® TiDBCluster æ¥æ“ä½œï¼Œä½¿å¾—é›†ç¾¤æŒ‰ç…§æœŸæœ›çŠ¶æ€éƒ¨ç½²ã€‚ ä¸ºä»€ä¹ˆèƒ½å¤Ÿåšåˆ°ï¼Ÿ Kubernetes åº•å±‚æ¶æ„è¢«å°½å¯èƒ½çš„è¿›è¡Œæ‹†åˆ†ä¸è§£è€¦ï¼Œè¿™æ ·ä½¿å¾—ä¸Šå±‚å¯ä»¥æœ‰å¾ˆé«˜çš„æ‰©å±•æ€§ã€‚ å¯¹äºä½¿ç”¨è‡ªå®šä¹‰èµ„æºï¼Œæœ€åŸºæœ¬è¦æ¶‰åŠåˆ°ï¼š CustomResourceDefinition ï¼šä¸€ç§ Resource ç±»å‹ï¼Œä¸ºäº†è®© k8s èƒ½å¤Ÿè®¤è¯†åˆ°ä½ çš„è‡ªå®šä¹‰èµ„æºï¼Œéœ€è¦å…ˆæäº¤ CRDï¼› CustomResource Controller ï¼šç®¡ç† CR çš„ç¨‹åºï¼Œä»¥ Pod æ–¹å¼è¿è¡Œï¼Œå¹¶é€šè¿‡ k8s API æ¥ç®¡ç† CR ä»¥åŠæ‰§è¡Œæ“ä½œï¼› CustomResource ï¼šä½ çš„è‡ªå®šä¹‰èµ„æºï¼Œå°±åƒ Pod Service è¿™ç§èµ„æºä¸€æ ·ä½¿ç”¨ï¼› æ¯”å–» æˆ‘ä¹ æƒ¯ä»¥ç¼–ç¨‹çš„æ–¹å¼æ¥çœ‹åˆ°è¿™ 3 ä¸ªï¼š CRD æ˜¯ç±»å®šä¹‰ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ç±»å‹ï¼› CR åŸºäºç±»åˆ›å»ºçš„å¯¹è±¡ï¼› CR Controller æ˜¯ä»£ç é€»è¾‘ï¼› ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 CRD CRD æ˜¯ä½¿ç”¨çš„ CustomResource çš„åŸºç¡€ï¼Œèƒ½å¤Ÿè®© k8s è®¤è¯†åˆ°ä½ çš„è‡ªå®šä¹‰çš„èµ„æºã€‚ åŸºæœ¬çš„ CRD å®šä¹‰å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜ç½‘ï¼‰ï¼š apiVersion:apiextensions.k8s.io/v1beta1kind:CustomResourceDefinitionmetadata:name:crontabs.stable.example.comspec:group:stable.example.comversions:- name:v1beta1# Each version can be enabled/disabled by Served flag.served:true# One and only one version must be marked as the storage version.storage:true- name:v1served:truestorage:falsescope:Namespacednames:# plural name to be used in the URL: /apis/\u003cgroup\u003e/\u003cversion\u003e/\u003cplural\u003eplural:crontabssingular:crontabkind:CronTabshortNames:- ctadditionalPrinterColumns:- name:Spectype:stringdescription:The cron spec defining the interval a CronJob is runjsonPath:.spec.cronSpec metadata.name ï¼šå‘½åï¼Œå¿…é¡»æ˜¯ \u003cplural\u003e.\u003cgroup\u003eï¼› spec group ï¼šAPI Groupï¼Œç”¨ä»¥ REST API æ³¨å†Œï¼ˆ/apis/\u003cgroup\u003e/\u003cversion\u003eï¼‰ï¼ŒåŸºæœ¬ä»¥ URL æ–¹å¼ï¼› versions ï¼šç‰ˆæœ¬å·ï¼Œç”¨ä»¥ REST API æ³¨å†Œï¼ˆ/apis/\u003cgroup\u003e/\u003cversion\u003eï¼‰ï¼› scope ï¼šèµ„æºçš„èŒƒå›´ï¼ŒNamespaced æˆ–è€… Clusterï¼› names plural ï¼šCRD çš„å¤æ•°å‘½åï¼› singular ï¼šCRD çš„å•æ•°å‘½åï¼› kind ï¼šCR çš„åå­—ï¼Œå®šä¹‰ CR æ—¶ä½¿ç”¨ï¼› shortNames ï¼šç®€çŸ­çš„åç§°ï¼Œç”¨ä»¥ kubectl æ—¶ç®€å†™ï¼› additionalPrinterColumns ï¼škubectl æ‰“å°å‡ºçš„é¢å¤–ä¿¡æ¯ï¼Œä» CR çš„ spec ä¸­è·å–ç›¸å…³çš„ä¿¡æ¯ï¼› ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 URL åˆ›å»º CRD åï¼Œä¼šè‡ªåŠ¨åœ¨ API Server å»ºç«‹å…¶å¯¹åº”çš„ Endpoint URLï¼Œä½¿å¾—å¯ä»¥é€šè¿‡ HTTP æ–¹å¼æ¥æŸ¥è¯¢ä¸æ“ä½œè¯¥ CRã€‚ å…¶ URL ä¸º /apis/\u003cgroup\u003e/\u003cversion\u003e/namespaces/\u003cns\u003e/\u003cplural\u003e/â€¦ã€‚ ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­çš„ API endpoint ä¸º /apis/stable.example.com/v1/namespaces/*/crontabs/â€¦ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 Validation spec.validation ç”¨ä»¥ç”¨æˆ·åœ¨æäº¤ CR æ—¶ï¼Œå¯¹å…¶å®šä¹‰è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ã€‚ è¯¥åŠŸèƒ½éœ€è¦é…ç½® kube-apiserver çš„ â€“feature-gates=CustomResourceValidation=trueã€‚ æˆ‘ä»¬å¯¹ä¸Šé¢çš„ç¤ºä¾‹å¯¹å…¶å¢åŠ ä¸¤ä¸ªæ£€æŸ¥ï¼š apiVersion:apiextensions.k8s.io/v1beta1kind:CustomResourceDefinitionmetadata:name:crontabs.stable.example.comspec:group:stable.example.comversion:v1scope:Namespacednames:plural:crontabssingular:crontabkind:CronTabshortNames:- ctvalidation:# openAPIV3Schema is the schema for validating custom objects.openAPIV3Schema:properties:spec:properties:cronSpec:type:stringpattern:'^(\\d+|\\*)(/\\d+)?(\\s+(\\d+|\\*)(/\\d+)?){4}$'replicas:type:integerminimum:1maximum:10 spec.cronSpec å¿…é¡»æ˜¯åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸² spec.replicas å¿…é¡»æ˜¯ä» 1 åˆ° 10 çš„æ•´æ•° æ›´å¤šçš„ openAPIV3Schema æ£€æŸ¥è¯­æ³•è§ OpenAPI v3 schemasã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 Defaulting ä¸ Nullable åœ¨ OpenAPI v3 validation schema ä¸‹ï¼Œå…è®¸ä½ ä¸ºæŸäº›é¡¹æŒ‡å®šé»˜è®¤å€¼ã€‚ apiVersion å¿…é¡»æ˜¯ apiextensions.k8s.io/v1 ä¸‹é¢ç¤ºä¾‹ä¸º spec.cronSpec æŒ‡å®šäº†ä¸€ä¸ªé»˜è®¤å€¼ï¼Œè€Œ spec.image é»˜è®¤ä¸º null å€¼ï¼š apiVersion:apiextensions.k8s.io/v1kind:CustomResourceDefinitionmetadata:name:crontabs.stable.example.comspec:group:stable.example.comversions:- name:v1served:truestorage:trueschema:# openAPIV3Schema is the schema for validating custom objects.openAPIV3Schema:type:objectproperties:spec:type:objectproperties:cronSpec:type:stringpattern:'^(\\d+|\\*)(/\\d+)?(\\s+(\\d+|\\*)(/\\d+)?){4}$'default:\"5 0 * * *\"image:type:stringnullable:truereplicas:type:integerminimum:1maximum:10default:1scope:Namespacednames:plural:crontabssingular:crontabkind:CronTabshortNames:- ct ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 Subresources subresouces æ”¯æŒè®¾ç½® status å’Œ scale ä¸¤ç±»ï¼š status ï¼šAPI URL å¯åŠ¨ /status è·¯å¾„ï¼Œè¯·æ±‚åå¾—åˆ°å¯¹åº”èµ„æºå¯¹è±¡çš„å½“å‰ status scale ï¼šAPI URL å¯ç”¨ /scale è·¯å¾„ï¼Œä½¿å¾— Kubernetes æ§åˆ¶å™¨ï¼ˆå¦‚ HPAï¼‰èƒ½å¤Ÿæ§åˆ¶ CRD å¯¹è±¡ã€‚ç”¨æˆ·é€šè¿‡ kubectl scale ä¹Ÿå¯ä»¥å¯¹ CRD å¯¹è±¡è¿›è¡Œç¼©æ‰©å®¹æ“ä½œã€‚ å‰æ å½“ç„¶ï¼Œscale çš„å‰ææ˜¯ä½ çš„ CustomResource èƒ½å¤Ÿæ”¯æŒå¤šå‰¯æœ¬çš„å½¢å¼ã€‚ ç¤ºä¾‹å¦‚ä¸‹ï¼š # ...spec:group:stable.example.comversions:- name:v1subresources:status:{}scale:specReplicasPath:.spec.replicasstatusReplicasPath:.status.replicaslabelSelectorPath:.status.labelSelector scale specReplicasPath ï¼šä» CR è·å–æœŸæœ›å‰¯æœ¬æ•°é‡çš„è·¯å¾„ï¼› statusReplicasPath ï¼šä» CR è·å–å½“å‰å‰¯æœ¬æ•°é‡çš„è·¯å¾„ï¼› labelSelectorPath ï¼šä» CR è·å– Label Selector çš„è·¯å¾„ï¼› ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.5 Categories spec.names.categories å¯ä»¥å°†èµ„æºåˆ†ç»„ï¼Œé€šè¿‡ä½¿ç”¨ kubectl get \u003ccategories\u003e æ¥è·å–ä¸€ç»„èµ„æºã€‚ apiVersion:apiextensions.k8s.io/v1kind:CustomResourceDefinitionmetadata:name:crontabs.stable.example.comspec:# â€¦ names:# categories æ˜¯å®šåˆ¶èµ„æºæ‰€å½’å±çš„åˆ†ç±»èµ„æºåˆ—è¡¨categories:- all ä¸Šé¢ä¾‹å­å°† CR åˆ†ç±»åˆ° â€œallâ€ ç±»åˆ«ä¸­ï¼Œä½¿å¾— kubectl get all å¯ä»¥è·å–åˆ°è¯¥ç±»åˆ«ä¸‹çš„æ‰€æœ‰å·²ç»åˆ›å»ºçš„èµ„æºã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.6 Finalizer Finalizer ä¼šåœ¨åˆ é™¤ CR æ—¶è‡ªåŠ¨è¢«è°ƒç”¨ï¼Œå¯ä»¥å®ç°å¯¹ CR çš„æ¸…ç†å·¥ä½œã€‚ apiVersion:\"stable.example.com/v1\"kind:CronTabmetadata:finalizers:- stable.example.com/finalizer finalizers ï¼šè®¾ç½® Finalizerï¼Œä»…ä»…æ˜¯ä¸€ä¸ªåç§°ï¼Œç”¨äº Controller åˆ¤æ–­ å½“ç”¨æˆ·è¯·æ±‚åˆ é™¤èµ„æºå¯¹è±¡æ—¶ï¼ŒKubernetes ä¼šå…ˆå°† metadata.deletionTimestamp çš„å€¼ï¼Œç„¶åå°†å…¶æ ‡è®°ä¸ºå¼€å§‹åˆ é™¤ã€‚è®¾ç½®è¯¥å€¼åï¼Œä¸æ–­çš„è½®è¯¢æ£€æŸ¥æ˜¯å¦æ‰€æœ‰çš„ finalizers è¢«ç§»é™¤ã€‚ å¯¹äºæ—è·¯çš„ Controllerï¼Œå‘ç° metadata.deletionTimestamp è¢«è®¾ç½®ï¼ŒçŸ¥é“äº†èµ„æºå¯¹è±¡æ­£åœ¨åˆ é™¤æµç¨‹ï¼Œäºæ˜¯å¼€å§‹æ‰§è¡Œå…¶è´Ÿè´£çš„çš„æ¸…ç†å·¥ä½œã€‚æ‰§è¡Œå®Œæˆåï¼Œä» finalizers ä¸­ç§»é™¤å¯¹åº”çš„ä¸€é¡¹ã€‚ Note Controler å¯ä»¥è¯»å– metadata.deletionGracePeriodSeconds çš„å€¼ï¼Œç”¨ä»¥å¾—åˆ°æœŸæœ›çš„ä¼˜é›…åˆ é™¤æ—¶é—´æ˜¯å¤šä¹…ã€‚ æ‰€æœ‰ finalizers ç§»é™¤åï¼ŒKubernetes æ‰å°†å…¶çœŸæ­£çš„èµ„æºå¯¹è±¡åˆ é™¤ã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:2:6","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 CR åœ¨æäº¤ CRD åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»º CR æ¥æäº¤äº†ã€‚å½“ç„¶ï¼ŒCR ä¸­çš„ spec ç›¸å…³çš„å±æ€§ k8s æ˜¯ä¸ä¼šä½¿ç”¨çš„ï¼Œè€Œæ˜¯åœ¨ Controller ä¸­è§£æå¹¶ä½¿ç”¨ã€‚ åŸºäºä¸Šé¢ç¤ºä¾‹ï¼Œåˆ›å»ºä¸€ä¸ª CronTab èµ„æºï¼š apiVersion:\"stable.example.com/v1\"kind:CronTabmetadata:name:my-new-cron-objectspec:cronSpec:\"* * * * /5\"image:my-awesome-cron-image å½“æˆ‘ä»¬æäº¤èµ„æºåï¼Œå…¶èµ„æºå°±ä¿å­˜åœ¨äº† Kubernetes ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ä¸åˆ é™¤ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ³¨å†Œ CronTab çš„ Controllerï¼Œæ‰€ä»¥æ²¡æœ‰åŸºäºè¯¥èµ„æºè¿›è¡Œç³»ç»Ÿä¸Šçš„ç®¡ç†ã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 CR Controller ä¸Šé¢çœ‹åˆ°ï¼ŒCR ä¸ CRD éƒ½æ˜¯é™æ€çš„èµ„æºï¼Œè€Œ CR Controller å°±æ˜¯åŸºäºå·²ç»åˆ›å»ºçš„ CR æ¥è¿›è¡Œå®é™…çš„ç³»ç»Ÿæ“ä½œï¼Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿæ˜¯å‘æœŸæœ›çš„çŠ¶æ€å‘å±•ã€‚ Controller éœ€è¦æˆ‘ä»¬è‡ªè¡Œç¼–å†™å…¶é€»è¾‘ï¼Œç„¶åæ³¨å†Œåˆ° Kubernetes ä¸­ã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 Controller æ¨¡å¼ ä¸è®ºæ˜¯å†…ç½®çš„ Controllerï¼Œè¿˜æ˜¯ä½ éœ€è¦ç¼–å†™çš„è‡ªå®šä¹‰çš„ Controllerï¼Œéƒ½éœ€è¦éµå¾ª æ§åˆ¶å™¨æ¨¡å¼Controller Pattern çš„æ–¹å¼å®ç°ã€‚ æˆ‘ç†è§£çš„æ§åˆ¶å™¨æ¨¡å¼æ˜¯ï¼šController ä¸æ–­æ°¸ä¹…å¾ªç¯æ‰§è¡Œç€ Controll Loopï¼Œè€Œæ¯ä¸€ä¸ª Loop éƒ½æ˜¯åŸºäºå½“å‰å®é™…çš„èµ„æºçŠ¶æ€ï¼ˆstatusï¼‰ï¼Œè¿›è¡Œç³»ç»Ÿæ“ä½œï¼Œå‘æœŸæœ›çš„èµ„æºçŠ¶æ€ï¼ˆspecï¼‰é æ‹¢ã€‚ æ‰€ä»¥æ•´ä¸ªé€»è¾‘æ˜¯åŸºäºçŠ¶æ€çš„ï¼Œè€Œä¸æ˜¯åŸºäºäº‹ä»¶çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ å£°æ˜å¼ APIDeclarative API ä¸ å‘½ä»¤å¼ APIImperative API çš„åŒºåˆ«ã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 å·¥ä½œåŸç† Kubernetes æä¾›äº†èµ„æºçŠ¶æ€çš„å­˜å‚¨åŠŸèƒ½ï¼Œè€Œ Controller éœ€è¦å®ç°çš„å°±æ˜¯åŸºäºå¯¹èµ„æºçš„æ›´å˜çš„æ§åˆ¶é€»è¾‘ã€‚ ä¸€ä¸ª Controller çš„å·¥ä½œåŸç†ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æµç¨‹å›¾è¡¨ç¤ºï¼š æ•´ä½“ä¸Šçœ‹ï¼ŒController å®ç°åˆ†ä¸ºä¸‰ä¸ªç»„ä»¶ï¼š Informer ï¼šæä¾›ç‰¹å®šå¯¹è±¡çš„å­˜å‚¨ï¼Œäº‹ä»¶è§¦å‘åŠŸèƒ½ï¼Œå³ List ä¸ Watch åŠŸèƒ½ï¼› WorkQueue ï¼šå¯¹è±¡å˜æ›´äº‹ä»¶é€šçŸ¥é˜Ÿåˆ—ï¼Œé€šè¿‡é˜Ÿåˆ—æ¥é˜²æ­¢é˜»å¡ Informerï¼› Control Loop ï¼šæ§åˆ¶å¾ªç¯ï¼ŒåŸºäºäº‹ä»¶æ¥æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼› 4.2.1 Informer Informer æ˜¯ Kubernetes æä¾›çš„ä»£ç æ¨¡å—ï¼Œé’ˆå¯¹äºç‰¹å®šçš„ API å¯¹è±¡ï¼ŒåŒ…å«å‡ ä¸ªèŒè´£ï¼š åŒæ­¥ etcd ä¸­å¯¹åº” API å¯¹è±¡ï¼Œå°†æ‰€æœ‰å¯¹è±¡ç¼“å­˜åˆ°æœ¬åœ°ï¼› æŸä¸ª API å¯¹è±¡çš„ä»»ä½•å˜æ›´ï¼Œéƒ½å¯ä»¥è§¦å‘å¯¹è±¡å˜æ›´äº‹ä»¶ï¼› è§¦å‘/æ£€æµ‹åˆ°å¯¹è±¡å˜æ›´äº‹ä»¶æ—¶ï¼Œè§¦å‘æ³¨å†Œçš„ ResourceEventHandler å›è°ƒï¼Œå³ AddFunc UpdateFunc DeleteFunc å›è°ƒï¼› é’ˆå¯¹äº etcd çš„ List ä¸ Watch æœºåˆ¶ï¼ŒInformer çš„åŒæ­¥æœºåˆ¶ä¹ŸåŒ…å«ä¸¤ç§ï¼š ä½¿ç”¨ Watch çš„äº‹ä»¶å¢é‡åŒæ­¥ï¼šå½“ APIServer æœ‰å¯¹è±¡çš„åˆ›å»ºã€åˆ é™¤æˆ–è€…æ›´æ–°ï¼ŒInformer.Reflector æ¨¡å—ä¼šæ”¶åˆ°å¯¹åº”äº‹ä»¶ï¼Œè§£æåæ”¾å…¥ Delta FIFO Queueï¼› ä½¿ç”¨ List çš„å®šæœŸå‘¨æœŸå…¨é‡åŒæ­¥ï¼šç»è¿‡ä¸€å®šå‘¨æœŸï¼ŒInformer ä¼šé€šè¿‡ List æ¥è¿›è¡Œæœ¬åœ°å¯¹è±¡çš„å¼ºåˆ¶æ›´æ–°ã€‚ è¯¥æ›´æ–°æ“ä½œä¼šå¼ºåˆ¶è§¦å‘â€œæ›´æ–°äº‹ä»¶â€ï¼Œä»è€Œè°ƒç”¨ UpdateFunc å›è°ƒ ä¸»åŠ¨åˆ¤æ–­ ResourceVersion æ‰€ä»¥ UpdateFunc è¦é€šè¿‡å¯¹è±¡çš„ ResourceVersion æ¥åˆ¤æ–­ï¼Œæ˜¯å¦å¯¹è±¡æœ‰ç€çœŸæ­£çš„æ›´æ–°ã€‚ åŒæ—¶ï¼ŒInformer ä¸­å¼‚æ­¥çš„ä¸æ–­è¯»å– Delta FIFO Queue ä¸­äº‹ä»¶ï¼Œå¹¶è§¦å‘å…¶æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼ˆAddFunc UpdateFunc DeleteFuncï¼‰ã€‚ ","date":"2021-06-10","objectID":"/posts/cloud_computing/k8s_learning/7-crd/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 7 - CRD","uri":"/posts/cloud_computing/k8s_learning/7-crd/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"StatefulSet æ¦‚å¿µä¸ä½¿ç”¨","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° Pod åœ¨è®¾è®¡çš„ç†å¿µä¸Šæ˜¯æ— çŠ¶æ€çš„ï¼ŒPod å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è¢«é”€æ¯ï¼Œå¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è¢«åœ¨åˆ«çš„èŠ‚ç‚¹åˆ›å»ºç›¸åŒçš„å‰¯æœ¬ã€‚ Deployment ä¸ RelicSets å°±æ˜¯åŸºäºè¿™ä¸ªç†å¿µè®¾è®¡çš„ï¼Œå®ƒä»¬ä»…ä»…ä¿è¯ Pod çš„å‰¯æœ¬æ•°é‡ï¼Œè€Œä¸å…³å¿ƒå…¶ä»–ã€‚ å¯¹äºå¤§å¤šæ•°ç¨‹åºï¼Œå…¶éƒ½æ˜¯éœ€è¦ â€œçŠ¶æ€â€ çš„ï¼Œä¹Ÿå°±æ˜¯é‡å¯èƒ½å¤Ÿæ¢å¤ä¹‹å‰çš„æ•°æ®ã€‚è¿™ä¸ªçŠ¶æ€å¯èƒ½åŒ…æ‹¬ï¼š å­˜å‚¨ ç½‘ç»œ å¯åœé¡ºåº ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 â€œçŠ¶æ€â€ æ˜¯ä»€ä¹ˆ å¯¹äºå­˜å‚¨å¾ˆå¥½ç†è§£ï¼Œå¤§å¤šæ•°ç¨‹åºä¼šå°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜æˆ–è€…äº‘ç›˜ï¼Œè€Œé‡å¯åé‡æ–°è¯»å–æ•°æ®ï¼Œæ¥æ¢å¤çŠ¶æ€ã€‚æ‰€ä»¥ï¼ŒPod é‡å¯å‰åè¯»å–åˆ°çš„å­˜å‚¨è¦æ˜¯ä¸€æ ·çš„ã€‚ å¯¹äºç½‘ç»œï¼ŒåŸºäº Service çš„å­˜åœ¨ï¼Œä¸€èˆ¬çš„åç«¯æœåŠ¡å¯ä»¥ä¸ç”¨å…³ç³»å…¶æ‰€å¤„äºçš„ç½‘ç»œç¯å¢ƒã€‚ä½†æ˜¯å¯¹äºåˆ†å¸ƒå¼ç¨‹åºæˆ–è€… p2p ç¨‹åºï¼Œæ¯ä¸ªç¨‹åºæ˜¯éœ€è¦çŸ¥é“å…¶ä»–ç¨‹åºçš„ç½‘ç»œåœ°å€çš„ã€‚æ‰€ä»¥ï¼ŒPod é‡å¯å‰åçš„ç½‘ç»œåœ°å€è¦æ˜¯ä¸€æ ·çš„ã€‚ è¿˜æœ‰ä¸€ç‚¹æ˜¯åŸºäº Pod ä¹‹é—´çš„å…³ç³»ï¼Œæœ‰æ—¶å€™å¤šä¸ª Pod å®ä¾‹ä¹‹é—´çš„å¯åœé¡ºåºä¹Ÿåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚ ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 å¦‚ä½•ä¿å­˜ â€œçŠ¶æ€â€ å¯¹äºå­˜å‚¨ï¼ŒPVC æ˜¯ä¸ Pod ç”Ÿå‘½å‘¨æœŸä¸è€¦åˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è®© Pod é‡å¯å‰åéƒ½ä½¿ç”¨åŒä¸€ä¸ª PVCï¼Œé‚£ä¹ˆå…¶æ•°æ®å°±æ˜¯ç›¸åŒçš„ã€‚æ‰€ä»¥é—®é¢˜å˜ä¸ºäº†ï¼šå»ºç«‹ Pod ä¸ PVC çš„æ˜ å°„å…³ç³»ã€‚ å¯¹äºç½‘ç»œï¼ŒPod çš„ IP ä¸æ˜¯æ’å®šçš„ï¼Œè¿™ä¸ªæ˜¯ Pod çš„åŸºæœ¬æ¦‚å¿µï¼Œæ— èƒ½æ›´æ”¹ã€‚æ‰€ä»¥é—®é¢˜å˜ä¸ºäº†ï¼šè¦æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ä»£è¡¨è¿™ä¸ª Pod çš„æ’å®šç½‘ç»œåœ°å€ã€‚ å¯¹äºå¯åŠ¨é¡ºåºï¼Œè¦ä¿è¯ Pod ä¹‹é—´çš„è¿è¡Œé¡ºåºï¼Œé‚£ä¹ˆéœ€è¦è®¤å¾—æ¯ä¸€ä¸ª Podï¼Œä¹Ÿå°±æ˜¯ Pod çš„å‘½åå¿…é¡»æ˜¯æœ‰è§„èŒƒä¸å›ºå®šçš„ã€‚ æ‰€æœ‰çš„é—®é¢˜éƒ½ç”±å›ºå®šçš„ Pod å‘½åæ¥è§£å†³ï¼ŒPod ä¼šæŒ‰ç…§ 0-N çš„æ–¹å¼æ¥è¿›è¡Œå‘½åï¼Œè€Œè¿™æ · Pod0 å¯ä»¥å›ºå®šåˆ° Pod0 PVCï¼Œå›ºå®šåˆ° Pod0 DNS åŸŸåï¼Œå¯åŠ¨é¡ºåºæŒ‰ç…§ Pod0 Pod1 â€¦ æ¥å¯åŠ¨ã€‚ è¿™å°±æ˜¯ StatefulSet åšçš„äº‹æƒ…ï¼Œæ€»ç»“ä¸€ä¸‹ï¼š å›ºå®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œé€šè¿‡ PVCï¼› å›ºå®šçš„ç½‘ç»œæ ‡è¯†ï¼Œé€šè¿‡ Headless Service ä½¿å¾— \u003cpodname\u003e.\u003cservice\u003e.\u003cnamespace\u003e ä¸å›ºå®šå‘½åçš„ Pod ç»‘å®šï¼› æŒ‰ç…§ç¼–å·è¿›è¡Œæœ‰åºçš„å¯åŠ¨ä¸åœæ­¢ï¼› ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 StatefulSet åŸºç¡€ ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 å®šä¹‰ StatefuleSet åŸºæœ¬å®šä¹‰å¦‚ä¸‹ï¼š apiVersion:apps/v1kind:StatefulSetmetadata:name:webspec:serviceName:\"nginx\"replicas:2selector:matchLabels:app:nginxtemplate:metadata:labels:app:nginxspec:containers:- name:nginximage:k8s.gcr.io/nginx-slim:0.8ports:- containerPort:80name:webvolumeMounts:- name:wwwmountPath:/usr/share/nginx/htmlvolumeClaimTemplates:- metadata:name:wwwspec:accessModes:[\"ReadWriteOnce\"]resources:requests:storage:1GistorageClassName:shared-ssd-storage serviceName ï¼šä½¿ç”¨çš„ Headless Service å‘½åï¼› replicas ï¼šå‰¯æœ¬æ•°é‡ï¼› selector ï¼šPod selectorï¼Œå†³å®šè¦ç®¡ç†å“ªäº› Podï¼› template ï¼šPod templateï¼› volumeClaimTemplates ï¼šåˆ›å»ºçš„ PVC æ¨¡æ¿ï¼› metadata.name ï¼šåˆ›å»ºçš„ PVC åŸºç¡€å‘½åï¼Œå‘½åä»¥ \u003cname\u003e-\u003cpodname\u003e æ ¼å¼ï¼› spec ï¼šä¸åˆ›å»ºä¸€ä¸ª PVC çš„ spec ç›¸åŒï¼› ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 Status StatefulSet ä¼šå°†å‡çº§ä¸ç‰ˆæœ¬ä¿¡æ¯è®°å½•åˆ° status å­—æ®µï¼š status:collisionCount:0currentReplicas:3currentRevision:my-cluster-69545dcd7dobservedGeneration:1readyReplicas:3replicas:3updateRevision:my-cluster-69545dcd7dupdatedReplicas:3 currentReplicas ï¼šå½“å‰ç‰ˆæœ¬çš„ Pod æ•°é‡ï¼› currentRevision ï¼šå½“å‰ç‰ˆæœ¬çš„æ ‡è¯†ï¼› updatedReplicas ï¼šå‡çº§å®Œæˆçš„ Pod æ•°é‡ï¼› updateRevision ï¼šéœ€è¦å‡çº§çš„ç‰ˆæœ¬æ ‡è¯†ï¼› è€Œåœ¨å¯¹åº”çš„ Pod label ä¸­ï¼Œcontroller-revision-hash ä¼šä¿å­˜ç€å…¶å¯¹åº”çš„ Revisionï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå…¶ Pod çš„ StatefulSet æ·»åŠ çš„ï¼š metadata:labels:controller-revision-hash:my-cluster-69545dcd7d é€šè¿‡å¯¹æ¯” Pod çš„ controller-revision-hash label ä¸ StatefulSet ä¿å­˜çš„ updateRevision å°±å¯ä»¥åˆ¤æ–­è¿™ä¸ª Pod æ˜¯å¦å·²ç»å‡çº§è¿‡äº†ã€‚å› æ­¤ï¼ŒStatefulSet å¯ä»¥ä¸æ–­å¯¹æœªå‡çº§çš„ Pod æ‰§è¡Œå‡çº§æ“ä½œã€‚ ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 ä½¿ç”¨ æ³¨æ„äº‹é¡¹ï¼š PV æˆ–è€… StorageClass éœ€è¦é¢„å…ˆåˆ›å»ºï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºä¸åˆ é™¤ï¼› è™½ç„¶ PVC æ˜¯ç”± StatefulSet è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä½†æ˜¯ä¸ä¼šè¿›è¡Œè‡ªåŠ¨åˆ é™¤ï¼Œè¿™æ˜¯ä¸ºäº†ä¿ç•™æ•°æ®ï¼› Headless Service éœ€è¦é¢„å…ˆåˆ›å»ºï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºä¸åˆ é™¤ï¼› åˆ é™¤ StatefulSet ä¸ä¼šä½¿å…¶æ¸…ç†æ‰€æœ‰çš„ Podï¼Œåº”è¯¥é€šè¿‡å°† .spec.replicas è®¾ç½®ä¸º 0 æ¥è®©å…¶æ¸…ç†æ‰€æœ‰çš„ Podï¼› ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 Pod ç®¡ç†ç­–ç•¥ é€šè¿‡ spec.podManagementPolicy å¯ä»¥è®¾ç½®ç®¡ç†çš„ Pod çš„ç­–ç•¥ï¼š OrderedReady ï¼šé»˜è®¤ç­–ç•¥ï¼ŒæŒ‰ç…§ Pod çš„é¡ºåºä¾æ¬¡åˆ›å»ºæˆ–åœæ­¢ï¼Œå‰ä¸€ä¸ª Pod å®Œæˆåæ‰ä¼šè¿›è¡Œä¸‹ä¸€ä¸ª Pod çš„æ“ä½œï¼› Parallel ï¼šæ‰€æœ‰ Pod åˆ›å»ºæˆ–åœæ­¢éƒ½æ˜¯å¹¶è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ä¸éœ€è¦å¯åœé¡ºåºçš„ç‰¹æ€§ï¼› ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.5 Pod å‡çº§ç­–ç•¥ é€šè¿‡ spec.updateStrategy å¯ä»¥è®¾ç½® Pod çš„å‡çº§ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å½“ä½ æ›´æ–° spec.template çš„é•œåƒç‰ˆæœ¬æ—¶ï¼Œè§¦å‘çš„æ“ä½œã€‚ # â€¦spec:updateStrategy:rollingUpdate:partition:3type:RollingUpdate type æŒ‡å®šå‡çº§ç­–ç•¥ updateStrategy ï¼šæŒ‡å®š RollingUpdate æ—¶æ§åˆ¶æ»šåŠ¨å‡çº§è¡Œä¸º ç›®å‰æ”¯æŒä¸¤ç§ç­–ç•¥ï¼š OnDelete ï¼ˆé»˜è®¤ï¼‰ï¼šéœ€è¦å‡çº§æ—¶ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤æ—§ç‰ˆæœ¬ Podï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨åœæ­¢æ—§ç‰ˆæœ¬çš„ Podï¼Œæ‰ä¼šåˆ›å»ºå¯¹åº”æ–°ç‰ˆæœ¬ Podã€‚ RollingUpdate ï¼šè‡ªåŠ¨åˆ é™¤æ—§ç‰ˆæœ¬çš„ Podï¼Œå¹¶åˆ›å»ºæ–°ç‰ˆæœ¬ Podã€‚ç®¡ç†æ–¹å¼ä¾èµ–äº Pod ç®¡ç†ç­–ç•¥ã€‚ 2.5.1 Partitions è®¾ç½® spec.updateStrategy.rollingUpdate.partition å¯ä»¥å¯¹ Pod è¿›è¡Œåˆ†åŒºç®¡ç†ã€‚åªæœ‰åºå·å¤§äºæˆ–ç­‰äºçš„ Pod æ‰ä¼šè¿›è¡Œæ»šåŠ¨å‡çº§ï¼Œå…¶ä»– Pod ä¿æŒä¸å˜ï¼ˆå³ä½¿è¢«åˆ é™¤åé‡æ–°åˆ›å»ºï¼‰ã€‚ # è®¾ç½® partition ä¸º 1 $ kubectl patch statefulset web -p '{\"spec\":{\"updateStrategy\":{\"type\":\"RollingUpdate\",\"rollingUpdate\":{\"partition\":3}}}}' statefulset \"web\" patched # æ›´æ–° StatefulSet $ kubectl patch statefulset web --type='json' -p='[{\"op\":\"replace\",\"path\":\"/spec/template/spec/containers/0/image\",\"value\":\"gcr.io/google_containers/nginx-slim:0.7\"}]' statefulset \"web\" patched # éªŒè¯æ›´æ–°ï¼Œå¯ä»¥çœ‹åˆ°ä» web-1 web-2 éƒ½å‡çº§äº†ï¼Œè€Œ web-0 æ²¡æœ‰å˜åŒ– kubectl get pods -n mytest NAME READY STATUS RESTARTS AGE web-0 1/1 Running 0 3m2s web-1 1/1 Running 0 30s web-2 1/1 Running 0 50s ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:2:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"æ€»ç»“ StatefulSet åœ¨åŸç†ä¸Šè®¾è®¡çš„è®©äººæ„Ÿè§‰å¾ˆä¼˜é›…ï¼Œä»…ä»…ä»å›ºå®šçš„ Pod å‡ºå‘æ¥å®ç° â€œæœ‰çŠ¶æ€â€ è¿™ä¸ªå¤æ‚çš„äº‹æƒ…ã€‚ ä¸è¿‡ä¹Ÿè®¸è¿˜æœ‰å¥½å¤šåœºæ™¯ StatefulSet ä¹Ÿæ— æ³•æ»¡è¶³ï¼Œå¯èƒ½éœ€è¦æ›´å¤šçš„å¼€å‘ã€‚ éœ€è¦å¼„æ¸…æ¥šä»¥ä¸‹å‡ ç‚¹ï¼š ä¸ºäº†éœ€è¦æœ‰çŠ¶æ€åº”ç”¨ å¦‚ä½•ä¸º Pod å®ç°æœ‰çŠ¶æ€ StatefulSet åŸºæœ¬å®šä¹‰ä¸ä½¿ç”¨ StatefulSet çš„ Pod ç®¡ç†ç­–ç•¥ StatefulSet çš„å‡çº§ç­–ç•¥ ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ ã€ŠKubernetes æŒ‡å—ã€‹ ","date":"2021-06-09","objectID":"/posts/cloud_computing/k8s_learning/6-statefulset/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 6 - StatefulSet","uri":"/posts/cloud_computing/k8s_learning/6-statefulset/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚å¿µ åœ¨ API è®¿é—®æ§åˆ¶ ä¸­æåˆ°ï¼ŒKubernetes æ”¯æŒçš„æˆæƒæœºåˆ¶æœ‰å¤šç§ï¼Œå…¶ä¸­ RBAC æ˜¯æœ€å¸¸ç”¨çš„æˆæƒæ–¹å¼ã€‚RBAC åŸºäºè§’è‰²è®¿é—®æ§åˆ¶ï¼Œå…¨ç§° Role-Base Access Controlã€‚ å¯¹äºç†è§£ RBACï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä¸‰ä¸ªå…³é”®çš„æ¦‚å¿µï¼š Role ï¼šè§’è‰²ï¼Œä»£è¡¨ä¸€ç»„å¯¹ Kubernetes API å¯¹è±¡æ“ä½œçš„æƒé™ã€‚ Subject ï¼šè¢«ä½œç”¨è€…ï¼ŒåŒ…æ‹¬ Userã€Groupã€ServiceAccount è§ K8s å­¦ä¹  - API Server è®¤è¯ RoleBinding ï¼šå®šä¹‰ Role ä¸ Subject çš„æ˜ å°„å…³ç³»ï¼› å› æ­¤ï¼Œæˆ‘ä»¬ä¼šé¢„å…ˆåˆ›å»ºä¸€äº› Roleï¼Œç„¶ååˆ›å»º Subject æ—¶ï¼Œå®šä¹‰ RoleBinding æ¥è¡¨æ˜å¯¹ Subject çš„æƒé™æ§åˆ¶ã€‚ ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ é€šè¿‡ RoleBindingï¼Œå®ç°äº† Role Subject ä¹‹é—´çš„è§£è€¦ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Role ä¸ ClusterRole ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 Role Role å°±æ˜¯ä¸€ä¸ª Kubernetes èµ„æºå¯¹è±¡ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ª namespaced Resouceï¼Œå› æ­¤å…¶ Role æ§åˆ¶çš„æƒé™èŒƒå›´ä¹Ÿåªèƒ½æ˜¯æ‰€å±çš„ namespace ä¸‹ã€‚ åŸºæœ¬å®šä¹‰å¦‚ä¸‹ï¼š kind:RoleapiVersion:rbac.authorization.k8s.io/v1metadata:namespace:defaultname:pod-readerrules:- apiGroups:[\"\"]resources:[\"pods\"]verbs:[\"get\",\"watch\",\"list\"] metadata.namespace ï¼šæŒ‡å®š Role æ‰€å±çš„ namespace rules.apiGroups ï¼šè¡¨æ˜é’ˆå¯¹å“ªäº› API Group ç”Ÿæ•ˆï¼Œä¸ºç©ºè¡¨ç¤º core API Groupï¼› rules.resources ï¼šè¡¨æ˜é’ˆå¯¹å“ªäº› Resource ç”Ÿæ•ˆï¼› rules.verbs ï¼šå…è®¸æ‰§è¡Œçš„æ“ä½œï¼› ç¤ºä¾‹ä¸­ rules å®šä¹‰çš„è§„åˆ™å°±æ˜¯ï¼šå…è®¸å¯¹ â€œmynamespaceâ€ ä¸‹çš„æ‰€æœ‰ Pod å¯¹è±¡ï¼Œæ‰§è¡Œ GETã€Watchã€List æ“ä½œã€‚ èƒ½å¤Ÿæ”¯æŒé™åˆ¶çš„æ“ä½œä¸ºï¼šâ€œgetâ€, â€œlistâ€, â€œwatchâ€, â€œcreateâ€, â€œupdateâ€, â€œpatchâ€, â€œdeleteâ€ï¼Œâ€œdeletecollectionâ€ ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 ClusterRole ClusterRole æ˜¯ä¸€ä¸ª non-namespaced Resourceï¼Œæ‰€ä»¥æ˜¯é’ˆå¯¹æ‰€æœ‰ namespace çš„èµ„æºç”Ÿæ•ˆï¼Œä¹Ÿå¯ä»¥å®ç°æ§åˆ¶ non-namespaced Resource çš„æƒé™ã€‚ åŸºæœ¬å®šä¹‰å¦‚ä¸‹ï¼š kind:ClusterRoleapiVersion:rbac.authorization.k8s.io/v1metadata:# \"namespace\" omitted since ClusterRoles are not namespacedname:secret-readerrules:- apiGroups:[\"\"]resources:[\"secrets\"]verbs:[\"get\",\"watch\",\"list\"] rules.apiGroups ï¼šè¡¨æ˜é’ˆå¯¹å“ªäº› API Group ç”Ÿæ•ˆï¼Œä¸ºç©ºè¡¨ç¤º core API Groupï¼› rules.resources ï¼šè¡¨æ˜é’ˆå¯¹å“ªäº› Resource ç”Ÿæ•ˆï¼› rules.verbs ï¼šå…è®¸æ‰§è¡Œçš„æ“ä½œï¼› ç¤ºä¾‹ä¸­ rules å®šä¹‰çš„è§„åˆ™æ˜¯ï¼šå…è®¸å¯¹æ‰€æœ‰ namespace ä¸‹çš„ æ‰€æœ‰ Secret å¯¹è±¡ï¼Œæ‰§è¡Œ GETã€Watchã€List æ“ä½œã€‚ 2.2.1 èšåˆ ClusterRole å¤šä¸ª ClusterRole å¯ä»¥èšåˆä¸ºä¸€ä¸ªæ–°çš„ ClusterRoleï¼Œç”¨äºç®€åŒ– ClusterRole çš„ç®¡ç†å·¥ä½œã€‚ apiVersion:rbac.authorization.k8s.io/v1kind:ClusterRolemetadata:name:monitoringaggregationRule:clusterRoleSelectors:- matchLabels:rbac.example.com/aggregate-to-monitoring:\"true\"rules:[]# rules è§„åˆ™ä¼šè‡ªåŠ¨è¢«è®¾ç½® aggregationRule å­—æ®µè®¾ç½®äº†åŒ¹é… ClusterRole çš„è§„åˆ™ï¼Œå½“ä¸€ä¸ª ClusterRole è¢«åŒ¹é…åˆ°åï¼Œå…¶ rules è‡ªåŠ¨ä¼šå¡«å……ç›¸å…³çš„è§„åˆ™ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 å¯¹éèµ„æºå¯¹è±¡é™åˆ¶ æŸäº› Kubernetes API åŒ…å«ä¸‹æ¬¡å­èµ„æºï¼Œä¾‹å¦‚ Pod çš„æ—¥å¿—ã€‚ # ...rules:- apiGroups:[\"\"]resource:[\"pods\",\"pods/log\"]verbs:[\"get\",\"list\"] ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.4 å¯¹æŒ‡å®šèµ„æºå¯¹è±¡é™åˆ¶ é€šè¿‡ rules.resourceName å­—æ®µå¯ä»¥é™åˆ¶å¯¹æŒ‡å®šèµ„æºçš„æƒé™ï¼š # ...rules:- apiGroups:[\"\"]resource:[\"configmap\"]resourceName:[\"mu-configmap\"]verbs:[\"update\",\"get\"] å½“ç„¶ï¼Œå› ä¸ºæ˜¯å¯¹æŒ‡å®šçš„èµ„æºï¼Œå› æ­¤æ— æ³•é™åˆ¶ listã€watchã€create æˆ– deletecollections æ“ä½œã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.5 å†…ç½® Role ä¸ ClusterRole é»˜è®¤ä¸‹ï¼ŒKubernetes å·²ç»å†…ç½®äº†è®¸å¤šä¸ª Role ä¸ ClusterRoleï¼Œå®ƒä»¬éƒ½æ˜¯ä»¥ system: å¼€å¤´å‘½åã€‚ æ‰€æœ‰ç³»ç»Ÿé»˜è®¤çš„ ClusterRole å’Œ RoleBinding éƒ½ä¼šä½¿ç”¨ label kubernetes.io/bootstrappiong=rbac-defaults æ¥æ ‡è®°ã€‚ æ¯æ¬¡é›†ç¾¤å¯åŠ¨æ—¶ï¼ŒAPIServer ä¼šæ›´æ–°é»˜è®¤çš„é›†ç¾¤ Role ç¼ºå¤±çš„æƒé™ï¼Œä¹Ÿä¼šæ›´æ–°é»˜è®¤ Role ç»‘å®šçš„ Subjectã€‚è¿™æ ·å¯ä»¥é˜²æ­¢ä¸€äº›ç ´åæ€§çš„æ›´æ”¹ï¼Œä¿è¯é›†ç¾¤å‡çº§æƒ…å†µä¸‹ç›¸å…³å†…å®¹èƒ½å¤ŸåŠæ—¶æ›´æ–°ã€‚ ä½¿ç”¨å†…ç½® Role ä¸ ClusterRole å·²ç»å®Œå…¨å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„ä½¿ç”¨åœºæ™¯ã€‚ å†…ç½®çš„ Role çš„å«ä¹‰è§ Default roles and role bindingsã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:2:5","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 RoleBinding ä¸ ClusterRoleBinding ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 RoleBinding RoleBinding ç”¨äºç»‘å®šä¸€ä¸ª Role ä¸å¤šä¸ª Subjectï¼Œé€šè¿‡ RoleBinding æ‰èƒ½è®©æŸä¸ª Subject æœ‰ namespace ç›¸å…³èµ„æºçš„è®¿é—®æƒé™ã€‚ # This role binding allows \"jane\" to read pods in the \"default\" namespace.kind:RoleBindingapiVersion:rbac.authorization.k8s.io/v1metadata:name:read-podsnamespace:defaultsubjects:- kind:Username:janeapiGroup:rbac.authorization.k8s.io- kind:ServiceAccountname:defaultroleRef:kind:Rolename:pod-readerapiGroup:rbac.authorization.k8s.io Tip RoleBinding ä¹Ÿå¯ä»¥å¼•ç”¨ ClusterRoleï¼Œå°†å…¶æƒé™é™åˆ¶åœ¨äº† RoleBinding æ‰€å±çš„ namespace ä¸‹ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 ClusterRoleBinding ClusterRoleBinding è®© Subject æœ‰ç€æ•´ä¸ªé›†ç¾¤ç›¸å…³èµ„æºçš„è®¿é—®æƒé™ã€‚ 3.2.1 ClusterRole èšåˆ åœ¨ ClusterRole ä¸­å¯ä»¥é€šè¿‡ aggregationRule æ¥ä¸å…¶ä»– ClusterRoleï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è‡ªåŠ¨ç»„åˆå¤šä¸ª ClusterRole ä¸ºä¸€ä¸ªã€‚ kind:ClusterRoleapiVersion:rbac.authorization.k8s.io/v1metadata:name:monitoringaggregationRule:# é€šè¿‡ label selector æ–¹å¼è‡ªåŠ¨ç»„åˆclusterRoleSelectors:- matchLabels:rbac.example.com/aggregate-to-monitoring:\"true\"rules:[]# Rules ç”±ç»„åˆèµ·æ¥çš„ ClusterRole è‡ªåŠ¨å¡«å……---kind:ClusterRoleapiVersion:rbac.authorization.k8s.io/v1metadata:name:monitoring-endpointslabels:rbac.example.com/aggregate-to-monitoring:\"true\"# These rules will be added to the \"monitoring\" role.rules:- apiGroups:[\"\"]resources:[\"services\",\"endpoints\",\"pods\"]verbs:[\"get\",\"list\",\"watch\"] ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ å®˜æ–¹æ–‡æ¡£ï¼šä½¿ç”¨ RBAC é‰´æƒ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/5-rbac/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 5 - RBAC æˆæƒæœºåˆ¶","uri":"/posts/cloud_computing/k8s_learning/5-rbac/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"PV PVC StorageClass æ¦‚å¿µä¸ä½¿ç”¨","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 PV PVPersistent Volume ä»£è¡¨ä¸€ä¸ªå®é™…å¯ç”¨çš„åç«¯å­˜å‚¨ï¼ˆä¹Ÿå¯èƒ½ä¸æ˜¯åç«¯ï¼Œè€Œæ˜¯ Local PVï¼‰ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒPV æ˜¯ä¸€ä¸ªç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæˆ–è€…äº‘å‚å•†çš„äº‘ç›˜ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 PV çš„å®šä¹‰ PV çš„å®šä¹‰ä»…ä»…æè¿°äº†å­˜å‚¨çš„å±æ€§ï¼š apiVersion:v1kind:PersistentVolumemetadata:name:pv0003spec:capacity:storage:5GivolumeMode:FilesystemaccessModes:- ReadWriteOncepersistentVolumeReclaimPolicy:RecyclestorageClassName:slowmountOptions:- hard- nfsvers=4.1nfs:path:/tmpserver:172.17.0.2 capacityï¼šæè¿°å­˜å‚¨çš„å¤§å°ï¼› volumeModeï¼šå­˜å‚¨çš„ä½¿ç”¨ç±»å‹ï¼ŒåŒ…æ‹¬ï¼š Filesystem æ–‡ä»¶ç³»ç»Ÿï¼šä½¿ç”¨æ—¶ä¼šé€šè¿‡ Mount æŒ‚è½½åˆ° Pod æŸä¸ªç›®å½•ã€‚ä¹Ÿæ”¯æŒè‡ªåŠ¨ä¸º device åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ Block å—è®¾å¤‡ï¼šé€šè¿‡ device æ–¹å¼æä¾›ç»™ Pod accessModes ï¼šè®¾å¤‡åœ¨å®é™…ä½¿ç”¨æ—¶ä¼šå…ˆ mount åˆ°å®¿ä¸»æœºä¸Šï¼ŒaccessMode å†³å®šäº†æ˜¯å¦å…è®¸å¤šèŠ‚ç‚¹å¤ç”¨ï¼Œå¹¶å…¶è¯»å†™æƒé™ï¼ŒåŒ…æ‹¬ï¼š ReadWriteOnceï¼šåªå…è®¸ä¸€ä¸ªèŠ‚ç‚¹æŒ‚è½½ä½¿ç”¨ï¼Œå¹¶æä¾›è¯»å†™ï¼› ReadOnlyManyï¼šå…è®¸å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ä½¿ç”¨ï¼Œæä¾›è¯»æƒé™ï¼› ReadWriteManyï¼šå…è®¸å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ä½¿ç”¨ï¼Œæä¾›è¯»å†™æƒé™ï¼› ä¸åŒçš„ PV ç±»å‹å¯¹å…¶ accessMode æ”¯æŒç¨‹åº¦ä¸åŒï¼Œå…·ä½“è§ AccessModeã€‚ storageClassName ï¼šæŒ‡å®šå…¶æ‰€å±çš„ StorageClassã€‚ ä¹Ÿå¯ä»¥ä¸æŒ‡å®š StorageClassï¼Œé‚£ä¹ˆåªæœ‰ä¸æŒ‡å®š class çš„ PVC æ‰å¯ä»¥ç»‘å®šè¯¥ PVã€‚ persistentVolumeReclaimPolicy ï¼šReclaimPolicy æŒ‡å®šäº†å½“å…¶ç»‘å®šçš„ PVC åˆ é™¤æ—¶ï¼Œè¯¥å¦‚ä½•å¤„ç† PVã€‚ ç›®å‰çš„å›æ”¶ç­–ç•¥åŒ…æ‹¬ï¼š Retain ï¼šä¿ç•™ PVï¼ŒPV ä¼šå˜ä¸º Released çŠ¶æ€ï¼› Recycle ï¼šè‡ªåŠ¨åˆ é™¤ PV æ•°æ®ï¼› Delete ï¼šåŒæ—¶åˆ é™¤åç«¯ç£ç›˜ï¼ˆAWS EBSã€GCE PD ç­‰äº‘ç›˜ä¹Ÿä¼šè¢«åˆ é™¤ï¼‰ï¼› ç›®å‰ï¼ŒNFS å’Œ HostPath ç±»å‹çš„ PV ä»…ä»…æ”¯æŒ Recycleï¼Œäº‘å‚å•†ç£ç›˜å¯ä»¥æ”¯æŒ Deleteã€‚ mountOptions ï¼šå½“ PV æŒ‚è½½åˆ°èŠ‚ç‚¹ä¸Šæ—¶ï¼Œæ·»åŠ çš„é™„åŠ é€‰é¡¹ã€‚ é’ˆå¯¹ä¸åŒç±»å‹çš„ PVï¼Œè¿™ä¸ªé€‰é¡¹æ˜¯ä¸åŒçš„ï¼Œå…·ä½“è§ Mount Pointsã€‚ nodeAffinity ï¼šPV å¯ä»¥è®¾å®šèŠ‚ç‚¹äº²å’Œæ€§ï¼Œæ¥é™åˆ¶åªæœ‰ç‰¹å®šçš„èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨å…¶ PVã€‚ Note nodeAffinity åœ¨ä½¿ç”¨ Local PV æ—¶å¿…å®šè¦ä½¿ç”¨ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.2 PV ç”Ÿå‘½å‘¨æœŸ PV ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ 5 ä¸ªé˜¶æ®µï¼š Provisioning ï¼šå³ PV çš„åˆ›å»ºï¼Œå¯ä»¥ç›´æ¥åˆ›å»º PVï¼ˆé™æ€æ–¹å¼ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ StorageClass åŠ¨æ€åˆ›å»ºï¼› Binding ï¼šå°† PV åˆ†é…ç»™ PVCï¼› Using ï¼šPod é€šè¿‡ PVC ä½¿ç”¨è¯¥ Volumeï¼Œå¹¶å¯ä»¥é€šè¿‡å‡†å…¥æ§åˆ¶ StorageObjectInUseProtection é˜»æ­¢åˆ é™¤æ­£åœ¨ä½¿ç”¨çš„ PVCï¼› Releasing ï¼šPod é‡Šæ”¾ Volume å¹¶åˆ é™¤ PVCï¼› Reclaiming ï¼šå›æ”¶ PVï¼Œå¯ä»¥ä¿ç•™ PV ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä»äº‘å­˜å‚¨ä¸­åˆ é™¤ï¼› Deleting ï¼šåˆ é™¤ PV å¹¶ä»äº‘å­˜å‚¨ä¸­åˆ é™¤åæ®µå­˜å‚¨ï¼› å¯¹åº” 5 ä¸ªé˜¶æ®µï¼Œä¸€ä¸ª PV å¯èƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ï¼š Availableï¼šPV å·²ç»åˆ›å»ºï¼Œå¹¶ä¸”æ²¡æœ‰ PVC ç»‘å®šï¼› Boundï¼šPVC ç»‘å®šäº†è¯¥ PVï¼› Releasedï¼šPVC å·²ç»è¢«åˆ é™¤ï¼Œè€Œè¯¥ PV è¿˜æ²¡æœ‰è¢«å›æ”¶ï¼› Failedï¼šPV è‡ªåŠ¨å›æ”¶å¤±è´¥ï¼› ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 PVC PVCPersistent Volume Claim æè¿°ä¸€ä¸ª Pod å¯¹ PV çš„éœ€æ±‚ï¼Œæ˜¯åŸºäº namespace ä¸‹çš„ã€‚ ä¸ºä»€ä¹ˆéœ€è¦ PV PVCï¼Ÿ æ„Ÿè§‰è¿˜æ˜¯ä¸ºäº†è§£è€¦ï¼Œè§£è€¦ä½¿å¾— Pod ä¸å­˜å‚¨å½¢æˆäº†å¤šå¯¹å¤šçš„å…³ç³»ã€‚ æœ€ç›´è§‚çš„å¥½å¤„ï¼Œä¸€ä¸ª PV å¯ä»¥é€šè¿‡å¤šä¸ª PVC è¿›è¡Œç»‘å®šï¼Œä½¿å¾—æ•°æ®å¯ä»¥è¢«å¤šä¸ª Pod å…±äº«ä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥é¢„å®šä¹‰å¤šä¸ª PVï¼Œè€Œé€šè¿‡ PVC å¯ä»¥ç›´æ¥ç”±è°ƒåº¦å»é€‰æ‹©åˆé€‚çš„ PV è¿›è¡Œç»‘å®šã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 PVC å®šä¹‰ 2.1.1 Spec PVC å®šä¹‰ä¸­ä¸»è¦æ˜¯æè¿°äº†å¯¹ PV çš„éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰è°ƒåº¦å¦‚ä½•é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ PVã€‚ apiVersion:v1kind:PersistentVolumeClaimmetadata:name:myclaimspec:accessModes:- ReadWriteOncevolumeMode:FilesystemvolumeName:foo-pvresources:requests:storage:8GistorageClassName:slow # æŒ‡å®šç»‘å®šçš„ StorageClassselector:matchLabels:release:\"stable\"matchExpressions:- {key: environment, operator: In, values:[dev]} accessModes ï¼šè®¿é—®æ¨¡å¼ï¼Œä¸ PV çš„è®¿é—®æ¨¡å¼è¦åŒ¹é… volumeMode ï¼šä½¿ç”¨æ¨¡å¼ï¼Œä¸ PV çš„è®¿é—®æ¨¡å¼è¦åŒ¹é… volumeName ï¼šæŒ‡å®šç»‘å®šçš„ PV nameï¼Œæˆ–è€… Bind åä¹Ÿä¼šå¡«å……ä¸ºå¯¹åº”çš„ PV name resources ï¼šPod æ‰€éœ€æ±‚çš„èµ„æº selectorï¼šè¿›ä¸€æ­¥æ¥è¿‡æ»¤é€‰æ‹©çš„ PVï¼Œåªæœ‰æ»¡è¶³åŒ¹é…æ¡ä»¶çš„ PV æ‰å¯ä»¥è¢«ç»‘å®š storageClassName ï¼šæŒ‡å®šæ‰€å±çš„ StorageClassï¼Œåªæœ‰ç›¸åŒ StorageClass çš„ PV PVC æ‰å¯ä»¥ç»‘å®š å¦‚æœæ²¡æœ‰æŒ‡å®š StorageClassï¼Œå¦‚æœç³»ç»Ÿè®¾ç½®äº† Default StorageClass åˆ™ä½¿ç”¨ï¼Œå¦åˆ™åªèƒ½ç»‘å®šæ²¡æœ‰è®¾ç½® StorageClass çš„ PVã€‚ ä¸æŒ‡å®š StorageClass åœ¨æ²¡æœ‰æŒ‡å®š storageClassName ä¸‹ï¼Œè¡Œä¸ºæ˜¯æœ‰å¤šç§æƒ…å†µçš„ï¼Œè§ Classã€‚ 2.1.2 Status status:accessModes:- ReadWriteOncecapacity:storage:446Giphase:Bound accessModes ï¼šè®¿é—®æ¨¡å¼ capacity ï¼šå¯ä½¿ç”¨çš„å®¹é‡ phase ï¼šPVC çš„é˜¶æ®µï¼ŒåŒ…æ‹¬ï¼š Pending ï¼šæ²¡æœ‰ç»‘å®š PVï¼› Bound ï¼šå·²ç»ç»‘å®šåˆ° PVï¼› Lost ï¼šå·²ç»ç»‘å®šåˆ° PVï¼Œä½†æ˜¯ PV ä¸¢å¤±äº†ï¼› ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 PVC çš„ä½¿ç”¨ åœ¨ Pod å®šä¹‰æˆ–è€… Pod template ä¸­ï¼Œä½¿ç”¨ pvc ç±»å‹ volume æ¥æŒ‡å®šä½¿ç”¨çš„ PVCã€‚ apiVersion:v1kind:Podmetadata:name:mypodspec:containers:- name:myfrontendimage:nginxvolumeMounts:# æ·»åŠ  volume æŒ‚è½½- mountPath:\"/var/www/html\"name:mypdvolumes:- name:mypd # volume ç±»å‹ä¸º PVCpersistentVolumeClaim:claimName:myclaim # æŒ‡å®šä½¿ç”¨çš„ PVC ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 StorageClass PV çš„åˆ›å»ºæ–¹æ³•æœ‰ä¸¤ç§ï¼š é™æ€åˆ›å»ºStatic Provisionï¼Œç”±ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºæ‰€æœ‰æ”¯æŒçš„ PVï¼› åŠ¨æ€åˆ›å»ºDynamic Provisionï¼Œå®šä¹‰ StorageClassï¼ŒæŒ‰ PVC æ¥åˆ›å»ºåˆé€‚çš„ PVï¼› æ‰€ä»¥æ˜ç¡®ï¼ŒStorageClass æ˜¯æ ¹æ® PVCï¼Œæ¥åˆ›å»º/å›æ”¶ PV çš„ã€‚ è€Œåˆ›å»ºä¸å›æ”¶çš„ Driver å°±ç§°ä¸º Provisionerï¼Œä¸åŒç±»å‹çš„ PV çš„åˆ›å»ºä¸å›æ”¶æ–¹å¼éƒ½æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥æœ‰ç€è®¸å¤šçš„ Provisioner å®ç°ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 StorageClass å®šä¹‰ StorageClass ä¸­å¤§å¤šæ•°å±æ€§æ˜¯å…¶åˆ›å»ºå‡º PV çš„æ¨¡æ¿ã€‚ apiVersion:storage.k8s.io/v1kind:StorageClassmetadata:name:standardprovisioner:kubernetes.io/aws-ebs # æŒ‡å®š Provisionerparameters:type:gp2reclaimPolicy:RetainallowVolumeExpansion:truemountOptions:- debugvolumeBindingMode:Immediate provisioner ï¼šæŒ‡å®š Provisioner çš„å®ç°ï¼Œè¿™ä¹Ÿå°±å†³å®šäº†å…¶åˆ›å»º PV çš„ç±»å‹ã€‚ å…¶å†…ç½®æ”¯æŒçš„ Provisioner è§ provisionerã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ Provisionerã€‚ reclaimPolicy ï¼šé’ˆå¯¹ PV çš„å›æ”¶ç­–ç•¥ï¼Œè¿™ä¹Ÿå°±å†³å®šäº†å…¶åˆ›å»º PV çš„å›æ”¶ç­–ç•¥ã€‚é»˜è®¤ä¸º Deleteã€‚ allowVolumeExpansion ï¼šæ˜¯å¦å…è®¸é€šè¿‡ä¿®æ”¹ PVC å¯¹è±¡çš„å±æ€§ï¼Œæ¥å¯¹ä½¿ç”¨çš„ PV è¿›è¡Œæ‰©å®¹ã€‚ å¤§å¤šæ•°äº‘å­˜å‚¨éƒ½æ”¯æŒè¯¥é€‰é¡¹ï¼Œå…·ä½“è§ allow-volume-expansionã€‚ mountOptions ï¼šæŒ‡å®šå…¶åˆ›å»ºçš„ PV çš„ Mount Optionsã€‚ volumeBindingMode ï¼šå†³å®šäº†ä½•æ—¶è¿›è¡Œå°† PV mount åˆ°èŠ‚ç‚¹ä¸Šã€‚ Immediate è¡¨æ˜ä¸€æ—¦åˆ›å»º PVC åï¼Œå°±éœ€è¦ç»‘å®š PVã€‚ WaitForFirstConsumer å°† PV ä¸ PVC çš„ç»‘å®šå»¶åï¼Œç­‰åˆ° Pod åˆ›å»ºå¹¶ä½¿ç”¨ PVC æ—¶ï¼Œæ‰ä¼šå»ç»‘å®šå¯¹åº”çš„ PVã€‚ Local PV å¿…é¡»ä½¿ç”¨ WaitForFirstConsumer å› ä¸º Local PV åªæœ‰ç­‰åˆ° Pod åˆ›å»ºå¹¶è°ƒåº¦æ—¶ï¼Œæ‰èƒ½å†³å®šä½¿ç”¨æœ¬åœ°çš„ PVï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨ WaitForFirstConsumerã€‚ allowedTopologies ï¼šåœ¨ä½¿ç”¨äº‘æœåŠ¡çš„å­˜å‚¨æ—¶ï¼Œå…¶ PV æ˜¯æœ‰ â€œè®¿é—®ä½ç½®â€ï¼ˆæ‹“æ‰‘åŸŸï¼‰ çš„é™åˆ¶çš„ï¼Œè€Œå°±éœ€è¦æ»¡è¶³èŠ‚ç‚¹ä¸Šçš„ Pod ä»…ä»…ä½¿ç”¨ç‰¹å®šä½ç½®çš„ PVã€‚ æ‰€ä»¥åœ¨ WaitForFirstConsumer æ¨¡å¼ä¸‹ï¼Œé€šè¿‡ allowedTopologies ä½¿å¾—ä»…ä»…åœ¨ç‰¹å®šçš„ä½ç½®æ¥åˆ›å»º PVï¼Œä»è€ŒèŠ‚ç‚¹çš„ Pod å¯ä»¥æ­£å¸¸çš„è®¿é—® PVã€‚ parameters ï¼šæä¾›ç»™ Provisioner åˆ›å»º PV çš„å‚æ•°ï¼Œæœ€å¤šæ”¯æŒ 512 ä¸ªå‚æ•°ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡ 256KiBã€‚ ä¸åŒ Provisioner æ”¯æŒä¸åŒå‚æ•°ï¼Œè§ parametersã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 PV PVC StorageClass ä¹‹é—´çš„å…³ç³» ä¸‹é¢ä¸€å¼ å›¾æè¿°äº† PV PVC StorageClass ä¹‹é—´çš„å…³ç³»ï¼š ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5 Local PV ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.1 æ‰‹åŠ¨åˆ›å»ºä½¿ç”¨ LocalPV åœ¨è‡ªå·±æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œå¾€å¾€æ²¡æœ‰ä¸€ä¸ªäº‘å­˜å‚¨å¯ä»¥ä½œä¸º PV ä½¿ç”¨ï¼Œè€Œä½¿ç”¨ Local PVï¼Œä½¿å¾— Pod ä½¿ç”¨çš„ PV æ¥è‡ªäºæœ¬åœ°çš„ç›®å½•æˆ–è€…å—è®¾å¤‡ã€‚ å…ˆæ˜ç¡® Local PV å¦‚ä½•å®šä¹‰ï¼Œå³ PV ç±»å‹ä¸º hostPathï¼Œè¡¨æ˜å®é™…å­˜å‚¨è®¾å¤‡æ¥è‡ªäºå®¿ä¸»æœºçš„ä¸€ä¸ªç›®å½•ã€‚ åŒæ—¶ï¼Œåªæœ‰è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹çš„ Pod æ‰èƒ½ä½¿ç”¨è¿™ä¸ª PVï¼Œæ‰€ä»¥è¦è®¾å®š PV çš„ spec.nodeAffinityï¼Œä»…ä»…å…è®¸è¯¥èŠ‚ç‚¹ä½¿ç”¨è¯¥ PVï¼š apiVersion:v1kind:PersistentVolumemetadata:name:example-pvspec:capacity:storage:5GivolumeMode:FilesystemaccessModes:- ReadWriteOncepersistentVolumeReclaimPolicy:DeletestorageClassName:local-storage # æŒ‡å®š storageClassNamelocal:# local ç±»å‹è¡¨æ˜ä½¿ç”¨ Local PVpath:/mnt/disks/vol1nodeAffinity:# è®¾å®šèŠ‚ç‚¹äº²å’Œæ€§ï¼Œä½¿å¾—åªèƒ½æœ¬åœ°èŠ‚ç‚¹ä½¿ç”¨ PVrequired:nodeSelectorTerms:- matchExpressions:- key:kubernetes.io/hostnameoperator:Invalues:- node-1 # ä»…ä»…å…è®¸ node-1 ä½¿ç”¨è¯¥ PV è€Œä¸ºäº†è®© PVC ä¸ PV ç»‘å®šæ¨è¿Ÿåˆ° Pod åˆ›å»ºåæ‰å†³å®šç»‘å®šçš„ PVï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª StorageClassï¼Œå³ä½¿å…¶å¹¶ä¸èƒ½å¤Ÿæ”¯æŒåŠ¨æ€åˆ›å»º PVï¼š kind:StorageClassapiVersion:storage.k8s.io/v1metadata:name:local-storageprovisioner:kubernetes.io/no-provisioner # no-provisioner ä¸æ”¯æŒåŠ¨æ€åˆ›å»º PVvolumeBindingMode:WaitForFirstConsumer # è®© PVC ç»‘å®šæ¨è¿Ÿ è€Œåœ¨ä½¿ç”¨æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªæ™®é€šçš„ PVCï¼ŒæŒ‡å®šå¥½ spec.storageClassName åï¼Œå°±å¯ä»¥ä½¿ç”¨ LocalPV äº†ã€‚ kind:PersistentVolumeClaimapiVersion:v1metadata:name:example-local-claimspec:accessModes:- ReadWriteOnceresources:requests:storage:5GistorageClassName:local-storage # æŒ‡å®š StorageClassï¼Œæ¥ç»‘å®š PV ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:5:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5.2 local pv static provisioner local pv static provisioner å°†ä¸Šé¢çš„æ­¥éª¤è¿›è¡Œäº†ç®€åŒ–ï¼Œå…¶å¯åŠ¨äº†ä¸€ä¸ª DaemonSetï¼Œæ ¹æ®é…ç½®å¥½çš„ç›®å½•ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”ç›®å½•çš„ Local PVã€‚ æ‰€ä»¥å¸¦æ¥çš„å¥½å¤„å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸ºä¸€ä¸ªä¸ªèŠ‚ç‚¹å»åˆ›å»ºå¯¹åº”çš„ PV äº†ï¼Œæœ‰ Pod è‡ªåŠ¨è´Ÿè´£è¯¥äº‹ã€‚ 5.2.1 åŸç† local pv static provisioner ä¸ºåˆ›å»ºä¸€ä¸ª DamonSetï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹åˆ›å»º Daemon Podã€‚ æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ Daemon Pod ä¼šæ ¹æ®å…¶ ConfigMap é…ç½®å¥½çš„ discovery dirï¼Œåœ¨ç›®ä¸‹æŸ¥æ‰¾å¯ä»¥ä½œä¸º PV çš„å­ç›®å½•ã€‚ åœ¨ discovery dir ä¸‹æŒ‘é€‰ç›®å½•æœ‰ä¸¤ä¸ªæ¡ä»¶ï¼š ç›®å½•å¿…é¡»æ˜¯ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œä¹Ÿå°±æ˜¯ mountinfo ä¸­å¯ä»¥çœ‹åˆ°çš„ï¼› ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯æŒ‚è½½ç‚¹ï¼Ÿ æˆ‘çŒœæµ‹è¿™æ˜¯ä¸ºäº†é€šè¿‡æŒ‚è½½ç‚¹å¾—åˆ°ç›®å½•å®¹é‡å¤§å°ï¼Œä»è€Œå¡«å…… PV å®¹é‡ç›¸å…³å±æ€§ã€‚ æ»¡è¶³å…¶ ConfigMap ä¸­æŒ‡å®šçš„ç›®å½•åŒ¹é…æ–¹å¼ namePatternã€‚ 5.2.2 ç¤ºä¾‹ è€Œä¸ºäº†ä½¿ç”¨ LocalPVï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å®šä¹‰ä¸€ä¸ª StorageClassï¼Œè®©åˆ›å»ºå‡ºçš„ LocalPV èƒ½å¤Ÿå±äºæ­£ç¡®çš„ StorageClassã€‚ æ‰€ä»¥ä½¿ç”¨çš„æ­¥éª¤ä¸ºï¼š æ¯ä¸ªèŠ‚ç‚¹ä¸Šå‡†å¤‡ä½œä¸º LocalPV çš„ç›®å½•ï¼Œè¯¥ç›®å½•å¿…é¡»æ˜¯ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œä¸”ä½äº discovery dir ä¸‹ï¼› åˆ›å»º StorageClassï¼Œä½œä¸ºåç»­åˆ›å»ºå‡ºçš„ Local PV çš„ StorageClassï¼› å®šä¹‰å¹¶åˆ›å»º ConfigMapï¼Œä¸ºäº†å°†ç›¸å…³çš„ä¿¡æ¯ä¼ é€’ç»™ provisioner çš„ DaemonSet Podï¼› å®šä¹‰å¹¶åˆ›å»º ServiceAccountï¼Œå› ä¸ºåç»­çš„ Daemon Pod éœ€è¦åˆ›å»º Local PV ç»“æ„ï¼Œæ‰€ä»¥éœ€è¦ç›¸å…³çš„æƒé™ï¼› å®šä¹‰å¹¶åˆ›å»º DaemonSetï¼Œæ ¹æ® config map ä¿¡æ¯ï¼Œå…¶ Pod é‡Œç¨‹åºä¼šè‡ªåŠ¨åˆ›å»º Local PVï¼Œå…¶å®šä¹‰å°±ä¸ä¸Šè¿°çš„ PV ä¸€è‡´ï¼› çœ‹ä¸€ä¸‹å…¶ StorageClassã€ConfigMap å’Œ DaemonSet å®šä¹‰ï¼š apiVersion:storage.k8s.io/v1kind:StorageClassmetadata:name:fast-disks # name è¦ä¸ä¸‹é¢ ConfigMap ç›¸åŒprovisioner:kubernetes.io/no-provisionervolumeBindingMode:WaitForFirstConsumerreclaimPolicy:Delete # æ”¯æŒ Delete Retain---apiVersion:v1kind:ConfigMapmetadata:name:local-provisioner-config namespace:default data:storageClassMap:| fast-disks:# ä¸Šé¢åˆ›å»ºçš„ StorageClass åå­—hostDir:/mnt/fast-disks # å®¿ä¸»æœº discovery dirmountDir:/mnt/fast-disks # Daemon Pod ä¸­æŸ¥æ‰¾çš„ discover dirblockCleanerCommand:- \"/scripts/shred.sh\"- \"2\"volumeMode:FilesystemfsType:ext4namePattern:\"*\"# æŸ¥æ‰¾å­ç›®å½•çš„åŒ¹é…æ–¹å¼---apiVersion:apps/v1kind:DaemonSetmetadata:name:local-volume-provisionernamespace:defaultlabels:app:local-volume-provisionerspec:selector:matchLabels:app:local-volume-provisioner template:metadata:labels:app:local-volume-provisionerspec:serviceAccountName:local-storage-admincontainers:- image:\"k8s.gcr.io/sig-storage/local-volume-provisioner:v2.4.0\"imagePullPolicy:\"Always\"name:provisioner securityContext:privileged:trueenv:- name:MY_NODE_NAMEvalueFrom:fieldRef:fieldPath:spec.nodeNamevolumeMounts:- mountPath:/etc/provisioner/config name:provisioner-configreadOnly:true- mountPath:/mnt/fast-disks name:fast-disksmountPropagation:\"HostToContainer\"volumes:- name:provisioner-config # èƒ½å¤Ÿè®¿é—®åˆ° ConfigMapconfigMap:name:local-provisioner-config - name:fast-disks # èƒ½å¤ŸæŸ¥çœ‹åˆ° discovery dirhostPath:path:/mnt/fast-disks ç­‰åˆ°è‡ªåŠ¨åˆ›å»ºå‡º Local PV åï¼Œåç»­çš„æµç¨‹å…¶å®å°±æ˜¯ä½¿ç”¨ä¸€ä¸ª Local PV çš„æµç¨‹äº†ã€‚ ","date":"2021-06-08","objectID":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/:5:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 4 - PV PVC StorageClass","uri":"/posts/cloud_computing/k8s_learning/4-pv-pvc-storageclass/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 Pod çš„ DNS ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 Pod çš„ DNS åŸŸå å¯¹æ¯ä¸ª Pod æ¥è¯´ï¼ŒCoreDNS ä¼šä¸ºå…¶è®¾ç½®ä¸€ä¸ª \u003cpod_ip\u003e.\u003cnamespace\u003e.pod.\u003cclust-domain\u003e æ ¼å¼çš„ DNS åŸŸåã€‚ # è®¿é—® POD IP DNS $ nslookup 192-168-166-168.tidb-cluster-dev.pod.cluster.local Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: 192-168-166-168.tidb-cluster-dev.pod.cluster.local Address 1: 192.168.166.168 my-tidb-cluster-dev-tidb-0.my-tidb-cluster-dev-tidb-peer.tidb-cluster-dev.svc.cluster.local å¯¹äº Deployment æˆ– DaemonSet ç±»å‹åˆ›å»ºçš„ Podï¼ŒCoreDNS ä¼šä¸ºå…¶ç®¡ç†çš„æ¯ä¸ª Pod è®¾ç½®ä¸€ä¸ª \u003cpod_ip\u003e.\u003cdepolyment/daemonset_name\u003e.svc.\u003ccluster_domain\u003e æ ¼å¼çš„ DNS åŸŸåã€‚ ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.2 è‡ªå®šä¹‰ hostname å’Œ subdomain é»˜è®¤æƒ…å†µä¸‹ï¼ŒPod å†…å®¹å™¨çš„ hostname è¢«è®¾ç½®ä¸º Pod çš„åç§°ã€‚å› æ­¤ï¼Œä½¿ç”¨å‰¯æœ¬æ§åˆ¶å™¨æ—¶ Pod åç§°ä¼šåŒ…å«éšæœºä¸²ï¼Œå› æ­¤ hostname æ— æ³•å›ºå®šã€‚ å¯ä»¥é€šè¿‡ spec.hostname å­—æ®µå®šä¹‰å®¹å™¨ç¯å¢ƒçš„ hostnameï¼Œé€šè¿‡ spec.subdomain å­—æ®µå®šä¹‰å®¹å™¨ç¯å¢ƒçš„å­åŸŸåã€‚ spec:hostname:webapp-1subdomain:mysubdomain Pod åˆ›å»ºæˆåŠŸåï¼ŒKubernetes ä¸ºå…¶è®¾ç½® DNS åŸŸåä¸º \u003chostname\u003e.\u003csubdomain\u003e.\u003cnamespace\u003e.svc.\u003ccluster_domain\u003eã€‚è¿™æ—¶é€šè¿‡éƒ¨ç½²ä¸€ä¸ª Headless Service å°±å¯ä»¥åœ¨ DNS æœåŠ¡å™¨ä¸­è‡ªåŠ¨åˆ›å»ºå¯¹åº” DNS è®°å½•ã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡è¯¥ DNS åŸŸåæ¥è®¿é—® Podã€‚ å®é™…ä¸Šï¼ŒStatefulSet å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥ä½¿ç”¨ Headless Service çš„ã€‚æŸ¥çœ‹ä¸€ä¸ª StatefulSet ç®¡ç†çš„ Podï¼š $ kubectl get po my-tidb-cluster-dev-pd-0 -o yaml# ...spec:hostname:my-tidb-cluster-dev-pd-0# å›ºå®š pod çš„ hostnamesubdomain:my-tidb-cluster-dev-pd-peer # åœ¨ StatefulSet ä¸­å®šä¹‰çš„ Headless Service name ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.3 è‡ªå®šä¹‰ DNS é…ç½® é€šè¿‡ Pod å®šä¹‰ä¸­çš„ spec.dnsPolicy å¯ä»¥å®šä¹‰ä½¿ç”¨çš„ DNS ç­–ç•¥ã€‚ ç›®å‰åŒ…å«ä»¥ä¸‹çš„ DNS ç­–ç•¥ï¼š Default ï¼šä» Node ç»§æ‰¿ DNS ClusterFirst ï¼šä¸é…ç½®çš„é›†ç¾¤ domain åç¼€ä¸åŒ¹é…çš„ DNS æŸ¥è¯¢ï¼Œéƒ½ä¼šè½¬å‘åˆ°ä» Node ç»§æ‰¿çš„ä¸Šæ¸¸æœåŠ¡å™¨ ClusterFirstWithHostNet ï¼šå¦‚æœ Pod ä½¿ç”¨ hostNetwork è¿è¡Œï¼ŒDNS åº”è¯¥ä½¿ç”¨ host None ï¼šå¿½ç•¥ Kubernetes DNS è®¾ç½®ï¼Œç”±ç”¨æˆ·é€šè¿‡ spec.dnsConfig å­—æ®µè¿›è¡Œé…ç½® é€šè¿‡ spec.dnsConfig å­—æ®µè¿›è¡Œæ›´åŠ ç»†èŠ‚çš„ DNS ç›¸å…³é…ç½®ã€‚ spec:dnsPolicy:\"None\"dnsConfig:nameservers:- 8.8.8.8searches:- ns1.svc.cluster-domain.example- my.dns.search.suffixoptions:- name:ndotsvalue:\"2\"- name:edns0 Pod åˆ›å»ºåï¼Œå®¹å™¨å†…çš„ /etc/resolv.conf æ–‡ä»¶ä¼šè¢«è®¾ç½®ï¼š nameserver 8.8.8.8 search ns1.svc.cluster-domain.example my.dns.search.suffix option natods:2 eth0 ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:1:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Service ä¸­çš„ DNS Service DNS ç›¸å…³å·²ç»åœ¨ Service ä¸€æ–‡ä¸­è¯´æ˜ï¼Œè¿™é‡Œä»…ä»…ç®€å•æåŠä¸€ä¸‹ã€‚ æ¯ä¸ª Service ä¼šè‡ªåŠ¨å¯¹åº”ä¸€ä¸ª DNS åŸŸåï¼Œå‘½åæ–¹å¼ä¸º \u003cservice\u003e.\u003cnamespace\u003e.svc.\u003ccluster_domain\u003eï¼Œcluster_domain é»˜è®¤ä¸º cluster.localã€‚ é€šè¿‡æ”¹å˜ namespace å¯ä»¥è®¿é—®ä¸åŒ namespace ä¸‹çš„ Service ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 Node æœ¬åœ° DNS ç¼“å­˜ é›†ç¾¤ä¸­çš„ DNS æœåŠ¡éƒ½æ˜¯é€šè¿‡ â€œkube-dnsâ€ çš„ Service æä¾›çš„ï¼Œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥é€šè¿‡å…¶ ClusterIP åœ°å€å»è¿›è¡Œ DNS åŸŸåè§£æã€‚ ä¸ºäº†ç¼“è§£ DNS æœåŠ¡çš„å‹åŠ›ï¼ŒKubernetes å¼•å…¥äº† Node æœ¬åœ° DNS ç¼“å­˜ï¼Œä½¿å¾— DNS åŸŸåè§£æå¯ä»¥åœ¨ Node æœ¬åœ°ç¼“å­˜ï¼Œä¸ç”¨æ¯æ¬¡è·¨ä¸»æœºå» CoreDNS è¿›è¡Œè§£æã€‚ ä½¿ç”¨ Node æœ¬åœ° DNS ç¼“å­˜åï¼ŒPod è¿›è¡Œ DNS è§£æçš„æµç¨‹å¦‚ä¸‹ï¼š Node æœ¬åœ° DNS ç¼“å­˜çš„åŠŸèƒ½æ˜¯é€šè¿‡éƒ¨ç½²ä¸€ä¸ª DaemonSet å®ç°çš„ï¼Œå…¶ Pod è¿è¡Œçš„ k8s.gcr.io/k8s-dns-node-cache é•œåƒå®ç°äº† DNS ç¼“å­˜åŠŸèƒ½ã€‚ å…·ä½“éƒ¨ç½²æ–¹å¼è§æ–‡æ¡£ï¼šåœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ NodeLocal DNSCache ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 CoreDNS ä» 1.11 ç‰ˆæœ¬å¼€å§‹ï¼ŒKubernetes é›†ç¾¤çš„ DNS æœåŠ¡ç”± CoreDNS æä¾›ï¼Œå…¶ç”¨ Go å®ç°çš„ä¸€ä¸ªé«˜æ€§èƒ½ã€æ’ä»¶å¼ã€æ˜“æ‰©å±•çš„ DNS æœåŠ¡å™¨ã€‚ ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 é…ç½® CoreDNS CoreDNS çš„ä¸»è¦åŠŸèƒ½æ˜¯é€šè¿‡æ’ä»¶ç³»ç»Ÿå®ç°çš„ï¼ŒCoreDNS å®ç°äº†ä¸€ç§é“¾å¼æ’ä»¶ç»“æ„ï¼Œå°† DNS é€»è¾‘æŠ½è±¡ä¸ºä¸€ä¸ªä¸ªæ’ä»¶ï¼Œèƒ½å¤Ÿç»„åˆçµæ´»é…ç½®ã€‚ å¸¸è§çš„æ’ä»¶å¦‚ä¸‹ï¼š loadbalance ï¼šæä¾›åŸºäº DNS è´Ÿè½½å‡è¡¡åŠŸèƒ½ loop ï¼šæ£€æŸ¥ DNS è§£æå‡ºç°çš„å¾ªç¯é—®é¢˜ cache ï¼šæä¾›å‰ç«¯ç¼“å­˜åŠŸèƒ½ health ï¼šå¯¹ Endpoint è¿›è¡Œå¥åº·æ£€æŸ¥ kubernetes ï¼šä» Kubernetes ä¸­è¯»å– zone æ•°æ® etcd ï¼šä» etcd ä¸­è¯»å– zone è®°å½•ï¼Œå¯ç”¨äºè‡ªå®šä¹‰åŸŸåè®°å½• file ï¼šä» RFC11035 æ ¼å¼æ–‡ä»¶è¯»å– zone æ•°æ® hosts ï¼šä½¿ç”¨ /etc/hosts æ–‡ä»¶æˆ–è€…å…¶ä»–æ–‡ä»¶è¯»å– zone æ•°æ®ï¼Œå¯ç”¨äºè‡ªå®šä¹‰åŸŸåè®°å½• auto ï¼šä»ç£ç›˜ä¸­è‡ªåŠ¨åŠ è½½åŒºåŸŸæ–‡ä»¶ reload ï¼šå®šæ—¶é‡æ–°åŠ è½½ Corefile é…ç½®æ–‡ä»¶å†…å®¹ forward ï¼šè½¬å‘åŸŸåæŸ¥è¯¢åˆ°ä¸Šæ¸¸ DNS æœåŠ¡å™¨ä¸Š prometheus ï¼šä¸º Prometheus ç³»ç»Ÿæä¾›é‡‡é›†æ€§èƒ½æŒ‡æ ‡æ•°æ® URL pprof ï¼šåœ¨ URL è·¯å¾„ /debug/pprof æä¾›æ€§èƒ½æ•°æ® log ï¼šå¯¹ DNS æŸ¥è¯¢è¿›è¡Œæ—¥å¿—è®°å½• errors ï¼šå¯¹é”™è¯¯ä¿¡æ¯è¿›è¡Œæ—¥å¿—è®°å½• é»˜è®¤ä¸‹ï¼ŒCoreDNS çš„ Pod ä¼šä½¿ç”¨ coredns ConfigMap æä¾›å¯¹ CoreDNS çš„é…ç½®ã€‚å› æ­¤ï¼Œä½ å¯ä»¥é€šè¿‡é…ç½®æ­¤ ConfigMap è¿›è¡Œ CoreDNS çš„é…ç½®ã€‚ $ k get configmaps coredns -n kube-system -o yaml # ... kind: ConfigMap data: Corefile: | .:53 { errors health { lameduck 5s } ready kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . /etc/resolv.conf { max_concurrent 1000 } cache 30 loop reload loadbalance } ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ ã€ŠKubernetes æƒå¨æŒ‡å—ã€‹ ","date":"2021-06-07","objectID":"/posts/cloud_computing/k8s_learning/3-dns/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 3 - DNS","uri":"/posts/cloud_computing/k8s_learning/3-dns/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 æ¦‚è¿° é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡® Service å‡ºç°çš„èƒŒæ™¯ï¼šå› ä¸º Pod è®¾è®¡ä¸Šæ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä»¥è¯´æ²¡æœ‰å›ºå®šçš„ IPï¼Œæ‰€ä»¥åœ¨å…¶ä»–ç»„ä»¶è®¿é—®æŸä¸€ä¸ªç½‘ç»œæœåŠ¡æ—¶ï¼Œéœ€è¦ä¸€ä¸ª â€œå›ºå®šâ€ çš„åœ°å€ã€‚ è¿™ä¸ªå›ºå®šçš„åœ°å€ï¼Œå°±éœ€è¦ç”± Service æ¥æä¾›ã€‚åŒæ ·ï¼Œå› ä¸ºè®¿é—®çš„åœ°å€å›ºå®šäº†ï¼ŒService ä¹Ÿå¯ä»¥æä¾›è´Ÿè½½å‡è¡¡è¿™æ ·çš„åŠŸèƒ½ã€‚ æœ€ç®€å•çš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ª Web åç«¯æœåŠ¡ï¼Œæœ‰ç€ 3 ä¸ª Pod è¿è¡Œã€‚è€Œå‰ç«¯æƒ³è®¿é—®è¯¥åç«¯æœåŠ¡ï¼Œæƒ³è¦çš„åªæ˜¯ä¸€ä¸ªå›ºå®šçš„åŸŸåæˆ–è€…åœ°å€ï¼Œè€Œä¸å…³ç³»åç«¯æœåŠ¡çš„ Pod ä¼šæ€æ ·è¢«è°ƒåº¦ã€‚ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ å¯ä»¥æ„Ÿè§‰ï¼Œè¿™å°±æ˜¯åˆ†å±‚ã€‚ä¸Šä¸‹å±‚ä¹‹é—´åªé€šè¿‡å›ºå®šçš„åœ°å€é€šä¿¡ï¼Œè€Œä¸å…³å¿ƒå±‚å†…éƒ¨æ˜¯æ€æ ·è¿è¡Œçš„ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Service åŸºç¡€ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 å®šä¹‰ Service åŸºæœ¬çš„å®šä¹‰å¦‚ä¸‹ï¼š apiVersion:v1kind:Servicemetadata:name:stringnamespace:stringlabels:- name:stringannotations:- name:stringspec:selector:[]type:stringclusterIP:stringsessionAffinity:stringports:- name:stringprotocol:stringport:inttargetPort:intnodePort:intstatus:loadBalancer:ingress:ip:stringhostname:stringtopologyKeys:- \"key\"externalName:string spec.selector ï¼šç”¨äº Service é€‰æ‹©è¢«ä»£ç†çš„ Podï¼› spec.type ï¼š Service ç±»å‹ï¼Œè§ Service çš„ç±»å‹ï¼› spec.clusterIP ï¼šå›ºå®šçš„åœ°å€ï¼Œä¸ºç©ºé‚£ä¹ˆéšæœºæä¾›ï¼› spec.sessionAffinity ï¼š è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼› spec.ports ï¼šæä¾›éœ€è¦ä»£ç†çš„åè®®ï¼Œæºç«¯å£ï¼Œç›®çš„ç«¯å£ï¼Œå®¿ä¸»æœºç«¯å£ï¼ˆNodePort ç±»å‹ï¼‰ï¼› spec.status ï¼šä½¿ç”¨ LoadBalancer ç±»å‹ä¸‹ï¼Œæä¾›ç›¸å…³å‚æ•°ï¼› spec.topologyKeys ï¼šæ§åˆ¶æµé‡è½¬å‘çš„æ‹“æ‰‘æ§åˆ¶ï¼Œä¼˜å…ˆå°†æµé‡è½¬å‘åˆ°ç›¸åŒ key çš„ Node ä¸Šçš„ Podï¼› spec.externalName ï¼šExternalName ç±»å‹ service ä»£ç†çš„é›†ç¾¤å¤–çš„æœåŠ¡åŸŸåï¼› ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 è´Ÿè½½å‡è¡¡ç­–ç•¥ k8s é»˜è®¤æä¾›ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š RoundRobin ï¼šè½®è¯¢æ¨¡å¼ï¼Œå°†è¯·æ±‚è½®è¯¢åˆ°åç«¯å„ä¸ª Podã€‚é»˜è®¤æ¨¡å¼ SessionAffinity ï¼šåŸºäºå®¢æˆ·ç«¯ IP åœ°å€è¿›è¡Œä¼šè¯ä¿æŒçš„æ¨¡å¼ã€‚ å³ç¬¬ä¸€æ¬¡å°†æŸä¸ªå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚åˆ°åç«¯æŸä¸ª Podï¼Œä¹‹åç›¸åŒå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°å¯¹åº” Podã€‚ å°† spec.sessionAffinity æŒ‡å®šä¸º â€œClientIPâ€ï¼Œå°±è¡¨æ˜äº†å¼€å¯ SessionAffinity ç­–ç•¥ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.3 æ”¯æŒçš„ç½‘ç»œåè®® ç›®å‰ Service æ”¯æŒå¦‚ä¸‹ç½‘ç»œåè®®ï¼š TCP: é»˜è®¤ç½‘ç»œåè®®ï¼Œå¯ç”¨äºæ‰€æœ‰ç±»å‹ Service UDP: å¯ç”¨äºå¤§å¤šæ•°ç±»å‹ Serviceã€‚LoadBalancer ç±»å‹å–å†³äºäº‘æœåŠ¡æ˜¯å¦æ”¯æŒ HTTP: å–å†³äºäº‘æœåŠ¡æ˜¯å¦æ”¯æŒ PROXY: å–å†³äºäº‘æœåŠ¡æ˜¯å¦æ”¯æŒ SCTP ä» 1.17 ç‰ˆæœ¬å¼€å§‹ï¼Œå¯ä»¥ä¸º Service å’Œ Endpoint èµ„æºå¯¹è±¡è®¾ç½® spec.ports[].AppProtocol å­—æ®µï¼Œç”¨äºè¡¨ç¤ºåç«¯æœåŠ¡åœ¨æŸç«¯å£åœçš„åº”ç”¨å±‚åè®®ç±»å‹ã€‚ # ...spec:ports:- port:8080targetPort:8080AppProtocol:HTTP ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 æœåŠ¡å‘ç° Kubernetes æä¾›äº†ä¸¤ç§æœºåˆ¶ä¾›å®¢æˆ·ç«¯ä»¥å›ºå®šçš„èŒƒå¼è·å–åç«¯ Service çš„è®¿é—®åœ°å€ï¼šç¯å¢ƒå˜é‡å’Œ DNSã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 ç¯å¢ƒå˜é‡æ–¹å¼ å¦‚æœ Pod åœ¨ Service ä¹‹ååˆ›å»ºï¼Œé‚£ä¹ˆé›†ç¾¤ä¸­åŒ namespace Service åœ°å€ä¿¡æ¯ä¼šé€šè¿‡ ENV ä¼ é€’ç»™å®¹å™¨ï¼ˆä¸åŒ…æ‹¬ Headless Serviceï¼‰ã€‚ ç›¸å…³çš„ç¯å¢ƒå˜é‡åŒ…æ‹¬ï¼š \u003cservice\u003e_PORT=\u003cproto\u003e://\u003cclusterip\u003e:\u003cport\u003e \u003cservice\u003e_PORT_\u003cport\u003e_\u003cproto\u003e=\u003cproto\u003e://\u003cclusterip\u003e:\u003cport\u003e \u003cservice\u003e_PORT_\u003cport\u003e_\u003cproto\u003e_ADDR=\u003cclusterip\u003e \u003cservice\u003e_PORT_\u003cport\u003e_\u003cproto\u003e_PORT=\u003cport\u003e \u003cservice\u003e_PORT_\u003cport\u003e_\u003cproto\u003e_PROTO=\u003cproto\u003e \u003cservice\u003e_SERVICE_HOST=\u003cclusterip\u003e \u003cservice\u003e_SERVICE_PORT=\u003cport\u003e \u003cservice\u003eSERVICE_PORT\u003cNAME\u003e=\u003cport\u003e é»˜è®¤ç›¸å…³çš„ç¯å¢ƒå˜é‡ä½¿ç”¨çš„éƒ½æ˜¯ service.spec.port[0] ä¿¡æ¯ã€‚å¦‚æœä½¿ç”¨çš„å¤š port ä»£ç†ï¼Œéœ€è¦ä½¿ç”¨ xxx_PORT_xxx ç›¸å…³ç¯å¢ƒå˜é‡ã€‚ ç¯å¢ƒå˜é‡é»˜è®¤è¿˜ä¼šæä¾› kubernetes çš„ service åœ°å€ï¼Œç”¨äº Pod æ¥è®¿é—® APIServerã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 DNS æ–¹å¼ æ‰€æœ‰ Service éƒ½ä¼šè‡ªåŠ¨å¯¹åº”ä¸€ä¸ª DNS åŸŸåï¼Œå…¶å‘½ä»¤æ–¹å¼ä¸º \u003cservice\u003e.\u003cnamespace\u003e.svc.cluster.\u003ccluster_domain\u003eã€‚ç”± CoreDNS ä½œä¸ºé›†ç¾¤çš„é»˜è®¤ DNS æœåŠ¡å™¨ï¼Œæä¾›åŸŸåè§£ææœåŠ¡ã€‚ å¦‚æœ Service å®šä¹‰ä¸­è®¾ç½®äº† spec.ports[].nameï¼Œé‚£ä¹ˆè¯¥ç«¯å£å·ä¹Ÿä¼šæœ‰ä¸€ä¸ªåŸŸåï¼š`\u003cport_name\u003e....svc.\u003ccluster_domain\u003eã€‚ # æä¾›äº† _http._tcp.\u003cname\u003e.\u003cnamspace\u003e.svc.local çš„ DNS åŸŸåspec:ports:- protocol:TCPport:8080targetPort:8080name:http å½“æ‰§è¡Œ nslookup \u003cservice\u003e æ—¶ï¼Œè‡ªåŠ¨åœ¨å½“å‰çš„ namespace ä¸‹è®¿é—®ã€‚é€šè¿‡ nslookup \u003cservice\u003e.\u003cnamespace\u003e å¯ä»¥è·¨ namespace è¿›è¡Œ DNS è§£æã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 Service ç±»å‹ Service æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯ï¼šä»£ç†ã€‚ä»£ç†æ¶‰åŠåˆ°ä¸¤ä¸ªç‚¹ï¼šè®¿é—®ä»£ç†çš„å‰ç«¯ï¼Œè¢«ä»£ç†çš„åç«¯ã€‚ é’ˆå¯¹è¿™ä¸ªå‰åç«¯çš„ä¸åŒï¼ŒService åˆ†ä¸ºäº† 4 ç§ç±»å‹ï¼š ClusterIPï¼ˆé»˜è®¤ï¼‰ï¼šä»£ç†ä¸€ç»„åç«¯ Podï¼Œæä¾›ä¸€ä¸ªå›ºå®šçš„å†…éƒ¨åœ°å€ ClusterIP + Portï¼Œä¹Ÿç§°ä¸º VIPï¼› NodePort ï¼šNodePort åœ¨ ClusterIP åŸºç¡€ä¸Šï¼Œä¼šå°† ClusterIP + Port æ˜ å°„åˆ° Node ä¸Šçš„æŸä¸ªç«¯å£ï¼Œä½¿å¾—é›†ç¾¤å¤–éƒ¨å¯ä»¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼› LoadBalancer ï¼šLoadBalancer åœ¨ NodePort ä¸Šï¼Œå°†ä¸€éƒ¨åˆ† Node çš„ç«¯å£æ˜ å°„åˆ°ä¸€ä¸ª IP ä¸Šï¼Œä½¿å¾—å¤–éƒ¨ç½‘ç»œå¯ä»¥è®¿é—® Nodeï¼› ExternalName ï¼šä»£ç†é›†ç¾¤å¤–éƒ¨æœåŠ¡çš„ DNS åŸŸåï¼Œè€Œä¸æ˜¯é€šè¿‡ selector æ¥é€‰æ‹©é›†ç¾¤å†…éƒ¨åç«¯ Podï¼› å¯ä»¥çœ‹åˆ°ï¼ŒClusterIP NodePort LoadBalancer æ˜¯é’ˆå¯¹è®¿é—®ä»£ç†çš„å‰ç«¯åšäº†åŒºåˆ†ï¼Œè€Œ ExternalName æ˜¯åœ¨è¢«ä»£ç†åç«¯çš„ä¸åŒã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 ClusterIP ClusterIP æ˜¯æœ€åŸºæœ¬çš„ Serviceï¼Œé€šè¿‡ä¸€ä¸ª VIP + Port æ¥åœ¨é›†ç¾¤å†…éƒ¨ä»£ç†äº†ä¸€ç»„ Pod çš„ Portã€‚å§‹ç»ˆè¦è®°å¾—ï¼ŒVIP æ˜¯åœ¨é›†ç¾¤å†…éƒ¨æ‰èƒ½ä½¿ç”¨ã€‚ apiVersion:v1kind:Servicemetadata:name:service-pythonspec:ports:- port:3000# å…¥å£ç«¯å£protocol:TCP # ä»£ç†åè®®targetPort:443# ç›®æ ‡ç«¯å£selector:run:pod-python # ä»…ä»£ç†åŒ¹é…çš„ Podtype:ClusterIP ä¸Šè¿°å®šä¹‰åˆ›å»ºäº†ä¸€ä¸ªéšæœºé€‰æ‹© IPï¼Œä»£ç† TCP 3000 -\u003e 443 ç«¯å£çš„ Serviceã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 NodePort NodePort æ˜¯å¯¹ ClusterIP çš„å¢å¼ºï¼Œå¢åŠ ä¸€ä¸ªå®¿ä¸»æœºä¸Šç«¯å£åˆ°ä»£ç†æºç«¯å£çš„è½¬å‘ï¼Œä½¿å¾—é›†ç¾¤å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚ port-forward å½“ä½ æ‰§è¡Œ kubectl port-forward svc/xxx å‘½ä»¤æ—¶ï¼Œå…¶å®ä¹Ÿæ˜¯å¢åŠ äº†ä¸€ä¸ªå®¿ä¸»ç«¯å£åˆ° Service æºç«¯å£è½¬å‘ï¼Œå’Œ NodePort ä¸€æ ·ã€‚ é€šè¿‡ service.spec.ports[].nodePort æŒ‡å®šæ˜ å°„çš„å®¿ä¸»æœºç«¯å£ï¼š apiVersion:v1kind:Servicemetadata:name:service-pythonspec:ports:- port:3000protocol:TCPtargetPort:443nodePort:30080selector:run:pod-pythontype:NodePort ä¸Šè¿°å®šä¹‰åœ¨ ClusterIP åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å®¿ä¸»æœº 30080 çš„ç«¯å£è½¬å‘ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.3 LoadBalancer åœ¨äº‘å‚å•†ç¯å¢ƒä¸‹ï¼ŒNode éƒ½æ˜¯åœ¨äº‘çš„æ‰˜ç®¡é›†ç¾¤ä¸­çš„ï¼Œæ‰€ä»¥å¤–ç½‘è®¿é—® k8s é›†ç¾¤å†…çš„è·¯å¾„ä¸ºï¼šâ€œå¤–ç½‘ -\u003e äº‘é›†ç¾¤ -\u003e k8s é›†ç¾¤â€ã€‚è€Œ NodePort ä»…ä»…è§£å†³äº† â€œäº‘é›†ç¾¤ -\u003e k8s é›†ç¾¤â€ è¿™ä¸ªé—®é¢˜ã€‚ å› æ­¤ï¼ŒLoadBalancer Service åœ¨ NodePort åŸºç¡€ä¸Šï¼Œæä¾›äº†äº‘å‚å•†éœ€è¦çš„è´Ÿè½½å‡è¡¡ä¿¡æ¯ï¼Œè€Œäº‘å‚å•†æ ¹æ®è¯¥ä¿¡æ¯è®¾ç½®å¥½ â€œå¤–ç½‘ -\u003e äº‘é›†ç¾¤â€ çš„è½¬å‘è·¯å¾„ã€‚ apiVersion:v1kind:Servicemetadata:name:service-pythonspec:ports:- port:3000protocol:TCPtargetPort:443nodePort:30080selector:run:pod-pythontype:LoadBalancerexternalTrafficPolicy:Local spec.externalTrafficPolicy spec ä¸­å®šä¹‰ä»…ä»…æ˜¯çº¦å®šçš„è§„èŒƒï¼Œä¸åŒå‚å•†æ‰€éœ€è¦çš„æ›´åŠ ç»†èŠ‚çš„ LoadBalancer çš„å‚æ•°ï¼Œå¤§å¤šæ•°æ˜¯é€šè¿‡ service.metadata.annotations æ¥æä¾›ï¼š metadata:name:my-serviceannotations:service.beta.kubernetes.io/aws-load-balancer-access-log-enabled:\"true\"# Specifies whether access logs are enabled for the load balancerservice.beta.kubernetes.io/aws-load-balancer-access-log-emit-interval:\"60\"# The interval for publishing the access logs. You can specify an interval of either 5 or 60 (minutes).service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name:\"my-bucket\"# The name of the Amazon S3 bucket where the access logs are storedservice.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix:\"my-bucket-prefix/prod\"# The logical hierarchy you created for your Amazon S3 bucket, for example `my-bucket-prefix/prod` å¯¹äº LoadBalancerï¼Œæ›´å¤šçš„ä¿¡æ¯è§å®˜æ–¹æ–‡æ¡£ï¼šLoadBalancerã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.4 ExternalName å‰é¢ä¸‰ç§ Service ä»£ç†çš„åç«¯éƒ½æ˜¯é›†ç¾¤å†…éƒ¨çš„ Podï¼Œè€Œ ExternalName ä¸å†æ˜¯ä»£ç† Podï¼Œè€Œæ˜¯å°†è¯·æ±‚åŸŸåé‡å®šå‘å¦ä¸€ä¸ªåŸŸåã€‚ å› æ­¤ï¼ŒExternalName Service ä¸å†æä¾›ä»£ç†çš„åŠŸèƒ½ï¼Œè€Œæ˜¯æä¾›äº†åŸŸåé‡å®šå‘çš„åŠŸèƒ½ã€‚ kind:ServiceapiVersion:v1metadata:name:service-pythonspec:ports:- port:3000protocol:TCPtargetPort:443type:ExternalNameexternalName:remote.server.url.com é€šè¿‡ serivce.spec.externalName æŒ‡å®šè¢«ä»£ç†çš„åŸŸåï¼Œè€Œé›†ç¾¤å†…éƒ¨çš„ Pod å°±å¯ä»¥é€šè¿‡è¯¥ Service è®¿é—®å¤–éƒ¨æœåŠ¡äº†ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5 Endpoint å½“åˆ›å»ºä¸€ä¸ª Service åï¼Œä¼šæ ¹æ® service.spec.selector è‡ªåŠ¨æ¥åŒ¹é…ä½œä¸ºåç«¯çš„ Podã€‚å®é™…ä¸Šï¼Œä¼šå¯¹åº”ä¸€ä¸ª Endpoints å¯¹è±¡æ¥ä»£è¡¨å…¶åŒ¹é…åˆ°çš„ä»£ç†ç›®æ ‡ï¼Œè€Œå…¶æ¯ä¸€ä¸ªè¢«ä»£ç†çš„ Pod ç§°ä¹‹ä¸º Endpointã€‚ $ kubectl get endpoints -A NAMESPACE NAME ENDPOINTS AGE default kubernetes 172.16.4.169:6443 3d1h kube-system kube-dns 10.36.0.4:53,10.36.0.5:53,10.36.0.4:53 + 3 more... 3d1h å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¸æä¾› service.spec.selectorï¼Œä¹Ÿä¸ä½¿ç”¨ ExternalName Serviceï¼Œè€ŒæŒ‡å®šåˆ›å»ºä¸€ä¸ª Endpoints å¯¹è±¡ã€‚è¿™æ ·å¯ä»¥å®ç°ï¼ŒService åªä»£ç†æŒ‡å®šçš„åœ°å€ï¼š apiVersion:v1kind:Servicemetadata:name:plat-devspec:ports:- port:3306protocol:TCPtargetPort:3306---apiVersion:v1kind:Endpointsmetadata:name:plat-devsubsets:- addresses:- ip:\"10.5.10.109\"ports:- port:3306 åŒåçš„ Endpoint ä¸ Service è‡ªåŠ¨è¢«è®¤ä¸ºæ˜¯ç›¸ç»‘å®šçš„ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"6 Headless Service Service ä¼šè‡ªåŠ¨å‘ç°ä¸€ç»„ Podï¼Œå¹¶æä¾›ä»£ç†æœåŠ¡ä¸è´Ÿè½½å‡è¡¡ã€‚ä¸è¿‡æœ‰æ—¶å€™ï¼ŒPod ä¸­ç¨‹åºå¹¶ä¸æƒ³ä½¿ç”¨ Service çš„ä»£ç†åŠŸèƒ½ï¼Œè€Œæ˜¯ä»…ä»…æƒ³è®© Service ä½œä¸ºä¸€ä¸ªæœåŠ¡å‘ç°çš„ä½œç”¨ï¼Œä¾‹å¦‚ï¼Œpeer2peer ç¨‹åºæƒ³è¦çŸ¥é“æœ‰å“ªäº›å¯¹ç«¯çš„ç¨‹åºã€‚ é€šè¿‡ Service çš„å®šä¹‰çœ‹ï¼Œè¿™ç§æƒ…å†µä¹Ÿå°±æ˜¯ä¸éœ€è¦ service.spec.clusterIPï¼Œä½†æ˜¯éœ€è¦ service.spec.selectorã€‚è¿™ç§ç‰¹æ®Šçš„ Service è¢«ç§°ä¸º Headless Serviceã€‚ apiVersion:v1kind:Servicemetadata:name:mysql-balance-svcnamespace:mysql-spacespec:ports:- port:3308protocol:TCPtargetPort:3306clusterIP:None # clusterIP æŒ‡å®šä¸º None è¡¨æ˜ä¸éœ€è¦selector:name:mysql-balance-podpublishNotReadyAddresses:false spec.clusterIP: None è¡¨æ˜å…¶ä¸º Headless Service sepc.publishNotReadyAddresses ï¼šä¸º true æ—¶ï¼Œå³ä½¿ Pod è¿˜ä¸æ˜¯ Ready çŠ¶æ€ï¼Œä¹Ÿä¼šæä¾› DNS è®°å½• service.spec.selector è®© Service åŒ¹é…åˆ°åç«¯ Podï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Endpointsã€‚ å½“æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Service DNS è¿›è¡Œè§£ææ—¶ï¼Œä¼šå¾—åˆ° DNS ç³»ç»Ÿè¿”å›çš„å…¨éƒ¨ Endpoint åœ°å€ã€‚ $ nsloopup mysql-balance-svc.mysql-space.svc.cluster.local Server: 169.169.0.100 Address: 169.169.0.100#53 Name :mysql-balance-svc.mysql-space.svc.cluster.local Address: 10.0.95.13 Name :mysql-balance-svc.mysql-space.svc.cluster.local Address: 10.0.95.12 Name :mysql-balance-svc.mysql-space.svc.cluster.local é€šè¿‡ Headless Serviceï¼Œç„¶åè®¾ç½® Pod çš„ hostname ä¸ subdomainï¼Œå°±å¯ä»¥å®ç°é€šè¿‡å›ºå®š DNS è®°å½•è®¿é—®æŸä¸ª Podã€‚ä¹Ÿå°±æ˜¯ StatefulSet ä½¿ç”¨ Headless Service çš„æ–¹å¼ã€‚ è¿™é‡ŒæåŠä¸€ä¸‹ï¼ŒStatefulSet Pod å¯¹åº”çš„ DNS è®°å½•ä¸ºï¼š\u003cpodname\u003e.\u003cservice\u003e.\u003cnamespace\u003e.svc.cluster.localã€‚ DNS è®°å½•ä¸æ˜¯ç”± Headless Service æä¾›çš„ è¦æ³¨æ„ï¼ŒStatefulSet Pod çš„ DNS è®°å½•ä¸æ˜¯ç”± Headless Service æä¾›çš„ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"7 EndpointSlice ä¸ Service Topology ç”±å‰é¢çŸ¥é“ï¼ŒService åç«¯æ˜¯ä¸€ç»„ Endpointï¼Œéšç€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼ŒEndpoint æ•°é‡ä¸æ–­çš„å¢é•¿ï¼Œä½¿å¾— kube-proxy éœ€è¦ç»´æŠ¤éå¸¸å¤šçš„è´Ÿè½½åˆ†å‘è§„åˆ™ã€‚ é€šè¿‡ EndpointSlice ä¸ Service Topology é…åˆï¼Œå¯ä»¥è®© kube-proxy ä»…ä»…è½¬å‘éƒ¨åˆ†çš„èŠ‚ç‚¹ï¼Œå®ç°å¯¹ Endpoint çš„åˆ†ç‰‡ç®¡ç†ã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:7:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"7.1 EndpointSlice 1.16 ç‰ˆæœ¬å¼•å…¥äº† EndpointSlice æœºåˆ¶ï¼ŒåŒ…æ‹¬ EndpointSlice èµ„æºå¯¹è±¡å’Œ EndpointSlice Controllerã€‚ EndpointSlice å°±æ˜¯ä»£è¡¨ç€ä¸€ç»„ Endpointï¼Œkube-proxy å¯ä»¥ä½¿ç”¨ EndpointSlice ä¸­çš„ Endpoint è¿›è¡Œè·¯ç”±è½¬å‘ã€‚ kube-proxy å¼€å¯ EndpointSlice kube-proxy é»˜è®¤ä»ç„¶ä½¿ç”¨ Endpoint å¯¹è±¡ï¼Œé€šè¿‡è®¾ç½®å…¶å¯åŠ¨å‚æ•° â€“feature-gates=â€œEndpointSlice=trueâ€ æ¥è®©å…¶ä½¿ç”¨ EndpointSlice å¯¹è±¡ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª Service åï¼Œå°±ä¼šå­˜åœ¨å¯¹åº”çš„ EndpointSlice å¯¹è±¡ï¼ŒåŒ…å«åŒ¹é…åˆ°çš„ Endpoint å¯¹è±¡ã€‚ $ kubectl get endpointslices.discovery.k8s.io NAME ADDRESSTYPE PORTS ENDPOINTS AGE my-tidb-cluster-dev-discovery-sm8ns IPv4 10262,10261 192.168.54.139 2d3h my-tidb-cluster-dev-pd-dsktv IPv4 2379 192.168.135.18,192.168.166.186,192.168.54.140 2d3h my-tidb-cluster-dev-pd-peer-n6wbg IPv4 2380 192.168.135.18,192.168.166.186,192.168.54.140 2d3h ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:7:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"7.2 Service Topology Service Topology å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¯¹ Node è¿›è¡Œåˆ†ç»„ï¼Œè®¾ç½®æœ‰æ„ä¹‰çš„æŒ‡æ ‡å€¼æ¥æ ‡è¯† Node æ˜¯ â€œè¿‘â€ æˆ–è€… â€œè¿œâ€ã€‚å¯¹äºå…¬æœ‰äº‘ç¯å¢ƒæ¥è¯´ï¼Œé€šå¸¸ä¼šè¿›è¡Œ Zone æˆ– Region çš„åˆ’åˆ†ã€‚ é€šè¿‡ Service Topology å°±å®ç°äº†å¯¹ Endpoint è¿›è¡Œåˆ†ç»„ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¤šä¸ª EndpointSliceï¼Œè¿›è¡Œåˆ†ç‰‡ç®¡ç†ã€‚ å¼€å¯ Service Topology é€šè¿‡è®¾ç½® kube-apiserver å’Œ kube-proxy å¯åŠ¨å‚æ•° â€“feature-gates=â€œServiceTopology=true,EndpointSlice=true å¼€å¯ã€‚ é€šè¿‡ Service å®šä¹‰ä¸Šçš„ spec.topologyKeys å­—æ®µæ¥è¿›è¡Œ Service æµé‡æ§åˆ¶ã€‚è½¬å‘æµé‡æ—¶ï¼Œä¼šå»æŒ‰ç…§ topologyKeys å­—æ®µé¡ºåºåŒ¹é… Node çš„ labelï¼ŒåŒæ ·çš„ key å¯¹åº”çš„ value ç®—ä½œåŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆæ‰èƒ½å°†æµé‡è½¬å‘åˆ°è¯¥ Node ä¸Šã€‚ spec:topologyKeys:- \"kubernetes.io/hostname\"# åŒ¹é… Node ä¸è¦è½¬å‘çš„ Nodeï¼Œè¯¥ key çš„ label ç›¸åŒæ‰å¯ä»¥è½¬å‘æµé‡---spec:topologyKeys:- \"topology.kubernetes.io/zone\"# ä¼˜å…ˆè½¬å‘åˆ°åŒ zone- \"topology.kubernetes.io/region\"# å…¶æ¬¡è½¬å‘åˆ°åŒ region- \"*\"# æœ€åéšæ„è½¬å‘ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:7:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"8 Ingress Service æä¾›äº†åŸºäº 4 å±‚çš„ä»£ç†ï¼Œä¹Ÿå°±æ˜¯åŸºäº IP + Port çš„ä»£ç†ã€‚è€Œ Ingress å‡ºç°å°±æ˜¯ä¸ºäº†æ”¯æŒ 7 å±‚çš„ä»£ç†ï¼Œå…¸å‹çš„å°±æ˜¯æ”¯æŒ HTTP/HTTPS åè®®çš„ä»£ç†ã€‚ Ingress ç±»ä¼¼äº nginx çš„é…ç½®ï¼Œæä¾›åº”ç”¨å±‚çš„è·¯ç”±ï¼Œå°†æµé‡è·¯ç”±ç»™åŸºäºä¼ è¾“å±‚çš„ Serviceï¼Œè€Œç”± Service å°†æµé‡è·¯ç”±ç»™åº•å±‚çš„ Podã€‚ ä¸è¿‡ Ingress ç±»ä¼¼äº Serviceï¼Œä»…ä»…æ˜¯ä¸€ä¸ªè§„åˆ™çš„å®šä¹‰ï¼Œå…¶ä»£ç†çš„å®ç°ä¾èµ–äº Ingress Controllerã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:8:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"8.1 Ingress Controller Ingress Controller åŸºäºå®šä¹‰å¥½çš„ Ingress æ¥å®ç°å®é™…çš„è·¯ç”±ï¼Œå¯ä»¥ç†è§£ä¸ºå°±æ˜¯å®é™…ä¸Šçš„ nginxã€‚ Ingress Controller æ˜¯ä¸åŒ…å«åœ¨ controller manager é»˜è®¤å¯åŠ¨çš„ controller çš„ï¼Œéœ€è¦æ‰‹åŠ¨è¿›è¡Œ controllerã€‚ å½“ç„¶ï¼Œç›®å‰æœ‰ç€è®¸å¤šç§çš„ Ingress Controller çš„å®ç°ï¼Œå…·ä½“è§ Ingress Controllerã€‚ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:8:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"8.2 Ingress å®šä¹‰ Ingress çš„é…ç½®å’Œé…ç½® nginx ç±»ä¼¼ï¼ŒåŸºäº HTTP path è·¯å¾„è¿›è¡Œè·¯ç”±çš„é…ç½®ã€‚ çœ‹ä¸€ä¸ªç¤ºä¾‹å®šä¹‰ï¼š apiVersion:networking.k8s.io/v1kind:Ingressmetadata:name:ingress-resource-backendspec:ingressClassName:istiotls:- hosts:[]secretName:secretdefaultBackend:service:name:server-nameport:name:port-namenumber:80resource:apiGroup:k8s.example.comkind:StorageBucketname:static-assetsrules:host:\"\"- http:paths:- path:/iconspathType:ImplementationSpecificbackend:resource:apiGroup:k8s.example.comkind:StorageBucketname:icon-assets spec.ingressClassName - æŒ‡å®šä½¿ç”¨çš„ Ingress Controller çš„åå­—ï¼Œä¸ºä¿æŒå…¼å®¹ annotation kubernetes.io/ingress.class ä¾æ—§å¯ä»¥ä½¿ç”¨ spec.tls - è¯ä¹¦å¯¹åº”çš„ secret ä¸å…è®¸çš„ hosts spec.defaultBackend - ç”¨äºé…ç½®é»˜è®¤çš„åç«¯ï¼Œå½“ rules ä¸­æ‰€æœ‰éƒ½ä¸æ»¡è¶³æ—¶ï¼Œå°±ä¼šä½¿ç”¨ default è·¯ç”± service - è½¬å‘åˆ°ä¸€ä¸ª Kubernetes Service name - service çš„åå­— port - è½¬å‘ç»™ service çš„ portï¼Œå¯ä»¥æ˜¯åå­—æˆ–è€…ç«¯å£å· resource - è½¬å‘ç»™ Ingress å¯¹è±¡åŒ Namespace ä¸‹çš„ä¸€ä¸ª Resourceï¼ˆä¸ service é€‰é¡¹äº’æ–¥ï¼‰ spec.rules - å®šä¹‰è·¯ç”±ç­–ç•¥ host - åŒ¹é…è¯·æ±‚çš„ hostï¼Œå¯ä»¥æ˜¯ç²¾ç¡®åŒ¹é…æˆ–è€…é€šé…ç¬¦åŒ¹é… http - http å±‚çš„å¤šä¸ªåŒ¹é…è·¯å¾„ ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:8:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"å‚è€ƒ ã€ŠKubernetes in Actionã€‹ ã€ŠKubernetes æƒå¨æŒ‡å—ã€‹ Blog: è¯¦è§£ k8s 4 ç§ç±»å‹ Service ","date":"2021-06-06","objectID":"/posts/cloud_computing/k8s_learning/2-service/:9:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 2 - Service","uri":"/posts/cloud_computing/k8s_learning/2-service/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"Pod åŸºæœ¬æ¦‚å¿µ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1 Pod çš„è¿›ç¨‹æ¨¡å‹ Pod æ˜¯ä¸€ç»„å®¹å™¨çš„é›†åˆï¼Œè€Œä¸ºä»€ä¹ˆå®ç°ä¸Šéœ€è¦å¤šä¸ªå®¹å™¨ï¼Ÿæ®ä¼ ï¼Œå› ä¸ºå¼€å‘ Borg é¡¹ç›®çš„å·¥ç¨‹å¸ˆå‘ç°ï¼Œéƒ¨ç½²çš„åº”ç”¨å¾€å¾€éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚æ¢ä¸ªè§’åº¦è¯´ï¼Œéƒ¨ç½²çš„ä¸šåŠ¡å¾€å¾€æœ‰ç€å¤šä¸ªä¸åŒçš„è¿›ç¨‹ï¼Œå¹¶ä¸”å¾€å¾€éœ€è¦éƒ¨ç½²åˆ°åŒä¸€ä¸ªæœºå™¨ä¸Šã€‚ å®¹å™¨æ˜¯ â€œå•è¿›ç¨‹æ¨¡å‹â€ï¼Œåœ¨äº‘ä¸Šä»£è¡¨çš„æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚è€Œ Pod æ˜¯ â€œè¿›ç¨‹ç»„æ¨¡å‹â€ï¼Œåœ¨äº‘ä¸Šä»£è¡¨ç€å°±æ˜¯è¿›ç¨‹ç»„ã€‚ â€œå•è¿›ç¨‹æ¨¡å‹â€ â€œå•è¿›ç¨‹æ¨¡å‹â€ ä¸ä»£è¡¨å®¹å™¨åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œæ˜¯æŒ‡å®¹å™¨æ— æ³•ç®¡ç†å¤šè¿›ç¨‹çš„èƒ½åŠ›ã€‚ ä½ å¯ä»¥å°†å…¶ç†è§£ä¸ºï¼ŒPod å®ç°äº† Supervisor/goreman è¿™æ ·çš„åŠŸèƒ½ï¼Œå°†å¤šä¸ªè¿›ç¨‹è¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œè¿™å¯¹äºä¸šåŠ¡åº”ç”¨çš„éƒ¨ç½²æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ æ‰€ä»¥ Kubernetes æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œç®¡ç†ç€ Pod â€œè¿›ç¨‹ç»„â€ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.1 Pause å®¹å™¨ åœ¨åˆ›å»º Pod æ—¶ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ª pause å®¹å™¨ï¼Œä¹Ÿç§°ä¸º æ ¹å®¹å™¨ æˆ–è€… infra å®¹å™¨ã€‚ pause å®¹å™¨ä½¿ç”¨ k8s.gcr.io/pause é•œåƒï¼Œæ°¸è¿œå¤„äºæš‚åœï¼Œå ç”¨ç€å¾ˆå°‘çš„èµ„æºã€‚ ä¸ºä»€ä¹ˆéœ€è¦ pause å®¹å™¨ï¼Ÿ å› ä¸ºå®¹å™¨å…±äº«èµ„æºçš„ç‰¹æ®Šæ€§ã€‚å®¹å™¨åœ¨éœ€è¦å…±äº« namespace æ—¶ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª namespaceï¼Œç„¶åè®©å…¶ä»–çš„å®¹å™¨åŠ å…¥è¿™ä¸ª namespaceã€‚ è¿™å¸¦æ¥çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šå¦‚æœå®¹å™¨ A å…ˆå¯åŠ¨ï¼Œå®¹å™¨ B åŠ å…¥ã€‚é‚£ä¹ˆå®¹å™¨ A å¼‚å¸¸é‡å¯åï¼Œæ˜¯å®¹å™¨ A åŠ å…¥å®¹å™¨ Bï¼Œè¿˜æ˜¯é‡æ–°å¯åŠ¨å®¹å™¨ B å†æ¬¡åŠ å…¥å®¹å™¨ Aã€‚ å¾ˆéš¾é€‰æ‹©ï¼Œå®ç°èµ·æ¥ä¹Ÿå¾ˆå¤æ‚ï¼Œå› ä¸ºä¸¤ä¸ªå®¹å™¨æœ‰ç€å‰åé¡ºåºçš„ä¾èµ–æ€§ï¼Œè€Œä¸æ˜¯â€œå¹³ç­‰çš„â€ã€‚ Kubernetes ä½¿ç”¨ä¸€ä¸ªå ç”¨æå°‘èµ„æºï¼Œéä¸šåŠ¡å®¹å™¨çš„ pause å®¹å™¨é¦–å…ˆå¯åŠ¨ã€‚ç„¶ååœ¨å…¶ pause å®¹å™¨é…ç½®å¥½ namespaceã€‚æ¥ç€å…¶ä»–çš„ä¸šåŠ¡å®¹å™¨åŠ å…¥åˆ° pause å®¹å™¨çš„ namespaceã€‚ å› ä¸º pause å®¹å™¨å ç”¨æå°‘èµ„æºï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•é€»è¾‘ï¼Œæ‰€ä»¥å…¶ä»–ä¸šåŠ¡å®¹å™¨é‡å¯åï¼Œåªéœ€è¦åŠ å…¥ pause å®¹å™¨çš„ namespace å³å¯ï¼Œä¸éœ€è¦æ‹…å¿ƒ namespace å‘ç”Ÿå˜åŒ–ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:1:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"1.2 å®¹å™¨å…±äº«çš„èµ„æº Pod å†…å®¹å™¨é»˜è®¤å…±äº« network uts ipc namespaceï¼Œæ‰€ä»¥å®¹å™¨é—´çš„ç½‘ç»œæ˜¯ç›¸åŒçš„ã€‚ Pod å¯ä»¥é…ç½®å¼€å¯å…±äº« PID namespaceï¼Œä½¿å¾—å®¹å™¨ä¹‹é—´å¯ä»¥çœ‹åˆ°å¯¹æ–¹çš„è¿›ç¨‹ã€‚ å…±äº« pid namespace è®¾ç½® Pod å®šä¹‰çš„ spec.shareProcessNamespace ä¸º true æ¥å…±äº« pid namespaceã€‚ Pod é€šè¿‡ Volume çš„æŠ½è±¡æ¦‚å¿µæ¥è¿›è¡Œå…±äº«å­˜å‚¨ï¼Œå°†å…¶å—è®¾å¤‡æˆ–è€…ç›®å½•æä¾›åˆ°æ¯ä¸ªå®¹å™¨å†…çš„ä¸åŒè·¯å¾„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå®¹å™¨çœ‹åˆ°çš„ç›®å½•è·¯å¾„æˆ–è€…å—è®¾å¤‡æ˜¯ç‹¬ç«‹çš„ï¼Œä½†æ˜¯éƒ½å¯¹åº”åŒä¸€ä¸ªå®¿ä¸»æœºçš„ç›®å½•æˆ–å—è®¾å¤‡ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:1:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2 Dynamic Pod ä¸ Static Pod ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.1 Dynamic Pod å¤§å¤šæ•°æƒ…å†µï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ ReplicaSet æˆ–è€… Deployment è¿™æ ·çš„å‰¯æœ¬æ§åˆ¶å™¨æ¥åˆ›å»º Podï¼Œç”šè‡³é€šè¿‡ç¼–å†™ Pod çš„å®šä¹‰æ¥æ‰‹åŠ¨éƒ¨ç½² Podã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒPod æ˜¯ç”± Kubernetes æ§åˆ¶é¢ç®¡ç†çš„ï¼Œå¯ä»¥é€šè¿‡ APIServer å¯åœå®ƒã€‚ è¿™æ ·çš„ Pod è¢«ç§°ä¸º åŠ¨æ€ PodDynamic Podã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"2.2 Static Pod å¦ä¸€ç±»æ˜¯ç‰¹æ®Šçš„ Podï¼Œè¢«ç§°ä¸º é™æ€ PodStatic Podã€‚ é™æ€ Pod æ˜¯ç”±æœ¬åœ° kubelet åˆ›å»ºçš„ï¼Œä»…ä»…åœ¨ kubelet çš„ Node ä¸Šè¿è¡Œã€‚Kubernetes æ§åˆ¶é¢å¯ä»¥çœ‹è§ï¼Œä½†æ˜¯æ— æ³•ç®¡ç†å®ƒã€‚kubelet ä¹Ÿä¸ä¼šå…¶è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚ åˆ›å»ºé™æ€ Pod æœ‰ç€ä¸¤ç§æ–¹å¼ï¼šé…ç½®æ–‡ä»¶ å’Œ HTTP æ–¹å¼ã€‚ 2.2.1 é…ç½®æ–‡ä»¶æ–¹å¼ åœ¨ kubelet çš„é…ç½®æ–‡ä»¶ä¸­ç¤¾ä¼šä¸­ staticPodPath ä¸ºä¸€ä¸ªç›®å½•ï¼Œkubelet ä¼šæ‰«æè¯¥ç›®å½•ï¼Œè¯»å–ç›®å½•ä¸‹çš„ .yaml æˆ– .json æ–‡ä»¶ï¼Œåˆ›å»ºå¯¹åº”çš„ Podã€‚ å¦ä¸€ç§æ–¹å¼ ä¹Ÿå¯ä»¥ä½¿ç”¨ kubelet å¯åŠ¨å‚æ•° --pod-manifest-path æŒ‡å®šç›®å½•ï¼Œä½†æ˜¯è¿™æ˜¯å³å°†åºŸå¼ƒçš„å‚æ•°ã€‚ ä½ åœ¨ APIServer å¯ä»¥çœ‹åˆ°è¯¥ Podï¼Œä½†æ˜¯å¦‚æœä½ è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè¯¥ Pod ä¼šä¸€ç›´è¿›å…¥ Pending çŠ¶æ€ï¼Œä½†æ˜¯ä¸ä¼šçœŸæ­£è¢«åœæ­¢ã€‚ åˆ é™¤è¯¥ Pod åªèƒ½é€šè¿‡åˆ é™¤ç›®å½•ä¸‹çš„å¯¹åº” .yaml æ–‡ä»¶ã€‚ 2.2.2 HTTP æ–¹å¼ è®¾ç½® kubelet çš„å¯åŠ¨å‚æ•° --manifest-urlï¼Œkubelet ä¼šå®šæœŸä»è¯¥ URL åœ°å€ä¸‹è½½æ–‡ä»¶ï¼Œç„¶åä»¥ yaml æˆ– json æ ¼å¼è§£æï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„ Podã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3 Pod çš„ç”Ÿå‘½å‘¨æœŸ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.1 Pod phase Pod çš„ status.phase å±æ€§è¡¨æ˜äº† Pod çš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼š status:phase:Running Pod ç”Ÿå‘½å‘¨æœŸåŒ…å«å¦‚ä¸‹é˜¶æ®µï¼š çŠ¶æ€ å«ä¹‰ Pending Pod è¢«åˆ›å»ºååˆ° Pod å†…æ‰€æœ‰å®¹å™¨æˆåŠŸåˆ›å»ºå‰ï¼Œéƒ½å±äº Pending é˜¶æ®µï¼ŒåŒ…æ‹¬äº†ä¸‹è½½é•œåƒæœŸé—´ã€‚ Running Pod å†…çš„æ‰€æœ‰å®¹å™¨è¢«æˆåŠŸåˆ›å»ºï¼Œè‡³å°‘ä¸€ä¸ªå®¹å™¨è¿˜åœ¨è¿è¡Œï¼ˆå³ä½¿å…¶ä»–å®¹å™¨å¼‚å¸¸é‡å¯ï¼‰ã€‚ Succeeded Pod å†…æ‰€æœ‰å®¹å™¨æˆåŠŸæ‰§è¡Œå¹¶é€€å‡ºï¼ˆé€€å‡ºç ä¸º 0ï¼‰ï¼Œå¹¶ä¸” Pod ä¸å†ä¼šè¢«é‡æ–°æ‹‰èµ·ã€‚ Failed Pod å†…æ‰€æœ‰å®¹å™¨éƒ½å·²ç»åœæ­¢ï¼Œå¹¶ä¸”è‡³å°‘ä¸€ä¸ªå®¹å™¨æ˜¯å¼‚å¸¸é€€å‡ºçš„ï¼ˆé€€å‡ºç é 0ï¼‰ã€‚ Unknown æ— æ³•å¾—çŸ¥ Pod çš„çŠ¶æ€ã€‚å¤§å¤šæ•°æƒ…å†µæ˜¯ Node å¤±è”å¯¼è‡´ã€‚ STATUS of kubectl ä½ ä¼šå‘ç°é€šè¿‡ kubectl get pods è¾“å‡ºçš„ STATUS å¯èƒ½å¹¶ä¸æ˜¯ä¸Šè¿°çš„ phaseï¼Œè€Œæ˜¯ Pod ä¸­å®¹å™¨çŠ¶æ€çš„ä¸€ä¸ªåŸå› ï¼Œå³ status.containerStatuses[].state.\u003c\u003e.reasonï¼Œè¿™æ˜¯ä¸ºäº†ç›´è§‚è¾“å‡º Pod çš„å¼‚å¸¸åŸå› ã€‚ é€šè¿‡ kubectl get pods -o yaml å¯ä»¥çœ‹åˆ° status.phaseã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:3:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.2 Container State Kubernetes ä¼šè·Ÿè¸ª Pod ä¸‹æ¯ä¸ªå®¹å™¨çš„çŠ¶æ€ï¼Œä½äº status.containerStatuses.state å­—æ®µã€‚ å®¹å™¨å¯èƒ½çš„çŠ¶æ€æœ‰ï¼š çŠ¶æ€ å«ä¹‰ Waiting ç­‰å¾…è¿è¡Œã€‚å¯èƒ½ç”±äºæ­£åœ¨æ‹‰å– imageï¼Œæˆ–è€…ç­‰å¾… init container è¿è¡Œç­‰æƒ…å†µã€‚ Running å®¹å™¨æ­£åœ¨è¿è¡Œä¸­ã€‚ Terminated å®¹å™¨è¿è¡Œç»“æŸï¼Œæ— è®ºæ­£å¸¸é€€å‡ºè¿˜æ˜¯å¼‚å¸¸é€€å‡ºã€‚ é€šè¿‡ status.containerStatuses.state ä½ å¯ä»¥çœ‹åˆ°ä¸ºå•¥å®¹å™¨å¤„äºè¯¥çŠ¶æ€ã€‚ 3.2.1 å®¹å™¨å£°æ˜å‘¨æœŸå›è°ƒ Kubernetes æä¾›ä¸¤ä¸ªå®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒï¼š postStart ï¼šåœ¨å®¹å™¨åˆ›å»ºåç«‹å³å¼‚æ­¥æ‰§è¡Œï¼Œå› æ­¤ä¸ä¿è¯åœ¨å®¹å™¨çš„ entrypoint å‰æ‰§è¡Œã€‚ ä½†æ˜¯ kubelet ä¼šç­‰å¾… postStart åæ‰§è¡Œå®Œï¼Œæ‰å°†å®¹å™¨çš„çŠ¶æ€å˜ä¸º Runningã€‚ preStop ï¼šåœ¨ kubelet å‘é€å®¹å™¨åœæ­¢ä¿¡å·å‰ï¼Œæ‰§è¡Œçš„æ“ä½œã€‚ Note æ³¨æ„ï¼ŒpreStop ä»…ä»…åœ¨ kubelet åœæ­¢å®¹å™¨çš„æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œï¼ˆå› ä¸ºè¿™æ˜¯ kubelet æ‰§è¡Œçš„æ“ä½œï¼‰ï¼Œè€Œå®¹å™¨è‡ªå·±é€€å‡ºçš„æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œã€‚ ä½¿ç”¨å›è°ƒçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š apiVersion:v1kind:Podmetadata:name:lifecycle-demospec:containers:- name:lifecycle-demo-containerimage:nginxlifecycle:postStart:httpGet:path:/port:80preStop:exec:command:[\"/bin/sh\",\"-c\",\"nginx -s quit; while killall -0 nginx; do sleep 1; done\"] å¯ä»¥çœ‹åˆ°ï¼Œå›è°ƒå¯ä»¥é…ç½®ä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼š httpGet ï¼šæ‰§è¡Œä¸€æ¬¡ HTTP GET è¯·æ±‚ï¼› exec ï¼šæ‰§è¡Œå‘½ä»¤è¡Œï¼› ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:3:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.3 Pod Condition Pod çš„ status.conditions è¡¨æ˜äº† Pod çš„ä¸€äº›ç»†èŠ‚æƒ…å†µã€‚ é»˜è®¤åŒ…å«ä»¥ä¸‹çš„ conditionï¼š Conditon å«ä¹‰ PodScheduled Pod æ˜¯å¦å·²ç»è¢«è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ã€‚ Initialized æ‰€æœ‰ Init Container æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚ ContainersReady æ‰€æœ‰å®¹å™¨æ˜¯å¦æ˜¯å°±ç»ªçš„ï¼ˆè¿è¡Œä¸­ï¼‰ã€‚ Ready Pod æ˜¯å¦èƒ½å¤Ÿæä¾›æœåŠ¡ï¼Œå³èƒ½å¦åŠ å…¥åˆ° Service çš„ Endpoints ä¸­ã€‚ Ready çŠ¶æ€å—åˆ° Readiness Probe çš„æ§åˆ¶ã€‚ status:conditions:- lastProbeTime:nulllastTransitionTime:\"2021-06-11T07:11:46Z\"status:\"True\"type:Initialized- lastProbeTime:nulllastTransitionTime:\"2021-06-12T15:32:39Z\"message: 'containers with unready status:[pd]'reason:ContainersNotReadystatus:\"False\"type:Ready- lastProbeTime:nulllastTransitionTime:\"2021-06-12T15:32:39Z\"message: 'containers with unready status:[pd]'reason:ContainersNotReadystatus:\"False\"type:ContainersReady- lastProbeTime:nulllastTransitionTime:\"2021-06-11T07:11:46Z\"status:\"True\"type:PodScheduled å¯ä»¥çœ‹åˆ°æ¯ä¸ª Condition éƒ½åŒ…å«äº†å¦‚ä¸‹ä¿¡æ¯ï¼š type ï¼šcondition ç±»å‹ï¼› status ï¼šcondition æ˜¯å¦æ­£å¸¸ï¼ŒåŒ…æ‹¬ True False Unknownï¼› lastProbeTime ï¼šä¸Šä¸€æ¬¡æ£€æŸ¥è¯¥ condition çš„æ—¶é—´ï¼› lastTransitionTime ï¼šä¸Šä¸€æ¬¡ condition status å˜åŒ–çš„æ—¶é—´ï¼› reason ï¼šä¸Šä¸€æ¬¡ condition status å˜åŒ–çš„åŸå› ï¼› message ï¼šä¸Šä¸€æ¬¡ conditon status å˜åŒ–çš„åŸå› ä¿¡æ¯ï¼› 3.3.1 è‡ªå®šä¹‰ condition é™¤äº†é»˜è®¤çš„ condition å¤–ï¼Œå¯ä»¥é€šè¿‡ spec.readinessGates æ¥è‡ªå®šä¹‰ conditionã€‚ è‡ªå®šä¹‰ condition å¾€å¾€ç”±ä¸€ä¸ª controller æ§åˆ¶ï¼Œé€šè¿‡è‡ªå®šä¹‰ controller æ¥ä¸»åŠ¨å°†è‡ªå®šä¹‰ condition è®¾ç½®ä¸º trueã€‚ è‡ªå®šä¹‰ condition ä»…ä»…ä¼šå½±å“åˆ° Ready conditionï¼Œåªæœ‰æ‰€æœ‰è‡ªå®šä¹‰ condition ä¸º true åï¼ŒReady condition æ‰èƒ½å˜ä¸º trueã€‚ apiVersion:v1kind:Podmetadata:name:centosspec:readinessGates:- conditionType:\"www.example.com/feature-1\" ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:3:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"3.4 Pod é‡å¯ç­–ç•¥ é€šè¿‡ spec.restartPolicy æŒ‡å®š Pod çš„é‡å¯ç­–ç•¥ï¼Œå…¶å¯èƒ½çš„å€¼ä¸ºï¼š Always ï¼šå®¹å™¨é€€å‡ºæ—¶ï¼Œkubelet è‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼› OnFailure ï¼šå®¹å™¨é€€å‡ºä¸”é€€å‡ºç é 0 æ—¶ï¼Œkubelet è‡ªåŠ¨é‡å¯å®¹å™¨ï¼› Never ï¼šä»»ä½•å®¹å™¨æå‡ºï¼Œkubelet éƒ½ä¸é‡å¯å®¹å™¨ï¼› kubelet é‡å¯å®¹å™¨çš„æ—¶é—´é—´éš”ä»¥æŒ‡æ•°çš„æ–¹å¼å¢é•¿ï¼ˆ1nã€2nã€4n â€¦ï¼‰ï¼Œæœ€é•¿å»¶è¿Ÿ 5minã€‚å¦‚æœå®¹å™¨è¿è¡Œäº† 10min æ²¡æœ‰é€€å‡ºï¼Œåˆ™é—´éš”æ—¶é—´ä¼šè¢«é‡ç½®ã€‚ é‡å¯æ—¶é—´é—´éš”å•ä½ é‡å¯é—´éš”æ—¶é—´æ˜¯ä»¥ kubelet handle å‘¨æœŸä¸ºå•ä½ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:3:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4 Probe Probe ä»¥æ—è·¯çš„æ–¹å¼ï¼Œå‘¨æœŸæ€§åœ°æ£€æµ‹ Pod å®¹å™¨çš„æƒ…å†µï¼Œæ£€æµ‹å¤±è´¥æ˜¯åŠæ—¶æ›´æ–° Pod çš„çŠ¶æ€ï¼Œä½¿å¾—ä¸Šå±‚æ„ŸçŸ¥åè¿›è¡Œä¸€äº›æ¢å¤æ“ä½œã€‚ ç›®å‰åŒ…å«ä¸‰ç§æ¢é’ˆï¼šLivenessProbeã€ReadinessProbe å’Œ StartupProbeã€‚ å®¹å™¨ç»´åº¦ è¦æ˜ç¡®ï¼ŒProbe æ˜¯ä»¥å®¹å™¨ä¸ºå¯¹è±¡çš„ï¼Œè€Œä¸æ˜¯ Podã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.1 LivenessProbe LivenessProbe ç”¨äºå‘¨æœŸæ€§åˆ¤æ–­ä¸€ä¸ªå®¹å™¨æ˜¯å¦æ˜¯å­˜æ´»çš„ï¼Œå¦‚æœ LivenessProbe æ¢æµ‹å¤±è´¥ï¼Œé‚£ä¹ˆ kubelet å°†ä¼š â€œæ€æ‰â€ è¯¥å®¹å™¨ã€‚ å®¹å™¨åœæ­¢åï¼Œåç»­çš„æ“ä½œæ˜¯ç”± é‡å¯ç­–ç•¥ æ§åˆ¶çš„ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:4:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.2 ReadinessProbe ReadinessProbe ç”¨äºå‘¨æœŸæ€§åˆ¤æ–­ä¸€ä¸ªå®¹å™¨æ˜¯å¦æ˜¯ Readyï¼Œä»è€Œå½±å“ Pod çš„ Ready condition æ˜¯å¦ä¸º Trueã€‚ åªæœ‰ Pod Ready condition ä¸º True æ—¶ï¼ŒService æ‰å¯ä»¥å°†å…¶ Pod åŠ å…¥åˆ° Endpointsï¼Œä»è€Œè¯¥ Pod æ‰èƒ½æ¥å—è¯·æ±‚å¹¶å¤„ç†ã€‚ åŒæ ·ï¼Œå½“ Pod Ready condition ä» True å˜ä¸º False æ—¶ï¼ŒService ä¼šå°†å…¶ Pod ä» Endpoints ç§»é™¤ã€‚ ä¸ºä½•è¿˜éœ€è¦ Readiness Gateï¼Ÿ å› ä¸º ReadinessProbe æ˜¯ä¸€ç§è¢«åŠ¨æ¢æµ‹çš„æ–¹å¼ï¼Œè€Œ Readiness Gate æä¾›äº†ä¸€ç§ä¸»åŠ¨ä¿®æ”¹çš„æ–¹å¼ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:4:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.3 StartupProbe StartupProbe ä»…ä»…åœ¨å®¹å™¨å¯åŠ¨åä¼šè¿è¡Œï¼Œå¹¶ä¸”æˆåŠŸåä¸ä¼šå†æ¬¡è¿è¡Œï¼Œç›´åˆ°å®¹å™¨é‡æ–°å¯åŠ¨ã€‚ StartupProbe æ˜¯ä¸ºäº†è§£å†³æœ‰äº›å®¹å™¨çš„å¯åŠ¨æƒ…å†µå¾ˆæ…¢çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µåªéœ€è¦è¿›è¡Œä¸€æ¬¡æˆåŠŸçš„æ¢æµ‹ï¼Œæ‰€ä»¥ä¸é€‚åˆ ReadyinessProbe çš„å‘¨æœŸæ€§è¯­ä¹‰ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:4:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"4.4 ä½¿ç”¨ Probe ä¸‰ç§æ¢é’ˆéƒ½å¯ä»¥ä½¿ç”¨ä¸‰ç§æ¢æµ‹æ–¹å¼ï¼š exec ï¼šæ‰§è¡Œä¸€ä¸ª shell å‘½ä»¤ï¼Œé€€å‡ºç ä¸º 0 è¡¨æ˜å®¹å™¨å¥åº·ï¼› spec:containers:- name:livenessimage:k8s.gcr.io/livenesslivenessProbe:exec:command:- cat- /tmp/healthy tcpSocket ï¼šè¿æ¥ TCP çš„ä¸€ä¸ª IP ä¸ Portï¼Œè¿æ¥æˆåŠŸè¡¨æ˜å®¹å™¨å¥åº·ï¼› spec:containers:- name:goproxyimage:k8s.gcr.io/goproxy:0.1ports:- containerPort:8080readinessProbe:tcpSocket:port:8080 httpGet ï¼šå‘é€ä¸€ä¸ª HTTP Get è¯·æ±‚ï¼ŒçŠ¶æ€ç  [200, 400) è¡¨æ˜å®¹å™¨å¥åº·ï¼› spec:containers:- name:livenesslivenessProbe:httpGet:path:/healthzport:8080httpHeaders:- name:Custom-Headervalue:Awesome æ¯ç§æ¢æµ‹å™¨ä¹ŸåŒ…å«å¦‚ä¸‹çš„é…ç½®å‚æ•°ï¼Œç”¨ä»¥æ§åˆ¶æ¢æµ‹çš„è¡Œä¸ºï¼š initialDelaySeconds ï¼šå®¹å™¨å¯åŠ¨åå¤šä¹…å¼€å§‹è¿›è¡Œæ¢æµ‹ã€‚ ä»…ä»…é€‚ç”¨äº LivenessProbe ä¸ ReadinessProbeã€‚ periodSeconds ï¼šæ‰§è¡Œæ¢æµ‹çš„æ—¶é—´é—´éš”ã€‚é»˜è®¤ 10sã€‚ timeoutSeconds ï¼šæ¯æ¬¡æ¢æµ‹çš„è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤ 1sã€‚ successThreshold ï¼šæ¢æµ‹å¤±è´¥åï¼Œç»è¿‡å‡ æ¬¡æ¢æµ‹æˆåŠŸåï¼Œæ‰å°†å…¶å˜ä¸ºå¥åº·çŠ¶æ€ï¼Œé»˜è®¤å€¼ä¸º 1ã€‚ ä»…ä»…é€‚ç”¨äº StartupProbeã€‚ failureThreshold ï¼šè¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡åï¼Œæ‰å°†å…¶å®¹å™¨è§†ä¸ºä¸å¥åº·çŠ¶æ€ï¼Œé»˜è®¤å€¼ä¸º 3ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:4:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"5 Init Container å¤§å¤šæ•°åº”ç”¨åœ¨å¯åŠ¨å‰éƒ½éœ€è¦è¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„æ“ä½œã€‚Kubernetes æä¾›äº† init container æ¥è¿›è¡Œ Pod çš„åˆå§‹åŒ–æ“ä½œã€‚ init container ä¹Ÿæ˜¯æ™®é€šçš„å®¹å™¨ï¼Œä½†æ˜¯ä»…ä»…åªè¿è¡Œä¸€æ¬¡å°±ç»“æŸã€‚å¤šä¸ª init container çš„æƒ…å†µä¸‹ï¼ŒæŒ‰ç…§å®šä¹‰çš„é¡ºåºè¿è¡Œï¼Œå¹¶ä¸”åªæœ‰å‰é¢çš„è¿è¡ŒæˆåŠŸåæ‰ä¼šè¿è¡Œåé¢çš„ã€‚ æŸä¸ª init container è¿è¡Œå¤±è´¥åï¼Œå…¶ Pod çš„å¯åŠ¨æµç¨‹ä¼šç»ˆæ­¢ã€‚è€Œå…¶åçš„æ“ä½œå°±æ˜¯å—åˆ° é‡å¯ç­–ç•¥ çš„æ§åˆ¶ã€‚ init container åœ¨ spec.initContainers ä¸­å®šä¹‰ï¼š apiVersion:v1kind:Podmetadata:name:myapp-podlabels:app:myappspec:containers:- name:myapp-containerimage:busybox:1.28command:['sh','-c','echo The app is running! \u0026\u0026 sleep 3600']initContainers:- name:init-myserviceimage:busybox:1.28command:['sh','-c',\"until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done\"]- name:init-mydbimage:busybox:1.28command:['sh','-c',\"until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done\"] init container ä¸åº”ç”¨å®¹å™¨çš„åŒºåˆ«å¦‚ä¸‹ï¼š å¯åŠ¨é¡ºåºã€‚init container å…¨éƒ¨å¯åŠ¨ç»“æŸåï¼ŒKubernetes æ‰ä¼šåˆå§‹åŒ– Pod å„ç§ä¿¡æ¯ï¼Œç„¶åå¯åŠ¨åº”ç”¨å®¹å™¨ èµ„æºé™åˆ¶ï¼Œè§ï¼šResourceã€‚ init container ä¸èƒ½è®¾ç½® ReadinessProberã€‚ Pod é‡æ–°å¯åŠ¨æ—¶ï¼Œinit container å°†ä¼šé‡æ–°è¿è¡Œã€‚æ‰€ä»¥ init container åº”è¯¥æ˜¯å¹‚ç­‰çš„ã€‚ ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:5:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["Kubernetes å­¦ä¹ "],"content":"6 Ephemeral Container æœ‰æ—¶ç”±äºå®¹å™¨å´©æºƒæˆ–è€…å®¹å™¨é•œåƒä¸åŒ…å« debug å·¥å…·ï¼Œä½¿å¾—é€šè¿‡ kubectl exec æ–¹å¼ä¸èƒ½å¾ˆå¥½çš„è¿›è¡Œè°ƒè¯•ã€‚v1.18 ç‰ˆæœ¬å¼€å§‹ï¼Œæ–°æ·»åŠ ä¸€ä¸ª kubectl debug å‘½ä»¤ï¼Œç”¨äºåˆ›å»º ephemeral container æ¥è¿›è¡Œ debugã€‚ å¼€å¯ç‰¹æ€§ éœ€è¦å¼€å¯ EphemeralContainers feature gate ä½¿ç”¨ kubectl debug çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š $ kubectl debug -it ephemeral-demo --image=busybox --target=ephemeral-demo â€“image ï¼šä¸´æ—¶å®¹å™¨ä½¿ç”¨çš„é•œåƒï¼› â€“target ï¼šåŠ å…¥çš„ Pod ä¸­ç‰¹å®šå®¹å™¨çš„ namespaceï¼› ä¹Ÿå¯ä»¥å¤åˆ¶ä¸€ä¸ª Podï¼Œç„¶åæ·»åŠ ä¸´æ—¶å®¹å™¨æ¥è¿›è¡Œè°ƒè¯•ï¼š $ kubectl debug myapp -it --copy-to=myapp-debug --container=myapp -- sh â€“copy-to ï¼šå°† pod å¤åˆ¶ä¸€ä»½æ–°å‘½åçš„ podï¼› ä½ å¯ä»¥è®©ä¸´æ—¶å®¹å™¨å’Œåº”ç”¨å®¹å™¨å…±äº« pid namespaceï¼Œè¿™æ ·å¯ä»¥è¿›è¡Œç±»ä¼¼ strace è¿™æ ·çš„è¿›ç¨‹æ’æŸ¥ã€‚ kubectl debug myapp -it --image=ubuntu --share-processes --copy-to=myapp-debug â€“share-processes ï¼šä½¿ç”¨ â€“copy-to æ—¶ï¼Œå¼€å¯ pid namespace å…±äº«ï¼› ","date":"2021-06-05","objectID":"/posts/cloud_computing/k8s_learning/1-pod/:6:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å­¦ä¹  - 1 - Pod","uri":"/posts/cloud_computing/k8s_learning/1-pod/"},{"categories":["ç½‘ç»œ"],"content":"SSL/TLS æ€»ç»“","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ ä¹‹å‰ä¸€ç›´å¯¹ TLS ä¸è¯ä¹¦ç†è§£çš„ä¸æ¸…æ™°ï¼Œè¿™é‡Œå°è¯•è¿›è¡Œæ€»ç»“ä¸€ä¸‹ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:0:0","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"1 å¯†ç å¥—ä»¶ SSL åœ¨æ¡æ‰‹çš„ç¬¬ä¸€æ­¥å°±æ˜¯ç¡®è®¤æ‰€ä½¿ç”¨çš„å¯†ç å¥—ä»¶Cipher Suiteï¼Œä½¿å¾—é¦–å…ˆ client ä¸ server ä½¿ç”¨ç›¸åŒçš„ç®—æ³•è¿›è¡Œé€šä¿¡ã€‚å…¶ä¸­åŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼š éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼šè¡¨æ˜ä¼ è¾“ç§˜é’¥ä½¿ç”¨çš„éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä¾‹å¦‚ RSAã€DHE_RSA ç­‰ï¼› å¯¹ç§°åŠ å¯†ç®—æ³•ï¼šåŠ å¯†æ¡æ‰‹åï¼Œä¼ è¾“æ•°æ®ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ï¼Œä¾‹å¦‚ AES_128_CBC ç­‰ï¼› æ•°æ®æ‘˜è¦ç®—æ³•ï¼šæ•°æ®æ ¡éªŒä½¿ç”¨çš„ç®—æ³•ï¼Œä¾‹å¦‚ SHA256 ç­‰ï¼› ä¾‹å¦‚ï¼ŒServer ç«¯ä¼ è¾“ TLS_RSA_WITH_AES_256_CBC_SHA256 ç®—æ³•å¥—ä»¶ï¼Œè¡¨æ˜å…¶è¯¢é—®ä½¿ç”¨ RSA + AES_256_CBC + SHA256 ä¸‰ä¸ªç®—æ³•ç»„ä»¶ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:1:0","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"1.1 å¯¹ç§°åŠ å¯†ç®—æ³• å¯¹ç§°åŠ å¯†ç®—æ³•çš„ä½œç”¨å¾ˆç®€å•ï¼šä½¿ç”¨åŒä¸€ä¸ªç§˜é’¥ï¼Œå‘é€ç«¯è¿›è¡Œæ•°æ®åŠ å¯†ï¼Œæ¥æ”¶ç«¯è¿›è¡Œæ•°æ®è§£å¯†ã€‚ ç›¸æ¯”äºéå¯¹ç§°åŠ å¯†ï¼ŒåŠ è§£å¯†é€Ÿåº¦å¿«ï¼Œæ‰€ä»¥ä¼šç”¨äºä¼ è¾“æ•°æ®çš„åŠ è§£å¯†ã€‚ ä½†æ˜¯ï¼Œå¯¹ç§°åŠ å¯†æ— æ³•è§£å†³ç§˜é’¥ä¼ è¾“é—®é¢˜ï¼Œä¸€æ—¦åŒæ–¹äº¤æ¢ç§˜é’¥æ—¶æ³„éœ²ï¼Œé‚£ä¹ˆæ•°æ®çš„å®‰å…¨æ€§å°±æ— æ³•ä¿éšœäº†ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:1:1","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"1.2 éå¯¹ç§°åŠ å¯†ç®—æ³• è¿™é‡Œä¸ä¼šè¯´æ˜éå¯¹ç§°åŠ å¯†ç®—æ³•çš„ç®—æ³•åŸç†ï¼Œè€Œæ˜¯æƒ³å¼„æ¸…æ¥šä¸ºä»€ä¹ˆä½¿ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ˜ç¡®éå¯¹ç§°åŠ å¯†ç®—æ³•çš„ä½œç”¨ã€‚éå¯¹ç§°åŠ å¯†ç®—æ³•åŒ…å«ä¸¤ä¸ªå¯†ç ï¼š å…¬é’¥ï¼šå¯ä»¥å…¬å¼€çš„ç§˜é’¥ï¼› ç§é’¥ï¼šä¸å¯å…¬å¼€ï¼Œè‡ªèº«æŒæœ‰çš„ç§˜é’¥ï¼› ä½œç”¨å¾ˆç®€å•ï¼Œå¯¹äºéå¯¹ç§°åŠ å¯†ï¼Œç”¨å…¬é’¥åŠ å¯†çš„æ•°æ®åªèƒ½ç”¨ç§é’¥è§£å¼€ï¼Œç”¨ç§é’¥åŠ å¯†çš„æ•°æ®åªèƒ½ç”¨å…¬é’¥è§£å¼€ã€‚ è¿™æ ·çš„ä½œç”¨åœ¨å“ªï¼Ÿå› ä¸ºå¯¹äºå¯¹ç§°åŠ å¯†ï¼Œäº¤æ¢çš„ç§˜é’¥ä¸€æ—¦æ³„éœ²ï¼Œé‚£ä¹ˆåŠ å¯†çš„æ•°æ®å°±ä¼šè¢«ç ´è§£ã€‚è€Œå¯¹äºéå¯¹ç§°åŠ å¯†ï¼Œéœ€è¦äº¤æ¢çš„å¾€å¾€åªæœ‰å…¬é’¥ï¼Œè€Œå…¬é’¥è¢«æ³„éœ²åï¼Œé‚£ä¹ˆä½¿ç”¨å…¬é’¥åŠ å¯†çš„æ•°æ®è¿˜æ˜¯æ— æ³•è¢«ç ´è§£çš„ï¼Œé‚£ä¹ˆè¿˜æ˜¯èƒ½ä¿è¯äº†å•å‘çš„æ•°æ®å®‰å…¨æ€§ã€‚ ä½†æ˜¯ï¼Œéå¯¹ç§°åŠ å¯†ç®—æ³•åŠ è§£å¯†é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥åœ¨ TLS ä¸­ä»…ä»…ç”¨äºäº¤æ¢ç§˜é’¥ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:1:2","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"1.3 æ‘˜è¦ç®—æ³• æ‘˜è¦ç®—æ³•ä¸æ˜¯ç”¨äºæ•°æ®åŠ å¯†çš„ï¼Œè€Œæ˜¯ç”¨äºæ•°æ®çš„æ ¡éªŒã€‚æ— è®ºå¤šå¤§çš„æ•°æ®ï¼Œç»è¿‡æ‘˜è¦ç®—æ³•æœ€åå¾—åˆ°å›ºå®šé•¿åº¦çš„æ•°æ®ã€‚è€Œä¸åŒçš„æ•°æ®å¾—åˆ°çš„æ‘˜è¦ç»“æœæ˜¯ä¸åŒçš„ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬æ¯”è¾ƒä¸¤ä¸ªæ•°æ®çš„æ‘˜è¦ç»“æœï¼Œå°±å¯ä»¥ç¡®å®šä¸¤ä¸ªæ•°æ®æ˜¯å¦ç›¸åŒï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ£€éªŒã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:1:3","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"2 SSH åœ¨ TLS ä¹‹å‰ï¼Œå…ˆè¯´ä¸€ä¸‹ SSHï¼Œgithub ä¸ ssh ç™»å½•éƒ½ä½¿ç”¨äº† SSH åè®®ã€‚ SSHSecure Shell æ˜¯å»ºç«‹åœ¨åº”ç”¨å±‚ä¸ŠåŸºç¡€ä¸Šçš„ç½‘ç»œå®‰å…¨åè®®ï¼ˆæ³¨æ„ï¼Œå…¶æ²¡æœ‰ä½¿ç”¨ TLS åè®®ï¼‰ã€‚ SSH ä½¿ç”¨éå¯¹ç§°åŠ å¯†æŠ€æœ¯ RSA åŠ å¯†äº†æ‰€æœ‰ä¼ è¾“çš„æ•°æ®ã€‚ä½¿ç”¨äº†ä¸¤ç§éªŒè¯æ–¹å¼ï¼š åŸºäºå£ä»¤çš„å®‰å…¨éªŒè¯ï¼šåªè¦çŸ¥é“éœ€è¦ç™»å½•çš„æœºå™¨çš„è´¦å·ä¸å¯†ç ï¼Œå°±å¯ä»¥ç™»å½•ã€‚æ‰€æœ‰ä¼ è¾“çš„æ•°æ®éƒ½ä¼šè¢«åŠ å¯†ï¼Œä½†æ˜¯æ— æ³•é˜²æ­¢â€œä¸­é—´äººâ€æ”»å‡»ã€‚ åŸºäºç§˜é’¥çš„å®‰å…¨éªŒè¯ï¼šæå‰åˆ›å»ºå…¬é’¥ä¸ç§é’¥ï¼ŒæŠŠå…¬é’¥æ”¾åœ¨æœåŠ¡å™¨ä¸Šã€‚åœ¨å®¢æˆ·ç«¯è¦ç™»å½•æœåŠ¡å™¨æ—¶ï¼Œä¼šå‘é€å…¶æœ¬åœ°ä¿å­˜çš„å…¬é’¥ã€‚æœåŠ¡ç«¯åœ¨æŒ‡å®šç›®å½•æŸ¥æ‰¾å¯¹åº”å…¬é’¥æ˜¯å¦åŒ¹é…ã€‚ å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡å™¨ä½¿ç”¨å…¬é’¥æ¥è¿›è¡Œå®¢æˆ·ç«¯çš„éªŒè¯ï¼Œå› æ­¤ Github ä¸ SSH ç™»å½•æ—¶éƒ½éœ€è¦å°†æœ¬åœ°ç”Ÿæˆçš„å…¬é’¥å…ˆæå‰é…ç½®ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:2:0","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"2 SSL/TLS ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:3:0","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"2.1 SSL ä¸ TLS TLSTransport Layer Security æ˜¯ SSLSecure Sockets Layer çš„å‡çº§ç‰ˆï¼Œä¸‹é¢æ˜¯å…¶å‘å±•çš„å†å²ï¼š åè®® åˆ›å»ºæ—¶é—´ RFC SSL 1.0 - SSL 2.0 1995 SSL 3.0 1996 RFC 6101 TLS 1.0 1999 RFC 2246 TLS 1.1 2006 RFC 4346 TLS 1.2 2008 RFC 5246 TLS 1.3 2019 RFC 8446 è€Œ HTTPS å°±æ˜¯åœ¨ TCP å»ºç«‹è¿æ¥åï¼Œå…ˆè¿›è¡Œ TLS åè®®æ¡æ‰‹ï¼Œç„¶åä½¿ç”¨åŠ å¯†ä¼ è¾“ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:3:1","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"2.2 TLS æ¡æ‰‹è¿‡ç¨‹ çœ‹ä¸€ä¸‹å…·ä½“çš„æ¡æ‰‹è¿‡ç¨‹ï¼š ClientHelloï¼šå®¢æˆ·ç«¯å‘èµ·å»ºç«‹ TLS è¿æ¥è¯·æ±‚ï¼ˆTCP è¿æ¥å·²ç»å»ºç«‹ï¼‰ client å‘é€çš„æ¶ˆæ¯ä¸­ï¼Œä¼šè¡¨æ˜å…¶è‡ªèº«æ”¯æŒçš„ TLS ä»¥åŠå¯†ç å¥—ä»¶ï¼Œè®© server å¯ä»¥é€‰æ‹©åˆé€‚çš„ç®—æ³•ã€‚ å³åŒ…æ‹¬å‡ ä¸ªé‡è¦ä¿¡æ¯ï¼š æ”¯æŒçš„ TLS æœ€é«˜ç‰ˆæœ¬ï¼› æ”¯æŒçš„å¯†ç å¥—ä»¶ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§ä¼šè¿›è¡Œæ’åºï¼› æ”¯æŒçš„å‹ç¼©ç®—æ³•ï¼› ï¼ˆå¯é€‰ï¼‰session idï¼Œé€šè¿‡ session é‡ç”¨å¯ä»¥è·³è¿‡ä¸€äº›æ¡æ‰‹è¿‡ç¨‹ï¼› éšæœºä¸²ï¼Œååºç”Ÿæˆå¯†ç ä½¿ç”¨ï¼Œä½¿å¾—æ¯æ¬¡æ¡æ‰‹å¾—åˆ°çš„å¯†ç éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼› ServerHelloï¼šæœåŠ¡ç«¯é€‰å‡ºåˆé€‚çš„å¯†ç å¥—ä»¶ server æ ¹æ® client çš„ hello æ¶ˆæ¯ï¼Œåœ¨è‡ªå·±çš„è¯ä¹¦ä¸­æŸ¥æ‰¾åˆé€‚çš„è¯ä¹¦ï¼ˆè¯ä¹¦é‡ŒåŒ…å«äº†éå¯¹ç§°åŠ å¯†ç®—æ³•å’Œæ‘˜è¦ç®—æ³•ï¼‰ï¼Œå¹¶æŒ‘é€‰å‡ºåˆé€‚çš„å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä¹Ÿå°±å¾—åˆ°äº†å¯†ç å¥—ä»¶ã€‚åŒæ—¶ï¼Œä¹Ÿä¼šè¿”å›ä¸€ä¸ªéšæœºä¸²ã€‚ å¦‚æœ TLS ç‰ˆæœ¬ï¼Œæˆ–è€…å¯†ç å¥—ä»¶æ— æ³•åŒ¹é…ï¼Œé‚£ä¹ˆç›´æ¥ä¼šè¿æ¥å¤±è´¥ã€‚ Certificateï¼šæœåŠ¡ç«¯å‘é€è‡ªå·±çš„è¯ä¹¦ï¼Œè®© client æ£€æŸ¥ ServerKeyExchangeï¼ˆå¯é€‰ï¼‰ï¼šå‘é€éå¯¹æ¥åŠ å¯† premaster ç”Ÿæˆæ‰€éœ€çš„å‚æ•°ï¼ˆå¦‚æœç®—æ³•éœ€è¦çš„è¯ï¼‰ å¯¹äºä¸€äº›éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆDHE_RSAï¼‰ï¼Œéœ€è¦ server ä¼ é€’ä¸€äº›ç‰¹æ®Šçš„å‚æ•°ï¼Œç”¨ä»¥ç”Ÿæˆã€å‡†å¯†ç ï¼ˆpremasterï¼‰ã€‘ï¼Œå› æ­¤éœ€è¦ä¼ é€’ä¸€äº›ç‰¹æ®Šå‚æ•°ã€‚ CertificateRequestï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœæœåŠ¡ç«¯å¼€å¯åŒå‘è®¤è¯ï¼Œé‚£ä¹ˆå°±å‘é€è¯·æ±‚ï¼Œè¦æ±‚ client æä¾›è¯ä¹¦ åœ¨å†…éƒ¨æœåŠ¡çš„ HTTPS ä¸­ï¼Œæœ‰æ—¶å€™ server éœ€è¦å»éªŒè¯ client æ˜¯å¦æ˜¯å†…éƒ¨çš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è¿›è¡ŒåŒå‘è®¤è¯ï¼Œè¿™å°±éœ€è¦ server å»æ£€æŸ¥ client çš„è¯ä¹¦ã€‚ å½“ç„¶ï¼Œå¤§éƒ¨åˆ† Web æœåŠ¡ä¸éœ€è¦ï¼Œè€Œ client è®¤è¯æ˜¯é€šè¿‡è´¦å·å¯†ç æ¥å†³å®šçš„ã€‚ ServerHelloDoneï¼šæœåŠ¡ç«¯è¡¨æ˜ç»“æŸ Certificateï¼ˆå¯é€‰ï¼‰ï¼šclient å‘é€è‡ªå·±çš„è¯ä¹¦ å¦‚æœç¬¬ 5 æ­¥å‘ç”Ÿï¼Œé‚£ä¹ˆ client éœ€è¦å‘é€è‡ªå·±çš„è¯ä¹¦ã€‚å°±ç®— client æ²¡æœ‰è¯ä¹¦ï¼Œä¹Ÿè¦å‘é€ç©ºçš„æ¶ˆæ¯ï¼Œè®© server å†³å®šæ˜¯å¦ç»§ç»­ã€‚ ClientKeyExchangeï¼šéªŒè¯å®Œæ¯•è¯ä¹¦åï¼Œç”Ÿæˆ premasterï¼Œé€šè¿‡è¯ä¹¦ä¸­å…¬é’¥åŠ å¯†åå‘é€ client éªŒè¯å®Œæ¯• server è¯ä¹¦åï¼Œç”Ÿæˆéå¯¹ç§°åŠ å¯†ç®—æ³•çš„ premasterï¼Œç„¶åé€šè¿‡è¯ä¹¦çš„å…¬é’¥å‘é€ã€‚ å¦‚æœç®—æ³•éœ€è¦ï¼Œä¼šä½¿ç”¨ç¬¬ 4 æ­¥æ¥æ”¶çš„ç›¸å…³å‚æ•°è¿›è¡Œç”Ÿæˆã€‚ CertificateVerifyï¼ˆå¯é€‰ï¼‰ï¼šå‘é€ client æ ¡éªŒç  + ç§é’¥åŠ å¯†æ ¡éªŒç çš„æ•°æ®ï¼Œè®© server å°è¯•è§£å¯†å¹¶éªŒè¯ï¼Œæ¥éªŒè¯ client è¯ä¹¦ç¡®å®æ˜¯å±æ€§ client çš„ å¦‚æœç¬¬ 7 æ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆä¸ºäº†é˜²æ­¢ client å‘é€ä¸€ä¸ªä¸å±äºè‡ªèº«çš„è¯ä¹¦ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œä¸€æ¬¡éå¯¹ç§°åŠ å¯†é€šä¿¡ï¼Œä½¿å¾— server ç¡®ä¿è¯ä¹¦æ˜¯å±äº client çš„ï¼ˆclient æ‹¥æœ‰ç€ç§é’¥ï¼‰ã€‚ Finished ï¼šæ ¹æ®å¯†ç å¥—ä»¶ï¼ŒåŒæ–¹ç®—å‡º master å¯†ç ï¼Œå¹¶ä¸”ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•è¿›è¡Œä¸€æ¬¡é€šä¿¡ï¼Œæ¥éªŒè¯å¯†ç æ— è¯¯ã€‚ æ ¹æ®åŠ å¯†å¥—ä»¶ + premasterï¼Œå¹¶ä¸”ä½¿ç”¨ client éšæœºä¸² + server éšæœºä¸²ï¼Œclient server å„ç‹¬ç«‹ç”Ÿæˆ master å¯†ç ï¼Œå¹¶ä¸”æ˜¯ä¸€æ ·çš„ã€‚ æ¥ç€ client ä¸ server éƒ½ä¼šä½¿ç”¨ç¼“å­˜çš„æ ¡éªŒç ï¼Œä½¿ç”¨ master å¯†ç è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼Œç„¶åå‘é€ç»™å¯¹æ–¹ï¼Œè®©å¯¹æ–¹ä½¿ç”¨ master å¯†ç è¿›è¡Œè§£å¯†ã€‚è¿™æ ·æ¥éªŒè¯ master å¯†ç åŒæ–¹ä½¿ç”¨çš„æ˜¯ä¸€æ ·çš„ã€‚ TLS å®Œæˆåï¼Œclient server å°±å¾—åˆ°äº†ç›¸åŒçš„ master å¯†ç ï¼Œä½œä¸ºåç»­å¯¹ç§°åŠ å¯†é€šä¿¡çš„å¯†ç ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:3:2","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"2.3 ä¸ºä½•å®‰å…¨ åœ¨ä¸Šé¢çš„æµç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆ client server ä½¿ç”¨äº†éå¯¹ç§°åŠ å¯†ç®—æ³•æ¥è¿›è¡Œ premaster çš„äº¤æ¢ï¼ˆç¬¬ 8 æ­¥ä½¿ç”¨å…¬é’¥åŠ å¯†åå‘é€ï¼‰ï¼Œè€Œæœ€ç»ˆçš„ master å¯†ç ç”Ÿæˆéœ€è¦ä½¿ç”¨ premaster ä½œä¸ºä¸€ä¸ªå‚æ•°ã€‚ å¯ä»¥ç®€å•åœ°ç†è§£ï¼ŒåŒæ–¹ç”Ÿæˆå¯†ç çš„ä¸€ä¸ªé‡è¦å‚æ•°ä½¿ç”¨äº†éå¯¹ç§°åŠ å¯†ç®—æ³•è¿›è¡Œä¼ è¾“ï¼Œä¿è¯äº†æ•°æ®çš„å®‰å…¨ï¼Œè¿™æ ·æœ€åå„è‡ªç‹¬ç«‹ç”Ÿæˆçš„ master å¯†ç å°±ä¸ä¼šæ³„éœ²ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:3:3","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"3 è¯ä¹¦ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:4:0","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"3.1 åŸç† æˆ‘ä»¬ä»ç”³è¯·è¯ä¹¦çš„è¿‡ç¨‹çœ‹ï¼š ç”Ÿæˆ ç”³è¯·ï¼ˆç­¾åï¼‰æ–‡ä»¶ï¼Œç”³è¯·æ–‡ä»¶ä¸­åŒ…å«äº†è¦ä½¿ç”¨çš„å…¬é’¥ï¼Œä»¥åŠä¸€äº›ç”³è¯·è€…çš„ä¿¡æ¯ï¼šåœ°ç‚¹ã€ç»„ç»‡ç­‰ã€‚ å°†ç”³è¯·æ–‡ä»¶é€šè¿‡å®‰å…¨çš„æ–¹å¼ï¼ˆç§ä¸‹ï¼‰å‘é€ç»™ CAã€‚ CA å°±æ˜¯ä¸€ä¸ªç”¨äºåˆ†å‘è¯ä¹¦çš„æƒå¨æœºæ„ã€‚ CA ä½¿ç”¨è‡ªå·±çš„ç§é’¥ï¼Œå¯¹ç”³è¯·æ–‡ä»¶è¿›è¡Œç­¾åï¼ˆåŠ å¯†ï¼‰ï¼Œå¾—åˆ°äº†è¯ä¹¦ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæœ€åå¾—åˆ°çš„è¯ä¹¦ä¸­åŒ…å«äº†ï¼š åŠ å¯†åçš„å…¬é’¥ ç”³è¯·è€…çš„ä¿¡æ¯ CA ä¿¡æ¯ è¯ä¹¦å¹´é™ ç­‰ åœ¨æµè§ˆå™¨ä¸æœåŠ¡å™¨ä¸­ï¼Œä¼šå†…ç½®ä¸–ç•Œä¸Šæ‰€æœ‰ CA çš„æ ¹è¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯åŒ…å«äº† CA çš„å…¬é’¥ã€‚é€šè¿‡è¯ä¹¦å…¬é’¥å¯¹ server è¯ä¹¦è¿›è¡Œè§£å¯†ï¼Œå¹¶ä¸”åˆ¤æ–­å…¶ä¸­çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥åˆ¤æ–­å‡ºè¯¥è¯ä¹¦æ˜¯å¦æ˜¯ CA ç­¾ç½²çš„ã€‚ Note xx.crt æ˜¯è¯ä¹¦æ–‡ä»¶ï¼Œxx.crs æ˜¯ç”³è¯·æ–‡ä»¶ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:4:1","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"3.2 è‡ªç­¾å å½“æˆ‘ä»¬å†…éƒ¨æœåŠ¡ï¼Œä»…ä»…éœ€è¦è‡ªç­¾åæ—¶ï¼Œå…¶å®å°±æ˜¯è‡ªå·±ç”Ÿæˆäº†ç§°ä¸ºäº†ä¸€ä¸ª CAï¼Œå¾—åˆ°äº†æ ¹è¯ä¹¦ä¸ç§é’¥ã€‚ è€Œåä½¿ç”¨ç§é’¥ç»™ server ç­¾è¯ä¹¦ï¼Œå°†æ ¹è¯ä¹¦å†…ç½®ç»™ client ä½¿ç”¨ï¼Œå°±å¯ä»¥è¿›è¡Œè‡ªç­¾åçš„ TLS é€šä¿¡ã€‚ ä¸‹é¢è¿›è¡Œä¸€æ¬¡è‡ªç­¾åçš„è¿‡ç¨‹ï¼š ç”Ÿæˆæ ¹è¯ä¹¦ä¸ç§é’¥ openssl genrsa -out root.key 2048 openssl req -new -x509 -days 3650 -key root.key -out ca.crt ç”Ÿæˆ server è¯ä¹¦ä¸ç§é’¥ï¼Œå¹¶ä½¿ç”¨æ ¹è¯ä¹¦ç§é’¥ç­¾å openssl req -newkey rsa:2048 -nodes -keyout server.key -out server.csr openssl x509 -req -extfile \u003c(printf \"subjectAltName=DNS:caliper.xycloud.com\") -days 3650 -in server.csr -CA root.crt -CAkey root.key -CAcreateserial -out server.crt ï¼ˆå¯é€‰ï¼‰å¦‚æœéœ€è¦åŒå‘è®¤è¯ï¼Œé‚£ä¹ˆè¦ç”Ÿæˆ client çš„è¯ä¹¦ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„æ ¹è¯ä¹¦ç­¾åã€‚ openssl req -newkey rsa:2048 -nodes -keyout client.key -out client.csr openssl x509 -req -days 3650 -in client.csr -CA root.crt -CAkey root.key -CAcreateserial -out client.crt ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:4:2","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"3.2 æ€»ç»“ æ¢ä¸ªè§’åº¦çœ‹ï¼Œä¸ºäº†å®ç°è‡ªç­¾åï¼ŒåŒå‘ TLSï¼Œä¸¤è¾¹éœ€è¦çš„æ–‡ä»¶ server ç«¯éœ€è¦ server.key - server ç«¯ç§é’¥ server.crt - é€šè¿‡ server.csrï¼Œç”± CA ç­¾ååçš„è¯ä¹¦ certfile := filepath.Join(global.ConfDir(), \"server.crt\") keyfile := filepath.Join(global.ConfDir(), \"server.key\") err := s.server.ListenAndServeTLS(certfile, keyfile) client ç«¯éœ€è¦ client.key - client ç«¯ç§é’¥ client.crt - é€šè¿‡ client.csrï¼Œç”± CA ç­¾ååçš„è¯ä¹¦ ca.crt - CA è¯ä¹¦ï¼Œå› ä¸ºæ˜¯è‡ªç­¾å Note å¦‚æœæ˜¯å•å‘ TLSï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ client ç§é’¥ä¸è¯ä¹¦ï¼ŒCA è¯ä¹¦è¿˜æ˜¯éœ€è¦å†…ç½®ã€‚ è€ŒéªŒè¯å°±æ˜¯ client ä½¿ç”¨å…¬é’¥æ­£å¸¸è§£å¯†æ•°æ®ï¼Œç„¶åæ£€æŸ¥ä¸‹æ•°æ®ã€‚ æ‰€ä»¥è¯ä¹¦ï¼Œå…¶å®å°±æ˜¯ç»™ server â€œç›–äº†ä¸€ä¸ªç« â€ï¼Œè¡¨æ˜å…¶æ˜¯æƒå¨æœºæ„è®¤è¯çš„ã€‚è€Œ client å†…ç½®çš„æ ¹è¯ä¹¦ä½¿å¾— client å¯ä»¥è®¤åˆ°è¿™ä¸ªæƒå¨æœºæ„ã€‚ ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:4:3","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["ç½‘ç»œ"],"content":"å‚è€ƒ Blogï¼šSSL/TLS åŠè¯ä¹¦æ¦‚è¿° ","date":"2021-05-01","objectID":"/posts/net/tls-%E6%80%BB%E7%BB%93/:5:0","tags":["ç½‘ç»œ"],"title":"SSL/TLS æ€»ç»“","uri":"/posts/net/tls-%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"VFS çš„å®ç°","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹ Linux å­˜å‚¨æ¶æ„ä¸­çš„ VFS å±‚çš„ä¸€ä¸ªæ€»ç»“ï¼ŒåŸºæœ¬å†…å®¹æ¥æºäºç½‘ç»œçš„å­¦ä¹ ï¼Œä»¥åŠè‡ªå·±è§‚æ‘©äº†ä¸‹æºç ã€‚ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:0:0","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"1 VFS æ•´ä½“æ¨¡å‹ è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVirtual File System æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹ä¸æ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾—ç”¨æˆ·è¿›ç¨‹æ— éœ€å…³ç³»æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ï¼Œè€Œé€šè¿‡ç›¸åŒçš„ IO æ¥å£å°±å¯ä»¥è¿›è¡Œæ•°æ®çš„è¯»å†™ã€‚ å½“ç”¨æˆ·ç¨‹åºå¯¹ä¸€ä¸ª fd è°ƒç”¨ IO ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒVFS æ ¹æ®å…¶å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè°ƒç”¨å…¶å„ä¸ªå‡½æ•°çš„å®ç°ã€‚ å¯ä»¥å°†å…¶æƒ³è±¡é—®ï¼Œä½ å®šä¹‰äº†ä¸€ä¸ª Golang interface VFSï¼Œè€Œä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå®ç°äº†å…¶ interface çš„æ“ä½œã€‚ä¸Šå±‚åªéœ€è¦è°ƒç”¨ VFS çš„å„ä¸ªæ¥å£å³å¯ã€‚ Tip â€œä¸€åˆ‡çš„æŠ½è±¡å±‚éƒ½æ˜¯ä¸ºäº†è§£è€¦â€ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:1:0","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2 VFS çš„é€šç”¨æ–‡ä»¶æ¨¡å‹ ä¸ºäº†ç®¡ç†ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒVFS éœ€è¦ä¸€ä¸ªé€šç”¨çš„æ–‡ä»¶æ¨¡å‹æ¥æŠ½è±¡æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ¨¡å‹ï¼Œè€Œä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿéœ€è¦é€šè¿‡è‡ªèº«çš„å®ç°æ¥æ»¡è¶³è¿™ä¸ªæ¨¡å‹ã€‚ VFS çš„é€šç”¨æ–‡ä»¶æ¨¡å‹ä¸»è¦åŒ…å« 4 ä¸ªå¯¹è±¡ï¼š superblockï¼šä¿å­˜æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ‰ç€ä¸€ä¸ª superblock å¯¹è±¡ï¼ŒåŒ…å«æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€å¤§å°ã€çŠ¶æ€ç­‰ä¿¡æ¯ï¼› inodeï¼šä¿å­˜ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œä»£è¡¨ç€ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ï¼ŒåŒ…å«æ–‡ä»¶è®¿é—®æƒé™ã€æ–‡ä»¶ç±»å‹ã€å¤§å°ç­‰ï¼ˆä¸åŒ…æ‹¬æ–‡ä»¶åï¼‰ï¼› fileï¼šè¿›ç¨‹æ‰“å¼€æ–‡ä»¶åï¼Œæ–‡ä»¶çš„è¡¨ç¤ºï¼Œè¿›ç¨‹æ‰€çœ‹è§çš„æ–‡ä»¶ï¼› dentryï¼šä¿å­˜æ–‡ä»¶åï¼ˆç›®å½•åï¼‰ä¸å…¶ inode çš„å¯¹åº”å…³ç³»ï¼Œç”¨äºåŠ é€Ÿæ–‡ä»¶çš„æŸ¥è¯¢ï¼› ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:2:0","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.1 inode inode æ˜¯é’ˆå¯¹æ–‡ä»¶ç³»ç»Ÿç»´åº¦è€Œè¨€çš„ï¼Œæ˜¯æ¯ä¸ªæ–‡ä»¶æˆ–ç›®å½•åœ¨æ–‡ä»¶ç³»ç»Ÿçš„å”¯ä¸€æ ‡è¯†ï¼Œå¹¶åŒ…å«å…¶ç›¸å…³çš„å…ƒä¿¡æ¯ã€‚å¯ä»¥æƒ³åˆ°ï¼Œinode éœ€è¦æŒä¹…åŒ–åœ¨å…·ä½“çš„å­˜å‚¨è®¾å¤‡ä¸Šï¼Œç”¨ä»¥æœºå™¨é‡å¯åæ¢å¤æ–‡ä»¶ä¿¡æ¯ã€‚ çœ‹ä¸€ä¸‹ inode çš„ç»“æ„ï¼Œå¯ä»¥çŸ¥æ™“å…¶å¯¹åº”çš„åŒ…å«çš„ä¿¡æ¯ï¼š // fs.h struct inode { umode_t i_mode; kuid_t i_uid; kgid_t i_gid; unsigned int i_flags; const struct inode_operations *i_op; struct super_block *i_sb; struct address_space *i_mapping; #ifdef CONFIG_SECURITY void *i_security; #endif /* Stat data, not accessed from path walking */ unsigned long i_ino; /* * Filesystems may only read i_nlink directly. They shall use the * following functions for modification: * * (set|clear|inc|drop)_nlink * inode_(inc|dec)_link_count */ union { const unsigned int i_nlink; unsigned int __i_nlink; }; dev_t i_rdev; loff_t i_size; struct timespec64 i_atime; struct timespec64 i_mtime; struct timespec64 i_ctime; spinlock_t i_lock; /* i_blocks, i_bytes, maybe i_size */ unsigned short i_bytes; u8 i_blkbits; u8 i_write_hint; blkcnt_t i_blocks; #ifdef __NEED_I_SIZE_ORDERED seqcount_t i_size_seqcount; #endif /* Misc */ unsigned long i_state; struct rw_semaphore i_rwsem; unsigned long dirtied_when; /* jiffies of first dirtying */ unsigned long dirtied_time_when; struct hlist_node i_hash; struct list_head i_io_list; /* backing dev IO list */ #ifdef CONFIG_CGROUP_WRITEBACK struct bdi_writeback *i_wb; /* the associated cgroup wb */ /* foreign inode detection, see wbc_detach_inode() */ int i_wb_frn_winner; u16 i_wb_frn_avg_time; u16 i_wb_frn_history; #endif struct list_head i_lru; /* inode LRU list */ struct list_head i_sb_list; struct list_head i_wb_list; /* backing dev writeback list */ union { struct hlist_head i_dentry; struct rcu_head i_rcu; }; atomic64_t i_version; atomic64_t i_sequence; /* see futex */ atomic_t i_count; atomic_t i_dio_count; atomic_t i_writecount; #if defined(CONFIG_IMA) || defined(CONFIG_FILE_LOCKING) atomic_t i_readcount; /* struct files open RO */ #endif union { const struct file_operations *i_fop; /* former -\u003ei_op-\u003edefault_file_ops */ void (*free_inode)(struct inode *); }; struct file_lock_context *i_flctx; struct address_space i_data; struct list_head i_devices; union { struct pipe_inode_info *i_pipe; struct block_device *i_bdev; struct cdev *i_cdev; char *i_link; unsigned i_dir_seq; }; __u32 i_generation; void *i_private; /* fs or device private pointer */ } __randomize_layout; i_modeï¼šæ–‡ä»¶ç±»å‹ï¼Œæ–‡ä»¶ã€ç›®å½•ç­‰ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›æƒé™ä¿¡æ¯ï¼› i_uidã€i_gidï¼šæ–‡ä»¶æ‰€å±çš„ UID ä¸ GIDï¼› i_flagsï¼šæ–‡ä»¶çŠ¶æ€æ ‡è®°ï¼› i_opï¼šinode æ“ä½œé›†åˆï¼Œä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œä¸åŒçš„æ“ä½œï¼› i_sbï¼šæŒ‡å‘æ‰€å±æ–‡ä»¶ç³»ç»Ÿçš„ superblock ç»“æ„ï¼› i_mappingï¼šinode å¯¹åº”çš„åœ°å€ç©ºé—´ï¼ˆaddress_spaceï¼‰ï¼Œå¯¹äº mmap å¾ˆé‡è¦ï¼› i_inoï¼šinode ç´¢å¼•å·ï¼› i_nlinkï¼šinode å¼•ç”¨è®¡æ•°ï¼› i_rdevï¼šinode è¡¨ç¤ºè®¾å¤‡æ–‡ä»¶æ—¶ï¼Œä¸ºè®¾å¤‡çš„ dev numberï¼ˆmajor+minorï¼‰ï¼› i_sizeï¼šinode å¯¹åº”çš„æ–‡ä»¶å¤§å°ï¼› i_atimeã€i_mtimeã€i_ctimeï¼šæ–‡ä»¶æœ€åè®¿é—®æ—¶é—´ã€æ–‡ä»¶å†…å®¹æœ€åä¿®æ”¹æ—¶é—´ã€inode æœ€åå˜åŒ–æ—¶é—´ï¼ˆæƒé™ã€æ‰€æœ‰è€…ç­‰ï¼‰ i_bytesï¼šæ–‡ä»¶å ç”¨å­˜å‚¨è®¾å¤‡çš„å­—èŠ‚æ•°ï¼ˆè€ƒè™‘ç¨€ç–æ–‡ä»¶ï¼‰ï¼› i_blocksï¼šæ–‡ä»¶å ç”¨å­˜å‚¨è®¾å¤‡çš„å—æ•°ï¼ˆè€ƒè™‘ç¨€ç–æ–‡ä»¶ï¼‰ï¼› i_hashï¼šinode æ‰€å­˜åœ¨çš„ hash è¡¨ï¼› i_lruï¼šinode æ„æˆçš„ LRU listï¼› i_fopï¼šæ–‡ä»¶æ“ä½œå‡½æ•°é›†åˆï¼Œä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸åŒå®ç°ï¼› ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œä»»ä½•æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ¯ä¸€ä¸ªå•å…ƒï¼ˆæ™®é€šæ–‡ä»¶ã€ç›®å½•ã€è®¾å¤‡ã€ç®¡é“ç­‰ç­‰ï¼‰ï¼Œåœ¨ VFS éƒ½ç”±ä¸€ä¸ª inode æ¥æŠ½è±¡ã€‚ å› æ­¤ï¼Œå¯¹äºæ¯ä¸ªè¿›ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ç›¸åŒçš„ï¼Œå³åŸºäºæ–‡ä»¶ç³»ç»ŸæŸä¸ªâ€œæ–‡ä»¶â€çš„å¢åˆ æ”¹æŸ¥ç­‰ç­‰ï¼Œæ¥å£æ˜¯ç»Ÿä¸€çš„ã€‚è€Œå„ä¸ªæ–‡ä»¶ç³»ç»Ÿå°±è¦å®ç°è‡ªèº«çš„ i_opã€i_fop æ“ä½œã€‚ ä¾‹å¦‚ï¼Œå¯¹äºç½‘ç»œ IOï¼Œä¹Ÿæ˜¯é€šè¿‡ VFS å±‚æ“ä½œçš„ï¼Œè€Œéœ€è¦ç½‘ç»œå­ç³»ç»Ÿå®ç°ä¸€ä¸ªèµ°ç½‘ç»œçš„ i_fop æ“ä½œã€‚ Note â€œä¸€åˆ‡çš†æ–‡ä»¶â€ 2.1.1 æ–‡ä»¶ç³»ç»Ÿå¯¹ inode æ“ä½œ çœ‹ä¸€ä¸‹æ–‡ä»¶ç³»ç»Ÿå¯¹ inode çš„æ“ä½œ inode_operationsï¼š // fs.h struct inode_operations { struct dentry * (*lookup) (struct inode *,struct dentry *, unsigned int); const char * (*get_link) (struct dentry *, struct inode *, struct delayed_call *); int (*permission) (struct inode *, int); struct posix_acl * (*get_acl)(struct inode *, int); int (*readlink) (struct dentry *, char __user *,int); int (*create) (struct inode *,struct dentry *, umode_t, bool); int (*link) (struct dentry *,struct inode *,struct dentry *); int (*unlink) (struct inode *,struct dentry *); int (*symlink) (struct inode *,struct dentry *,const char *); int (*mkdir) (struct inode *,struct dentry *,umode_t); int (*rmdir) (struct inode *,struct dentry *); int (*mknod) (struct inode *,struct dentry *,umode_t,dev_t); int (*rename) (struct inode *, struct dentry *, struct inode *, struct dentry *, unsigned int); int (*setattr) (struct dentry *, struct iattr *); int (*getattr) (const struct path *, struct kstat *, u32, uns","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:2:1","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.2 superblock superblock åŒ…å«ä¸€ä¸ªå…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„å…¨å±€ä¿¡æ¯ã€‚ struct super_block { struct list_head s_list; /* Keep this first */ dev_t s_dev; /* search index; _not_ kdev_t */ unsigned char s_blocksize_bits; unsigned long s_blocksize; loff_t s_maxbytes; /* Max file size */ struct file_system_type *s_type; const struct super_operations *s_op; const struct dquot_operations *dq_op; const struct quotactl_ops *s_qcop; const struct export_operations *s_export_op; unsigned long s_flags; unsigned long s_iflags; /* internal SB_I_* flags */ unsigned long s_magic; struct dentry *s_root; struct rw_semaphore s_umount; int s_count; atomic_t s_active; char s_id[32]; /* Informational name */ uuid_t s_uuid; /* UUID */ unsigned int s_max_links; fmode_t s_mode; const struct dentry_operations *s_d_op; /* default d_op for dentries */ /* s_inode_list_lock protects s_inodes */ spinlock_t s_inode_list_lock ____cacheline_aligned_in_smp; struct list_head s_inodes; /* all inodes */ spinlock_t s_inode_wblist_lock; struct list_head s_inodes_wb; /* writeback inodes */ } __randomize_layout; s_list ï¼šæ‰€æœ‰å­˜åœ¨çš„æ–‡ä»¶ç³»ç»Ÿä»¥ list æ–¹å¼ç»„ç»‡ï¼› s_dev ï¼šæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„è®¾å¤‡çš„ dev ç¼–å·ï¼› s_blocksize_bitsã€s_blocksize ï¼š s_maxbytes ï¼šå¯ä»¥åˆ›å»ºçš„æœ€å¤§æ–‡ä»¶å¤§å°ï¼› s_type ï¼šæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼› s_op ï¼šæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ŒåŒ…å« mountã€umount ç­‰æ“ä½œçš„å®ç°ï¼› dq_op ï¼šæ–‡ä»¶ç³»ç»Ÿ quota åŠŸèƒ½çš„å®ç°ï¼› s_magic ï¼šæ–‡ä»¶ç³»ç»Ÿ magic numberï¼Œæ¯ç±»æ–‡ä»¶ç³»ç»Ÿæœ‰ç€å”¯ä¸€çš„ magic numberï¼› s_root ï¼šroot ç›®å½•ï¼Œå¦‚æœæ˜¯å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿçš„è¯ï¼› s_uuid ï¼šæ–‡ä»¶ç³»ç»Ÿ UUIDï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ‰ç€å•æœºå”¯ä¸€çš„ UUIDï¼› s_inodes ï¼šæ‰€æœ‰ inode çš„ç»„æˆçš„é“¾è¡¨ï¼› s_inodes_wb ï¼šæ‰€æœ‰ç­‰å¾… writeback çš„ inode ç»„æˆçš„é“¾è¡¨ï¼› ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:2:2","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.3 file file æ˜¯æ–‡ä»¶åœ¨è¿›ç¨‹ä¸­çš„è¡¨ç¤ºï¼Œå½“è¿›ç¨‹é€šè¿‡ open() æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¾—åˆ°æ–‡ä»¶æè¿°ç¬¦åï¼Œå†…æ ¸å°±ä¼šæœ‰ä¸€ä¸ª file å¯¹è±¡æ¥è¡¨ç¤ºè¿™ä¸ªâ€œæ‰“å¼€â€ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªè¿›ç¨‹æ‰€æ‰“å¼€çš„æ¯ä¸ª fdï¼Œå°±å¯¹åº”è¿™ä¸€ä¸ª file ç»“æ„å¯¹è±¡ã€‚ çœ‹ä¸‹å…·ä½“çš„ file å¯¹è±¡ï¼š // fs.h struct file { union { struct llist_node fu_llist; struct rcu_head fu_rcuhead; } f_u; struct path f_path; struct inode *f_inode; /* cached value */ const struct file_operations *f_op; spinlock_t f_lock; enum rw_hint f_write_hint; atomic_long_t f_count; unsigned int f_flags; fmode_t f_mode; struct mutex f_pos_lock; loff_t f_pos; struct fown_struct f_owner; const struct cred *f_cred; struct file_ra_state f_ra; u64 f_version; #ifdef CONFIG_SECURITY void *f_security; #endif /* needed for tty driver, and maybe others */ void *private_data; #ifdef CONFIG_EPOLL /* Used by fs/eventpoll.c to link all the hooks to this file */ struct list_head f_ep_links; struct list_head f_tfile_llink; #endif /* #ifdef CONFIG_EPOLL */ struct address_space *f_mapping; â€¦ } __randomize_layout __attribute__((aligned(4))); /* lest something weird decides that 2 is OK */ f_owner åŒ…å«å¤„ç†è¯¥æ–‡ä»¶çš„è¿›ç¨‹æœ‰å…³ä¿¡æ¯ï¼Œä¾‹å¦‚è¿›ç¨‹çš„ pidï¼› f_ra è¡¨ç¤ºé¢„è¯»ç›¸å…³çš„æ“ä½œï¼ŒåŒ…å«é¢„è¯»æ–‡ä»¶æ•°æ®çš„å¤§å°ã€é¢„è¯»çš„æ–¹å¼ç­‰ï¼› f_mode ä¸ºæ‰“å¼€æ–‡ä»¶æ—¶ä¼ é€’çš„æ–¹å¼ï¼Œä¾‹å¦‚ readonly rw ç­‰æ¨¡å¼ï¼› f_flags ä¸º open ç³»ç»Ÿè°ƒç”¨æ—¶ä¼ é€’çš„é¢å¤–çš„ flag æ ‡å¿—ï¼› f_path ç”¨äºç»´æŠ¤ä¸¤ä¸ªä¿¡æ¯ï¼š æ–‡ä»¶åä¸ inode ä¹‹é—´çš„å…³è”ï¼ˆdentryï¼‰ï¼› æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ï¼ˆvfsmountï¼‰ï¼› f_op ä¸ºå¯¹åº” inode çš„æ–‡ä»¶æ“ä½œå‡½æ•°ï¼› f_mapping ï¼šæŒ‡å‘æ–‡ä»¶å¯¹åº”çš„ inode çš„åœ°å€ç©ºé—´æ˜ å°„ï¼Œå³ inode -\u003e i_mappingï¼› file.f_path å±æ€§åŒ…å«æ–‡ä»¶å¯¹åº”çš„ dentry å¯¹è±¡ï¼Œdentry ä¸­åŒ…å«ç€å¯¹åº”çš„ inode æŒ‡é’ˆï¼Œå› æ­¤å®Œæˆäº† file -\u003e inode çš„æ˜ å°„ã€‚ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:2:3","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.4 dentry dentry è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªæ–‡ä»¶åä¸å…¶å¯¹åº”çš„ inode çš„å…³ç³»ï¼Œdentry ç»„æˆçš„æ ‘å‹ç»“æ„æ„å»ºèµ·äº†æŸä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•æ ‘ã€‚ æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ‰ç€ä¸€ä¸ªæ²¡æœ‰çˆ¶ dentry çš„æ ¹ç›®å½•ï¼Œè¢«æ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„ superblock æ‰€å¼•ç”¨ã€‚ å¿…é¡»è¦æ¸…æ¥šï¼Œç£ç›˜ç­‰æŒä¹…åŒ–å­˜å‚¨è®¾å¤‡ä¸Šå¹¶æ²¡æœ‰å­˜å‚¨ dentryã€‚dentry æ ‘å‹ç»“æ„çš„æ„å»ºæ˜¯åœ¨ VFS è¯»å–ç›®å½•ã€æ–‡ä»¶çš„æ•°æ®åï¼Œå¯¹åº”åˆ›å»ºå¹¶æ„å»ºçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œdentry æ˜¯ä¸€ä¸ªç¼“å­˜ç»“æ„ï¼Œç”¨äºè¿è¡Œæ—¶æ„å»ºå‡ºæ ‘å‹ç»„ç»‡ç»“æ„ï¼Œæ¥åŠ é€Ÿæ–‡ä»¶ã€ç›®å½•çš„æŸ¥æ‰¾ã€‚ çœ‹ä¸‹å…¶ä¸»è¦çš„æ•°æ®ç»“æ„ï¼š // dcache.h struct dentry { /* RCU lookup touched fields */ unsigned int d_flags; /* protected by d_lock */ seqcount_spinlock_t d_seq; /* per dentry seqlock */ struct hlist_bl_node d_hash; /* lookup hash list */ struct dentry *d_parent; /* parent directory */ struct qstr d_name; struct inode *d_inode; /* Where the name belongs to - NULL is * negative */ unsigned char d_iname[DNAME_INLINE_LEN]; /* small names */ /* Ref lookup also touches following */ struct lockref d_lockref; /* per-dentry lock and refcount */ const struct dentry_operations *d_op; struct super_block *d_sb; /* The root of the dentry tree */ unsigned long d_time; /* used by d_revalidate */ void *d_fsdata; /* fs-specific data */ union { struct list_head d_lru; /* LRU list */ wait_queue_head_t *d_wait; /* in-lookup ones only */ }; struct list_head d_child; /* child of parent list */ struct list_head d_subdirs; /* our children */ /* * d_alias and d_rcu can share memory */ union { struct hlist_node d_alias; /* inode alias list */ struct hlist_bl_node d_in_lookup_hash; /* only for in-lookup ones */ struct rcu_head d_rcu; } d_u; } __randomize_layout; d_parentï¼šçˆ¶ç›®å½•çš„ dentryï¼Œæ ¹ç›®å½• dentry æŒ‡å‘è‡ªèº«ï¼› d_nameï¼šæ–‡ä»¶å/ç›®å½•åï¼› d_inodeï¼šæ–‡ä»¶åå¯¹åº”æ–‡ä»¶/ç›®å½•çš„ inodeï¼› d_opï¼šæ–‡ä»¶ç³»ç»Ÿ dentry æ“ä½œçš„å®ç°ï¼› d_sbï¼šdentry æ‰€å±çš„æ–‡ä»¶ç³»ç»Ÿçš„ superblock ç»“æ„ï¼› d_lockrefï¼šdentry å¼•ç”¨è®¡æ•°ï¼› d_aliasï¼šé“¾è¡¨å…ƒç´ ï¼Œä¸åŒ dentry è¡¨ç¤ºç›¸åŒæ–‡ä»¶æ—¶ï¼Œä¼šé€šè¿‡é“¾è¡¨é“¾æ¥æ‰€æœ‰ dentryã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ç¡¬é“¾æ¥å°†ä¸¤ä¸ªä¸åŒåç§°å¯¹åº”åŒä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼› 2.4.1 dentry æ“ä½œ dentry_operations ç»“æ„ä¿å­˜äº†æŒ‡å‘ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿå¯¹ dentry éœ€è¦å®ç°çš„æ“ä½œã€‚ // dcache.h struct dentry_operations { int (*d_revalidate)(struct dentry *, unsigned int); int (*d_weak_revalidate)(struct dentry *, unsigned int); int (*d_hash)(const struct dentry *, struct qstr *); int (*d_compare)(const struct dentry *, unsigned int, const char *, const struct qstr *); int (*d_delete)(const struct dentry *); int (*d_init)(struct dentry *); void (*d_release)(struct dentry *); void (*d_prune)(struct dentry *); void (*d_iput)(struct dentry *, struct inode *); char *(*d_dname)(struct dentry *, char *, int); struct vfsmount *(*d_automount)(struct path *); int (*d_manage)(const struct path *, bool); struct dentry *(*d_real)(struct dentry *, const struct inode *); } ____cacheline_aligned; d_revalidateï¼šæ£€æŸ¥å†…å­˜ä¸­å„ä¸ª dentry å¯¹è±¡æ„å»ºçš„ç»“æ„ï¼Œæ˜¯å¦ç¬¦åˆå½“å‰æ–‡ä»¶ç³»ç»Ÿçš„æƒ…å†µã€‚è¿™å¯¹äºç½‘ç»œæ–‡ä»¶ç³»ç»Ÿè‡³å…³é‡è¦ã€‚ å› ä¸ºç½‘ç»œæ–‡ä»¶ç³»ç»Ÿä¸ç›´æ¥å…³è”åˆ°å†…æ ¸ä¸ VFSï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½è¦é€šè¿‡ç½‘ç»œ IO æ¥æ”¶é›†ã€‚è¯¥å‡½æ•°ç”¨äºä¿è¯ dentry ç»“æ„ä¸å®é™…æƒ…å†µçš„ä¸€è‡´æ€§ã€‚ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:2:4","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.5 æ¨¡å‹æ€»ç»“ é¦–å…ˆä»å†…æ ¸è§’åº¦çœ‹ï¼Œä¸€ä¸ªå·²ç»æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ç”± superblock + inode ç»„æˆçš„ã€‚æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ä¿å­˜åœ¨ superblock ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶ç”± inode è¡¨ç¤ºã€‚ å¯¹äºä¸€ä¸ªæ–‡ä»¶çš„è¯»å†™ï¼Œå°±æ˜¯æ‰¾åˆ°å¯¹åº”æ–‡ä»¶çš„ inodeï¼Œç„¶åè°ƒç”¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ read/write æ¥å£ã€‚ä¸€ä¸ªç›®å½• inode å¯¹åº”çš„æ•°æ®ï¼Œå°±æ˜¯å…¶å­æ–‡ä»¶æˆ–è€…ç›®å½•çš„å‘½åã€‚ å› ä¸ºæ–‡ä»¶çš„è¯»å†™å¢åˆ æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œä¸ºäº†åœ¨ç›®å½•æ ‘ä¸­æ›´å¿«é€Ÿçš„æŸ¥æ‰¾ inodeï¼Œå†…æ ¸ç»´æŠ¤äº† dentry ç»“æ„æ ‘ï¼Œdentry åŒ…å«äº†æ–‡ä»¶åä¸ inode çš„æ˜ å°„å…³ç³»ï¼Œä½¿å¾—ä¸ç”¨ä¾é è¯»å†™ç£ç›˜æ¥æŸ¥æ‰¾æ–‡ä»¶å¯¹åº”çš„ inodeã€‚ ä»è¿›ç¨‹è§’åº¦çœ‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€å¤šæ–‡ä»¶ï¼Œå› æ­¤ä½¿ç”¨ file ç»“æ„ä»£è¡¨äº†æ¯ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œä» file -\u003e dentry -\u003e inode æ¥æ‰¾åˆ°å…¶å¯¹åº”çš„æ–‡ä»¶ã€‚ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:2:5","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3 æ–‡ä»¶æ“ä½œå®ç° ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:3:0","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.1 æŒ‚è½½ æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æœ‰ mount ç³»ç»Ÿè°ƒç”¨è§¦å‘ï¼Œå½“æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°ä¸€ä¸ªç›®å½•æ—¶ï¼ŒæŒ‚è½½ç‚¹çš„å†…å®¹å°±è¢«æ›¿æ¢ä¸ºäº†è¢«æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ ¹ç›®å½•çš„å†…å®¹ã€‚å‰ä¸€ä¸ªç›®å½•æ¶ˆå¤±ï¼Œæ— æ³•è®¿é—®ï¼Œå½“æŒ‚è½½ç‚¹è¢«å–æ¶ˆæŒ‚è½½ååˆä¼šé‡æ–°å‡ºç°ï¼Œå¹¶ä¸”æ•°æ®ä¸ä¼šæ”¹å˜ã€‚ æ¯ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿéƒ½å¯¹åº”å†…æ ¸ä¸­çš„ mount ç»“æ„å¯¹è±¡ï¼š struct vfsmount { struct dentry *mnt_root; /* root of the mounted tree */ struct super_block *mnt_sb; /* pointer to superblock */ int mnt_flags; } __randomize_layout; struct mount { struct hlist_node mnt_hash; struct mount *mnt_parent; struct dentry *mnt_mountpoint; struct vfsmount mnt; union { struct rcu_head mnt_rcu; struct llist_node mnt_llist; }; #ifdef CONFIG_SMP struct mnt_pcp __percpu *mnt_pcp; #else int mnt_count; int mnt_writers; #endif struct list_head mnt_mounts; /* list of children, anchored here */ struct list_head mnt_child; /* and going through their mnt_child */ struct list_head mnt_instance; /* mount instance on sb-\u003es_mounts */ const char *mnt_devname; /* Name of device e.g. /dev/dsk/hda1 */ struct list_head mnt_list; struct list_head mnt_expire; /* link in fs-specific expiry list */ struct list_head mnt_share; /* circular list of shared mounts */ struct list_head mnt_slave_list;/* list of slave mounts */ struct list_head mnt_slave; /* slave list entry */ struct mount *mnt_master; /* slave is on master-\u003emnt_slave_list */ struct mnt_namespace *mnt_ns; /* containing namespace */ struct mountpoint *mnt_mp; /* where is it mounted */ union { struct hlist_node mnt_mp_list; /* list mounts with the same mountpoint */ struct hlist_node mnt_umount; }; struct list_head mnt_umounting; /* list entry for umount propagation */ #ifdef CONFIG_FSNOTIFY struct fsnotify_mark_connector __rcu *mnt_fsnotify_marks; __u32 mnt_fsnotify_mask; #endif int mnt_id; /* mount identifier */ int mnt_group_id; /* peer group identifier */ int mnt_expiry_mark; /* true if marked for expiry */ struct hlist_head mnt_pins; struct hlist_head mnt_stuck_children; } __randomize_layout; mnt_parentï¼šæŒ‚è½½ç‚¹ä½äºçˆ¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼› mnt_mountpointï¼šæŒ‚è½½ç‚¹ï¼Œä¹Ÿå°±æ˜¯çˆ¶æ–‡ä»¶ç³»ç»Ÿä¸­æŒ‚è½½ç‚¹å¯¹åº”çš„ dentryï¼› mntï¼šåŒ…å«ä»£è¡¨çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å±æ€§ï¼š mnt_rootï¼šæ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•çš„ dentryï¼› mnt_sbï¼šæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„ superblockï¼› mnt_flagsï¼šæŒ‚è½½æ ‡å¿—ï¼› mnt_countï¼šæŒ‚è½½çš„å¼•ç”¨è®¡æ•°ï¼› mnt_nsï¼šæ‰€å±çš„ mount namespaceï¼› mnt_devnameï¼šæŒ‚è½½çš„è®¾å¤‡åç§°ï¼Œä¾‹å¦‚ /dev/sdaï¼› æŒ‚è½½å­æ ‘ç›¸å…³æ•°æ®ç»“æ„ â€¦ï¼› mnt_idï¼šè¯¥æŒ‚è½½çš„å”¯ä¸€ idï¼› mnt_group_idï¼šåŒç»„çš„æŒ‚è½½ç‚¹çš„é›†åˆï¼Œå³ peer group idï¼› 3.1.1 å…±äº«å­æ ‘ æ™®é€šçš„æŒ‚è½½ç†è§£èµ·æ¥å¹¶ä¸éš¾ï¼Œä½†æ˜¯æ¶‰åŠåˆ° bind mount ä¸ mount namespace åï¼Œäº‹æƒ…å¼€å§‹ä¸ä¸€æ ·äº†èµ·æ¥ã€‚æƒ³è±¡å‡ ä¸ªåœºæ™¯ï¼š å¦‚æœç³»ç»Ÿæ–°æ·»åŠ äº†ç£ç›˜ï¼Œå› ä¸ºå®¹å™¨é—´ mount namespace éš”ç¦»äº†æŒ‚è½½ä¿¡æ¯ï¼Œå¦‚æœå®¹å™¨æƒ³ç”¨è¿™ä¸ªç£ç›˜ï¼Œæ˜¯å¦åªèƒ½æ‰‹åŠ¨è¿›è¡ŒæŒ‚è½½ã€‚ Shared subtrees å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ å…±äº«å­æ ‘Shared subtrees å°±æ˜¯ä¸€ç§æ§åˆ¶å­æŒ‚è½½ç‚¹èƒ½å¦åœ¨å…¶ä»–åœ°æ–¹è¢«çœ‹åˆ°çš„æŠ€æœ¯ï¼Œåªä¼šåœ¨ bind mount å’Œ mount namespace ä¸­è¢«ä½¿ç”¨åˆ°ã€‚ è¿™ä¸ªæ¦‚å¿µæ¯”è¾ƒç»•ï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šå¸¸å¸¸ç”¨åˆ°ï¼Œå¯ä»¥å…ˆè·³è¿‡ã€‚ é¦–å…ˆï¼Œéœ€è¦å…ˆçŸ¥é“ä¸¤ä¸ªæ¦‚å¿µï¼š peer groupï¼šä¸€ä¸ªæˆ–å¤šä¸ªæŒ‚è½½ç‚¹çš„é›†åˆï¼ŒåŒç»„çš„æŒ‚è½½ä¹‹é—´ä¼šå…±äº«æŒ‚è½½ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥çœ‹åˆ°ã€‚ ç›®å‰æœ‰ä¸¤ç§æƒ…å†µä¼šè®©ä¸¤ä¸ªæŒ‚è½½ç‚¹å±äºåŒä¸€ä¸ª peer groupï¼š ä½¿ç”¨ mount â€“bindï¼Œå¹¶ä¸”æŒ‚è½½çš„ propagation type ä¸º shareï¼Œè¿™æ ·æºç›®å½•å’Œç›®æ ‡ç›®å½•å±äºåŒä¸€ä¸ª peer groupï¼ˆå‰ææ˜¯æºæ˜¯ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œè€Œä¸æ˜¯æ™®é€šæ–‡ä»¶æˆ–è€…æ™®é€šç›®å½•ï¼‰ã€‚ å½“åˆ›å»ºæ–°çš„ mount namespace æ—¶ï¼Œæ–° namespace ä¼šæ‹·è´ä¸€ä»½è€ namespace çš„æŒ‚è½½ç‚¹ä¿¡æ¯ï¼Œäºæ˜¯æ–°çš„å’Œè€çš„ namespace é‡Œé¢çš„ç›¸åŒæŒ‚è½½ç‚¹å°±ä¼šå±äºåŒä¸€ä¸ª peer groupã€‚ propagation typeï¼šæ¯ä¸ªæŒ‚è½½ç‚¹éƒ½æœ‰ä¸€ä¸ª type æ ‡å¿—ï¼Œç”±å®ƒå†³å®šåŒä¸€ä¸ª peer group é‡Œçš„å…¶ä»–çš„æŒ‚è½½ç‚¹ä¸‹é¢æ˜¯ä¸æ˜¯ä¹Ÿä¼šåˆ›å»ºå’Œç§»é™¤ç›¸åº”çš„æŒ‚è½½ç‚¹ã€‚ ç›®å‰åŒ…å«å››ç§ç±»å‹çš„ propagation typeï¼š MS_SHAREDï¼šæŒ‚è½½ä¿¡æ¯åœ¨åŒä¸€ä¸ª peer group çš„ä¸åŒæŒ‚è½½ç‚¹ä¹‹é—´å…±äº«ä¼ æ’­ï¼› MS_PRIVATEï¼šæŒ‚è½½ä¿¡æ¯ä¸å…±äº«ï¼Œè®¾ç½® private çš„æŒ‚è½½ç‚¹ä¸å±äºä»»ä½•çš„ peer groupï¼› MS_SLAVEï¼šä¼ æ’­æ˜¯å•å‘çš„ï¼ŒåŒä¸€ä¸ª peer group ä¸­ï¼Œmaster çš„æŒ‚è½½ç‚¹ä¸‹é¢å‘ç”Ÿå˜åŒ–ä¼šå…±äº«åˆ° slaveã€‚åä¹‹ï¼Œslave ä¸‹å˜åŒ–ä¸ä¼šå½±å“ masterï¼› MS_UNBINDABLEï¼šå’Œ MS_PRIVATE ç›¸åŒï¼Œåªæ˜¯è¿™ç§ç±»å‹æŒ‚è½½ç‚¹ä¸èƒ½ä½œä¸º bind mountï¼› å¯ä»¥çœ‹åˆ°ï¼Œpeer cgroup çš„æ¦‚å¿µå°±æ˜¯ mount ç»“æ„ä¸­çš„ mnt_group_idï¼Œå„ä¸ªä¸åŒçš„ type çš„å­æŒ‚è½½ï¼Œä¼šè¢«ä¿å­˜åœ¨ä¸åŒçš„ mount çš„é“¾è¡¨ä¸­ã€‚ æœ‰ä¸ªå¤§ç¥ç»™å‡ºäº†æ¸…æ™°çš„ç¤ºä¾‹ä¸è§£é‡Šï¼Œè§ï¼šShared subtrees ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:3:1","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.2 æŸ¥æ‰¾ inode æŸ¥æ‰¾ inode åº”è¯¥æ˜¯æœ€å¸¸è§çš„æ“ä½œäº†ï¼Œå½“ä½ è¦æ‰“å¼€æ–‡ä»¶æˆ–è€…è¿›å…¥ç›®å½•ï¼Œå†…æ ¸ç¬¬ä¸€ä¸ªä»»åŠ¡å°±æ˜¯è¦æ ¹æ®å…¶è·¯å¾„ï¼Œæ¥æŸ¥æ‰¾åˆ°å¯¹åº”çš„ inodeã€‚ å› ä¸º dentry çš„å­˜åœ¨ï¼ŒæŸ¥æ‰¾è‡ªç„¶åˆ†ä¸ºäº†ï¼šé€šè¿‡ dentry ç¼“å­˜æŸ¥æ‰¾ï¼Œä»¥åŠé€šè¿‡å®é™…çš„è¯»æ–‡ä»¶ç³»ç»ŸæŸ¥æ‰¾ã€‚ å…ˆçœ‹ä¸‹é€šè¿‡ dentry ç¼“å­˜æŸ¥æ‰¾ï¼š è§£ææ–‡ä»¶è·¯å¾„ï¼Œç„¶åä¸æ–­æŸ¥æ‰¾å¯¹åº”çš„ dentryã€‚ ä¾‹å¦‚ /a/b/cï¼Œå…ˆé€šè¿‡ root dentry æŸ¥æ‰¾ a å¯¹åº”çš„ dentryï¼Œæ¥ç€é€šè¿‡ a dentry æŸ¥æ‰¾ bï¼Œä¸æ–­å¾ªç¯ã€‚ å› ä¸º dentry åªæ˜¯ç¼“å­˜ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ d_revalidate() æ¥æ£€æŸ¥ dentry æ˜¯å¦æ˜¯æœ‰æ•ˆåœ°ã€‚ è¿”å›æœ‰æ•ˆ dentry çš„ inodeã€‚ å½“å¯¹åº” dentry ä¸å­˜åœ¨ï¼Œæˆ–è€…æ— æ•ˆä¹‹åï¼Œå°±ä¼šé€šè¿‡æ–‡ä»¶ç³»ç»Ÿ inode æ“ä½œ lookup() æ¥å£ï¼Œé€šè¿‡åº•å±‚çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŸ¥æ‰¾ï¼Œå¹¶å°†å…¶é‡æ–°è®°å½•åˆ° dentry ä¸­ã€‚ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:3:2","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"å‚è€ƒ Blogï¼šlinux çš„ VFS è¯¦è§£ ","date":"2021-03-13","objectID":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/:4:0","tags":["linux","storage"],"title":"Linux å­˜å‚¨æ¶æ„ - VFS æ€»ç»“","uri":"/posts/linux/storage/linux-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84-vfs%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"Golang å¸¸è§è°ƒè¯•æ–¹æ³•å½’çº³æ€»ç»“","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹ Golang è°ƒè¯•æ–¹æ³•çš„ä¸€ä¸ªæ€»ç»“ï¼ŒåŸºæœ¬å†…å®¹æ¥æºäºç½‘ç»œçš„å­¦ä¹ ï¼Œä»¥åŠè‡ªå·±è§‚æ‘©äº†ä¸‹æºç ã€‚ æ‰€ä»¥å­¦ä¹ çš„ä¹¦ç±ä¸æ–‡ç« è§ å‚è€ƒã€‚ ","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/:0:0","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1 go pprof Go pprof æ˜¯ Go æ€§èƒ½åˆ†æå·¥å…·ï¼Œåœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è®°å½•è¿è¡Œçš„ï¼šCPUã€Memã€goroutine ç­‰æƒ…å†µã€‚åŸºæœ¬å®šä½ Go ç¨‹åºçš„é—®é¢˜ç¬¬ä¸€ååº”å°±æ˜¯ä½¿ç”¨ go pprofã€‚ pprof åƒåŸºæœ¬çš„é‡‡é›†ä¸€æ ·ï¼Œåˆ†ä¸ºé‡‡é›†ã€ä¸ŠæŠ¥ã€åˆ†æä¸‰ä¸ªéƒ¨åˆ†ã€‚ ","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/:1:0","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.1 é‡‡é›† Go æ ‡å‡†åº“æä¾›ä¸ªå„ä¸ªæ•°æ®çš„é‡‡é›†æ¥å£ï¼Œå¯ä»¥ä¸»åŠ¨å¼€å¯ pprof å¹¶å°†æ•°æ®å†™å…¥åˆ° io.writer ä¸­ã€‚ å…¶åŒ…æ‹¬ï¼š pprof.Profiles() ï¼šè¿”å›æ”¯æŒçš„ profile çš„å¿«ç…§ã€‚åŒ…æ‹¬ï¼šgoroutineã€threadcreateã€heapã€allocsã€blockã€mutexï¼› trace.Start() / trace.Stop() ï¼šå¼€å¯å„ä¸ªäº‹ä»¶çš„è¿½è¸ªï¼ŒåŒ…æ‹¬ goroutine çŠ¶æ€å˜æ›´ã€GC äº‹ä»¶ã€mheap å¤§å°å˜æ›´ç­‰ï¼› runtime åŒ…å‡½æ•°ï¼› ä¸è¿‡å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ net/http/pprof å°±è¡Œäº†ï¼Œå…¶æ³¨å†Œäº†å„ä¸ª HTTP è¯·æ±‚çš„å¤„ç†å‡½æ•°ï¼Œè€Œå…¶å‡½æ•°ä½¿ç”¨å‰é¢çš„æ¥å£è¿›è¡Œçš„æ•°æ®çš„é‡‡é›†ã€‚ // net/http/pprof/pprof.go func init() { http.HandleFunc(\"/debug/pprof/\", Index) http.HandleFunc(\"/debug/pprof/cmdline\", Cmdline) http.HandleFunc(\"/debug/pprof/profile\", Profile) http.HandleFunc(\"/debug/pprof/symbol\", Symbol) http.HandleFunc(\"/debug/pprof/trace\", Trace) } /debug/pprof/ ï¼šå¼•å¯¼ç•Œé¢ï¼ŒåŒ…å«å„ä¸ªå­ç±»åˆ«çš„è®¿é—®ï¼› /debug/pprof/cmdline ï¼šè¾“å‡ºç¨‹åºå¯åŠ¨çš„å‘½ä»¤è¡Œï¼› /debug/pprof/profile ï¼šè¾“å‡ºå¤§å¤šæ•° profile ç»“æœï¼Œè°ƒç”¨ pprof.Profiles()ï¼› /debug/pprof/trace ï¼šä¸€å®šæ—¶é—´å†… go runtime äº‹ä»¶çš„è¿½è¸ªï¼Œè°ƒç”¨ trace.Start()ï¼› ","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/:1:1","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.2 ä¸ŠæŠ¥ å‰é¢çœ‹åˆ°ï¼Œnet/http/pprof åŒ…å°± init æ³¨å†Œå¯¹åº”çš„ HTTP è¯·æ±‚å¤„ç†å‡½æ•°ï¼Œè€Œæˆ‘ä»¬åªè¦åœ¨ç¨‹åºä¸­å¯¼å…¥ net/http/pprof å¹¶å¯åŠ¨ä¸€ä¸ª HTTP Server å°±å¯ä»¥ä½¿ç”¨å…¶æä¾›çš„ä¸ŠæŠ¥çš„åŠŸèƒ½ã€‚ package main import ( \"net/http\" _ \"net/http/pprof\" ) func main() { // â€¦ // å¯åŠ¨å¯¹åº”çš„ HTTP Server // è¿™é‡Œæˆ‘çš„ç¨‹åºä¸­ main å‡½æ•°åé¢ä¼šé˜»å¡, æ‰€ä»¥ç”¨åç¨‹å¯åŠ¨ server go func() { if err := http.ListenAndServe(\"0.0.0.0:12300\", nil); err != nil { panic(err) } }() // â€¦ } 1.2.1 æµè§ˆå™¨æ–¹å¼ æµè§ˆå™¨æ‰“å¼€æŒ‡å®šçš„åœ°å€çš„ /debug/pprof/ é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å¼•å¯¼é¡µé¢ï¼š å„ä¸ªæ”¯æŒçš„ profile éƒ½æœ‰ç®€è¦çš„è§£é‡Šï¼Œè¿™é‡Œç¿»è¯‘ä¸€ä¸‹ï¼š allocs ï¼šè¿‡å»æ‰€æœ‰çš„å†…å­˜åˆ†é…çš„æ ·æœ¬ï¼› block ï¼š cmdline ï¼šè¾“å‡ºç¨‹åºæ‰§è¡Œçš„å‘½ä»¤ï¼› goroutine ï¼šæ‰€æœ‰ goroutine å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼› heap ï¼šheap å†…å­˜ä½¿ç”¨çš„æ ·æœ¬ï¼› mutex ï¼š profile ï¼šä¸€å®šæ—¶é—´å†…çš„ CPU profileï¼Œå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šé‡‡é›†å¤šå°‘æ—¶é—´ï¼› threadcreate ï¼šåˆ›å»ºæ–°çš„ç³»ç»Ÿçº¿ç¨‹çš„å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä¹Ÿè®¸åœ¨ cgo ä¸­å¾ˆæœ‰ç”¨ï¼› trace ï¼šä¸€å®šæ—¶é—´å†…ç¨‹åºçš„æ‰§è¡Œ traceï¼Œå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šé‡‡é›†æ—¶é—´ã€‚ å½“ä½ ç‚¹å‡»å…¶ä¸­çš„æŸä¸€é¡¹æ—¶ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªç”¨äº profile çš„æ•°æ®æ–‡ä»¶ï¼Œé€šè¿‡ go tool profile æˆ–è€… go tool trace ç­‰å‘½ä»¤å¯ä»¥å°†å…¶å¯è§†åŒ–ã€‚ Tip ä¹Ÿè®¸ä½ ç‚¹å‡» heap æˆ–è€…å…¶ä»–ä¼šå‘ç°æµè§ˆå™¨æ‰“å¼€äº†ä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œè¿™æ˜¯æµè§ˆå™¨ç›´æ¥å°†è·å–çš„æ•°æ®å±•ç¤ºäº†å‡ºæ¥ï¼Œä½†æ˜¯å…¶æ•°æ®å¯è¯»æ€§å¾ˆå·®ã€‚ ä½ å¯ä»¥ä½¿ç”¨ curl ä¿å­˜æ•°æ®æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥é€šè¿‡ go tool profile \u003caddr\u003e/debug/profile/heap æ¥è·å–æ–‡ä»¶å¹¶è§£æã€‚ ","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/:1:2","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.3 è§£æ é€šè¿‡ go tool pprof å¯ä»¥è§£æ pprof å¾—åˆ°çš„æ•°æ®æ–‡ä»¶ã€‚go tool pprof \u003cfile\u003e æ‰§è¡Œåä¼šè¿›å…¥ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œï¼Œå…¶ä¸­é€šè¿‡å„ä¸ªå‘½ä»¤å¯ä»¥è¿›è¡Œæ•°æ®æ–‡ä»¶çš„è§£æä¸å±•ç¤ºã€‚ å¸¸ç”¨çš„å‘½ä»¤åŒ…æ‹¬ï¼š top \u003cN\u003e ï¼šå±•ç¤ºå‰ N ä¸ªæ•°æ®æœ€å¤§çš„é¡¹ï¼› list \u003cpackge\u003e.\u003cfunc\u003e ï¼šåˆ—å‡ºæŸä¸ªå‡½æ•°çš„æŒ‡æ ‡ï¼› traces ï¼šå±•ç¤ºå„ä¸ª goroutine çš„è°ƒç”¨æ ˆï¼Œä»¥åŠå¯¹åº”çš„æŒ‡æ ‡ï¼› web ï¼šé€šè¿‡æµè§ˆå™¨æ‰“å¼€è§£æåçš„å›¾ç‰‡ï¼› 1.3.1 heap æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ heap é¡¹çš„æ•°æ®æ–‡ä»¶ï¼Œä¸‹è½½åé€šè¿‡ go tool pprof çš„ web å‘½ä»¤æ‰“å¼€ï¼š $ go tool pprof http://10.9.195.138:12300/debug/pprof/heap å¼¹å‡ºçš„æµè§ˆå™¨çš„å›¾ç‰‡ä¸­ï¼Œå±•ç¤ºå„ä¸ªå‡½æ•°çš„ç”³è¯·çš„ heap å ç”¨ã€‚å…¶ä¸­ï¼Œæ¡†è¶Šå¤§å°±ä»£è¡¨ä½¿ç”¨çš„è¶Šå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆå¿«å¯ä»¥æ‰¾åˆ°å†…å­˜ä½¿ç”¨æœ€å¤šçš„å‡½æ•°ã€‚ 1.3.2 alloc å¯¹äº heap é¡¹å±•ç¤ºçš„æ˜¯ä¸€ç¬é—´çš„ heap ä½¿ç”¨çš„å¿«ç…§ã€‚ä½†æ˜¯æœ‰ä¸€äº›æƒ…å†µä» heap é¡¹çš„æ•°æ®ä¸­çœ‹ä¸å‡ºæ¥ï¼Œä¾‹å¦‚ä¸€ç›´åœ¨å¿«é€Ÿç”³è¯·æ— ç”¨å†…å­˜ï¼Œè€Œå¯¼è‡´ GC é¢‘ç¹è§¦å‘ã€‚è¿™ç§æƒ…å†µè™½ç„¶æ•´ä½“ç¨‹åºå†…å­˜å ç”¨ä¸å¤§ï¼Œä½†æ˜¯æ˜¯é¢‘ç¹ GC ä¹‹åçš„å‡è±¡ã€‚ è€Œ alloc å°±æ˜¯ç”¨äºå±•ç¤ºç”³è¯·å†…å­˜å¤§å°ï¼Œè¿™ä¸ heap å±•ç¤ºå½“å‰å ç”¨å†…å­˜å¤§å°æ˜¯ä¸ä¸€æ ·çš„ã€‚ $ go tool pprof http://10.9.195.138:12300/debug/pprof/allocs 1.3.3 goroutine Go è‡ªå¸¦å†…å­˜å›æ”¶ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼çš„æƒ…å†µã€‚è€Œå¤§éƒ¨åˆ†æ‰€è¯´çš„å†…å­˜æ³„æ¼ï¼Œéƒ½æ˜¯ç”±äº goroutine æ³„æ¼å¯¼è‡´çš„ goroutine ç»“æ„å ç”¨å†…å­˜è¿‡å¤šã€‚ å¦‚æœç›´æ¥ç‚¹å‡»æµè§ˆå™¨çš„ goroutine é¡¹ä¸­ï¼Œä¼šå±•ç¤ºå‡ºæ‰€æœ‰ goroutine çš„ä¸Šä¸‹æ–‡ã€‚ ä½†æ˜¯è¿™ä¸åˆ©äºåˆ†ææ•´ä½“çš„ goroutine æƒ…å†µï¼Œè¿˜æ˜¯é€šè¿‡ go tool profile å‘½ä»¤æ¥çœ‹ï¼š $ go tool pprof http://10.9.195.138:12300/debug/pprof/goroutine åœ¨è§£æåçš„å›¾ç‰‡ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å„ä¸ªå‡½æ•°åˆ›å»ºçš„ goroutine çš„æ•°é‡ï¼Œå› æ­¤å¯ä»¥å¾ˆå¿«æ‰¾åˆ° goroutine æ³„æ¼çš„æƒ…å†µï¼ˆå›¾ç‰‡ä¸æ˜¯æ³„æ¼ï¼Œåªæ˜¯å±•ç¤ºä¸€ä¸‹ï¼‰ã€‚ 1.3.4 profile profile é¡¹ç”¨äºå±•ç¤ºå„ä¸ªå‡½æ•°çš„ CPU æ‰§è¡Œæ—¶é—´ï¼Œå½“ä½ å‘ç°ç¨‹åº CPU ä½¿ç”¨å¼‚å¸¸æ—¶ï¼Œè¿™é¡¹éå¸¸å…³é”®ã€‚ é»˜è®¤æƒ…å†µä¼šç¨‹åºåœ¨æ”¶åˆ°æƒ…å†µåï¼Œé‡‡é›† 30s å†…çš„å„ä¸ªå‡½æ•°çš„ CPU æ‰§è¡Œæ—¶é—´ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°æ¥è°ƒæ•´è¯¥æ—¶é—´ã€‚ $ go tool pprof http://10.9.195.138:12300/debug/pprof/profile?seconds=30 ä¸€çœ¼å°±å¯ä»¥çœ‹åˆ°æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å‡½æ•°æµï¼š 1.3.5 trace ä¸å‰é¢å‡ ä¸ªä¸åŒï¼Œtrace å¯ä»¥ç”¨äºè·Ÿè¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚go runtime ä¼šä¸ŠæŠ¥ç‰¹å®šçš„ trace äº‹ä»¶ï¼Œè€Œ trace å°†å…¶æ”¶é›†å¹¶å±•ç¤ºå‡ºæ¥ã€‚ $ curl http://10.9.195.138:12300/debug/pprof/trace\\?seconds\\=30 \u003e trace.out $ go tool trace trace.out æ‰§è¡Œå‘½ä»¤åï¼Œæµè§ˆå™¨ä¼šå¼¹å‡ºä¸€ä¸ªé¡µé¢ï¼ˆå¿…é¡»æ˜¯ Chromeï¼‰ï¼ŒåŒ…å«å‡ ä¸ªåˆ†æé¡¹ï¼ŒåŒ…æ‹¬ï¼š é¡¹ç›® ä½œç”¨ View trace æŒ‰ç…§æ—¶é—´ç»´åº¦è§‚å¯Ÿå„ä¸ªäº‹ä»¶ï¼› Goroutine analysis æŸ¥çœ‹å„ä¸ª G çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰§è¡Œæ—¶é—´ï¼Œé˜»å¡æ—¶é—´ç­‰ï¼› Network blocking profile ç½‘ç»œæ¥å£é˜»å¡æƒ…å†µï¼› Synchronization blocking profileï¼šç”¨æˆ·æ€é˜»å¡æƒ…å†µï¼ŒåŒ…æ‹¬ selectã€chan é˜»å¡ç­‰ï¼› Syscall blocking profile ç³»ç»Ÿè°ƒç”¨å¯¼è‡´çš„é˜»å¡æƒ…å†µï¼Œæœ€å¸¸è§çš„å°±æ˜¯ IO ç³»ç»Ÿè°ƒç”¨ï¼› Scheduler latency profile å„ä¸ªå‡½æ•°çš„æ‰§è¡Œæ—¶é—´æƒ…å†µï¼› User defined task User defined regions Minimum mutator utilization å±•ç¤ºå‡ºäº† GC å¤–ï¼Œåº”ç”¨èƒ½å¤Ÿè·å¾—çš„ CPU èµ„æºçš„æœ€å°æ¯”ä¾‹ï¼› (1) View trace é€‰æ‹© â€œView traceâ€ï¼Œä¼šå‡ºç°ä¸€ä¸ªä»¥æ—¶é—´ä¸ºæ¨ªè½´çš„å›¾ç‰‡ã€‚ æŒ‰ä½ W æ”¾å¤§åå¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­æ¯ä¸ª P æ‰§è¡Œçš„ G çš„æ—¶é—´æ®µä¸äº‹ä»¶ï¼ˆäº‹ä»¶æ‰§è¡Œæ˜¯ä¸ªç«–çº¿ï¼‰éƒ½ä¼šå±•ç¤ºå‡ºæ¥ã€‚å„ä¸ª G ç›´æ¥å­˜åœ¨äº‹ä»¶ï¼Œç‚¹å‡» Flow events åè¿˜ä¼šå±•ç¤ºå‡ºäº‹ä»¶æµã€‚ ä¸Šé¢ G76 è¿™ä¸ª Goroutineï¼Œç»è¿‡äº† P0 æ‰§è¡Œ -\u003e ç³»ç»Ÿè°ƒç”¨é˜»å¡ -\u003e P2 æ‰§è¡Œ ç‚¹å‡»å…¶ä¸­ä¸€ä¸ªæ®µï¼Œå¯ä»¥çœ‹åˆ°è¯¥ G çš„æ‰§è¡Œçš„ç»Ÿè®¡ä¿¡æ¯ã€‚ Titleï¼šG ç¼–å·ä»¥åŠæ‰§è¡Œçš„å‡½æ•° Startï¼šå¯åŠ¨æ—¶é—´ï¼› Wall Durationï¼šæ‰§è¡Œæ—¶é—´ï¼› Start Stack Traceï¼šG å¼€å§‹æ‰§è¡Œçš„å‡½æ•°æ ˆï¼› End Stack Traceï¼šG åˆ‡æ¢å‰æˆ–è€…ç»“æŸçš„å‡½æ•°æ ˆï¼› (2) Goroutine analysis é€‰æ‹© â€œGoroutine analysisâ€ åï¼Œç‚¹å‡»ä¸€ä¸ªå…·ä½“çš„ Gï¼Œå¯ä»¥çœ‹åˆ°å…¶æ‰§è¡Œæ—¶é—´çš„ç»Ÿè®¡ã€‚ ","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/:1:3","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2 delve pprof æ˜¯ç¨‹åºæ•´ä½“çš„è¿è¡Œæƒ…å†µçš„æ•°æ®ï¼Œå¦‚æœæƒ³å¯¹ç¨‹åºæ‰§è¡Œè¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œå°±éœ€è¦ä½¿ç”¨ delveã€‚ delve ç±»ä¼¼äº gdbï¼Œä½†æ˜¯ gdb æ˜¯é’ˆå¯¹äºçº¿ç¨‹çš„ï¼Œæ— æ³•è¯†åˆ« goroutineã€‚è€Œ delve æ˜¯ä¸“é—¨ç”¨äº Go ç¨‹åºçš„ï¼Œå¯ä»¥åšåˆ°é’ˆå¯¹ä¸åŒ goroutine æ‰“æ–­ç‚¹ï¼Œå•æ­¥æ‰§è¡Œç­‰æ“ä½œã€‚ ","date":"2021-02-18","objectID":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/:2:0","tags":["Golang","Golang å¼€å‘"],"title":"[WIP] Go è°ƒè¯•æ–¹æ³•æ€»ç»“","uri":"/posts/language/golang/go-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"Linux ç½‘ç»œæ”¶å‘åŒ…å†…æ ¸è¿‡ç¨‹æ€»ç»“","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹ Linux ç½‘ç»œæ”¶å‘åŒ…ä¸€ä¸ªæ€»ç»“ï¼ŒåŸºæœ¬å†…å®¹æ¥æºäºç½‘ç»œçš„å­¦ä¹ ï¼Œä»¥åŠè‡ªå·±è§‚æ‘©äº†ä¸‹æºç ã€‚ æ‰€ä»¥å­¦ä¹ çš„ä¹¦ç±ä¸æ–‡ç« è§ å‚è€ƒã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:0:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"1 èƒŒæ™¯çŸ¥è¯† ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:1:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"1.1 ä¸­æ–­ ä¸­æ–­ç»ˆæ­¢ CPU æ‰§è¡Œæµï¼Œç«‹å³æ‰§è¡Œå¿…è¦çš„å¤„ç†ç¨‹åºã€‚åˆ†ä¸ºä¸¤ä¸ªç±»å‹ï¼š åŒæ­¥ä¸­æ–­å’Œå¼‚å¸¸ï¼šç”± CPU è‡ªèº«äº§ç”Ÿã€‚ä¾‹å¦‚ç¨‹åºå´©æºƒã€ç¼ºé¡µå¼‚å¸¸ï¼› å¼‚æ­¥ä¸­æ–­ï¼šç”± IO è®¾å¤‡äº§ç”Ÿï¼Œä»»æ„æ—¶é—´å¯èƒ½å‘ç”Ÿï¼› ä¸¤ç§ä¸­æ–­å‘ç”Ÿåï¼ŒCPU ä¼šåˆ‡æ¢è‡³å†…æ ¸æ€ï¼Œå¹¶æ‰§è¡Œ ä¸­æ–­å¤„ç†ç¨‹åºinterrupt handlerã€‚ å¯¹äºå¼‚æ­¥ä¸­æ–­ï¼Œå› ä¸ºä¼šåœæ­¢å½“å‰æ‰§è¡Œçš„è¿›ç¨‹ï¼Œæ‰€ä»¥å†…æ ¸è¦ç¡®ä¿ä¸­æ–­å¤„ç†ç¨‹åºå°½å¿«å®Œæˆï¼Œå°½å¿«è¿”è¿˜ CPUã€‚åŒæ ·ï¼Œä¹Ÿä¼šé˜»å¡ IO è®¾å¤‡çš„ä¸‹ä¸€æ¬¡ä¸­æ–­ï¼ŒLinux å°†å¼‚æ­¥ä¸­æ–­åˆ†ä¸ºäº† ç¡¬ä»¶ä¸­æ–­ ä¸ ä¸­æ–­ä¸‹åŠéƒ¨ã€‚ 1.1.1 ç¡¬ä»¶ä¸­æ–­ ç¡¬ä»¶ä¸­æ–­hardware interrupt æŒ‡ç¡¬ä»¶è®¾å¤‡å‘èµ·ä¿¡å·ä¸­æ–­ CPU æ‰§è¡Œï¼ŒCPU ç«‹å³è¿›è¡Œä¸­æ–­çš„å¤„ç†ã€‚ å®é™…ä¸Šï¼Œä¸ºäº†ä¸é•¿æ—¶é—´é˜»å¡ä¸ä¸­æ–­å¤„ç†ï¼Œç¡¬ä¸­æ–­å¾€å¾€å¯åŠ¨åˆ°çš„æ˜¯ä¸€ä¸ªé€šçŸ¥çš„ä½œç”¨ã€‚ä¾‹å¦‚ç½‘å¡æ”¶åˆ°æ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡ DMA å†™å…¥ ringbuffer åï¼Œä¼šé€šè¿‡ç¡¬ä¸­æ–­é€šçŸ¥ CPU ä» ringbuffer è¯»å–å¹¶å¤„ç†æ•°æ®ã€‚ é€šè¿‡ /proc/interrupts å¯ä»¥çœ‹åˆ°ç¡¬ä¸­æ–­çš„è§¦å‘æ¬¡æ•°ï¼š $ cat /proc/interrupts # â€¦ CPU0 100: 15 IR-PCI-MSI 35651584-edge p2p1-TxRx-0 101: 0 IR-PCI-MSI 35651585-edge p2p1-TxRx-1 102: 0 IR-PCI-MSI 35651586-edge p2p1-TxRx-2 103: 0 IR-PCI-MSI 35651587-edge p2p1-TxRx-3 104: 0 IR-PCI-MSI 35651588-edge p2p1-TxRx-4 105: 0 IR-PCI-MSI 35651589-edge p2p1-TxRx-5 106: 0 IR-PCI-MSI 35651590-edge p2p1-TxRx-6 ç¬¬ä¸€è¡Œï¼šIRQ ç¼–å·ï¼› ç¬¬äºŒè¡Œï¼šæ¯ä¸ª CPU çš„ä¸­æ–­æ¬¡æ•°ï¼› ç¬¬ä¸‰è¡Œï¼šä¸­æ–­çš„ç±»å‹ï¼› ç¬¬å››è¡Œï¼šï¼Ÿï¼Ÿï¼› ç¬¬äº”è¡Œï¼šä¸­æ–­å‘èµ·çš„è®¾å¤‡åï¼› å¹³æ—¶å¯èƒ½åªéœ€è¦å…³æ³¨ç¬¬äº”è¡Œè®¾å¤‡åç§°å°±è¡Œï¼Œå› ä¸ºå¯èƒ½è¦è¿‡æ»¤å‡ºç½‘å¡å¯¹åº”é˜Ÿåˆ—çš„ä¸­æ–­ï¼Œç„¶åå°†å…¶ç»‘å®šè§¦å‘çš„ CPUï¼Œè§ ç½‘å¡å¤šé˜Ÿåˆ—ã€‚ 1.1.2 ä¸­æ–­ä¸‹åŠéƒ¨ ä¸­æ–­ä¸‹åŠéƒ¨bottom half åŒ…å«ä¸‰ç§å¤„ç†æ–¹å¼ï¼š è½¯ä¸­æ–­ softirqï¼šå›ºå®šçš„ 32 ä¸ªæ¥å£ï¼Œåªç•™ç»™å¯¹æ—¶é—´è¦æ±‚æœ€ä¸¥æ ¼çš„ä¸‹åŠéƒ¨ä½¿ç”¨ã€‚ æŸ¥çœ‹ /proc/softirqs æ–‡ä»¶ å¯ä»¥çœ‹åˆ°ç›®å‰æ”¯æŒçš„è½¯ä¸­æ–­ï¼š å‘½å å«ä¹‰ HI TIMER å®šæ—¶ä¸­æ–­ NET_TX ç½‘ç»œå‘é€ NET_RX ç½‘ç»œæ¥æ”¶ BLOCK IRQ_POLL TASKLET tasklet è½¯ä¸­æ–­æ‰©å±• SCHED å†…æ ¸è°ƒåº¦ HRTIMER RCU RCU é” taskletï¼šå› ä¸ºè½¯ä¸­æ–­åªæœ‰å›ºå®šçš„ 32 ä¸ªï¼Œä¸ºäº†æ”¯æŒæ‰©å±•ï¼Œtasklet åŸºäºè½¯ä¸­æ–­æ—¶é—´ï¼Œåœ¨ä¸åŒå¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå¹¶ä¸”æ”¯æŒé€šè¿‡ä»£ç åŠ¨æ€æ³¨å†Œï¼› å·¥ä½œé˜Ÿåˆ— work queueï¼šå°†ä¸€ä¸ªä¸­æ–­çš„éƒ¨åˆ†å·¥ä½œæ¨åï¼Œå¯ä»¥å®ç°ä¸€äº› tasklet ä¸èƒ½å®ç°çš„å·¥ä½œï¼ˆæ¯”å¦‚å¯ä»¥ç¡çœ ï¼‰ã€‚ ä¸€äº›å†…æ ¸çº¿ç¨‹ä¼šä¸æ–­å¤„ç†å·¥ä½œé˜Ÿåˆ—çš„æ•°æ®ï¼Œå…¶è¿è¡Œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸”å¯ä»¥ç¡çœ ä»¥åŠè¢«é‡æ–°è°ƒåº¦ã€‚ç›®å‰ï¼Œkworker å†…æ ¸çº¿ç¨‹ è´Ÿè´£å¤„ç†è¿™ä¸ªå·¥ä½œã€‚ å¯¹äºè½¯ä¸­æ–­ä¸ taskletï¼Œå¦‚æœå¤§é‡å‡ºç°æ—¶ï¼Œä¸ºäº†ä¸ä¸€ç›´è¿›è¡Œ CPU ä¸­æ–­ï¼Œå†…æ ¸ä¼šå”¤é†’ ksoftirqd å†…æ ¸çº¿ç¨‹è¿›è¡Œå¼‚æ­¥çš„å¤„ç†ã€‚æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ª ksoftirqd/n çº¿ç¨‹ï¼Œn ä¸º CPU ç¼–å·ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:1:1","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2 ç½‘å¡å±‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:2:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.1 ç½‘å¡å¤šé˜Ÿåˆ— ç½‘å¡ä¸ç³»ç»Ÿä¼ è¾“æ•°æ®åŒ…é€šè¿‡ä¸¤ä¸ªç¯å½¢é˜Ÿåˆ—ï¼šTX ring bufferã€RX ring bufferï¼Œä¹Ÿç§°ä¸º DMA ç¯å½¢é˜Ÿåˆ—ã€‚å¹³æ—¶æ‰€è¯´çš„è®¾ç½®ç½‘å¡å¤šé˜Ÿåˆ—æŒ‡çš„å°±æ˜¯è®¾ç½®è¿™ä¸ªç¯å½¢é˜Ÿåˆ—çš„æ•°é‡ã€‚ å½“ç½‘å¡æ”¶åˆ°å¸§æ—¶ï¼Œä¼šé€šè¿‡å“ˆå¸Œæ¥å†³å®šå°†å¸§æ”¾åœ¨å“ªä¸ª ring buffer ä¸Šï¼Œç„¶åé€šè¿‡ç¡¬ä¸­æ–­é€šçŸ¥å…¶å¯¹åº”çš„ CPU å¤„ç†ã€‚ é»˜è®¤ä¸‹ï¼Œå¤„ç†ç¯å½¢é˜Ÿåˆ—æ•°æ®ç”± CPU0 è´Ÿè´£ï¼Œå¯ä»¥é€šè¿‡é…ç½® ä¸­æ–­äº²å’Œæ€§ï¼Œæˆ–è€…é€šè¿‡å¼€å¯ irqbalance service å°†ä¸­æ–­å‡è¡¡åˆ°å„ä¸ª CPU ä¸Šã€‚ 2.1.1 é…ç½®ç½‘å¡é˜Ÿåˆ— é€šè¿‡ ethool -l/-L \u003cnic\u003e å‘½ä»¤æŸ¥çœ‹ä¸é…ç½®ç½‘å¡çš„é˜Ÿåˆ—æ•°ï¼Œé€šå¸¸é…ç½®çš„ä¸æœºå™¨ CPU ä¸ªæ•°ä¸€æ ·ï¼ˆå¦‚æœç½‘å¡æ”¯æŒçš„è¯ï¼‰ï¼š $ ethtool -l eth0 Channel parameters for eth0: Pre-set maximums: RX: 0 TX: 0 Other: 1 Combined: 8 Current hardware settings: RX: 0 TX: 0 Other: 1 Combined: 7 $ ethtool -L eth0 combined 8 è®¾ç½®åï¼Œä½ åœ¨ /sys/class/net/\u003cnic\u003e/queues/ å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æ”¶å‘é˜Ÿåˆ—ç›®å½•ï¼š $ ls /sys/class/net/eth0/queues/ rx-0 rx-1 rx-2 rx-3 rx-4 rx-5 rx-6 rx-7 tx-0 tx-1 tx-2 tx-3 tx-4 tx-5 tx-6 tx-7 åœ¨ /proc/interrupts ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å„ä¸ªé˜Ÿåˆ—å¯¹å„ä¸ª CPU çš„ä¸­æ–­æ¬¡æ•°ï¼š $ cat /proc/interrupts | grep eth0 # â€¦ è¿™é‡Œåªæ‰“å°äº†ä¸€ä¸ª CPU ä¸­æ–­ CPU0 62: 0 IR-PCI-MSI 524288-edge eth0 63: 0 IR-PCI-MSI 524289-edge eth0-TxRx-0 64: 0 IR-PCI-MSI 524290-edge eth0-TxRx-1 65: 1766 IR-PCI-MSI 524291-edge eth0-TxRx-2 66: 0 IR-PCI-MSI 524292-edge eth0-TxRx-3 67: 0 IR-PCI-MSI 524293-edge eth0-TxRx-4 68: 0 IR-PCI-MSI 524294-edge eth0-TxRx-5 69: 0 IR-PCI-MSI 524295-edge eth0-TxRx-6 70: 0 IR-PCI-MSI 524296-edge eth0-TxRx-7 é€šè¿‡ ethtool -g/-G \u003cnic\u003e å¯ä»¥æŸ¥çœ‹ä¸é…ç½® ring buffer çš„é•¿åº¦ï¼š $ ethtool -g eth0 Ring parameters for eth0: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 256 RX Mini: 0 RX Jumbo: 0 TX: 256 2.1.2 é…ç½®ä¸­æ–­äº²å’Œæ€§ å¦‚æœä½ å‘ç° CPU0 çš„ä¸­æ–­å¾ˆé«˜ï¼Œé‚£ä¹ˆå°±å¾ˆæœ‰å¯èƒ½æ‰€æœ‰ç½‘å¡é˜Ÿåˆ—çš„ä¸­æ–­éƒ½æ‰“åˆ°äº† CPU0 ä¸Šã€‚å¯ä»¥é€šè¿‡ /proc/irq/\u003cid\u003e/smp_affinity_list æŸ¥çœ‹æŒ‡å®šç¼–å·çš„ä¸­æ–­çš„å¯¹åº”å…è®¸çš„ CPUã€‚ $ for i in {62..70}; do echo -n \"Interrupt $iis allowed on CPUs \"; cat /proc/irq/$i/smp_affinity_list; done Interrupt 62 is allowed on CPUs 4 Interrupt 63 is allowed on CPUs 8 Interrupt 64 is allowed on CPUs 13 Interrupt 65 is allowed on CPUs 21 Interrupt 66 is allowed on CPUs 6 Interrupt 67 is allowed on CPUs 31 Interrupt 68 is allowed on CPUs 5 Interrupt 69 is allowed on CPUs 2 Interrupt 70 is allowed on CPUs 31 62-70 çš„ç½‘å¡é˜Ÿåˆ—ä¸­æ–­éƒ½æ‰“åˆ°äº†ä¸åŒçš„ CPU ä¸Šï¼› é€šè¿‡å†™å…¥ echo \"\u003cbitmark\u003e\" \u003e /proc/irq/\u003cid\u003e/smp_affinity å¯ä»¥ä¸­æ–­ç»‘å®šçš„ CPUï¼Œbitmark çš„æ¯ä¸ªä½å¯¹åº”ä¸€ä¸ª CPUï¼Œä¾‹å¦‚ â€œ0x1111â€ è¡¨ç¤º CPU 0-3 éƒ½å¯ä»¥å¤„ç†è¿™ä¸ªä¸­æ–­ã€‚ å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ irqbalance æ¥å‡è¡¡å„ä¸ª CPU çš„ä¸­æ–­ï¼ŒåŠ¨æ€çš„æ”¹å˜ä¸­æ–­ä¸ç»‘å®šçš„ CPUã€‚ä¸è¿‡ï¼Œirqbalance ä¸ä»…ä»…é’ˆå¯¹ç½‘å¡é˜Ÿåˆ—ä¸­æ–­ï¼Œè¿˜ä¼šè°ƒæ•´å…¶ä»–çš„ã€‚ å¦‚æœä½ çš„ç½‘å¡ä¸æ”¯æŒå¤šé˜Ÿåˆ—ï¼Œå¯ä»¥å°è¯•é…ç½® RPSã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:2:1","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.2 æ¥æ”¶æ•°æ® å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œç½‘å¡æ¥æ”¶åˆ°æ•°æ®æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚ packet è¿›å…¥ç‰©ç†ç½‘å¡ï¼Œç‰©ç†ç½‘å¡ä¼šæ ¹æ®ç›®çš„ mac åˆ¤æ–­æ˜¯å¦ä¸¢å¼ƒï¼ˆé™¤éæ··æ‚æ¨¡å¼ï¼‰ï¼› ç½‘å¡é€šè¿‡ DMA æ–¹å¼å°† packet å†™å…¥åˆ° ringbuffer ringbuffer ç”±ç½‘å¡é©±åŠ¨ç¨‹åºåˆ†é…å¹¶åˆå§‹åŒ–ã€‚ ç½‘å¡é€šè¿‡ç¡¬ä¸­æ–­é€šçŸ¥ CPUï¼Œæœ‰æ•°æ®æ¥äº†ã€‚ CPU æ ¹æ®ä¸­æ–­æ‰§è¡Œä¸­æ–­å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ç½‘å¡é©±åŠ¨å‡½æ•°ã€‚ é©±åŠ¨ç¨‹åºå…ˆç¦ç”¨ç½‘å¡ä¸­æ–­ï¼ˆNAPIï¼‰ï¼Œè¡¨ç¤ºç½‘å¡ä¸‹æ¬¡ç›´æ¥å†™åˆ° ringbuffer å³å¯ï¼Œä¸éœ€è¦ä¸­æ–­é€šçŸ¥äº†ã€‚ è¿™æ ·é¿å… CPU ä¸æ–­è¢«ä¸­æ–­ã€‚ é©±åŠ¨ç¨‹åºå¯åŠ¨è½¯ä¸­æ–­ï¼Œè®© CPU æ‰§è¡Œè½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸æ–­ä» ringbuffer è¯»å–å¹¶å¤„ç† packetã€‚ ç½‘å¡å¤šé˜Ÿåˆ—å°±æ˜¯åœ¨è¿™é‡Œç”Ÿæ•ˆï¼Œç½‘å¡ä¼šå°† packet æ”¾ç½®åˆ°ä¸åŒçš„ ringbufferï¼Œä¸åŒçš„ ringbuffer ä¼šä¸­æ–­ä¸åŒçš„ CPUï¼ˆå¦‚æœè®¾ç½®äº†ä¸­æ–­äº²å’Œæ€§ï¼‰ï¼Œä½¿å¾—å„ä¸ª CPU çš„é˜Ÿåˆ—ç¡¬ä¸­æ–­æ˜¯å‡è¡¡çš„ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:2:2","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"2.3 å‘é€æ•°æ® ç½‘ç»œè®¾å¤‡é€šè¿‡é©±åŠ¨å‡½æ•°å‘é€æ•°æ®åï¼Œå°±å½’ç½‘å¡é©±åŠ¨ç®¡äº†ï¼Œä¸åŒçš„é©±åŠ¨æœ‰ç€ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚ å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š å°† sk_buff æ”¾å…¥ TX ringbuffã€‚ é€šçŸ¥ç½‘å¡å‘é€æ•°æ®ã€‚ ç½‘å¡å‘é€å®Œæ•°æ®åï¼Œé€šè¿‡ä¸­æ–­é€šçŸ¥ CPUã€‚ æ”¶åˆ°ä¸­æ–­åï¼Œè¿›è¡Œ sk_buff çš„æ¸…ç†å·¥ä½œã€‚ å½“ç„¶ï¼Œç½‘å¡é©±åŠ¨è¿˜æœ‰ä¸€äº›ä¸ net_device æ‰“äº¤é“çš„åœ°æ–¹ï¼Œæ¯”å¦‚ç½‘å¡çš„é˜Ÿåˆ—æ»¡äº†ï¼Œéœ€è¦å‘Šè¯‰ä¸Šå±‚ä¸è¦å†å‘äº†ï¼Œç­‰é˜Ÿåˆ—æœ‰ç©ºé—²çš„æ—¶å€™ï¼Œå†é€šçŸ¥ä¸Šå±‚æ¥ç€å‘æ•°æ®ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:2:3","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3 ç½‘ç»œè®¿é—®å±‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:3:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.1 net_device æ¯ä¸ªç½‘ç»œè®¾å¤‡éƒ½è¡¨ç¤ºä¸º net_device ä¸€ä¸ªå®ä¾‹ã€‚ä¸åŒç±»å‹çš„ç½‘ç»œè®¾å¤‡éƒ½ä¼šæœ‰ net_device è¡¨ç¤ºï¼Œè€Œå…¶ç›¸å…³æ“ä½œå‡½æ•°çš„å®ç°ä¸åŒã€‚ net_device æ˜¯é’ˆå¯¹äº namespace çš„ï¼Œé€šè¿‡ sysfs ä½ å¯ä»¥çœ‹åˆ°å½“å‰å‘½åç©ºé—´ä¸‹æ‰€æœ‰çš„ net_deviceã€‚ $ ls /sys/class/net docker0 enp0s3 enp0s8 lo lxcbr0 vethea62395 net_device åŒ…å«äº†è®¾å¤‡ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå®šä¹‰å¾ˆé•¿ï¼Œ ä¸‹é¢ç»è¿‡ç®€åŒ–ï¼š struct net_device { char name[IFNAMSIZ]; // IO ç›¸å…³å­—æ®µ unsigned long mem_end; unsigned long mem_start; unsigned long base_addr; int irq; unsigned long state; struct list_head dev_list; int ifindex; const struct net_device_ops *netdev_ops; const struct ethtool_ops *ethtool_ops; unsigned int flags; unsigned int mtu; unsigned short type; unsigned short hard_header_len; unsigned char perm_addr[MAX_ADDR_LEN]; unsigned char addr_len; #if IS_ENABLED(CONFIG_VLAN_8021Q) struct vlan_info __rcu *vlan_info; #endif // â€¦ åè®®ç›¸å…³çš„ç‰¹æ®ŠæŒ‡é’ˆ /* Interface address info used in eth_type_trans() */ unsigned char *dev_addr; struct netdev_rx_queue *_rx; unsigned int num_rx_queues; unsigned int real_num_rx_queues; struct bpf_prog __rcu *xdp_prog; unsigned long gro_flush_timeout; int napi_defer_hard_irqs; rx_handler_func_t __rcu *rx_handler; void __rcu *rx_handler_data; struct netdev_queue __rcu *ingress_queue; truct netdev_queue *_txï¼› unsigned int num_tx_queues; unsigned int real_num_tx_queues; struct Qdisc *qdisc; unsigned int tx_queue_len; }; name[IFNAMSIZ] ï¼šè®¾å¤‡å‘½åï¼› irq ï¼širq ç¼–å·ï¼› ifindex ï¼šè®¾å¤‡ç¼–å·ï¼› mtu ï¼šè®¾å¤‡çš„æœ€å¤§ä¼ è¾“å•å…ƒï¼› netdev_ops ï¼šè®¾å¤‡çš„æ“ä½œæ¥å£ï¼Œä¸åŒç±»å‹çš„æ¥å£æœ‰ç€ä¸åŒçš„æ“ä½œå®ç°ï¼› dev_addr ï¼šç½‘å¡ç¡¬ä»¶åœ°å€ï¼› _rx ï¼šæ•°æ®åŒ…æ¥æ”¶é˜Ÿåˆ—ï¼ˆringbufferï¼‰ï¼› _tx ï¼šæ•°æ®åŒ…å‘é€é˜Ÿåˆ—ï¼› qdisc : è®¾å¤‡è¿›å…¥çš„ qdiscï¼› ingress_queue ï¼šingress é˜Ÿåˆ—ï¼› å…¶ä»–åŒ…å«ä¸€äº› XDP ç›¸å…³ï¼Œç»Ÿè®¡ç›¸å…³ç­‰å­—æ®µï¼› å¤§å¤šæ•°çš„ç»Ÿè®¡ä¿¡æ¯éƒ½å¯ä»¥åœ¨å¯¹åº”è®¾å¤‡çš„ sysfs ç›®å½•ä¸­æ‰¾åˆ°ã€‚ ç½‘å¡å‘½å linux å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šé»˜è®¤ç»™ç½‘å¡ä»¥ ethx æ–¹å¼å‘½åï¼Œåé¢ systemd å›å» rename ç½‘å¡åç§°ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:3:1","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.2 GRO GROGeneric Receive Offloading ç”¨äºå°† jumbo frameï¼ˆè¶…è¿‡ 1500Bï¼‰çš„å¤šä¸ªåˆ†ç‰‡åˆå¹¶ï¼Œç„¶åå°†ç»™ä¸Šå±‚å¤„ç†ï¼Œä»¥å‡å°‘ä¸Šå±‚å¤„ç†æ•°æ®åŒ…çš„æ•°é‡ã€‚ é€šè¿‡ ethtool -k/K \u003cnic\u003e æŸ¥å’Œè®¾ç½® GROã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:3:2","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.3 RPS XPS RFS 3.3.1 RPS ç½‘å¡å¤šé˜Ÿåˆ—éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œè€Œ RPSReceive Packet Steering è¿™äº›åˆ™æ˜¯è½¯ä»¶å®ç°å¤šé˜Ÿåˆ—ï¼Œå°†åŒ…è®©æŒ‡å®šçš„ CPU å»å¤„ç†ã€‚é€šå¸¸æƒ…å†µï¼Œå½“ç½‘å¡é˜Ÿåˆ—æ•°å°äº CPU ä¸ªæ•°æ—¶ï¼Œå¯ä»¥è®© RPS è¿›ä¸€æ­¥åˆ©ç”¨å¤šä½™çš„ CPUï¼Œè®©å…¶å»å¤„ç†ä¸­æ–­ã€‚ Note RPS çš„è®¾ç½®æ˜¯é’ˆå¯¹å•ä¸ª ringbuffer çš„ï¼Œä¸ç½‘å¡å¤šé˜Ÿåˆ—å¤„ç†ä¸æ˜¯åŒä¸€ä¸ªé˜¶æ®µï¼Œä¹Ÿä¸æ˜¯å†²çªçš„ã€‚ å¼€å¯ RPS åï¼Œæ•°æ®ä¼šç”±ç»ç”±è¢«ä¸­æ–­ CPU è½¬å‘ï¼Œç”±å…¶ä»– CPU å¤„ç†ã€‚æµç¨‹å¦‚ä¸‹ï¼š å½“ç½‘å¡æ”¶åˆ°æ•°æ®å­˜å…¥ ring buffer åï¼Œè¿˜æ˜¯é€šçŸ¥æŒ‡å®š CPUx ä» ringbuffer å–å‡ºæ•°æ®ï¼› ä¸è¿‡æ¥ä¸‹æ¥ï¼ŒCPUx ä¼šä¸ºæ¯ä¸ª packet å“ˆå¸Œæ”¾å…¥å…¶ä»– CPU çš„ input_pkt_queue ä¸­ã€‚ CPUx é€šè¿‡ Inter-processor Interrupt (IPI) ä¸­æ–­å‘ŠçŸ¥å…¶ä»– CPUï¼Œå¤„ç†è‡ªå·±çš„ input_pkt_queue ï¼› å…¶ä»– CPU ä»å„ä¸ªçš„ input_pkt_queue ä¸­å–å‡ºæ•°æ®åŒ…ï¼Œå¹¶å¤„ç†ä¹‹åçš„æµç¨‹ï¼› å¯ä»¥çœ‹åˆ°ï¼ŒRPS ä¸æ˜¯ç”¨äºå‡å°‘ CPU è½¯ä¸­æ–­çš„æ¬¡æ•°ï¼Œè€Œæ˜¯ç”¨äºå°†æ•°æ®åŒ…å¤„ç†æ—¶é—´å‡æ‘Šåˆ°å„ä¸ª CPU ä¸Šï¼Œä¹Ÿå°±æ˜¯å‡å°‘å•ä¸ª CPU çš„è½¯ä¸­æ–­æ‰§è¡Œæ—¶é—´ï¼ˆ%softï¼‰ã€‚ # é…ç½®è¯¥ ringbuffer ä½¿ç”¨ CPU0 CPU1 çš„é˜Ÿåˆ— $ echo \"0x11\" \u003e /sys/class/net/eth0/queues/rx-0/rps_cpus # é…ç½®æ¯ä¸ª CPU çš„ input_pkt_queue çš„å¤§å° $ sysctl -w net.core.netdev_max_backlog=1000 3.3.2 RFS RFSReceive Flow Steering ä¸€èˆ¬å’Œ RPS é…åˆå·¥ä½œã€‚ RPS å°†å—åˆ°çš„ packet ç»è¿‡å“ˆå¸Œå‘é…åˆ°ä¸åŒçš„ CPU input_pkt_queueã€‚è€Œ RFS ä¼šæ ¹æ® packet çš„æ•°æ®æµï¼Œå‘é€åˆ°å¯¹åº”è¢«å¤„ç†çš„ CPU input_pkt_queue ä¸Šï¼Œå³åŒä¸€ä¸ªæ•°æ®æµçš„ packet ä¼šè¢«è·¯ç”±åˆ°å¤„ç†å½“å‰æ•°æ®æµçš„ CPU ä¸Šï¼Œä»è€Œæé«˜ CPU cache çš„å‘½ä¸­ç‡ã€‚ RFS é»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦é€šè¿‡é…ç½®ç”Ÿæ•ˆï¼Œä¸€èˆ¬æ¨èçš„é…ç½®å¦‚ä¸‹ï¼š # é…ç½®ç³»ç»ŸæœŸæœ›çš„æ´»è·ƒè¿æ¥æ•° $ sysctl -w net.core.rps_sock_flow_entries=32768 # é…ç½®æ¯ä¸ª rps é˜Ÿåˆ—è´Ÿè´£çš„ flow æœ€å¤§æ•°é‡ï¼Œä¸º rps_sock_flow_entries / N $ echo 2048 \u003e /sys/class/net/eth0/queues/rx-0/rps_flow_cnt 3.3.3 XPS XPSTransmit Packet Steering åˆ™æ˜¯å‘é€æ—¶çš„å¤šé˜Ÿåˆ—å¤„ç†ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:3:3","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.4 æ¥æ”¶æ•°æ® åœ¨ç½‘å¡å±‚ä¸­ï¼Œæœ€åç”±å¼‚æ­¥çš„è½¯ä¸­æ–­å¤„ç†å‡½æ•°æ¥å¼‚æ­¥çš„ä»é‡Œ ringbuffer çš„æ•°æ®ã€‚è€Œè¿™ç”±å†…æ ¸çº¿ç¨‹ ksoftirqd æ¥è°ƒç”¨å¯¹åº”çš„ç½‘ç»œè½¯ä¸­æ–­å‡½æ•°å¤„ç†ã€‚ æ‰€ä»¥ï¼Œåœ¨æ•°æ®åŒ…åˆ°è¾¾ socket buffer å‰ï¼Œæ•°æ®å¤„ç†éƒ½æ˜¯ç”± ksoftirqd çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯ç®—åœ¨è½¯ä¸­æ–­å¤„ç†æ—¶é—´é‡Œçš„ã€‚ ksoftirqd è°ƒç”¨é©±åŠ¨ç¨‹åºçš„ poll å‡½æ•°æ¥ä¸€ä¸ªä¸ªå¤„ç† packetã€‚ å¦‚æœæ²¡æœ‰ packet çš„è¯ï¼Œå°±ä¼šé‡æ–°å¯åŠ¨ç½‘å¡ç¡¬ä¸­æ–­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡é‡æ–°çš„æµç¨‹ã€‚ poll å‡½æ•°å°†è¯»å–çš„æ¯ä¸ª packetï¼Œè½¬æ¢ä¸º sk_buff æ•°æ®æ ¼å¼ï¼Œå¹¶åˆ†æå…¶ä¼ è¾“å±‚åè®®ã€‚ ï¼ˆå¯é€‰ï¼‰å¦‚æœå¼€å¯äº† GROï¼Œé‚£ä¹ˆè¿›è¡Œ GRO çš„å¤„ç†ã€‚ å¦‚æœå¼€å¯äº† RPSï¼Œé‚£ä¹ˆè¿›è¡Œ RPS çš„å¤„ç†ï¼Œå¦åˆ™æ”¾å…¥å½“å‰ CPU çš„ input_pkt_queueã€‚ RPS å¤„ç†çš„æµç¨‹å¦‚ä¸‹ï¼š å½“å‰ CPU å°† sk_buff æ”¾åˆ°å…¶ä»– CPU çš„ input_pkt_queue ä¸­ã€‚å¦‚æœ input_pkt_queue æ»¡çš„è¯ï¼Œpacket ä¼šè¢«ä¸¢å¼ƒã€‚ CPU é€šè¿‡ IPI ç¡¬ä¸­æ–­é€šçŸ¥å…¶ä»– CPU å¤„ç†è‡ªå·±çš„ input_pkt_queueï¼Œä¹Ÿå°±æ˜¯èµ° 11 æ­¥æµç¨‹ã€‚ åˆ°è¿™é‡Œï¼Œè€Œæ— è®ºæ˜¯å¦å¼€å¯ RPSï¼Œæ¥ä¸‹æ¥å°±æ˜¯ CPU ä»å„è‡ª input_pkt_queue å–å‡º sk_buff å¹¶å¤„ç†ã€‚ CPU æŸ¥çœ‹ socket æ˜¯å¦æ˜¯ AF_PACKET ç±»å‹çš„ã€‚å¦‚æœæ˜¯çš„è¯å¤åˆ¶ä¸€ä»½æ•°æ®å¤„ç†ï¼ˆä¾‹å¦‚ tcpdump æŠ“è¿™é‡Œçš„åŒ…ï¼‰ã€‚ è°ƒç”¨å¯¹åº”åè®®æ ˆçš„å‡½æ•°ï¼Œå°†æ•°æ®åŒ…è§£æå‡ºç½‘ç»œå±‚åè®®ï¼Œå¹¶äº¤ç»™å¯¹åº”çš„åè®®æ ˆå¤„ç†ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:3:4","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"3.5 å‘é€æ•°æ® æ¥å—åˆ°ç½‘ç»œå±‚çš„æ•°æ®åï¼Œæ¥åˆ°ç½‘ç»œè®¿é—®å±‚ä¼šç»è¿‡ä¸€ä¸ªéå¸¸é‡è¦çš„ç³»ç»Ÿï¼šTraffic Controllerã€‚è¿™æ˜¯æ¥æ”¶æ•°æ®æ—¶ä¸ä¼šç»è¿‡ã€‚ æ ¹æ® sk_buff ä¸­çš„è®¾å¤‡ä¿¡æ¯ï¼Œè·å–å¯¹åº” net_device.qdiscã€‚ å¦‚æœ qdisc å­˜åœ¨çš„è¯ï¼Œèµ°æµé‡æ§åˆ¶ç³»ç»Ÿï¼Œå¯èƒ½ä¼šä¸¢å¼ƒåŒ…ï¼š TODO æ‹·è´ä¸€ä»½ sk_buff ç»™ â€œpacket tapsâ€ã€‚ è°ƒç”¨å…·ä½“é©±åŠ¨çš„å‘é€æ•°æ®çš„å‡½æ•°å‘é€ã€‚ Note æ³¨æ„ï¼Œå‘é€æ•°æ®æ—¶å¹¶æ²¡æœ‰ CPU çš„ â€œoutputqueueâ€ï¼Œå› ä¸ºæµé‡æ§åˆ¶ç³»ç»Ÿå·²ç»è¿›è¡Œäº†æµé‡æ§åˆ¶ã€‚ å…¥å£æµé‡æ§åˆ¶ å¦‚æœæƒ³å¯¹å…¥å£æµé‡è¿›è¡Œæµé‡æ§åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ tc ingressqdisc + è™šæ‹Ÿè®¾å¤‡ IFB è¿›è¡Œ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:3:5","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"4 ç½‘ç»œå±‚ ç½‘ç»œè®¿é—®å±‚åœ¨æ¥å—åˆ°æ•°æ®åï¼Œè°ƒç”¨å„ä¸ªç½‘ç»œå±‚åè®®çš„å¤„ç†å‡½æ•°ï¼Œè¿›è¡Œ sk_buff çš„å¤„ç†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¸‹é¢è¯´çš„æ˜¯ IP åè®®ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:4:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"4.1 sk_buff ç½‘å¡æ¥å—åˆ°çš„æ•°æ®åŒ…ï¼Œæ•´ä¸ªåœ¨å†…æ ¸ä¸­ä¼ é€’ä½¿ç”¨çš„éƒ½æ˜¯ sk_buff æ•°æ®ç»“æ„ã€‚ç½‘ç»œçš„å„ä¸ªå±‚éƒ½æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ª sk_buff å¯¹è±¡ï¼Œè€Œæ— éœ€è¿›è¡Œæ•°æ®çš„å¤åˆ¶ï¼Œä½¿å¾—æ€§èƒ½æ›´é«˜ã€‚ sk_buff åŒ…å«å„ä¸ªæŒ‡é’ˆæ‰§è¡Œå¯¹åº”æ•°æ®çš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä¸”è¡¨ç¤ºå…¶åè®®çš„ head data ç­‰åŒºåŸŸã€‚ // \u003csk_buff.h\u003e struct sk_buff { // ... union { __be16 inner_protocol; __u8Â inner_ipproto; }; __u16Â inner_transport_header; __u16Â inner_network_header; __u16Â inner_mac_header; __be16 protocol; __u16 transport_header; __u16 network_header; __u16 mac_header; /* These elements must be at the end, see alloc_skb() for details. */ sk_buff_data_t tail; sk_buff_data_t end; unsigned char *head, *data; }; headï¼Œend ä¸ºæ•´ä¸ªæ•°æ®åŒ…çš„å¤´å°¾å†…å­˜åœ°å€ï¼› dataï¼Œtail ä¸ºå½“å‰å±‚å¯¹åº”çš„æ•°æ®çš„å¤´å°¾å†…å­˜åœ°å€ï¼› transport_headerï¼Œnetwork_headerï¼Œmac_header ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€é“¾è·¯å±‚ header çš„å†…å­˜åœ°å€ï¼› çœ‹å›¾å¯èƒ½æ›´å¥½ç†è§£ï¼Œsk_buff é€šè¿‡æŒ‡é’ˆå°†æ•°æ®åŒ…å„ä¸ªåŒºåŸŸè¡¨ç¤ºå‡ºæ¥äº†ï¼Œè€Œåœ¨å„ä¸ªåè®®å±‚ä¹‹é—´ç§»åŠ¨åˆ™æ˜¯ç§»åŠ¨ data ä¸ tail æŒ‡é’ˆã€‚ sk_buff_head è¡¨ç¤º sk_buff ç»„æˆçš„é“¾è¡¨ï¼Œè¿™ä¸ªç»“æ„å°±æ˜¯ RPS å„ä¸ª CPU çš„é˜Ÿåˆ—ï¼Œä»¥åŠ socket buffer çš„å®ç°ã€‚ // \u003csk_buff.h\u003e struct sk_buff_head { /* These two members must be first. */ struct sk_buff *next; struct sk_buff *prev; __u32 qlen; // é“¾è¡¨é•¿åº¦ spinlock_t lock; }; ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:4:1","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"4.2 netfilter netfilter æ˜¯ä¸€ä¸ªåœ¨å†…æ ¸æ¡†æ¶ï¼Œä½äºç½‘ç»œå±‚ï¼Œå¯ä»¥æ ¹æ®åŠ¨æ€çš„æ¡ä»¶è¿‡æ»¤æˆ–æ“ä½œåˆ†ç»„ã€‚ ä¸»è¦åŒ…å«å¦‚ä¸‹åŠŸèƒ½ï¼š filterï¼šæ ¹æ®åˆ†ç»„å…ƒä¿¡æ¯ï¼Œå¯¹ä¸åŒæ•°æ®æµè¿›è¡Œåˆ†ç»„è¿‡æ»¤ï¼› NATï¼šæ ¹æ®è§„åˆ™æ¥è½¬æ¢ source ip æˆ–è€… destination ipï¼› mangle: æ ¹æ®ç‰¹å®šåˆ†ç»„æ‹†åˆ†ä¸ä¿®æ”¹ï¼› iptables iptables æ˜¯ç”¨äºæä¾›ç»™ç”¨æˆ·é…ç½®é˜²ç«å¢™ã€åˆ†ç»„è¿‡æ»¤ç­‰åŠŸèƒ½ï¼Œä½¿ç”¨çš„å°±æ˜¯ netfilter æ¡†æ¶ã€‚ é’ˆå¯¹ä¸åŒçš„é˜¶æ®µï¼Œå†…æ ¸ä»£ç ä¸­ä¼šå­˜åœ¨ä¸åŒçš„ hook ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:4:2","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"4.3 æ¥æ”¶æ•°æ® æ¥å—æ•°æ®åˆ°è¿™é‡Œï¼Œæ•°æ®åŒ…çš„ç½‘ç»œå±‚åè®®å·²ç»è§£æè¿‡äº†ï¼Œçœ‹ä¸€ä¸‹ç½‘ç»œå±‚å¤„ç†æ•°æ®æŠ¥çš„æ­¥éª¤ï¼š å¦‚æœå…¶æ•°æ®åŒ…çš„ MAC åœ°å€ä¸æ˜¯å½“å‰ç½‘å¡ï¼Œé‚£ä¹ˆä¸¢å¼ƒï¼ˆå¯èƒ½ç”±äºç½‘å¡æ··æ‚æ¨¡å¼è¿›æ¥çš„ï¼Œè¿˜æ˜¯æ— æ³•ç»è¿‡åè®®æ ˆå¤„ç†ï¼‰ã€‚ ç»è¿‡ netfilter.PREROUTING é˜¶æ®µå›è°ƒã€‚ è¿›è¡Œè·¯ç”±åˆ¤æ–­ï¼šå¦‚æœç›®çš„ IP æ˜¯æœ¬æœº IPï¼Œé‚£ä¹ˆæ¥å—è¯¥åŒ…ã€‚å¦‚æœä¸æ˜¯æœ¬æœº IPï¼Œåˆ¤æ–­æ˜¯å¦è¦è·¯ç”±ã€‚ ç»è¿‡ netfilter.LOCALIN é˜¶æ®µå›è°ƒã€‚ è¿›å…¥ä¼ è¾“å±‚ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä»…ä»…æ˜¯ç®€å•çš„æ¥æ”¶æ•°æ®åŒ…å¾ˆç®€å•ï¼Œåªè¦ç»è¿‡ netfilter çš„å›è°ƒå³å¯ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:4:3","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"4.4 è·¯ç”±æ•°æ® å½“æ¥å—æ•°æ®æ—¶å‘ç°æ•°æ®åŒ…ä¸æ˜¯å‘å¾€æœ¬æœºæ—¶ï¼Œå°±ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œè·¯ç”±ã€‚ è·¯ç”±çš„å‰ææ˜¯ï¼šæœºå™¨å¼€å¯äº† ip forward åŠŸèƒ½ï¼Œå¦åˆ™ä¼šç›´æ¥ä¸¢åŒ…ã€‚ # å¼€å¯ ip forward sysctl -w net.ipv4.ip_forward=1 çœ‹ä¸€ä¸‹è·¯ç”±å¯¹æ•°æ®åŒ…çš„å¤„ç†ï¼š æ£€æŸ¥æ˜¯å¦å¼€å¯ ip forward åŠŸèƒ½ï¼Œæ²¡æœ‰å¼€å¯çš„è¯æ•°æ®åŒ…ä¼šæ‰§è¡Œä¸¢å¼ƒã€‚ ç»è¿‡ netfilter.FORWARD é˜¶æ®µå›è°ƒã€‚ èµ°æ­£å¸¸çš„å‘åŒ…æµç¨‹å‘é€æ•°æ®åŒ…ï¼ˆä¼šç»è¿‡ netfilter.POSTROUTING é˜¶æ®µå›è°ƒï¼‰ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:4:4","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"4.5 å‘é€æ•°æ® åœ¨ sk_buff æŒ‡å‘çš„æ•°æ®åŒºè®¾ç½®å¥½ IP æŠ¥æ–‡å¤´ã€‚ è°ƒç”¨ netfilter.LOCALOUT é˜¶æ®µå›è°ƒã€‚ è°ƒç”¨ç›¸å…³åè®®çš„å‘é€å‡½æ•°ï¼ˆIP åè®®æˆ–å…¶ä»–ï¼‰ï¼Œå°†å‡ºå£ç½‘å¡è®¾å¤‡ä¿¡æ¯å†™å…¥ sk_buffã€‚ è°ƒç”¨ netfilter.POSTOUTPUT é˜¶æ®µå›è°ƒã€‚ POSTOUTPUT å¯èƒ½è®¾ç½®äº† SNATï¼Œä»è€Œå¯¼è‡´è·¯ç”±ä¿¡æ¯å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–é‡æ–°é‡æ–°å›åˆ° 3ã€‚ æ ¹æ®ç›®çš„ IPï¼Œä»è·¯ç”±è¡¨ä¸­è·å–ä¸‹ä¸€è·³çš„åœ°å€ï¼Œç„¶ååœ¨ ARP ç¼“å­˜è¡¨ä¸­æ‰¾åˆ°ä¸‹ä¸€è·³çš„ neigh ä¿¡æ¯ã€‚ å¦‚æœæ²¡æœ‰ neigh ä¿¡æ¯ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œä¸€ä¸ª ARP è¯·æ±‚ï¼Œå°è¯•å¾—åˆ°ä¸‹ä¸€è·³çš„ mac åœ°å€ã€‚ åˆ°è¿™é‡Œï¼Œå¾—åˆ°äº†ä¸‹ä¸€è·³è®¾å¤‡çš„ mac åœ°å€ï¼Œå°†å…¶å¡«å…¥ sk_buff å¹¶è°ƒç”¨ä¸‹ä¸€å±‚çš„æ¥å£ã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:4:5","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"5 ä¼ è¾“å±‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:5:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"5.1 sock sock æ˜¯ socket åœ¨å†…æ ¸çš„è¡¨ç¤ºç»“æ„ï¼Œæ¯ä¸ª sock å¯¹åº”äºä¸€ä¸ªç”¨æˆ·æ€ä½¿ç”¨çš„ socketã€‚TCP UDP éƒ½æ˜¯åŸºäºè¯¥ç»“æ„æ¥å®ç°çš„ã€‚ å…¶ä¸­ï¼Œsock æœ€ä¸»è¦çš„å±æ€§å°±æ˜¯å¸¸è¯´çš„ socket buffer äº†ã€‚ // \u003csock.h\u003e struct sock { // â€¦ #define sk_state __sk_common.skc_state // â€¦ struct sk_buff_head sk_error_queue; struct sk_buff_head sk_receive_queue; struct sk_buff_head sk_write_queue; int sk_rcvbuf; int sk_sndbuf; u32 sk_ack_backlog; u32 sk_max_ack_backlog; // å„ä¸ªå›è°ƒå‡½æ•° void (*sk_state_change)(struct sock *sk); void (*sk_data_ready)(struct sock *sk); void (*sk_write_space)(struct sock *sk); void (*sk_error_report)(struct sock *sk); int (*sk_backlog_rcv)(struct sock *sk, struct sk_buff *skb); // â€¦ } sk_state ï¼šTCP çš„çŠ¶æ€ï¼› sk_receive_queue sk_write_queue ï¼šæ¥å—/å‘é€é˜Ÿåˆ—ï¼ˆbufferï¼‰ï¼› rcvbufï¼Œsndbuf ï¼šæ¥å—/å‘é€é˜Ÿåˆ—çš„å¤§å°ï¼Œå•ä½ Bï¼› sk_ack_backlog ï¼šç»è¿‡ä¸‰æ¬¡æ¡æ‰‹åï¼Œç­‰å¾… accept() çš„å…¨è¿æ¥é˜Ÿåˆ—ï¼› 5.1.1 é…ç½® socket buffer å¤§å° é€šè¿‡ sysctl å¯ä»¥é…ç½® TCPã€UDP çš„æ¥å—ä¸å‘é€ç¼“å†²åŒºå¤§å°ï¼š sysctl -w net.ipv4.tcp_rmem=\"4096 503827 6291456\" sysctl -w net.ipv4.tcp_wmem=\"4096 503827 6291456\" sysctl -w net.ipv4.udp_mem=\"377868 503827 755736\" æ¯ä¸ªè®¾ç½®åŒ…å«ä¸‰ä¸ªå€¼ï¼Œminã€defaultã€maxã€‚å†…æ ¸ä¼šæ ¹æ®å½“å‰çš„å¯ç”¨å†…å­˜åŠ¨æ€è°ƒèŠ‚é˜Ÿåˆ—çš„å¤§å°ï¼› Tip ä½¿ç”¨ SO_SNDBUF/SO_RCVBUF å¯ä»¥é’ˆå¯¹ socket å•ç‹¬è®¾ç½® r/w bufferã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:5:1","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"5.2 UDP å±‚ 5.2.1 æ¥æ”¶æ•°æ® å…ˆä»ç®€å•çš„ UDP å¤„ç†å¼€å§‹çœ‹ï¼š å¯¹æ•°æ®åŒ…è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ã€‚ æ ¹æ®ç›®çš„ IP ä¸ç›®çš„ portï¼Œåœ¨ udptableï¼ˆåŒ…å«æœºå™¨æ‰€æœ‰çš„ udp sockï¼‰æŸ¥æ‰¾å¯¹åº”çš„ sockã€‚æ²¡æœ‰æ‰¾åˆ°åˆ™ä¼šä¸¢å¼ƒæ•°æ®åŒ…ï¼Œå¦åˆ™ç»§ç»­ã€‚ æ£€æŸ¥ receive buffer æ˜¯å¦æ»¡ï¼Œå¦‚æœæ»¡äº†åˆ™ä¼šç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ã€‚ æ£€æŸ¥æ•°æ®åŒ…æ˜¯å¦æ»¡è¶³ BPF socket filterï¼Œå¦‚æœä¸æ»¡è¶³åˆ™ç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ã€‚ å°†æ•°æ®åŒ…æ”¾å…¥ receive bufferã€‚ è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œä»¥é€šçŸ¥æ•°æ®åŒ…å·²ç»å‡†å¤‡å¥½ã€‚è¿™ä¼šå°†é˜»å¡ç­‰å¾…æ•°æ®åŒ…åˆ°æ¥çš„ç”¨æˆ·æ€ç¨‹åºå”¤é†’ã€‚ UDP çš„å¤„ç†å¾ˆç®€å•ï¼Œæ‰¾åˆ°å¯¹åº”çš„ sock ç»“æ„ï¼Œç„¶åå°†å…¶æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå”¤é†’ç”¨æˆ·æ€ç¨‹åºã€‚ 5.2.2 å‘é€æ•°æ® å‘é€æ“ä½œä¸æ¥æ”¶ä¸æ˜¯å¯¹ç§°çš„ï¼Œå› ä¸ºåœ¨å‘é€æ—¶å°±è¦ç¡®å®šå‡ºå£çš„è®¾å¤‡ï¼Œæ¥ç¡®è®¤åŒ…æ˜¯å¦ä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚ æ ¹æ®æœºå™¨çš„è·¯ç”±è¡¨å’Œç›®çš„ IPï¼Œå†³å®šæ•°æ®åŒ…åº”è¯¥ä»å“ªä¸ªè®¾å¤‡å‘é€å‡ºå»ã€‚å¦‚æœæ ¹æ®è·¯ç”±è¡¨æ— æ³•åˆ°è¾¾ç›®çš„åœ°å€ï¼Œç›´æ¥ä¸¢å¼ƒåŒ…ã€‚ å¦‚æœ socket æ²¡æœ‰ç»‘å®šæº IPï¼Œé‚£ä¹ˆå°±ä½¿ç”¨è®¾å¤‡çš„æº IPã€‚ æ ¹æ®è·å–åˆ°è·¯ç”±ä¿¡æ¯ï¼Œå°† msg æ„å»ºä¸º sk_buff ç»“æ„ä½“ã€‚ å‘ sk_buff çš„æ•°æ®åŒºå¡«å…… UDP åŒ…å¤´ï¼Œç„¶åè°ƒç”¨ IP å±‚ç›¸å…³å‡½æ•°ã€‚ Note UDP ä¸å­˜åœ¨ send bufferï¼Œæ•°æ®ç›´æ¥ä¼šå‘é€å‡ºå»ï¼Œå› ä¸º UDP æ²¡æœ‰æ‹¥å¡æ§åˆ¶ã€‚ è®¾ç½® socket SO_SNDBUF é€‰é¡¹æ—¶ï¼Œå¯¹äº UDP è¿™æ˜¯æ¯æ¬¡å‘é€æ•°æ®çš„æœ€å¤§å€¼ï¼Œè¶…è¿‡çš„è¯å‘é€ä¼šç›´æ¥è¿”å› ENOBUFSã€‚ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:5:2","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"æ€»ç»“ æ•´ä¸ªå†…æ ¸ç½‘ç»œæ”¶å‘æ˜¯ä¸ªå¾ˆå¤æ‚çš„æ¨¡å—ï¼Œå¯èƒ½å¥½å¤šåœ°æ–¹çš„ç»†èŠ‚éƒ½æ²¡æœ‰æ¶‰åŠï¼Œä¹Ÿæœ‰å¯èƒ½æœ‰ç†è§£é”™è¯¯çš„åœ°æ–¹ã€‚ æ‰€å¹¸å†…æ ¸å®ç°å±‚æ¬¡åˆ†æ˜çš„æ¯”è¾ƒæ¸…æ¥šï¼Œå› æ­¤å¯ä»¥ä¸€å±‚å±‚è§‚å¯Ÿå…¶å¯¹åº”è´Ÿè´£çš„è¡Œä¸ºã€‚ åœ¨ä¸€ä¸ªæ™®é€šç¨‹åºå‘˜çš„è§’åº¦ä¸‹ï¼Œé¦–å…ˆéœ€è¦ç†è§£ç½‘ç»œåŒ…æ”¶å‘æ¶‰åŠåˆ°çš„å„ä¸ªå±‚çš„ä½œç”¨ï¼šç½‘å¡å±‚ã€ç½‘ç»œè®¿é—®å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚ã€‚ å¯¹äºå„ä¸ªå±‚ï¼Œéœ€è¦çŸ¥é“ä¸€äº›åŒ…å¤„ç†çš„å…³é”®ç‚¹çš„æ‰€å¤„äºçš„ä½ç½®ï¼ŒåŒ…æ‹¬ï¼šç½‘å¡å¤šé˜Ÿåˆ—ã€æµé‡æ§åˆ¶ã€netfilterã€r/w buffer ç­‰ï¼› ç›®å‰æ•´ç†çš„ä¸»è¦çš„ç‚¹å¦‚ä¸‹ï¼š ç½‘å¡å±‚ ç½‘å¡å¤šé˜Ÿåˆ—çš„æ¦‚å¿µä¸ä½ç½®ï¼› CPU å¦‚ä½•æ¥å—ç½‘å¡æ•°æ®ï¼› CPU å¦‚ä½•å‘é€ç½‘å¡æ•°æ®ï¼› ç½‘ç»œè®¿é—®å±‚ ç½‘ç»œè®¿é—®å±‚æ¥å—æ•°æ®ï¼› ç½‘ç»œè®¿é—®å±‚å‘é€æ•°æ®ï¼› ksoftiqrd çº¿ç¨‹çš„ä»»åŠ¡ï¼› RPSã€XPSã€RFS çš„æ¦‚å¿µï¼› TC æµé‡æ§åˆ¶å¤„ç†çš„ä½ç½®ï¼› XDP å¤„ç†çš„ä½ç½®ï¼› ç½‘ç»œå±‚ sk_buff ç»“æ„çš„æ¦‚å¿µï¼› ç½‘ç»œå±‚æ¥å—æ•°æ®ï¼› ç½‘ç»œå±‚å‘é€æ•°æ®ï¼› netfilter å„ä¸ªé˜¶æ®µå›è°ƒçš„ä½ç½®ï¼› å¦‚ä½•è¿›è¡Œè·¯ç”±åˆ¤æ–­ï¼› ä¼ è¾“å±‚ sock ç»“æ„çš„æ¦‚å¿µï¼› UDP çš„ recv socket bufferï¼› TCP çš„åŠè¿æ¥é˜Ÿåˆ—ï¼Œå…¨è¿æ¥é˜Ÿåˆ—ï¼Œr/w socket bufferï¼› ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:6:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["linux"],"content":"å‚è€ƒ Blog: Linux ç½‘ç»œ - æ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ Blog: Linux ç½‘ç»œ - æ•°æ®åŒ…çš„å‘é€è¿‡ç¨‹ ã€Šæ·±å…¥ Linux å†…æ ¸æ¶æ„ã€‹ ","date":"2021-02-04","objectID":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/:7:0","tags":["linux","ç½‘ç»œ"],"title":"Linux ç½‘ç»œæ”¶å‘åŒ…è¿‡ç¨‹æ€»ç»“","uri":"/posts/linux/net/linux-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"Go åç¨‹å®ç°ï¼ŒGMP æ¨¡å‹å®ç°ï¼Œè°ƒåº¦ç®—æ³•å®ç°","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹ Golang å¹¶å‘è°ƒåº¦å®ç°çš„ä¸€ä¸ªæ€»ç»“ï¼ŒåŸºæœ¬å†…å®¹æ¥æºäºç½‘ç»œçš„å­¦ä¹ ï¼Œä»¥åŠè‡ªå·±è§‚æ‘©äº†ä¸‹æºç ã€‚ æ‰€ä»¥å­¦ä¹ çš„ä¹¦ç±ä¸æ–‡ç« è§ å‚è€ƒã€‚ ä¸‹é¢ä»£ç éƒ½æ˜¯åŸºäº go 1.15.6ã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:0:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1 èƒŒæ™¯çŸ¥è¯† ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:1:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.1 è¿›ç¨‹ã€çº¿ç¨‹ä¸åç¨‹ çœ‹åç¨‹çš„å®ç°ä¹‹å‰ï¼Œç»•ä¸å¼€çš„éœ€è¦çŸ¥é“è¿›ç¨‹ä¸çº¿ç¨‹ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„æ¯”è¾ƒã€‚ è¿›ç¨‹progress å°±æ˜¯ç¨‹åºæ‰§è¡Œçš„å®ä¾‹ã€‚åœ¨å†…æ ¸è§’åº¦ä¸Šçœ‹ï¼Œè¿›ç¨‹æ˜¯åˆ†é…ç³»ç»Ÿèµ„æºçš„å®ä½“ã€‚ è€Œè¿™ä¹Ÿå¯ä»¥æ¨å‡ºï¼Œæ‰€è°“çš„è¿›ç¨‹åˆ‡æ¢çš„æ¶ˆè€—ï¼Œä¹Ÿå°±æ˜¯åˆ‡æ¢åˆ†é…çš„ç³»ç»Ÿèµ„æºï¼ŒåŒ…æ‹¬è™šæ‹Ÿå†…å­˜ï¼ˆé¡µè¡¨ç­‰ï¼‰ã€å¯„å­˜å™¨çš„å€¼ç­‰ã€‚ Tip æ®è¯´æ¯æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢éœ€è¦å‡ åçº³ç§’åˆ°å¾®ç§’çš„ CPU æ—¶é—´ã€‚ çº¿ç¨‹thread æ˜¯å†…æ ¸è°ƒåº¦çš„åŸºæœ¬å•å…ƒï¼Œåœ¨ Linux ä¸Šï¼Œçº¿ç¨‹å°±æ˜¯ â€œè½»é‡çº§è¿›ç¨‹â€ï¼Œå› ä¸ºå®ƒä¸è¿›ç¨‹åœ¨å†…æ ¸çš„çœ‹æ¥éƒ½ä¸€æ ·ï¼Œä»…ä»…æ˜¯å…±äº«äº†ä¸€äº›èµ„æºï¼ŒåŒ…æ‹¬ï¼š å†…å­˜åœ°å€ç©ºé—´ï¼› è¿›ç¨‹çš„åŸºç¡€ä¿¡æ¯ï¼› æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼› ä¿¡å·å¤„ç†ï¼› ç­‰ç­‰ æ‰€ä»¥ç›¸å¯¹äºè¿›ç¨‹é—´åˆ‡æ¢ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹ä¸‹çš„çº¿ç¨‹åˆ‡æ¢ï¼Œå¯ä»¥çœç•¥è¿™äº›å…±äº«çš„èµ„æºçš„åˆ‡æ¢ã€‚å› æ­¤ï¼Œçº¿ç¨‹é—´åˆ‡æ¢é€Ÿåº¦å¿«äºè¿›ç¨‹é—´åˆ‡æ¢ã€‚ Note æ‰€è°“è¿›ç¨‹åˆ‡æ¢å°±æ˜¯ä¸åŒè¿›ç¨‹é—´çš„çº¿ç¨‹åˆ‡æ¢ï¼Œæ‰€ä»¥ä¸‹é¢æ‰€è¯´çš„çº¿ç¨‹é—´çš„åˆ‡æ¢ã€çº¿ç¨‹ä¸Šä¸‹æ–‡éƒ½æ˜¯æŒ‡åŒè¿›ç¨‹ä¸‹çš„çº¿ç¨‹ã€‚ ä¸Šé¢æ‰€è¯´çš„è°ƒåº¦ã€åˆ‡æ¢éƒ½æ˜¯ç«™åœ¨å†…æ ¸çš„è§’åº¦çœ‹çº¿ç¨‹ã€‚è€Œç«™åœ¨çº¿ç¨‹çš„è§’åº¦ï¼Œå®ƒå¯ä»¥è®¤ä¸ºè‡ªå·±æ˜¯ â€œå®Œå…¨â€ å ç”¨ CPU çš„ã€‚å¦‚æœçº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œå°±ç­‰äº CPU åœ¨ ç©ºé—² æµªè´¹ã€‚ æ‰€ä»¥ï¼Œå†™ä»£ç å¾€å¾€ä¼šä½¿ç”¨å¼‚æ­¥ APIï¼Œé€šè¿‡å›è°ƒ/é€šçŸ¥æ¥ä½¿å¾—çº¿ç¨‹é˜»å¡çš„æ›´åŠ å°‘ï¼ˆå…¸å‹çš„ epollï¼‰ï¼Œè¿™æ—¶å€™ CPU åŸæ¥é˜»å¡çš„æ—¶é—´å¯ä»¥æ‰§è¡Œå…¶ä»–çš„ä»£ç ã€‚ ä½†æ˜¯ï¼Œå›è°ƒçš„ä»£ç ä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°é‡Œçº¿æ€§æ‰§è¡Œçš„ï¼Œä¼šæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå…·ä½“ä¾‹å­ï¼ŒA å‡½æ•°æœ€åˆçš„æ‰§è¡Œæµä¸ºï¼š æ‰§è¡Œ -\u003e è¯»å–æ•°æ® -\u003e æ‰§è¡Œ å¦‚æœä½¿ç”¨å¼‚æ­¥ APIï¼Œå…¶æ‰§è¡Œæµç¨‹å˜ä¸ºï¼š A å‡½æ•°ï¼šæ‰§è¡Œ -\u003e å¼‚æ­¥ -\u003e è¿”å› å›è°ƒå‡½æ•°ï¼šè¯»å–æ•°æ® -\u003e æ‰§è¡Œã€‚ é¦–å…ˆï¼Œå•ä¸ªå‡½æ•°çš„æ‰§è¡Œæµå˜ä¸ºäº†ä¸¤ä¸ªä¸åŒå‡½æ•°ï¼Œä»£ç å†™æ³•ä¸Šä¸²è¡Œçš„æ€ç»´è¦å˜ä¸ºåˆ†å‰²çš„æ€ç»´ã€‚å¹¶ä¸”ï¼Œå¦‚æœè¿™ä¸ªæ“ä½œè¿˜æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé‚£ä¹ˆè¿˜æ¶‰åŠåˆ°äº† â€œA å‡½æ•°å°†çŠ¶æ€ä¼ é€’åˆ°å›è°ƒå‡½æ•°â€ ç­‰é—®é¢˜ã€‚ å› æ­¤ï¼Œåç¨‹routine å‡ºç°ï¼Œä¸Šé¢çš„ä¾‹å­çš„æ‰§è¡Œæµè¿˜æ˜¯ï¼š æ‰§è¡Œ -\u003e è¯»å–æ•°æ® -\u003e æ‰§è¡Œ ä½†æ˜¯ï¼Œåœ¨è¯»å–æ•°æ®è¿™ä¸€æ­¥ï¼Œåç¨‹ä¼šä¸»åŠ¨è®©å‡º CPUï¼Œç­‰å¾…æ•°æ®åˆ°æ¥æ—¶å†æ¬¡åˆ‡æ¢åˆ°è¯¥åç¨‹ï¼Œç»§ç»­æ‰§è¡Œã€‚å› æ­¤ï¼Œå†™æ³•ä¸å˜ï¼ŒåŠŸèƒ½ç›¸åŒã€‚ å¹¶ä¸”ï¼Œåœ¨ä¸€äº›ç”¨æˆ·ç©ºé—´çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å®ç°ä¸Šï¼ˆchannelï¼‰ï¼Œåç¨‹çš„é˜»å¡ä¸éœ€è¦çº¿ç¨‹é˜»å¡ï¼Œè€Œåœ¨ç”¨æˆ·ç©ºé—´å°±å®Œæˆäº†åç¨‹çš„åˆ‡æ¢ã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:1:1","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.2 è°ƒåº¦å™¨ è°ƒåº¦å™¨scheduler æ˜¯ä¸ºäº†åœ¨å†³å®šåœ¨æœ‰é™çš„ CPU ä¸Šï¼Œé€‰æ‹©å“ªäº›ä»»åŠ¡ï¼ˆè¿›ç¨‹/çº¿ç¨‹/åç¨‹ï¼‰æ‰§è¡Œä½¿å¾—ç³»ç»Ÿè¿è¡Œæ›´é«˜æ•ˆï¼Œæ‰€ä»¥ä¸»è¦æœ‰ä¸¤ä¸ªå·¥ä½œï¼š å†³å®šä¸ºå„ä¸ªä»»åŠ¡å†³å®šå…¶è¿è¡Œå¤šé•¿æ—¶é—´ï¼Œä»¥åŠä½•æ—¶åˆ‡æ¢åˆ°ä¸‹ä¸ªä»»åŠ¡æ‰§è¡Œï¼› åœ¨åˆ‡æ¢ä»»åŠ¡ A è‡³ä»»åŠ¡ B æ—¶ï¼Œå¿…é¡»ä¿å­˜ä»»åŠ¡ A çš„è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”ä»»åŠ¡ B çš„è¿è¡Œç¯å¢ƒä¸ä¸Šæ¬¡å…¶è¢«åˆ‡æ¢æ—¶å®Œå…¨ç›¸åŒï¼› ç¬¬ 1 ä¸ªå·¥ä½œæ¶‰åŠåˆ°çš„å°±æ˜¯ è°ƒåº¦ç®—æ³•ï¼Œå¦‚ä½•è°ƒåº¦ä½¿å¾—ç³»ç»Ÿè¿è¡Œçš„æœ€é«˜æ•ˆã€‚ ç¬¬ 2 ä¸ªå·¥ä½œæ¶‰åŠåˆ°çš„å°±æ˜¯ ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™é‡Œå†è¯´ä¸€ä¸‹è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹çš„ä¸Šä¸‹æ–‡ï¼š è¿›ç¨‹ï¼šè™šæ‹Ÿå†…å­˜ã€å¯„å­˜å™¨çš„å€¼ã€å†…æ ¸å¯¹åº”è¿›ç¨‹ä¿¡æ¯ç­‰ï¼›ï¼ˆå†…æ ¸å®Œæˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ çº¿ç¨‹ï¼šå¯„å­˜å™¨çš„å€¼ã€å†…æ ¸å¯¹åº”çš„è¿›ç¨‹ä¿¡æ¯ç­‰ï¼›ï¼ˆå†…æ ¸å®Œæˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ åç¨‹ï¼šå¯„å­˜å™¨çš„å€¼ã€ç”¨æˆ·ç©ºé—´å¯¹åº”çš„åç¨‹ä¿¡æ¯ç­‰ï¼›ï¼ˆç”¨æˆ·ç©ºé—² runtime å®Œæˆåç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ Note ä¸Šé¢çš„åˆ‡æ¢æ²¡æœ‰è¯´æ ˆï¼Œå› ä¸ºæ ˆçš„åˆ‡æ¢å°±æ˜¯å¯„å­˜å™¨çš„åˆ‡æ¢ã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:1:2","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.3 PC ä¸ SP è¿™ä¸€å—åœ¨ å†…å­˜ç®¡ç†æ€»ç»“ è¯´è¿‡ï¼Œå› ä¸ºå¯¹åç¨‹åˆ‡æ¢å¾ˆé‡è¦ï¼Œè¿™ä¸ªå†æ¬¡å¤åˆ¶ä¸€ä¸‹ã€‚ 1.3.1 PC ç¨‹åºè®¡æ•°å™¨ PCProgram Counter æ˜¯ CPU ä¸­çš„ä¸€ä¸ªå¯„å­˜å™¨ï¼Œä¿å­˜ç€ä¸‹ä¸€ä¸ª CPU æ‰§è¡Œçš„æŒ‡ä»¤çš„ä½ç½®ã€‚é¡ºåºæ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼ŒPC = PC + 1ï¼ˆä¸€ä¸ªæŒ‡ä»¤ï¼‰ã€‚è€Œè°ƒç”¨å‡½æ•°æˆ–è€…æ¡ä»¶è·³è½¬æ—¶ï¼Œä¼šå°†è·³åˆ°çš„æŒ‡ä»¤åœ°å€è®¾ç½®åˆ° PC ä¸­ã€‚ æ‰€ä»¥ï¼Œå¯ä»¥æƒ³åˆ°ï¼Œå½“éœ€è¦åˆ‡æ¢æ‰§è¡Œçš„ goroutineï¼Œè°ƒç”¨ JMP æŒ‡ä»¤è·³è½¬åˆ° G å¯¹åº”çš„ä»£ç ã€‚ 1.3.2 SP æ ˆé¡¶æŒ‡é’ˆ SPstack pointer æ˜¯ä¿å­˜æ ˆé¡¶åœ°å€çš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ä¸´æ—¶å˜é‡åœ¨æ ˆä¸Šï¼Œå°±æ˜¯å°†ä¸´æ—¶å˜é‡çš„å€¼å†™å…¥ SP ä¿å­˜çš„å†…å­˜åœ°å€ï¼Œç„¶å SP ä¿å­˜çš„åœ°å€å‡å°ï¼ˆæ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€å˜åŒ–ï¼‰ï¼Œç„¶åä¸´æ—¶å˜é‡é”€æ¯æ—¶ï¼ŒSP åœ°å€åˆå˜ä¸ºé«˜åœ°å€ã€‚ ä¸è¿‡ï¼Œå› ä¸º goroutine åˆ‡æ¢æ—¶ï¼Œå¿…é¡»è¦ä¿å­˜å½“å‰ goroutine çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯æ ˆé‡Œçš„å˜é‡ã€‚å› æ­¤ï¼Œgoroutine æ ˆè‚¯å®šæ˜¯ä¸èƒ½ä½¿ç”¨ Linux è¿›ç¨‹æ ˆäº†ï¼ˆå› ä¸ºè¿›ç¨‹æ ˆæœ‰ä¸Šé™ï¼Œä¹Ÿæ— æ³•å®ç°â€œä¿å­˜â€è¿™ç§åŠŸèƒ½ï¼‰ã€‚æ‰€ä»¥æ‰€è¯´çš„åç¨‹æ ˆï¼Œéƒ½æ˜¯åŸºäº mmap ç”³è¯·å†…å­˜ç©ºé—´ï¼ˆåŸºäº Go å†…å­˜ç®¡ç†ï¼Œå†…å­˜ç®¡ç†åŸºäº mmapï¼‰ï¼Œç„¶ååˆ‡æ¢æ—¶ä¿®æ”¹ SP å¯„å­˜å™¨åœ°å€å®ç°çš„ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ goroutine æ ˆå¯ä»¥â€œæ— é™å¤§â€çš„åŸå› äº†ã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:1:3","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2 GMP æ¨¡å‹ å…ˆä»æ•´ä½“æ¨¡å‹å…¥æ‰‹ï¼Œæ•´ä¸ªåç¨‹å®ç°æœ‰ç€ä¸‰ä¸ªæœ€ä¸»è¦çš„å¯¹è±¡ï¼š G ï¼šè¡¨ç¤º Goroutineï¼Œä¿å­˜å¹¶å‘ä»»åŠ¡çš„çŠ¶æ€ï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼› M ï¼šè¡¨ç¤ºç³»ç»Ÿçº¿ç¨‹ï¼Œå¿…é¡»åœ¨ç»‘å®š P åï¼Œæ‰§è¡Œ G ä»»åŠ¡ï¼› P ï¼šå¤„ç†å™¨ï¼Œä½œç”¨ç±»ä¼¼äº CPU æ ¸ï¼Œæ§åˆ¶å¹¶å‘æ‰§è¡Œä»»åŠ¡æ•°é‡ï¼› schedt ï¼šå…¨å±€çš„é“¾è¡¨ï¼ŒåŒ…æ‹¬å…¨å±€çš„ G å¯è¿è¡Œé“¾è¡¨ã€ç©ºé—² M é“¾è¡¨ã€ç©ºé—² P é“¾è¡¨ï¼› è€Œå¤§è‡´çš„è¿è¡Œçš„æ¨¡å‹å¦‚ä¸‹ï¼š æ¯ä¸ª P ç»‘å®šä¸€ä¸ª Mï¼Œä¸ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Gï¼› æ¯ä¸ª P åŒ…å«è‡ªå·±æœ¬åœ°çš„å¯è¿è¡Œçš„ G çš„é“¾è¡¨ï¼› å…¨å±€çš„ G çš„å¯è¿è¡Œé“¾è¡¨ï¼Œç”¨ä»¥æä¾›ç»™æ—  G å¯ä»¥æ‰§è¡Œçš„ Pï¼› ä¸€äº› M ä¸ G çš„ç»‘å®šï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨é˜»å¡è€Œè§£ç»‘äº† Pï¼ŒM é˜»å¡ç»“æŸåè¿˜æ˜¯ä¼šè¿›å…¥è°ƒåº¦å¾ªç¯ï¼› ä¸€äº› G ä¸»åŠ¨è¿›å…¥ waiting çŠ¶æ€ï¼Œç­‰å¾…å”¤é†’åé‡æ–°åŠ å…¥æŸä¸ªå¯è¿è¡Œé˜Ÿåˆ—ï¼ˆå…¸å‹çš„ï¼Œè¯»å– channel é˜»å¡ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„é˜»å¡ï¼Œç”±å‘é€ channel æ—¶å°†å…¶å”¤é†’ï¼‰ï¼› ç©ºé—² M é“¾è¡¨ï¼Œç©ºé—² P é“¾è¡¨ï¼Œç©ºé—² G é“¾è¡¨ç­‰ï¼› ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:2:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.1 G g ç»“æ„ï¼ˆruntime/runtime2.goï¼‰ä»£è¡¨ä¸€ä¸ª Gï¼ŒåŒ…å«äº†æŸä¸ªä»»åŠ¡çš„ä¸Šä¸‹æ–‡ï¼ŒM åˆ‡æ¢ G æ‰§è¡Œæ—¶ï¼Œå½“å‰ G çš„ä¸Šä¸‹æ–‡å°±ä¿å­˜åœ¨äº† g ç»“æ„ä¸­ã€‚ type g struct { // Stack parameters. Â // stack describes the actual stack memory: [stack.lo, stack.hi). Â // stackguard0 is the stack pointer compared in the Go stack growth prologue. Â // It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption. Â // stackguard1 is the stack pointer compared in the C stack growth prologue. Â // It is stack.lo+StackGuard on g0 and gsignal stacks. Â // It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash). Â stack stack // offset known to runtime/cgo Â stackguard0 uintptr // offset known to liblink Â stackguard1 uintptr // offset known to liblink _panic *_panic // innermost panic - offset known to liblink Â _defer *_defer // innermost defer Â m *m // current m; offset known to arm liblink Â sched gobuf atomicstatus uint32 goid int64 preempt bool // preemption signal, duplicates stackguard0 = stackpreempt Â preemptStop bool // transition to _Gpreempted on preemption; otherwise, just deschedule Â preemptShrink bool // shrink stack at synchronous safe point lockedm muintptr â€¦ } stackï¼šG å¯¹åº”æ ˆç©ºé—´çš„åœ°å€ï¼Œè§ï¼ˆå†…å­˜ç®¡ç†æ¨¡å‹-Goroutine çš„æ ˆï¼‰ï¼› stackguar0ï¼šæ‰©å®¹æ ˆçš„åœ°å€ï¼Œä¹Ÿå¯ä»¥ç”¨äºåˆ¤æ–­ G æ˜¯å¦åº”è¯¥è¢«æŠ¢å ï¼›å½“ stackguard0 == stackpreempt å°±è¡¨æ˜å½“å‰ G è¢«æŠ¢å äº†ï¼› _panicï¼šG ä¸‹çš„ panic é“¾è¡¨ï¼› _deferï¼šG ä¸‹çš„æ‰€æœ‰ defer ç»„æˆçš„é“¾è¡¨ï¼› mï¼šå½“å‰ç»‘å®šçš„ Mï¼Œä¸º nil å°±è¡¨ç¤ºå½“å‰ G æ²¡æœ‰åœ¨æ‰§è¡Œï¼› schedï¼šG çš„éƒ¨åˆ†ä¸Šä¸‹æ–‡ï¼Œä¼šæä¾›ç»™æ±‡ç¼–ä»£ç ï¼› atomicstatusï¼šG çš„çŠ¶æ€ï¼› goidï¼šG çš„å”¯ä¸€ IDï¼Œä½†æ˜¯ç”¨æˆ·ä»£ç æ— æ³•è¯»å–ï¼› preemptï¼šæŠ¢å æ ‡å¿—ï¼› lockedmï¼šè®°å½• G è¢«é”å®šçš„ Mï¼Œå®ç° runtime.LockOSThread() å…¶ä¸­ g.sched æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»“æ„ï¼Œéœ€è¦çœ‹ä¸€ä¸‹å…¶ gobuf çš„å®ç°ï¼ˆruntime/runtime2.goï¼‰ï¼š type gobuf struct { // The offsets of sp, pc, and g are known to (hard-coded in) libmach. Â // Â // ctxt is unusual with respect to GC: it may be a Â // heap-allocated funcval, so GC needs to track it, but it Â // needs to be set and cleared from assembly, where it's Â // difficult to have write barriers. However, ctxt is really a Â // saved, live register, and we only ever exchange it between Â // the real register and the gobuf. Hence, we treat it as a Â // root during stack scanning, which means assembly that saves Â // and restores it doesn't need write barriers. It's still Â // typed as a pointer so that any other writes from Go get Â // write barriers. Â sp uintptr pc uintptr g guintptr ctxt unsafe.Pointer ret sys.Uintreg â€¦ } spï¼šå½“å‰ G çš„ SP æŒ‡é’ˆåœ°å€ï¼Œåœ¨åˆ›å»º G æ—¶é»˜è®¤è®¾ç½®ä¸º goexit å‡½æ•°åœ°å€ï¼› pcï¼šå½“å‰ G çš„ PC æŒ‡é’ˆåœ°å€ï¼› gï¼šgobuf æ‰€å±çš„ g ç»“æ„åœ°å€ï¼› retï¼šç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼› 2.1.1 G çš„çŠ¶æ€ ç›®å‰ G å¯èƒ½å¤„äºä»¥ä¸‹ 9 ç§çŠ¶æ€ï¼š çŠ¶æ€ å€¼ å«ä¹‰ _Gidle 0 G åˆšåˆ†é…ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ– _Grunnable 1 G å¤„äºå¯è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¢«æ‰§è¡Œ _Grunning 2 G ç»‘å®šäº† Mã€Pï¼Œä¸åœ¨å¯è¿è¡Œé˜Ÿåˆ—ï¼Œå¹¶ä¸”å¯èƒ½æ­£åœ¨æ‰§è¡Œ _Gsyscall 3 G æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è€Œé˜»å¡ï¼Œä¸åœ¨å¯è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œç»‘å®šäº† Mï¼Œæ²¡æœ‰ç»‘å®š P _Gwaiting 4 G å› ä¸ºç”¨æˆ·ç©ºé—´è€Œé˜»å¡ï¼Œä¸åœ¨å¯è¿è¡Œé˜Ÿåˆ—ï¼Œç­‰å¾…å…¶ä»– G å”¤é†’ï¼Œæ²¡æœ‰ç»‘å®š Mã€P _Gdead 5 G å½“å‰æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå…¶ g ç»“æ„å¯ä»¥è¢«å¤ç”¨ _Gcopystack 6 G çš„æ ˆæ­£åœ¨è¢«æ‹·è´ï¼Œæ²¡æœ‰æ‰§è¡Œï¼Œä¸å†å¯è¿è¡Œé˜Ÿåˆ— _Gpreempted 7 ç”±äºæŠ¢å è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œï¼Œç­‰å¾…å”¤é†’ _Gscan 8 GC æ­£åœ¨æ‰«æ G çš„æ ˆï¼Œå¯ä¸å…¶ä»–çŠ¶æ€åŒæ—¶å­˜åœ¨ å…¶çŠ¶æ€è½®è½¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š 2.1.2 G çš„åˆ›å»º åœ¨ä»£ç ä¸­è°ƒç”¨ go è¯­å¥æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶ç¿»è¯‘ä¸º newproc() è°ƒç”¨ï¼Œè¿™ä¹Ÿå°±æ˜¯åˆ›å»º G çš„å¼€ç«¯ï¼š func newproc(siz int32, fn *funcval) { argp := add(unsafe.Pointer(\u0026fn), sys.PtrSize) gp := getg() pc := getcallerpc() systemstack(func() { // åˆ›å»º g ç»“æ„ Â newg := newproc1(fn, argp, siz, gp, pc) // æ”¾å…¥å½“å‰ P æˆ–è€…å…¨å±€å¯è¿è¡Œé˜Ÿåˆ— Â _p_ := getg().m.p.ptr() runqput(_p_, newg, true) if mainStarted { wakep() } }) } // Create a new g in state _Grunnable, starting at fn, with narg bytes // of arguments starting at argp. callerpc is the address of the go // statement that created this. The caller is responsible for adding // the new g to the scheduler. // // This must run on the system stack because it's the continuation of // newproc, which cannot split the stack. // //go:systemstack func newproc1(fn *funcval, argp unsafe.Pointer, narg int32, callergp *g, callerpc uintptr) *g { // è°ƒç”¨ go è¯­å¥çš„ G Â _g_ := getg() siz := narg siz = (siz + 7) \u0026^ 7 // ä» P.gFree è·å–ä¸€ä¸ªå¯å¤ç”¨çš„ g å¯¹è±¡ Â _p_ := _g_.m.p.ptr() newg := gfget(_p_) // æ²¡æœ‰å¯å¤ç”¨çš„ï¼Œé‡æ–°åˆ†é…ä¸€ä¸ª g å¯¹è±¡ Â if newg == nil { newg = malg(_StackMin) casgstatus(newg, _Gidle, _Gdead) allgadd(newg) // publishes with a g-\u003estatus of Gdead so GC scanner doesn't look at uninitialized stack. Â } totalSize := 4*sys.RegSize + uintptr(siz) + sys.MinFrameSize // extra space in case of reads ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:2:1","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.2 M M ä»£è¡¨çš„å°±æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œç”± m ç»“æ„ è¡¨ç¤ºï¼ˆruntime/runtime2.goï¼‰ï¼š type m struct { g0 *g // goroutine with scheduling stack Â gsignal *g // signal-handling g Â goSigStack gsignalStack // Go-allocated signal handling stack Â curg *g // current running goroutine Â p puintptr // attached p for executing go code (nil if not executing go code) Â nextp puintptr oldp puintptr // the p that was attached before executing a syscall Â id int64 lockedg guintptr lockedExt uint32 // tracking for external LockOSThread Â lockedInt uint32 // tracking for internal lockOSThread } g0 : M ç§æœ‰çš„ g0ï¼› gsignal ï¼šç”¨äºå¤„ç†æ“ä½œç³»ç»Ÿä¿¡å·çš„ Gï¼› curg ï¼šå½“å‰ M æ­£åœ¨æ‰§è¡Œçš„ Gï¼› p : å½“å‰ M ç»‘å®šçš„ Pï¼› nextp ï¼šæš‚å­˜çš„ nextpï¼› oldp ï¼šM é™·å…¥ç³»ç»Ÿè°ƒç”¨å‰ç»‘å®šçš„ Pï¼Œç”¨äºç³»ç»Ÿè°ƒç”¨ç»“æŸåå°è¯•é‡æ–°ç»‘å®šï¼› id ï¼šm çš„ IDï¼› lockedg ï¼šä¿å­˜ M é”å®šçš„ Gï¼Œå®ç° runtime.LockOSThread()ï¼› 2.2.1 M çš„åˆ›å»º åœ¨åˆ›å»º G æˆ–è€…å…¶ä»–åœ°æ–¹ï¼Œå½“ G å˜ä¸º runnable åï¼Œå°±ä¼šè°ƒç”¨ wakep() è§¦å‘ä¸€æ¬¡ P æ‰§è¡Œ G çš„è¿‡ç¨‹ã€‚å…¶ä¼šè°ƒç”¨ startm() é€‰æ‹©/åˆ›å»º ä¸€ä¸ª M ç»‘å®š Pï¼Œå¹¶æ‰§è¡Œä¸€ä¸ª Gã€‚ // Tries to add one more P to execute G's. // Called when a G is made runnable (newproc, ready). func wakep() { if atomic.Load(\u0026sched.npidle) == 0 { return } startm(nil, true) } // Schedules some M to run the p (creates an M if necessary). // If p==nil, tries to get an idle P, if no idle P's does nothing. // May run with m.p==nil, so write barriers are not allowed. // If spinning is set, the caller has incremented nmspinning and startm will // either decrement nmspinning or set m.spinning in the newly started M. //go:nowritebarrierrec func startm(_p_ *p, spinning bool) { // é€‰æ‹©ä¸€ä¸ªç©ºé—²çš„ P Â lock(\u0026sched.lock) if _p_ == nil { _p_ = pidleget() if _p_ == nil { unlock(\u0026sched.lock) return } } // é€‰æ‹©ä¸€ä¸ªç©ºé—²çš„ M Â mp := mget() if mp == nil { // No M is available, we must drop sched.lock and call newm. Â // However, we already own a P to assign to the M. Â // Â // Once sched.lock is released, another G (e.g., in a syscall), Â // could find no idle P while checkdead finds a runnable G but Â // no running M's because this new M hasn't started yet, thus Â // throwing in an apparent deadlock. Â // Â // Avoid this situation by pre-allocating the ID for the new M, Â // thus marking it as 'running' before we drop sched.lock. This Â // new M will eventually run the scheduler to execute any Â // queued G's. Â id := mReserveID() unlock(\u0026sched.lock) var fn func() if spinning { // The caller incremented nmspinning, so set m.spinning in the new M. Â fn = mspinning } // åˆ›å»ºä¸€ä¸ª M Â newm(fn, _p_, id) return } unlock(\u0026sched.lock) // The caller incremented nmspinning, so set m.spinning in the new M. Â mp.spinning = spinning mp.nextp.set(_p_) notewakeup(\u0026mp.park) } å½“å­˜åœ¨ç©ºé—²çš„ Pï¼Œä½†æ˜¯æ²¡æœ‰ç©ºé—²çš„ M æ—¶ï¼Œå°±ä¼šè°ƒç”¨ newm() åˆ›å»ºä¸€ä¸ª Mï¼› newm() å°±æ˜¯åˆ›å»º m ç»“æ„ï¼Œä»¥åŠå¯åŠ¨ç³»ç»Ÿçº¿ç¨‹çš„åœ°æ–¹ï¼ˆruntime/proc.goï¼‰ï¼š // Create a new m. It will start off with a call to fn, or else the scheduler. // fn needs to be static and not a heap allocated closure. // May run with m.p==nil, so write barriers are not allowed. // // id is optional pre-allocated m ID. Omit by passing -1. //go:nowritebarrierrec func newm(fn func(), _p_ *p, id int64) { // åˆ†é… m å¯¹è±¡ï¼ˆå¤ç”¨ sched.freem æˆ–è€…æ–°åˆ›å»ºï¼‰ Â mp := allocm(_p_, fn, id) mp.nextp.set(_p_) mp.sigmask = initSigmask â€¦ newm1(mp) } func newm1(mp *m) { â€¦ execLock.rlock() // Prevent process clone. Â newosproc(mp) execLock.runlock() } // May run with m.p==nil, so write barriers are not allowed. //go:nowritebarrier func newosproc(mp *m) { stk := unsafe.Pointer(mp.g0.stack.hi) // ç»™ thread åˆå§‹çš„æ ˆæ¥è‡ªäº g0 Â // Disable signals during clone, so that the new thread starts Â // with signals disabled. It will enable them in minit. Â var oset sigset sigprocmask(_SIG_SETMASK, \u0026sigset_all, \u0026oset) ret := clone(cloneFlags, stk, unsafe.Pointer(mp), unsafe.Pointer(mp.g0), unsafe.Pointer(funcPC(mstart))) sigprocmask(_SIG_SETMASK, \u0026oset, nil) if ret \u003c 0 { throw(\"newosproc\") } } è·å– m å¯¹è±¡ï¼Œæ¥è‡ªäº sched.freem æˆ–è€…æ–°åˆ›å»ºä¸€ä¸ªï¼› é€šè¿‡ clone() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ï¼Œæ‰§è¡Œçš„å‡½æ•°ä¸º mstart()ï¼› çœ‹ä¸€ä¸‹ clone çš„ flagsï¼š var ( cloneFlags = _CLONE_VM | /* share memory */ _CLONE_FS | /* share cwd, etc */ _CLONE_FILES | /* share fd table */ _CLONE_SIGHAND | /* share sig handler table */ _CLONE_SYSVSEM | /* share SysV semaphore undo lists (see issue #20763) */ _CLONE_THREAD /* revis","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:2:2","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.3 P P æ˜¯ M ä¸ G çš„ä¸­é—´å±‚ï¼Œæ²¡æœ‰äº† Pï¼ŒM ä¸ G å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ã€‚é€šè¿‡ P æ¥åˆ†ç‰‡æ‰€æœ‰å¯è¿è¡Œçš„ Gï¼Œä½¿å¾—è¿è¡Œæ•ˆç‡æ›´åŠ çš„é«˜ã€‚ p æ˜¯ P çš„ç»“æ„ä½“è¡¨ç¤ºï¼ˆruntime/runtime2.goï¼‰ï¼š type p struct { id int32 status uint32 // one of pidle/prunning/... Â m muintptr // back-link to associated m (nil if idle) Â mcache *mcache pcache pageCache // Queue of runnable goroutines. Accessed without lock. Â runqhead uint32 runqtail uint32 runq [256]guintptr // runnext, if non-nil, is a runnable G that was ready'd by Â // the current G and should be run next instead of what's in Â // runq if there's time remaining in the running G's time Â // slice. It will inherit the time left in the current time Â // slice. If a set of goroutines is locked in a Â // communicate-and-wait pattern, this schedules that set as a Â // unit and eliminates the (potentially large) scheduling Â // latency that otherwise arises from adding the ready'd Â // goroutines to the end of the run queue. Â runnext guintptr // Available G's (status == Gdead) Â gFree struct { gList n int32 } sudogcache []*sudog sudogbuf [128]*sudog } status ï¼šP çš„çŠ¶æ€ï¼› m ï¼šå½“å‰ç»‘å®šçš„ Mï¼› mcache ï¼šP å”¯ä¸€çš„ mcacheï¼Œå°†ã€å†…å­˜ç®¡ç†ã€‘ï¼› runqhead ï¼šP çš„å¯è¿è¡Œé˜Ÿåˆ—çš„ head indexï¼› runqtail ï¼šP çš„å¯ä»¥è¡Œé˜Ÿåˆ—çš„ tail indexï¼› runq ï¼šP çš„å¯è¿è¡Œé˜Ÿåˆ—ï¼Œå¯ä»¥çœ‹åˆ°å¤§å°ä¸º 256ï¼› runnext ï¼šä¸‹ä¸€æ¬¡ä¼˜å…ˆæ‰§è¡Œçš„ Gï¼Œä¼˜å…ˆçº§é«˜äº runqï¼› gFree ï¼šå¯å¤ç”¨çš„ g ç»“æ„é“¾è¡¨ï¼› P è¿˜åŒ…å«å¤§é‡ä¸ GC å†…å­˜ç®¡ç†ç›¸å…³çš„å­—æ®µï¼Œè¿™é‡Œæš‚æ—¶çœç•¥ã€‚ 2.3.1 P çš„çŠ¶æ€ çŠ¶æ€ å€¼ å«ä¹‰ _Pidle 0 P æ²¡æœ‰ä»»ä½• G å¯ä»¥æ‰§è¡Œï¼Œè¢«ç©ºé—² P é“¾è¡¨æŒæœ‰ç€ _Prunning 1 P ç»‘å®šäº†ä¸€ä¸ª Mï¼Œå¹¶ä¸”æ­£åœ¨æ‰§è¡Œ G _Psyscall 2 P ç»‘å®šäº† Mï¼Œä½†æ˜¯ M é™·å…¥ç³»ç»Ÿè°ƒç”¨é˜»å¡ï¼ŒP å¯ä»¥è¢«å…¶ä»– M è·å– _Pgcstop 3 P ç»‘å®šç€ Mï¼Œä½†æ˜¯å› ä¸º STW æŒ‚èµ· _Pdead 4 P ä¸åœ¨è¢«ä½¿ç”¨ï¼Œç”±äº GOMAXPROCS ç¼©å° å¯ä»¥çœ‹åˆ°ï¼Œ_Pidle ä¸ _Psyscall éƒ½å±äº P å¯ä»¥è¢«å…¶ä»– M ç»‘å®šçš„çŠ¶æ€ã€‚ 2.3.2 P çš„åˆ›å»º/é”€æ¯ å‰é¢å¯ä»¥çœ‹åˆ°ï¼ŒG æ˜¯ç”± go å‘½ä»¤åˆ›å»ºçš„ï¼Œè€Œ M æ˜¯æŒ‰éœ€åˆ›å»ºçš„ã€‚P çš„åˆ›å»ºä¸åŒï¼Œå› ä¸ºå…¶ä»£è¡¨çš„æ˜¯å¹¶å‘ä¸ªæ•°ï¼Œæ‰€ä»¥å…¶åˆ›å»ºæ˜¯åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºã€‚ åœ¨æ‰§è¡Œç”¨æˆ· main å‡½æ•°ä¹‹é—´çš„ scheinit() ä¸­è¿›è¡Œ runtime çš„åˆå§‹åŒ–ï¼Œå…¶ä¸­ä¸€é¡¹å°±æ˜¯åˆå§‹åŒ– P: // The bootstrap sequence is: // //Â call osinit //Â call schedinit //Â make \u0026 queue new G //Â call runtimeÂ·mstart // // The new G calls runtimeÂ·main. func schedinit() { // â€¦ procs := ncpu if n, ok := atoi32(gogetenv(\"GOMAXPROCS\")); ok \u0026\u0026 n \u003e 0 { procs = n } if procresize(procs) != nil { throw(\"unknown runnable goroutine during bootstrap\") } // â€¦ } procresize() ç”¨äºæ”¹å˜ P çš„æ•°é‡ï¼ˆruntime/proc.goï¼‰ï¼š // Change number of processors. The world is stopped, sched is locked. // gcworkbufs are not being modified by either the GC or // the write barrier code. // Returns list of Ps with local work, they need to be scheduled by the caller. func procresize(nprocs int32) *p { old := gomaxprocs // æ‰©å¤§ P çš„æ•°é‡ Â // Grow allp if necessary. Â if nprocs \u003e int32(len(allp)) { // Synchronize with retake, which could be running Â // concurrently since it doesn't run on a P. Â lock(\u0026allpLock) if nprocs \u003c= int32(cap(allp)) { allp = allp[:nprocs] } else { nallp := make([]*p, nprocs) // Copy everything up to allp's cap so we Â // never lose old allocated Ps. Â copy(nallp, allp[:cap(allp)]) allp = nallp } unlock(\u0026allpLock) } // åˆå§‹åŒ–æ–°çš„ P Â // initialize new P's Â for i := old; i \u003c nprocs; i++ { pp := allp[i] if pp == nil { pp = new(p) } pp.init(i) atomicstorep(unsafe.Pointer(\u0026allp[i]), unsafe.Pointer(pp)) } // å¦‚æœå½“å‰ M ç»‘å®šçš„ P æ˜¯è¦è¢«é‡Šæ”¾çš„ï¼Œé‚£ä¹ˆ M æ–°é€‰å–ä¸€ä¸ªå¯ç”¨çš„ P Â _g_ := getg() if _g_.m.p != 0 \u0026\u0026 _g_.m.p.ptr().id \u003c nprocs { // continue to use the current P Â _g_.m.p.ptr().status = _Prunning _g_.m.p.ptr().mcache.prepareForSweep() } else { // release the current P and acquire allp[0]. Â // Â // We must do this before destroying our current P Â // because p.destroy itself has write barriers, so we Â // need to do that from a valid P. Â if _g_.m.p != 0 { _g_.m.p.ptr().m = 0 } _g_.m.p = 0 p := allp[0] p.m = 0 p.status = _Pidle acquirep(p) if trace.enabled { traceGoStart() } } // g.m.p is now set, so we no longer need mcache0 for bootstrapping. Â mcache0 = nil // æ¸…ç†ä¸ä½¿ç”¨çš„ P Â // release resources from unused P's Â for i := nprocs; i \u003c old; i++ { p := allp[i] p.destroy() // can't free P itself because it can be referenced by an M in syscall Â } // Trim allp. Â if int32(len(allp)) != nprocs { lock(\u0026allpLock) allp = allp[:nprocs] unlock(\u0026allpLock) } var runnablePs *p for i := nprocs - 1; i \u003e= 0; i-- { p := allp[i] if _g_.m.p.ptr() == p { continue } p.status = _Pidle if runqempty(p) { pidleput(p) } else { p.m.set(mget())","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:2:3","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.4 schedt schedt æ˜¯ä¸€ä¸ªå•ä¾‹å…¨å±€å˜é‡ï¼ŒåŒ…å«ä¸€äº›å…¨å±€çš„é“¾è¡¨ï¼ˆruntime/runtime2.goï¼‰ï¼š var sched schedt type schedt struct { // When increasing nmidle, nmidlelocked, nmsys, or nmfreed, be Â // sure to call checkdead(). midle muintptr // idle m's waiting for work Â nmidle int32 // number of idle m's waiting for work pidle puintptr // idle p's Â npidle uint32 // Global runnable queue. Â runq gQueue runqsize int32 // disable controls selective disabling of the scheduler. Â // Â // Use schedEnableUser to control this. Â // Â // disable is protected by sched.lock. Â disable struct { // user disables scheduling of user goroutines. Â user bool runnable gQueue // pending runnable Gs Â n int32 // length of runnable Â } // Global cache of dead G's. Â gFree struct { lock mutex stack gList // Gs with stacks Â noStack gList // Gs without stacks Â n int32 } // Central cache of sudog structs. Â sudoglock mutex sudogcache *sudog // Central pool of available defer structs of different sizes. Â deferlock mutex deferpool [5]*_defer // freem is the list of m's waiting to be freed when their Â // m.exited is set. Linked through m.freelink. Â freem *m } midle ï¼šç©ºé—²çš„ M çš„é“¾è¡¨ï¼› pidle ï¼šç©ºé—²çš„ P çš„é“¾è¡¨ï¼› runq ï¼šå…¨å±€çš„å¯è¿è¡Œçš„ G é˜Ÿåˆ—ï¼› gFree ï¼šå…¨å±€çš„å¯å¤ç”¨çš„ g ç»“æ„é˜Ÿåˆ—ï¼› freem ï¼šç­‰å¾…é‡Šæ”¾çš„ M çš„é“¾è¡¨ï¼Œå½“ M æ–°å»ºæ—¶ä¼šå°†å…¶é‡Šæ”¾ï¼Œå¹¶å¤ç”¨ m å¯¹è±¡ï¼› ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:2:4","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3 è°ƒåº¦å¾ªç¯ å‰é¢ M çš„å¯åŠ¨çœ‹åˆ°ï¼Œæ¯ä¸ª M åˆ›å»ºåä¼šè¿›å…¥ schedule() çš„è°ƒåº¦å¾ªç¯ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å›ï¼Œæ¯ä¸ª M æ‰§è¡Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š æ‰§è¡Œ schedule()ï¼Œ ä½¿å¾— M æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ Gï¼Œå¹¶ç»‘å®šï¼› æ‰§è¡Œ execute()ï¼Œå®Œæˆæ‰§è¡Œ G.fn çš„å‡†å¤‡å·¥ä½œï¼› è°ƒç”¨ G çš„å‡½æ•°ï¼› G å‡½æ•°è°ƒç”¨é€€å‡ºåï¼Œè°ƒç”¨ goexit() å‡½æ•°æ¸…ç†ç›¸å…³èµ„æºï¼Œå¹¶é‡æ–°è¿›å…¥ schedule()ï¼› å½“ç„¶ï¼Œä¸Šé¢æ˜¯æ­£å¸¸ G æ‰§è¡Œå¹¶é€€å‡ºçš„é€»è¾‘ï¼Œå¤šæ•°æƒ…å†µä¸‹ G æ‰§è¡Œçš„è¿‡ç¨‹ä¸­éƒ½ä¼šç»å†æŠ¢å ä¸è°ƒåº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼š M å¯èƒ½ä¼šåˆ‡æ¢ Pã€åˆ‡æ¢ G æ‰§è¡Œã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:3:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.1 schedule() schedule() æ˜¯è°ƒåº¦å¾ªç¯çš„ç¬¬ä¸€æ­¥ï¼ŒM ä¼šåœ¨è¿™é‡Œå°½åŠ›å¯»æ‰¾ä¸€ä¸ª runnable Gï¼Œç„¶åè¿›å…¥ execute() æ‰§è¡Œ G çš„ä»£ç ï¼š // One round of scheduler: find a runnable goroutine and execute it. // Never returns. func schedule() { _g_ := getg() // é”å®šäº† G, é‚£ä¹ˆè¿˜æ˜¯æ‰§è¡Œé”å®šçš„ G Â if _g_.m.lockedg != 0 { stoplockedm() execute(_g_.m.lockedg.ptr(), false) // Never returns. Â } top: pp := _g_.m.p.ptr() pp.preempt = false // STW ä¸­ï¼Œç­‰å¾…ç»“æŸ Â if sched.gcwaiting != 0 { gcstopm() goto top } // è¿è¡Œ timer Â checkTimers(pp, 0) // gp ä¸ºæ–°è°ƒåº¦åˆ°çš„ G Â var gp *g var inheritTime bool // Normal goroutines will check for need to wakeP in ready, Â // but GCworkers and tracereaders will not, so the check must Â // be done here instead. Â tryWakeP := false if trace.enabled || trace.shutdown { gp = traceReader() if gp != nil { casgstatus(gp, _Gwaiting, _Grunnable) traceGoUnpark(gp, 0) tryWakeP = true } } // GC æ‰«æå¼€å§‹å·¥ä½œï¼Œå°è¯• GCWorker çš„ G Â if gp == nil \u0026\u0026 gcBlackenEnabled != 0 { gp = gcController.findRunnableGCWorker(_g_.m.p.ptr()) tryWakeP = tryWakeP || gp != nil } // å®šæœŸç›´æ¥ä» å…¨å±€å¯è¿è¡Œé˜Ÿåˆ— è·å– Gï¼Œé˜²æ­¢é¥¥é¥¿ Â if gp == nil { // Check the global runnable queue once in a while to ensure fairness. Â // Otherwise two goroutines can completely occupy the local runqueue Â // by constantly respawning each other. Â if _g_.m.p.ptr().schedtick%61 == 0 \u0026\u0026 sched.runqsize \u003e 0 { lock(\u0026sched.lock) gp = globrunqget(_g_.m.p.ptr(), 1) unlock(\u0026sched.lock) } } // ä»å½“å‰ P çš„ å¯è¿è¡Œé˜Ÿåˆ— è·å–ä¸€ä¸ª G Â if gp == nil { gp, inheritTime = runqget(_g_.m.p.ptr()) // We can see gp != nil here even if the M is spinning, Â // if checkTimers added a local goroutine via goready. Â } // ä¸Šé¢éƒ½å°è¯•äº†ï¼Œå°½å¯èƒ½å»æ‰¾åˆ°ä¸€ä¸ª Gï¼Œè¿™é‡Œä¼šé˜»å¡ Â if gp == nil { gp, inheritTime = findrunnable() // blocks until work is available Â } // This thread is going to run a goroutine and is not spinning anymore, Â // so if it was marked as spinning we need to reset it now and potentially Â // start a new spinning M. Â if _g_.m.spinning { resetspinning() } // å¸®å¿™å”¤é†’åˆ«çš„ P Â // If about to schedule a not-normal goroutine (a GCworker or tracereader), Â // wake a P if there is one. Â if tryWakeP { wakep() } // å¦‚æœé€‰å‡ºçš„ G æ˜¯è¢«åˆ«çš„ M é”å®šçš„ï¼Œé‚£ä¹ˆåªèƒ½é‡æ–°èµ°æµç¨‹ Â if gp.lockedm != 0 { // Hands off own p to the locked m, Â // then blocks waiting for a new p. Â startlockedm(gp) goto top } // æ‰§è¡Œæ–°çš„ G Â execute(gp, inheritTime) } M æœ‰é”å®šçš„ Gï¼Œæ‰§è¡Œé”å®š G ä»£ç ï¼› ä»å„ä¸ªåœ°æ–¹å¾—åˆ°ä¸€ä¸ª runnable Gï¼ŒåŒ…æ‹¬ï¼š GCWork çš„ Gï¼Œè§ï¼š å®šæœŸç›´æ¥ä» å…¨å±€å¯è¿è¡Œçš„é˜Ÿåˆ— è·å– Gï¼Œé˜²æ­¢å…¨å±€é˜Ÿåˆ—çš„ G é•¿æ—¶é—´é¥¥é¥¿ï¼› ä»ç»‘å®šçš„ P çš„ å¯è¿è¡Œé˜Ÿåˆ— è·å– Gï¼› é€šè¿‡ fundrunnable() å°½å¯èƒ½è·å–ä¸€ä¸ª Gï¼› æœ€ç»ˆï¼Œè·å–åˆ°ä¸€ä¸ª G åï¼Œexecute() æ‰§è¡Œ G çš„ä»£ç ï¼› 3.1.1 fundrunnable() ä¸ºäº†æ‰¾åˆ°å¯ä»¥è¿è¡Œçš„ Gï¼Œfindrunnable() ä¼šå°è¯•å„ä¸ªæ‰‹æ®µã€‚ä½†æ˜¯è¿™ä¸ªä»£ç æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæ¡æœ€å…³é”®çš„ç‚¹çœ‹ï¼ˆruntime/proc.goï¼‰ï¼š // Finds a runnable goroutine to execute. // Tries to steal from other P's, get g from local or global queue, poll network. func findrunnable() (gp *g, inheritTime bool) { _g_ := getg() top: // æ­£åœ¨åƒåœ¾å›æ”¶ STWï¼Œä¼‘çœ è½®è¯¢ Â _p_ := _g_.m.p.ptr() if sched.gcwaiting != 0 { gcstopm() goto top } now, pollUntil, _ := checkTimers(_p_, 0) if fingwait \u0026\u0026 fingwake { if gp := wakefing(); gp != nil { ready(gp, 0, true) } } // ä»ç»‘å®šçš„ P é˜Ÿåˆ—è·å– Â if gp, inheritTime := runqget(_p_); gp != nil { return gp, inheritTime } // ä»å…¨å±€é˜Ÿåˆ—è·å– Â if sched.runqsize != 0 { lock(\u0026sched.lock) gp := globrunqget(_p_, 0) unlock(\u0026sched.lock) if gp != nil { return gp, false } } // æ£€æŸ¥å…¨å±€çš„ netpoll çš„ G Â if netpollinited() \u0026\u0026 atomic.Load(\u0026netpollWaiters) \u003e 0 \u0026\u0026 atomic.Load64(\u0026sched.lastpoll) != 0 { if list := netpoll(0); !list.empty() { // non-blocking Â gp := list.pop() injectglist(\u0026list) casgstatus(gp, _Gwaiting, _Grunnable) if trace.enabled { traceGoUnpark(gp, 0) } return gp, false } } // ä»åˆ«çš„ P å·å–ä¸€åŠçš„ä»»åŠ¡ Â // Steal work from other P's. Â procs := uint32(gomaxprocs) ranTimer := false for i := 0; i \u003c 4; i++ { for enum := stealOrder.start(fastrand()); !enum.done(); enum.next() { if sched.gcwaiting != 0 { goto top } stealRunNextG := i \u003e 2 // first look for ready queues with more than 1 g Â p2 := allp[enum.position()] if _p_ == p2 { continue } if gp := runqsteal(_p_, p2, stealRunNextG); gp != nil { return gp, false } // Consider stealing timers from p2. // This call to checkTimers is the only place where // we hold a lock on a different P's timers. // Lock content","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:3:1","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.2 execute() execute() è®©å½“å‰çº¿ç¨‹æ‰§è¡Œ G çš„ä»£ç ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å›ï¼š // Schedules gp to run on the current M. // If inheritTime is true, gp inherits the remaining time in the // current time slice. Otherwise, it starts a new time slice. // Never returns. func execute(gp *g, inheritTime bool) { _g_ := getg() // Assign gp.m before entering _Grunning so running Gs have an Â // M. Â _g_.m.curg = gp gp.m = _g_.m casgstatus(gp, _Grunnable, _Grunning) gp.waitsince = 0 gp.preempt = false gp.stackguard0 = gp.stack.lo + _StackGuard if !inheritTime { _g_.m.p.ptr().schedtick++ } // â€¦ gogo(\u0026gp.sched) } ä¸è¿‡ execute() æ‰§è¡Œçš„æ˜¯ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œåˆ‡æ¢ PCã€SP ç­‰æ“ä½œåªèƒ½é€šè¿‡æ±‡ç¼–çš„ gogo å®ç°ï¼Œæ³¨æ„å…³é”®çš„ g.sched ç»“æ„ï¼ˆgobuf ç»“æ„ï¼‰çš„ä¼ å‚ã€‚ // func gogo(buf *gobuf) // restore state from Gobuf; longjmp TEXT runtimeÂ·gogo(SB), NOSPLIT, $16-8 MOVQÂ buf+0(FP), BXÂ // gobuf å†…å®¹æ”¾åˆ° BX å¯„å­˜å™¨ Â MOVQÂ gobuf_g(BX), DX MOVQÂ 0(DX), CXÂ // make sure g != nil Â get_tls(CX) MOVQÂ DX, g(CX) MOVQÂ gobuf_sp(BX), SPÂ // å°† SP åœ°å€è®¾ç½®ä¸º gobuf.spã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œ G æ—¶ï¼Œè¿™é‡Œæ˜¯ goexit å‡½æ•°åœ°å€ Â MOVQÂ gobuf_ret(BX), AX MOVQÂ gobuf_ctxt(BX), DX MOVQÂ gobuf_bp(BX), BP MOVQÂ $0, gobuf_sp(BX)Â // clear to help garbage collector Â MOVQÂ $0, gobuf_ret(BX) MOVQÂ $0, gobuf_ctxt(BX) MOVQÂ $0, gobuf_bp(BX) MOVQÂ gobuf_pc(BX), BX // å°† BX å¯„å­˜å™¨è®¾ç½®ä¸º gobuf.pcã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œ G æ—¶ï¼Œè¿™é‡Œæ˜¯ G çš„å‡½æ•°åœ°å€ Â JMPÂ BX // JMP gobuf.pcï¼Œå¼€å§‹æ‰§è¡Œ è¿™é‡Œæœ€å…³é”®çš„å°±æ˜¯åˆ‡æ¢ä¸º G çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼š å°† SP è®¾ç½®ä¸º gobuf.spã€‚å¦‚æœ G æ²¡æœ‰æ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆå€¼å°±æ˜¯åˆ›å»º g ç»“æ„æ—¶å¡«å…¥çš„ goexit() å‡½æ•°çš„åœ°å€ã€‚ ä»£ç æµé€šè¿‡ JMP æŒ‡ä»¤è·³è½¬åˆ° gobuf.pcã€‚å¦‚æœ G æ²¡æœ‰æ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆå°±æ˜¯ G å¯¹åº”ä»£ç çš„åœ°å€ã€‚ è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“äº†ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨å°±æ˜¯å°† è¿”å›å‡½æ•°ã€å‚æ•° å‹æ ˆçš„è¿‡ç¨‹ã€‚è€Œè¿™é‡Œå°†æ ˆé¡¶è®¾ç½®ä¸º goexit() å‡½æ•°ï¼Œæ‰€ä»¥å½“ G å¯¹åº”ç”¨æˆ·ä»£ç æ‰§è¡Œå®Œåï¼Œå°±ä¼šç»§ç»­æ‰§è¡Œ goexit() å‡½æ•°ã€‚è¿™å°±æ˜¯ M ä¸æ–­æ‰§è¡Œè°ƒåº¦å¾ªç¯çš„å…³é”®ã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:3:2","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.3 goexit() goexit() åœ¨ G ç”¨æˆ·ä»£ç æ‰§è¡Œåï¼Œæ‰§è¡Œçš„æ±‡ç¼–ä»£ç ï¼Œå…¶æœ€åé€šè¿‡åˆ‡æ¢åˆ° g0 æ ˆè°ƒç”¨ goexit0() å‡½æ•°ï¼š // goexit continuation on g0. func goexit0(gp *g) { _g_ := getg() // G running å˜ä¸º dead Â casgstatus(gp, _Grunning, _Gdead) // é‡ç½® g çš„å±æ€§ Â if isSystemGoroutine(gp, false) { atomic.Xadd(\u0026sched.ngsys, -1) } gp.m = nil locked := gp.lockedm != 0 gp.lockedm = 0 _g_.m.lockedg = 0 gp.preemptStop = false gp.paniconfault = false gp._defer = nil // should be true already but just in case. Â gp._panic = nil // non-nil for Goexit during panic. points at stack-allocated data. Â gp.writebuf = nil gp.waitreason = 0 gp.param = nil gp.labels = nil gp.timer = nil if gcBlackenEnabled != 0 \u0026\u0026 gp.gcAssistBytes \u003e 0 { // Flush assist credit to the global pool. This gives Â // better information to pacing if the application is Â // rapidly creating an exiting goroutines. Â scanCredit := int64(gcController.assistWorkPerByte * float64(gp.gcAssistBytes)) atomic.Xaddint64(\u0026gcController.bgScanCredit, scanCredit) gp.gcAssistBytes = 0 } // è§£é™¤ M ä¸ G çš„ç»‘å®š Â dropg() // å°† dead G æ”¾åˆ° p.gFree æˆ–è€… sched.gFree Â gfput(_g_.m.p.ptr(), gp) if locked { // å¦‚æœ M ä¸ G æ˜¯é”å®šçš„ï¼Œé‚£ä¹ˆ M çº¿ç¨‹é€€å‡º Â // The goroutine may have locked this thread because Â // it put it in an unusual kernel state. Kill it Â // rather than returning it to the thread pool. // Return to mstart, which will release the P and exit // the thread. if GOOS != \"plan9\" { // See golang.org/issue/22227. gogo(\u0026_g_.m.g0.sched) } else { // Clear lockedExt on plan9 since we may end up re-using // this thread. _g_.m.lockedExt = 0 } } // é‡æ–°è¿›å…¥è°ƒåº¦å¾ªç¯ Â schedule() } G çŠ¶æ€ç”± _Grunning å˜ä¸º _Gdeadï¼› é‡ç½® G çš„å±æ€§ï¼› é€šè¿‡ dropg() è§£é™¤ M ä¸ G çš„ç»‘å®šï¼› å°† g å¯¹è±¡æ”¾åˆ° p.gFree æˆ–è€… sched.gFreeï¼Œä»¥ä¾¿åç»­åˆ›å»º G æ—¶å¯ä»¥å¤ç”¨å¯¹è±¡ï¼› å¦‚æœ M ä¸ G æ˜¯é”å®šç€çš„ï¼Œè€Œ G æ‰§è¡Œå®Œæ¯•ï¼Œè®© m å›åˆ° mstart() å‡½æ•°ç»§ç»­æ‰§è¡Œï¼Œè¿™æ · M çº¿ç¨‹ä¼šè¢«é”€æ¯å¹¶é€€å‡ºï¼› é‡æ–°è¿›å…¥ schedule() è°ƒåº¦å¾ªç¯ï¼› ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:3:3","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4 è°ƒåº¦åˆ‡æ¢ å½“å‰ï¼Œè°ƒåº¦å¾ªç¯ä¸­æè¿°çš„æƒ…å†µæ˜¯ä¸€ä¸ª M æ‰§è¡Œ G ä¸è¢«æŠ¢å ä¸è°ƒåº¦çš„æƒ…å†µã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå½“ M æ‰§è¡Œ G.fn çš„è¿‡ç¨‹ä¸­å°±ä¼šè¢«åˆ‡æ¢ï¼Œæ‰§è¡Œå…¶ä»–çš„ G çš„æƒ…å†µã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:4:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.1 åˆ‡æ¢æ—¶æœº å…ˆå¤§ä½“æ€»ç»“ä¸€ä¸‹å¯èƒ½çš„åˆ‡æ¢æ—¶æœºï¼š ä¸»åŠ¨æŒ‚èµ· é‡åˆ° runtime çº§åˆ«é˜»å¡ï¼ˆä¾‹å¦‚ channel è¯»å†™é˜»å¡ï¼‰ ä¸»åŠ¨è°ƒåº¦ è°ƒç”¨ runtime.Gosched() ä¸»åŠ¨è¿›è¡Œè°ƒåº¦ ç³»ç»Ÿè°ƒç”¨ ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼ŒM å¯èƒ½è¿›è¡Œ G çš„åˆ‡æ¢ï¼› æŠ¢å  sysmon åˆ¤æ–­ G è¿è¡Œæ—¶é—´å¤§äº 10msï¼Œè¿›è¡ŒæŠ¢å ï¼› ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:4:1","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.2 ä¸»åŠ¨æŒ‚èµ· åœ¨ G é‡åˆ°éç³»ç»Ÿè°ƒç”¨çš„é˜»å¡å‰ï¼Œå°±ä¼šè°ƒç”¨ gopark()ï¼Œå°† G ç”± _Grunning -\u003e _Gwaitingï¼Œè€Œ M è§£ç»‘ Gï¼Œé‡æ–°è¿›å…¥è°ƒåº¦å¾ªç¯ï¼š // Puts the current goroutine into a waiting state and calls unlockf. // If unlockf returns false, the goroutine is resumed. func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) { if reason != waitReasonSleep { checkTimeouts() // timeouts may expire while two goroutines keep the scheduler busy Â } mp := acquirem() gp := mp.curg status := readgstatus(gp) mp.waitlock = lock mp.waitunlockf = unlockf gp.waitreason = reason mp.waittraceev = traceEv mp.waittraceskip = traceskip releasem(mp) // can't do anything that might move the G between Ms here. Â mcall(park_m) } // park continuation on g0. func park_m(gp *g) { _g_ := getg() // æ”¹å˜ G çŠ¶æ€ Â casgstatus(gp, _Grunning, _Gwaiting) // M è§£ç»‘ G Â dropg() if fn := _g_.m.waitunlockf; fn != nil { ok := fn(gp, _g_.m.waitlock) _g_.m.waitunlockf = nil _g_.m.waitlock = nil if !ok { if trace.enabled { traceGoUnpark(gp, 2) } casgstatus(gp, _Gwaiting, _Grunnable) execute(gp, true) // Schedule it back, never returns. Â } } // é‡æ–°è¿›å…¥è°ƒåº¦å¾ªç¯ Â schedule() } Note ä¸Šé¢æ²¡æœ‰ä»»ä½•åœ°æ–¹è®°å½• _Gwaiting çŠ¶æ€çš„ Gï¼ŒWhyï¼Ÿ å› ä¸ºè¿™æ—¶ gopark() è°ƒç”¨è€…çš„è´£ä»»ï¼Œä¾‹å¦‚ channel è¯»å†™é˜»å¡æ—¶ï¼Œä¼šå°† g è®°å½•åˆ° channel æ—¶ï¼Œåœ¨å”¤é†’æ—¶å°† G é‡æ–°åŠ å…¥åˆ°å¯è¿è¡Œé˜Ÿåˆ—ã€‚ å½“è¿›å…¥ _Gwaiting çŠ¶æ€çš„ G éœ€è¦æ¢å¤æ—¶ï¼Œè°ƒç”¨ goready() / goparkunlock() å‡½æ•°è¿›è¡Œæ¢å¤ï¼š func goready(gp *g, traceskip int) { systemstack(func() { ready(gp, traceskip, true) }) } // Mark gp ready to run. func ready(gp *g, traceskip int, next bool) { status := readgstatus(gp) // è·å–ä¸€ä¸ª M Â // Mark runnable. Â _g_ := getg() mp := acquirem() // disable preemption because it can be holding p in a local var // waiting -\u003e runnable Â // status is Gwaiting or Gscanwaiting, make Grunnable and put on runq Â casgstatus(gp, _Gwaiting, _Grunnable) // æ”¾ç½®åˆ° M å¯¹åº” P çš„ runqï¼Œç­‰å¾…è°ƒåº¦æ‰§è¡Œ Â runqput(_g_.m.p.ptr(), gp, next) wakep() releasem(mp) } è°ƒç”¨ gopark() çš„åœ°æ–¹æœ‰è®¸å¤šï¼Œåˆ—å‡ºä¸»è¦çš„å‡ ä¸ªåœ°æ–¹ï¼š channel çš„å‘é€/æ¥å—é˜»å¡ï¼› select æ‰€æœ‰ case ä¸æ»¡è¶³ï¼Œé™·å…¥é˜»å¡ï¼› time.Sleep ä½¿å¾— goroutine è¿›å…¥é˜»å¡ï¼› GC å·¥ä½œçš„ gcwork æŒ‚èµ·ç­‰å¾…å”¤é†’ï¼› main goroutine æŒ‚èµ·å¹¶ä¸”ä¸ä¼šè¢«å”¤é†’ï¼› ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:4:2","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.3 ä¸»åŠ¨è°ƒåº¦ æ ‡å‡†åº“æ¥å£ runtime.Gosched() å¯ä»¥åœ¨ç”¨æˆ·ä»£ç ä¸­ä½¿ G ä¸»åŠ¨è®©å‡º Mï¼š func Gosched() { checkTimeouts() mcall(gosched_m) } // Gosched continuation on g0. func gosched_m(gp *g) { goschedImpl(gp) } func goschedImpl(gp *g) { // running çŠ¶æ€å˜ä¸º runnable Â casgstatus(gp, _Grunning, _Grunnable) // M ä¸ G è§£ç»‘ Â dropg() // æ”¾åˆ° global runq Â lock(\u0026sched.lock) globrunqput(gp) unlock(\u0026sched.lock) schedule() } æœ€åä¼šè°ƒç”¨ goschedImpl()ï¼Œå°† G ç”± _Grunning -\u003e _Grunnable çŠ¶æ€ï¼ŒM ä¸ G è§£ç»‘ï¼Œå¹¶å°†å…¶æ”¾åˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚ Note å› ä¸ºè°ƒç”¨ goschedImpl() æ˜¯è¦åˆ‡æ¢æ­£åœ¨è¿è¡Œçš„ Gï¼Œæ‰€ä»¥æ”¾åˆ°å…¨å±€é˜Ÿåˆ—ã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:4:3","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.4 ç³»ç»Ÿè°ƒç”¨ Go é€šè¿‡ syscall.Syscall å’Œ syscall.RawSyscall æ¥å°è£…ç³»ç»Ÿçš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ã€‚ syscall.Syscall é’ˆå¯¹å¯èƒ½é•¿æ—¶é—´é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚ IO æ“ä½œã€‚ ä½¿å¾—åœ¨é™·å…¥ç³»ç»Ÿè°ƒç”¨ä¹‹é—´ï¼Œç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼Œå¯ä»¥è§¦å‘ä¸€äº›å‡†å¤‡å’Œæƒ…å†µå·¥ä½œã€‚ syscall.RawSyscall é’ˆå¯¹ä¸å¤ªä¼šé•¿æ—¶é—´é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚ è¯»å–æ—¶é—´ç­‰ã€‚ ç›´æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸åšå…¶ä»–å¤„ç†ã€‚ ç³»ç»Ÿè°ƒç”¨åˆ†ç±» å¤§ç¥å°†å„ä¸ªç³»ç»Ÿè°ƒç”¨åˆ†ç±»äº†ï¼Œè§ è¿™é‡Œ TEXT Â·Syscall(SB),NOSPLIT,$0-56 CALLÂ runtimeÂ·entersyscall(SB) // è°ƒç”¨ entersyscall() Â MOVQÂ a1+8(FP), DI MOVQÂ a2+16(FP), SI MOVQÂ a3+24(FP), DX MOVQÂ trap+0(FP), AXÂ // syscall entry Â SYSCALL CMPQÂ AX, $0xfffffffffffff001 JLSÂ ok MOVQÂ $-1, r1+32(FP) MOVQÂ $0, r2+40(FP) NEGQÂ AX MOVQÂ AX, err+48(FP) CALLÂ runtimeÂ·exitsyscall(SB) // ç»“æŸè°ƒç”¨ exitsyscall() Â RET ok: MOVQÂ AX, r1+32(FP) MOVQÂ DX, r2+40(FP) MOVQÂ $0, err+48(FP) CALLÂ runtimeÂ·exitsyscall(SB) // ç»“æŸè°ƒç”¨ exitsyscall() Â RET ç³»ç»Ÿè°ƒç”¨å‰ï¼Œæ‰§è¡Œ entersyscall()ï¼› æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼› ç³»ç»Ÿè°ƒç”¨åï¼Œæ‰§è¡Œ exitsyscall()ï¼› 4.4.1 ç³»ç»Ÿè°ƒç”¨å‰çš„å‡†å¤‡ entersyscall() ä¼šè°ƒç”¨ reentersyscall() å‡½æ•°ï¼Œæ‰§è¡Œè¿›å…¥ç³»ç»Ÿè°ƒç”¨å‰çš„å‡†å¤‡å·¥ä½œï¼š func reentersyscall(pc, sp uintptr) { _g_ := getg() _g_.m.locks++ _g_.stackguard0 = stackPreempt _g_.throwsplit = true save(pc, sp) _g_.syscallsp = sp _g_.syscallpc = pc casgstatus(_g_, _Grunning, _Gsyscall) _g_.m.syscalltick = _g_.m.p.ptr().syscalltick _g_.m.mcache = nil pp := _g_.m.p.ptr() pp.m = 0 _g_.m.oldp.set(pp) _g_.m.p = 0 atomic.Store(\u0026pp.status, _Psyscall) if sched.gcwaiting != 0 { systemstack(entersyscall_gcwait) save(pc, sp) } _g_.m.locks-- } ç¦æ­¢çº¿ç¨‹ä¸Šå‘ç”Ÿçš„æŠ¢å ï¼Œé˜²æ­¢å‡ºç°å†…å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼› ä¿è¯å½“å‰å‡½æ•°ä¸ä¼šè§¦å‘æ ˆåˆ†è£‚æˆ–è€…å¢é•¿ï¼› é€šè¿‡ save() ä¿å­˜ PCã€SP å€¼è‡³ g.schedï¼› G çŠ¶æ€ _Grunning -\u003e _Gsyscallï¼› m.oldp è®¾ç½®ä¸ºå½“å‰ Pï¼Œm.p è®¾ç½®ä¸º 0ï¼Œè¿™æ„å‘³ç€è®°å½•ä½†æ˜¯è§£ç»‘å½“å‰çš„ Pï¼Œè€Œ P çŠ¶æ€ä¸º _Psyscallï¼› è¿™é‡Œæ¯”è¾ƒé‡è¦çš„å°±æ˜¯è®© M ä¸ P è§£ç»‘ï¼Œä½¿å¾—å…¶ä»– M å¯ä»¥è·å–åˆ°è¯¥ P å¹¶æ‰§è¡Œ Gã€‚ å› æ­¤ï¼ŒP ä»£è¡¨çš„æ˜¯å¹¶å‘æ•°ï¼Œè€Œä¸æ˜¯çº¿ç¨‹æ•°ã€‚ 4.4.2 ç³»ç»Ÿè°ƒç”¨åçš„æ¢å¤ ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼Œæ‰§è¡Œ exitsyscall() è¿›è¡Œæ¢å¤æ“ä½œã€‚ func exitsyscall() { _g_ := getg() // M å°è¯•ç»‘å®šé˜»å¡å‰ä½¿ç”¨çš„ Pï¼Œæˆ–è€…ä¸€ä¸ªæ–°çš„ P Â oldp := _g_.m.oldp.ptr() _g_.m.oldp = 0 if exitsyscallfast(oldp) { _g_.m.p.ptr().syscalltick++ casgstatus(_g_, _Gsyscall, _Grunning) ... return } // M è§£ç»‘ Gï¼Œé‡æ–°è¿›å…¥è°ƒç”¨å¾ªç¯ Â mcall(exitsyscall0) _g_.m.p.ptr().syscalltick++ _g_.throwsplit = false } M å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„ Pï¼Œä»ä¸¤ä¸ªåœ°æ–¹ï¼š å¦‚æœ m.oldp è¿˜æ˜¯ä¸º _Psyscall çŠ¶æ€ï¼Œè¯´æ˜æ²¡è¢«äººä½¿ç”¨ï¼Œé‚£ä¹ˆè®°å½•ä½¿ç”¨é˜»å¡å‰çš„ Pï¼› ä»å…¨å±€ç©ºé—² P sched.pidle é“¾è¡¨ä¸­è·å–ä¸€ä¸ª Pï¼› å¦‚æœæ²¡æœ‰ Pï¼Œé‚£ä¹ˆç¡®å® M æ— æ³•æ‰§è¡Œå½“å‰ Gï¼Œå°± M è§£ç»‘ Gï¼Œå°† G æ”¾å…¥å…¨å±€é˜Ÿåˆ—ï¼› æ— è®ºå¦‚ä½•ï¼Œæœ€å M éƒ½ä¼šè°ƒç”¨ schedule() é‡å¯è¿›å…¥è°ƒåº¦å¾ªç¯ï¼Œåˆ‡æ¢ä¸€ä¸ª G æ‰§è¡Œã€‚ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:4:4","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.5 æŠ¢å  æ¯ä¸ªè¿è¡Œä¸­çš„ G ä¼šæœ‰ä¸€ä¸ªè¿è¡Œçš„æ—¶é—´ç‰‡ï¼Œè€Œ sysmon ä¼šå‘¨æœŸæ€§æ£€æŸ¥éƒ¨åˆ† Gï¼Œå¦‚æœå…¶æ‰§è¡Œæ—¶é—´å¤§äº 10msï¼Œå°±ä¼šè§¦å‘æŠ¢å ã€‚ æŠ¢å åŒ…æ‹¬ä¸¤ç§æ–¹å¼ï¼š æŠ¢å æ ‡å¿—ï¼šé€šè¿‡è®¾ç½® g.stackguard0=stackPreemptã€‚è¿™å¿…ç„¶ä¼šå¯¼è‡´ G æ‰§è¡Œä¸‹æ¬¡å‡½æ•°è°ƒç”¨æ—¶è§¦å‘æ ˆæ‰©å®¹é€»è¾‘ï¼Œä»è€Œèµ°åˆ°åˆ‡æ¢è°ƒåº¦çš„é€»è¾‘ï¼› ä¿¡å·æŠ¢å ï¼ˆv1.14ï¼‰ï¼šä¿¡å·æŠ¢å ä¼šä½¿å¾— M çº¿ç¨‹è§¦å‘ä¿¡å·ä¸­æ–­ï¼Œæ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œä»è€Œé‡æ–°è¿›å…¥è°ƒåº¦å¾ªç¯ã€‚ 4.5.1 è§¦å‘æŠ¢å æ—¶æœº sysmon ä¼šé‡å¯æ‰§è¡Œ retake() å‡½æ•°ï¼Œåˆ¤æ–­å“ªäº›æ­£åœ¨è¿è¡Œçš„ G æ˜¯éœ€è¦æŠ¢å çš„ã€‚ func retake(now int64) uint32 { n := 0 // Prevent allp slice changes. This lock will be completely Â // uncontended unless we're already stopping the world. Â lock(\u0026allpLock) // éå†æ‰€æœ‰ P Â for i := 0; i \u003c len(allp); i++ { _p_ := allp[i] pd := \u0026_p_.sysmontick s := _p_.status sysretake := false // å…è®¸æŠ¢å  _Prunning ä¸ _Psyscall çŠ¶æ€çš„ P Â if s == _Prunning || s == _Psyscall { t := int64(_p_.schedtick) if int64(pd.schedtick) != t { pd.schedtick = uint32(t) pd.schedwhen = now } else if pd.schedwhen+forcePreemptNS \u003c= now { // åˆ°è¾¾æŠ¢å æ—¶é—´ Â preemptone(_p_) // In case of syscall, preemptone() doesn't Â // work, because there is no M wired to P. Â sysretake = true } } // å¯¹äº _Psyscallï¼Œå¯ä»¥è®©å…¶ä¸ M è§£ç»‘ï¼Œç­‰å…¶ä»–çš„ M ç»‘å®š Â if s == _Psyscall { t := int64(_p_.syscalltick) if !sysretake \u0026\u0026 int64(pd.syscalltick) != t { pd.syscalltick = uint32(t) pd.syscallwhen = now continue } if runqempty(_p_) \u0026\u0026 atomic.Load(\u0026sched.nmspinning)+atomic.Load(\u0026sched.npidle) \u003e 0 \u0026\u0026 pd.syscallwhen+10*1000*1000 \u003e now { continue } unlock(\u0026allpLock) incidlelocked(-1) if atomic.Cas(\u0026_p_.status, s, _Pidle) { n++ _p_.syscalltick++ handoffp(_p_) } incidlelocked(1) lock(\u0026allpLock) } } unlock(\u0026allpLock) return uint32(n) } è¿è¡Œä¸­çš„ G è¿è¡Œè¶…è¿‡ 10msï¼Œè°ƒç”¨ preemptone() è¿›è¡ŒæŠ¢å ï¼› å¯¹äº _Psyscall ä¸­çš„ Pï¼Œå°†å…¶è§£ç»‘ Mï¼Œä½¿å¾—å…¶ä»– M å¯ä»¥ç»‘å®šè¯¥ Pï¼› 4.5.2 è§¦å‘æŠ¢å  preemptone() è§¦å‘æŠ¢å ï¼Œé€šè¿‡ä¸Šé¢æ‰€è¿°çš„ä¸¤ç§æ–¹å¼ã€‚ func preemptone(_p_ *p) bool { mp := _p_.m.ptr() gp := mp.curg gp.preempt = true // è®¾ç½®æŠ¢å æ ‡å¿— Â // Every call in a go routine checks for stack overflow by Â // comparing the current stack pointer to gp-\u003estackguard0. Â // Setting gp-\u003estackguard0 to StackPreempt folds Â // preemption into the normal stack overflow check. Â gp.stackguard0 = stackPreempt // ä¿¡å·æŠ¢å  Â // Request an async preemption of this P. Â if preemptMSupported \u0026\u0026 debug.asyncpreemptoff == 0 { _p_.preempt = true preemptM(mp) } return true } è®¾ç½® G çš„æŠ¢å æ ‡å¿—ï¼Œgp.stackguard0 = stackPreemptï¼› æ‰§è¡Œ preemptM() è¿›è¡Œä¿¡å·æŠ¢å ï¼› 4.5.3 é€šè¿‡æŠ¢å æ ‡å¿—æŠ¢å  å‰é¢çœ‹åˆ°ï¼Œè®¾ç½® gp.stackguard0 = stackPreemptï¼Œè€Œè¿™åœ¨æ¯æ¬¡ G å‡½æ•°è°ƒç”¨å‰çš„æ£€æŸ¥æ˜¯å¦æ‰©å®¹æ ˆæ—¶ï¼Œå¿…ç„¶ä¼šè§¦å‘ G æ ˆæ‰©å®¹é€»è¾‘ newstack()ã€‚ è€Œåœ¨ å†…å­˜ç®¡ç† æ—¶ï¼Œä»‹ç»äº† newstack() å¦‚æœæ‰©å®¹ G çš„æ ˆï¼Œä½†æ˜¯çœç•¥äº†ä¸€ä¸ªé‡è¦çš„é€»è¾‘åˆ†æ”¯ï¼šnewstack() å‡½æ•°ä¸­è¿˜ä¼šè¿›è¡Œ G çš„è°ƒåº¦ï¼š func newstack() { thisg := getg() gp := thisg.m.curg // â€¦ Â preempt := atomic.Loaduintptr(\u0026gp.stackguard0) == stackPreempt // ç‰¹æ®Šæƒ…å†µä¸‹ä¸èƒ½æŠ¢å æ—¶ï¼Œç»§ç»­èµ° G ä»£ç é€»è¾‘ Â if preempt { if !canPreemptM(thisg.m) { // Let the goroutine keep running for now. Â // gp-\u003epreempt is set, so it will be preempted next time. Â gp.stackguard0 = gp.stack.lo + _StackGuard gogo(\u0026gp.sched) // never return Â } // â€¦ Â if preempt { if gp == thisg.m.g0 { throw(\"runtime: preempt g0\") } if thisg.m.p == 0 \u0026\u0026 thisg.m.locks == 0 { throw(\"runtime: g is running but p is not\") } if gp.preemptShrink { // We're at a synchronous safe point now, so Â // do the pending stack shrink. Â gp.preemptShrink = false shrinkstack(gp) } if gp.preemptStop { preemptPark(gp) // never returns Â } // Act like goroutine called runtime.Gosched. Â gopreempt_m(gp) // never return Â } // â€¦ } func gopreempt_m(gp *g) { // è€æœ‹å‹äº† Â goschedImpl(gp) } åˆ¤æ–­åˆ° gp.stackguard0 = stackPreempt åï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šèµ°é‡æ–°è°ƒåº¦çš„é€»è¾‘ï¼ŒM é‡æ–°è¿›å…¥è°ƒåº¦å¾ªç¯ã€‚ 4.5.4 ä¿¡å·æŠ¢å  æ‰§è¡Œ preemptM() ä¼šå¯¹ M è¿›è¡Œä¿¡å·æŠ¢å ï¼Œé€šè¿‡å‘é€ SIGURG ä¿¡å·è§¦å‘ M çº¿ç¨‹çš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚ const sigPreempt = _SIGURG func preemptM(mp *m) { if GOOS == \"darwin\" \u0026\u0026 GOARCH == \"arm64\" \u0026\u0026 !iscgo { return } if atomic.Cas(\u0026mp.signalPending, 0, 1) { if GOOS == \"darwin\" { atomic.Xadd(\u0026pendingPreemptSignals, 1) } // If multiple threads are preempting the same M, it may send many Â // signals to the same M such that it hardly make progress, causing Â // live-lock problem. Apparently this could happen on darwin. See Â // issue #37741. Â // Only send a signal if there isn't already one pending. Â signalM(mp, sigPreempt) } } M ä¼šæ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•° asyncPreempt()ï¼Œæœ€åè°ƒç”¨åˆ° asyncPreempt2()ï¼Œä½¿å¾— M è¿›å…¥é‡æ–°è°ƒåº¦ï¼š // asyncPreempt saves all user registers and calls asyncPreempt2. // // When stack scanning encounters an asyncPreempt frame","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:4:5","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"æ€»ç»“ ç›¸å¯¹äº å†…å­˜ç®¡ç† ä¸ åƒåœ¾æ”¶é›†ï¼Œç«Ÿç„¶æ„Ÿè§‰å¹¶å‘è°ƒåº¦çš„ç»“æ„è¿˜ç®—ç®€å•ã€‚ éœ€è¦å¼„æ¸…æ¥šçš„æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š åç¨‹å‡ºç°çš„æ„ä¹‰ è°ƒåº¦å™¨çš„å·¥ä½œ GMP æ¨¡å‹æ•´ä½“æ¡†æ¶ Gã€Mã€P ä»£è¡¨çš„æ„ä¹‰ è°ƒåº¦å¾ªç¯çš„æµç¨‹ è¿›å…¥è°ƒåº¦å¾ªç¯ M çš„è¡Œä¸º æ‰¾å¯» G çš„å„ä¸ªé€”å¾„ M æ‰§è¡Œ G æ—¶ï¼Œå¦‚ä½•åˆ‡æ¢ä¸Šä¸‹æ–‡ å¦‚ä½•é€€å‡ºå›åˆ°è°ƒåº¦å¾ªç¯ è°ƒåº¦åˆ‡æ¢ åˆ‡æ¢çš„å„ä¸ªæ—¶æœº ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè°ƒåº¦åˆ‡æ¢çš„è¡Œä¸º æŠ¢å çš„ä¸¤ç§æ–¹å¼ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:5:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"å‚è€ƒ ã€ŠGolang å­¦ä¹ ç¬”è®°ã€‹ ã€ŠGolang è®¾è®¡ä¸å®ç°ã€‹ï¼šè°ƒåº¦å™¨ ","date":"2021-01-23","objectID":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/:6:0","tags":["Golang","Golang åŸç†"],"title":"Go å¹¶å‘è°ƒåº¦æ€»ç»“","uri":"/posts/language/golang/go-%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"Golang ä¸‰è‰²æ ‡è®°æ”¶é›†ç®—æ³•ï¼Œç®—æ³•å®ç°åŸç†","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹ Golang åƒåœ¾æ”¶é›†çš„ä¸€ä¸ªæ€»ç»“ï¼ŒåŸºæœ¬å†…å®¹æ¥æºäºç½‘ç»œçš„å­¦ä¹ ï¼Œä»¥åŠè‡ªå·±è§‚æ‘©äº†ä¸‹æºç ã€‚ æ‰€ä»¥å­¦ä¹ çš„ä¹¦ç±ä¸æ–‡ç« è§ å‚è€ƒã€‚ ä¸‹é¢ä»£ç éƒ½æ˜¯åŸºäº go 1.15.6ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:0:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1 èƒŒæ™¯çŸ¥è¯† ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:1:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.1 æœ¯è¯­ åƒåœ¾å›æ”¶ç®—æ³•æœ‰ä¸€äº›åŸºæœ¬çš„æœ¯è¯­ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“å¯¹åº”çš„å«ä¹‰ï¼š Mutatorï¼šå…·æœ‰â€œæ”¹å˜å¯¹è±¡â€çš„æ„æ€ï¼ŒGC ä¸­å°±æ˜¯æ”¹åŠ¨å¯¹è±¡é—´å¼•ç”¨å…³ç³»çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºï¼› å †ï¼šå¯¹è±¡ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼ŒGC å°±æ˜¯å°†åƒåœ¾å¯¹è±¡ç©ºé—´æ”¾å›åˆ°å †ä¸­ï¼› æ ¹å¯¹è±¡ï¼šå¯¹è±¡çš„æŒ‡é’ˆçš„â€œèµ·ç‚¹â€éƒ¨åˆ†ï¼Œä¸€èˆ¬å°±æ˜¯å…¨å±€å¯¹è±¡å’Œæ ˆå¯¹è±¡ï¼› ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:1:1","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.2 ä¸‰è‰²æ ‡è®°ç®—æ³• ä¸‰è‰²æ ‡è®°ç®—æ³•æ˜¯ GC æ ‡è®°æ¸…é™¤ç®—æ³•Mark-Sweep çš„ä¸€ç§ï¼Œä¹Ÿæ˜¯ Golang ä¸­ä½¿ç”¨çš„ç®—æ³•ã€‚ æ¨èé˜…è¯» æ¨èé˜…è¯»æ–‡ç« ï¼Œå†™çš„éå¸¸è¯¦ç»†ï¼šåƒåœ¾æ”¶é›†å™¨ é¦–å…ˆï¼Œä¸‰è‰²æ ‡è®°ç®—æ³•çš„æœ€åŸºæœ¬é€»è¾‘ä¸ºï¼š æ ‡è®°çš„æœ€å¼€å§‹ï¼Œæ‰€æœ‰å¯¹è±¡é»˜è®¤ä¸ºç™½è‰²ï¼› å°† æ ¹å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œæ”¾å…¥ç°è‰²é›†åˆï¼› ä» ç°è‰²é›†åˆ ä¸­å–å‡ºç°è‰²å¯¹è±¡ï¼Œå°†å…¶å­å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼ŒåŠ å…¥ç°è‰²é›†åˆï¼Œè¯¥ç°è‰²å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²ï¼› é‡å¤ç¬¬ 3 æ­¥ï¼Œç›´åˆ°ç°è‰²é›†åˆä¸ºç©ºï¼› æ¸…ç†æ‰€æœ‰çš„ç™½è‰²å¯¹è±¡ï¼› æ•´ä¸ªé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªæ ‘çš„å±‚æ¬¡éå†ï¼Œå°†æ‰€æœ‰å¯è¾¾çš„ç»“ç‚¹æ ‡è®°ï¼Œç„¶åæ¸…ç†æœªæ ‡è®°çš„ä¸å¯è¾¾ç»“ç‚¹ã€‚ ä½†æ˜¯ï¼Œä»…ä»…æ˜¯æ™®é€šçš„ä¸‰è‰²æ ‡è®°ç®—æ³•è¦æ±‚æ‰§è¡Œæ—¶ï¼ŒMutator ä¸èƒ½åŒæ—¶è¿è¡Œã€‚å› ä¸ºå¦‚æœ Mutator å¹¶è¡Œæ—¶ï¼ŒæŸä¸ªæ‰«æè¿‡çš„ç»“ç‚¹çš„å¼•ç”¨å…³ç³»å˜åŒ–ï¼Œå°±å¯èƒ½å¯¼è‡´ æ‚¬æŒ‚æŒ‡é’ˆdangling pointer é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œä¸Šå›¾ä¸­ç¬¬ 3 æ­¥å°† A æŒ‡å‘ Dï¼Œé‚£ä¹ˆ D è¿˜æ˜¯æ— æ³•è¢«æ ‡è®°ï¼Œè¢«é”™è¯¯å›æ”¶ã€‚ è€Œæƒ³è¦è®© Mutator åŒæ—¶è¿è¡Œæ—¶ï¼Œæ ‡è®°çš„ç»“æœè¿˜ä¿æŒæ­£ç¡®ï¼Œé‚£ä¹ˆæ¯ä¸ªæ—¶åˆ»æ ‡è®°çš„ç»“æœè¦æ»¡è¶³ ä¸‰è‰²ä¸å˜æ€§Tri-color invariant å¼ºä¸‰è‰²ä¸å˜æ€§ï¼šé»‘è‰²å¯¹è±¡ä¸ä¼šæŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåªä¼šæŒ‡å‘ç°è‰²å¯¹è±¡æˆ–è€…é»‘è‰²å¯¹è±¡ã€‚ å› ä¸ºé»‘è‰²å¯¹è±¡ä¸ä¼šå†è¢«æ‰«æï¼Œå¦‚æœé»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œé‚£ä¹ˆè‚¯å®šè¯¥ç™½è‰²å¯¹è±¡ä¼šè¢«é”™è¯¯å›æ”¶ã€‚ å½“ç„¶ï¼Œé™¤éè¿™ç§æƒ…å†µèƒ½å¤Ÿæ»¡è¶³å¼±ä¸‰è‰²ä¸å˜æ€§ã€‚ å¼±ä¸‰è‰²ä¸å˜æ€§ï¼šé»‘è‰²å¯¹è±¡æ‰§è¡Œç™½è‰²å¯¹è±¡ï¼Œé‚£ä¹ˆå¿…é¡»åŒ…å«ä¸€æ¡ç°è‰²å¯¹è±¡ç»ç”±å¤šä¸ªç™½è‰²å¯¹è±¡çš„å¯è¾¾è·¯å¾„ã€‚ å› ä¸ºæœ‰äº†åé¢è¿™ä¸ªå¯è¾¾è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯è¯´ç™½è‰²å¯¹è±¡è¿˜æ˜¯å¯ä»¥è¢«æ ‡è®°çš„ï¼Œé‚£ä¹ˆé»‘è‰²å¯¹è±¡å¯ä»¥æŒ‡å‘è¯¥ç™½è‰²å¯¹è±¡ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:1:2","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1.3 å±éšœæŠ€æœ¯ ä¸ºäº†æ»¡è¶³ä¸¤ä¸ªä¸å˜æ€§ï¼Œæ‰€ä»¥è¦åœ¨å¯¹è±¡å¼•ç”¨å˜æ›´æ—¶ï¼Œåšå‡ºä¸€äº›æ“ä½œæ”¹å˜å¯¹è±¡æ ‡è®°ã€‚è¿™å°±æ˜¯ GC é‡Œ å±éšœæŠ€æœ¯barrier çš„ä½œç”¨ã€‚ Go ä¸­ä½¿ç”¨äº†å†™å±éšœï¼Œå³åœ¨ç”¨æˆ·ç¨‹åºæ›´æ–°å¯¹è±¡æŒ‡é’ˆæ—¶ï¼Œæ‰§è¡Œä¸€äº›ä»£ç ï¼Œä½¿å¾—ç»§ç»­æ»¡è¶³ä¸å˜æ€§ã€‚ Note è¿™é‡Œçš„å±éšœæŠ€æœ¯ä¼¼ä¹å’Œæˆ‘çŸ¥é“çš„ CPU çš„å±éšœæŠ€æœ¯å«ä¹‰ä¸å¤ªç±»ä¼¼ï¼Œæ›´åƒæ˜¯å›è°ƒå‡½æ•°ï¼Œä¹ŸæŒºå›°æƒ‘ 1.3.1 æ’å…¥å†™å±éšœ Dijkstra æå‡ºçš„ æ’å…¥å†™å±éšœï¼Œåœ¨æ›´æ–°å¯¹è±¡æŒ‡é’ˆæ—¶ï¼Œå°†å…¶è¢«æŒ‡å‘çš„å¯¹è±¡é‡æ–°åŠ å…¥æ‰«æé›†åˆï¼ˆä¸‰è‰²æ ‡è®°ä¸­ä¹Ÿå°±æ˜¯å˜ä¸ºç°è‰²ï¼‰ï¼Œè¿™æ ·æ¥ä¸‹æ¥è¿˜æ˜¯èƒ½å¤Ÿè¢«æ‰«æã€‚ å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ ·é»‘è‰²å¯¹è±¡å§‹ç»ˆæŒ‡å‘çš„æ˜¯ç°è‰²å¯¹è±¡ï¼Œæ°¸è¿œéƒ½ä¼šæ»¡è¶³å¼ºä¸‰è‰²ä¸å˜æ€§ã€‚ ä½†æ˜¯ï¼ŒDijkstra ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š å¯¹è±¡æŒ‡é’ˆå˜åŠ¨æ—¶ï¼Œæ²¡æœ‰è€ƒè™‘æ—§çš„æŒ‡é’ˆå¼•ç”¨ã€‚ä¾‹å¦‚ *field åŸæ¥çš„å¯¹è±¡ oldobj å·²ç»æ‰«ææˆé»‘è‰²äº†ï¼Œé‚£ä¹ˆ *field = newobj å˜åŠ¨åï¼Œå¯èƒ½ oldobj å˜ä¸ºåƒåœ¾å¯¹è±¡ï¼Œåªæœ‰ç­‰åˆ°ä¸‹ä¸€è½®æ ‡è®°æ—¶æ‰ä¼šè¢«å›æ”¶ã€‚ TODO 1.3.2 åˆ é™¤å†™å±éšœ Yuasa æå‡ºçš„ åˆ é™¤å†™å±éšœï¼Œè®©è€å¯¹è±¡çš„å¼•ç”¨è¢«åˆ é™¤æ—¶ï¼Œå°†ç™½è‰²çš„è€å¯¹è±¡æ¶‚æˆç°è‰²ï¼Œè¿™æ ·åˆ é™¤å†™å±éšœå°±å¯ä»¥ä¿è¯å¼±ä¸‰è‰²ä¸å˜æ€§ã€‚ 1.3.3 Go ä¸­çš„å±éšœ Go ä¸­ä½¿ç”¨ æ··åˆå†™å±éšœï¼Œå³æ’å…¥å†™å±éšœä¸åˆ é™¤å†™å±éšœéƒ½å¼€å¯ï¼Œå¹¶ä¸”åœ¨æ ‡è®°é˜¶æ®µå¼€å§‹åï¼Œå°†åˆ›å»ºçš„æ‰€æœ‰æ–°å¯¹è±¡éƒ½æ ‡è®°ä¸ºé»‘è‰²ï¼Œé˜²æ­¢æ–°åˆ†é…çš„å¯¹è±¡è¢«é”™è¯¯çš„å›æ”¶ã€‚ å…·ä½“æ“ä½œä¸ºï¼š GC å¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸ºé»‘è‰²ï¼ˆä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€ STW)ï¼Œ GC æœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²ã€‚ è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:1:3","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2 ä¸‰è‰²æ ‡è®°ç®—æ³•å®ç° æˆ‘ä»¬å…ˆä¸çœ‹æ•´ä¸ªçš„æµç¨‹å®ç°ï¼Œè€Œæ˜¯ä»æ ¸å¿ƒçš„æ ‡è®°ç®—æ³•å…¥æ‰‹ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:2:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.1 æ ‡è®° 2.1.1 å¹¶å‘æ ‡è®°æ¡†æ¶ runtime ä½¿ç”¨å¹¶å‘çš„æ ‡è®°æ–¹å¼ï¼Œå¤šä¸ª groutine åŒæ—¶æ‰§è¡Œä¸€éƒ¨åˆ†å†…å­˜çš„æ ‡è®°æ“ä½œã€‚å…¶æ•´ä¸ªå°±æ˜¯åŸºäºä¸€ä¸ªå·¥ä½œæ± æ¡†æ¶ã€‚ é¦–å…ˆï¼Œæœ‰ç€ä¸€ä¸ªå…¨å±€çš„å·¥ä½œé˜Ÿåˆ—ï¼Œå…¶æ”¾åœ¨ work å…¨å±€å˜é‡ä¸­ï¼š var work struct { full lfstack // lock-free list of full blocks workbuf empty lfstack // lock-free list of empty blocks workbuf } fullï¼šå…¨å±€çš„éç©ºçš„é˜Ÿåˆ—ç»„æˆçš„é“¾è¡¨ï¼Œå•ä¸ª groutine æ²¡æœ‰ä»»åŠ¡æ—¶å°±ä»è¿™é‡Œå–ä¸€ä¸ªé˜Ÿåˆ—ä½¿ç”¨ï¼› emptyï¼šå…¨å±€çš„ç©ºçš„é˜Ÿåˆ—ç»„æˆçš„é“¾è¡¨ï¼Œå•ä¸ª groutine çš„å·¥ä½œé˜Ÿåˆ—æ»¡æ—¶å°±ä¼šè¿™é‡Œå»ä¸€ä¸ªé˜Ÿåˆ—åˆ‡æ¢ï¼› æ¯ä¸ª goroutine æœ‰ç€ç‹¬ç«‹å¯¹åº”çš„ gcWork å¯¹è±¡ï¼Œå…¶ç±»ä¼¼ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºéœ€è¦æ‰«æçš„å†…å­˜çš„åœ°å€ã€‚ type workbuf struct { workbufhdr obj [(_WorkbufSize - unsafe.Sizeof(workbufhdr{})) / sys.PtrSize]uintptr } type gcWork struct { // wbuf1 and wbuf2 are the primary and secondary work buffers. Â // Â // This can be thought of as a stack of both work buffers' Â // pointers concatenated. When we pop the last pointer, we Â // shift the stack up by one work buffer by bringing in a new Â // full buffer and discarding an empty one. When we fill both Â // buffers, we shift the stack down by one work buffer by Â // bringing in a new empty buffer and discarding a full one. Â // This way we have one buffer's worth of hysteresis, which Â // amortizes the cost of getting or putting a work buffer over Â // at least one buffer of work and reduces contention on the Â // global work lists. Â // Â // wbuf1 is always the buffer we're currently pushing to and Â // popping from and wbuf2 is the buffer that will be discarded Â // next. Â // Â // Invariant: Both wbuf1 and wbuf2 are nil or neither are. Â wbuf1, wbuf2 *workbuf â€¦ } wbuf1 ä¸ wbuf2: å°±æ˜¯ä¸»é˜Ÿåˆ—ä¸å¤‡é˜Ÿåˆ—ã€‚æ‰€æœ‰æ“ä½œéƒ½ä¼šå…ˆæ“ä½œ wbuf1ï¼Œå¦‚æœ wbuf1 ç©ºé—´ä¸è¶³æˆ–è€…æ²¡æœ‰å¯¹è±¡ï¼Œå°±ä¼šè§¦å‘ wbuf1 ä¸ wbuf2 åˆ‡æ¢ã€‚å½“ä¸¤ä¸ªç¼“å†²åŒºéƒ½ç©ºé—´ä¸è¶³æˆ–è€…æ»¡æ—¶ï¼Œå°±ä¼šä» work.free æˆ–è€… work.list å¾—åˆ°ä¸€ä¸ªç©ºé—²çš„ï¼Œå¹¶èµ‹å€¼ wbuf1ã€‚ gcWork æœ‰å‡ ä¸ªé‡è¦çš„æ–¹æ³•ï¼š gcWork.tryGetFast() ï¼šä» wbuf1 å¿«é€Ÿå¾—åˆ°ä¸€ä¸ª obj çš„åœ°å€ï¼› gcWork.tryGet() ï¼šä» wbuf1 -\u003e wbuf2 -\u003e work.full è·å–ä¸€ä¸ª objï¼› gcWork.putFast() ï¼šå°†ä¸€ä¸ªå¾…æ‰«æçš„ obj æ”¾å…¥ wbuf1ï¼› gcWork.put() ï¼šå°†ä¸€ä¸ªå¾…æ‰«æçš„ obj æ”¾å…¥ wbuf1 -\u003e wbuf2 -\u003e work.emptyï¼› gcWork.balance() ï¼šå°† wbuf2/wbuf1 æ”¾å…¥ work.full ä¸­ï¼› gcWork.empty() ï¼šåˆ¤æ–­æ˜¯å¦ gcWork ä¸ºç©ºï¼Œä¸ºç©ºè¡¨æ˜æ²¡æœ‰ä¼šç°è‰² objï¼› å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯å›´ç»•äº†å„ä¸ªå·¥ä½œé˜Ÿåˆ—çš„ç”Ÿäº§-æ¶ˆè´¹è¿‡ç¨‹ã€‚å…ˆä»æ ¹å¯¹è±¡å¼€å§‹ï¼Œgoroutine ä» gcWork å–å‡ºå¾…æ‰«æçš„ objï¼Œå°†å…¶æ ‡è®°ï¼Œç„¶åå°† obj æŒ‡å‘çš„å­ obj å†æ¬¡æ”¾å…¥ gcWorkã€‚ä¸æ–­å¾ªç¯ï¼Œç›´åˆ° gcWork ä¸ºç©ºã€‚ 2.1.2 groutine æ ‡è®°æµç¨‹ ä¸‹é¢çœ‹ä¸‹æ ¸å¿ƒçš„æ ‡è®°æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…ä»…å…³æ³¨ä¸€ä¸ª groutine çš„å·¥ä½œã€‚å¤§è‡´çš„æ ‡è®°æ­¥éª¤å¦‚ä¸‹ï¼š å°†æ ¹å¯¹è±¡æ”¾å…¥ gcWorkï¼› groutine ä» gcWork å–å‡ºä¸€ä¸ª object åœ°å€ï¼Œå°†å…¶æ ‡è®°ï¼› å°† object åŒ…å«çš„æŒ‡é’ˆæŒ‡å‘çš„ object å†æ¬¡æ”¾å…¥ gcWorkï¼› é‡å¤ 2-3 æ­¥ï¼Œç›´åˆ° gcWork ä¸ºç©ºï¼› è€Œå¯¹åº”äºä¸‰è‰²æ ‡è®°ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤ä¸åŒé¢œè‰²çš„å¯¹è±¡åœ¨ runtime ä¸­çš„å¯¹åº”ï¼š ç°è‰²å¯¹è±¡ -\u003e gcWork ä¸­çš„ objectï¼› é»‘è‰²å¯¹è±¡ -\u003e ä¸åœ¨ gcWork ä¸­ï¼Œä½†æ˜¯è¢« mark çš„ objectï¼› ç™½è‰²å¯¹è±¡ -\u003e ä¸åœ¨ gcWork ä¸­ï¼Œæ²¡æœ‰è¢« mark çš„ objectï¼› æ¯ä¸ª P ä¼šå¯¹åº”ä¸€ä¸ªæ ‡è®°ä½¿ç”¨çš„ groutineï¼Œæ‰§è¡Œ gcDrain() å‡½æ•°ï¼ˆruntime/mgcmark.goï¼‰ï¼š // gcDrain scans roots and objects in work buffers, blackening grey // objects until it is unable to get more work. It may return before // GC is done; it's the caller's responsibility to balance work from // other Ps. // // If flags\u0026gcDrainUntilPreempt != 0, gcDrain returns when g.preempt // is set. // // If flags\u0026gcDrainIdle != 0, gcDrain returns when there is other work // to do. // // If flags\u0026gcDrainFractional != 0, gcDrain self-preempts when // pollFractionalWorkerExit() returns true. This implies // gcDrainNoBlock. // // If flags\u0026gcDrainFlushBgCredit != 0, gcDrain flushes scan work // credit to gcController.bgScanCredit every gcCreditSlack units of // scan work. // // gcDrain will always return if there is a pending STW. // //go:nowritebarrier func gcDrain(gcw *gcWork, flags gcDrainFlags) { gp := getg().m.curg preemptible := flags\u0026gcDrainUntilPreempt != 0 flushBgCredit := flags\u0026gcDrainFlushBgCredit != 0 idle := flags\u0026gcDrainIdle != 0 initScanWork := gcw.scanWork // é…ç½®é€€å‡ºæ ‡è®°çš„ check å‡½æ•°ï¼Œæ ¹æ®ä¸åŒç­–ç•¥é€€å‡ºæ ‡è®° Â checkWork := int64(1\u003c\u003c63 - 1) var check func() bool if flags\u0026(gcDrainIdle|gcDrainFractional) != 0 { checkWork = initScanWork + drainCheckThreshold if idle { check = pollWork } else if flags\u0026gcDrainFractional != 0 { check = pollFractionalWorkerExit } } // æ‰«ææ ¹å¯¹è±¡æ”¾å…¥ gcWork Â if work.markrootNext \u003c work.markrootJobs { // Stop if we're preemptible or if someone wants to STW. Â for !(gp.preempt \u0026\u0026 (preemptible || atomic.Load(\u0026sched.gcwaiting) != 0)) { job := atomic.Xadd(\u0026work.markrootNext, +1) - 1 if job \u003e= work.markrootJobs { break } markroot(gcw, job) if check != nil \u0026\u0026 check() { goto done } } } // æ ‡è®°å¾ªç¯ Â for !(gp.preem","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:2:1","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.2 å†™å±éšœ åœ¨å„ä¸ªä»£ç çš„æ³¨é‡Šä¸­ï¼Œå¯ä»¥çœ‹åˆ° â€œ//go:nowritebarrierâ€ã€‚æ˜¾ç„¶ï¼Œè¿™æ ·è®©ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ä¸åŠ å…¥å†™å±éšœçš„æ„æ€ï¼Œå› æ­¤å¯ä»¥æƒ³åˆ°ï¼Œé»˜è®¤çš„å‡½æ•°æ‰§è¡Œéƒ½ä¼šåŠ å…¥å†™å±éšœçš„é€»è¾‘ã€‚ åœ¨ SSA ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šåœ¨ Storeã€Moveã€Zero æ“ä½œä¸­åŠ å…¥å†™å±éšœï¼Œå†™å±éšœå‡½æ•°ä¸º writebarrier() å‡½æ•°ï¼ˆcmd/compile/internal/ssa/writebarrier.goï¼‰ã€‚ writebarrier() å‡½æ•°å¾ˆå¤æ‚ï¼Œè¿™é‡Œä¸å±•å¼€ã€‚å†æ¬¡çœ‹ä¸€ä¸‹æ··åˆå†™å±éšœæ“ä½œï¼š GC å¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸ºé»‘è‰²ï¼ˆä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€ STW)ã€‚ GC æœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²ã€‚ è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ å½“å¼€å§‹ GC æ—¶ï¼Œå…¨å±€å˜é‡ runtime.writeBarrier.enabled å˜ä¸º trueï¼Œæ‰€æœ‰çš„å†™æ“ä½œéƒ½ä¼šç»è¿‡ writebarrier() çš„æ“ä½œã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:2:2","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3 å†…å­˜æ¸…ç† å†…å­˜æ¸…ç†ä¸æ ‡è®°å°±æ˜¯å®Œå…¨åˆ†éš”çš„é€»è¾‘äº†ï¼Œé€šè¿‡åˆ¤æ–­å¯¹è±¡æ˜¯å¦è¢«æ ‡è®°å°±å¯å†³å®šæ˜¯å¦å°†å…¶å†…å­˜å›æ”¶ã€‚ gcSweep() å‡½æ•°ç”¨äºåœ¨ GC æ ‡è®°ç»“æŸåæ‰§è¡Œæ¸…ç†ï¼ˆsrc/runtime/mgc.goï¼‰ï¼š // gcSweep must be called on the system stack because it acquires the heap // lock. See mheap for details. // // The world must be stopped. // //go:systemstack func gcSweep(mode gcMode) { lock(\u0026mheap_.lock) // å…³é”®çš„ sweepgen å˜é‡ Â mheap_.sweepgen += 2 mheap_.sweepdone = 0 if !go115NewMCentralImpl \u0026\u0026 mheap_.sweepSpans[mheap_.sweepgen/2%2].index != 0 { // We should have drained this list during the last Â // sweep phase. We certainly need to start this phase Â // with an empty swept list. Â throw(\"non-empty swept list\") } mheap_.pagesSwept = 0 mheap_.sweepArenas = mheap_.allArenas mheap_.reclaimIndex = 0 mheap_.reclaimCredit = 0 unlock(\u0026mheap_.lock) if go115NewMCentralImpl { sweep.centralIndex.clear() } // é˜»å¡æ¸…ç† Â if !_ConcurrentSweep || mode == gcForceBlockMode { // Special case synchronous sweep. Â // Record that no proportional sweeping has to happen. Â lock(\u0026mheap_.lock) mheap_.sweepPagesPerByte = 0 unlock(\u0026mheap_.lock) // æ¸…ç† span ! Â // Sweep all spans eagerly. Â for sweepone() != ^uintptr(0) { sweep.npausesweep++ } // Free workbufs eagerly. Â prepareFreeWorkbufs() for freeSomeWbufs(false) { } // All \"free\" events for this mark/sweep cycle have Â // now happened, so we can make this profile cycle Â // available immediately. Â mProf_NextCycle() mProf_Flush() return } // åå°æ¸…ç†ï¼ˆå¹¶å‘æ¸…ç†ï¼‰ Â // Background sweep. Â lock(\u0026sweep.lock) if sweep.parked { sweep.parked = false ready(sweep.g, 0, true) } unlock(\u0026sweep.lock) } ä¸æ–­æ‰§è¡Œ sweepone() æ¥æ¸…ç† mspanï¼› å¯åŠ¨åå°å¹¶å‘æ¸…ç†ï¼› ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:3:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.1 é˜»å¡æ¸…ç† é€šè¿‡ä¸æ–­æ‰§è¡Œ sweepone() æ¥è¿›è¡Œ mspan çš„æ¸…ç†ï¼Œsweepone() ä» heap å¾—åˆ°ä¸€ä¸ª mspan å¹¶æ¸…ç†ï¼ˆsrc/runtime/mgcsweep.goï¼‰ï¼š // sweepone sweeps some unswept heap span and returns the number of pages returned // to the heap, or ^uintptr(0) if there was nothing to sweep. func sweepone() uintptr { â€¦ // å¾—åˆ°ä¸€ä¸ªè¢«æ¸…ç†çš„ mspan var s *mspan sg := mheap_.sweepgen for { if go115NewMCentralImpl { s = mheap_.nextSpanForSweep() } else { s = mheap_.sweepSpans[1-sg/2%2].pop() } if s == nil { atomic.Store(\u0026mheap_.sweepdone, 1) break } // è®¾ç½®æ ‡è®° if s.sweepgen == sg-2 \u0026\u0026 atomic.Cas(\u0026s.sweepgen, sg-2, sg-1) { break } } // æ¸…ç† mspan npages := ^uintptr(0) if s != nil { npages = s.npages if s.sweep(false) { // Whole span was freed. Count it toward the // page reclaimer credit since these pages can // now be used for span allocation. atomic.Xadduintptr(\u0026mheap_.reclaimCredit, npages) } else { // Span is still in-use, so this returned no // pages to the heap and the span needs to // move to the swept in-use list. npages = 0 } } â€¦ return npages } æœ€ç»ˆçš„å›æ”¶å·¥ä½œé  mspan.sweep() å®Œæˆï¼Œè¿™ç»™åœ¨ Go å†…å­˜ç®¡ç†æ€»ç»“ ä¸­å¯ä»¥çœ‹åˆ°å…·ä½“å®ç°ï¼Œå¤§è‡´å°±æ˜¯å°† GC åæ²¡æœ‰è¢« mark çš„ object è®°å½•ä¸ºå¯ç”¨ï¼Œä»¥åç»­ç”³è¯·ä½¿ç”¨è¦†ç›–ã€‚å¦‚æœæ•´ä¸ª mspan å˜å›ç©ºï¼Œå°±ç”± mheap å›æ”¶å…¶å¯¹åº”çš„ pageã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:3:1","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.2 å¹¶å‘æ¸…ç† å¹¶å‘æ¸…ç†å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¢«å”¤é†’åå¼€å§‹æ‰§è¡Œæ¸…ç†ä»»åŠ¡ã€‚ func bgsweep(c chan int) { sweep.g = getg() lockInit(\u0026sweep.lock, lockRankSweep) lock(\u0026sweep.lock) sweep.parked = true c \u003c- 1 goparkunlock(\u0026sweep.lock, waitReasonGCSweepWait, traceEvGoBlock, 1) for { // ä¾æ—§é€šè¿‡ sweepone() æ¸…ç† for sweepone() != ^uintptr(0) { sweep.nbgsweep++ Gosched() } for freeSomeWbufs(true) { Gosched() } lock(\u0026sweep.lock) if !isSweepDone() { // This can happen if a GC runs between // gosweepone returning ^0 above // and the lock being acquired. unlock(\u0026sweep.lock) continue } // ç­‰å¾…å”¤é†’ sweep.parked = true goparkunlock(\u0026sweep.lock, waitReasonGCSweepWait, traceEvGoBlock, 1) } } ä¾æ—§æ˜¯é€šè¿‡ä¸æ–­æ‰§è¡Œ sweepone() è¿›è¡Œæ¸…ç†ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:3:2","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4 æ ‡è®°æµç¨‹ ä¸‹é¢æ¥çœ‹å¦‚ä½•è§¦å‘çš„ GC ä»¥åŠ GC çš„å¤§è‡´æµç¨‹ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:4:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.1 GC è§¦å‘ GC æœ‰ä¸‰ä¸ªç‚¹ä¼šè¢«è§¦å‘ï¼š runtime å¯åŠ¨åä¼šå¯åŠ¨ä¸€ä¸ªåå° gourtineï¼Œè¢«å”¤é†’åå°±ä¼šæ‰§è¡Œ GCï¼Œè€Œå”¤é†’æ“ä½œç”± sysmon è´Ÿè´£æ‰§è¡Œã€‚ sysmon ä¼šæ ¹æ®ç³»ç»Ÿæƒ…å†µå†³å®šæ˜¯å¦è§¦å‘ã€‚ åˆ†é…æ–° object æ—¶ï¼ˆmallocgc() å‡½æ•°ï¼‰ï¼Œå¦‚æœ mcache éœ€è¦é‡æ–°åˆ·æ–°ï¼Œæˆ–è€…æ˜¯åˆ†é…çš„æ˜¯ large objectï¼Œé‚£ä¹ˆä¹Ÿä¼šè§¦å‘ä¸€æ¬¡ GCã€‚ é€šè¿‡æ¥å£ runtime.GC() ä¸»åŠ¨è§¦å‘ã€‚ æ‰€æœ‰çš„è§¦å‘éƒ½ä¼šä½¿ç”¨ gcTrigger.test() è¿›è¡Œæ¡ä»¶æ£€æµ‹ï¼ˆruntime/mgc.goï¼‰ï¼š // test reports whether the trigger condition is satisfied, meaning // that the exit condition for the _GCoff phase has been met. The exit // condition should be tested when allocating. func (t gcTrigger) test() bool { if !memstats.enablegc || panicking != 0 || gcphase != _GCoff { return false } switch t.kind { case gcTriggerHeap: // ç”± heap è§¦å‘ï¼Œä¹Ÿå°±æ˜¯åˆ†é… object æ—¶è§¦å‘ Â // Non-atomic access to heap_live for performance. If Â // we are going to trigger on this, this thread just Â // atomically wrote heap_live anyway and we'll see our Â // own write. Â return memstats.heap_live \u003e= memstats.gc_trigger case gcTriggerTime: // ç”± sysmon å‘¨æœŸæ€§è§¦å‘ Â if gcpercent \u003c 0 { return false } lastgc := int64(atomic.Load64(\u0026memstats.last_gc_nanotime)) return lastgc != 0 \u0026\u0026 t.now-lastgc \u003e forcegcperiod case gcTriggerCycle: // é€šè¿‡ runtime.GC() ä¸»åŠ¨è§¦å‘ Â // t.n \u003e work.cycles, but accounting for wraparound. Â return int32(t.n-work.cycles) \u003e 0 } return true } å¯¹åº”çš„æ¡ä»¶ä¸ºï¼š sysmon å‘¨æœŸæ€§è§¦å‘ï¼šè§¦å‘é—´éš”å¤§äº 2minï¼› åˆ†é… object è§¦å‘ï¼šå †å†…å­˜çš„åˆ†é…è¾¾åˆ°æ§åˆ¶è®¡ç®—çš„è§¦å‘å †å¤§å°ï¼› runtime.GC() ä¸»åŠ¨è§¦å‘ï¼šå½“å‰æ²¡æœ‰æ­£åœ¨ GCï¼Œåˆ™è§¦å‘ï¼› ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:4:1","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.2 GC å¼€å§‹ æ‰€æœ‰è§¦å‘ GC åè°ƒç”¨çš„éƒ½æ˜¯ gcStart() å‡½æ•°ï¼ˆruntime/mgc.goï¼‰ï¼š // gcStart starts the GC. It transitions from _GCoff to _GCmark (if // debug.gcstoptheworld == 0) or performs all of GC (if // debug.gcstoptheworld != 0). // // This may return without performing this transition in some cases, // such as when called on a system stack or with locks held. func gcStart(trigger gcTrigger) { // Since this is called from malloc and malloc is called in // the guts of a number of libraries that might be holding // locks, don't attempt to start GC in non-preemptible or // potentially unstable situations. mp := acquirem() if gp := getg(); gp == mp.g0 || mp.locks \u003e 1 || mp.preemptoff != \"\" { releasem(mp) return } releasem(mp) mp = nil // å†æ¬¡éªŒè¯æ˜¯å¦æ¡ä»¶ï¼Œå¹¶ä¸æ–­è°ƒç”¨ sweepone() æ¥å®Œæˆä¸Šä¸€æ¬¡åƒåœ¾æ”¶é›†çš„æ”¶å°¾å·¥ä½œ // Pick up the remaining unswept/not being swept spans concurrently // // This shouldn't happen if we're being invoked in background // mode since proportional sweep should have just finished // sweeping everything, but rounding errors, etc, may leave a // few spans unswept. In forced mode, this is necessary since // GC can be forced at any point in the sweeping cycle. // // We check the transition condition continuously here in case // this G gets delayed in to the next GC cycle. for trigger.test() \u0026\u0026 sweepone() != ^uintptr(0) { sweep.nbgsweep++ } // Perform GC initialization and the sweep termination // transition. semacquire(\u0026work.startSema) // Re-check transition condition under transition lock. if !trigger.test() { semrelease(\u0026work.startSema) return } // è·å– STW çš„é” // Ok, we're doing it! Stop everybody else semacquire(\u0026gcsema) semacquire(\u0026worldsema) // æ¯ä¸ª P åˆ†é…ä¸€ä¸ª Gï¼Œå‡†å¤‡å¼€å§‹æ‰§è¡Œåå°çš„æ ‡è®°å·¥ä½œ gcBgMarkStartWorkers() // æ‰§è¡Œ STW ! systemstack(stopTheWorldWithSema) // Finish sweep before we start concurrent scan. systemstack(func() { finishsweep_m() }) // ä¿®æ”¹ GC çŠ¶æ€ï¼Œè¿›å…¥æ ‡è®° setGCPhase(_GCmark) // åˆå§‹åŒ–æ ‡è®°æ‰€éœ€çŠ¶æ€ gcBgMarkPrepare() // è®¡ç®— Dataã€BSSã€Stack ç­‰éœ€è¦æ‰«æçš„æ•°é‡ gcMarkRootPrepare() // ç›´æ¥æ ‡è®° tiny object gcMarkTinyAllocs() // å¯ä»¥å¼€å§‹è¿è¡Œæ ‡è®° atomic.Store(\u0026gcBlackenEnabled, 1) // STW ç»“æŸï¼ŒG å¼€å§‹è¿›è¡Œå¹¶è¡Œæ ‡è®° // Concurrent mark. systemstack(func() { now = startTheWorldWithSema(trace.enabled) work.pauseNS += now - work.pauseStart work.tMark = now }) // é‡Šæ”¾é” semrelease(\u0026worldsema) releasem(mp) if mode != gcBackgroundMode { Gosched() } semrelease(\u0026work.startSema) } è¯¥å‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œå¤§è‡´åˆ†ä¸ºä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š ä¸»åŠ¨è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå¹¶ç­‰å¾…å”¤é†’ï¼› æ ¹æ® P.gcMarkWorkerMode å†³å®šæ ‡è®°çš„ç­–ç•¥ï¼› è°ƒç”¨ gcDrain() è¿›è¡Œæ ‡è®° æ‰€æœ‰æ ‡è®°ä»»åŠ¡å®Œæˆåï¼Œè°ƒç”¨ gcMarkDone() å®Œæˆæ ‡è®°é˜¶æ®µï¼› å› ä¸ºæ ‡è®°é˜¶æ®µæ˜¯ä¸ç”¨æˆ·è¿›ç¨‹å¹¶å‘çš„ï¼Œæ‰€ä»¥ä¼šæ¶‰åŠåˆ°æ‰§è¡Œåƒåœ¾æ”¶é›†è¿˜æ˜¯æ™®é€šç¨‹åºçš„é—®é¢˜ã€‚ä¸ºæ­¤ï¼Œæ¯ä¸ªåƒåœ¾æ”¶é›†çš„ G æœ‰ç€ä¸åŒçš„æ ‡è®°ç­–ç•¥ï¼Œå…¶ä¾èµ–äº P.gcMarkWorkerModeï¼ˆç”±ä¸€ä¸ªç‹¬ç«‹çš„ G è®¡ç®—å‡ºä¸åŒæ¨¡å¼çš„ P çš„æ•°é‡å¹¶è®¾ç½®ï¼‰ã€‚ å…¶åŒ…å«ä¸‰ç§æ ‡è®°ç­–ç•¥ï¼š gcMarkWorkerDedicatedModeï¼šP ä¸“é—¨ç”¨äºæ ‡è®°å¯¹è±¡ï¼Œä¸ä¼šè¢«æŠ¢å ï¼› gcMarkWorkerFractionalModeï¼šå½“åƒåœ¾æ”¶é›†åå° CPU ä½¿ç”¨ç‡è¾¾ä¸åˆ° 25%ï¼Œä¼šå¯åŠ¨è¯¥ç±»å‹å·¥ä½œåç¨‹å¸®åŠ©åƒåœ¾æ”¶é›†è¾¾åˆ°åˆ©ç”¨ç‡ç›®æ ‡ï¼Œå› ä¸ºåªå ç”¨ä¸€ä¸ª CPU éƒ¨åˆ†èµ„æºï¼Œå¯ä»¥è¢«æŠ¢å ï¼› gcMarkWorkerIdleModeï¼šå½“ P æ²¡æœ‰å¯ä»¥æ‰§è¡Œçš„ G æ—¶ï¼Œä¼šè¿è¡Œåƒåœ¾æ”¶é›†æ ‡è®°ä»»åŠ¡ç›´åˆ°è¢«æŠ¢å ï¼› ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:4:2","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.3 æ ‡è®°ç»“æŸ å½“æ¯ä¸ªæ ‡è®° Groutine ç»“æŸåï¼Œéƒ½ä¼šè°ƒç”¨ gcMarkDone()ï¼Œä½†æ˜¯ç­‰å¾…æ‰€æœ‰æ ‡è®°ç»“æŸåï¼Œåªæœ‰ä¸€ä¸ª groutine ä¼šçœŸæ­£æ‰§è¡Œç»“æŸé€»è¾‘ï¼ˆruntime/mgc.goï¼‰ã€‚ func gcMarkDone() { // ç¬¬ä¸€ä¸ªè·å–åˆ°é”çš„æ‰ä¼šæ‰§è¡Œ gcMarkDone() // Ensure only one thread is running the ragged barrier at a // time. semacquire(\u0026work.markDoneSema) top: // åç»­çš„ gouroute ä¼šä¸²è¡Œçš„åœ¨è¿™é‡Œé€€å‡º if !(gcphase == _GCmark \u0026\u0026 work.nwait == work.nproc \u0026\u0026 !gcMarkWorkAvailable(nil)) { semrelease(\u0026work.markDoneSema) return } // å¾ªç¯ç­‰å¾…æ‰€æœ‰æ ‡è®°ç»“æŸ gcMarkDoneFlushed = 0 systemstack(func() { gp := getg().m.curg casgstatus(gp, _Grunning, _Gwaiting) forEachP(func(_p_ *p) { wbBufFlush1(_p_) _p_.gcw.dispose() if _p_.gcw.flushedWork { atomic.Xadd(\u0026gcMarkDoneFlushed, 1) _p_.gcw.flushedWork = false } }) casgstatus(gp, _Gwaiting, _Grunning) }) if gcMarkDoneFlushed != 0 { goto top } â€¦ // Perform mark termination. This will restart the world. gcMarkTermination(nextTriggerRatio) } åœ¨ä¸€å¤§å †åˆ¤æ–­æ ‡è®°ç»“æŸçš„é€»è¾‘åï¼Œè°ƒç”¨ gcMarkTermination() è¿›å…¥æ ‡è®°ç»ˆæ­¢é˜¶æ®µã€‚ åœ¨ gcMarkTermination() ä¼šå…³é—­æ··åˆå†™å±éšœï¼Œå†³å®šè§¦å‘åƒåœ¾æ”¶é›†çš„ heap é˜ˆå€¼ï¼Œå¹¶è¿›è¡Œç›¸å…³ä¿¡æ¯çš„ç»Ÿè®¡ï¼Œç„¶åè°ƒç”¨ gcSweep() è¿›è¡Œé˜»å¡å¼æ¸…ç†ã€‚ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:4:3","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"æ€»ç»“ åƒåœ¾å›æ”¶çœŸçš„å¾ˆå¤æ‚ï¼Œä¸Šé¢çœç•¥äº†å¤§é‡çš„ç»†èŠ‚ï¼Œä¹Ÿæœ‰å¯èƒ½ç†è§£é”™è¯¯çš„æƒ…å†µã€‚ä½†æ˜¯å¿½ç•¥æ‰ç¹ççš„ç»†èŠ‚ï¼Œéœ€è¦å®Œå…¨æ˜ç™½çš„æœ‰å‡ ä¸ªç‚¹ï¼š ä¸‰è‰²æ ‡è®°ç®—æ³•çš„æ­¥éª¤ å¼ºä¸‰è‰²ä¸å˜æ€§æ¦‚å¿µï¼Œä»¥åŠä¸ºä»€ä¹ˆéœ€è¦ å†™å±éšœçš„ä½œç”¨ï¼Œä»¥åŠ Go ä½¿ç”¨çš„æ··åˆå†™å±éšœ GC è§¦å‘çš„æ—¶æœºä¸æ¡ä»¶ GC å¹¶å‘æ ‡è®°çš„å®ç° GC æ ‡è®°çš„å®ç°ï¼Œä¸å†…å­˜ç®¡ç†çš„ååŒ å†…å­˜æ¸…ç†çš„æ—¶æœº ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:5:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"å‚è€ƒ ã€ŠGolang å­¦ä¹ ç¬”è®°ã€‹ ã€ŠGolang è®¾è®¡ä¸å®ç°ã€‹ï¼šå†…å­˜åˆ†é…å™¨ ","date":"2021-01-14","objectID":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/:6:0","tags":["Golang","Golang åŸç†"],"title":"Go åƒåœ¾æ”¶é›†æ€»ç»“","uri":"/posts/language/golang/go-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"Golang åç¨‹æ ˆå®ç°ï¼Œå †å†…å­˜ç®¡ç†å®ç°","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹ Golang å†…å­˜æ¨¡å‹ä¸å†…å­˜ç®¡ç†çš„ä¸€ä¸ªæ€»ç»“ï¼ŒåŸºæœ¬å†…å®¹æ¥æºäºç½‘ç»œçš„å­¦ä¹ ï¼Œä»¥åŠè‡ªå·±è§‚æ‘©äº†ä¸‹æºç ã€‚ æ‰€ä»¥å­¦ä¹ çš„ä¹¦ç±ä¸æ–‡ç« è§ å‚è€ƒã€‚ ä¸‹é¢ä»£ç éƒ½æ˜¯åŸºäº go 1.15.6ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:0:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"1 Linux å†…å­˜æ¨¡å‹ æ‰€æœ‰è¯­è¨€çš„å†…å­˜ç®¡ç†ï¼Œåœ¨ Linux ä¸Šéƒ½æ˜¯åœ¨ä»¥åŸºæœ¬çš„è¿›ç¨‹å†…å­˜æ¨¡å‹åŸºç¡€ä¸Šå®ç°çš„ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ Linux è¿›ç¨‹å†…å­˜å¸ƒå±€ã€‚ åœ¨è¿›ç¨‹è§’åº¦ï¼Œçœ‹åˆ°çš„æ‰€æœ‰å†…å­˜å°±æ˜¯ è™šæ‹Ÿåœ°å€ç©ºé—´virtual address space ï¼Œæ•´ä¸ªæ˜¯ä¸€ä¸ªçº¿æ€§çš„å­˜å‚¨åœ°å€ã€‚å…¶ä¸­ä¸€éƒ¨åˆ†é«˜åœ°å€åŒºåŸŸç”¨æˆ·æ€æ— æ³•è®¿é—®ï¼Œæ˜¯å†…æ ¸åœ°å€ç©ºé—´ã€‚è€Œå¦ä¸€éƒ¨åˆ†å°±æ˜¯ç”±æ ˆã€mmapã€å †ç­‰å†…å­˜åŒºåŸŸç»„æˆçš„ç”¨æˆ·åœ°å€ç©ºé—´ã€‚ ä¸Šé¢è¿›ç¨‹å¯ä»¥è‡ªå·±åˆ†é…ä¸ç®¡ç†çš„è¿›ç¨‹ï¼Œå°±æ˜¯ mmap ä¸ å †ï¼Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ä¸º mmap() ä¸ brk()ï¼Œå› æ­¤æ‰€æœ‰è¯­è¨€çš„å†…å­˜ç®¡ç†éƒ½æ˜¯åŸºäºè¿™ä¸¤ä¸ªå†…å­˜åŒºåŸŸåœ¨è¿›ä¸€æ­¥å®ç°çš„ï¼ˆåŒ…æ‹¬ glibc çš„ malloc() ä¸ free()ï¼‰ã€‚ mmap æœ€åŸºæœ¬æœ‰ä¸¤ä¸ªç”¨é€”ï¼š æ–‡ä»¶æ˜ å°„ ï¼šç”³è¯·ä¸€å—å†…å­˜åŒºåŸŸï¼Œæ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿä¸Šä¸€ä¸ªæ–‡ä»¶ï¼ˆè¿™ä¹Ÿæ˜¯ page_cache çš„åŸºæœ¬åŸç†ï¼Œæ‰€ä»¥ä»–ä»¬åœ¨å†…æ ¸ä¸­éƒ½ä½¿ç”¨ address_space å®ç°ï¼‰ åŒ¿åæ˜ å°„ ï¼šç”³è¯·ä¸€å—å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯æ²¡æœ‰æ˜ å°„åˆ°å…·ä½“æ–‡ä»¶ï¼Œç›¸å½“äºåˆ†é…äº†ä¸€å—å†…å­˜åŒºåŸŸï¼ˆå¯ä»¥ç”¨äºçˆ¶å­è¿›ç¨‹å…±äº«ã€æˆ–è€…è‡ªå·±ç®¡ç†å†…å­˜çš„åˆ†é…ç­‰åŠŸèƒ½ï¼‰ è€Œæ‰€æœ‰åœ¨å†…å­˜ä¸Šæ‰€è¯´çš„åœ°å€ï¼ŒåŒ…æ‹¬ä»£ç æŒ‡ä»¤åœ°å€ã€å˜é‡åœ°å€éƒ½æ˜¯ä¸Šé¢åœ°å€ç©ºé—´çš„ä¸€ä¸ªåœ°å€ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:1:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2 PC ä¸ SP Goroutine å°†è¿›ç¨‹çš„åˆ‡æ¢å˜ä¸ºäº†åç¨‹é—´çš„åˆ‡æ¢ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´è´Ÿè´£æ‰§è¡Œä»£ç ä¸åç¨‹ä¸Šä¸‹æ–‡çš„ä¿ç•™ä¸åˆ‡æ¢ã€‚å› æ­¤ï¼Œæœ‰ä¸¤ä¸ªå…³é”®çš„å¯„å­˜å™¨ï¼šPC ä¸ SPã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:2:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.1 PC ç¨‹åºè®¡æ•°å™¨ PCProgram Counter æ˜¯ CPU ä¸­çš„ä¸€ä¸ªå¯„å­˜å™¨ï¼Œä¿å­˜ç€ä¸‹ä¸€ä¸ª CPU æ‰§è¡Œçš„æŒ‡ä»¤çš„ä½ç½®ã€‚é¡ºåºæ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼ŒPC = PC + 1ï¼ˆä¸€ä¸ªæŒ‡ä»¤ï¼‰ã€‚è€Œè°ƒç”¨å‡½æ•°æˆ–è€…æ¡ä»¶è·³è½¬æ—¶ï¼Œä¼šå°†è·³åˆ°çš„æŒ‡ä»¤åœ°å€è®¾ç½®åˆ° PC ä¸­ã€‚ æ‰€ä»¥ï¼Œå¯ä»¥æƒ³åˆ°ï¼Œå½“éœ€è¦åˆ‡æ¢æ‰§è¡Œçš„ goroutineï¼Œè°ƒç”¨ JMP æŒ‡ä»¤è·³è½¬åˆ° G å¯¹åº”çš„ä»£ç ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:2:1","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"2.2 SP æ ˆé¡¶æŒ‡é’ˆ SPstack pointer æ˜¯ä¿å­˜æ ˆé¡¶åœ°å€çš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ä¸´æ—¶å˜é‡åœ¨æ ˆä¸Šï¼Œå°±æ˜¯å°†ä¸´æ—¶å˜é‡çš„å€¼å†™å…¥ SP ä¿å­˜çš„å†…å­˜åœ°å€ï¼Œç„¶å SP ä¿å­˜çš„åœ°å€å‡å°ï¼ˆæ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€å˜åŒ–ï¼‰ï¼Œç„¶åä¸´æ—¶å˜é‡é”€æ¯æ—¶ï¼ŒSP åœ°å€åˆå˜ä¸ºé«˜åœ°å€ã€‚ ä¸è¿‡ï¼Œå› ä¸º goroutine åˆ‡æ¢æ—¶ï¼Œå¿…é¡»è¦ä¿å­˜å½“å‰ goroutine çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯æ ˆé‡Œçš„å˜é‡ã€‚å› æ­¤ï¼Œgoroutine æ ˆè‚¯å®šæ˜¯ä¸èƒ½ä½¿ç”¨ Linux è¿›ç¨‹æ ˆäº†ï¼ˆå› ä¸ºè¿›ç¨‹æ ˆæœ‰ä¸Šé™ï¼Œä¹Ÿæ— æ³•å®ç°â€œä¿å­˜â€è¿™ç§åŠŸèƒ½ï¼‰ã€‚æ‰€ä»¥æ‰€è¯´çš„åç¨‹æ ˆï¼Œéƒ½æ˜¯åŸºäº mmap ç”³è¯·å†…å­˜ç©ºé—´ï¼ˆåŸºäº Go å†…å­˜ç®¡ç†ï¼Œå†…å­˜ç®¡ç†åŸºäº mmapï¼‰ï¼Œç„¶ååˆ‡æ¢æ—¶ä¿®æ”¹ SP å¯„å­˜å™¨åœ°å€å®ç°çš„ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ goroutine æ ˆå¯ä»¥â€œæ— é™å¤§â€çš„åŸå› äº†ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:2:2","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3 Goroutine æ ˆ æ•´ä½“çš„ä¸€ä¸ª G çš„æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š stack.loï¼š G æ ˆçš„æœ€å¤§ä½åœ°å€ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé™ï¼‰ï¼› stack.hiï¼šG æ ˆçš„åˆå§‹åœ°å€ï¼› stackguard0ï¼šé˜ˆå€¼åœ°å€ï¼Œç”¨äºåˆ¤æ–­ G æ ˆæ˜¯å¦éœ€è¦æ‰©å®¹ï¼› StackGuardï¼šå¸¸é‡ï¼Œæ ˆçš„ä¿æŠ¤åŒºï¼Œä¹Ÿå°±æ˜¯é¢„ç•™çš„åœ°å€ï¼› StackSmallï¼šå¸¸é‡ï¼Œç”¨äºå°å‡½æ•°è°ƒç”¨çš„ä¼˜åŒ–ï¼› å…ˆçœ‹ä¸€ä¸‹ g çš„å®ç°ä¸­åŒ…å«çš„ stack å±æ€§ï¼ˆruntime/runtime2.goï¼‰ï¼Œå…¶å®æ³¨é‡Šå†™çš„å°±å¾ˆæ˜ç™½äº†ï¼š type g struct { // Stack parameters. // stack describes the actual stack memory: [stack.lo, stack.hi). // stackguard0 is the stack pointer compared in the Go stack growth prologue. // It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption. // stackguard1 is the stack pointer compared in the C stack growth prologue. // It is stack.lo+StackGuard on g0 and gsignal stacks. // It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash). stack stack // offset known to runtime/cgo stackguard0 uintptr // offset known to liblink stackguard1 uintptr // offset known to liblink // ... } stack å±æ€§å°±æ˜¯ G å¯¹åº”çš„æ ˆäº†ï¼ˆè¿™ä¹Ÿè¡¨æ˜äº†ä¸æ˜¯ä½¿ç”¨çš„è¿›ç¨‹æ ˆï¼‰ï¼› Note stack ä¸ stackguard0 å±æ€§ä¸€å®šè¦åœ¨ g ç»“æ„çš„å¼€å¤´ï¼Œå› ä¸ºæ±‡ç¼–ä¸­ä¼šä½¿ç”¨æŒ‡å®šçš„åç§» (0x10) æ¥è·å–å¯¹åº”çš„å€¼ï¼› å…·ä½“çœ‹ä¸€ä¸‹ stack ç»“æ„ï¼ˆruntime/runtime2.goï¼‰ï¼š // Stack describes a Go execution stack. // The bounds of the stack are exactly [lo, hi), // with no implicit data structures on either side. type stack struct { lo uintptr hi uintptr } ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.1 æ–° G çš„æ ˆ åœ¨ malg å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¯¹äºæ–° G çš„æ ˆçš„åˆ†é…ï¼ˆä¸€å¼€å§‹ä¸º 2KBï¼‰ï¼š // Allocate a new g, with a stack big enough for stacksize bytes. func malg(stacksize int32) *g { newg := new(g) if stacksize \u003e= 0 { stacksize = round2(_StackSystem + stacksize) // åœ¨å…¬å…±çš„ goroutine(g0) ä¸Šè°ƒç”¨å‡½æ•° systemstack(func() { // åˆ†é…ä¸€ä¸ª stack newg.stack = stackalloc(uint32(stacksize)) }) // è®¾ç½® stackguard0 åœ°å€ newg.stackguard0 = newg.stack.lo + _StackGuard newg.stackguard1 = ^uintptr(0) // Clear the bottom word of the stack. We record g // there on gsignal stack during VDSO on ARM and ARM64. *(*uintptr)(unsafe.Pointer(newg.stack.lo)) = 0 } return newg } Note æ³¨æ„ systemstack()ï¼Œç”¨äºå°†å½“å‰æ ˆåˆ‡æ¢åˆ° M çš„ g0 åç¨‹æ ˆä¸Šæ‰§è¡Œå‘½ä»¤ã€‚ Why? å› ä¸º G ç”¨äºæ‰§è¡Œç”¨æˆ·é€»è¾‘ï¼Œè€ŒæŸäº›ç®¡ç†æ“ä½œä¸æ–¹ä¾¿åœ¨ G æ ˆä¸Šæ‰§è¡Œï¼ˆä¾‹å¦‚ G å¯èƒ½ä¸­é€”åœæ­¢ï¼Œåƒåœ¾å›æ”¶æ—¶ G æ ˆç©ºé—´ä¹Ÿæœ‰å¯èƒ½è¢«å›æ”¶ï¼‰ï¼Œæ‰€ä»¥éœ€è¦æ‰§è¡Œç®¡ç†å‘½ä»¤æ—¶ï¼Œéƒ½ä¼šé€šè¿‡ systemstack æ–¹æ³•å°†çº¿ç¨‹æ ˆåˆ‡æ¢ä¸º g0 çš„æ ˆæ‰§è¡Œï¼Œä¸ç”¨æˆ·é€»è¾‘éš”ç¦»ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:1","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.2 æ ˆçš„åˆ†é… stackalloc() å‡½æ•°ç”¨äºåˆ†é…ä¸€ä¸ªæ ˆï¼Œæ— è®ºæ˜¯ç»™æ–° G è¿˜æ˜¯æ‰©å®¹æ ˆæ—¶éƒ½ä¼šç”¨åˆ°ï¼Œå› æ­¤æ ˆç©ºé—´çš„åˆ†é…ä¸å›æ”¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒé¢‘ç¹çš„æ“ä½œï¼Œæ‰€ä»¥æ ˆç©ºé—´é‡‡å–äº†ç¼“å­˜å¤ç”¨çš„æ–¹å¼ã€‚ ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š å¦‚æœåˆ†é…çš„æ ˆç©ºé—´ä¸å¤§ï¼Œå°±èµ°ç¼“å­˜å¤ç”¨è¿™ç§æ–¹å¼åˆ†é…ã€‚æ²¡æœ‰å¯ä»¥å¤ç”¨çš„å°±åˆ›å»ºï¼› å¦‚æœåˆ†é…çš„æ ˆç©ºé—´å¾ˆå¤§ï¼ˆå¤§äº 32KBï¼‰ï¼Œå°±ç›´æ¥ä» heap åˆ†é…ï¼› è¿™é‡Œä¸»è¦å…³æ³¨ç¬¬ 1 ä¸­æ–¹å¼ï¼Œä¼šè°ƒç”¨ stackpoolalloc() å‡½æ•°ã€‚ // Allocates a stack from the free pool. Must be called with // stackpool[order].item.mu held. func stackpoolalloc(order uint8) gclinkptr { list := \u0026stackpool[order].item.span s := list.first // ... if s == nil { // æ²¡æœ‰å¯ä»¥å¤ç”¨çš„æ ˆï¼Œèµ°å†…å­˜ç®¡ç†åˆ›å»º s = mheap_.allocManual(_StackCacheSize\u003e\u003e_PageShift, \u0026memstats.stacks_inuse) // ... } x := s.manualFreeList if x.ptr() == nil { throw(\"span has no free stacks\") } s.manualFreeList = x.ptr().next // ... return x } å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆå°è¯•ä» stackpool ç¼“å­˜çš„ç©ºé—²çš„ stack è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™èµ° Go å†…å­˜ç®¡ç†ç”³è¯·ä¸€ä¸ªã€‚ å†æ¥ä¸‹æ¥å°±æ˜¯ Go å†…å­˜ç®¡ç†æ¨¡å—è´Ÿè´£çš„äº‹äº†ï¼Œä¸æ·±å…¥ä¸‹å»ï¼ˆåé¢å†è¯´ï¼‰ã€‚åº•å±‚åˆ›å»ºéƒ½æ˜¯ä½¿ç”¨ mmap ç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸‹ä½¿ç”¨çš„å‚æ•°ï¼š // Don't split the stack as this method may be invoked without a valid G, which // prevents us from allocating more stack. //go:nosplit func sysAlloc(n uintptr, sysStat *uint64) unsafe.Pointer { p, err := mmap(nil, n, _PROT_READ|_PROT_WRITE, _MAP_ANON|_MAP_PRIVATE, -1, 0) if err != 0 { if err == _EACCES { print(\"runtime: mmap: access denied\\n\") exit(2) } if err == _EAGAIN { print(\"runtime: mmap: too much locked memory (check 'ulimit -l').\\n\") exit(2) } return nil } mSysStatInc(sysStat, n) return p } é€šè¿‡ mmap è°ƒç”¨çš„å‚æ•°å¯ä»¥çœ‹åˆ°ï¼Œç”³è¯·äº†ä¸€ä¸ªç³»ç»Ÿåˆ†é…çš„åŒ¿åå†…å­˜æ˜ å°„ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:2","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.3 æ ˆçš„æ‰©å®¹ 3.3.1 æ‰©å®¹åˆ¤æ–­ Go ç¼–è¯‘å™¨ä¼šåœ¨æ‰§è¡Œå‡½æ•°å‰ï¼Œæ’å…¥ä¸€äº›æ±‡ç¼–æŒ‡ä»¤ï¼Œå…¶ä¸­ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯æ£€æŸ¥ G æ ˆæ˜¯å¦éœ€è¦æ‰©å®¹ã€‚çœ‹ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„å®ç°ï¼š // main() è°ƒç”¨ test() $ go build -gcflags \"-l\" -o test main.go $ go tool objump -s \"main\\.test\" test TEXT main.test(SB) /root/yusihao/onething/BizImages/main.go main.go:3 0x45dc80 MOVQ FS:0xfffffff8, CX // CX ä¸ºå½“å‰ G åœ°å€ main.go:3 0x45dc89 CMPQ 0x10(CX), SP // CX+0x10 æ‰§è¡Œ g.stackguard0 å±æ€§ï¼Œä¸ SP æŒ‡é’ˆåœ°å€æ¯”è¾ƒ main.go:3 0x45dc8d JBE 0x45dccf // å¦‚æœ SP \u003c=stackguard0 è·³è½¬åˆ° 0x45dccfï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ runtime.morestack_noctxt(SB) å‡½æ•° main.go:3 0x45dc8f SUBQ $0x18, SP // ... main.go:5 0x45dcce RET // å‡½æ•°æ‰§è¡Œç»“æŸï¼ŒRET è¿”å›ï¼Œä¸ä¼šæ‰§è¡Œåé¢ä¸¤ä¸ªæŒ‡ä»¤ main.go:3 0x45dccf CALL runtime.morestack_noctxt(SB) // æ‰§è¡Œæ ˆæ‰©å®¹ main.go:3 0x45dcd4 MP main.test(SB) // æ‰§è¡Œç»“æŸåï¼Œé‡æ–°æ‰§è¡Œå½“å‰å‡½æ•° é€»è¾‘å¾ˆç®€å•ï¼Œå¦‚æœ SP \u003c= stackguard0ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œæ ˆçš„æ‰©å®¹ï¼Œæ‰©å®¹ç»“æŸé‡æ–°æ‰§è¡Œå½“å‰å‡½æ•°ã€‚ Note ä¸Šé¢æ¯”è¾ƒ SP æ—¶å€™ï¼Œæ²¡æœ‰è€ƒè™‘å½“å‰å‡½æ•°è°ƒç”¨ä½¿ç”¨çš„ç©ºé—´å¤§å°ã€‚Why? å› ä¸ºæµ‹è¯•ç¨‹åºè¿™ä¸ªå‡½æ•°ä¸­ä½¿ç”¨çš„ç©ºé—´æ¯”è¾ƒå°ï¼Œè€Œ stackguard0 ä¸ stack.lo æœ‰ä¸€æ®µä¿æŠ¤åŒºï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å…è®¸è¿™é‡Œ â€œæº¢å‡ºâ€ ä¸€äº›ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ²¡æœ‰è®© SP è€ƒè™‘å‡½æ•°ä½¿ç”¨ç©ºé—´ã€‚ å¦‚æœå‡½æ•°ä¸­ä½¿ç”¨çš„ç©ºé—´å¤§è¿‡ä¿æŠ¤åŒºæ—¶ï¼Œæ¯”è¾ƒæ—¶å°±ä¼šè®© SP å‡å»å½“å‰å‡½æ•°ä½¿ç”¨ç©ºé—´å†æ¯”è¾ƒäº†ã€‚ 3.3.2 æ‰©å®¹ æ‰©å®¹é€»è¾‘å¤§è‡´åˆ†ä¸ºä¸‰æ­¥ï¼š åˆ†é…ä¸€ä¸ª 2x æ–°æ ˆï¼› æ‹·è´å½“å‰æ ˆæ•°æ®è‡³æ–°æ ˆï¼› â€œé‡Šæ”¾\"æ‰æ—§æ ˆï¼› ä»ä¸Šé¢æ‰©å®¹åˆ¤æ–­å¯ä»¥çœ‹åˆ°ï¼Œä¼šè°ƒç”¨ morestack çš„æ±‡ç¼–ä»£ç ï¼š // Called during function prolog when more stack is needed. // R3 prolog's LR // using NOFRAME means do not save LR on stack. // // The traceback routines see morestack on a g0 as being // the top of a stack (for example, morestack calling newstack // calling the scheduler calling newm calling gc), so we must // record an argument size. For that purpose, it has no arguments. TEXT runtimeÂ·morestack(SB),NOSPLIT|NOFRAME,$0-0 // Cannot grow scheduler stack (m-\u003eg0). MOVWÂ g_m(g), R8 MOVWÂ m_g0(R8), R4 CMPÂ g, R4 BNEÂ 3(PC) BLÂ runtimeÂ·badmorestackg0(SB) BÂ runtimeÂ·abort(SB) // Cannot grow signal stack (m-\u003egsignal). MOVWÂ m_gsignal(R8), R4 CMPÂ g, R4 BNEÂ 3(PC) BLÂ runtimeÂ·badmorestackgsignal(SB) BÂ runtimeÂ·abort(SB) // Called from f. // Set g-\u003esched to context in f. MOVWÂ R13, (g_sched+gobuf_sp)(g) MOVWÂ LR, (g_sched+gobuf_pc)(g) MOVWÂ R3, (g_sched+gobuf_lr)(g) MOVWÂ R7, (g_sched+gobuf_ctxt)(g) // Called from f. // Set m-\u003emorebuf to f's caller. MOVWÂ R3, (m_morebuf+gobuf_pc)(R8)Â // f's caller's PC MOVWÂ R13, (m_morebuf+gobuf_sp)(R8)Â // f's caller's SP MOVWÂ g, (m_morebuf+gobuf_g)(R8) // Call newstack on m-\u003eg0's stack. MOVWÂ m_g0(R8), R0 BLÂ setg\u003c\u003e(SB) MOVWÂ (g_sched+gobuf_sp)(g), R13 MOVWÂ $0, R0 MOVW.W R0, -4(R13)Â // create a call frame on g0 (saved LR) BLÂ runtimeÂ·newstack(SB) // Not reached, but make sure the return PC from the call to newstack // is still in this function, and not the beginning of the next. RET TEXT runtimeÂ·morestack_noctxt(SB),NOSPLIT|NOFRAME,$0-0 MOVWÂ $0, R7 B runtimeÂ·morestack(SB) å¯ä»¥çœ‹åˆ° g0ï¼Œgsignal çš„æ ˆéƒ½ä¸ä¼šæ‰©å®¹ åœ¨ g0 æ ˆä¸Šä¼šè°ƒç”¨ newstack() å‡½æ•° è°ƒç”¨çš„ newstack() å‡½æ•°ï¼ˆruntime/stack.goï¼‰ï¼Œè¿‡ç¨‹å¾ˆå¤æ‚ï¼Œåªçœ‹ä¸€ä¸‹å…³é”®ç‚¹ï¼š // Called from runtimeÂ·morestack when more stack is needed. // Allocate larger stack and relocate to new stack. // Stack growth is multiplicative, for constant amortized cost. // // g-\u003eatomicstatus will be Grunning or Gscanrunning upon entry. // If the scheduler is trying to stop this g, then it will set preemptStop. // // This must be nowritebarrierrec because it can be called as part of // stack growth from other nowritebarrierrec functions, but the // compiler doesn't check this. // //go:nowritebarrierrec func newstack() { thisg := getg() gp := thisg.m.curg // ... // æ–°æ ˆå¤§å°ä¸ºå½“å‰ä¸¤å€ oldsize := gp.stack.hi - gp.stack.lo newsize := oldsize * 2 // ... // æ”¹å˜ G çŠ¶æ€ä¸º copy stackï¼Œgc ä¼šè·³è¿‡è¯¥çŠ¶æ€çš„ G casgstatus(gp, _Grunning, _Gcopystack) // åˆ†é…æ–°æ ˆï¼Œæ‹·è´æ•°æ®ï¼Œé‡Šæ”¾æ—§ç«™ // The concurrent GC will not scan the stack while we are doing the copy since // the gp is in a Gcopystack status. copystack(gp, newsize) if stackDebug \u003e= 1 { print(\"stack grow done\\n\") } casgstatus(gp, _Gcopystack, _Grunning) // æ‰§è¡Œ G ä»£ç  gogo(\u0026gp.sched) } // Copies gp's stack to a new stack of a different size. // Caller must have changed gp status to Gcopystack. func copystack(gp *g, newsize uintptr) { // åˆ›å»ºæ–° stack new := stackalloc(uint32(newsize)) // ... // æ‹·è´æ•°æ® memmove(unsafe.Pointer(new.hi-ncopy), unsafe.Pointer(old.hi-ncopy), ncopy) // ... gp.stack = new gp.stackguard0 = new.lo + _StackGuard // é‡Šæ”¾æ—§ stack if stackPoisonCopy != 0 { fillstac","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:3","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.4 æ ˆçš„é‡Šæ”¾ stackfree æ ˆçš„é‡Šæ”¾ä¸ç”³è¯·ç›¸åï¼Œæ”¾å…¥ stackpoolï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨å†…å­˜ç®¡ç†åˆ é™¤ï¼Œé‡ç‚¹è¿˜æ˜¯å†…å­˜ç®¡ç†çš„æ´»ï¼Œæ‰€ä»¥è¿™é‡Œä¸å±•å¼€ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:4","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.5 æ ˆçš„åˆ‡æ¢ åˆ‡æ¢åº”è¯¥æ˜¯å±äº goroutine è°ƒåº¦çš„å†…å®¹ï¼Œä¸è¿‡è¿™é‡Œå¯ä»¥å…³æ³¨ä¸€ä¸‹æ ˆæ—¶å¦‚ä½•åˆ‡æ¢çš„ã€‚ å½“ M æ‰§è¡Œçš„ G éœ€è¦åˆ‡æ¢ï¼Œæˆ–è€…ä¸€ä¸ªæ–°åˆ›å»º G æ‰§è¡Œæ—¶ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨ execute() å‡½æ•°ï¼Œè€Œ execute() å‡½æ•°ä¼šè°ƒç”¨ gogo æ±‡ç¼–å®ç°çš„å‡½æ•°ã€‚ // func gogo(buf *gobuf) // restore state from Gobuf; longjmp TEXT runtimeÂ·gogo(SB), NOSPLIT, $16-8 MOVQ buf+0(FP), BX // gobuf MOVQ gobuf_g(BX), DX MOVQ 0(DX), CX // make sure g != nil get_tls(CX) MOVQ DX, g(CX) MOVQ gobuf_sp(BX), SP // restore SP ï¼ˆå…³é”®ï¼) MOVQ gobuf_ret(BX), AX MOVQ gobuf_ctxt(BX), DX MOVQ gobuf_bp(BX), BP MOVQ $0, gobuf_sp(BX) // clear to help garbage collector MOVQ $0, gobuf_ret(BX) MOVQ $0, gobuf_ctxt(BX) MOVQ $0, gobuf_bp(BX) MOVQ gobuf_pc(BX), BX JMP BX gobuf ä¸­ä¿å­˜ç€è¦æ‰§è¡Œçš„ G çš„ spã€pc æŒ‡é’ˆï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡å°†å¯¹åº” gobuf.sp å†™å…¥åˆ° SP å¯„å­˜å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯å°†ä½¿ç”¨çš„æ ˆåˆ‡æ¢ä¸ºäº† G çš„æ ˆã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:5","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"3.6 g0 çš„æ ˆ åœ¨é˜…è¯»ç½‘ä¸Šçš„æ–‡ç« æ—¶ï¼Œè®¸å¤šæ–‡ç« éƒ½è¯´ g0 ä½¿ç”¨çš„æ˜¯ç³»ç»Ÿæ ˆï¼Œæˆ‘ç†è§£ä¸ºä½¿ç”¨çš„æ˜¯è¿›ç¨‹çš„æ ˆå†…å­˜åŒºåŸŸã€‚ä½†æ˜¯æ€è€ƒä¸€ä¸‹ï¼Œæ¯ä¸ª M å¯¹åº”ä¸€ä¸ª g0ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å¤šä¸ªçº¿ç¨‹è¦åŒæ—¶å…±äº«ç³»ç»Ÿæ ˆï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚ä¾‹å¦‚åœ¨ pthread å®ç°ä¸­ï¼Œå¯¹åº”æ–°å»ºçš„çº¿ç¨‹ä¹Ÿæ˜¯ä½¿ç”¨ mmap åˆ†é…ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œç„¶åè°ƒç”¨ clone() ç³»ç»Ÿè°ƒç”¨æ—¶ä¼ å…¥æ ˆåœ°å€å‚æ•°ã€‚ çœ‹ä¸€ä¸‹ä»£ç ï¼Œç¡®è®¤ä¸€ä¸‹åˆ°åº• g0 çš„æ ˆåˆ°åº•æ˜¯å•¥ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ–°å»º m çš„åœ°æ–¹ï¼š mp := new(m) mp.mstartfn = fn mcommoninit(mp, id) // In case of cgo or Solaris or illumos or Darwin, pthread_create will make us a stack. // Windows and Plan 9 will layout sched stack on OS stack. if iscgo || GOOS == \"solaris\" || GOOS == \"illumos\" || GOOS == \"windows\" || GOOS == \"plan9\" || GOOS == \"darwin\" { mp.g0 = malg(-1) } else { mp.g0 = malg(8192 * sys.StackGuardMultiplier) } mp.g0.m = mp å¯ä»¥çœ‹åˆ°ï¼Œm çš„ g0 å±æ€§è¿˜æ˜¯ä½¿ç”¨çš„ [malg() å‡½æ•°](#31-æ–°-g-çš„æ ˆï¼‰ å»åˆ›å»ºçš„ï¼Œä¸æ™®é€šçš„ g åˆ›å»ºä¸€æ ·ï¼Œåªä¸è¿‡åˆå§‹å¤§å°ä¸º 8KBã€‚malg() æµç¨‹ä¸Šé¢æœ‰è¯´åˆ°ï¼Œå°±æ˜¯èµ°å†…å­˜ç®¡ç†åˆ†é… mspan ä½œä¸ºæ ˆçš„æ–¹å¼ã€‚ ä¸è¿‡ï¼Œg0 çš„æ ˆè¿˜æ˜¯æœ‰äº›ä¸åŒçš„ï¼Œä¸ä¼šè¿›è¡Œæ ˆçš„æ‰©å®¹ï¼ˆå› ä¸ºä»…ä»…å†…éƒ¨ç®¡ç†æ—¶ç”¨åˆ°ï¼Œä¸éœ€è¦è¿›è¡Œè‡ªåŠ¨æ‰©å®¹ï¼‰ï¼Œåœ¨æ ˆæ‰©å®¹çš„ morestack æ±‡ç¼–ä»£ç  é‡Œå¯ä»¥çœ‹åˆ°ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:3:6","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4 å†…å­˜æ¨¡å‹ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.1 æ¦‚è§ˆ Golang å†…å­˜ç®¡ç†åŒ…å«å››ä¸ªç»„ä»¶ï¼š object ï¼šobject ä»£è¡¨ç”¨æˆ·ä»£ç ç”³è¯·çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæ²¡æœ‰å®é™…çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯åœ¨ mspan ä¸­ä»¥é€»è¾‘åˆ‡åˆ†çš„æ–¹å¼åˆ†é…ï¼› pageï¼šåˆ‡åˆ†å†…å­˜çš„å•å…ƒï¼Œmheap å°†å†…å­˜ä»¥ 8KB page åˆ‡åˆ†ï¼Œç„¶åç»„åˆæˆä¸º mspanï¼› runtime.mspan ï¼šå†…å­˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œç”±å¤šä¸ª 8KB å¤§å°çš„ page æ„æˆï¼ŒæŒ‰ç…§å›ºå®šå¤§å°æ¥åˆ‡åˆ†ä¸ºå¤šä¸ª objectï¼› runtime.mcache ï¼šå•ä¸ª P å¯¹åº”çš„ mspan çš„ç¼“å­˜ï¼Œæ— é”åˆ†é…ï¼› runtime.mcentral ï¼šæŒ‰ç…§ä¸åŒå¤§å°çš„ mspan åˆ†ç»„çš„ç®¡ç†é“¾è¡¨ï¼Œä¸º mcache æä¾›ç©ºé—² mspan runtime.mheap ï¼šä¿å­˜é—²ç½®çš„ mspan ä¸ largerspan é“¾è¡¨ï¼Œä¸æ“ä½œç³»ç»Ÿç”³è¯·ä¸é‡Šæ”¾å†…å­˜ï¼› ä¸Šé¢çš„ç»„ä»¶ä¹Ÿå¯ä»¥çœ‹åšåˆ†å±‚ï¼Œæ™®é€šå¯¹è±¡ï¼ˆobjectï¼‰çš„ç”³è¯·ä¸é‡Šæ”¾å°±æ˜¯æŒ‰ç…§ä¸Šä¸‹å±‚é¡ºåºç”³è¯·ä¸é‡Šæ”¾çš„ã€‚ Note ä¸‹é¢ä¸ä¼šè¯´ï¼ˆåé¢å†è¯´ï¼‰å…·ä½“çš„ object åˆ†é…æµç¨‹ï¼Œè€Œæ˜¯è¯´æ˜å„ä¸ªå±‚æ¬¡æ—¶çš„ç”³è¯·ä¸é‡Šæ”¾æ“ä½œã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:1","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.2 mspan æ¯ä¸ª mspan ç”±å¤šä¸ª 8KB çš„ page ç»„æˆï¼Œæ‰€æœ‰çš„ mspan ä¼šä»¥ list çš„æ–¹å¼æ„å»ºï¼Œè€Œä¸åŒçš„æ¨¡å—ï¼ˆmcacheã€mcentralï¼‰é€šè¿‡å¼•ç”¨æŒ‡é’ˆï¼Œæ¥ä¸åŒæ–¹å¼æ¥ç»„ç»‡ä¸åŒçš„ mspanã€‚ æ¯ä¸ª mspan ç®¡ç†å¤šä¸ªå›ºå®šå¤§å°çš„ objectï¼Œé€šè¿‡ç¼–å· (index) æ–¹å¼æ¥å¯»æ‰¾ object çš„åœ°å€ã€‚ ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆçœç•¥éƒ¨åˆ†ï¼‰ï¼š type mspan struct { next *mspan // next span in list, or nil if none Â prev *mspan // previous span in list, or nil if none startAddr uintptr // address of first byte of span aka s.base() Â npages uintptr // number of pages in span manualFreeList gclinkptr // list of free objects in mSpanManual spans Â freeindex uintptr nelems uintptr // number of object in the span. Â allocCache uint64 allocBits *gcBits gcmarkBits *gcBits // sweep generation: // if sweepgen == h-\u003esweepgen - 2, the span needs sweeping // if sweepgen == h-\u003esweepgen - 1, the span is currently being swept // if sweepgen == h-\u003esweepgen, the span is swept and ready to use // if sweepgen == h-\u003esweepgen + 1, the span was cached before sweep began and is still cached, and needs sweeping // if sweepgen == h-\u003esweepgen + 3, the span was swept and then cached and is still cached // h-\u003esweepgen is incremented by 2 after every GC Â sweepgen uint32 spanclass spanClass // size class and noscan (uint8) Â allocCount uint16 // number of allocated objects Â elemsize uintptr // computed from sizeclass or from npages } nextã€prev ï¼šé“¾è¡¨å‰å spanï¼› startAddr ï¼šspan åœ¨ arena åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼› npages ï¼šå ç”¨ page(8KB) æ•°é‡ï¼› manualFreeList ï¼šç©ºé—² object é“¾è¡¨ï¼› freeindex ï¼šä¸‹ä¸€ä¸ªç©ºé—²çš„ object çš„ç¼–å·ï¼Œå¦‚æœ freeindex == nelemï¼Œè¡¨æ˜æ²¡æœ‰ç©ºé—² object å¯ä»¥åˆ†é… nelems ï¼šå½“å‰ span ä¸­åˆ†é…çš„ object çš„ä¸Šé™ï¼› allocCache ï¼šfreeindex çš„ cacheï¼Œé€šè¿‡ bitmap çš„æ–¹å¼è®°å½•å¯¹åº”ç¼–å·çš„ object å†…å­˜æ˜¯å¦æ˜¯ç©ºé—²çš„ï¼› allocBits : é€šè¿‡ bitmap æ ‡è¯†å“ªäº›ç¼–å·çš„ object æ˜¯åˆ†é…å‡ºå»çš„ï¼› gcmarkBits : ç»è¿‡ GC åï¼ŒgcmarkBits æ ‡è¯†å‡ºçš„ object å°±æ˜¯è¢« mark çš„ï¼Œæ²¡æœ‰ mark çš„å˜ä¸ºåƒåœ¾å¯¹è±¡æ¸…é™¤ï¼› sweepgen ï¼šmspan çš„çŠ¶æ€ï¼Œè§æ³¨é‡Šï¼› spanclass ï¼šmspan å¤§å°ç±»åˆ«ï¼› allocCount ï¼šå·²ç»åˆ†é…çš„ object æ•°é‡ï¼› elemsize ï¼šç®¡ç†çš„ object çš„å›ºå®šå¤§å°ï¼› å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª mspan ç®¡ç†ç€å›ºå®šå¤§å°çš„ objectï¼Œå¹¶é€šè¿‡ä¸€ä¸ª freeindex+allocCache æ¥è®°å½•ç©ºé—²çš„ object çš„ç¼–å·ã€‚ç”±æ­¤å¯ä»¥å¾—å‡ºï¼š mspan çš„åœ°å€åŒºåŸŸ: [startAddr, startAddr + npages*8*1024) æŸä¸ª object çš„èµ·å§‹åœ°å€: \u003cindex\u003e*elemsize + startAddr 4.2.1 object åˆ†é… åœ¨åˆ›å»ºæ–°çš„ object æ—¶ï¼Œå¯¹äºæ™®é€šå¤§å°çš„ object åˆ†é…ï¼ˆ16\u003csize\u003c32KB)ï¼Œä¼šåœ¨ä» mcache ä¸­é€‰å‡ºå…·æœ‰ç©ºé—²ç©ºé—´çš„ mspanï¼Œç„¶åè®°å½•åˆ° mspan.allocCache ä¸­ã€‚ å…·ä½“ä»£ç å¦‚ä¸‹ï¼ŒnextFreeIndex() å‡½æ•°å°±æ˜¯ç”¨äºå¾—åˆ°ä¸‹ä¸€ä¸ªç©ºé—² objectï¼Œå¹¶ç§»åŠ¨ freeindexï¼ˆruntime/mbitmap.go)ï¼š // nextFreeIndex returns the index of the next free object in s at // or after s.freeindex. // There are hardware instructions that can be used to make this // faster if profiling warrants it. func (s *mspan) nextFreeIndex() uintptr { sfreeindex := s.freeindex snelems := s.nelems if sfreeindex == snelems { return sfreeindex } aCache := s.allocCache bitIndex := sys.Ctz64(aCache) for bitIndex == 64 { // Move index to start of next cached bits. Â sfreeindex = (sfreeindex + 64) \u0026^ (64 - 1) if sfreeindex \u003e= snelems { s.freeindex = snelems return snelems } whichByte := sfreeindex / 8 // Refill s.allocCache with the next 64 alloc bits. Â s.refillAllocCache(whichByte) aCache = s.allocCache bitIndex = sys.Ctz64(aCache) // nothing available in cached bits Â // grab the next 8 bytes and try again. Â } result := sfreeindex + uintptr(bitIndex) if result \u003e= snelems { s.freeindex = snelems return snelems } s.allocCache \u003e\u003e= uint(bitIndex + 1) sfreeindex = result + 1 if sfreeindex%64 == 0 \u0026\u0026 sfreeindex != snelems { // We just incremented s.freeindex so it isn't 0. Â // As each 1 in s.allocCache was encountered and used for allocation Â // it was shifted away. At this point s.allocCache contains all 0s. Â // Refill s.allocCache so that it corresponds Â // to the bits at s.allocBits starting at s.freeindex. Â whichByte := sfreeindex / 8 s.refillAllocCache(whichByte) } s.freeindex = sfreeindex return result } æ³¨æ„ï¼šç›®å‰è·³è¿‡äº† â€œnextFreeFastâ€ å®ç°ï¼Œè¯¥è·å– span æ¯” â€œnextFreeâ€ æ›´å¿«ï¼Œä½¿ç”¨äº† mspan.allocCacheã€‚ 4.2.2 mspan çš„æ¸…ç† mspan.sweep() ç”¨äºè¿›è¡Œä¸€ä¸ª mspan çš„æ¸…ç†ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹æ—§ç‰ˆæœ¬çš„å®ç° mspan.oldSweep()ï¼š // Sweep frees or collects finalizers for blocks not marked in the mark phase. // It clears the mark bits in preparation for the next GC round. // Returns true if the span was returned to heap. // If preserve=true, don't return it to heap nor relink in mcentral lists; // caller takes care of it. /","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:2","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.3 mcache æ¯ä¸ª P æ‹¥æœ‰ä¸€ä¸ª mcacheï¼Œmcache ä¸­ä¿å­˜ç€å…·æœ‰ç©ºé—²ç©ºé—´çš„ mspanï¼Œç”¨äºåˆ†é… object æ—¶ï¼Œä¸éœ€è¦åŠ é”å³å¯ä» mspan åˆ†é…å¯¹è±¡ã€‚ æœ‰ä¸¤ç§ object èµ° mcache åˆ†é…ï¼š tiny objectï¼šmcache è¿˜å•ç‹¬ä½¿ç”¨ä¸€ä¸ª mspan è¿›è¡ŒéæŒ‡é’ˆå¾®å°å¯¹è±¡çš„åˆ†é…ã€‚ä¸æ™®é€š object å¯¹è±¡åˆ†é…ä¸åŒçš„æ˜¯ï¼Œtiny object ä¸æ˜¯å›ºå®šå¤§å°åˆ†é…çš„ï¼Œè€Œæ˜¯é€šè¿‡ mcache è®°å½•å…¶ offset åç§»é‡ï¼Œè®© tiny object â€œæŒ¤åœ¨â€ åŒä¸€ä¸ª mspan ä¸­ã€‚ normal objectï¼šæ™®é€šå¤§å°çš„ objectï¼Œä¼šä½¿ç”¨ mcache.alloc è¿›è¡Œåˆ†é…ã€‚mcache.alloc åŒ…å« 134 ä¸ªæ•°ç»„é¡¹ï¼ˆ67 sizeclass * 2ï¼‰ï¼Œå¯¹äºæ¯ä¸ªå¤§å°è§„æ ¼çš„ mspan æœ‰ç€ä¸¤ä¸ªç±»å‹ï¼š scanï¼šåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ noscanï¼šä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼ŒGC æ—¶æ— éœ€è¿›ä¸€æ­¥æ‰«ææ˜¯å¦å¼•ç”¨ç€å…¶ä»–æ´»è·ƒå¯¹è±¡ mcache â€œæ°¸è¿œâ€ æœ‰ç©ºé—²çš„ mspan ç”¨äº object çš„åˆ†é…ï¼Œå½“ mcache ç¼“å­˜çš„ mspan æ²¡æœ‰ç©ºé—²ç©ºé—´æ—¶ï¼Œå°±ä¼šæ‰¾ mcentral å»ç”³è¯·æ–°çš„ mspan ç”¨äºä½¿ç”¨ã€‚ æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆruntime/mcache.goï¼‰ï¼š // Per-thread (in Go, per-P) cache for small objects. // No locking needed because it is per-thread (per-P). // // mcaches are allocated from non-GC'd memory, so any heap pointers // must be specially handled. type mcache struct { // Allocator cache for tiny objects w/o pointers. Â // See \"Tiny allocator\" comment in malloc.go. // tiny points to the beginning of the current tiny block, or Â // nil if there is no current tiny block. Â // Â // tiny is a heap pointer. Since mcache is in non-GC'd memory, Â // we handle it by clearing it in releaseAll during mark Â // termination. Â tiny uintptr tinyoffset uintptr local_tinyallocs uintptr // number of tiny allocs not counted in other stats // The rest is not accessed on every malloc. alloc [numSpanClasses]*mspan // spans to allocate from, indexed by spanClass stackcache [_NumStackOrders]stackfreelist } tiny tinyoffset ï¼šç”¨äºå°å¯¹è±¡ï¼ˆ\u003c16ï¼‰çš„åˆ†é…ã€‚tiny æŒ‡å‘å½“å‰ä¸º tiny object å‡†å¤‡çš„ span çš„èµ·å§‹åœ°å€ï¼Œtinyoffset æŒ‡å‘å¯¹è±¡ä½¿ç”¨çš„åç§»åœ°å€ï¼› alloc ï¼šæœ€é‡è¦çš„å±æ€§ï¼Œä¿å­˜ç€ä¸åŒå¤§å°çš„ mspan å„ä¸€ä¸ªã€‚ç›®å‰ï¼ŒåŒ…å«å›ºå®š 64 ç±» sizeclassï¼š0ã€8 â€¦ 32768ï¼› 4.3.1 mspan çš„åˆ†é… å…ˆçœ‹ä¸‹ tiny object åˆ†é…ï¼Œåœ¨åˆ†é…ä¸€ä¸ª object æ—¶ï¼Œå¦‚æœå¤§å°å°äº 16 å­—èŠ‚æ—¶ï¼Œå°±ä¼šèµ° tiny object é€»è¾‘ã€‚ func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { if size \u003c= maxSmallSize { if noscan \u0026\u0026 size \u003c maxTinySize { off := c.tinyoffset // Align tiny pointer for required (conservative) alignment. if size\u00267 == 0 { off = alignUp(off, 8) } else if size\u00263 == 0 { off = alignUp(off, 4) } else if size\u00261 == 0 { off = alignUp(off, 2) } if off+size \u003c= maxTinySize \u0026\u0026 c.tiny != 0 { // The object fits into existing tiny block. x = unsafe.Pointer(c.tiny + off) c.tinyoffset = off + size c.local_tinyallocs++ mp.mallocing = 0 releasem(mp) return x } // Allocate a new maxTinySize block. span = c.alloc[tinySpanClass] v := nextFreeFast(span) if v == 0 { v, span, shouldhelpgc = c.nextFree(tinySpanClass) } x = unsafe.Pointer(v) (*[2]uint64)(x)[0] = 0 (*[2]uint64)(x)[1] = 0 // See if we need to replace the existing tiny block with the new one // based on amount of remaining free space. if size \u003c c.tinyoffset || c.tiny == 0 { c.tiny = uintptr(x) c.tinyoffset = size } size = maxTinySize } else { ... } } else { ... } } å¦‚æœå½“å‰ tinyoffset+size \u003c 16Bï¼ˆå› ä¸ºæ¯ä¸ª tiny span çš„å¤§å°ä¸º 32Bï¼Œè€Œæ¯ä¸ª tiny object æœ€å¤§ä¸º 16ï¼Œæ‰€ä»¥æ¯”è¾ƒ 16 å³å¯ï¼‰ï¼Œé‚£ä¹ˆè¡¨æ˜å½“å‰çš„ tiny span è‚¯å®šå¯ä»¥æ”¾ä¸‹ï¼Œé‚£ä¹ˆç§»åŠ¨ c.tinyoffset åç§»å³å¯ï¼› å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡æ–°ç”³è¯· tinySpanClass=5 çš„ spanï¼ˆ32Bï¼‰ï¼Œå¹¶æ›¿æ¢å½“å‰ c.tiny ä¸ c.tinyoffsetï¼ˆå½“å‰ object å¯ä»¥æ”¾åœ¨è€çš„ span æˆ–è€…æ–°çš„ spanï¼‰ã€‚ æ¥ç€çœ‹ä¸‹æ™®é€šå¤§å°çš„ object çš„åˆ†é…ï¼Œåœ¨å¤–å±‚å‡½æ•°è®¡ç®—å¥½ spanClass åï¼Œå°±ä¼šè°ƒç”¨ nextFree() å‡½æ•°ï¼ˆruntime/malloc.goï¼‰ï¼š // nextFree returns the next free object from the cached span if one is available. // Otherwise it refills the cache with a span with an available object and // returns that object along with a flag indicating that this was a heavy // weight allocation. If it is a heavy weight allocation the caller must // determine whether a new GC cycle needs to be started or if the GC is active // whether this goroutine needs to assist the GC. // // Must run in a non-preemptible context since otherwise the owner of // c could change. func (c *mcache) nextFree(spc spanClass) (v gclinkptr, s *mspan, shouldhelpgc bool) { s = c.alloc[spc] shouldhelpgc = false freeIndex := s.nextFreeIndex() if freeIndex == s.nelems { // The span is full. Â if uintptr(s.allocCount) != s.nelems { println(\"runtime: s.allocCount=\", s.allocCount, \"s.nelems=\", s.nelems) throw(\"s.allocCount != s.nelems \u0026\u0026 freeIndex == s.nelems\") } c.refill(spc) shouldhelpgc = true s = c.alloc[spc] freeIndex = s.nextFreeIndex() } if freeIndex \u003e= s.nele","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:3","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.4 mcentral mcentral æ˜¯å†…å­˜åˆ†é…å™¨çš„ä¸­å¿ƒç¼“å­˜ï¼Œç”¨äºç»™ mcache æä¾›ç©ºé—²çš„ mspanã€‚å› ä¸ºä¸æ˜¯ P å¯¹åº”çš„ï¼Œæ‰€ä»¥è®¿é—®ä¹Ÿéœ€è¦é”ã€‚ mheap ä¼šåˆ›å»º 64 ä¸ª sizeClass çš„ mcentralï¼Œæ¯ä¸ª mcentral ç®¡ç†ç›¸åŒå¤§å°çš„æ‰€æœ‰ mspanï¼Œä»¥ä¸¤ä¸ªé“¾è¡¨ç»“æ„ç®¡ç†ï¼š nonempty ï¼šåŒ…å«ç©ºé—²ç©ºé—´çš„ mspan ç»„æˆçš„é“¾è¡¨ï¼› empty ï¼šä¸åŒ…å«ç©ºé—²ç©ºé—´ï¼Œæˆ–è€…è¢« mcache ç”³è¯·çš„ mspan ç»„æˆçš„é“¾è¡¨ï¼ˆåˆ¤æ–­æ˜¯å¦è¢« mcache ä½¿ç”¨æ˜¯é€šè¿‡ mspan.sweepgen å±æ€§æ¥åˆ¤æ–­ï¼‰ï¼› å½“ mcache è¦ç”³è¯·æŸå¤§å°çš„ mspan æ—¶ï¼Œä¼šå›å»æŒ‡å®šå¤§å°çš„ mcentral å®ä¾‹ä¸Šç”³è¯·ã€‚ æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š // Central list of free objects of a given size. // //go:notinheap type mcentral struct { lock mutex spanclass spanClass // For !go115NewMCentralImpl. nonempty mSpanList // list of spans with a free object, ie a nonempty free list empty mSpanList // list of spans with no free objects (or cached in an mcache) â€¦ } lock ï¼šè®¿é—®éœ€è¦åŠ çš„é”ï¼› spanclass ï¼šå½“å‰ mcentral ç®¡ç†çš„ mspan å¤§å°ï¼› nonempty ï¼šåŒ…å«ç©ºé—²ç©ºé—´çš„ mspan é“¾è¡¨ï¼› empty ï¼šä¸åŒ…å«ç©ºé—²ç©ºé—´ï¼Œæˆ–è€…è¢« mcache ç”³è¯·äº†çš„ mspan é“¾è¡¨ï¼› Note æºç ä¸­å­˜åœ¨ go115NewMCentralImpl çš„æ³¨é‡Šï¼Œå¯¹ mcentral ç»“æ„åšäº†å¾ˆå¤§çš„æ”¹åŠ¨ï¼Œä½†æ˜¯åœ¨ go1.15 release é¡µé¢ä¸Šå¹¶æ²¡æœ‰çœ‹åˆ°å¯¹åº”çš„è¯´æ˜ã€‚ å…¶ commit è§ï¼šruntime: add new mcentral implementation 4.4.1 ä» mcentral ç”³è¯· mspan åœ¨ [mcache çš„è·å–](#432-mspan-çš„è·å–ï¼‰ ä¸­ï¼Œå¯ä»¥çœ‹åˆ° mcache é€šè¿‡è°ƒç”¨ mcentral.cacheSpan() ç”³è¯·æ–°çš„ç©ºé—² mspanã€‚åœ¨ go1.15 ä¸­ï¼Œå› ä¸ºæœ‰æ–°ç‰ˆ mcentral çš„å®ç°ï¼Œå› æ­¤åŒé“¾è¡¨æ–¹å¼ç§»åŠ¨åˆ°äº† mcentral.oldCacheSpan() æ–¹æ³•ä¸­ã€‚ // Allocate a span to use in an mcache. func (c *mcentral) cacheSpan() *mspan { if !go115NewMCentralImpl { return c.oldCacheSpan() } â€¦ } // Allocate a span to use in an mcache. // // For !go115NewMCentralImpl. func (c *mcentral) oldCacheSpan() *mspan { lock(\u0026c.lock) sg := mheap_.sweepgen retry: var s *mspan // èµ° nonempty é“¾è¡¨æ‰¾ for s = c.nonempty.first; s != nil; s = s.next { if s.sweepgen == sg-2 \u0026\u0026 atomic.Cas(\u0026s.sweepgen, sg-2, sg-1) { c.nonempty.remove(s) c.empty.insertBack(s) unlock(\u0026c.lock) s.sweep(true) goto havespan } if s.sweepgen == sg-1 { // the span is being swept by background sweeper, skip continue } // we have a nonempty span that does not require sweeping, allocate from it c.nonempty.remove(s) c.empty.insertBack(s) unlock(\u0026c.lock) goto havespan } // èµ° empty é“¾è¡¨æ‰¾ for s = c.empty.first; s != nil; s = s.next { if s.sweepgen == sg-2 \u0026\u0026 atomic.Cas(\u0026s.sweepgen, sg-2, sg-1) { // we have an empty span that requires sweeping, // sweep it and see if we can free some space in it c.empty.remove(s) // swept spans are at the end of the list c.empty.insertBack(s) unlock(\u0026c.lock) s.sweep(true) freeIndex := s.nextFreeIndex() if freeIndex != s.nelems { s.freeindex = freeIndex goto havespan } lock(\u0026c.lock) // the span is still empty after sweep // it is already in the empty list, so just retry goto retry } if s.sweepgen == sg-1 { // the span is being swept by background sweeper, skip continue } // already swept empty span, // all subsequent ones must also be either swept or in process of sweeping break } unlock(\u0026c.lock) // å‘ heap ç”³è¯·æ–°çš„ mspan // Replenish central list if empty. s = c.grow() if s == nil { return nil } lock(\u0026c.lock) c.empty.insertBack(s) unlock(\u0026c.lock) // At this point s is a non-empty span, queued at the end of the empty list, // c is unlocked. havespan: â€¦ freeByteBase := s.freeindex \u0026^ (64 - 1) whichByte := freeByteBase / 8 // Init alloc bits cache. s.refillAllocCache(whichByte) // Adjust the allocCache so that s.freeindex corresponds to the low bit in // s.allocCache. s.allocCache \u003e\u003e= s.freeindex % 64 return s } ä¸Šé¢é€»è¾‘å¯ä»¥å¤§è‡´åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š éå† nonempty é“¾è¡¨ï¼Œæ‰¾åˆ°å¯ç”¨çš„ mspanï¼ˆå¯¹äºéœ€è¦ sweep çš„ mspan å…ˆè¿›è¡Œ sweepï¼‰ï¼› æ²¡æ‰¾åˆ°ï¼Œéå† empty é“¾è¡¨ï¼Œä»…ä»…éå†éœ€è¦ sweep çš„ mspanï¼Œæ‰§è¡Œ sweep å¹¶åˆ¤æ–­æ˜¯å¦å¯ç”¨ï¼› è¿˜æ˜¯æ²¡æœ‰ï¼Œé€šè¿‡ mcentral.grow() å‘ mheap ç”³è¯·æ–°çš„ mspanï¼Œmheap ä¸­éƒ½æ²¡æœ‰ï¼Œreturn nilï¼› æ‰¾åˆ°ç©ºé—² mspan åï¼Œä¼šæ”¾ç½®åˆ° empty é“¾è¡¨å°¾éƒ¨ï¼Œå¹¶è¿”å›ï¼› 4.4.2 mcentral æ‰©å®¹ åœ¨ mcentral æ²¡æœ‰ä»»ä½•ç©ºé—² mspan ç»™ mcache æ—¶ï¼Œå°±ä¼šè°ƒç”¨ mcentral.grow() ç”³è¯·æ–°çš„ mspanã€‚ // grow allocates a new empty span from the heap and initializes it for c's size class. func (c *mcentral) grow() *mspan { npages := uintptr(class_to_allocnpages[c.spanclass.sizeclass()]) size := uintptr(class_to_size[c.spanclass.sizeclass()]) s := mheap_.alloc(npages, c.spanclass, true) if s == nil { return nil } // Use division by multiplication and shifts to quickly compute: // n := (npages \u003c\u003c _PageShift) / size n := (npages \u003c\u003c _PageShift) \u003e\u003e s.divShift * uintptr(s.divMul) \u003e\u003e s.divShift2 s.limit = s.base() + size*n heapBitsForAddr(s.b","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:4","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.5 mheap mheap æ˜¯æœ€æ ¸å¿ƒçš„ç»„ä»¶äº†ï¼Œruntime åªå­˜åœ¨ä¸€ä¸ª mheap å¯¹è±¡ï¼Œåˆ†é…ã€åˆå§‹åŒ– mspan éƒ½ä» mheap å¼€å§‹ã€‚ mheap ç›´æ¥ä¸è™šæ‹Ÿå†…å­˜æ‰“äº¤é“ï¼Œå¹¶å°†åœ¨è™šæ‹Ÿå†…å­˜ä¸Šåˆ›å»º mspan æä¾›ç»™ä¸Šå±‚ä½¿ç”¨ã€‚ mheap çš„åŠŸèƒ½å¯ä»¥çœ‹åšä¸¤ä¸ªæ–¹é¢ï¼š ä¸ä¸‹å±‚ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰ï¼šå†…å­˜ç®¡ç†ï¼ˆç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚ç”³è¯·è™šæ‹Ÿå†…å­˜å¾—åˆ°å¤šä¸ª heaparenaï¼Œæ¯ä¸ª heaparena å°†å¯ç”¨å†…å­˜åŒºåŸŸåˆ‡åˆ†ä¸º page å•å…ƒï¼Œä»¥å€æ•°ç»„æˆ mspan åˆ†é…ç»™ä¸Šå±‚ï¼› ä¸ä¸Šå±‚ï¼šæä¾›åˆ›å»º mspan çš„æ¥å£ã€‚é€šè¿‡ mcentral åˆ†ç±»ä¸åŒå¤§å°çš„ mspanï¼Œæˆ–è€…å¤§å†…å­˜éœ€è¦ç›´æ¥èµ° mspan åˆ†é…ï¼› å…¶æ•°æ®ç»“æ„å¾ˆå¤§ï¼Œçœç•¥äº†éƒ¨åˆ†ä¸ä¼šæåˆ°çš„å±æ€§ï¼ˆruntime/mheap.goï¼‰ï¼Œmheap_ å°±æ˜¯ heap çš„å•å®ä¾‹å¯¹è±¡ï¼š var mheap_ mheap // Main malloc heap. // The heap itself is the \"free\" and \"scav\" treaps, // but all the other global data is here too. // // mheap must not be heap-allocated because it contains mSpanLists, // which must not be heap-allocated. // //go:notinheap type mheap struct { // arenas is the heap arena map. It points to the metadata for // the heap for every arena frame of the entire usable virtual // address space. // // Use arenaIndex to compute indexes into this array. // // For regions of the address space that are not backed by the // Go heap, the arena map contains nil. // // Modifications are protected by mheap_.lock. Reads can be // performed without locking; however, a given entry can // transition from nil to non-nil at any time when the lock // isn't held. (Entries never transitions back to nil.) // // In general, this is a two-level mapping consisting of an L1 // map and possibly many L2 maps. This saves space when there // are a huge number of arena frames. However, on many // platforms (even 64-bit), arenaL1Bits is 0, making this // effectively a single-level map. In this case, arenas[0] // will never be nil. arenas [1 \u003c\u003c arenaL1Bits]*[1 \u003c\u003c arenaL2Bits]*heapArena // central free lists for small size classes. // the padding makes sure that the mcentrals are // spaced CacheLinePadSize bytes apart, so that each mcentral.lock // gets its own cache line. // central is indexed by spanClass. central [numSpanClasses]struct { mcentral mcentral pad [cpu.CacheLinePadSize - unsafe.Sizeof(mcentral{})%cpu.CacheLinePadSize]byte } pages pageAlloc // page allocation data structure spanalloc fixalloc // allocator for span* cachealloc fixalloc // allocator for mcache* specialfinalizeralloc fixalloc // allocator for specialfinalizer* specialprofilealloc fixalloc // allocator for specialprofile* speciallock mutex // lock for special record allocators. arenaHintAlloc fixalloc // allocator for arenaHints } arenas ï¼šå†…å­˜ç®¡ç†çš„å…ƒä¿¡æ¯æ•°ç»„ï¼Œå¯¹äºè™šæ‹Ÿå†…å­˜çš„é€»è¾‘åˆ‡å‰²ä¸ç®¡ç†å°±é è¿™ä¸ªæ•°ç»„äº†ï¼› central ï¼šæŒ‰ç…§å¤§å°åˆ†ç±»çš„å„ä¸ª mcentral å¯¹è±¡ï¼› pages ï¼šåœ¨ arena åŒºåŸŸä¸Šç”¨äºåˆ†é…ç©ºé—²çš„ pagesï¼Œä¾æ—§ä½¿ç”¨ç©ºé—²é“¾è¡¨ï¼› spanallocã€cachealloc ç­‰ ï¼šå„ä¸ªæ•°æ®ç»“æ„çš„ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼Œé€šè¿‡è¿æ¥ç©ºé—²çš„ mspanã€mcache ç­‰å¯¹è±¡ï¼Œè°ƒç”¨ fixalloc.alloc() å‡½æ•°å°±è·å–ä¸‹ä¸€ä¸ªç©ºé—²çš„å†…å­˜ç©ºé—´ï¼› 4.5.1 è™šæ‹Ÿå†…å­˜å¸ƒå±€ ç½‘ä¸Šå¤§éƒ¨åˆ†æ–‡ç« è¿˜æ˜¯è¯´ mheap ç®¡ç†çš„è™šæ‹Ÿå†…å­˜ä»¥ spans+bitmap+arena ç®¡ç†ï¼Œå¦‚ä¸‹å›¾ï¼š ä½†æ˜¯ä» go 1.11 å¼€å§‹ï¼ŒGo å¼€å§‹ä½¿ç¨€ç–å†…å­˜æ–¹å¼ç®¡ç†ï¼Œå³ç®¡ç†ç›¸äº’ä¹‹é—´ä¸è¿ç»­çš„è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª ã€ŠGolang è®¾è®¡ä¸å®ç°ã€‹ï¼‰ï¼š ä½¿ç”¨çš„å°±æ˜¯ mheap.arenasï¼Œä¸€ä¸ªäºŒç»´çš„ heapArena æ•°ç»„ã€‚ ä¸åŒå¹³å°çš„ heapArena ç®¡ç†çš„ arena å¤§å°ä¸åŒï¼Œåœ¨ Linux 64bit å¹³å°ä¸‹ï¼Œæ¯ä¸ª heapArena ç®¡ç†ç€ 64MB çš„ arena å†…å­˜åŒºåŸŸã€‚ // Currently, we balance these as follows: // // Platform Addr bits Arena size L1 entries L2 entries // -------------- --------- ---------- ---------- ----------- // */64-bit 48 64MB 1 4M (32MB) // windows/64-bit 48 4MB 64 1M (8MB) // */32-bit 32 4MB 1 1024 (4KB) // */mips(le) 31 4MB 1 512 (2KB) Note è¿™é‡Œä¸å¤ªå¥½ç†è§£ï¼Œä½†æ˜¯æˆ‘è§‰å¯ä»¥ç®€å•ç†è§£å°±æ˜¯ï¼Œå°†åŸæ¥çš„ spans+bitmap+arena ç®¡ç†æ–¹å¼ï¼Œå˜ä¸ºäº†å¤šä¸ª spans+bitmap+arena å®ç°ã€‚è€Œä¸åŒ arena ä¹‹é—´çš„åœ°å€ä¸æ˜¯è¿ç»­çš„ã€‚ ä½†æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨äºŒç»´æ•°ç»„ï¼Ÿç›®å‰ä¸çŸ¥é“ï¼Œä½†æ˜¯ Linux x86-64 æ¶æ„ä¸Šä¸€ç»´æ•°ç»„å¤§å°ä¸º 1ï¼Œå°±æ˜¯ç›¸å½“äº 1 ç»´æ•°ç»„ã€‚ heapArena æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆruntime/mheap.goï¼‰ï¼š // A heapArena stores metadata for a heap arena. heapArenas are stored // outside of the Go heap and accessed via the mheap_.arenas index. // //go:notinheap type heapArena struct { // bitmap stores the pointer/scalar bitmap for the words in // this arena. See mbitmap.go for a description. Use the // heapBits type to access this. bitmap [heapArenaBitmapBytes]byte // spans maps from virtual address page ID within this arena to *mspan. // For allocated spans, their pages map to the span itself. // For free spans, only the lowest and highest pages map to the span itself. // Internal pages map to an arbitrary span. // For pages that have never been allocated, spans entries are nil. // // Modifications are protected by m","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:5","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"4.6 æ€»ç»“ ç²—ç•¥åœ°çœ‹å®Œæ•´ä¸ªå†…å­˜æ¨¡å‹åï¼Œå¤§æ¦‚å†…å­˜çš„ç»“æ„å¦‚ä¸‹ï¼š å…¶ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„å°±æ˜¯ï¼šå†…å­˜è¢«åˆ‡åˆ†ä¸º pageï¼Œå¤šä¸ª page ç»„æˆä¸åŒå¤§å°çš„ mspanï¼Œè€Œåœ¨ mspan ä¸Šåˆåˆ†å‰²ä¸ºå›ºå®šå¤§å°çš„ objectã€‚ è€Œä¸Šå±‚çš„ mcacheã€mcentral åªæ˜¯ä»¥ä¸åŒçš„æ–¹å¼ç»„ç»‡ mspanï¼Œé€šè¿‡å¤šçº§ç¼“å­˜çš„æ€æƒ³ï¼Œä½¿å¾—å¹¶å‘çš„è·å–ä¸€ä¸ªå¯ç”¨çš„ mspan æ›´å¿«ã€‚ mcache å°†ä¸€éƒ¨åˆ† mspan ç‹¬ç«‹äº P æ‰€æœ‰ï¼Œä½¿å¾—ä¸éœ€è¦åŠ é”æ—¢å¯ä»¥è·å– mspanï¼› mcentral ä»¥å¤§å°æ¥åˆ†ç±» mspanï¼Œå°†å„ä¸ªå¤§å°çš„ mspan è¯·æ±‚ç‹¬ç«‹ï¼Œç¼©å°äº†é”çš„ç²’åº¦ï¼› mheap ä½œä¸ºæœ€åº•å±‚ï¼Œå°±å¥½åƒæ–‡ä»¶ç³»ç»Ÿä¸€æ ·ï¼Œç®¡ç†ç€æ•´ä¸ªå†…å­˜åˆ†é…çš„éª¨æ¶ã€‚è€Œä¸ä¸Šå±‚çš„äº¤äº’å°±æ˜¯é  mspan ä½œä¸ºå•ä½ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:4:6","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"5 å¯¹è±¡åˆ†é…æµç¨‹ å‰é¢ä¸€ç›´æåˆ°çš„ï¼Œå¯¹è±¡çš„åˆ†é…åˆ†ä¸ºä¸‰ç±»ï¼š tiny object (0, 16B): ä½¿ç”¨ tiny allocator åˆ†é…ï¼Œä½¿ç”¨ mcahe ä¸€ä¸ªç‹¬ç«‹çš„ mspanï¼ŒæŒ¤å‹å¼çš„ï¼› object [16B, 32KB]: ä½¿ç”¨ mcache åˆ†é…ï¼› large object (32KB, +âˆ): ç›´æ¥é€šè¿‡ mheap åˆ†é…ï¼› æ‰€æœ‰çš„åˆ†é…é€»è¾‘åœ¨ mallocgc() å¼€å§‹åˆ†å‰ï¼Œä¸‹é¢åˆ†åˆ«çœ‹ä¸‹å…·ä½“çš„åˆ†é…ä»£ç ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:5:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"5.1 tiny object åˆ†é… tiny object åˆ†é…çš„ä»£ç åœ¨ mspan åˆ†é…ä¸­å·²ç»è¯´æ˜äº†ï¼Œè¿™é‡Œå†ç†ä¸€ä¸‹å¤§è‡´æ­¥éª¤ï¼š ä¸åŒ…å«æŒ‡é’ˆ (noscan) å¹¶ä¸”å°äº 16B çš„å¯¹è±¡æ‰èµ°å¾®å°å¯¹è±¡åˆ†é…ï¼› tiny object åˆ†é…ä»…ä»…æ˜¯å¢å¤§ mcache.tinyoffset çš„å€¼ï¼Œæ‰€ä»¥æ˜¯ä¸åŒå¤§å° tiny object æŒ¤å‹åœ¨ä¸€ä¸ª mspan ä¸­ï¼› å¦‚æœå½“å‰çš„ mspan æ²¡æœ‰ç©ºé—´äº†ï¼Œé€šè¿‡ mcache.nextFree() æ¥è·å–æ–°çš„æŒ‡å®šå¤§å°çš„ mspanï¼Œè€Œè·å–çš„æµç¨‹å°±æ˜¯å‰é¢æ‰€è¯´çš„ï¼ˆèµ° mcentral-\u003emheap); ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:5:1","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"5.2 object åˆ†é… æ™®é€šå¤§å° object åˆ†é…æµç¨‹å°±å¾ˆç®€å•äº†ï¼š func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { if size \u003c= maxSmallSize { if noscan \u0026\u0026 size \u003c maxTinySize { ... } else { var sizeclass uint8 if size \u003c= smallSizeMax-8 { sizeclass = size_to_class8[divRoundUp(size, smallSizeDiv)] } else { sizeclass = size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)] } size = uintptr(class_to_size[sizeclass]) spc := makeSpanClass(sizeclass, noscan) span = c.alloc[spc] v := nextFreeFast(span) if v == 0 { v, span, shouldhelpgc = c.nextFree(spc) } x = unsafe.Pointer(v) if needzero \u0026\u0026 span.needzero != 0 { memclrNoHeapPointers(unsafe.Pointer(v), size) } } } else { ... } } è®¡ç®—å‡ºå¯¹åº”çš„ sizeclassï¼› ä» mcache.alloc[] å¾—åˆ°å¯¹åº”çš„ mspanã€‚å¦‚æœæ²¡æœ‰ï¼Œé€šè¿‡ nextFree() ç”³è¯·ï¼› è°ƒç”¨ memclrNoHeapPointers() æ¸…ç†ç©ºé—²å†…å­˜ä¸­æ‰€æœ‰æ•°æ®ï¼› ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:5:2","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"5.3 large object åˆ†é… func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { if size \u003c= maxSmallSize { if noscan \u0026\u0026 size \u003c maxTinySize { ... } else { ... } } else { shouldhelpgc = true systemstack(func() { span = largeAlloc(size, needzero, noscan) }) span.freeindex = 1 span.allocCount = 1 x = unsafe.Pointer(span.base()) size = span.elemsize } } func largeAlloc(size uintptr, needzero bool, noscan bool) *mspan { // print(\"largeAlloc size=\", size, \"\\n\") if size+_PageSize \u003c size { throw(\"out of memory\") } npages := size \u003e\u003e _PageShift if size\u0026_PageMask != 0 { npages++ } // Deduct credit for this span allocation and sweep if // necessary. mHeap_Alloc will also sweep npages, so this only // pays the debt down to npage pages. deductSweepCredit(npages*_PageSize, npages) spc := makeSpanClass(0, noscan) s := mheap_.alloc(npages, spc, needzero) if s == nil { throw(\"out of memory\") } if go115NewMCentralImpl { // Put the large span in the mcentral swept list so that it's // visible to the background sweeper. mheap_.central[spc].mcentral.fullSwept(mheap_.sweepgen).push(s) } s.limit = s.base() + size heapBitsForAddr(s.base()).initSpan(s) return s } large object ä¼šåˆ‡æ¢åˆ°ç³»ç»Ÿæ ˆï¼Œç„¶åèµ° mheap ç”³è¯·ï¼› è®¡ç®—å¯¹è±¡éœ€è¦çš„ page æ•°é‡ï¼Œç„¶åè°ƒç”¨ mheap.alloc() ç”³è¯·ç©ºé—²çš„ mspanï¼› è€Œ mheap.alloc() å°±æ˜¯ mcentral ç”³è¯· mspan çš„æ–¹æ³•ã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:5:3","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"6 å†…å­˜çš„é‡Šæ”¾ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:6:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"6.1 é‡Šæ”¾æ“ä½œ å‰é¢ 4.5.4 mheap å›æ”¶ mspan ä¸­çœ‹åˆ°ï¼Œmheap ä¸ä¼šçœŸæ­£çš„é‡Šæ”¾å†…å­˜ï¼Œè€Œæ˜¯ç­‰å¾…å…¶è¢«å¤ç”¨ã€‚ä½†æ˜¯ä¸å¯èƒ½ä¸€ç›´æ‰©å±•å†…å­˜ï¼Œè€Œä¸é‡Šæ”¾ã€‚ é‡Šæ”¾å†…å­˜ç”± mheap.page çš„ pageAlloc.scavenge() å‡½æ•°è´Ÿè´£ï¼ˆruntime/mgcscavenge.goï¼‰: // scavenge scavenges nbytes worth of free pages, starting with the // highest address first. Successive calls continue from where it left // off until the heap is exhausted. Call scavengeStartGen to bring it // back to the top of the heap. // // Returns the amount of memory scavenged in bytes. // // s.mheapLock must be held, but may be temporarily released if // mayUnlock == true. // // Must run on the system stack because s.mheapLock must be held. // //go:systemstack func (s *pageAlloc) scavenge(nbytes uintptr, mayUnlock bool) uintptr { var ( addrs addrRange gen uint32 ) released := uintptr(0) for released \u003c nbytes { if addrs.size() == 0 { // é€šè¿‡æ ‡è®°é€‰å‡ºä¸€éƒ¨åˆ†éœ€è¦é‡Šæ”¾çš„å†…å­˜åŒºåŸŸ if addrs, gen = s.scavengeReserve(); addrs.size() == 0 { break } } // é‡Šæ”¾å†…å­˜ r, a := s.scavengeOne(addrs, nbytes-released, mayUnlock) released += r addrs = a } // Only unreserve the space which hasn't been scavenged or searched // to ensure we always make progress. s.scavengeUnreserve(addrs, gen) return released } é‡Šæ”¾çš„æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ²¡æœ‰ç ”ç©¶è¿‡çœ‹ä¸æ‡‚ï¼Œç›®å‰çŸ¥é“ä¸‹æœ€åä¼šè°ƒç”¨ sysUnused() å‡½æ•°é‡Šæ”¾ï¼ˆruntime/mem_linux.goï¼‰ï¼š func sysUnused(v unsafe.Pointer, n uintptr) { // huge page å¤„ç† ... var advise uint32 if debug.madvdontneed != 0 { advise = _MADV_DONTNEED } else { advise = atomic.Load(\u0026adviseUnused) } if errno := madvise(v, n, int32(advise)); advise == _MADV_FREE \u0026\u0026 errno != 0 { // MADV_FREE was added in Linux 4.5. Fall back to MADV_DONTNEED if it is // not supported. atomic.Store(\u0026adviseUnused, _MADV_DONTNEED) madvise(v, n, _MADV_DONTNEED) } } é€šè¿‡ç³»ç»Ÿè°ƒç”¨ madvise() å‘ŠçŸ¥æ“ä½œç³»ç»ŸæŸæ®µå†…å­˜ä¸é€‚ç”¨ï¼Œå»ºè®®å†…æ ¸å›æ”¶å¯¹åº”ç‰©ç†å†…å­˜ã€‚ å½“ç„¶ï¼Œå†…æ ¸åœ¨ç‰©ç†å†…å­˜å……è¶³æƒ…å†µä¸‹å¯èƒ½ä¸ä¼šå®é™…å›æ”¶å†…å­˜ï¼Œä»¥å‡å°‘æ— è°“çš„å›æ”¶æ¶ˆè€—ã€‚ è€Œå½“å†æ¬¡ä½¿ç”¨æ­¤å†…å­˜å—æ—¶ï¼Œä¼šå¼•å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨é‡æ–°å…³è”ç‰©ç†å†…å­˜é¡µã€‚ ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:6:1","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"6.2 é‡Šæ”¾æ—¶æœº scavenge() æœ‰ä¸¤ä¸ªåœ°æ–¹ä¼šè¢«è°ƒç”¨ï¼š å‘¨æœŸæ€§çš„è§¦å‘ï¼ˆæ¯ 5 min?ï¼‰ï¼› mheap æ‰©å®¹æ—¶ æˆ–è€… è°ƒç”¨ runtime/debug.FreeOSMemory() ä¸»åŠ¨è§¦å‘ï¼› ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:6:2","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Golang"],"content":"å‚è€ƒ ã€ŠGolang å­¦ä¹ ç¬”è®°ã€‹ Blogï¼šGo å†…å­˜ç®¡ç†å¯è§†åŒ– ã€ŠGolang è®¾è®¡ä¸å®ç°ã€‹ï¼šå†…å­˜åˆ†é…å™¨ çŸ¥ä¹ï¼šå›¾è§£ Go è¯­è¨€å†…å­˜åˆ†é… ","date":"2021-01-05","objectID":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/:7:0","tags":["Golang","Golang åŸç†"],"title":"Go å†…å­˜ç®¡ç†æ€»ç»“","uri":"/posts/language/golang/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["VM"],"content":"æ€»ç»“ KVM è™šæ‹Ÿæœºä½¿ç”¨å­˜å‚¨ä¸ç½‘ç»œçš„æ–¹å¼","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡ä¸»è¦æ€»ç»“ä¸€äº›é‡åˆ°çš„è™šæ‹Ÿæœºä½¿ç”¨å­˜å‚¨ä¸ç½‘ç»œçš„æ–¹å¼ï¼ŒæŒ–äº†è®¸å¤šå‘ï¼Œä¸æ–­è¡¥å……ä¸­ã€‚ ä¸‹é¢æ‰€æœ‰çš„è™šæ‹Ÿæœºå¯åŠ¨éƒ½ä½¿ç”¨ libvirtï¼Œé€šè¿‡ä¿®æ”¹å…¶é…ç½®æ–‡ä»¶æ¥è®¾ç½®ç½‘ç»œæˆ–è€…å­˜å‚¨ï¼Œçœç•¥äº†è™šæ‹Ÿæœºçš„å¯åŠ¨ã€åœæ­¢ç­‰æ“ä½œå‘½ä»¤ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:0:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"1 virtio æ¦‚è¿° KVM åœ¨ IO è™šæ‹ŸåŒ–æ–¹é¢ï¼Œä¼ ç»Ÿçš„æ–¹å¼æ˜¯ä½¿ç”¨ QEMU çº¯è½¯ä»¶æ–¹å¼æ¨¡æ‹Ÿç½‘å¡ã€ç£ç›˜ã€‚ KVM ä¸­ï¼Œå¯ä»¥åœ¨å®¢æˆ·æœºä½¿ç”¨ åŠè™šæ‹ŸåŒ–é©±åŠ¨Paravirtualized Drivers æ¥æé«˜å®¢æˆ·æœºæ€§èƒ½ã€‚ ç›®å‰ï¼Œé‡‡ç”¨çš„æ˜¯ virtio è¿™ä¸ªè®¾å¤‡é©±åŠ¨æ ‡å‡†æ¡†æ¶ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:1:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"1.1 å…¨æ¨¡æ‹Ÿ I/O è®¾å¤‡åŸºæœ¬åŸç† çº¯è½¯ä»¶æ¨¡æ‹Ÿ I/O å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å®¢æˆ·æœºä¸­è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆDevice Driverï¼‰å‘èµ· I/O æ“ä½œè¯·æ±‚æ—¶ï¼ŒKVM å†…æ ¸æ¨¡å—ä¼šæ‹¦æˆªè¿™æ¬¡è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚ä¿¡æ¯æ”¾åˆ° I/O å…±äº«é¡µï¼ˆsharing pageï¼‰ï¼› KVM æ¨¡å—é€šçŸ¥ç”¨æˆ·ç©ºé—´ QEMU ç¨‹åºï¼ˆå®¢æˆ·æœºå¯¹åº” qemu è¿›ç¨‹çš„ä¸€ä¸ªçº¿ç¨‹ï¼‰æœ‰ I/O è¯·æ±‚ï¼› QEMU æ¨¡æ‹Ÿç¨‹åºæ ¹æ® I/O è¯·æ±‚ä¿¡æ¯ï¼Œäº¤ç”±ç¡¬ä»¶æ¨¡æ‹Ÿä»£ç ï¼ˆEmulation Codeï¼‰æ¨¡æ‹Ÿ I/O è¯·æ±‚ï¼Œé˜»å¡ç­‰å¾… I/O ç»“æœï¼› å¦‚æœæ˜¯æ™®é€šçš„ I/O è¯·æ±‚å®Œæˆåï¼Œå°†ç»“æœæ”¾å›åˆ° I/O å…±äº«é¡µï¼› å¦‚æœå®¢æˆ·æœºæ˜¯é€šè¿‡ DMA è®¿é—®å¤§å— I/O æ—¶ï¼ŒQEMU æ¨¡æ‹Ÿç¨‹åºä¼šç›´æ¥é€šè¿‡å†…å­˜æ˜ å°„çš„å°†ç»“æœç›´æ¥å†™åˆ°å®¢æˆ·æœºå†…å­˜ä¸­ï¼Œå¹¶é€šçŸ¥ KVM æ¨¡å—å®¢æˆ·æœº DMA æ“ä½œå·²ç»å®Œæˆï¼› KVM å†…æ ¸æ¨¡å—è¯»å– I/O å…±äº«é¡µä¸­ç»“æœï¼Œå°†ç»“æœè¿”å›ç»™å®¢æˆ·æœºï¼› æˆ–è€…ï¼Œæ¥å—åˆ° QEMU é€šçŸ¥ï¼Œé€šçŸ¥å®¢æˆ·æœº DMA æ“ä½œå·²ç»å®Œæˆï¼› QEMU æ¨¡æ‹Ÿ I/O è®¾å¤‡çš„ä¼˜ç‚¹ï¼šå¯ä»¥é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿå‡ºå„ç§è®¾å¤‡ï¼Œå…¼å®¹æ€§å¥½ã€‚ä½†æ˜¯ä¹Ÿæœ‰æ˜æ˜¾ç¼ºç‚¹ï¼šæ¯æ¬¡ I/O æ“ä½œæ¯”è¾ƒé•¿ï¼Œæœ‰è¾ƒå¤šçš„ VMEntryã€VMExit å‘ç”Ÿï¼Œéœ€è¦å¤šæ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸æ•°æ®å¤åˆ¶ï¼Œæ€§èƒ½å¾ˆå·®ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:1:1","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"1.2 virtio åŸºæœ¬åŸç† virtio æ˜¯ä¸€ä¸ªåœ¨ Hypervisor ä¸ŠæŠ½è±¡ API æ¥å£ï¼Œè®©å®¢æˆ·æœºçŸ¥é“è¿è¡Œä¸è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ï¼Œè¿›è€Œæ ¹æ® virtio æ ‡å‡†ä¸ Hypervisor åä½œï¼Œä»è€Œåœ¨å®¢æˆ·æœºè¾¾åˆ°æ›´å¥½æ€§èƒ½ã€‚ å…¶ virtio åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š å‰ç«¯é©±åŠ¨fronded æ˜¯åœ¨å®¢æˆ·æœºä¸­çš„é©±åŠ¨æ¨¡å—ï¼Œå¦‚ virtio-blkã€virtio-net ç­‰ï¼› åç«¯å¤„ç†ç¨‹åºbackend åœ¨ QEMU ä¸­å®ç°ï¼Œæ‰§è¡Œå…·ä½“çš„ I/O æ“ä½œï¼› virtio æ˜¯è™šæ‹Ÿé˜Ÿåˆ—æ¥å£ï¼Œåœ¨é€»è¾‘ä¸Šå°†å‰ç«¯é©±åŠ¨é™„åŠ åˆ°åç«¯å¤„ç†ç¨‹åºï¼Œè™šæ‹Ÿé˜Ÿåˆ—å®é™…ä¸Šè¢«å®ç°ä¸ºè·¨è¶Šå®¢æˆ·æœºæ“ä½œç³»ç»Ÿå’Œ Hypervisor çš„è¡”æ¥ç‚¹ï¼Œè¯¥è¡”æ¥ç‚¹å¯ä»¥ç”¨ä»»æ„æ–¹å¼å®ç°ï¼Œå‰ææ˜¯å‰åç«¯éƒ½éµå¾ªæ ‡å‡†å®ç°ã€‚ ä¸€ä¸ªå‰ç«¯é©±åŠ¨å¯ä»¥æœ‰ 0 æˆ–å¤šä¸ªé˜Ÿåˆ—ï¼Œä¾‹å¦‚ virtio-net ä½¿ç”¨ä¸¤ä¸ªè™šæ‹Ÿé˜Ÿåˆ—ï¼ˆæ¥å—+å‘é€ï¼‰ã€‚ virtio-ring å®ç°äº†ç¯å½¢ç¼“å†²åŒºï¼ˆring bufferï¼‰ï¼Œç”¨äºä¿å­˜å‰ç«¯é©±åŠ¨å’Œåç«¯å¤„ç†ç¨‹åºæ‰§è¡Œçš„ä¿¡æ¯ã€‚ ç¯å½¢ç¼“å†²åŒºå¯ä»¥ä¸€æ¬¡æ€§ä¿å­˜å‰ç«¯é©±åŠ¨å¤šä¸ª I/O è¯·æ±‚ï¼Œå¹¶äº¤ç”±åç«¯é©±åŠ¨æ‰¹é‡å¤„ç†ï¼Œæœ€åå®é™…è°ƒç”¨å®¿ä¸»æœºè®¾å¤‡é©±åŠ¨å®ç°çš„è®¾å¤‡ I/O æ“ä½œï¼Œä»¥æå‡æ•ˆç‡ã€‚ virtio çš„æ€§èƒ½å¾ˆå¥½ï¼Œä¸€èˆ¬éƒ½æ¨èä½¿ç”¨ virtioã€‚ä½†æ˜¯ï¼Œvirtio è¦æ±‚å®¢æˆ·æœºå¿…é¡»å®‰è£…ç‰¹å®šçš„ virtio é©±åŠ¨ï¼Œå¹¶ä¸”æŒ‰ç…§ virtio è§„å®šæ ¼å¼ä¼ è¾“æ•°æ®ï¼Œä¸€äº›è€çš„ Linux ç³»ç»Ÿå¯èƒ½ä¸æ”¯æŒã€‚ åœ¨å®¢æˆ·æœºä¸­æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ virtio ç›¸å…³å†…æ ¸æ¨¡å—ï¼Œä»¥ç¡®å®šç³»ç»Ÿæ˜¯å¦æ”¯æŒ virtioï¼š [root@kvm-guest ~]# lsmod | grep virtio virtio_net 28024 0 virtio_pci 22913 0 virtio_ring 21524 2 virtio_net,virtio_pci virtio 15008 2 virtio_net,virtio_pci å…¶ä¸­ï¼Œvirtioã€virtio_ringã€virtio_pci ç­‰é©±åŠ¨æä¾›å¯¹ virtio API æ”¯æŒï¼Œä»»ä½• virtio å‰ç«¯é©±åŠ¨éƒ½å¿…é¡»ä½¿ç”¨ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:1:2","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"1.3 vhost æ­£å¦‚ å‰é¢æ‰€è¿°ï¼Œvirtio åˆ†ä¸ºå‰åç«¯ï¼Œè€Œåç«¯é»˜è®¤ä¸ºç”¨æˆ·ç©ºé—´çš„ QEMU è¿›ç¨‹ã€‚ç”± QEMU è¿›ç¨‹æ¨¡æ‹Ÿè™šæ‹Ÿæœºçš„å‘½ä»¤ï¼Œåœ¨å°†ç»“æœè¿”å›ç»™è™šæ‹Ÿæœºã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå­˜åœ¨ç€ä¸€æ¬¡ ç”¨æˆ·ç©ºé—´è‡³å†…æ ¸ç©ºé—´çš„è½¬æ¢ã€‚ è€Œ vhost å‡ºç°å°±æ˜¯ç”¨äºä¼˜åŒ–è¿™ä¸€æ¬¡çš„è½¬æ¢ã€‚vhost æ˜¯å®¿ä¸»æœºä¸­çš„ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œç”¨äºå’Œè™šæ‹Ÿæœºç›´æ¥è¿›è¡Œé€šä¿¡ï¼Œä¹Ÿæ˜¯é€šè¿‡ virtio æä¾›çš„æ•°æ®é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ã€‚ ç›®å‰ï¼Œç½‘ç»œæ”¯æŒæœ‰ vhost-netï¼Œå—è®¾å¤‡æ”¯æŒæœ‰ vhost-blkï¼Œå®ƒä»¬éƒ½ä¾èµ–äºåŸºç¡€çš„å†…æ ¸æ¨¡å— vhostã€‚ $ lsmod | grep vhost vhost_net 28672 1 vhost 53248 1 vhost_net vhost_iotlb 16384 1 vhost ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:1:3","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"1.4 æ€»ç»“ é¦–å…ˆï¼Œéœ€è¦æ˜ç™½ virtio ä¸ºä»€ä¹ˆæ¯”çº¯æ¨¡æ‹Ÿçš„æ–¹å¼å¿«ï¼Ÿ æœ€ä¸»è¦å› ä¸ºçº¯æ¨¡æ‹Ÿçš„æ–¹å¼å­˜åœ¨å¤šæ¬¡å†…æ ¸ KVM ä¸ç”¨æˆ·ç©ºé—´ QEMU è¿›ç¨‹çš„æ•°æ®äº¤äº’ï¼Œç®€å•ç‚¹è¯´ï¼Œå®¢æˆ·æœºéœ€è¦ KVM è¿›è¡Œæ•°æ®çš„ä¸­è½¬ã€‚ è€Œ virtio æ¶ˆé™¤äº† KVM è¿›è¡Œæ•°æ®çš„ä¸­è½¬ï¼Œé€šè¿‡ä¸€å¥—æ ‡å‡†æ¡†æ¶å®ç°è™šæ‹Ÿæœºä¸ QEMU è¿›ç¨‹çš„ç›´æ¥ä¿¡æ¯äº¤äº’ã€‚ä¹Ÿæ˜¯å› æ­¤ï¼Œè™šæ‹Ÿæœºéœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„ virtio ç›¸å…³çš„é©±åŠ¨ï¼Œä¹Ÿå°±çŸ¥é“äº†è‡ªå·±å¤„äºè™šæ‹ŸåŒ–ç¯å¢ƒï¼Œæ‰€ä»¥æ˜¯åŠè™šæ‹ŸåŒ–ã€‚ å…¶æ¬¡ï¼Œéœ€è¦æ˜ç¡®ï¼Œvirtio ç”±å‰åç«¯ç»„æˆï¼Œå…¶ä¸­åç«¯æ˜¯ç”± QEMU å®ç°çš„ï¼Œç›®å‰ä¸»æµçš„ QEMU ç‰ˆæœ¬éƒ½å®ç°äº†ï¼Œä¸éœ€è¦ careã€‚è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvirtio çš„å‰ç«¯æ˜¯è¦åœ¨è™šæ‹Ÿæœºä¸­æ»¡è¶³ï¼Œä¹Ÿå°±æ˜¯ç›¸å…³çš„ virtio é©±åŠ¨ï¼Œè¿™åœ¨ä½¿ç”¨æ—¶éœ€è¦è¿›è¡Œç¡®è®¤ã€‚ è€Œ virtio çš„é€šä¿¡æ–¹å¼ä¸­ï¼Œè¿˜å­˜åœ¨ QEMU æ¨¡æ‹Ÿå‘½ä»¤æ‰§è¡Œè¿™ä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œå› æ­¤ï¼Œvhost å‡ºç°ä¼˜åŒ–äº†è¿™ä¸€æ¬¡çš„ç”¨æˆ·ç©ºé—´è‡³å†…æ ¸ç©ºé—´çš„åˆ‡æ¢ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:1:4","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"2 è®¾å¤‡ç›´æ¥åˆ†é… ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:2:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"2.1 PCI è®¾å¤‡ç›´æ¥åˆ†é… PCI è®¾å¤‡ç›´æ¥åˆ†é… å…è®¸å°†å®¿ä¸»æœºçš„ç‰©ç† PCIï¼ˆæˆ– PCI-Eï¼‰è®¾å¤‡ç›´æ¥åˆ†é…ç»™å®¢æˆ·æœºå®Œå…¨ä½¿ç”¨ã€‚ è®¾å¤‡ç›´æ¥åˆ†é…ç›¸å½“äºè™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨ç¡¬ä»¶è®¾å¤‡ï¼Œä¹Ÿå°±æ²¡æœ‰äº† QEMU è¿›ç¨‹çš„æ¨¡æ‹Ÿï¼Œå› æ­¤é€Ÿåº¦æœ€å¿«ã€‚ ä½†æ˜¯ï¼Œè®¾å¤‡ç›´æ¥åˆ†é…æœ‰ä¸€äº›æ¡ä»¶ï¼š ç¡¬ä»¶å¹³å°éœ€è¦æ”¯æŒ Intel ç¡¬ä»¶æ”¯æŒè®¾å¤‡ç›´æ¥åˆ†é…è§„èŒƒä¸º â€œIntel(R)Virtualization Technology for Directed I/Oâ€ï¼ˆVT-dï¼‰æˆ–è€… AMD çš„è§„èŒƒä¸º â€œAMD-Viâ€ï¼ˆä¹Ÿå«ä½œ IOMMUï¼‰ã€‚ ç›®å‰å¸‚é¢ä¸Šçš„ x86 ç¡¬ä»¶å¹³å°åŸºæœ¬éƒ½æ”¯æŒ VT-dï¼Œåœ¨ BIOS ä¸­è®¾ç½®æ‰“å¼€ VT-d ç‰¹æ€§ã€‚ å†…æ ¸é…ç½®æ”¯æŒç›¸å…³ VT-d çš„ç‰¹æ€§ï¼Œå¹¶ä¸”åŠ è½½å†…æ ¸æ¨¡å— vfio-pciï¼ˆå†…æ ¸ \u003e= 3.10ï¼‰ã€‚ å†…æ ¸å¯åŠ¨å‚æ•°éœ€è¦æ‰“å¼€ intel_iommu=onï¼ˆintel å¹³å°ï¼‰ $ modprobe vfio_pci $ lsmod | grep vfio vfio_pci 53248 0 vfio_virqfd 16384 1 vfio_pci vfio_iommu_type1 32768 0 vfio 36864 2 vfio_iommu_type1,vfio_pci irqbypass 16384 8 vfio_pci,kvm ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:2:1","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"2.2 SR-IOV VT-d æŠ€æœ¯åªèƒ½è®²ä¸€ä¸ªç‰©ç†è®¾å¤‡åˆ†é…ç»™ä¸€ä¸ªå®¢æˆ·æœºä½¿ç”¨ï¼Œä¸ºäº†è®©å¤šä¸ªè™šæ‹Ÿæœºå…±äº«åŒä¸€ä¸ªç‰©ç†è®¾å¤‡ï¼ŒPCI_SIG ç»„ç»‡å‘å¸ƒäº† SR-IOVSingle Root I/O Virtualizaiton and Sharing è§„èŒƒï¼Œè¯¥è§„èŒƒå®šä¹‰äº†æ ‡å‡†åŒ–æœºåˆ¶ï¼Œç”¨ä»¥åŸç”Ÿçš„æ”¯æŒå¤šä¸ªå…±äº«çš„è®¾å¤‡ï¼ˆä¸ä¸€å®šç½‘å¡ï¼‰ã€‚ ç›®å‰ï¼ŒSR-IOV æœ€å¹¿æ³›åº”ç”¨åœ¨ä»¥å¤ªç½‘è®¾å¤‡çš„è™šæ‹ŸåŒ–æ–¹é¢ã€‚ SR-IOV å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„ functionï¼š PF ç‰©ç†åŠŸèƒ½Physical Function ï¼šPF æ˜¯ä¸€ä¸ªæ™®é€šçš„ PCI-e è®¾å¤‡ï¼ˆå¸¦æœ‰ SR-IOV åŠŸèƒ½ï¼‰ï¼Œåœ¨å®¿ä¸»æœºä¸­é…ç½®å’Œç®¡ç†å…¶ä»– VFï¼Œæœ¬èº«ä¹Ÿå¯ä»¥ä½œä¸ºç‹¬ç«‹ function ä½¿ç”¨ï¼› VF è™šæ‹ŸåŠŸèƒ½Virtual Function ï¼šç”± PF è¡ç”Ÿçš„ â€œè½»é‡çº§â€ PCI-e åŠŸèƒ½ï¼Œå¯ä»¥åˆ†é…åˆ°å®¢æˆ·æœºä¸­ä½œä¸ºç‹¬ç«‹ function ä½¿ç”¨ï¼› SR-IOV ä¸ºå®¢æˆ·æœºä¸­ä½¿ç”¨çš„ VF æä¾›äº†ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€ä¸­æ–­ã€DMA æµï¼Œä»è€Œä¸éœ€è¦ Hypervisor ä»‹å…¥æ•°æ®ä¼ è¾“ã€‚ ä¸€ä¸ªå…·æœ‰ SR-IOV åŠŸèƒ½çš„è®¾å¤‡èƒ½å¤Ÿè¢«é…ç½®ä¸º PCI é…ç½®ç©ºé—´ä¸­å‘ˆç°å‡ºå¤šä¸ª Functionï¼ˆ1 ä¸ª PF + å¤šä¸ª VFï¼‰ï¼Œæ¯ä¸ª VF æœ‰ç‹¬ç«‹çš„é…ç½®ç©ºé—´å’Œå®Œæ•´çš„ BARï¼ˆBase Address Registerï¼ŒåŸºå€å¯„å­˜å™¨ï¼‰ã€‚ Hypervisor é€šè¿‡å°† VF å®é™…çš„é…ç½®ç©ºé—´æ˜ å°„åˆ°å®¢æˆ·æœºçœ‹åˆ°çš„é…ç½®ç©ºé—´çš„æ–¹å¼ï¼Œå°†ä¸€ä¸ªæˆ–å¤šä¸ª VF åˆ†é…ç»™ä¸€ä¸ªå®¢æˆ·æœºã€‚å¹¶ä¸”ï¼Œé€šè¿‡ Intel VT-x å’Œ VT-d ç­‰ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯æä¾›çš„å†…å­˜è½¬æ¢æŠ€æœ¯ï¼Œå…è®¸ç›´æ¥çš„ DMA ä¼ è¾“å»å¾€æˆ–æ¥è‡ªä¸€ä¸ªå®¢æˆ·æœºï¼Œå› æ­¤å‡ ä¹ä¸éœ€è¦ Hypervisor çš„å‚ä¸ã€‚ åœ¨å®¢æˆ·æœºä¸­çœ‹åˆ°çš„ VFï¼Œè¡¨ç°ç»™å®¢æˆ·æœºæ“ä½œç³»ç»Ÿçš„å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ™®é€šçš„è®¾å¤‡ã€‚ SR-IOV éœ€è¦ç¡¬ä»¶å¹³å°æ”¯æŒ Intel VT-x å’Œ VT-dï¼ˆæˆ– AMD çš„ SVM å’Œ IOMMUï¼‰è™šæ‹ŸåŒ–ç‰¹æ€§ï¼Œå¹¶ä¸”éœ€è¦å…·ä½“è®¾å¤‡æ”¯æŒ SR-IOV è§„èŒƒã€‚ åœ¨ Linux ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ PCI ä¿¡æ¯çš„â€œCapabilitiesâ€é¡¹ç›®ï¼Œä»¥ç¡®å®šè®¾å¤‡æ˜¯å¦å…·å¤‡ SR-IOV åŠŸèƒ½ï¼š $ lspci -s 82:00.0 -v 82:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) Flags: bus master, fast devsel, latency 0, IRQ 38, NUMA node 1 Memory at d0100000 (32-bit, non-prefetchable) [size=1M] I/O ports at c020 [size=32] Memory at d0204000 (32-bit, non-prefetchable) [size=16K] Expansion ROM at d0400000 [disabled] [size=1M] Capabilities: [40] Power Management version 3 Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+ Capabilities: [70] MSI-X: Enable+ Count=10 Masked- Capabilities: [a0] Express Endpoint, MSI 00 Capabilities: [100] Advanced Error Reporting Capabilities: [140] Device Serial Number a4-dc-be-ff-ff-17-8d-52 Capabilities: [150] Alternative Routing-ID Interpretation (ARI) Capabilities: [160] Single Root I/O Virtualization (SR-IOV) Capabilities: [1a0] Transaction Processing Hints Capabilities: [1c0] Latency Tolerance Reporting Capabilities: [1d0] Access Control Services Kernel driver in use: igb Kernel modules: igb â€œCapabilities: [160] Single Root I/O Virtualization (SR-IOV)\" è¡¨ç¤ºç½‘å¡æ”¯æŒ SR-IOV åŠŸèƒ½ å…·ä½“ä½¿ç”¨æ–¹å¼è§ç½‘ç»œæ¨¡å¼ä¸­çš„ç¤ºä¾‹ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:2:2","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"3 å­˜å‚¨æ¨¡å¼ ä¸‹é¢çš„ç£ç›˜æµ‹è¯•éƒ½æ˜¯ä»¥ 4k éšæœºè¯»å†™æµ‹è¯•ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š fio -thread -name=${DISK} -filename=${DISK} \\ -ioengine=libaio -direct=1 -bs=4k -rw=randrw -iodepth=32 \\ -size=8G -rw=readrw è¯´æ˜ï¼Œæµ‹è¯•ä»…ä»…é€‚ç”¨äºç®€å•å¯¹æ¯”å„ä¸ªæ¨¡å¼ä¹‹é—´æ€§èƒ½å·®å¼‚ï¼Œè€Œä¸æ˜¯æ ‡å‡†çš„åŸºå‡†æµ‹è¯•ï¼Œä¸èƒ½ä½œä¸ºé è°±æ•°æ®ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:3:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"3.1 çº¯æ¨¡æ‹Ÿ çº¯æ¨¡æ‹Ÿæ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œæ‰€æœ‰çš„ IO è¯·æ±‚å‘é€ç»™ QEMUï¼Œç”± QEMU åœ¨å®¿ä¸»æœºæ‰§è¡Œåå°†ç»“æœè¿”å›ç»™è™šæ‹Ÿæœºä¸­ï¼ˆè§ 1.1ï¼‰ã€‚ åˆ›å»ºä¸€ä¸ª qcow2 æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä»¥ sata é©±åŠ¨æ–¹å¼æä¾›ç»™è™šæ‹Ÿæœºï¼š â€¦ \u003cdisk type='file' device='disk'\u003e \u003cdriver name='qemu' type='qcow2'/\u003e \u003csource file='/root/disk1.qcow2'/\u003e \u003ctarget dev='sda' bus='sata'/\u003e \u003caddress type='drive' controller='0' bus='0' target='0' unit='0'/\u003e \u003c/disk\u003e â€¦ åœ¨è™šæ‹Ÿæœºä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”çš„ç£ç›˜ä¸å¯¹åº”çš„é©±åŠ¨ï¼š [root@localhost ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 500G 0 disk vda 253:0 0 500G 0 disk â””â”€vda1 253:1 0 500G 0 part / [root@localhost ~]# lspci â€¦ 00:09.0 SATA controller: Intel Corporation 82801IR/IO/IH (ICH9R/DO/DH) 6 port SATA Controller [AHCI mode] (rev 02) å‹æµ‹ç»“æœï¼š read: IOPS=9183, BW=35.9MiB/s (37.6MB/s)(4098MiB/114246msec) write: IOPS=9172, BW=35.8MiB/s (37.6MB/s)(4094MiB/114246msec) ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:3:1","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"3.2 virtio-blk virtio-blk å®ç°äº† virtio æ ‡å‡†ï¼Œåœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ virtio é©±åŠ¨ï¼ŒåŠ é€Ÿå­˜å‚¨çš„è®¿é—®ã€‚å½“ç„¶ï¼Œéœ€è¦å®¢æˆ·æœºä¸­ç³»ç»Ÿæ”¯æŒ virtio-blk å†…æ ¸æ¨¡å—ã€‚ [root@localhost ~]# lsmod | grep blk virtio_blk 18323 2 ç›®å‰ï¼Œvirtio-blk å¯ç”¨äºå®¿ä¸»æœºæ–‡ä»¶ã€è£¸è®¾å¤‡ã€LVM è®¾å¤‡ï¼ŒæŒ‚è½½åˆ°è™šæ‹Ÿæœºåå‘½åä¸º vdxã€‚ å°† \u003cdisk\u003e.\u003ctarget\u003e ä¸­çš„ bus æ”¹ä¸º virtioï¼Œå°±æ˜¯ä½¿ç”¨ virtio-blk æ–¹å¼ã€‚ â€¦ \u003cdisk type='file' device='disk'\u003e \u003cdriver name='qemu' type='qcow2'/\u003e \u003csource file='/root/disk1.qcow2'/\u003e \u003ctarget dev='sda' bus='virtio'/\u003e \u003caddress type='pci' domain='0x0000' bus='0x00' slot='0x0a' function='0x0'/\u003e \u003c/disk\u003e â€¦ ä¸è¿‡ä½¿ç”¨ virtio é©±åŠ¨ï¼Œè®¾ç½®çš„ dev åç§°ä¼šå¤±æ•ˆï¼Œè‡ªåŠ¨ä½¿ç”¨ vdx è¿™ç§å‘½åæ–¹å¼ã€‚åœ¨è™šæ‹Ÿæœºä¸­çœ‹åˆ°å¯¹åº”çš„ç£ç›˜ä»¥åŠé©±åŠ¨ï¼š [root@localhost ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT vda 253:0 0 500G 0 disk â””â”€vda1 253:1 0 500G 0 part / vdb 253:16 0 500G 0 disk [root@localhost ~]# lspci â€¦ 00:0a.0 SCSI storage controller: Red Hat, Inc. Virtio block device å‹æµ‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ¯”çº¯æ¨¡æ‹Ÿè¦å¿«å¾ˆå¤šï¼š read: IOPS=41.7k, BW=163MiB/s (171MB/s)(4098MiB/25145msec) write: IOPS=41.7k, BW=163MiB/s (171MB/s)(4094MiB/25145msec) virtio-blk è™½ç„¶æä¾›äº†å¾ˆé«˜çš„å­˜å‚¨è®¿é—®æ€§èƒ½ï¼Œä½†æ˜¯å…¶è®¾è®¡ä¸Šä¹Ÿæœ‰ç€ä¸€äº›ç¼ºç‚¹ï¼š virtio blk çš„èŒƒå›´æœ‰é™ï¼Œè¿™ä½¿å¾—æ–°çš„å‘½ä»¤å®ç°å˜å¾—å¤æ‚ã€‚æ¯æ¬¡å¼€å‘ä¸€ä¸ªæ–°å‘½ä»¤æ—¶ï¼Œvirtio blk é©±åŠ¨ç¨‹åºéƒ½å¿…é¡»åœ¨æ¯ä¸ªå®¢æˆ·æœºä¸­æ›´æ–° virtio blk å°† PCI åŠŸèƒ½å’Œå­˜å‚¨è®¾å¤‡æ˜ å°„ä¸º 1:1ï¼Œä¸€ä¸ªæ˜ å°„å°±éœ€è¦å ç”¨è™šæ‹Ÿæœºä¸€ä¸ª PCI åœ°å€ï¼Œé™åˆ¶äº†å¯æ‰©å±•æ€§ã€‚ virtio blk ä¸æ˜¯çœŸæ­£çš„ SCSI è®¾å¤‡ã€‚è¿™ä¼šå¯¼è‡´ä¸€äº›åº”ç”¨ç¨‹åºåœ¨ä»ç‰©ç†æœºç§»åŠ¨åˆ°è™šæ‹Ÿæœºæ—¶ä¸­æ–­ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:3:2","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"3.3 virtio-scsi virito-scsi æœ‰ç€ä¸ virtio-blk ç›¸åŒçš„æ€§èƒ½ï¼Œä½†æ˜¯æ”¹å–„äº† virtio-blk çš„ç›¸å…³ç¼ºç‚¹ï¼Œå…¶ä¸­æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ virtio-scsi å¯ä»¥å…è®¸è™šæ‹Ÿæœºå¤„ç†æ•°ç™¾ä¸ªè®¾å¤‡ï¼Œè€Œ virtio-blk åªèƒ½å¤„ç†å¤§çº¦ 30 ä¸ªè®¾å¤‡å°±ä¼šè€—å°½ PCI æ’æ§½ã€‚ å› ä¸º virtio-scsi åœ¨è™šæ‹Ÿæœºé‡Œä½¿ç”¨çš„æ˜¯ scsi é©±åŠ¨ï¼Œå› æ­¤è®¾å¤‡çš„å‘½åä¹Ÿå˜ä¸ºäº† sdxã€‚ å°†ç£ç›˜çš„é©±åŠ¨è®¾ç½®ä¸º scsiï¼ŒåŒæ—¶å°† scsi é©±åŠ¨è®¾ç½®ä¸ºä½¿ç”¨ virtio-scsiï¼ˆé»˜è®¤ä½¿ç”¨çš„é©±åŠ¨æ˜¯ lsiï¼‰ï¼š â€¦ \u003cdisk type='file' device='disk'\u003e \u003cdriver name='qemu' type='qcow2'/\u003e \u003csource file='/root/disk1.qcow2'/\u003e \u003ctarget dev='sdc' bus='scsi'/\u003e \u003caddress type='drive' controller='0' bus='0' target='0' unit='2'/\u003e \u003c/disk\u003e \u003ccontroller type='scsi' index='0' model='virtio-scsi'/\u003e â€¦ å¯ä»¥çœ‹åˆ°ï¼Œ\u003caddress\u003e ä¸­è®¾ç½®ç›¸å…³è®¾å¤‡åœ°å€æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸æ˜¯è®¾ç½® pci æ§½åœ°å€ï¼Œè€Œæ˜¯è®¾ç½®è®¾å¤‡å¯¹åº” SCSI æ˜ å°„åœ°å€ï¼Œå› æ­¤é€šè¿‡å¢åŠ  â€œtargetâ€ å±æ€§å°±å¯ä»¥æ·»åŠ å¤šä¸ªç¡¬ç›˜ï¼Œä¸éœ€è¦å ç”¨å¤šä¸ª PCI æ§½ï¼› è™šæ‹Ÿæœºä¸­çœ‹åˆ°å¯¹åº”çš„å—è®¾å¤‡ â€œsdaâ€ï¼Œä»¥åŠé©±åŠ¨ â€œVirtio SCSIâ€ï¼š [root@localhost ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 500G 0 disk vda 253:0 0 500G 0 disk â””â”€vda1 253:1 0 500G 0 part / [root@localhost ~]# lspci â€¦ 00:08.0 SCSI storage controller: Red Hat, Inc. Virtio SCSI å‹æµ‹ç»“æœï¼š read: IOPS=45.5k, BW=178MiB/s (186MB/s)(4098MiB/23055msec) write: IOPS=46.2k, BW=180MiB/s (189MB/s)(4094MiB/22695msec) ç›®å‰ï¼Œvirtio-scsi è¿˜å­˜åœ¨ä¸€ç§è®¾å¤‡ç›´é€šçš„æ¨¡å¼ï¼ŒIO æ€§èƒ½æ›´é«˜ï¼ˆå…·ä½“å®ç°åŸç†è¿˜ä¸äº†è§£ï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ¨¡å¼è¿˜èƒ½ç”¨äºå—è®¾å¤‡ï¼Œå¹¶ä¸”æ˜¯ä½¿ç”¨ scsi åè®®çš„å—è®¾å¤‡ï¼ˆæµ‹è¯•æ–‡ä»¶ã€usb éƒ½ä¸æ”¯æŒï¼‰ã€‚ é€šè¿‡è®¾ç½® device=â€œlunâ€ ä½¿ç”¨ï¼š ... \u003cdisk type='block' device='lun'\u003e \u003cdriver name='qemu' type='raw'/\u003e \u003csource dev='/dev/sda'/\u003e \u003ctarget dev='sdc' bus='scsi'/\u003e \u003caddress type='drive' controller='0' bus='0' target='0' unit='2'/\u003e \u003c/disk\u003e \u003ccontroller type='scsi' index='0' model='virtio-scsi' /\u003e ... ä½¿ç”¨ lun æ–¹å¼ï¼Œå¹¶æŒ‡å®šä½¿ç”¨å®¿ä¸»æœºå—è®¾å¤‡ sda è™šæ‹Ÿæœºä¸­çœ‹åˆ°å¯¹åº”å—è®¾å¤‡ â€œsdaâ€ï¼Œä»¥åŠé©±åŠ¨ \"â€ ï¼š [root@localhost ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 465.8G 0 disk vda 253:0 0 500G 0 disk â””â”€vda1 253:1 0 500G 0 part / [root@localhost ~]# lspci â€¦ 00:08.0 SCSI storage controller: Red Hat, Inc. Virtio SCSI å‘ç°çš„é—®é¢˜ åœ¨ä½¿ç”¨ lun åˆ†é…ç£ç›˜æ—¶ï¼Œå‘ç°è™šæ‹Ÿæœºå†…éƒ¨å¯¹ç£ç›˜çš„ä¿®æ”¹ï¼Œåœ¨å®¿ä¸»æœºä¸Šæ˜¯æ— æ³•å¯è§çš„ï¼ˆå¯èƒ½å‡ºç°ç£ç›˜æ–‡ä»¶ç³»ç»Ÿ UUID éƒ½ä¸ä¸€è‡´çš„é—®é¢˜ï¼‰ã€‚å¹¶ä¸”ï¼Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨ç»™ç£ç›˜åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿè¿˜ä¼šå‡ºç°æœ‰æŠ¥é”™çš„æƒ…å†µã€‚ å¦‚æœæ˜¯è¦å°† scsi ç£ç›˜å•ç‹¬åˆ†ç»™è™šæ‹Ÿæœºï¼Œæ¨èä½¿ç”¨è®¾å¤‡ç›´æ¥åˆ†é…ä¸­çš„ scsi è®¾å¤‡åˆ†é…ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:3:3","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"3.4 è®¾å¤‡ç›´æ¥åˆ†é… 3.4.1 PCI è®¾å¤‡ åœ¨ 2.1 PCI è®¾å¤‡ç›´æ¥åˆ†é… ä¸­æ‰€è¯´ï¼ŒPCI è®¾å¤‡éƒ½æ”¯æŒè¿›è¡Œè®¾å¤‡ç›´æ¥åˆ†é…ï¼Œä½¿å¾—è™šæ‹Ÿæœºä¸­ç›´æ¥å¯¹ PCI è®¾å¤‡è¿›è¡Œè®¿é—®ï¼Œé€Ÿåº¦æœ€å¿«ã€‚nvme ç£ç›˜å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ ä½¿ç”¨è®¾å¤‡ç›´æ¥åˆ†é…æ—¶ï¼Œéœ€è¦ç°åœ¨å®¿ä¸»æœºä¸Šå–æ¶ˆå¯¹åº”è®¾å¤‡çš„é©±åŠ¨ç»‘å®šï¼Œç„¶åå°†å…¶åˆ†é…ç»™è™šæ‹Ÿæœºï¼Œç„¶å libvirt ä¸­é…ç½®å¥½ç›¸å…³å‚æ•°åï¼Œä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ‰§è¡Œè¿™äº›æ­¥éª¤ã€‚ åœ¨è®¾å¤‡ xml é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  \u003chostdev\u003e é¡¹ï¼ŒæŒ‡å®šå¯¹åº”çš„è®¾å¤‡ PCI åœ°å€ï¼Œæ¥ç›´æ¥åˆ†é…è®¾å¤‡ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨ \u003cinterface type=â€˜hostdevâ€™/\u003eï¼Œè¿™æ˜¯ä¸€ç§ libvirt æä¾›çš„è¾ƒæ–°çš„é…ç½®æ–¹å¼ï¼Œä½†æ˜¯ä¸å…¼å®¹æ‰€æœ‰è®¾å¤‡ï¼‰ã€‚ â€¦ \u003chostdev mode='subsystem' type='pci' managed='yes'\u003e \u003csource\u003e \u003caddress domain='0x0000' bus='0x08' slot='0x00' function='0x0'/\u003e \u003c/source\u003e \u003c/hostdev\u003e â€¦ 3.4.2 SCSI è®¾å¤‡ å¯¹äº SCSI ç£ç›˜ï¼Œé€šè¿‡ PCI æ— æ³•å•ç‹¬åˆ†é…æŸä¸ªç£ç›˜ï¼Œè€Œ libvirt ä¸­æä¾›äº† type=â€˜scsiâ€™ ç±»å‹çš„ç›´æ¥åˆ†é…ã€‚ä½†æ˜¯ä¸ PCI ä¸åŒçš„æ˜¯ï¼Œscsi æ— æ³•è®¾ç½® â€˜managedâ€™ å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å®¿ä¸»æœºä¸Šè¿˜æ˜¯èƒ½å¤Ÿçœ‹è§è¯¥ scsi è®¾å¤‡ï¼Œå¦‚æœæƒ³ä¸å¯è§ï¼Œéœ€è¦è‡ªå·± unbindã€‚ æ·»åŠ  scsi ç±»å‹çš„ \u003chostdev\u003e é¡¹ï¼Œå…¶ä¸­ \u003csource\u003e.\u003caddress\u003e ä¸­æŒ‡å®šå®¿ä¸»æœºå¯¹åº”ç£ç›˜çš„ scsi åœ°å€ã€‚ ... \u003chostdev mode='subsystem' type='scsi' managed='no' sgio='filtered' rawio='yes'\u003e \u003csource\u003e \u003cadapter name='scsi_host0'/\u003e \u003caddress bus='2' target='1' unit='0'/\u003e \u003c/source\u003e \u003caddress type='drive' controller='0' bus='0' target='0' unit='2'/\u003e \u003c/hostdev\u003e \u003ccontroller type='scsi' index='0' model='virtio-scsi'/\u003e ... Note è¿™ç§æ¨¡å¼è¿˜æ˜¯ä¼šä½¿ç”¨ virtio-scsi é©±åŠ¨ï¼Œæˆ‘ä¸ç¡®å®šè¿™æ˜¯å¦å±äºè®¾å¤‡ç›´æ¥åˆ†é…ï¼Œä½†æ˜¯åœ¨æ–‡æ¡£ä¸­å…¶å±äº passthrough çš„ä¸€ç±» ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:3:4","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"3.5 libvirt æä¾›çš„å­˜å‚¨æ¨¡å‹ TODO ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:3:5","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"4 ç½‘ç»œæ¨¡å¼ è™šæ‹Ÿæœºç½‘ç»œçš„æ„å»ºä¸€èˆ¬éƒ½æ˜¯éœ€è¦æ„å»º å®¿ä¸»æœºç½‘ç»œç¯å¢ƒ + è™šæ‹Ÿæœºè™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå¾—ç›Šäº libvirtï¼Œä¸€äº›å¸¸ç”¨çš„ç½‘ç»œçš„æ„å»ºåªéœ€è¦é…ç½®å¥½ç›¸å…³é…ç½®å°±è¡Œï¼Œlibvirt ä¼šè¿›è¡Œç½‘ç»œçš„æ„å»ºã€‚åœ¨ libvirt ä¸­ï¼Œä¸€ä¸ªå¯ç”¨çš„ç½‘ç»œå°±ç§°ä¸º netowrk é¦–å…ˆéœ€è¦æ˜ç¡®çš„ï¼Œä¸‹é¢æ‰€è¯´çš„ç½‘ç»œæ¨¡å¼ä¸åŒçš„åœ¨äºå¦‚ä½•è®©å®¿ä¸»æœºæ¥æ”¶çš„æ•°æ®åŒ…ï¼Œåˆ°è¾¾ qemu è¿›ç¨‹ æˆ–è€… vhost å†…æ ¸æ¨¡å—ã€‚è€Œ qemu è¿›ç¨‹ä¸ vhost æ¨¡å—å¦‚ä½•å°†æ•°æ®åŒ…ä¼ é€’åˆ°è™šæ‹Ÿæœºä¸­ï¼Œè¿™æ˜¯è™šæ‹ŸåŒ–æ–¹å¼çš„é—®é¢˜ï¼Œå³å…¨è™šæ‹ŸåŒ–æˆ–è€…åŠè™šæ‹ŸåŒ–ã€‚ æ›´ç®€å•ç‚¹è¯´ï¼Œè™šæ‹Ÿæœºçš„ç½‘ç»œæ”¶å‘æœ‰ä¸‰ä¸ªç‚¹ï¼šå®¿ä¸»æœº \u003c-\u003e qemu/vhost \u003c-\u003e è™šæ‹Ÿæœºã€‚è€Œä¸åŒç½‘ç»œæ¨¡å¼ä¸åŒç‚¹åœ¨ å®¿ä¸»æœºè‡³ qemu/vhost é˜¶æ®µï¼Œè€Œæ•°æ®åŒ…åˆ°è™šæ‹Ÿæœºï¼Œè¿™å°±æ˜¯ä¸åŒè™šæ‹ŸåŒ–çš„å·¥ä½œäº†ã€‚ åœ¨ä¸‹é¢çš„é…ç½®ä¸­ï¼Œä½ ä¼šå‘ç°ç½‘ç»œæ¨¡å¼è¿˜éœ€è¦é…ç½® driver é€‰é¡¹ï¼Œè¿™å°±æ˜¯é…ç½®å…·ä½“çš„è™šæ‹ŸåŒ–æ–¹å¼äº†ã€‚ä½†æ˜¯è¿™ä¸æ˜¯è¿™é‡Œçš„é‡ç‚¹ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ç‰¹æ®Šçš„è¯´æ˜ã€‚ libvirt æ”¯æŒçš„ç½‘ç»œæ¨¡å¼æœ‰å¾ˆå¤šï¼Œä¸‹é¢ä»…ä»…æåˆ°æˆ‘ä½¿ç”¨è¿‡çš„ã€‚ ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:4:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"4.1 è™šæ‹Ÿæœºç½‘ç»œ 4.1.1 NAT Mode NAT ç½‘ç»œæ˜¯æœ€ç®€å•çš„ç½‘ç»œï¼Œä¸éœ€è¦ä»»ä½•çš„ä¾èµ–ã€‚é€šè¿‡è™šæ‹Ÿçš„ bridge ç½‘å¡åˆ›å»ºä¸€ä¸ªå±äºè™šæ‹Ÿæœºçš„å†…ç½‘ï¼Œç„¶ååœ¨å®¿ä¸»æœºä¸Šé€šè¿‡ iptables å®ç°å†…ç½‘åœ°å€çš„ NATã€‚ï¼ˆæ²¡é”™ï¼Œè¿™å’Œ docker bridge network çš„åŸç†ä¸€æ ·ï¼‰ libvirt ä¼šå­˜åœ¨ä¸€ä¸ªåä¸º default çš„ networkï¼Œå…¶å°±æ˜¯ä¸€ä¸ª NAT ç½‘ç»œã€‚é€šè¿‡ virsh net-list æŸ¥çœ‹ï¼š $ virsh net-list Name State Autostart Persistent -------------------------------------------- default active yes yes å…¶é»˜è®¤ä¼šè¢« activeï¼Œä¹Ÿå°±æ˜¯è¯´å®¿ä¸»æœºç¯å¢ƒåœ¨ libvirtd å¯åŠ¨åå°±ä¼šæ„å»ºå¥½ï¼Œä½ å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ bridge ç½‘å¡ã€‚ $ ip a ... 3: virbr0: \u003cNO-CARRIER,BROADCAST,MULTICAST,UP\u003e mtu 1500 qdisc noqueue state DOWN group default qlen 1000 link/ether 52:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff inet 172.27.0.1/16 brd 172.27.255.255 scope global galaxybr0 valid_lft forever preferred_lft forever ... é»˜è®¤ä¸‹ï¼Œdefault ç½‘ç»œçš„å†…ç½‘ä¸º 192.168.122.1/24ï¼Œæˆ‘é€šè¿‡ä¿®æ”¹å…¶é…ç½®æ–‡ä»¶ /etc/libvirt/qemu/networks/default.xml ä¿®æ”¹äº†å†…ç½‘èŒƒå›´ï¼š $ cat /etc/libvirt/qemu/networks/default.xml \u003cnetwork\u003e \u003cname\u003edefault\u003c/name\u003e \u003cuuid\u003e341adece-b07a-4eb0-92f2-d92f59ed266f\u003c/uuid\u003e \u003cforward mode='nat'/\u003e \u003cbridge name='virbr0' stp='on' delay='0'/\u003e \u003cmac address='52:54:00:12:34:56'/\u003e \u003cip address='172.27.0.1' netmask='255.255.0.0'\u003e \u003cdhcp\u003e \u003crange start='172.27.0.2' end='172.27.255.254'/\u003e \u003c/dhcp\u003e \u003c/ip\u003e \u003c/network\u003e libvirtd ä¼šä¸ºå¯åŠ¨çš„ nat ç½‘ç»œå¯åŠ¨ä¸€ä¸ª dnsmasq è¿›ç¨‹ï¼Œç”¨äºæä¾› DNS ä¸ DHCP åŠŸèƒ½ï¼Œå…¶å¯¹åº”é…ç½®å°±æ˜¯å¯¹åº”ç½‘ç»œçš„é…ç½® $ ps x | grep dns 2185 ? S 0:00 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script=/usr/libexec/libvirt_leaseshelper $ cat /var/lib/libvirt/dnsmasq/default.conf strict-order pid-file=/var/run/libvirt/network/default.pid except-interface=lo bind-dynamic interface=virbr0 dhcp-range=172.27.0.2,172.27.255.254,255.255.0.0 dhcp-no-override dhcp-authoritative dhcp-lease-max=65533 dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts Note è¿™é‡Œä¸ docker bridge network ä¸åŒç‚¹ï¼Œå› ä¸º docker ä¸­ä»…ä»…æ˜¯ namespace éš”ç¦»ï¼Œå®¹å™¨å†…ç½‘å¡ IP è¿˜æ˜¯å¯ä»¥ç”± docker è¿›å…¥ namespace åˆ†é…ï¼Œæ‰€ä»¥æ˜¯ docker æ‰¿æ‹…äº† dhcp æœåŠ¡å™¨çš„èŒè´£ã€‚ ä½†æ˜¯è™šæ‹Ÿæœºå’Œå®¿ä¸»æœºæ˜¯å¼ºéš”ç¦»çš„ï¼Œå› æ­¤éœ€è¦è™šæ‹Ÿæœºå¯åŠ¨åå»ä½œä¸º dhcpclient ç”³è¯·åœ°å€ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ª dhcp æœåŠ¡ï¼Œè¿™å°±æ˜¯ dnsmasq çš„ä½œç”¨ã€‚ åœ¨ xml é…ç½®æ–‡ä»¶ä¸­è®¾ç½® \u003cinterface type=â€˜networkâ€™\u003e é¡¹ï¼Œå¹¶è®¾ç½® \u003csource network=â€˜defaultâ€™/\u003e ä½¿ç”¨ default networkã€‚ \u003cinferface type='network'\u003e \u003cmac address='50:54:00:87:bc:c3'/\u003e \u003csource network='default'/\u003e \u003cmodel type='virtio'/\u003e \u003cdriver name='vhost' txmode='iothread' ioeventfd='on' event_idx='off' queues='16'\u003e \u003chost csum='off' gso='off' tso4='off' tso6='off' ecn='off' ufo='off' mrg_rxbuf='off'/\u003e \u003cguest csum='off' tso4='off' tso6='off' ecn='off' ufo='off'/\u003e \u003c/driver\u003e \u003c/interface\u003e å¯åŠ¨è™šæ‹Ÿæœºåï¼Œå¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºå†…éƒ¨å­˜åœ¨å¯¹åº”çš„ç½‘å¡ï¼Œé€šè¿‡ dhclient -v eth0 å‘½ä»¤ç”³è¯·ä¸€ä¸ª IPï¼Œå¹¿æ’­çš„ dhcp request ä¼šè¢«å®¿ä¸»æœº dnsmasp è¿›ç¨‹å“åº”ï¼Œå¹¶è¿”å› dhcp offerã€‚ [root@localhost ~]# ip a ... 2: eth0: \u003cBROADCAST,MULTICAST\u003e mtu 1500 qdisc noop state DOWN group default qlen 1000 link/ether 50:54:00:87:bc:c3 brd ff:ff:ff:ff:ff:ff [root@localhost ~]# dhclient -v eth0 ... Listening on LPF/eth0/50:54:00:87:bc:c3 Sending on LPF/eth0/50:54:00:87:bc:c3 Sending on Socket/fallback DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 4 (xid=0x57740476) DHCPREQUEST on eth0 to 255.255.255.255 port 67 (xid=0x57740476) DHCPOFFER from 172.27.0.1 DHCPACK from 172.27.0.1 (xid=0x57740476) bound to 172.27.163.138 -- renewal in 1653 seconds. [root@localhost ~]# ping www.baidu.com PING www.a.shifen.com (14.215.177.38) 56(84) bytes of data. 64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=1 ttl=48 time=7.93 ms ... 4.1.2 Routed Mode TODO ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:4:1","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"4.2 å…±äº«ç‰©ç†è®¾å¤‡ç½‘ç»œ 4.2.1 Bridge TODO 4.2.2 Macvtap åœ¨ docker çš„ç½‘ç»œä¸­ï¼Œå­˜åœ¨ç€ macvlan ç½‘ç»œï¼Œå…¶åœ¨å®¿ä¸»æœºçš„ç‰©ç†ç½‘å¡ä¸Šåˆ›å»º macvlan è®¾å¤‡ï¼Œä½¿å¾—åœ¨äºŒå±‚ä¸Šæ„å»ºå¤šä¸ªæ¥å£ï¼Œä»è€Œè®©å¤šä¸ªå®¹å™¨å¤„äºä¸å®¿ä¸»æœºåŒä¸€ä¸ªå±€åŸŸç½‘å†…ã€‚åœ¨è™šæ‹Ÿæœºç½‘ç»œä¸­ï¼Œå•å• macvlan ç½‘å¡æ— æ³•è¿æ¥è™šæ‹Ÿæœºè®¾å¤‡ä¸å®¿ä¸»æœºç½‘å¡ï¼Œè¿˜éœ€è¦ä¸€ä¸ª tap è®¾å¤‡è¿æ¥ï¼Œå°† macvlan + tap ç»„åˆå°±æ˜¯ macvtap è®¾å¤‡ã€‚ ä¸ macvlan è®¾å¤‡ç›¸åŒï¼Œmacvtap åŒæ ·å­˜åœ¨ï¼šprivateã€vepaã€bridgeã€passthru å››ç§æ¨¡å¼ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä¸­éƒ½ä»¥ bridge æ¨¡å¼ä¸ºä¾‹ã€‚ åœ¨ libvirt ä¸­ï¼Œå½“ interface type ä¸º direct æ—¶ï¼Œè¡¨æ˜è®¾å¤‡æ˜¯ç›´æ¥é™„åŠ åˆ°ç‰©ç†ç½‘å¡ä¸Šï¼Œè€Œå°±ä¼šä½¿ç”¨ macvtap æ„å»ºç½‘ç»œã€‚é€šè¿‡ \u003csource dev=xx mode=xx\u003e æŒ‡å®šé™„åŠ çš„ç‰©ç†ç½‘å¡ï¼Œä»¥åŠ macvtap çš„æ¨¡å¼ã€‚ ... \u003cinterface type='direct'\u003e \u003cmac address='50:54:00:87:bc:c3'/\u003e \u003csource dev='eth3' mode='bridge'/\u003e \u003cmodel type='virtio'/\u003e \u003cdriver name='vhost' txmode='iothread' ioeventfd='on' event_idx='off' queues='16'\u003e \u003chost csum='off' gso='off' tso4='off' tso6='off' ecn='off' ufo='off' mrg_rxbuf='off'/\u003e \u003cguest csum='off' tso4='off' tso6='off' ecn='off' ufo='off'/\u003e \u003c/driver\u003e \u003caddress type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/\u003e \u003c/interface\u003e ... å¯åŠ¨è™šæ‹Ÿæœºåï¼Œåœ¨å®¿ä¸»æœºä¸Šå¯ä»¥çœ‹åˆ°å¯¹åº”çš„ macvtap è®¾å¤‡è¢«åˆ›å»ºï¼Œå…¶ mac åœ°å€ä¹Ÿä¸é…ç½®ä¸­çš„ä¸€è‡´ã€‚ $ ip a ... 5: eth3: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1500 qdisc mq state UP group default qlen 1000 link/ether a4:dc:be:0a:7d:37 brd ff:ff:ff:ff:ff:ff inet 192.168.1.107/24 brd 192.168.1.255 scope global eth3 valid_lft forever preferred_lft forever 10: macvtap0@eth3: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1500 qdisc pfifo_fast state UP group default qlen 500 link/ether 50:54:00:87:bc:c3 brd ff:ff:ff:ff:ff:ff åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”çš„è™šæ‹Ÿç½‘å¡ï¼Œé€šè¿‡ dhcp ä¸Šå±‚è·¯ç”±å™¨è·å– IPï¼Œå¯ä»¥å‘ç°ï¼Œå…¶ç½‘å…³å°±æ˜¯å®¿ä¸»æœºçš„ç½‘å…³ï¼Œå…¶ç½‘æ®µä¸å®¿ä¸»æœºä¸€è‡´ã€‚å› æ­¤ï¼Œä½¿ç”¨ macvtap ç›¸å½“äºè®©è™šæ‹Ÿæœºä¸å®¿ä¸»æœºå¤„äºåŒä¸€ä¸ªäºŒå±‚ã€‚ [root@localhost ~]# dhclient -v eth0 ... Listening on LPF/eth0/50:54:00:87:bc:c3 Sending on LPF/eth0/50:54:00:87:bc:c3 Sending on Socket/fallback DHCPREQUEST on eth0 to 255.255.255.255 port 67 (xid=0x4e586341) DHCPNAK from 192.168.1.1 (xid=0x4e586341) DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 8 (xid=0x1d605c78) DHCPREQUEST on eth0 to 255.255.255.255 port 67 (xid=0x1d605c78) DHCPOFFER from 192.168.1.1 DHCPACK from 192.168.1.1 (xid=0x1d605c78) bound to 192.168.1.105 -- renewal in 3423 seconds. [root@localhost ~]# ip a 2: eth0: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1500 qdisc mq state UP group default qlen 1000 link/ether 52:54:00:87:bc:c1 brd ff:ff:ff:ff:ff:ff inet 192.168.1.105/24 brd 192.168.1.255 scope global dynamic eth0 valid_lft 7023sec preferred_lft 7023sec ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:4:2","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"4.3 è®¾å¤‡ç›´æ¥åˆ†é… å‰é¢çš„å„ç§ç½‘ç»œæ¨¡å¼ï¼Œæœ€åè¿˜æ˜¯é ç€å…¨è™šæ‹ŸåŒ–æˆ–è€…åŠè™šæ‹ŸåŒ–å°†æ•°æ®åŒ…ä¼ é€’ç»™è™šæ‹Ÿæœºï¼Œè€Œå¦‚æœä½ æœ‰ç€å¤šä¸ªå¯ç”¨çš„ç½‘å¡ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨è®¾å¤‡ç›´æ¥åˆ†é…ï¼Œè¿™æ˜¯æ€§èƒ½æœ€é«˜çš„æ–¹å¼ã€‚ 4.3.1 PCI ç½‘å¡ åœ¨è®¾å¤‡ xml é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  \u003chostdev\u003e é¡¹ï¼ŒæŒ‡å®šå¯¹åº”çš„è®¾å¤‡ PCI åœ°å€ï¼Œæ¥ç›´æ¥åˆ†é…è®¾å¤‡ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨ \u003cinterface type=â€˜hostdevâ€™/\u003eï¼Œè¿™æ˜¯ä¸€ç§ libvirt æä¾›çš„è¾ƒæ–°çš„é…ç½®æ–¹å¼ï¼Œä½†æ˜¯ä¸å…¼å®¹æ‰€æœ‰è®¾å¤‡ï¼‰ã€‚ â€¦ \u003chostdev mode='subsystem' type='pci' managed='yes'\u003e \u003csource\u003e \u003caddress domain='0x0000' bus='0x01' slot='0x00' function='0x0'/\u003e \u003c/source\u003e \u003c/hostdev\u003e â€¦ å¯åŠ¨è™šæ‹Ÿæœºåï¼Œåœ¨å®¿ä¸»æœºä¸Šå°±æ— æ³•çœ‹åˆ°å¯¹åº”çš„ç½‘å¡äº†ï¼Œå› ä¸ºå¯¹åº”çš„é©±åŠ¨è¢« libvirt è§£ç»‘äº†ã€‚ å…³é—­è™šæ‹Ÿæœºåï¼Œlibvirt åˆä¼šé‡æ–°å°†ç½‘å¡ç»‘å®šé©±åŠ¨ï¼Œåœ¨å®¿ä¸»æœºä¸Šæœ‰å¯è§äº†ã€‚ 4.3.1 SR-IOV TODO ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:4:3","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["VM"],"content":"å‚è€ƒ libvirt domain é…ç½®å®˜æ–¹æ–‡æ¡£ RedHatï¼šGuest Virtual Machine Device Configuration virtio-scsi passthrough virtio-scsi å’Œ virtio-blk çš„ç†è§£ libvirt: Networking libvirt: VirtualNetworking ","date":"2020-11-28","objectID":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/:5:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"KVM è™šæ‹Ÿæœºçš„å­˜å‚¨ä¸ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/vm/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E7%BD%91%E7%BB%9C/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"å®¹å™¨å¯åŠ¨èƒŒåçš„æ‰§è¡Œè¿‡ç¨‹","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡ä¸»è¦æè¿°å®¹å™¨å¯åœèƒŒåçš„æ­¥éª¤ï¼Œä½†æ˜¯ä¸æ¶‰åŠæºç ã€‚ ç¤ºä¾‹çš„åŸºäº ubuntu 20.04.1 LTS è™šæ‹Ÿæœºè¿è¡Œï¼Œdocker ç‰ˆæœ¬å¦‚ä¸‹ï¼š $ docker version Client: Version: 19.03.8 API version: 1.40 Go version: go1.13.8 Git commit: afacb8b7f0 Built: Wed Oct 14 19:43:43 2020 OS/Arch: linux/amd64 Experimental: false Server: Engine: Version: 19.03.8 API version: 1.40 (minimum version 1.12) Go version: go1.13.8 Git commit: afacb8b7f0 Built: Wed Oct 14 16:41:21 2020 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.3.3-0ubuntu2 GitCommit: runc: Version: spec: 1.0.1-dev GitCommit: docker-init: Version: 0.18.0 GitCommit: ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:0:0","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"1 å¯åŠ¨ ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:1:0","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"1.1 Create é€šè¿‡ docker create å‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œä½†æ˜¯å®¹å™¨å¹¶ä¸ä¼šçœŸæ­£çš„è¿è¡Œï¼Œå…¶å¯¹åº”è¿›ç¨‹ä¸ä¼šå­˜åœ¨ã€‚ create å®¹å™¨ç»è¿‡çš„å…·ä½“æµç¨‹ä¸ºï¼š å®¹å™¨å‚æ•°æ£€æŸ¥ä¸è°ƒæ•´ï¼› å®¹å™¨å¯¹åº”çš„è¯»å†™å±‚ï¼ˆRWLayerï¼‰çš„åˆ›å»ºï¼› å®¹å™¨å…ƒä¿¡æ¯çš„è®°å½•ï¼ˆä¸»è¦æ˜¯é…ç½®ä¿¡æ¯ï¼‰ï¼› (1) å®¹å™¨å‚æ•°æ£€æŸ¥ä¸è°ƒæ•´ æ£€æŸ¥å®¹å™¨è¿è¡Œå‚æ•°æ˜¯å¦åˆæ³•ï¼Œå¹¶è°ƒæ•´ä¸€äº›å‚æ•°çš„å€¼ï¼Œè¿™ä¸€æ­¥ä¸å…·ä½“æè¿°ã€‚ (2) è¯»å†™å±‚çš„åˆ›å»º å®¹å™¨çš„ â€œå±‚â€ å¯ä»¥åˆ†ä¸ºï¼š è¯»å†™å±‚ ï¼šä¿å­˜å®¹å™¨å¯¹ rootfs å†™ã€ä¿®æ”¹ç»“æœçš„å±‚ï¼Œå¹¶åœ¨å®¹å™¨é€€å‡ºåè¢« docker åˆ é™¤ï¼› ä¾‹å¦‚ï¼Œå®¹å™¨ä¸­å¯¹ç³»ç»Ÿç›˜ root ç›®å½•ä¸­æŸä¸ªæ–‡ä»¶çš„ä¿®æ”¹ï¼Œè¿™ä¸ªä¿®æ”¹åçš„æ–‡ä»¶ä¼šè¢«å¤åˆ¶ä¸€ä»½åœ¨ç³»ç»Ÿç›˜ä¸Šã€‚ init å±‚ ï¼šç”¨äºå¤„ç†ä¸€äº›ä¸é•œåƒä¸ç»‘å®šï¼Œä½†æ˜¯ä¸è¿è¡Œå®¹å™¨ç›¸å…³çš„æ–‡ä»¶ä¿®æ”¹ï¼Œä¸»è¦æ˜¯ /etc/resolve.conf /etc/hosts ç­‰ï¼› ä¸ºä»€ä¹ˆè¦æœ‰ init å±‚ï¼Ÿ æˆ‘çš„ç†è§£æ˜¯ï¼šé•œåƒå±‚ï¼ˆåªè¯»å±‚ï¼‰æä¾›çš„æ˜¯ä¸€ä¸ªé™æ€çš„ç¯å¢ƒï¼Œå³æ‰€æœ‰å®¹å™¨çœ‹åˆ°çš„ç¯å¢ƒéƒ½æ˜¯ä¸€æ ·ã€‚ è€Œæœ‰äº›ä¸œè¥¿å¹¶ä¸æ˜¯æƒ³è®©æ‰€æœ‰å®¹å™¨çœ‹åˆ°çš„ç›¸åŒï¼Œä¾‹å¦‚ hostnameã€nameserverï¼Œè¿™äº› docker éƒ½æä¾›äº†å‚æ•°é…ç½®ï¼Œæ‰€ docker å•ç‹¬æŠ½å‡ºäº†ä¸€ä¸ª â€œæœºå™¨ç»´åº¦â€ çš„åªè¯»å±‚ï¼Œinit å±‚ ç½®äºä¸ºä»€ä¹ˆä¸æ˜¯åœ¨è¯»å†™å±‚ä¿®æ”¹ï¼Œä¸ªäººè§‰å¾—æ˜¯å› ä¸ºè¯»å†™å±‚æ˜¯å¯ä»¥è¢« â€œå¯¼å‡ºâ€ çš„ï¼ˆdocker saveï¼‰ï¼Œè€Œè¿™äº› /etresolve.conf çš„å†…å®¹åˆæ˜¯ä¸åº”è¯¥è¢«å¯¼å‡ºçš„ï¼Œæ‰€ä»¥æ”¾åœ¨äº† init å±‚ã€‚ åªè¯»å±‚ ï¼šé•œåƒåŒ…å«çš„æ‰€æœ‰å±‚ï¼Œä»…ä»…åªè¯»ã€‚å¯¹åªè¯»å±‚ä»»ä½•ä¿®æ”¹éƒ½ä¼šä»¥ COW å½¢å¼æ”¾åœ¨è¯»å†™å±‚ã€‚ å…·ä½“è¯»å†™å±‚çš„æ¦‚å¿µè¿™é‡Œä¸å±•å¼€ï¼Œå¯ä»¥é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼šstoragedriverã€‚ è¿™é‡Œè¯»å†™å±‚çš„åˆ›å»ºä»…ä»…æŒ‡çš„æ˜¯åˆ›å»ºäº† init å±‚ä¸è¯»å†™å±‚çš„ç›®å½•ï¼Œå¹¶æ²¡æœ‰åš union mountï¼Œæ¯•ç«Ÿå®¹å™¨æ²¡æœ‰è¿è¡Œå˜›ï¼Œæ²¡å¿…è¦ã€‚ æ‰¾ä¸ªä¾‹å­çœ‹ä¸€ä¸‹ï¼š $ docker create --rm -t ubuntu 361c520da78f848d639d65f042fcf5d448c13cbc4ce8c251dcba2250162b48fe inspect å¯ä»¥çœ‹åˆ°å¯¹åº”çš„è¯»å†™å±‚çš„ç›®å½•ï¼š $ docker inspect 361c520da78f â€¦ \"GraphDriver\": { \"Data\": { \"LowerDir\": \"/var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c-init/diff:/var/lib/docker/overlay2/0336c489d40e65588748265a95f18328ddb1f5bcb9ebf10909fbf3f5f35b9496/diff:/var/lib/docker/overlay2/77d3ac91877751678bfec0576dab39ccd4b73666f8040aef387ef47ff30b4cf1/diff:/var/lib/docker/overlay2/ec8326178c990b52970a65371fd375737fdf256db597aa821a2b0f7d79bcc6f3/diff:/var/lib/docker/overlay2/385038374d3d369e98724926d0e1c240dcb74e31b1663ec1cb434c43ca2826f1/diff\", \"MergedDir\": \"/var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/merged\", \"UpperDir\": \"/var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/diff\", \"WorkDir\": \"/var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/work\" }, \"Name\": \"overlay2\" }, â€¦ $ ls /var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/ diff link lower work æ‰€æœ‰çš„å±‚ï¼ˆåŒ…å«å®¹å™¨ã€é•œåƒï¼‰éƒ½ä½äº /var/lib/docker/[driver] ç›®å½•ä¸‹ï¼Œä¸è¿‡ä¸åŒçš„ driver æœ‰ç€ä¸åŒçš„ç›®å½•ç»“æ„ï¼› æ¯ä¸ªå±‚çš„ç›®å½•ç»“æ„ä¹Ÿå’Œå¯¹åº”çš„ driver æœ‰å…³ï¼Œoverlay2 ä¸­å°±ä¼šåŒ…å« diffã€work ç­‰å­ç›®å½•ï¼Œè€ŒçœŸæ­£å®¹å™¨è¿è¡Œåçœ‹åˆ°çš„å°±æ˜¯ diff ç›®å½•è¢«æŒ‚è½½åçš„å†…å®¹ï¼› åœ¨ /var/lib/docker/overlay2/ ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåŒè¯»å†™å±‚ç±»ä¼¼åå­—çš„ â€œxxx-initâ€ ç›®å½•ï¼Œè¿™å°±æ˜¯ init å±‚ç›®å½•ï¼Œå¯¹åº”çš„ diff å­ç›®å½•ä¹Ÿæ˜¯ç”¨äºæŒ‚è½½çš„ç›®å½•ï¼š $ ls /var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c-init committed diff link lower work $ tree /var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c-init/diff /var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c-init/diff |-- dev | |-- console | |-- pts | `-- shm `-- etc |-- hostname |-- hosts |-- mtab -\u003e /proc/mounts `-- resolv.conf ä½†æ˜¯è¿™ä¸¤ä¸ªç›®å½•ä»…ä»…æ˜¯è¢«åˆ›å»ºï¼Œå¦‚æœæ‰§è¡Œ mount å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›ç›®å½•æ˜¯æ²¡æœ‰è¢«æŒ‚è½½çš„ã€‚ (3) å…ƒä¿¡æ¯çš„è®°å½• æ‰§è¡Œ docker create åï¼Œé€šè¿‡ docker ps -a å¯ä»¥çœ‹åˆ°å¯¹åº”çš„å®¹å™¨ï¼Œå¹¶ä¸” inspect å¯ä»¥çœ‹åˆ°å¯¹åº”çš„é…ç½®ä¿¡æ¯ï¼Œå› æ­¤ï¼Œcreate ä¹‹åæ˜¯æœ‰å…ƒä¿¡æ¯çš„è®°å½•çš„ã€‚ è€Œè¿™ä¸ªå…ƒä¿¡æ¯å°±ä¿å­˜åœ¨ /var/lib/docker/containers ç›®å½•ä¸‹ï¼Œæ¯ä¸ªå­ç›®å½•çš„åå­—å°±æ˜¯å¯¹åº”çš„å®¹å™¨ IDï¼š $ cd /var/lib/docker/containers \u0026\u0026 ls 361c520da78f848d639d65f042fcf5d448c13cbc4ce8c251dcba2250162b48fe $ ls 361c520da78f848d639d65f042fcf5d448c13cbc4ce8c251dcba2250162b48fe checkpoints config.v2.json hostconfig.json config.v2.json ä¿å­˜çš„å°±æ˜¯å¯¹åº”çš„å®¹å™¨é…ç½®ä¿¡æ¯ï¼› å¯ä»¥çœ‹åˆ°ï¼Œ /var/lib/docker/containers ç›®å½•å°±æ˜¯æ‰€æœ‰å®¹å™¨ä¿¡æ¯çš„ â€œæ•°æ®åº“â€ï¼Œè¿™ä¸å±‚çš„æ¦‚å¿µæ˜¯è§£è€¦çš„ã€‚ å¦‚æœï¼Œä½ è®¾ç½®äº† docker daemon é€€å‡ºåä¸åœæ­¢æ‰€æœ‰å®¹å™¨ï¼ˆé»˜è®¤æƒ…å†µ docker daemon é€€å‡ºå‰ä¼šåœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨ï¼Œé€šè¿‡é…ç½®å¯ä»¥æ”¹å˜è¿™ä¸ªè¡Œä¸ºï¼‰ï¼Œé‚£ä¹ˆ docker daemon é‡æ–°å¯åŠ¨åï¼Œå°±ä¼šä¾é è¿™ä¸ªç›®å½•è¿›è¡Œ container ä¿¡æ¯çš„æ¢å¤ã€‚ ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:1:1","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"1.2 Start é€šè¿‡ docker start å‘½ä»¤è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œå…¶ä¸»è¦çš„æ­¥éª¤å¦‚ä¸‹ï¼š çŠ¶æ€æ£€æŸ¥ï¼Œåªæœ‰ Create ä¸ Stop çŠ¶æ€å®¹å™¨æ‰å¯ä»¥è¢« Startï¼› è¿›è¡Œå®¹å™¨ rootfs çš„æ„å»ºï¼Œè¿™é‡Œä¼šè¿›è¡Œè¯»å†™å±‚ã€init å±‚ã€é•œåƒå±‚çš„ union mountï¼› å®¹å™¨ç½‘ç»œæ„å»ºï¼› è°ƒç”¨ containerd è¿›è¡Œå®¹å™¨çš„å¯åŠ¨ï¼› docker run ç­‰åŒäº docker create + docker runï¼Œæ‰€ä»¥ä¸éœ€è¦ç‰¹åˆ«è¯´æ˜ã€‚ (2) rootfs çš„æ„å»º rootfs æŒ‡å®šæ˜¯å®¹å™¨æœ€åçœ‹åˆ°çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ è¯»å†™å±‚ + init å±‚ + é•œåƒå±‚ç»è¿‡ union mount åçš„è¯»å†™å±‚ã€‚ æˆ‘æ„Ÿè§‰ï¼Œunion mount ä¸»è¦ç”±ä¸¤ä¸ªç‰¹ç‚¹ï¼š ç»Ÿä¸€è§†å›¾ ï¼šå°†å„ä¸ªå±‚ â€œå‹æ‰â€ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªå±‚ã€‚è€Œä¸Šä¸‹å±‚ä¹‹é—´ç›¸åŒçš„æ–‡ä»¶ã€ç›®å½•ï¼Œå°±ä¼šè¢«ä¸Šå±‚çš„è¦†ç›–ã€‚ å†™æ—¶å¤åˆ¶ ï¼šå¯¹äºæ•´ä¸ªè§†å›¾çš„æ“ä½œï¼Œåªä¼šå½±å“æœ€é¡¶å±‚ï¼ˆè¯»å†™å±‚ï¼‰ï¼Œä¸ä¼šå½±å“å…¶ä»–å±‚ï¼Œå¹¶ä¸”æ˜¯å†™æ—¶å¤åˆ¶çš„ã€‚ çœ‹ä¸€ä¸‹å…·ä½“ç¤ºä¾‹ï¼š $ docker start 361c520da78f 361c520da78f é€šè¿‡ mount å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”å®¹å™¨çš„ union mount å·²ç»å‡ºç°ï¼š $ mount â€¦ overlay on /var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/merged type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/O2TO66S3K4MTADSAAX6VXGTWSJ:/var/lib/docker/overlay2/l/UHTTQ5AJKPR23Y3V7J4ZLOIFDR:/var/lib/docker/overlay2/l/VWIFLRAQOPMH7LBAQQ5DDGIYVM:/var/lib/docker/overlay2/l/LQBRTVETGGWVU2OHWC42443K7X:/var/lib/docker/overlay2/l/5PDNI5HSOH6UMUDNWF4VMR46TS,upperdir=/var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/diff,workdir=/var/lib/docker/overlay2/d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c/work,xino=off) nsfs on /run/docker/netns/4500ea4f0025 type nsfs (rw) $ ls -lh /var/lib/docker/overlay2/l/O2TO66S3K4MTADSAAX6VXGTWSJ lrwxrwxrwx 1 root root 77 Nov 14 15:51 /var/lib/docker/overlay2/l/O2TO66S3K4MTADSAAX6VXGTWSJ -\u003e ../d063d1d9c81d0c72d7384ea999dbd77b33d04b942ef94a5aabc6fb6cf984194c-init/diff ç¬¬ä¸€ä¸ªæŒ‚è½½ä¿¡æ¯çœ‹å‡ºï¼Œå°† init å±‚ä¸é•œåƒå±‚çš„ç›®å½•æŒ‚è½½åˆ°äº†è¯»å†™çš„ merged ç›®å½•ï¼› åé¢æ‰§è¡Œçš„å‘½ä»¤çœ‹å¾…ï¼Œä½¿ç”¨çš„ /var/lib/docker/overlay2/l/O2TO66S3K4MTADSAAX6VXGTWSJ è¿™æ ·çš„ç›®å½•æ˜¯è½¯é“¾ï¼ŒæŒ‡å‘å‰é¢è¯´çš„å¯¹åº”çš„å„ä¸ªå±‚çš„ç›®å½•ï¼Œå› ä¸ºæ•´ä¸ªå±‚çš„åå­—å¤ªé•¿ï¼Œæ‰€ä»¥ä½¿ç”¨è½¯é“¾åˆ«åè®©æŒ‚è½½å±æ€§çŸ­ä¸€äº›ï¼› (3) å®¹å™¨ç½‘ç»œæ„å»º é¦–å…ˆæ˜ç¡®ï¼Œå…ˆæœ‰ç½‘ç»œç¯å¢ƒï¼Œå†æœ‰çš„å®¹å™¨è¿è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯å®¹å™¨ä¸­çš„è¿›ç¨‹åŠ å…¥ä¸€ä¸ªç‰¹å®šçš„ net namespaceã€‚æ‰€ä»¥ï¼Œç½‘ç»œç¯å¢ƒçš„æ„å»ºçš„ç›®æ ‡å°±æ˜¯ï¼šå¾—åˆ°ä¸€ä¸ªé…å¥½ç½‘ç»œçš„ net namespaceã€‚ æ‰€ä»¥ç½‘ç»œæ„å»ºå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå¤§æ¦‚çš„æ­¥éª¤ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ net namespaceï¼› åœ¨è¿™ä¸ª net namespace é‡Œæ“ä½œï¼Œæ„å»ºå¥½ç½‘ç»œï¼› ä¿ç•™è¿™ä¸ª net namesapceï¼› å¦‚ä½• â€œé…å¥½ç½‘ç»œçš„ net namespaceâ€ å°±å’Œå…·ä½“çš„ç½‘ç»œæ¨¡å¼æœ‰å…³äº†ï¼Œå…·ä½“è§ï¼šå®¹å™¨ç½‘ç»œæ€»ç»“ã€‚ é»˜è®¤ä¸‹ï¼Œå½“ä¸€ä¸ª namespace ä¸­æ²¡æœ‰ä»»ä½•è¿›ç¨‹æ—¶ï¼Œè¯¥ namespace å°±è‡ªåŠ¨è¢«å†…æ ¸é”€æ¯äº†ï¼ˆåƒåœ¾å›æ”¶ï¼‰ï¼Œè€Œè¦å°†ä¸€ä¸ª namespace æŒä¹…åŒ–ï¼Œå°±éœ€è¦å°†å…¶æŒ‚è½½åˆ°ä¸€ä¸ªå…·ä½“æ–‡ä»¶ï¼Œè¿™æ ·è¯¥ net namespace å°±ä¼šä¿ç•™ã€‚ å› æ­¤ï¼Œdocker ä¼šé€šè¿‡è¿™ç§æ–¹å¼å…ˆä¿ç•™ net namespaceï¼Œå¹¶è®©å®¹å™¨è¿è¡Œåçš„è¿›ç¨‹å¯ä»¥åŠ å…¥ã€‚å½“å®¹å™¨åœæ­¢æ˜¯ï¼Œdocker å°†å…¶æ‰‹åŠ¨åˆ é™¤ã€‚ é€šè¿‡ mount å‘½ä»¤ï¼Œä½ å¯ä»¥çœ‹åˆ°å¯¹åº”å®¹å™¨çš„ net namespace çš„æŒ‚è½½ä¼šéšç€å®¹å™¨è¿è¡Œå‡ºç°ã€‚ $ mount â€¦ nsfs on /run/docker/netns/4500ea4f0025 type nsfs (rw) â€¦ å½“ç„¶ï¼Œä¸Šé¢è¯´çš„ â€œæ„å»ºç½‘ç»œâ€ï¼Œâ€œæŒ‚è½½æ–‡ä»¶â€ï¼ŒåŒ…æ‹¬ â€œnamespace æ–‡ä»¶å¦‚ä½•æ˜ å°„åˆ°å¯¹åº”çš„å®¹å™¨â€ è¿™äº›è¡Œä¸ºä¸ä¿¡æ¯ï¼Œéƒ½æ˜¯ç”± libnetwork åº“ä¸­è´Ÿè´£çš„ã€‚ Tip çœ‹ libnetwork æºç æ—¶å‘ç°ä¸€ç‚¹ï¼Œå½“æŸä¸ªä»£ç éœ€è¦è¿›å…¥ namespaceï¼Œä¸€å®šéœ€è¦å°†å½“å‰ goroutine ä¸ thread ç»‘å®šï¼ˆruntime.LockOSThread()ï¼‰æ¥å£ã€‚ Why ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä¸€æ®µä»£ç ç”± G1 groutine ç»‘å®šåˆ°äº† T1 çº¿ç¨‹æ‰§è¡Œï¼Œåˆ›å»ºäº† N1 namespaceï¼Œå¹¶ä¸”æœŸæœ›åœ¨ N1 namespace ä¸‹æ‰§è¡Œã€‚ä½†æ˜¯ä»£ç è¿è¡Œä¸­ï¼Œå¯èƒ½ç”±äº Go çš„è°ƒåº¦ï¼Œå˜æˆäº† G1 groutine ç»‘å®šåˆ° T2 çº¿ç¨‹æ‰§è¡Œã€‚è¿™æ—¶ï¼Œå°±åˆ‡æ¢äº† namespace äº†ï¼Œä»£ç ä¹Ÿå°±ä¸æ˜¯åœ¨æœŸæœ›çš„ namespace ä¸‹æ‰§è¡Œï¼Œè¿™å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„é—®é¢˜ã€‚ (4) è°ƒç”¨ containerd å¯åŠ¨å®¹å™¨ docker daemon åœ¨è®¾è®¡åˆ°å®¹å™¨è¿›ç¨‹çš„è¿è¡Œæ—¶ï¼Œéƒ½æ˜¯äº¤ç»™ containerdï¼Œç„¶å containerd è°ƒç”¨ shimï¼Œshim è°ƒç”¨ runc åº“æ‰§è¡Œã€‚ çœŸæ­£å®¹å™¨å†…è¿›ç¨‹æ€ä¹ˆè¿è¡Œè¿˜åŒ…æ‹¬å¾ˆå¤šå†…å®¹ï¼Œç‰¹åˆ«æ˜¯ runc å¦‚ä½•è°ƒæ•´è¿›ç¨‹ namespaceï¼Œå¦‚ä½•å¯åŠ¨è¿›ç¨‹è¿™äº›å†…å®¹ï¼Œè¿™é‡Œä¸å†æ·±å…¥è¯´ã€‚ å¦‚æœæœ‰ç©ºï¼Œç­‰åé¢å‡ºä¸ªæ–‡ç« è¯¦è¿°ï¼ˆæŒ–å‘ã€‚ ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:1:2","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2 åœæ­¢ ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:2:0","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.1 Stop stop çš„æ­¥éª¤å°±æ˜¯å¯¹ run æ“ä½œçš„å›æ»šï¼ŒåŒ…æ‹¬ï¼š åœæ­¢å®¹å™¨çš„è¿è¡Œï¼› é”€æ¯å®¹å™¨ç½‘ç»œï¼› è§£é™¤å®¹å™¨è¯»å†™å±‚çš„æŒ‚è½½ï¼› å…¶ä¸­ç¬¬ 2ã€3 æ­¥å°±æ˜¯åç€æ¥æ“ä½œï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚ (1) åœæ­¢å®¹å™¨è¿è¡Œ åœæ­¢å®¹å™¨è¿è¡Œï¼Œå…¶å®å°±æ˜¯åœæ­¢å®¹å™¨å†…æ‰€æœ‰è¿›ç¨‹çš„è¿è¡Œã€‚ æœ‰è¶£çš„æ˜¯åœæ­¢å®¹å™¨è¿è¡Œçš„è¿‡ç¨‹é‡Œï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ runc åº“ï¼Œè€Œæ˜¯åœ¨ shim è¿™ä¸€å±‚ä¸­ï¼Œå¯¹ shim è¿›ç¨‹å‘é€ä¿¡å·ã€‚è¿™ä¸€å—ä¹Ÿæ˜¯åé¢ç»†è¯´ã€‚ å¤§è‡´çš„åœæ­¢æµç¨‹å°±æ˜¯ä¸‹é¢ä¸¤æ­¥ï¼š å‘é€ é…ç½®/é»˜è®¤ (SIGTERM) çš„åœæ­¢ä¿¡å·ï¼› ä¸Šä¸€æ­¥åœæ­¢å¤±è´¥/è¶…æ—¶ï¼Œé‚£ä¹ˆå°±å‘é€ SIGKILL ä¿¡å·ï¼› ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:2:1","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.2 Remove è€æ ·å­ï¼Œæ“ä½œçš„é€†å‘ï¼Œè¿™ä¹Ÿæ²¡å•¥å¥½è¯´çš„ã€‚ åˆ é™¤å¯¹åº”è¯»å†™å±‚ç›®å½•ä¸ init å±‚ç›®å½•ï¼› åˆ é™¤å¯¹åº”çš„å®¹å™¨å…ƒä¿¡æ¯ï¼› ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:2:2","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"3 æš‚åœä¸æ¢å¤ ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:3:0","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"3.1 Pause ä¸ Resume Pause æ“ä½œçš„åŸç†å¾ˆç®€å•ï¼Œé€šè¿‡ cgroup.freezer å†»ç»“è¿›ç¨‹çš„è¿è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸è®©è¿›ç¨‹è¢«å†…æ ¸è°ƒåº¦è¿è¡Œã€‚ åœ¨å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼Œè¯»å–å¯¹åº” cgroup çš„ freezer.state æ–‡ä»¶å¯ä»¥çœ‹åˆ°æ˜¯ THAWED çŠ¶æ€ã€‚ $ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES f4b92a61851a ubuntu \"/bin/bash\" 2 seconds ago Up 1 second host_container $ cat /sys/fs/cgroup/freezer/docker/f4b92a61851a7f5f85569318c830722c275796b36d34a506eae05b547b31cb7c/freezer.state THAWED æ‰§è¡Œ docker pause åï¼Œçœ‹åˆ°å¯¹åº”çš„ freezer.state å˜ä¸º FROZENï¼Œè¡¨æ˜è¢«å†»ç»“äº†ã€‚ $ docker pause host_container host_container $ cat /sys/fs/cgroup/freezer/docker/f4b92a61851a7f5f85569318c830722c275796b36d34a506eae05b547b31cb7c/freezer.state FROZEN æ‰§è¡Œ docker unpause æ¢å¤è¿è¡Œåï¼Œå¯¹åº”çŠ¶æ€åˆå˜ä¸ºäº† THAWEDï¼š $ docker unpause host_container $ cat /sys/fs/cgroup/freezer/docker/f4b92a61851a7f5f85569318c830722c275796b36d34a506eae05b547b31cb7c/freezer.state THAWED è€Œè¿™ä¸ªçŠ¶æ€çš„å˜åŒ–ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ echo \"\u003cstate\u003e\" \u003e freezer.state å®ç°çš„ã€‚ ","date":"2020-11-13","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/:3:1","tags":["docker","container"],"title":"å®¹å™¨å¯åœåŸç†æ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E5%90%AF%E5%81%9C%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"æè¿° docker ä¸‹å®¹å™¨ç½‘ç»œæ¨¡å‹ä¸å®ç°","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":" æ€»ç»“ç³»åˆ—çš„æ–‡ç« æ˜¯è‡ªå·±çš„å­¦ä¹ æˆ–ä½¿ç”¨åï¼Œå¯¹ç›¸å…³çŸ¥è¯†çš„ä¸€ä¸ªæ€»ç»“ï¼Œç”¨äºåç»­å¯ä»¥å¿«é€Ÿå¤ä¹ ä¸å›é¡¾ã€‚ æœ¬æ–‡æ˜¯å¯¹è‡ªå·±ä½¿ç”¨è¿‡çš„ docker ä½¿ç”¨çš„ç½‘ç»œæ¨¡å¼çš„åŸç†çš„æ€»ç»“ã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:0:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"1 æ¦‚è§ˆ docker å®¹å™¨ç½‘ç»œç›®å‰åŒ…å« 5 ä¸­æ¨¡å¼ï¼ŒåŒ…æ‹¬ï¼š bridgeï¼šé»˜è®¤çš„ç½‘ç»œæ¨¡å¼ï¼Œä½¿ç”¨ bridge è™šæ‹Ÿç½‘å¡ + iptables å®ç°ä¸€ä¸ªå†…åœ°å†…ç½‘ï¼Œæ‰€æœ‰å®¹å™¨éƒ½å¤„äºè¯¥å†…ç½‘å†…ï¼Œå¹¶ä¸”å¯ä»¥ç›¸äº’è®¿é—®ï¼› hostï¼šä¸å®¿ä¸»æœºå¤„äºåŒä¸€ä¸ª net namespaceï¼Œä½¿ç”¨å®¿ä¸»æœºç½‘ç»œç¯å¢ƒï¼› overlayï¼šåœ¨å¤šä¸ª docker daemon ä¹‹é—´å»ºç«‹ overlay ç½‘ç»œï¼Œä½¿å¾—ä¸åŒ docker daemon çš„å®¹å™¨ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼› macvlanï¼šä½¿ç”¨ macvlan è™šæ‹Ÿç½‘å¡ï¼Œå°†å®¹å™¨ç‰©ç†åœ°å€æš´éœ²åœ¨å®¿ä¸»æœºå±€åŸŸç½‘ä¸­ï¼Œä½ å¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€å°åŒå±€åŸŸç½‘çš„ç‰©ç†æœºï¼› noneï¼šä¸è¿›è¡Œä»»ä½•ç½‘ç»œé…ç½®ï¼Œé€šå¸¸ä¸è‡ªå®šä¹‰ç½‘ç»œ driver é…åˆä½¿ç”¨ï¼› é™¤äº†ä¸Šè¿°æ¨¡å¼ä¹‹å¤–ï¼Œæ¯ä¸ªå®¹å™¨ä¹Ÿå¯ä»¥åŠ å…¥å…¶å®ƒå®¹å™¨çš„ç½‘ç»œä¸­ï¼ˆé€šè¿‡åŠ å…¥å¯¹åº”çš„ net namespaceï¼‰ã€‚ docker è¿˜æ”¯æŒä½¿ç”¨è‡ªå®šä¹‰çš„ç½‘ç»œæ’ä»¶ï¼Œè¿™å—ä¸äº†è§£ï¼Œå…·ä½“è§å®˜æ–¹æ–‡æ¡£ã€‚ ä¸‹é¢æ‰€æœ‰ç¤ºä¾‹éƒ½åœ¨è™šæ‹Ÿæœº ubuntu 20.04 ä¸å†…æ ¸ 5.4.0-52-generic ä¸­å®Œæˆï¼Œdocker ç‰ˆæœ¬å¦‚ä¸‹ï¼š $docker version Client: Version: 19.03.8 API version: 1.40 Go version: go1.13.8 Git commit: afacb8b7f0 Built: Wed Oct 14 19:43:43 2020 OS/Arch: linux/amd64 Experimental: false Server: Engine: Version: 19.03.8 API version: 1.40 (minimum version 1.12) Go version: go1.13.8 Git commit: afacb8b7f0 Built: Wed Oct 14 16:41:21 2020 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.3.3-0ubuntu2 GitCommit: runc: Version: spec: 1.0.1-dev GitCommit: docker-init: Version: 0.18.0 GitCommit: ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:1:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2 èƒŒæ™¯çŸ¥è¯† ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:2:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.1 cgroup ä¸ namespace è¿™éƒ¨åˆ†ç½‘ä¸ŠçŸ¥è¯†å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸å¤åˆ¶åˆ«äººçš„äº†ã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:2:1","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.2 docker å¦‚ä½•ä½¿ç”¨ net namespace namespace ç”¨äºå„ä¸ªè¿›ç¨‹é—´çš„ç¯å¢ƒçš„éš”ç¦»ï¼Œè€Œå®¹å™¨è¿è¡Œï¼ˆé host ä¸ container æ¨¡å¼ï¼‰çš„å°±æ˜¯å¤„äºä¸€ä¸ªç‹¬ç«‹çš„ net namespaceã€‚ å½“å¤„äºä¸€ä¸ª net namespace æ—¶ï¼Œå¯ä»¥è®¤ä¸ºï¼Œå†…æ ¸åè®®æ ˆã€iptables(net_filter)ã€ç½‘ç»œè®¾å¤‡ç­‰ä¸å…¶ä»– net namespace éƒ½æ˜¯éš”ç¦»çš„ã€‚ï¼ˆè¿™é‡Œåªæ˜¯è¯´å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œä½†æ˜¯çœŸæ­£è¿˜æ˜¯åªæœ‰ä¸€ä¸ªå†…æ ¸ï¼Œå†…æ ¸ä¸º namespace åšäº†é€»è¾‘ä¸Šçš„éš”ç¦»ï¼‰ åœ¨å®¹å™¨è¿è¡Œä¹‹é—´ï¼Œdocker å°±ä¼šåˆ›å»ºå®¹å™¨å¯¹åº”çš„ net namespaceï¼Œå¹¶æ„å»ºå¥½å¯¹åº”çš„ç½‘ç»œï¼Œç„¶åå°†å…¶ â€˜æŒä¹…åŒ–â€™ï¼ˆå› ä¸ºé»˜è®¤ namespace æ˜¯éšç€è¿›ç¨‹æ¶ˆå¤±è€Œæ¶ˆå¤±çš„ï¼Œå¦‚æœæƒ³è¿›ç¨‹æ¶ˆå¤±è€Œ namespace å­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦å°†å…¶ mount åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸Šï¼‰ã€‚ ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨åï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¹ˆä¸€ä¸ªæŒ‚è½½ï¼š $ mount â€¦ nsfs on /run/docker/netns/9779108cb6b0 type nsfs (rw) è¯¥æ–‡ä»¶å°±æ˜¯å¯¹åº” net namespace çš„æŒ‚è½½ï¼Œé€šè¿‡å¯¹æ¯”å®¹å™¨è¿›ç¨‹çš„ netns inode ä¸ æ–‡ä»¶ inode å¯ä»¥è¯æ˜ï¼š $ docker top br0_container UID PID PPID C STIME TTY TIME CMD root 92658 92640 0 Nov06 pts/0 00:00:00 /bin/bash $ ls -lhi /proc/92658/ns/net 474863 lrwxrwxrwx 1 root root 0 Nov 7 12:42 /proc/92658/ns/net -\u003e 'net:[4026532287]' # æ–‡ä»¶ inode ä¸è¿›ç¨‹ net æŒ‡å‘ inode ç›¸åŒ $ ls -lhi /run/docker/netns/9779108cb6b0 4026532287 -r--r--r-- 1 root root 0 Nov 6 19:47 /run/docker/netns/9779108cb6b0 åœ¨å®¹å™¨è¢«åˆ é™¤åï¼Œå¯¹åº” net namespace å°±ä¼šè¢«é”€æ¯ã€‚ è€Œå„ä¸ªç½‘ç»œæ¨¡å¼æœ€å¤§çš„ä¸åŒï¼Œå°±æ˜¯åœ¨äº namespace åˆ›å»ºåï¼Œå¯¹åº”çš„ â€œæ„å»ºç½‘ç»œâ€ çš„æ“ä½œäº†ã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:2:2","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.3 bridge è™šæ‹Ÿç½‘ç»œè®¾å¤‡ bridge ç½‘ç»œè®¾å¤‡ ç›¸å½“äºä¸€ä¸ª â€œäº¤æ¢æœºâ€ï¼Œè®©ä»»ä½•å…¶ä»–ç½‘ç»œè®¾å¤‡é“¾æ¥ä¸Š bridge æ—¶ï¼Œæ‰€æœ‰åŒ…çš„éƒ½ä¼šæ— æ¡ä»¶ç»è¿‡ bridge è½¬å‘ï¼Œè€Œé“¾æ¥çš„ç½‘ç»œè®¾å¤‡å°±å˜æˆäº†ä¸€æ ¹ â€œç½‘çº¿â€ã€‚ ä¸è¿‡ä¸çœŸå®çš„äº¤æ¢æœºä¸åŒï¼Œbrdige ç½‘å¡å¯ä»¥è¢«èµ‹å€¼ IPï¼Œå½“ bridge æ‹¥æœ‰ IP åï¼Œå®ƒå°±ä¸å†…æ ¸åè®®æ ˆè¿æ¥äº†ï¼Œå› æ­¤æ¥æ”¶åˆ°çš„åŒ…å¯ä»¥åˆ°è¾¾å†…æ ¸åè®®æ ˆçš„ IP å±‚å¤„ç†ï¼Œä¹Ÿå°±ä¼šç»è¿‡ net_filter å¤„ç†ã€‚ æ¨èé˜…è¯» bridge ç½‘å¡æ¨èé˜…è¯»ï¼šLinux è™šæ‹Ÿç½‘ç»œè®¾å¤‡ä¹‹ bridgeï¼ˆæ¡¥ï¼‰ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:2:3","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.4 veth-pair è™šæ‹Ÿç½‘ç»œè®¾å¤‡ veth-pair è®¾å¤‡ æ€»æ˜¯æˆå¯¹çš„å‡ºç°ï¼Œå½“æ•°æ®åŒ…è¿›å…¥ä¸€ç«¯ veth è®¾å¤‡æ—¶ï¼Œä¼šä»å¦ä¸€ç«¯ veth è®¾å¤‡å‡ºã€‚veth-pair ä¸¤ä¸ªè®¾å¤‡å¯ä»¥å¤„äºä¸åŒçš„ net namespaceï¼Œä¹Ÿå°±å¯ä»¥å®ç°ä¸åŒ net namespace é—´æ•°æ®ä¼ è¾“ã€‚ é»˜è®¤ä¸‹ï¼Œveth è®¾å¤‡é“¾æ¥çš„ä¸¤ç«¯æ˜¯å†…æ ¸åè®®æ ˆã€‚ä¸è¿‡ veth è®¾å¤‡é“¾æ¥ä¸Š bridgeï¼Œè¿™æ ·å¦ä¸€ç«¯å‘é€çš„æ•°æ®éƒ½ä¼šç”± bridge å¤„ç†ã€‚ æ¨èé˜…è¯» veth-pair è®¾å¤‡äº†è§£æ¨èæ–‡ç« ï¼šLinux è™šæ‹Ÿç½‘ç»œè®¾å¤‡ä¹‹ veth ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:2:4","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"2.5 macvlan è™šæ‹Ÿç½‘ç»œè®¾å¤‡ macvlan ç½‘ç»œè®¾å¤‡ å¯ä»¥æœ‰ mac åœ°å€ä¸ ip åœ°å€ï¼Œç”¨äºå°† net namespace è¿æ¥åˆ°å®¿ä¸»æœºçš„ç‰©ç†ç½‘ç»œä¸­ï¼Œç›¸å½“äºï¼Œå®¹å™¨ç›´æ¥è¿æ¥ç€ç‰©ç†ç½‘ç»œã€‚ macvlan ç½‘ç»œè®¾å¤‡æœ‰ç€å¤šç§çš„æ¨¡å¼ï¼ŒåŒ…æ‹¬ï¼šbridgeã€private ç­‰ï¼Œè¿™å½±å“ç€å„ä¸ª macvlan ç½‘ç»œè®¾å¤‡ä¹‹é—´çš„é€šä¿¡ã€‚ æ›´å¤š macvlan ç½‘ç»œè®¾å¤‡æ¨èæ–‡ç« ï¼šLinux interfaces for virtual networking ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:2:5","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"3 Bridge ç½‘ç»œ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:3:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"3.1 åˆ›å»º/åˆ é™¤ Bridge ç½‘ç»œ (1) åˆ›å»ºç½‘ç»œ å…ˆè¯•ç€åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ bridge ç½‘ç»œï¼Œè§‚å¯Ÿ docker ä¼šå¯¹åº”åˆ›å»ºå“ªäº›ä¸œè¥¿ã€‚ $ docker network create --driver=bridge \\ --subnet=192.168.100.0/24 \\ --ip-range=192.168.100.0/26 \\ --gateway=192.168.100.1 \\ --opt com.docker.network.bridge.name=mybr0 \\ mybridge0 2e61a7dc333c1bc61d9cb86503ce4cd5a7435977ea2f9b7cc97fc71ae0e2bb93 --driver=bridge æŒ‡å®šåˆ›å»ºçš„ç½‘ç»œ driverï¼› --subnet=192.168.100.0/24 æŒ‡å®šå¯¹åº” bridge ç½‘ç»œçš„ç½‘æ®µï¼› --ip-range=192.168.100.0/26 æŒ‡å®šè¿è¡Œåˆ†é…ç»™å®¹å™¨çš„ ip èŒƒå›´ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªæ˜¯è¦åœ¨æŒ‡å®šçš„ç½‘æ®µå†…çš„ï¼› --gateway=192.168.100.1 æŒ‡å®šè¯¥å†…ç½‘çš„ç½‘å…³ IPï¼› --opt com.docker.network.bridge.name=mybr0 æŒ‡å®šåˆ›å»ºè™šæ‹Ÿ bridge ç½‘å¡çš„å‘½åï¼› mybridge0 ä¸ºåˆ›å»ºçš„ docker network çš„å‘½åï¼› é€šè¿‡ ifconfig å¯ä»¥çœ‹åˆ°ï¼Œbridge ç½‘ç»œåˆ›å»ºä¼šå¯¹åº”åˆ›å»ºä¸€ä¸ª bridge ç½‘ç»œè®¾å¤‡ï¼Œä½œä¸ºæ•´ä¸ªå†…ç½‘çš„ â€˜äº¤æ¢æœºâ€™ã€‚å…¶ IP å°±æ˜¯æŒ‡å®šçš„ gateway IPã€‚ $ ifconfig â€¦ mybr0: flags=4099\u003cUP,BROADCAST,MULTICAST\u003e mtu 1500 inet 192.168.100.1 netmask 255.255.255.0 broadcast 192.168.100.255 ether 02:42:46:8a:cf:34 txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 â€¦ $ brctl show bridge name bridge id STP enabled interfaces mybr0 8000.0242efdb0984 no ä½†æ˜¯ä¸è™šæ‹Ÿæœºç½‘ç»œä¸­çš„ bridge ç½‘å¡ä¸åŒï¼Œè¯¥ bridge ä¸ä¼šè¿æ¥ä»»ä½•çš„ç‰©ç†ç½‘å¡ï¼Œä»…ä»…æ˜¯ä½œä¸ºå†…ç½‘çš„ â€˜äº¤æ¢æœºâ€™ ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œæ¯•ç«Ÿå†…ç½‘æ˜¯è™šæ‹Ÿçš„ï¼Œæ²¡æœ‰å®é™…ä¸ç‰©ç†ç½‘ç»œè¿æ¥ï¼Œå¦‚ä½•è®¿é—®å¤–ç½‘å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼Œé€šè¿‡å†…æ ¸ iptables è¿›è¡Œ NATï¼Œç„¶åå°†åŒ…ä»å®é™…çš„ç‰©ç†ç½‘å¡ä¸Šå‘é€ä¸æ¥å—ã€‚å› æ­¤è¿˜æœ‰ä¸€éƒ¨åˆ†çš„æ”¹å˜åœ¨äº iptablesï¼Œä¸»è¦ä¼šå»ºç«‹çš„æ˜¯ nat ä¸ filter è¡¨çš„è§„åˆ™ã€‚ å…ˆçœ‹ nat è¡¨çš„ç›¸å…³è§„åˆ™ï¼ˆä¸‹é¢è¾“å‡ºä¸­çœç•¥äº†ä¸ç›¸å…³è§„åˆ™ï¼‰ï¼š $ iptables -t nat -L -nv Chain PREROUTING (policy ACCEPT 2 packets, 88 bytes) target prot opt in out source destination DOCKER all -- * * 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL Chain INPUT (policy ACCEPT 2 packets, 88 bytes) target prot opt in out source destination Chain OUTPUT (policy ACCEPT 124 packets, 8797 bytes) target prot opt in out source destination DOCKER all -- * * 0.0.0.0/0 !127.0.0.0/8 ADDRTYPE match dst-type LOCAL Chain POSTROUTING (policy ACCEPT 124 packets, 8797 bytes) target prot opt in out source destination MASQUERADE all -- * !mybr0 192.168.100.0/24 0.0.0.0/0 Chain DOCKER (2 references) target prot opt in out source destination RETURN all -- mybr0 * 0.0.0.0/0 0.0.0.0/0 PREROUTING ä¸ OUTPUT é“¾ä¸­è§„åˆ™ï¼Œä½¿å¾—æ‰€æœ‰å…¥å’Œå‡ºçš„åŒ…éƒ½ä¼šç»è¿‡ DOCKER é“¾ï¼› POSTROUTING é“¾ä¸­ï¼Œå°† mybridge0 ç½‘ç»œï¼ˆ192.168.100.0/24ï¼‰çš„å†…ç½‘ ip é€šè¿‡ MASQUERADE è¡Œä¸ºè¿›è¡Œä¼ªè£…ï¼ˆå¯ä»¥ç®€å•è®¤ä¸ºå†…ç½‘ ip ä¼šå˜ä¸ºå½“å‰ç½‘å¡çš„ ipï¼‰ï¼› å½“ç„¶ï¼Œå¦‚æœåŒ…å‘å¾€çš„æ˜¯ mybr0 ç½‘å¡ï¼Œè¯´æ˜æ˜¯ mybridge0 ç½‘ç»œå†…éƒ¨é€šä¿¡ï¼Œå°±ä¸éœ€è¦è¿›è¡Œ MASQUERADE ä¼ªè£…ï¼ˆ!mybr0ï¼‰ï¼› å½“å®¹å™¨å‘åŒ…æ—¶ï¼Œä¼šé€šè¿‡ mybr0 ç½‘å¡è½¬å‘è¿›å…¥å†…æ ¸æ ˆï¼Œå› æ­¤åœ¨ filter è¡¨ä¸­ï¼Œç›¸å…³çš„è§„åˆ™éƒ½æ˜¯é’ˆå¯¹äº â€œin=mybr0â€ã€‚çœ‹ä¸€ä¸‹ filter è¡¨çš„è§„åˆ™ï¼š $ iptables -t filter -L -nv Chain INPUT (policy ACCEPT 61774 packets, 79M bytes) Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) target prot opt in out source destination DOCKER-USER all -- * * 0.0.0.0/0 0.0.0.0/0 DOCKER-ISOLATION-STAGE-1 all -- * * 0.0.0.0/0 0.0.0.0/0 ACCEPT all -- * mybr0 0.0.0.0/0 0.0.0.0/0 ctstate RELATED,ESTABLISHED DOCKER all -- * mybr0 0.0.0.0/0 0.0.0.0/0 ACCEPT all -- mybr0 !mybr0 0.0.0.0/0 0.0.0.0/0 ACCEPT all -- mybr0 mybr0 0.0.0.0/0 0.0.0.0/0 Chain OUTPUT (policy ACCEPT 42290 packets, 55M bytes) target prot opt in out source destination Chain DOCKER (2 references) target prot opt in out source destination Chain DOCKER-ISOLATION-STAGE-1 (1 references) target prot opt in out source destination DOCKER-ISOLATION-STAGE-2 all -- mybr0 !mybr0 0.0.0.0/0 0.0.0.0/0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 Chain DOCKER-ISOLATION-STAGE-2 (2 references) target prot opt in out source destination DROP all -- * mybr0 0.0.0.0/0 0.0.0.0/0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 Chain DOCKER-USER (1 references) target prot opt in out source destination RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 FORWARD -\u003e DOCKER-ISOLATION-STAGE-1 -\u003e DOCKER-ISOLATION-STAGE-2 è¡¨æ˜å…è®¸åŒ…ä» mybr0 è¿›å…¥å¹¶è½¬å‘ï¼ˆå³å®¹å™¨å¯ä»¥å‘å¤–æ­£å¸¸å‘åŒ…ï¼‰ï¼› FORWARD ä¸­å¯¹ mybr0 è¿›å…¥çš„åŒ…è®¾ç½®äº† conntrackï¼Œä½¿å¾—èƒ½å¤Ÿæ”¶åˆ°è¿æ¥å»ºç«‹åçš„æ­£å¸¸çš„å›åŒ…ï¼› (2) åˆ é™¤ç½‘ç»œ é€šè¿‡ docker network remove åˆ é™¤ç½‘ç»œæ—¶ï¼Œä¼šå‘ç°å¯¹åº”çš„ bridge ç½‘å¡ä¸ iptables è§„åˆ™éƒ½è¢«åˆ é™¤ã€‚ $ docker network remove 5a17670afb6f 5a17670afb6f ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:3:1","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"3.2 å¯åŠ¨å®¹å™¨åçš„ç½‘ç»œ ä¸‹é¢çœ‹ä¸‹å®¹å™¨å¯åœåï¼Œå¸¦æ¥çš„ç½‘ç»œå˜åŒ–ã€‚å…ˆå¯åŠ¨æœ€ç®€å•çš„ä¸€ä¸ªå®¹å™¨ï¼ŒæŒ‡å®šä½¿ç”¨ç½‘ç»œä¸ºä¸Šé¢åˆ›å»ºçš„ mybridge0ã€‚ $ docker run -dt --rm --network=mybridge0 --name br0_container ubuntu 676f7f9eab12a20fb3a975fa99cc2c92433a9581b5774ea58e63d447d86aa5ad $ docker inspect 676f7f9eab12 â€¦ \"Networks\": { \"mybridge0\": { \"IPAMConfig\": null, \"Links\": null, \"Aliases\": [ \"882cac3e472f\" ], \"NetworkID\": \"af1dbf619ac62be1ad8a6b63696d3e6edff77cceab6cd0ee78de4b51e0d33683\", \"EndpointID\": \"56cd85c5121d7d14146fcacc75599f6c56034e758e81f405a51437276ac6ac9f\", \"Gateway\": \"192.168.100.1\", \"IPAddress\": \"192.168.100.2\", \"IPPrefixLen\": 24, \"IPv6Gateway\": \"\", \"GlobalIPv6Address\": \"\", \"GlobalIPv6PrefixLen\": 0, \"MacAddress\": \"02:42:c0:a8:64:02\", \"DriverOpts\": null } } â€¦ --network=mybridge0 è¡¨æ˜ä»¥ mybridge0 ç½‘ç»œå¯åŠ¨å®¹å™¨ï¼› è§‚å¯Ÿå®¹å™¨å…·ä½“å‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨è¢«éšæœºåˆ†é… mybridge0 è®¾ç½®çš„ ip-range ä¸€ä¸ª ipï¼Œå¹¶ä¸” gateway å°±æ˜¯ mybridge0 ç½‘ç»œçš„ç½‘å…³åœ°å€ï¼› è§‚å¯Ÿç½‘ç»œè®¾å¤‡ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª veth-pair è®¾å¤‡ å‡ºç°åœ¨å®¿ä¸»æœºä¸Šï¼Œå¹¶ä¸”è¿æ¥åˆ°äº† mybr0 ç½‘å¡ï¼š $ ifconfig â€¦ vethef6b174: flags=4163\u003cUP,BROADCAST,RUNNING,MULTICAST\u003e mtu 1500 inet6 fe80::e8ad:86ff:fefe:14ca prefixlen 64 scopeid 0x20\u003clink\u003e ether ea:ad:86:fe:14:ca txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 23 bytes 1882 (1.8 KB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 â€¦ $ brctl show bridge name bridge id STP enabled interfaces mybr0 8000.0242efdb0984 no vethef6b174 veth-pair éƒ½æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œå¯ä»¥ç®€å•è¢«çœ‹åšä¸€ä¸ªé€šé“ï¼Œä¸€ç«¯å‘å…¥çš„åŒ…ä¼šä»å¦ä¸€ç«¯å‘å‡ºï¼Œå¹¶è¿›å…¥å†…æ ¸åè®®æ ˆã€‚ä¸è¿‡ï¼Œåœ¨ bridge ç½‘ç»œç¯å¢ƒä¸‹ï¼Œveth5b480f8 è¿æ¥åˆ° mybr0ï¼Œæ‰€ä»¥æ‰€æœ‰ä» veth5b480f8 å‘å‡ºçš„åŒ…éƒ½ä¼šè¢« mybr0 æ¥æ‰‹è½¬å‘ï¼ˆç›¸å½“äºå°±æ˜¯ä¸€æ ¹ç½‘çº¿æ’å…¥äº†äº¤æ¢æœºï¼‰ã€‚ å¯ä»¥è¿›å…¥å®¹å™¨ namespaceï¼Œçœ‹ä¸€ä¸‹å®¹å™¨å†…çš„ veth è®¾å¤‡ã€‚ $ docker exec -it br0_container bash # ä»¥ä¸‹åœ¨å®¹å™¨ namesapce ç¯å¢ƒæ‰§è¡Œ root@676f7f9eab12:/# ifconfig eth0: flags=4163\u003cUP,BROADCAST,RUNNING,MULTICAST\u003e mtu 1500 inet 192.168.100.2 netmask 255.255.255.0 broadcast 192.168.100.255 ether 02:42:c0:a8:64:02 txqueuelen 0 (Ethernet) RX packets 1928 bytes 21609413 (21.6 MB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 1817 bytes 102779 (102.7 KB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 root@676f7f9eab12:/sys/class/net/eth0# ethtool -i eth0 driver: veth version: 1.0 firmware-version: expansion-rom-version: bus-info: supports-statistics: yes supports-test: no supports-eeprom-access: no supports-register-dump: no supports-priv-flags: no root@676f7f9eab12:~# cat /sys/class/net/eth0/iflink 15 åœ¨å®¹å™¨å†…çš„ä»…ä»…æœ‰ä¸€ä¸ª eth0 ç½‘å¡ï¼Œip è®¾ç½®ä¸ºäº†å®¹å™¨çš„ ipã€‚ä½†æ˜¯å…¶å®è¿™ä¸ªç½‘å¡å°±æ˜¯ veth è®¾å¤‡æ”¹äº†åå­—ï¼› é€šè¿‡ ethtool -i eth0 å‘½ä»¤çœ‹åˆ°ï¼Œå…¶å¯¹åº” driver æ˜¯ vethï¼Œå¹¶ä¸” /sys/class/net/eth0/iflink æ–‡ä»¶è¡¨æ˜äº†å¯¹ç«¯çš„ veth ç½‘å¡ç¼–å·ä¸º 15ï¼ˆå³å®¿ä¸»æœºçœ‹åˆ°çš„ veth ç½‘å¡è®¾å¤‡ï¼‰ï¼› ç°åœ¨ï¼Œæˆ‘ä»¬è¯•ç€å¯åŠ¨å®¹å™¨å¹¶æ·»åŠ ä¸€ä¸ª tcp ç«¯å£æ˜ å°„ã€‚ $ docker run -dt --rm \\ --network=mybridge0 --publish 12211:8080 \\ --name br0_container ubuntu 2502f7397a37e2ab482f8a9152d1ed968dd2e2825c71eb2a6737e4900f7236c1 è€Œè¿™ä¸ªç«¯å£æ˜ å°„ï¼Œå°±æ˜¯å°†å®¿ä¸»æœºçš„ 12211 ç«¯å£æ˜ å°„ç»™å®¹å™¨çš„ 8080ï¼Œæ‰€ä»¥æ‰€æœ‰å‘å¾€å®¿ä¸»æœºçš„ 12211 ç«¯å£çš„åŒ…ï¼Œéƒ½ä¼šè¢«ä¿®æ”¹ç«¯å£å¹¶è½¬å‘åˆ°å®¹å™¨å†…éƒ¨ã€‚è¿™ä¹Ÿæ˜¯é€šè¿‡ iptables å®ç°çš„ï¼š iptables -t nat -L -nv Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes) target prot opt in out source destination DOCKER all -- * * 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL Chain INPUT (policy ACCEPT 0 packets, 0 bytes) target prot opt in out source destination Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) target prot opt in out source destination DOCKER all -- * * 0.0.0.0/0 !127.0.0.0/8 ADDRTYPE match dst-type LOCAL Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination 10 617 MASQUERADE all -- * !mybr0 192.168.100.0/24 0.0.0.0/0 0 0 MASQUERADE tcp -- * * 192.168.100.2 192.168.100.2 tcp dpt:8080 Chain DOCKER (2 references) pkts bytes target prot opt in out source destination 0 0 RETURN all -- mybr0 * 0.0.0.0/0 0.0.0.0/0 0 0 DNAT tcp -- !mybr0 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:12211 to:192.168.100.2:8080 PREROUTING -\u003e DOCKER é“¾ä¸­ï¼Œæ‰€æœ‰ä¸æ˜¯ä» mybr0 è¿›å…¥çš„åŒ…ï¼Œå¹¶ä¸”å‘å¾€ tcp 12211 ç«¯å£çš„åŒ…ï¼Œéƒ½ä¼šè¢« DNAT ä¸ºå‘å¾€ 192.168.100.2:8080ã€‚è¿™æ ·å°±å®ç°äº†ç«¯å£æ˜ å°„çš„åŠŸèƒ½ã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:3:2","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"3.3 bridge ç½‘ç»œæ€»ç»“ ä¸­å¿ƒæ€æƒ³ï¼šbridge ç½‘ç»œä½¿ç”¨ bridge ç½‘å¡åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°çš„å†…ç½‘ï¼Œè€Œ bridge ç½‘å¡ + iptables è§„åˆ™æˆä¸ºäº†è¿™ä¸ªå†…ç½‘çš„ â€˜è·¯ç”±å™¨'ã€‚å…¶ä¸­ï¼š bridge ç½‘å¡ä½œä¸ºäºŒå±‚çš„äº¤æ¢æœºï¼Œbridge ç½‘å¡ ip ä½œä¸ºè·¯ç”±å™¨çš„ç½‘å…³ ipã€‚ iptables è§„åˆ™å®ç°äº† brdige ç½‘å¡ä¸ç‰©ç†ç½‘ç»œçš„è¿æ¥ å®¿ä¸»æœºå†…æ ¸æ ˆå®ç°äº†è¿™ä¸ª â€˜è·¯ç”±å™¨â€™ çš„è·¯ç”±åŠŸèƒ½ã€‚ ä¸‹å›¾å±•ç¤ºäº†æ•´ä¸ª bridge ç½‘ç»œçš„æ¨¡å‹ï¼ˆå›¾ç‰‡æ¥è‡ªç½‘ç»œï¼‰ï¼š å…¶ä¸­æ¯”è¾ƒå…³é”®çš„ç‚¹ï¼š veth pair è®¾å¤‡å°†å®¹å™¨ net namespace è¿æ¥åˆ° bridge ç½‘å¡ï¼ˆå¯ä»¥çœ‹åšå°† veth pair ä½œä¸ºç½‘çº¿æ’åˆ°äº† bridge è¿™ä¸ª â€˜è·¯ç”±å™¨â€™ ä¸Šï¼‰ã€‚ iptables å®ç°äº† bridge ç½‘å¡ä¸ç‰©ç†ç½‘ç»œçš„ â€˜è¿æ¥â€™ã€‚ bridge ç½‘å¡æ”¶åˆ°çš„åŒ…ï¼Œç»è¿‡ iptables çš„ MASQUERADE å°†åŒ…è¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¹¶ç»è¿‡å†…æ ¸åè®®æ ˆçš„è·¯ç”±é€šè¿‡ç‰©ç†ç½‘å¡å‘é€åˆ°ç‰©ç†ç½‘ç»œã€‚è€Œå›åŒ…é€šè¿‡ conntrack æœºåˆ¶æ­£å¸¸æ¥æ”¶ä¸é€†åœ°å€è½¬æ¢ã€‚ å®¹å™¨ä¸å®¿ä¸»æœºçš„ç«¯å£æ˜ å°„ï¼Œä¹Ÿæ˜¯é€šè¿‡ iptables çš„ DNAT å®ç°çš„ã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:3:3","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"4 Host ç½‘ç»œ Host ç½‘ç»œæ²¡å•¥å¥½è¯´çš„ï¼Œå¯åŠ¨å®¹å™¨ä¸åˆ›å»ºæ–°çš„ namespaceï¼Œä¾æ—§åœ¨å®¿ä¸»æœºçš„ net namespace ä¸‹ã€‚ $ docker run -dt --rm --network=host --name host_container ubuntu da1c426a7c7501b329258b12cb475ff42669837ca686d6e946511632461cc946 è§‚å¯Ÿ mountï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”è¿˜æ˜¯æœ‰ net namespace çš„æ–‡ä»¶æŒ‚è½½ï¼Œæ–‡ä»¶åä¸º defaultï¼š $ mount â€¦ nsfs on /run/docker/netns/default type nsfs (rw) æ–‡ä»¶ inode å¯¹æ¯”å½“å‰å®¿ä¸»æœº net namespace inodeï¼Œæ˜¯ä¸€è‡´çš„ï¼š $ ls -lh /proc/self/ns/net lrwxrwxrwx 1 root root 0 Nov 7 14:47 /proc/self/ns/net -\u003e 'net:[4026531992]' $ ls -lhi /run/docker/netns/default 4026531992 -r--r--r-- 1 root root 0 Oct 30 16:50 /run/docker/netns/default ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:4:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"5 macvlan ç½‘ç»œ macvlan ç½‘ç»œä½¿ç”¨ macvlan è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå°†å®¹å™¨ net namespace ç½‘ç»œæš´éœ²åœ¨ä¸å½“å‰å®¿ä¸»æœºåŒçº§çš„å±€åŸŸç½‘å†…ï¼Œç›¸å½“äºå®¹å™¨å°±æ˜¯å½“å‰ç½‘ç»œå†…çš„ä¸€å° â€œä¸»æœºâ€ã€‚ macvlan ç½‘ç»œè®¾å¤‡ä¹ŸåŒ…æ‹¬å¤šç§æ¨¡å¼ï¼šbridge modeã€802.1q trunk bridge modeã€‚ä¸‹é¢ç¤ºä¾‹éƒ½æ˜¯åŸºäºæ™®é€šçš„ brdige modeã€‚ å› ä¸º macvlan ç½‘ç»œåœ¨è™šæ‹Ÿæœºç½‘ç»œä¸‹ä¸å¤ªå¥½éªŒè¯ï¼Œæ‰€ä»¥ä¸‹é¢ä¾‹å­æ¥è‡ªäºä¸€å°ç‰©ç†æœºä¸Šã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:5:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"5.1 åˆ›å»º/åˆ é™¤ macvlan ç½‘ç»œ é€šè¿‡ docker network create åˆ›å»º macvlan ç½‘ç»œã€‚ $ docker network create -d macvlan \\ --subnet=192.168.67.130/24 --gateway=192.168.67.1 \\ -o parent=eth0 mymacvlan0 633aae3d4f430352e5439e2650c02fe9c2092b99b5b8252f8141fa5d62ec7e70 -d macvlanï¼ŒæŒ‡å®š macvlan ç½‘ç»œ -subnet=192.168.67.130/24ï¼Œå› ä¸º macvlan ç½‘ç»œä¸‹çš„å®¹å™¨ä¼šç›´æ¥è¿å…¥ç‰©ç†ç½‘ç»œï¼Œæ‰€ä»¥å­ç½‘ä¹Ÿæ˜¯è¦åœ¨å½“å‰å­ç½‘å†…ï¼› --gateway=192.168.67.1ï¼ŒåŒæ ·ï¼Œgateway å°±æ˜¯å®¿ä¸»æœºçš„ç½‘å…³åœ°å€ï¼› -o parent=eth0ï¼ŒæŒ‡å®š macvlan è®¾å¤‡é“¾æ¥çš„ç‰©ç†ç½‘å¡ï¼Œä¸€å®šè¦æ˜¯ä¸€ä¸ªçœŸæ­£å¯è”ç½‘çš„ç‰©ç†ç½‘å¡ï¼› ä¸è¿‡ä¸ bridge ç½‘ç»œä¸åŒçš„æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ª macvlan ç½‘ç»œä»…ä»…æ˜¯è®°å½•å…¶å¯¹åº”çš„é…ç½®ï¼Œä¸ä¼šåˆ›å»ºå¯¹åº”çš„ macvlan ç½‘å¡æˆ–è€… iptables è§„åˆ™ã€‚å› ä¸º macvlan ç½‘å¡æ˜¯ä¸ net namespace ç»‘å®šçš„ï¼Œæ‰€ä»¥å½“åˆ›å»º net namespace æ—¶æ‰ä¼šå‡ºç°å¯¹åº”ç½‘ç»œè®¾å¤‡ã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:5:1","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"5.2 å¯åœå®¹å™¨åçš„ç½‘ç»œ $ docker run --net=mymacvlan0 \\ -dt --rm --name macvlan_container \\ --ip=192.168.67.139 --privileged \\ centos_ctr bash 2eff4835733734b6819c7f97ae41585985d95c1ea4c66a6a478a43e71b60b6d6 å¯åŠ¨å®¹å™¨ï¼Œå¦‚æœä¸æŒ‡å®š IPï¼ŒDocker ä¼šåœ¨é…ç½®çš„ç½‘æ®µé‡Œåˆ†é…ä¸€ä¸ªã€‚ tip ä¸ºäº†èƒ½å¤Ÿæ–¹ä¾¿æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼Œä½¿ç”¨çš„å®¹å™¨é•œåƒ centos_ctr æ˜¯ç”± centos é•œåƒä»¥ host ç½‘ç»œå¯åŠ¨ï¼Œé¢„è£…ä¸€äº›å‘½ä»¤åï¼Œæ‰ç”±å®¹å™¨å¯¼å‡ºçš„é•œåƒã€‚ ä½†æ˜¯å‘ç°è¿›å…¥å®¹å™¨åï¼Œå‘ç°é™æ€é…ç½® IP æ— æ³• ping é€šç½‘å…³ï¼ˆå®¿ä¸»æœºæ˜¯æ­£å¸¸æ— æ³• ping é€šï¼Œå› ä¸ºå†…æ ¸ä¼šä¸¢å¼ƒ macvlan ç½‘å¡çš„åŒ…ï¼‰ã€‚ç ”ç©¶åä¸æ¸…æ¥šå…·ä½“åŸå› ï¼Œä½†æ˜¯è¿™å°å®¿ä¸»æœºæ¥çš„æ˜¯äº¤æ¢æœºï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¸æ˜¯è·¯ç”±å™¨å¯¼è‡´çš„ã€‚ $ docker exec -it macvlan_container bash # ä»¥ä¸‹æ˜¯å®¹å™¨ä¸­å‘½ä»¤ [root@2eff48357337 /]# ifconfig eth0: flags=4163\u003cUP,BROADCAST,RUNNING,MULTICAST\u003e mtu 1500 inet 192.168.67.139 netmask 255.255.255.0 broadcast 192.168.67.255 ether 02:42:c0:a8:43:8b txqueuelen 0 (Ethernet) RX packets 433282 bytes 27463954 (26.1 MiB) RX errors 0 dropped 26809 overruns 0 frame 0 TX packets 91342 bytes 6649728 (6.3 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 [root@2eff48357337 /]# ping 192.168.67.1 PING 192.168.67.1 (192.168.67.1) 56(84) bytes of data. From 192.168.67.139 icmp_seq=1 Destination Host Unreachable From 192.168.67.139 icmp_seq=2 Destination Host Unreachable å› æ­¤ï¼Œæ¢ä¸ªæ€è·¯ï¼Œé™æ€ IP ä¸è¡Œï¼Œå°±é€šè¿‡ DHCP è·å–ä¸€ä¸ª IP å°è¯•æ˜¯å¦èƒ½å¤Ÿè¿é€šç½‘ç»œã€‚ åœ¨åˆ é™¤é™æ€ IP ä¹‹åï¼Œè°ƒç”¨ dhclient ä»ä¸Šå±‚è·¯ç”±å™¨è·å–ä¸€ä¸ª IPã€‚ # åˆ é™¤ eth0 ç½‘å¡ IP [root@2eff48357337 /]# ip address del 192.168.67.139 dev eth0 Warning: Executing wildcard deletion to stay compatible with old scripts. Explicitly specify the prefix length (192.168.67.139/32) to avoid this warning. This special behaviour is likely to disappear in further releases, fix your scripts! [root@2eff48357337 /]# ifconfig eth0: flags=4163\u003cUP,BROADCAST,RUNNING,MULTICAST\u003e mtu 1500 ether 02:42:c0:a8:43:8b txqueuelen 0 (Ethernet) RX packets 435540 bytes 27608133 (26.3 MiB) RX errors 0 dropped 26983 overruns 0 frame 0 TX packets 91763 bytes 6678670 (6.3 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 # è°ƒç”¨ dhclient è·å–æ–°çš„ IP [root@2eff48357337 /]# dhclient -r \u0026\u0026 dhclient -v Removed stale PID file Internet Systems Consortium DHCP Client 4.3.6 Copyright 2004-2017 Internet Systems Consortium. All rights reserved. For info, please visit https://www.isc.org/software/dhcp/ Listening on LPF/eth0/02:42:c0:a8:43:8b Sending on LPF/eth0/02:42:c0:a8:43:8b Sending on Socket/fallback DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0xdf4e0e25) DHCPREQUEST on eth0 to 255.255.255.255 port 67 (xid=0xdf4e0e25) DHCPOFFER from 192.168.9.253 DHCPACK from 192.168.9.253 (xid=0xdf4e0e25) System has not been booted with systemd as init system (PID 1). Can't operate. Failed to create bus connection: Host is down bound to 192.168.9.235 -- renewal in 38783 seconds. [root@2eff48357337 /]# ifconfig eth0: flags=4163\u003cUP,BROADCAST,RUNNING,MULTICAST\u003e mtu 1500 inet 192.168.9.235 netmask 255.255.255.0 broadcast 192.168.9.255 ether 02:42:c0:a8:43:8b txqueuelen 0 (Ethernet) RX packets 435635 bytes 27614880 (26.3 MiB) RX errors 0 dropped 27001 overruns 0 frame 0 TX packets 91767 bytes 6679438 (6.3 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 [root@2eff48357337 /]# route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 192.168.9.253 0.0.0.0 UG 0 0 0 eth0 192.168.9.0 0.0.0.0 255.255.255.0 U 0 0 0 eth0 å¯ä»¥çœ‹åˆ°ï¼ŒDHCP è·å¾—çš„ IP ä¸å®¿ä¸»æœºéƒ½ä¸æ˜¯åŒä¸€ä¸ªç½‘æ®µçš„ï¼Œå¹¶ä¸”ç½‘å…³åœ°å€ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªï¼Œå› æ­¤ä¸Šå±‚è¿ç€äº¤æ¢æœºæœ‰å¤šä¸ªç½‘æ®µï¼ˆè¿™å—ä¸å¤ªç†è§£äº†ï¼‰ã€‚ ä½†æ˜¯ï¼Œæµ‹è¯•åæ˜¯å¯ä»¥ ping é€šç½‘å…³ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®å¤–ç½‘çš„ï¼š [root@2eff48357337 /]# ping 192.168.9.253 PING 192.168.9.253 (192.168.9.253) 56(84) bytes of data. 64 bytes from 192.168.9.253: icmp_seq=1 ttl=64 time=0.637 ms 64 bytes from 192.168.9.253: icmp_seq=2 ttl=64 time=0.250 ms ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:5:2","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"5.3 æ€»ç»“ ä¸­å¿ƒæ€æƒ³ï¼šå°† macvlan ç½‘ç»œå¯åŠ¨å®¹å™¨çœ‹åšä¸€ä¸ªä¸å®¿ä¸»æœºåŒçº§çš„ç½‘ç»œï¼Œå…¶è·å– IP æ–¹å¼éƒ½ä¸æ­£å¸¸çš„æœºå™¨ç›¸åŒã€‚ ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:5:3","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["Docker åŸç†æ€»ç»“"],"content":"å‚è€ƒ Docker å®¹å™¨ç½‘ç»œå®˜æ–¹æ–‡æ¡£ Linux è™šæ‹Ÿç½‘ç»œè®¾å¤‡ä¹‹ bridgeï¼ˆæ¡¥ï¼‰ Linux interfaces for virtual networking ","date":"2020-11-06","objectID":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/:6:0","tags":["docker","container"],"title":"å®¹å™¨ç½‘ç»œæ€»ç»“","uri":"/posts/cloud_computing/how_docker_work/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%80%BB%E7%BB%93/"},{"categories":["VM"],"content":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"ä¸­å¿ƒæ€æƒ³ï¼šé€šè¿‡ libvirt è¿è¡Œä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆdomainï¼‰ï¼Œå¹¶ä¿å­˜å…¶å¯¹åº”çš„ domain çš„é•œåƒæ–‡ä»¶ä¸é…ç½®æ–‡ä»¶ï¼Œç„¶åå°±å¯ä»¥åœ¨å…¶ä»–æœºå™¨é€šè¿‡ virsh define + start æˆ–è€… virt-install å¯åŠ¨ã€‚ è¯´æ˜ï¼šä¸‹é¢ç¯å¢ƒéƒ½æ˜¯åœ¨ centos ä¸Šåˆ¶ä½œåŸºäº KVM çš„è™šæ‹Ÿæœºé•œåƒã€‚ ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:0:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"1 ä» ISO é•œåƒå®‰è£… æœ€åŸºæœ¬çš„å®‰è£…æ–¹å¼ï¼Œé€šè¿‡å®‰è£…å¹¶è¿è¡Œä¸€ä¸ªæ–°çš„è™šæ‹Ÿæœºï¼Œç„¶åå¾—åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸é•œåƒæ–‡ä»¶ã€‚ ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:1:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"1.1 æ‰‹åŠ¨å®‰è£… æœ€åŸºæœ¬çš„å®‰è£…æ–¹å¼ï¼Œé€šè¿‡ ISO æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚ ä¸‹è½½ ISO é•œåƒæ–‡ä»¶ï¼Œé•œåƒæ–‡ä»¶åœ¨å„ä¸ªé•œåƒç«™ä¸­å°±å¯ä»¥æ‰¾åˆ°ã€‚ï¼ˆå› ä¸ºä¸ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œæ‰€ä»¥ä¸‹è½½çš„æ˜¯éå›¾å½¢åŒ–çš„ ISOï¼‰ é€šè¿‡ virt-install å‘½ä»¤å®‰è£…é•œåƒï¼ˆå› ä¸ºä½¿ç”¨çš„æ˜¯éå›¾å½¢åŒ–çš„å®‰è£…ï¼Œæ‰€ä»¥å‚æ•°æœ‰ä¸€äº›ä¸ä¸€æ ·ï¼‰ virt-install --name guest1_fromiso --memory 2048 --vcpus 2 \\ --disk size=8 --location CentOS-7-x86_64-DVD-2003.iso \\ --os-type Linux --os-variant=centos7.0 --virt-type kvm \\ --boot menu=on --graphics none --console pty --extra-args 'console=ttyS0' å…¶ä¸­è¦æ³¨æ„å‡ ä¸ªå‚æ•°ï¼š å› ä¸ºæˆ‘ä»¬æ˜¯å®‰è£…éå›¾å½¢åŒ–ï¼Œæ‰€ä»¥éœ€è¦ --location å‚æ•°æŒ‡å®š isoï¼Œå¹¶æŒ‡å®š --boot menu=on æ‰“å¼€å®‰è£…èœå•ï¼Œæœ€åè¿˜éœ€è¦æŒ‡å®šå®‰è£…ä¿¡æ¯çš„è¾“å‡º --console pty --extra-args 'console=ttyS0' è¿™æ ·å®‰è£…èœå•æ‰èƒ½æ­£å¸¸å±•ç¤ºå‡ºæ¥ --graphics none æŒ‡å®šéå›¾å½¢åŒ–ï¼› --network bridge=virbr0ï¼ŒæŒ‡å®šç½‘ç»œæ¨¡å¼ï¼Œè¿™é‡ŒæŒ‡å®š libvirt é»˜è®¤åˆ›å»ºçš„ bridge ç½‘å¡ï¼Œå¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª libvirt ç»´æŠ¤å†…ç½‘ï¼Œå®‰è£…æ—¶é€‰æ‹© dhcp å°±å¯ä»¥è·å¾—ä¸€ä¸ªå¯ç”¨çš„å†…ç½‘åœ°å€ï¼› å…·ä½“ libvirt çš„ç½‘ç»œæ¨¡å‹ï¼Œåé¢åœ¨å•ç‹¬ç ”ç©¶ä¸‹ã€‚ -- disk size=8ï¼Œdisk å‚æ•°ç”¨äºæŒ‡å®šç³»ç»Ÿç›˜ï¼Œè¿™é‡ŒæŒ‡å®šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª 8G çš„ qcow2 æ–‡ä»¶ï¼Œä½œä¸ºç³»ç»Ÿç›˜ï¼ˆé»˜è®¤é•œåƒæ–‡ä»¶ä¿å­˜åœ¨ /var/lib/libvirt/images/ï¼‰ç›®å½•ä¸‹ï¼› è¿™æ—¶å°±ä¼šè¿›å…¥è™šæ‹Ÿæœºçš„å®‰è£…æ­¥éª¤ï¼Œå…·ä½“å®‰è£…æ­¥éª¤å°±ä¸èµ˜è¿°äº†ã€‚ å®‰è£…æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ° domain å°±è¢«åˆ›å»ºäº†ï¼Œè¿™å°±å¯ä»¥å¾—åˆ°å®ƒçš„é…ç½®æ–‡ä»¶ä¸é•œåƒæ–‡ä»¶äº†ã€‚ $ virsh list Id Name State ---------------------------------------------------- 18 guest1_fromiso running ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:1:1","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"1.2 è‡ªåŠ¨å®‰è£… å¯ä»¥çœ‹åˆ°ï¼Œæ‰‹åŠ¨å®‰è£…éœ€è¦äººä¸ºåœ¨èœå•ä¸­é€‰æ‹©ã€é…ç½®ï¼Œè¿™ä¸é€‚ç”¨äºå¤šä¸ªè™šæ‹Ÿæœºçš„å®‰è£…ã€‚è€Œ RedHat åˆ›å»ºäº† kickstart å®‰è£…æ–¹æ³•ï¼Œä½¿å¾—æ•´ä¸ªè™šæ‹Ÿæœºå®‰è£…æµç¨‹å˜å¾—è‡ªåŠ¨åŒ–ã€‚ è¿™å—ä¸äº†è§£ï¼Œå…·ä½“è§çº¢å¸½å®˜æ–¹æ–‡æ¡£ï¼šKICKSTART INSTALLATIONS ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:1:2","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"2 ä½¿ç”¨ Cloud Image å½“ç„¶ï¼Œä¸Šé¢åˆ¶ä½œè¿‡ç¨‹ä¸­è€—æ—¶éƒ½åœ¨å®‰è£…ç³»ç»Ÿä¸Šäº†ï¼Œè€Œå„ä¸ªäº‘å‚å•†çš„è™šæ‹Ÿæœºæ•°é‡é‚£ä¹ˆå¤šï¼Œè‚¯å®šä¸ä¼šä¸€å°å°å»å®‰è£…æ“ä½œç³»ç»Ÿäº†ã€‚æ‰€ä»¥ï¼Œç›®å‰æœ€å¸¸è§çš„éƒ½æ˜¯ç›´æ¥ä¸‹è½½å·²ç»å®‰è£…è¿‡ç³»ç»Ÿçš„è™šæ‹Ÿæœºé•œåƒæ–‡ä»¶ã€‚ ä½†æ˜¯è¿™æ ·çš„è™šæ‹Ÿæœºæ˜¯æ²¡æœ‰ç‰¹æ®Šé…ç½®çš„ï¼Œä¾‹å¦‚å¯†ç ã€hostname éƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ cloud-init å‡ºç°ï¼Œç”¨äºåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨è™šæ‹Ÿæœºæ—¶è¿›è¡Œç³»ç»Ÿçš„é…ç½®ã€‚ æ‰€ä»¥ï¼Œæœ€å¿«é€Ÿçš„åˆ¶ä½œæ–¹æ³•å°±æ˜¯ï¼šè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶ + cloud-init é…ç½®ã€‚ ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:2:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"2.1 cloud-init ä¸‹é¢å†…å®¹éƒ½æ¥è‡ªäºæ–‡æ¡£ï¼Œè¿™é‡Œä»…ä¸ºè‡ªå·±åšä¸ªè®°å½•ã€‚ é¦–å…ˆæ˜ç¡® cloud init çš„åŠŸèƒ½ï¼šç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œcloud init ç›¸å…³çš„è¿›ç¨‹ä¼šæ ¹æ®é…ç½®ä¿¡æ¯å»è¿›è¡Œç³»ç»Ÿçš„é…ç½®ï¼ŒåŒ…æ‹¬ï¼šè®¾ç½® hostnameã€ssh keyã€password ç­‰ï¼› (1) åŸºæœ¬æ¦‚å¿µ metadataï¼šåŒ…å«æœåŠ¡å™¨ä¿¡æ¯ï¼Œç”¨äº cloud-init é…ç½®ï¼› userdataï¼šåŒ…å« cloud-init ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯ æ–‡ä»¶ï¼Œè„šæœ¬ï¼Œyaml æ–‡ä»¶ç­‰ï¼› datasourceï¼šcloud-init è¯»å–é…ç½®æ•°æ®çš„æ¥æºï¼ŒåŒ…å«å¤§éƒ¨åˆ†äº‘å‚å•†ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªæœ¬åœ°çš„æ–‡ä»¶ (NoCloud datasource)ï¼› (2) è¿è¡Œè¿‡ç¨‹ cloud init è®¾ç½®åŒ…æ‹¬äº”ä¸ªé˜¶æ®µï¼š Generator æœºå™¨å¯åŠ¨é˜¶æ®µï¼Œsystemd çš„ä¸€ä¸ª generator å°†ä¼šå†³å®šæ˜¯å¦å°† cloud-init.targetï¼ˆtarget å¯ä»¥ç®€å•è®¤ä¸ºç‰¹å®šäº‹ä»¶ä¸‹è§¦å‘çš„ä¸€ç»„ unitï¼‰åŒ…å«åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ã€‚è¿™å°±è¡¨ç¤ºå¯åŠ¨ cloud-initã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œgenerator ä¼šå¯åŠ¨ cloud-initï¼Œé™¤éä»¥ä¸‹æƒ…å†µï¼š /etc/cloud/cloud-init.disabled æ–‡ä»¶å­˜åœ¨ï¼› å†…æ ¸å¯åŠ¨å‘½ä»¤è¡Œ /proc/cmdline ä¸­åŒ…å« â€œcloud-init=disabledâ€ã€‚å¦‚æœæ˜¯å®¹å™¨ä¸­è¿è¡Œï¼Œä¼šè¯»å–ç¯å¢ƒå˜é‡ KERNEL_CMDLINEï¼› è€Œä¸‹é¢çš„æ­¥éª¤ï¼Œå°±æ˜¯ç”± target åŒ…å«çš„å„ä¸ª unit æ‰§è¡Œçš„ã€‚ Local ç”± cloud-init-local.service æ‰§è¡Œï¼Œä¸»è¦ç›®çš„ï¼šæ‰¾åˆ° â€œlocalâ€ çš„ datasourceï¼Œæ ¹æ®é…ç½®ç½‘ç»œã€‚ é…ç½®ç½‘ç»œæœ‰ä¸‰ç§æƒ…å†µï¼š é¦–å…ˆï¼Œæ ¹æ®ä¼ å…¥é…ç½® â€œmetadataâ€ é…ç½®ç½‘ç»œï¼› å½“ä¸Šé¢æƒ…å†µå¤±è´¥ï¼Œç›´æ¥é…ç½® â€œdhcp on eth0â€ï¼› å¦‚æœ /etc/cloud/cloud.cfg é…ç½®æ–‡ä»¶ä¸­ç¦ç”¨äº†ç½‘ç»œï¼šnetwork: {config: disabled}ï¼Œé‚£ä¹ˆå°±ä¸è¿›è¡Œç½‘ç»œé…ç½®ï¼› Initã€Configã€Final é˜¶æ®µ å¯¹åº” service ä¸º cloud-init.serviceã€cloud-config.serviceã€ cloud-final.serviceã€‚ é€šè¿‡ local é˜¶æ®µï¼Œç½‘ç»œå·²ç»é…ç½®å¥½äº†ï¼Œå¹¶ä¸”å·²ç»å¾—åˆ°äº† metadataã€‚è€Œ /etc/cloud/cloud.cfg é…ç½®å®šä¹‰äº†å‰©ä¸‹ä¸‰ä¸ªé˜¶æ®µå¯¹åº”çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ moduleã€‚ cloud init é€šè¿‡ä¸€äº›ç¼“å­˜ä¿¡æ¯æ¥åˆ¤æ–­æœºå™¨æ˜¯å¦ç»è¿‡åˆå§‹åŒ–ï¼Œé€šè¿‡ cloud-init clean ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¸…ç†ç¼“å­˜ä¿¡æ¯ã€‚ /var/log/cloud-init.log è®°å½•äº† cloud-init è¿è¡Œçš„å®Œæ•´è¿‡ç¨‹ã€‚ ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:2:1","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"2.2 åˆ¶ä½œé•œåƒ ä¸‹é¢å°±å¼€å§‹è¿›è¡Œé•œåƒåˆ¶ä½œï¼š ä¸‹è½½ cloud imageï¼Œè¿™é‡Œä½¿ç”¨ä¸­ç§‘å¤§æä¾›çš„ï¼š $ wget https://mirrors.ustc.edu.cn/centos-cloud/centos/7/images/CentOS-7-x86_64-GenericCloud-2003.qcow2 ä¿®æ”¹å¯†ç  å½“ç„¶ï¼Œè¯¥é•œåƒå…¶å®å°±å¯ä»¥ç›´æ¥è¿›è¡Œ virt-install æ¥å¯åŠ¨ï¼ˆå› ä¸ºæˆ‘ä»¬æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥é€šè¿‡ virt-install æ¥å¯åŠ¨å¹¶ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼‰ï¼Œä½†æ˜¯ä¸çŸ¥é“å¯†ç ï¼Œä¹Ÿæœä¸åˆ°ï¼Œæ— æ³•ç™»é™†è¿›å…¥ã€‚ä¸è¿‡ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥è®¾ç½®å¯†ç åè¿›è¡Œç™»é™†ï¼š $ virt-customize -a CentOS-7-x86_64-GenericCloud-2003.qcow2 --root-password password:yourpassword å› ä¸º cloud-init éœ€è¦ä¸€ä¸ª datasourceï¼Œè€Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨äº‘å‚å•†ï¼Œæ‰€ä»¥ä½¿ç”¨ NoCloud å½¢å¼ï¼ŒæŒ‰ç…§å®˜æ–¹çš„ s ç¤ºä¾‹åˆ›å»ºä¸€ä¸ª disk æ–‡ä»¶ã€‚ # åˆ›å»º user-data ä¸ meta-date é…ç½®æ–‡ä»¶ $ cat meta-data instance-id: guest1 local-hostname: guest1 $ cat user-data #cloud-config chpasswd: expire: false list: | root: password1 ssh_pwauth: True # ç”Ÿæˆ disk æ–‡ä»¶ï¼ŒåŒ…å« userdata ä¸ metadata é…ç½®æ•°æ® $ genisoimage -output seed.iso -volid cidata -joliet -rock user-data meta-data åˆ›å»ºå¹¶è¿è¡Œè™šæ‹Ÿæœºã€‚ $ virt-install --memory 2048 --vcpus 2 --name guest2 \\ --disk CentOS-7-x86_64-GenericCloud-2003.qcow2 --disk seed.iso \\ --os-type Linux --os-variant centos7.0 --virt-type kvm \\ --graphics none --network default \\ --import å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å‚æ•°ï¼š --disk CentOS-7-x86_64-GenericCloud-2003.qcow2ï¼šåˆ¶å®šç³»ç»Ÿç›˜ï¼› --importï¼šè·³è¿‡å®‰è£…è¿‡ç¨‹ï¼Œå› ä¸ºå·²ç»å®‰è£…å¥½æ“ä½œç³»ç»Ÿï¼Œä¸éœ€è¦è¿›è¡Œå®‰è£…è¿‡ç¨‹ï¼› --disk seed.isoï¼šä¼ é€’ cloud-init datasource ä¿¡æ¯ï¼› è™šæ‹Ÿæœºå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ° cloud-init é…ç½®ä¿¡æ¯çš„ä¸€äº›æ‰“å°ï¼š æœ€åæ ¹æ®é…ç½®çš„å¯†ç æˆåŠŸè¿›å…¥ï¼š è€Œ CentOS-7-x86_64-GenericCloud-2003.qcow2 å°±æ˜¯è™šæ‹Ÿæœºç»è¿‡é…ç½®çš„é•œåƒæ–‡ä»¶ï¼Œè€Œ libvirt å¯åŠ¨æ‰€éœ€çš„é…ç½®æ–‡ä»¶å°±æ˜¯ /etc/libvirt/qemu/guest1.xmlã€‚ ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:2:2","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["VM"],"content":"å‚è€ƒ CREATING GUESTS WITH VIRT-INSTALL KICKSTART INSTALLATIONS cloud-init Documentation ","date":"2020-10-31","objectID":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/:3:0","tags":["è™šæ‹Ÿæœº","KVM","äº‘è®¡ç®—"],"title":"åˆ¶ä½œè™šæ‹Ÿæœºé•œåƒ","uri":"/posts/cloud_computing/vm/%E5%88%B6%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F/"},{"categories":["Kubernetes å®è·µ"],"content":"ä½¿ç”¨è™šæ‹Ÿæœºæ­å»º Kubernetes é›†ç¾¤","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":" Kubernetes å®è·µ ä¸»è¦è®°å½•ä¸€äº›è‡ªå·±çš„ä¸€äº›éƒ¨ç½²å®è·µã€‚ ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:0:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"1 è™šæ‹Ÿæœºé›†ç¾¤æ­å»º ç›®æ ‡ï¼šåˆ›å»º 3 ä¸ªè™šæ‹Ÿæœºï¼Œç”¨ä½œä¸€ä¸ª Master Nodeï¼Œä¸¤ä¸ª Work Nodeï¼›å½“ç„¶ï¼Œä¸‰ä¸ªèŠ‚ç‚¹å¤„äºåŒä¸€ä¸ªç½‘æ®µã€‚ å…·ä½“æ­¥éª¤å¦‚ä¸‹: æ„å»ºèŠ‚ç‚¹ æ„å»ºä¸‰ä¸ªè™šæ‹Ÿæœºï¼ŒåŸºäº centos 7ã€å†…å­˜ 2 GBï¼Œå¹¶é€šè¿‡è™šæ‹Ÿæœºå¤åˆ¶åŠŸèƒ½ï¼ˆå…¶å®å°±æ˜¯ copy ç³»ç»Ÿç›˜ï¼‰ï¼Œå®Œå…¨å¤åˆ¶å‡º Node 1ï¼ŒNode 2ï¼ŒNode 3ã€‚ æ­å»ºç½‘ç»œ ä¸‰ä¸ªèŠ‚ç‚¹éœ€è¦äº’ç›¸è®¿é—®ï¼Œæ‰€ä»¥å°†å…¶ä½äº VirtualBox åˆ›å»ºçš„ Natç½‘ç»œä¸‹ï¼Œç»™äºˆæ¯ä¸ª Node é™æ€çš„ IPï¼ˆ10.0.2.10 - 10.0.2.12ï¼‰ï¼Œä¸ºäº†æ–¹ä¾¿è®¿é—®ï¼Œå¹¶è®¾ç½® ssh çš„ DNATã€‚ è®¾ç½®æ¯ä¸ªè™šæ‹Ÿæœºç½‘å¡åŠ å…¥å…¶åˆ›å»ºçš„ â€œNodeNatNetworkâ€ã€‚ä¾‹å¦‚ï¼š å¯åŠ¨æ¯ä¸ªè™šæ‹Ÿæœºï¼Œè®¾ç½®å…¶ hostnameï¼Œä¸ç½‘å¡é™æ€ IPã€‚ä¾‹å¦‚ï¼š è‡³æ­¤ï¼Œä¸‰ä¸ªè™šæ‹Ÿæœºä½äºåŒä¸€ä¸ªç½‘æ®µï¼Œå¹¶ä¸”èƒ½å¤Ÿç›¸äº’è®¿é—®ï¼›å¯¹å¤–ï¼Œåˆ™é€šè¿‡ VirtualBox çš„ Nat ç½‘ç»œèƒ½å¤Ÿè®¿é—®ã€‚ ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:1:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"2 éƒ¨ç½² K8s ç›®æ ‡ï¼šé€šè¿‡ kubeadm éƒ¨ç½²æ•´ä¸ª k8sï¼Œç”¨ Node-1 ä¸º Master èŠ‚ç‚¹ï¼Œå…¶ä»–ä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:2:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"2.1 å®‰è£… kubeadmã€kubeletã€kubectl å®‰è£… kubeadmã€kubeletã€kubectlã€‚è¿™ä¸ªå®˜æ–¹æ–‡æ¡£å†™çš„å¾ˆè¯¦ç»†ï¼Œè§ Installing kubeadm ã€‚ ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:2:1","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"2.2 kubeadm init åˆå§‹åŒ– Master èŠ‚ç‚¹ Node-1 èŠ‚ç‚¹æ‰§è¡Œ kubeadm initï¼Œå°†å…¶ä½œä¸º Master èŠ‚ç‚¹åˆå§‹åŒ–ã€‚æ‰§è¡ŒæˆåŠŸåï¼Œkubeadm ç”Ÿæˆäº† Kubernetes ç»„ä»¶çš„å„ä¸ªé…ç½®ï¼Œä»¥åŠæä¾›æœåŠ¡çš„å„ç±»è¯ä¹¦ï¼Œä½äº /etc/kubernetes ç›®å½•ä¸‹: å¹¶ä¸”å·²ç»ä»¥ static pod çš„å½¢å¼å¯åŠ¨äº†ï¼šapiserverã€controller-managerã€etcdã€schedulerã€‚ è¿˜æœ‰æœ€é‡è¦çš„ï¼Œkubeadm ä¸ºé›†ç¾¤ç”Ÿæˆä¸€ä¸ªã€bootstrap tokenã€‘ï¼Œéœ€è¦åŠ å…¥é›†ç¾¤çš„èŠ‚ç‚¹éƒ½éœ€è¦é€šè¿‡è¿™ä¸ª token åŠ å…¥ã€‚ * é—®é¢˜ kubeadm æ£€æŸ¥ swap æ‰“å¼€ç€ï¼Œkubeadm æ¨èä¸ä½¿ç”¨ swapï¼Œé€šè¿‡ swapoff -a å…³é—­äº¤æ¢åŒºã€‚ kubectl é»˜è®¤é€šè¿‡ 8080 ç«¯å£è®¿é—®ï¼Œæ— æ³•æ‰§è¡Œã€‚ è®¾ç½® kubectl çš„é…ç½®æ–‡ä»¶ä¸º kubeadm ç”Ÿæˆçš„ /etc/kubernetes/admin.confã€‚ï¼ˆå…¶å®å°±æ˜¯é…ç½®å…¬é’¥ï¼Œæˆ–è€…å°† admin.conf ç§»åŠ¨åˆ° ~/.kube/config æ–‡ä»¶ï¼Œä½œä¸ºé»˜è®¤é…ç½®ã€‚ ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:2:2","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"2.3 kubeadm join [token] è®¾ç½®å·¥ä½œèŠ‚ç‚¹ é€šè¿‡ kubead init æœ€åè¿”å›çš„æç¤ºä¿¡æ¯ï¼Œæ‰§è¡Œå¯¹åº” kubeadm join å°† Node-1 Node-2 åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œä½œä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ [root@Node-2 kubeadm join 10.0.2.10:6443 --token mahrou.d3uodof21i3d6yxk --discovery-token-ca-cert-hash sha256:21dfe4ef6b3bbd89f803bf44ff6eda587874336d103d0e4a3b --v 5 å¯ä»¥çœ‹åˆ°ï¼Œkubelet å¯åŠ¨åå°±é€šè¿‡ pod æ–¹å¼å¯åŠ¨äº†æœ¬èŠ‚ç‚¹ä¸Š kube-proxy å®¹å™¨ï¼š * é—®é¢˜ æ— æ³•è®¿é—®åˆ° Node-1 èŠ‚ç‚¹ï¼Œnc ip å¤±è´¥ï¼Œä½†æ˜¯å¯ä»¥ ping é€šã€‚é€šè¿‡åœ¨ Node-1 tcpdump å¯ä»¥æŠ“å–åˆ°æ¥è‡ª Node-3 çš„åŒ…ï¼Œå› æ­¤åº”è¯¥æ˜¯é˜²ç«å¢™çš„é—®é¢˜ï¼Œé€šè¿‡ iptables å¯¹ Node-2 Node-3 IP å¼€æ”¾ã€‚ kubectl æ— æ³•è®¿é—®é—®é¢˜ï¼Œä¸ä¸Šè¿°é—®é¢˜ä¸€è‡´ã€‚ ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:2:3","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"2.4 ç»“æœ ç›®å‰ä¸ºæ­¢ï¼Œå°±å®Œæˆäº†é›†ç¾¤çš„æ­å»ºï¼Œä½†æ˜¯ é€šè¿‡ kubectl get nodesï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ NotReadyï¼š kubectl describe node node-1 å¯ä»¥çœ‹åˆ°ï¼ŒåŸå› æ˜¯å› ä¸ºæ²¡æœ‰è®¾ç½®æ­£ç¡®çš„ Network Pluginï¼š ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:2:4","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"3 éƒ¨ç½²ç½‘ç»œæ’ä»¶ ç›®çš„ï¼šéƒ¨ç½²ç½‘ç»œæ’ä»¶ï¼Œä½¿å„ä¸ªèŠ‚ç‚¹ä¸º Ready çŠ¶æ€ï¼Œå¹¶å…¶å†…éƒ¨ Pod èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚ ä»¥ Weave éƒ¨ç½²ä¸ºä¾‹ï¼Œéƒ¨ç½²ç½‘ç»œæ’ä»¶ï¼š kubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\" å…¶æè¿°æ–‡ä»¶ä¸­å®šä¹‰æ‰€æœ‰ Weave éœ€è¦çš„ BAAC æƒé™ç»„ä»¶ï¼Œä»¥åŠæœ€é‡è¦çš„ç½‘ç»œæ’ä»¶ Pod å¯¹åº”çš„ DaemonSet: åº”ç”¨æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”çš„ DaemonSet å°±è¿è¡Œèµ·æ¥ï¼Œå¹¶å¼€å§‹ç»™ä¸‰ä¸ª Node éƒ¨ç½² Pod: åœ¨èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥çœ‹åˆ° weave-net å¯¹åº”çš„ pod ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªå®¹å™¨ï¼š ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:3:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":["Kubernetes å®è·µ"],"content":"4 éƒ¨ç½²å®¹å™¨å­˜å‚¨æ’ä»¶ ç›®çš„ï¼šä¸ºäº†èƒ½å¤Ÿè®©å®¹å™¨ä½¿ç”¨ç½‘ç»œå­˜å‚¨ï¼Œä½¿å¾—å®¹å™¨æ•°æ®æŒä¹…åŒ–ï¼Œéœ€è¦éƒ¨ç½²å­˜å‚¨æ’ä»¶ã€‚ ä»¥ Rook é¡¹ç›®ä¸ºä¾‹ï¼Œéƒ¨ç½²å­˜å‚¨æ’ä»¶ï¼š $ kubectl apply -f https://raw.githubusercontent.com/rook/rook/master/cluster/exampleskubernetes/ceph/common.yaml $ kubectl apply -f https://raw.githubusercontent.com/rook/rook/master/cluster/exampleskubernetes/ceph/operator.yaml $ kubectl apply -f https://raw.githubusercontent.com/rook/rook/master/cluster/examples/kubernetes/ceph/cluster.yaml å®‰è£…æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°ï¼Œrook æœ‰ç€è‡ªå·±çš„ namespaceï¼Œå¹¶ä¸”å·²ç»éƒ¨ç½²äº† DaemonSetï¼š å¯ä»¥çœ‹åˆ°ï¼ŒPod ä¹Ÿéƒ¨ç½²æˆåŠŸäº†ï¼š ","date":"2020-10-15","objectID":"/posts/cloud_computing/k8s_practice/create-cluster/:4:0","tags":["k8s","äº‘è®¡ç®—"],"title":"K8s å®è·µ - é›†ç¾¤æ­å»º","uri":"/posts/cloud_computing/k8s_practice/create-cluster/"},{"categories":null,"content":"å†™åšå®¢æ˜¯ä¸ºäº†æ€»ç»“è‡ªå·±å­¦åˆ°çš„ä¸œè¥¿ï¼Œå¦‚æœå­˜åœ¨é”™è¯¯ï¼Œæ¬¢è¿è”ç³»æˆ‘æ”¹æ­£ :) åšå®¢ä½¿ç”¨ Hugo æ¡†æ¶è¿›è¡Œæ­å»º, ä¸»é¢˜ä½¿ç”¨ LoveIt. Logo ç”± gopherize.me ç”Ÿæˆ, å¹¶ä½¿ç”¨ realfavicongenerator.net è½¬åŒ–. ","date":"2020-10-15","objectID":"/about/:0:0","tags":null,"title":"å…³äº","uri":"/about/"}]