# 授权 Authorization


认证解决了对用户身份认证的问题，授用于解决用户有着哪些权限的问题。涉及两个独立的问题：
* 确保授权的过程可靠 - 常用 OAuth2 和 SAML 2.0
* 确保授权的结果可控 - 常用 DAC、ABAC 和 RBAC。

## 1 RBAC

## 2 OAuth 2

OAuth 2 是在 RFC 6749 中定义的国际标准，用于解决面向第三方应用（Third-Party Application）的认证授权协议。当一个第三方应用要访问某个系统时，最简单的方法就是将账号密码告知第三方应用，但是这样显然导致了密码泄露，并且还无法很好的回收权限。这也正是 OAuth 2 要解决的问题。

OAuth 2 有许多方式，不过共同特征就是以 [令牌]^(Token) 代替用户密码作为凭证。
* 哪怕令牌泄露，也不会导致密码泄露；
* 令牌可以设定访问资源的范围，以及时效性；
* 每个应用都有独立的令牌，其中一个泄露不会导致其他应用收到影响；

### 2.1 基本概念

* 第三方应用 Third-Party Application - 需要得到授权，访问某个资源的应用；
* 授权服务器 Authorization Server - 根据用户意愿授权第三方应用的服务器；
* 资源服务器 Resource Server - 保存第三方应用需要访问资源的服务器；
* 资源所有者 Resource Owner - 拥有授权权限的人；
* 操作代理 User Agent - 用户用来访问服务器的工具，例如浏览器、HTTPClient；

基本的访问流程如下图，不同方式在其中步骤中有所延展：
{{< find_img "img1.png" >}}

### 2.2 授权码模式

[授权码模式]^(Authorization Code) 是最严格的方式，考虑了几乎所有的敏感信息泄漏的预防和后果。
{{< find_img "img2.png" >}}

开始授权前，第三方应用先要到授权服务器注册，从授权服务器中获得应用对应的 ClientID 和 ClientSecret。

1. 定向到授权服务器 - 用户访问时，第三方应用将用户定向到授权服务器的授权页面，向授权服务器提供 ClientID，以及用户如果同意授权后要跳转的 URI。
2. 用户授权 - 授权服务器根据 ClientID 确定第三方应用身份，用户决定是否同意授权。
3. 得到授权码 - 办法用户同意授权后，授权服务器将定向到第 1 步中的回调 URI，并附带上授权码的获取地址作为参数。
4. 获取令牌 - 第三方应用访问授权码地址得到授权码，将授权码与自己的 ClientSecret 作为参数，访问授权服务器来换取令牌。
5. 颁发令牌 - 授权服务器检查授权码和 ClientSecret，无误后颁发令牌。令牌包括访问令牌与刷新令牌。
6. 资源服务器检查访问令牌与授权权限，向第三方应用提供资源。

### 2.3 隐式授权模式

[隐式授权模式]^(Implicit) 省略了通过授权码换取令牌的步骤（合并了上述第 3 4 5 步），并且明确禁止发放刷新令牌。
{{< find_img "img3.png" >}}

可以看到，授权服务器不会验证第三方应用的身份，在得到用户授权后，直接返回访问令牌给第三方引用。显然，这样减低了安全性，但是无需注册提升了灵活性。

另外，RFC 6749 中明确说明令牌必须是通过 URI 的 Fragment 带回的。

### 2.4 密码模式

[密码模式]^(Resource Owner Password Credentials) 整合了认证和授权的过程。第三方应用直接拿着账户和密码向授权服务器换取令牌。
{{< find_img "img4.png" >}}

### 2.5 客户端模式

[客户端模式]^(Client Credentials) 指第三方应用以用户名义，直接向授权服务器申请资源许可。该模式通常用于管理操作或者自动处理的场景中，即常用于服务间认证授权。
{{< find_img "img5.png" >}}




