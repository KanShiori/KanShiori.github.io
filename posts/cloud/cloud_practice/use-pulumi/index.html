<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Pulumi 入门 - Shiori&#39;s Blog</title><meta name="Description" content="Shiori&#39;s Blog"><meta property="og:title" content="Pulumi 入门" />
<meta property="og:description" content="内容基本照搬的官方文档：Architecture &amp; Concepts。 Pulumi 是一个支持 IaC 的平台。与其他 IaC 工具最大的不同时，Pulumi 允许使用熟悉" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" /><meta property="og:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-06T21:58:22+08:00" />
<meta property="article:modified_time" content="2022-06-12T22:51:59+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/>

<meta name="twitter:title" content="Pulumi 入门"/>
<meta name="twitter:description" content="内容基本照搬的官方文档：Architecture &amp; Concepts。 Pulumi 是一个支持 IaC 的平台。与其他 IaC 工具最大的不同时，Pulumi 允许使用熟悉"/>
<meta name="application-name" content="Shiori&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Shiori&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/icons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" /><link rel="prev" href="https://KanShiori.github.io/posts/cloud/cloud_practice/debug-pod/" /><link rel="next" href="https://KanShiori.github.io/posts/cloud/cloud_practice/use-crossplane/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Pulumi 入门",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_practice\/use-pulumi\/"
        },"image": ["https:\/\/KanShiori.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "云计算","wordcount":  7586 ,
        "url": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_practice\/use-pulumi\/","datePublished": "2022-04-06T21:58:22+08:00","dateModified": "2022-06-12T22:51:59+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/KanShiori.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Shiori"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="http://kanshiori.cn" rel="noopener noreffer" target="_blank"> 主页 </a><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="http://kanshiori.cn" title="" rel="noopener noreffer" target="_blank">主页</a><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Pulumi 入门</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Shiori</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/cloud-practice/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Cloud Practice</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-04-06">2022-04-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 7586 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 16 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-概念与架构">1 概念与架构</a>
      <ul>
        <li><a href="#11-基本概念">1.1 基本概念</a></li>
        <li><a href="#12-架构">1.2 架构</a></li>
      </ul>
    </li>
    <li><a href="#2-project">2 Project</a></li>
    <li><a href="#3-stack">3 Stack</a>
      <ul>
        <li><a href="#31-stack-管理">3.1 Stack 管理</a></li>
        <li><a href="#32-stack-tag">3.2 Stack Tag</a></li>
        <li><a href="#33-stack-output">3.3 Stack Output</a></li>
        <li><a href="#34-stack-reference">3.4 Stack Reference</a></li>
        <li><a href="#35-stack-的导入导出">3.5 Stack 的导入导出</a></li>
        <li><a href="#36-stack-配置文件">3.6 Stack 配置文件</a></li>
      </ul>
    </li>
    <li><a href="#4-backend">4 Backend</a>
      <ul>
        <li><a href="#41-login-与-logout">4.1 Login 与 Logout</a></li>
        <li><a href="#42-pulumi-service-架构">4.2 Pulumi Service 架构</a></li>
        <li><a href="#43-state-的细节">4.3 State 的细节</a></li>
      </ul>
    </li>
    <li><a href="#5-resource">5 Resource</a>
      <ul>
        <li><a href="#51-resource-name">5.1 Resource Name</a>
          <ul>
            <li><a href="#511-physical-name-生成规则">5.1.1 Physical Name 生成规则</a></li>
            <li><a href="#512-resource-urn">5.1.2 Resource URN</a></li>
          </ul>
        </li>
        <li><a href="#52-resource-options">5.2 Resource Options</a></li>
        <li><a href="#53-componentresource">5.3 ComponentResource</a></li>
        <li><a href="#54-resource-provider">5.4 Resource Provider</a></li>
        <li><a href="#55-dynamic-providers">5.5 Dynamic Providers</a></li>
        <li><a href="#56-getter-函数">5.6 Getter 函数</a></li>
      </ul>
    </li>
    <li><a href="#6-input-和-output">6 Input 和 Output</a>
      <ul>
        <li><a href="#61-apply">6.1 Apply</a></li>
        <li><a href="#62-lifting">6.2 Lifting</a></li>
        <li><a href="#63-interpolation">6.3 Interpolation</a></li>
        <li><a href="#64-input-转换为-output">6.4 Input 转换为 Output</a></li>
      </ul>
    </li>
    <li><a href="#7-secret">7 Secret</a>
      <ul>
        <li><a href="#71-配置-secret-provider">7.1 配置 Secret Provider</a></li>
      </ul>
    </li>
    <li><a href="#8-function-serialization">8 Function Serialization</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>内容基本照搬的官方文档：<a href="https://www.pulumi.com/docs/intro/concepts/" target="_blank" rel="noopener noreffer"><strong>Architecture &amp; Concepts</strong></a>。</p>
</blockquote>
<p><a href="https://www.pulumi.com/" target="_blank" rel="noopener noreffer"><strong>Pulumi</strong></a> 是一个支持 IaC 的平台。与其他 IaC 工具最大的不同时，Pulumi 允许使用熟悉的编程语言来编写部署程序。开发者编写部署程序，Pulumi 解析后创建对应允许平台的资源。</p>
<h2 id="1-概念与架构">1 概念与架构</h2>
<h3 id="11-基本概念">1.1 基本概念</h3>
<p>Pulumi 使用的主要结构如下：</p>
<a class="lightgallery" href="/posts/cloud/cloud_practice/use-pulumi/img1.png" title="/posts/cloud/cloud_practice/use-pulumi/img1.png" data-thumbnail="/posts/cloud/cloud_practice/use-pulumi/img1.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_practice/use-pulumi/img1.png"
            data-srcset="/posts/cloud/cloud_practice/use-pulumi/img1.png, /posts/cloud/cloud_practice/use-pulumi/img1.png 1.5x, /posts/cloud/cloud_practice/use-pulumi/img1.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_practice/use-pulumi/img1.png" width="763" height="536" />
    </a>
<ul>
<li>
<p>Resource - 物理云资源的逻辑抽象，在 Program 会编写期望的 Resource；</p>
</li>
<li>
<p>Program - 用户使用通用语言（NodeJS、Golang 等）编写的部署程序，其通过声明式的方式描述了期望的 Resource 架构；</p>
</li>
<li>
<p>Project - Program 所属一个 Project，包含 Program 以及元信息的目录就是 Project；</p>
</li>
<li>
<p>Stack - Program 会部署到多个 Stack，对应不同的运行环境。各个 Stack 之间 Resource 是独立隔离的；</p>
</li>
</ul>
<p>大致的使用流程为：</p>
<ol>
<li>用户编写 Program，描述期望的 Resource。</li>
<li>通过 Pulumi 将 Program 部署到不同的 Stack，例如 dev 环境和 prod 环境。</li>
<li>Pulumi 根据编写 Program 调用各个云的 API 来创建物理资源。</li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>异步构建<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">可以看到，代码中的逻辑与实际 Pulumi 运行是异步的，Pulumi 会识别出 Resource 之间的依赖关系，并最大化的并行构建资源。</div>
        </div>
    </div>
<h3 id="12-架构">1.2 架构</h3>
<p>Pulumi 运行的架构如下：</p>
<a class="lightgallery" href="/posts/cloud/cloud_practice/use-pulumi/img1.2.png" title="/posts/cloud/cloud_practice/use-pulumi/img1.2.png" data-thumbnail="/posts/cloud/cloud_practice/use-pulumi/img1.2.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_practice/use-pulumi/img1.2.png"
            data-srcset="/posts/cloud/cloud_practice/use-pulumi/img1.2.png, /posts/cloud/cloud_practice/use-pulumi/img1.2.png 1.5x, /posts/cloud/cloud_practice/use-pulumi/img1.2.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_practice/use-pulumi/img1.2.png" width="708" height="495" />
    </a>
<ul>
<li>
<p>Language Host</p>
<p>Language Host 指的是运行 Program 的物理环境，主要有两部分：</p>
<ul>
<li>executor - 对应语言的二进制程序 <code>pulumi-language-&lt;language&gt;</code>，CLI 会调用该程序解析解析并编译 Program</li>
<li>runtime - 各个语言的 runtime，例如 Program 中构建 Resource 代码执行时，就是由 runtime 将其注册到 Deployment Engine</li>
</ul>
</li>
<li>
<p>Deployment Engine</p>
<p>Deployment Engine 接受 Language Host 的注册的当前状态，对比保存在 <a href="#4-backend" rel=""><strong>Backend</strong></a> 中的 Stack State，计算出需要执行的操作，进而调用各个 <a href="#54-resource-provider" rel=""><strong>Resource Provider</strong></a> 的操作接口。</p>
<p>Deployment Engine 是内嵌于 pulumi CLI 中的。</p>
</li>
<li>
<p>Resource Providers</p>
<p>Resource Providers 是针对于各个云服务的接口抽象。由两部分组成：</p>
<ul>
<li>SDK - 提供给 Program 中使用的库，例如使用 <code>@pulumi/aws</code> 包中的 Resource 接口来定义 AWS 云资源。</li>
<li>Resource Plugin - Deployment Engine 使用的二进制程序，其中提供了 Resource 操作接口，并转化为调用各个云服务的 API。</li>
</ul>
<p>Pulumi 会根据 Program 中导入的库，自动在后台执行 <code>pulumi plugin install</code> 下载对应的 Resource Plugin。</p>
</li>
</ul>
<h2 id="2-project">2 Project</h2>
<p>执行 <code>pulumi new</code> 构建一个新的 Project，会一步步引导你来创建 Project。</p>
<p>任何包含 <code>Pulumi.yaml</code> 文件的目录都被认为是一个 Project。 <code>Pulumi.yaml</code> 中包含了 Project 的元信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webserver</span><span class="w">
</span><span class="w"></span><span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="l">nodejs</span><span class="w">
</span><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Basic example of an AWS web server accessible over HTTP.</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">不同的语言之间文件内容不同，例如 JavaScript 会包含 package.json 文件来管理依赖。</div>
        </div>
    </div>
<p>在 Pulumi Program 中使用的所有本地路径都是当前目录的相对目录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">myTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cloud</span><span class="p">.</span><span class="nx">Task</span><span class="p">(</span><span class="s2">&#34;myTask&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">build</span><span class="o">:</span> <span class="s2">&#34;./app&#34;</span><span class="p">,</span> <span class="c1">// subfolder of working directory
</span><span class="c1"></span>    <span class="p">...</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="3-stack">3 Stack</h2>
<p>Stack 代表一个独立的环境，Pulumi 会跟踪每个 Stack 的当前状态，在部署 Program 到一个 Stack 时，对比期望状态（Program 编写的）和当前状态（Stack 状态）来进行声明式的部署。</p>
<a class="lightgallery" href="/posts/cloud/cloud_practice/use-pulumi/img2.png" title="/posts/cloud/cloud_practice/use-pulumi/img2.png" data-thumbnail="/posts/cloud/cloud_practice/use-pulumi/img2.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_practice/use-pulumi/img2.png"
            data-srcset="/posts/cloud/cloud_practice/use-pulumi/img2.png, /posts/cloud/cloud_practice/use-pulumi/img2.png 1.5x, /posts/cloud/cloud_practice/use-pulumi/img2.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_practice/use-pulumi/img2.png" width="627" height="544" />
    </a>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">可以理解，Program 是静态的，Stack 是动态的，类似于程序与进程之间的关系。</div>
        </div>
    </div>
<p>不同 Stack 往往代表着不同的部署环境，Stack 之间通过 Stack 配置文件来描述环境的差异。当部署 Program 到一个 Stack 时，程序就会使用该 Stack 的配置文件来构建。Stack 配置文件格式为：<code>Pulumi.&lt;stackname&gt;.yaml</code>。</p>
<p>大多数的 <code>pulumi</code> 命令会默认使用当前的指定的 Stack，称为 Active Stack。可以使用 <code>pulumi stack select</code> 命令切换 Active Stack。</p>
<h3 id="31-stack-管理">3.1 Stack 管理</h3>
<p>执行 <code>pulumi init &lt;stackname&gt;</code> 来创建一个 Stack。如果要指定创建某个 Org 下的 Stack 需要使用 <code>&lt;orgname&gt;/&lt;stackname&gt;</code> 或者 Stack 完全名称 <code>&lt;orgname&gt;/&lt;projectname&gt;/&lt;stackname&gt;</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi stack init prod
Created stack <span class="s1">&#39;prod&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>pulumi up</code> 将 Program 部署到 Active Stack，之后 Pulumi 会使用当前 Stack 的配置文件来进行计算，并展示部署计划。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi up
Previewing update <span class="o">(</span>dev<span class="o">)</span>

View Live: https://xxx

     Type                              Name            Plan
 +   pulumi:pulumi:Stack               quickstart-dev  create
 +   ├─ kubernetes:apps/v1:Deployment  nginx           create
 +   └─ kubernetes:core/v1:Service     nginx           create

Resources:
    + <span class="m">3</span> to create
...
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>pulumi stack ls</code> 查看当前 Project 的 Stack，并可以使用 <code>pulumi stack select</code> 来切换 Active Stack。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi stack ls
NAME   LAST UPDATE    RESOURCE COUNT  URL
dev    <span class="m">8</span> minutes ago  <span class="m">4</span>               https://app.pulumi.com/KanShiori/quickstart/dev
prod*  n/a            n/a             https://app.pulumi.com/KanShiori/quickstart/prod

$ pulumi stack <span class="k">select</span> dev
</code></pre></td></tr></table>
</div>
</div><p>删除 Stack 分为两步：先需要使用 <code>pulumi destroy</code> 销毁 Stack 中的所有资源，才能使用 <code>pulumi stack rm</code> 删除 Stack。删除 Stack 意味着对应的配置文件以及所有的元信息都会被删除。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi destroy
Previewing destroy <span class="o">(</span>dev<span class="o">)</span>

View Live: https://app.pulumi.com/KanShiori/quickstart/dev/previews/a4d21b5f-a0b6-4631-b4dd-2c1ac49b9e14

     Type                              Name            Plan
 -   pulumi:pulumi:Stack               quickstart-dev  delete                                                                                                              -   ├─ kubernetes:core/v1:Service     nginx           delete
 -   └─ kubernetes:apps/v1:Deployment  nginx           delete

Outputs:
  - ip: <span class="s2">&#34;10.96.122.118&#34;</span>

Resources:
    - <span class="m">3</span> to delete

Do you want to perform this destroy? yes
...

$ pulumi stack rm dev
This will permanently remove the <span class="s1">&#39;dev&#39;</span> stack!
Please confirm that this is what you<span class="s1">&#39;d like to do by typing (&#34;dev&#34;): dev
</span><span class="s1">Stack &#39;</span>dev<span class="err">&#39;</span> has been removed!
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>强制删除<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">使用 <code>--force</code> 参数可以强制删除一个仍有资源的 Stack，但是不推荐这么做。</div>
        </div>
    </div>
<h3 id="32-stack-tag">3.2 Stack Tag</h3>
<p>Stack 可以关联一组 tag（键值对）作为额外信息，用以 Pulumi Service 使用。例如可以使用 tag 来对 Stack 进行分组。</p>
<p>默认 Stack 会自动被加上一些 tag，例如 Key 为 pulumi:project pulumi:runtime gitHub:owner vcs:owner 等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi stack tag ls
Please choose a stack: prod
NAME                VALUE
gitHub:owner        KanShiori
gitHub:repo         Example
pulumi:description  A minimal Kubernetes TypeScript Pulumi program
pulumi:project      quickstart
pulumi:runtime      nodejs
vcs:kind            github.com
vcs:owner           KanShiori
vcs:repo            Example
</code></pre></td></tr></table>
</div>
</div><p>当然，你也可以使用 <code>pulumi stack tag set &lt;name&gt; &lt;value&gt;</code> 来添加自定义 tag。约定俗成地，pulumi: gitHub: vcs: 前缀是内置使用的 Key，避免使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi stack tag <span class="nb">set</span> myname shiori
</code></pre></td></tr></table>
</div>
</div><h3 id="33-stack-output">3.3 Stack Output</h3>
<p>Program 中可以定义一些 Output 来导出 Resource 的信息，Stack 元信息中会包含定义的 Output 信息。用户可以用来导出一些重要信息，或者导出信息来让 Program 使用。</p>
<p>使用 export 语句定义 Output：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">export</span> <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Stack Output 本质上是一个 JSON：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">$</span> <span class="err">pulumi</span> <span class="err">stack</span> <span class="err">output</span> <span class="err">--json</span>
<span class="p">{</span>
  <span class="nt">&#34;x&#34;</span><span class="p">:</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span>
  <span class="nt">&#34;o&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;num&#34;</span><span class="p">:</span> <span class="mi">42</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Secret 信息<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">如果 Stack Output 包含 Secret 信息，那么默认不会展示 Secret 信息与对应的值。你可以通过 <code>--show-secrets</code> 来展示。</div>
        </div>
    </div>
<h3 id="34-stack-reference">3.4 Stack Reference</h3>
<p>使用 Stack Reference 可以在 Stack 中访问另一个 Stack 的 Output。代码中通过创建一个 <code>StackReference</code> 对象，并引用另一个 Stack 的<strong>完全命名</strong>来使用（支持跨 Org 或者跨 Project 使用）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="kr">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">StackReference</span><span class="p">(</span><span class="s2">&#34;acmecorp/infra/other&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">otherOutput</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">getOutput</span><span class="p">(</span><span class="s2">&#34;x&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>举一个适用场景：你的一些 Kubernetes 使用其他 Stack 进行部署，你在某个 Stack 想要在该 Kubernetes 中部署资源，那么你可以使用 <code>StackReference</code> 来引用目标 Kubernetes 的 kubeconfig。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">k8s</span> <span class="kr">from</span> <span class="s2">&#34;@pulumi/kubernetes&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="kr">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">getStack</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">infra</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">StackReference</span><span class="p">(</span><span class="sb">`mycompany/infra/</span><span class="si">${</span><span class="nx">env</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>  <span class="c1">// 引用另一个 Stack
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">provider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">Provider</span><span class="p">(</span><span class="s2">&#34;k8s&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">kubeconfig</span>: <span class="kt">infra.getOutput</span><span class="p">(</span><span class="s2">&#34;kubeConfig&#34;</span><span class="p">)</span> <span class="p">});</span> <span class="c1">// 从 Output 中得到 kubeconfig
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Service</span><span class="p">(...,</span> <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">provider</span> <span class="p">});</span>  <span class="c1">// 设置 Provider 以部署资源到目标 Kubernetes 中
</span></code></pre></td></tr></table>
</div>
</div><h3 id="35-stack-的导入导出">3.5 Stack 的导入导出</h3>
<p>Stack 支持使用原始数据的导入与导出，这适用于某些情况你必须手动修改 Stack 相关信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi stack <span class="nb">export</span> --file stack.json

$ pulumi stack import --file stack.json
</code></pre></td></tr></table>
</div>
</div><h3 id="36-stack-配置文件">3.6 Stack 配置文件</h3>
<p>每个 Stack 有着独立的配置文件 <code>Pulumi.&lt;stack&gt;.yaml</code>，用于在同一个 Program 中能够方便的差异化不同的 Stack。配置文件中以 yaml 格式保存 K/V 对，Program 中可以加载配置并使用相关的参数。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">创建 Stack 并不会直接创建对应的配置文件，配置文件直到第一次写入 K/V 时才会创建。</div>
        </div>
    </div>
<p>Pulumi 提供了两种方式使用配置文件（当然，也可以手动修改文件）：</p>
<ul>
<li>
<p>CLI</p>
<p>Pulumi 提供了 <code>config set</code> 与 <code>config get</code> 命令，用于配置或读取 K/V：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi config <span class="nb">set</span> aws:region us-west-2

$ pulumi config get aws:region
us-west-2
</code></pre></td></tr></table>
</div>
</div><p>默认传入的是 Key 的字符串，通过 <code>--path</code> 参数，可以配置结构化的数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># pulumi config set &#39;data.enable&#39; true</span><span class="w">
</span><span class="w"></span><span class="c"># pulumi config set --path &#39;data.active&#39; true</span><span class="w">
</span><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">quickstart:data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">quickstart:data.enable</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Program</p>
<p>Program 中提供了 <code>Config</code> 对象，代表着 Stack 的配置文件。通过 <code>Config.get</code> 或 <code>Config.require</code> 可以读取配置项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="kr">require</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">lucky</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">getNumber</span><span class="p">(</span><span class="s2">&#34;lucky&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">42</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Hello, </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb"> -- I see your lucky number is </span><span class="si">${</span><span class="nx">lucky</span><span class="si">}</span><span class="sb">!`</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>使用结构化配置时，需要使用 <code>requireObject</code> 方法来解析对应的结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">interface</span> <span class="nx">Data</span> <span class="p">{</span>
  <span class="nx">active</span>: <span class="kt">boolean</span><span class="p">;</span>
  <span class="nx">nums</span>: <span class="kt">number</span><span class="p">[];</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">requireObject</span><span class="p">&lt;</span><span class="nt">Data</span><span class="p">&gt;(</span><span class="s2">&#34;data&#34;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Active: </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">active</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>实际上，配置文件中的 Key 的格式为 <code>&lt;namespace&gt;:key</code>，<code>&lt;namespace&gt;</code> 默认为当前的 Project 名称。不过在写入和读取时，都可以忽略 <code>&lt;namespace&gt;</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># pulumi config set isMinikube false</span><span class="w">
</span><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">quickstart:isMinikube</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="4-backend">4 Backend</h2>
<p>Pulumi 本质上是对比期望状态（Program 中定义）与实际状态（Stack 资源信息），来进行声明式的构建资源。Stack 元信息也被称为 Stack State，由 Backend 负责存储。</p>
<p>Pulumi 支持多种 Backend，大致上可以分为两类：</p>
<ul>
<li>
<p>Service</p>
<p>Pulumi 原生的 Backend 服务，默认使用域名 app.pulumi.com 来作为 Backend。</p>
<p>Pulumi Service 也支持线下自行部署并使用。</p>
</li>
<li>
<p>Self-Managed</p>
<p>因为 Stack State 本质上是一个 JSON 文件，因此支持大部分的对象存储来进行存储，包括 AWS S3、Azure Blob Storage 等兼容 S3 的对象存储，以及本地文件系统。</p>
<p>Self-Managed Backend 的实现都是开源的，可以在任何环境免费使用。不过， Self-Managed Backend 仅仅负责 State 文件的存储，意味着需要用户自行管理 State 的访问安全、信息加密、History 等功能。</p>
</li>
</ul>
<h3 id="41-login-与-logout">4.1 Login 与 Logout</h3>
<p>执行 <code>pulumi login</code> 来登陆到一个 Backend，不提供 URL 情况下默认使用 Pulumi Service。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi login &lt;backend-url&gt;
</code></pre></td></tr></table>
</div>
</div><p>Login 成功后，Pulumi CLI 会将凭证信息保存在 ~/.pulumi/credentials.json 文件中。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">或者，你刻意设置 <code>PULUMI_BACKEND_URL</code> 环境变量来默认指定 Backend URL。</div>
        </div>
    </div>
<p>对于不同的 Self-Managed Backend，体现在 URL 路径中。例如：<code>s3://&lt;bucket-path&gt;</code> <code>azblob://&lt;container-path&gt;</code>。URL 中指定了存储的根目录，Pulumi 会将文件存储在根目录的 .pulumi 目录下。</p>
<p>对于本地文件系统，可以指定 URL 为 <code>file://&lt;fs-path&gt;</code> 或者使用 <code>pulumi login --local</code>。区别在于，<code>--local</code> 固定保存文件在 ~/.pulumi 目录下，而指定 URL 可以指定本地文件的目录。</p>
<p>执行 <code>pulumi logout</code> 来登出 Backend，这将会删除  ~/.pulumi/credentials.json 文化中的所有凭证信息。</p>
<h3 id="42-pulumi-service-架构">4.2 Pulumi Service 架构</h3>
<p>Pulumi Service 提供两个域名：app.pulumi.com 是针对用户的 Web 控制台，api.pulumi.com 是用于 CLI 访问的 REST 服务。</p>
<p>Pulumi Service 整体的架构如下：</p>
<a class="lightgallery" href="/posts/cloud/cloud_practice/use-pulumi/img3.png" title="/posts/cloud/cloud_practice/use-pulumi/img3.png" data-thumbnail="/posts/cloud/cloud_practice/use-pulumi/img3.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_practice/use-pulumi/img3.png"
            data-srcset="/posts/cloud/cloud_practice/use-pulumi/img3.png, /posts/cloud/cloud_practice/use-pulumi/img3.png 1.5x, /posts/cloud/cloud_practice/use-pulumi/img3.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_practice/use-pulumi/img3.png" width="879" height="613" />
    </a>
<p>可以看到，Pulumi Service 与 Cloud 之间没有任何关联，调用 Cloud API 完全是由 CLI 中发起的。也就是说，Pulumi Service 不需要任何 Cloud 的权限。</p>
<p>当线下部署 Pulumi Service 时架构与上图类似，区别在于使用的不是公共域名而是用户设置的私有域名。</p>
<h3 id="43-state-的细节">4.3 State 的细节</h3>
<p>参考官方文档：<a href="https://www.pulumi.com/docs/intro/concepts/state/#advanced-state" target="_blank" rel="noopener noreffer"><strong>Advanced State</strong></a>。</p>
<h2 id="5-resource">5 Resource</h2>
<p>Resource 代表将要部署的云资源，例如 Instance、Kubernetes 集群等。</p>
<p>Resource 在代码中由 <code>Resource</code> 类表示，有两个子类：</p>
<ul>
<li>
<p>CustomResource - 对应与云管理的原生的资源，由对应的云的 Resource Provider 管理，例如 AWS、Azure 等；</p>
</li>
<li>
<p>ComponentResource - 由其他 Resource 组合成的逻辑资源；</p>
</li>
</ul>
<p>期望部署的资源由创建对应的 <code>Resource</code> 对象来描述，大部分都类似如下格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Resource</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>name - Resource 的 Logical Name，每个 Stack 的每个 Resource 中唯一。</p>
<p>Logical Name 用于 Pulumi 中引用该 Resource，并且对应的实际资源的 Physical Name 会基于 Logical Name 来生成。</p>
</li>
<li>
<p>args - 为 Resource 的相关属性的配置。</p>
<p>每种 Resource 有着不同的配置参数，具体参考 <a href="https://www.pulumi.com/registry/" target="_blank" rel="noopener noreffer"><strong>Registry</strong></a> 。</p>
</li>
<li>
<p>options - 可选参数，允许控制 Resource 的某些方面。</p>
<p>例如，可以通过 options 指定 Resource 之间的依赖关系，或者指定 Resource Provider 等等。</p>
</li>
</ul>
<h3 id="51-resource-name">5.1 Resource Name</h3>
<p>每个 Resource 有着 Logical Name 与 Physical Name。</p>
<ul>
<li>Logical Name - 用于 Pulumi 中标识该资源，代码中创建时需要指定；</li>
<li>Physical Name - Resource Provider 部署实际的云资源使用的名字；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">role</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Role</span><span class="p">(</span><span class="s2">&#34;my-role&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="511-physical-name-生成规则">5.1.1 Physical Name 生成规则</h4>
<p>默认下，Provider 会使用 Logical Name 作为前缀，后增加随机字符串来生成 Physical Name。随机字符串的意义在于：</p>
<ul>
<li>随机字符串使得 Stack 之间 Resource 的命名不同，防止出现命名冲突；</li>
<li>允许 Pulumi 进行滚动升级：先创建新的 Resource，后删除旧的 Resource；</li>
</ul>
<p>当然，也可以不自动生成，大多数 Resource 有着 <code>name</code> 参数，用以指定 Physical Name。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">role</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Role</span><span class="p">(</span><span class="s2">&#34;my-role&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;my-role-001&#34;</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">一些资源可能不是使用 <code>name</code> 参数（例如 s3 bucket），也有一些资源无法指定名称（例如 kms key）。</div>
        </div>
    </div>
<p>指定 Physical Name 后，需要用户自行防止 Stack 之间的命名冲突，并且对于 Resource 升级时，需要指定参数 <code>deleteBeforeReplace: true</code>。该参数会在升级资源时，先删除旧资源，后创建新资源。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">role</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Role</span><span class="p">(</span><span class="s2">&#34;my-role&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="sb">`my-role-</span><span class="si">${</span><span class="nx">pulumi</span><span class="p">.</span><span class="nx">getProject</span><span class="p">()</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">pulumi</span><span class="p">.</span><span class="nx">getStack</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span> <span class="nx">deleteBeforeReplace</span>: <span class="kt">true</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="512-resource-urn">5.1.2 Resource URN</h4>
<p>每个 Resource 有着全局唯一的名字，称为 Uniform Resource Name（URN）。不过大多数情况下，用户不会直接看到 URN。</p>
<p>URN 基于 Project、Stack、Resource、Resource 类型和父资源类型来创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">urn:pulumi:production::acmecorp-website::custom:resources:Resource$aws:s3/bucket:Bucket::my-bucket
           ^^^^^^^^^^  ^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^  ^^^^^^^^^
           &lt;stack-name&gt; &lt;project-name&gt;   &lt;parent-type&gt;             &lt;resource-type&gt;       &lt;resource-name&gt;
</code></pre></td></tr></table>
</div>
</div><p>不同 URN 的 Resource 之间是被认为没有任何关联的。例如当你改变了某个资源导致 URN 发生变化时，Pulumi 的行为是删除旧 URN 的资源，创建新 URN 的资源。这意味着，Pulumi 调用的是 create 和 delete 操作，而不是 update 和 replace 操作。</p>
<a class="lightgallery" href="/posts/cloud/cloud_practice/use-pulumi/img4.png" title="/posts/cloud/cloud_practice/use-pulumi/img4.png" data-thumbnail="/posts/cloud/cloud_practice/use-pulumi/img4.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_practice/use-pulumi/img4.png"
            data-srcset="/posts/cloud/cloud_practice/use-pulumi/img4.png, /posts/cloud/cloud_practice/use-pulumi/img4.png 1.5x, /posts/cloud/cloud_practice/use-pulumi/img4.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_practice/use-pulumi/img4.png" width="920" height="478" />
    </a>
<h3 id="52-resource-options">5.2 Resource Options</h3>
<p>所有的 Resource 创建时可以传入一些选项来控制一些行为，例如：</p>
<ul>
<li>additionalSecretOutputs - 指定一些属性作为 Secret 加密；</li>
<li>aliases - 指定 Resource 的别名，以在重命名时保留物理资源；</li>
<li>deleteBeforeReplace - 先删除旧资源再创建新资源，以覆盖默认行为；</li>
<li>dependsOn - 指定 Resource 之间的依赖关系；</li>
<li>import - 直接复用当前已有的云资源；</li>
<li>parent - 在 Resource 之间构建父子关系；</li>
<li>replaceOnChanges - 某些属性的更改应该直接使用 replace；</li>
<li>provider - 指定管理资源使用的 Provider；</li>
</ul>
<p>更多信息参考官方文档：<a href="https://www.pulumi.com/docs/intro/concepts/resources/options/" target="_blank" rel="noopener noreffer"><strong>Resource Options</strong></a>。</p>
<h3 id="53-componentresource">5.3 ComponentResource</h3>
<p>ComponentResource 是将一组 Resource 进行组合。Component 在构造函数中实例化使用到 Resource，并将其作为 Child Resource。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">实际上，Stack 本身就是一个 ComponentResource，里面包含了所有 Program 中构建的 Resource。</div>
        </div>
    </div>
<p>使用时，我们需要创建一个继承于 <code>ComponentResource</code> 的子类。在该类的构造函数中，需要先调用父类的构造函数，以注册 ComponentResource 类型到 Pulumi 中。</p>
<p>在构造函数中，可以构建使用的 Child Resource，这与正常编写 Program 时一致。</p>
<p>最后，我们调用了 <code>registerOutputs()</code> 可以将构造函数中的 Output 注册到 Pulumi 中，这也意味着构造函数的结束。因此，无论是否需要注册 Output，都应该最后调用该函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">aws</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">pulumi</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">);</span>

<span class="c1">// Define a component for serving a static website on S3
</span><span class="c1"></span><span class="kr">class</span> <span class="nx">S3Folder</span> <span class="kr">extends</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">ComponentResource</span> <span class="p">{</span>

    <span class="kr">constructor</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Register this component with name examples:S3Folder
</span><span class="c1"></span>        <span class="kr">super</span><span class="p">(</span><span class="s2">&#34;examples:S3Folder&#34;</span><span class="p">,</span> <span class="nx">bucketName</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">opts</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Path where files would be uploaded: </span><span class="si">${</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

        <span class="c1">// Create a bucket and expose a website index document
</span><span class="c1"></span>        <span class="kd">let</span> <span class="nx">siteBucket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">(</span><span class="nx">bucketName</span><span class="p">,</span> <span class="p">{},</span>
            <span class="p">{</span> <span class="nx">parent</span>: <span class="kt">this</span> <span class="p">}</span> <span class="p">);</span> <span class="c1">// specify resource parent
</span><span class="c1"></span>
        <span class="c1">// Create a property for the bucket name that was created
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">bucketName</span> <span class="o">=</span> <span class="nx">siteBucket</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span>

        <span class="c1">// Register that we are done constructing the component
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">registerOutputs</span><span class="p">({</span><span class="nx">bucketDnsName</span>: <span class="kt">bucket.bucketDomainName</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">module</span><span class="nx">.exports.S3Folder</span> <span class="o">=</span> <span class="nx">S3Folder</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>创建 ComponentResource 对象时，支持一个特殊的参数 <code>providers</code>。因为 ComponentResource 可以包含多个 Resource，因此会使用多种 Provider 来构建。<code>providers</code> 参数就是用于指定 ComponentResource 使用的 Provider。</p>
<p>例如，下面示例中指定了 ComponentResource 使用的 AWS 与 Kubernetes 资源对应的 Provider。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">component</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyComponent</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">providers</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">aws</span>: <span class="kt">useast1</span><span class="p">,</span>
        <span class="nx">kubernetes</span>: <span class="kt">myk8s</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>ComponentResource 中所有的 Child Resource 都默认会继承 Provider，除非创建时指定。</p>
<h3 id="54-resource-provider">5.4 Resource Provider</h3>
<p>Resource Provider 负责与云服务通信，以 create、read、update 和 delete 代码中定义的 Resource。不同的 Resource 会使用不同的 Provider，例如：AWS Resource Provider，Kubernetes Resource Provider 等。</p>
<blockquote>
<p>所有支持的 Provider 见 <a href="https://www.pulumi.com/registry/" target="_blank" rel="noopener noreffer"><strong>Pulumi Registry</strong></a>。</p>
</blockquote>
<p>默认下，所有的 Provider 都使用 Stack 配置文件作为配置。因此，你可以在 Stack 配置文件中设置 Provider 的相关配置。</p>
<p>例如，下面命令设置当前 Stack 默认将资源部署在 <code>us-west-2</code> Region。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi config <span class="nb">set</span> aws:region us-west-2
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>关闭默认的 Provider<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>默认 Provider 可以通过配置文件中设置关闭：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ pulumi config <span class="nb">set</span> --path <span class="s1">&#39;pulumi:disable-default-providers[0]&#39;</span> aws

$ pulumi config <span class="nb">set</span> --path <span class="s1">&#39;pulumi:disable-default-providers[1]&#39;</span> kubernetes

$ pulumi config <span class="nb">set</span> --path <span class="s1">&#39;pulumi:disable-default-providers[0]&#39;</span> <span class="s1">&#39;*&#39;</span>
</code></pre></td></tr></table>
</div>
</div></div>
        </div>
    </div>
<p>在 Program 中也可以通过创建 <code>Provider</code> 对象，然后通过创建 Resource 时指定 <code>provider</code>。这样，就可以使用定制的 Provider 来创建 Resource。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">pulumi</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">aws</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">);</span>

<span class="c1">// Create an AWS provider for the us-east-1 region.
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">useast1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">Provider</span><span class="p">(</span><span class="s2">&#34;useast1&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">region</span><span class="o">:</span> <span class="s2">&#34;us-east-1&#34;</span> <span class="p">});</span>

<span class="c1">// Create an ACM certificate in us-east-1.
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cert</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">acm</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">(</span><span class="s2">&#34;cert&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">domainName</span><span class="o">:</span> <span class="s2">&#34;foo.com&#34;</span><span class="p">,</span>
    <span class="nx">validationMethod</span><span class="o">:</span> <span class="s2">&#34;EMAIL&#34;</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">useast1</span> <span class="p">});</span>

<span class="c1">// Create an ALB listener in the default region that references the ACM certificate created above.
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">lb</span><span class="p">.</span><span class="nx">Listener</span><span class="p">(</span><span class="s2">&#34;listener&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">loadBalancerArn</span>: <span class="kt">loadBalancerArn</span><span class="p">,</span>
    <span class="nx">port</span>: <span class="kt">443</span><span class="p">,</span>
    <span class="nx">protocol</span><span class="o">:</span> <span class="s2">&#34;HTTPS&#34;</span><span class="p">,</span>
    <span class="nx">sslPolicy</span><span class="o">:</span> <span class="s2">&#34;ELBSecurityPolicy-2016-08&#34;</span><span class="p">,</span>
    <span class="nx">certificateArn</span>: <span class="kt">cert.arn</span><span class="p">,</span>
    <span class="nx">defaultAction</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">targetGroupArn</span>: <span class="kt">targetGroupArn</span><span class="p">,</span>
        <span class="kr">type</span><span class="o">:</span> <span class="s2">&#34;forward&#34;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>如 <a href="#componentresource" rel=""><strong>ComponentResource</strong></a> 所说，通过 <code>providers</code> 参数来设置 ComponentResource 子资源使用的 Provider。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">class</span> <span class="nx">MyResource</span> <span class="kr">extends</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">ComponentResource</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="s2">&#34;instance&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">parent</span>: <span class="kt">this</span> <span class="p">});</span>
        <span class="kd">let</span> <span class="nx">pod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">(</span><span class="s2">&#34;pod&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">parent</span>: <span class="kt">this</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">useast1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">Provider</span><span class="p">(</span><span class="s2">&#34;useast1&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">region</span><span class="o">:</span> <span class="s2">&#34;us-east-1&#34;</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">myk8s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Provider</span><span class="p">(</span><span class="s2">&#34;myk8s&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">context</span><span class="o">:</span> <span class="s2">&#34;test-ci&#34;</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">myResource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyResource</span><span class="p">(</span><span class="s2">&#34;myResource&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">providers</span><span class="o">:</span> <span class="p">{</span> <span class="nx">aws</span>: <span class="kt">useast1</span><span class="p">,</span> <span class="nx">kubernetes</span>: <span class="kt">myk8s</span> <span class="p">}</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="55-dynamic-providers">5.5 Dynamic Providers</h3>
<p>Dynamic Providers 指的是用户自行编写的 Provider，类似于原生的 AWS Provider 与 Kubernetes Provider 等，可以通过 Dynamic Provider 来管理用户自定义的资源。</p>
<p>Dynamic Providers 实现基于一些框架，具体细节见官方文档：<a href="https://www.pulumi.com/docs/intro/concepts/resources/dynamic-providers" target="_blank" rel="noopener noreffer"><strong>Dynamic Providers</strong></a>。</p>
<h3 id="56-getter-函数">5.6 Getter 函数</h3>
<p>所有的 Resource 资源都可以使用 <code>get</code> 函数来获取某个资源的信息。不同于 <code>import</code> 函数，<code>get</code> 函数取得的结果是同步的，Pulumi 永远不会更新或删除 <code>get</code> 函数读取的资源信息。</p>
<p><code>get</code> 函数接受两个参数：Logical Name 和 对应资源的 Physical ID。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="kr">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SecurityGroup</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;group&#34;</span><span class="p">,</span> <span class="s2">&#34;sg-0dfd33cdac25b1ec9&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="s2">&#34;web-server&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">ami</span><span class="o">:</span> <span class="s2">&#34;ami-6869aa05&#34;</span><span class="p">,</span>
    <span class="nx">instanceType</span><span class="o">:</span> <span class="s2">&#34;t2.micro&#34;</span><span class="p">,</span>
    <span class="nx">securityGroups</span><span class="o">:</span> <span class="p">[</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="c1">// reference the security group resource above
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="6-input-和-output">6 Input 和 Output</h2>
<p>Program 中定义的 Resource 是异步构建的，为了能够处理 Resource 之间的依赖关系，Pulumi 设计出了 Input 与 Output 类型来描述 Resource 之间的依赖关系。</p>
<p>每个 Resource 的构造函数都接收 <code>Input&lt;T&gt;</code> 类型，该类型可以是静态的值（例如 string、interger、boolean 类型的值等），或者异步计算的值（例如 Promise 或者 Task），或者从其他 Resource 属性读取的 Output。</p>
<p>所有 Resource 的属性以及本身都可以作为 Output。Output 是类型 <code>Output&lt;T&gt;</code> 的实例，其值会经过异步的计算。因为在实际的资源部署之前，Resource Output 都是未知的，所以 Pulumi 会在部署后异步填入 Output。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">不要纠结于 Input 与 Output 的概念，可以简单理解 Output 与 Input 都是描述依赖关系，而所有的值都是引用。</div>
        </div>
    </div>
<p>根据 Input 与 Output，Pulumi 就可以计算出 Resource 之间引用的依赖关系，从而确保按顺序创建存在依赖关系的 Resource。</p>
<p>因为 Output 是异步的，因此其值不是立即使用的。如果你想从 Output 中派生出新的 Output（依赖关系会延续），有以下方法。</p>
<ul>
<li>Apply - 回调函数，接受 Output 处理后派生出新的 Output；</li>
<li>Lifting - 直接读取 Resource 属性，该属性会被提升为一个 Output；</li>
<li>Interpolation - 使用 Output 进行字符串拼接；</li>
</ul>
<h3 id="61-apply">6.1 Apply</h3>
<p>使用 <code>apply</code> 函数可以读取 Output 并派生出一个新的 Output。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">virtualmachine</span><span class="p">.</span><span class="nx">dnsName</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">dnsName</span> <span class="o">=&gt;</span> <span class="s2">&#34;https://&#34;</span> <span class="o">+</span> <span class="nx">dnsName</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>上述示例中，<code>url</code> 也是一个 Output，并且依赖于 <code>dnsName</code> Output。也就是说，只有当 <code>dnsName</code> 的值可用后，才会计算出 <code>url</code> 的值。</p>
<p>如果需要从多个 Output 处理后派生出一个 Output，可以使用 <code>all</code> 函数。新的 Output 将会等待所有依赖的 Output 值可用后才计算出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="kr">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>
<span class="c1">// ...
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">connectionString</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">sqlServer</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">database</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">apply</span><span class="p">(([</span><span class="nx">server</span><span class="p">,</span> <span class="nx">db</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="sb">`Server=tcp:</span><span class="si">${</span><span class="nx">server</span><span class="si">}</span><span class="sb">.database.windows.net;initial catalog=</span><span class="si">${</span><span class="nx">db</span><span class="si">}</span><span class="sb">...`</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="62-lifting">6.2 Lifting</h3>
<p>当你将某个 Resource 的属性传递给其他 Resource 用于初始化时，该属性会被 Lift 为一个 Output。也就是说，Resource 会自动依赖与另一个 Resource。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">certCertificate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">acm</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">(</span><span class="s2">&#34;cert&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">domainName</span><span class="o">:</span> <span class="s2">&#34;example.com&#34;</span><span class="p">,</span>
    <span class="nx">validationMethod</span><span class="o">:</span> <span class="s2">&#34;DNS&#34;</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">let</span> <span class="nx">certValidation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">route53</span><span class="p">.</span><span class="nx">Record</span><span class="p">(</span><span class="s2">&#34;cert_validation&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">records</span><span class="o">:</span> <span class="p">[</span>
        <span class="nx">certCertificate</span><span class="p">.</span><span class="nx">domainValidationOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">resourceRecordValue</span>
    <span class="p">],</span>
<span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p>在 JavaScript 与 TypeScript 环境下，如果访问的 Resource 属性是计算后是未定义的，那么会认为值为 undefined，而不是报错。</p>
<h3 id="63-interpolation">6.3 Interpolation</h3>
<p>即使 Output 的值为字符串，也不能直接用于字符串连接。直接使用 <code>apply</code> 函数拼接可能过滤繁琐，你可以使用 Pulumi 提供的 Interpolation 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">hostname</span>: <span class="kt">Output</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;;</span>
<span class="kd">let</span> <span class="nx">port</span>: <span class="kt">Output</span><span class="p">&lt;</span><span class="nt">number</span><span class="p">&gt;;</span>

<span class="c1">// 直接使用 apply 函数
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">hostname</span><span class="p">,</span> <span class="nx">port</span><span class="p">]).</span>
    <span class="nx">apply</span><span class="p">(([</span><span class="nx">hostname</span><span class="p">,</span> <span class="nx">port</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="sb">`http://</span><span class="si">${</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span>

<span class="c1">// 使用 concat 函数
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">url1</span>: <span class="kt">Output</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&#34;http://&#34;</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">);</span>
<span class="c1">// 使用 interpolate 函数
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">url2</span>: <span class="kt">Output</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">interpolate</span> <span class="sb">`http://</span><span class="si">${</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">/`</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="64-input-转换为-output">6.4 Input 转换为 Output</h3>
<p>Input 也可以转换为 Output，以便进一步处理它。使用 <code>output</code> 函数来转换 Input。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">function</span> <span class="nx">split</span><span class="p">(</span><span class="nx">input</span>: <span class="kt">pulumi.Input</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">Output</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">split</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="7-secret">7 Secret</h2>
<p>Output 与配置文件默认都是不加密的保存的。如果需要保存一些敏感信息，可以使用 Secret。</p>
<p>无论是 Secret Output 还是 Secret Cofig，Pulumi Service 都会使用每个 Stack 的独立密钥对其进行加密后再保存。</p>
<p>通过 <code>--secret</code> 参数创建 Secret 配置，：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># pulumi config set --secret &#39;token&#39; 123</span><span class="w">
</span><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">quickstart:token</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 加密后内容</span><span class="w">
</span><span class="w">    </span><span class="nt">secure</span><span class="p">:</span><span class="w"> </span><span class="l">AAABAH31XbQSigUOA10PKZOWPzLMnPIbrdu58QulEeWVED4=</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在 Program 中，有三种使用 Secret 的方式：</p>
<ul>
<li>
<p>Program 中使用 <code>getSecret</code> 或 <code>requireSecret</code> 方法读取 Secret 配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">cfg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">Config</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">param</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ssm</span><span class="p">.</span><span class="nx">Parameter</span><span class="p">(</span><span class="s2">&#34;a-secret-param&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="kr">type</span><span class="o">:</span> <span class="s2">&#34;SecureString&#34;</span><span class="p">,</span>
    <span class="nx">value</span>: <span class="kt">cfg.requireSecret</span><span class="p">(</span><span class="s2">&#34;my-secret-value&#34;</span><span class="p">),</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>pulumi.secret</code> 函数创建一个 Secret。</p>
</li>
<li>
<p>定义 Resource 时，通过 <code>additionalSecretOutputs</code> 选项标记 Resource 为 Secret</p>
</li>
</ul>
<p>任何通过使用 Secret 的 <a href="#6-input-%e5%92%8c-output" rel=""><strong>Output</strong></a> 也会被标记为 Secret，进而也会被加密保存。</p>
<h3 id="71-配置-secret-provider">7.1 配置 Secret Provider</h3>
<p>默认下，Pulumi Service 会为每个 Stack 自动生成独立的加密密钥。保存 Secret 信息时就会使用该密钥进行加密。</p>
<p>Pulumi Service 也支持配置 Secret Provider，以使用云厂商的加密服务，例如 AWS KMS 和 GCP KMS 等。</p>
<p>创建 Stack 时，可以通过 <code>--secrets-provider</code> 参数指定 secret provider。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">pulumi stack init &lt;name&gt; --secrets-provider<span class="o">=</span><span class="s2">&#34;&lt;provider&gt;://&lt;provider-settings&gt;&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>关于 <code>&quot;&lt;provider&gt;://&lt;provider-settings&gt;&quot;</code> 的具体内容，参考 <a href="https://www.pulumi.com/docs/intro/concepts/secrets/#available-encryption-providers" target="_blank" rel="noopener noreffer"><strong>Available Encryption Providers</strong></a>。</p>
<p>如果要更改当前 Stack 的 Secret Provider，可以使用 <code>stack change-secret-provider</code> 命令。这只会影响后续新的 Secret Output 或配置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">pulumi stack change-secrets-provider <span class="s2">&#34;&lt;secrets-provider&gt;&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="8-function-serialization">8 Function Serialization</h2>
<p>Pulumi 支持使用 TypeScript 或者 JavaScript 直接编写函数计算的 Function。</p>
<p>例如，下面编写了函数逻辑并直接创建 AWS Lambda 函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="kr">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">lambda</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">lambda</span><span class="p">.</span><span class="nx">CallbackFunction</span><span class="p">(</span><span class="s2">&#34;mylambda&#34;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">callback</span>: <span class="kt">async</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// your code here ...
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">someOutput</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>甚至，可以直接设置 Lambda 函数的触发器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">bucket</span><span class="p">.</span><span class="nx">onObjectCreated</span><span class="p">(</span>
  <span class="s2">&#34;mytrigger&#34;</span><span class="p">,</span>
  <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">lambda</span><span class="p">.</span><span class="nx">CallbackFunction</span><span class="p">(</span><span class="s2">&#34;mylambda&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">callback</span>: <span class="kt">async</span> <span class="nx">eventInfo</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">record</span> <span class="k">of</span> <span class="nx">eventInfo</span><span class="p">.</span><span class="nx">Records</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// process each record we&#39;re notified about.
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1">// Only let this Lambda run for a minute before forcefully terminating it.
</span><span class="c1"></span>    <span class="nx">timeout</span>: <span class="kt">60</span>
  <span class="p">})</span>
<span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li>官方文档：<a href="https://www.pulumi.com/docs/intro/concepts/" target="_blank" rel="noopener noreffer"><strong>Architecture &amp; Concepts</strong></a></li>
<li>官方文档：<a href="https://www.pulumi.com/registry/" target="_blank" rel="noopener noreffer"><strong>Registry</strong></a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-06-12&nbsp;<a class="git-hash" href="https://github.com/KanShiori/KanShiori.github.io/commit/c89e094c6f96c5d95110f1589607d938fe70519a" target="_blank" title="commit by Shiori(yshshihaoren@qq.com) c89e094c6f96c5d95110f1589607d938fe70519a: fix">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>c89e094</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/cloud/cloud_practice/use-pulumi/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-title="Pulumi 入门" data-hashtags="云计算"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-hashtag="云计算"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-title="Pulumi 入门"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-title="Pulumi 入门"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-title="Pulumi 入门"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-title="Pulumi 入门"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/baidu.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://KanShiori.github.io/posts/cloud/cloud_practice/use-pulumi/" data-title="Pulumi 入门"><i class="fab fa-evernote fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cloud/cloud_practice/debug-pod/" class="prev" rel="prev" title="Kubernetes 中调试 Pod"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Kubernetes 中调试 Pod</a>
            <a href="/posts/cloud/cloud_practice/use-crossplane/" class="next" rel="next" title="Crossplane 入门">Crossplane 入门<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.91.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Shiori</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":35},"comment":{},"lightgallery":true,"search":{"algoliaAppID":"9NJS0VQU0I","algoliaIndex":"blog","algoliaSearchKey":"85d62ea65a7f7445fbfb413bdca088f2","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
