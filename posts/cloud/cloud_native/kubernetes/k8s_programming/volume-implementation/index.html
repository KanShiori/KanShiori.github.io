<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>K8s 实现 - Volume 实现 - Shiori&#39;s Blog</title><meta name="Description" content="Kubernetes Volume 的背后原理"><meta property="og:title" content="K8s 实现 - Volume 实现" />
<meta property="og:description" content="Kubernetes Volume 的背后原理" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" /><meta property="og:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-11T14:35:42+00:00" />
<meta property="article:modified_time" content="2023-02-09T21:11:10+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/>

<meta name="twitter:title" content="K8s 实现 - Volume 实现"/>
<meta name="twitter:description" content="Kubernetes Volume 的背后原理"/>
<meta name="application-name" content="Shiori&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Shiori&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/icons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" /><link rel="prev" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-design/" /><link rel="next" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/csi-implementation/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "K8s 实现 - Volume 实现",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_native\/kubernetes\/k8s_programming\/volume-implementation\/"
        },"image": ["https:\/\/KanShiori.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "k8s, 云计算","wordcount":  5438 ,
        "url": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_native\/kubernetes\/k8s_programming\/volume-implementation\/","datePublished": "2021-11-11T14:35:42+00:00","dateModified": "2023-02-09T21:11:10+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/KanShiori.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Shiori"
            },"description": "Kubernetes Volume 的背后原理"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="http://kanshiori.cn" rel="noopener noreffer" target="_blank"> 主页 </a><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="http://kanshiori.cn" title="" rel="noopener noreffer" target="_blank">主页</a><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">K8s 实现 - Volume 实现</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Shiori</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes-%E7%BC%96%E7%A8%8B/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Kubernetes 编程</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-11-11">2021-11-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 5438 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 11 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-base-interface">1 Base Interface</a>
      <ul>
        <li><a href="#11-volumeplugin-interface">1.1 VolumePlugin Interface</a></li>
        <li><a href="#12-control-interface">1.2 Control Interface</a></li>
      </ul>
    </li>
    <li><a href="#2-volume-plugin-的管理">2 Volume Plugin 的管理</a>
      <ul>
        <li><a href="#21-volumepluginmgr-类">2.1 VolumePluginMgr 类</a></li>
        <li><a href="#22-如何注册-volume-plugin">2.2 如何注册 Volume Plugin</a>
          <ul>
            <li><a href="#221-dynamicpluginprober-接口">2.2.1 DynamicPluginProber 接口</a></li>
            <li><a href="#222-csi-plugin-的注册">2.2.2 CSI Plugin 的注册</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-pv-controller">3 PV Controller</a>
      <ul>
        <li><a href="#31-触发逻辑">3.1 触发逻辑</a></li>
        <li><a href="#32-reconcile-pv">3.2 Reconcile PV</a></li>
        <li><a href="#33-reconcile-pvc">3.3 Reconcile PVC</a></li>
      </ul>
    </li>
    <li><a href="#4-attachdetach-controller">4 AttachDetach Controller</a>
      <ul>
        <li><a href="#41-更新-desiredstateofworld">4.1 更新 desiredStateOfWorld</a></li>
        <li><a href="#42-更新-actualstateofworld">4.2 更新 actualStateOfWorld</a></li>
        <li><a href="#43-reconcile">4.3 Reconcile</a></li>
      </ul>
    </li>
    <li><a href="#5-kubelet-如何处理-volume">5 Kubelet 如何处理 Volume</a>
      <ul>
        <li><a href="#51-reconcile">5.1 Reconcile</a>
          <ul>
            <li><a href="#511-unmountvolumes">5.1.1 unmountVolumes</a></li>
            <li><a href="#512-mountattachvolumes">5.1.2 mountAttachVolumes</a></li>
            <li><a href="#513-unmountdetachdevices">5.1.3 unmountDetachDevices</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>介绍 Kubernetes 源码中 Volume 相关的实现（不包含 CSI 相关实现）。</p>
<p>Volume 的基本概念见 <a href="../../k8s_learning/volume" rel=""><strong>Kubernetes - 存储设计</strong></a>。</p>
</blockquote>
<h2 id="1-base-interface">1 Base Interface</h2>
<p>在 <a href="../../k8s_learning/volume" rel=""><strong>Kubernetes - 存储设计</strong></a> 中看到，各个存储插件都围绕这 Volume Plugin 的概念展开。这里我们先看一下 Interface 的抽象。</p>
<h3 id="11-volumeplugin-interface">1.1 VolumePlugin Interface</h3>
<p>在源码实现中，Volume Plugin 概念对应的就是 <strong><code>VolumePlugin</code></strong> Interface，其定义了最基本的存储插件应该支持接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Spec</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Volume</span>                          <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Volume</span>
	<span class="nx">PersistentVolume</span>                <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span>
	<span class="nx">ReadOnly</span>                        <span class="kt">bool</span>
	<span class="nx">InlineVolumeSpecForCSIMigration</span> <span class="kt">bool</span>
	<span class="nx">Migrated</span>                        <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// VolumePlugin is an interface to volume plugins that can be used on a
</span><span class="c1">// kubernetes node (e.g. by kubelet) to instantiate and manage volumes.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">VolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Init 初始化 plugin
</span><span class="c1"></span>	<span class="nf">Init</span><span class="p">(</span><span class="nx">host</span> <span class="nx">VolumeHost</span><span class="p">)</span> <span class="kt">error</span>
	<span class="c1">// Name 返回 plugin name
</span><span class="c1"></span>	<span class="c1">// 命名方式为 &#34;example.com/volume&#34;，&#34;kubernetes.io&#34; 由 kubernete 内置 Volume 预留使用
</span><span class="c1"></span>	<span class="nf">GetPluginName</span><span class="p">()</span> <span class="kt">string</span>
	<span class="c1">// GetVolumeName 基于 spec 返回一个唯一的 volume name 或者 id
</span><span class="c1"></span>	<span class="c1">// 对于 Attach 与 Detach 操作会传递该 name 来让 plugin 识别 volume
</span><span class="c1"></span>	<span class="nf">GetVolumeName</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// CanSupport 返回 plugin 是否支持该 spec
</span><span class="c1"></span>	<span class="nf">CanSupport</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="kt">bool</span>
	<span class="c1">// RequiresRemount 表明 plugin 是否支持 volume 的重新挂载
</span><span class="c1"></span>	<span class="nf">RequiresRemount</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="kt">bool</span>
	<span class="c1">// NewMounter 创建一个 Mounter
</span><span class="c1"></span>	<span class="nf">NewMounter</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">podRef</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">VolumeOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Mounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// NewUnmounter 创建一个 UnMounter
</span><span class="c1"></span>	<span class="nf">NewUnmounter</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">podUID</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">)</span> <span class="p">(</span><span class="nx">Unmounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// ConstructVolumeSpec 由 volume name 得到一个 spec
</span><span class="c1"></span>	<span class="nf">ConstructVolumeSpec</span><span class="p">(</span><span class="nx">volumeName</span><span class="p">,</span> <span class="nx">volumePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// SupportsMountOption 表明是否支持挂载选项
</span><span class="c1"></span>	<span class="nf">SupportsMountOption</span><span class="p">()</span> <span class="kt">bool</span>
	<span class="c1">// SupportsBulkVolumeVerification checks if volume plugin type is capable
</span><span class="c1"></span>	<span class="c1">// of enabling bulk polling of all nodes. This can speed up verification of
</span><span class="c1"></span>	<span class="c1">// attached volumes by quite a bit, but underlying pluging must support it.
</span><span class="c1"></span>	<span class="nf">SupportsBulkVolumeVerification</span><span class="p">()</span> <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <strong><code>VolumePlugin</code></strong> 之上，根据支持的功能不同衍生了更多的 Plugin Interface。包括：</p>
<ul>
<li><strong><code>PersistentVolumePlugin</code></strong> - Volume 支持保存持久数据</li>
<li><strong><code>RecyclableVolumePlugin</code></strong> - 支持 Recycle Volume</li>
<li><strong><code>DeletableVolumePlugin</code></strong> - 支持 Delete Volume</li>
<li><strong><code>ProvisionableVolumePlugin</code></strong> - 支持 Provision Volume</li>
<li><strong><code>DeviceMountableVolumePlugin</code></strong> - 需要先挂载 Device，才可以将 Volume 挂载给 Pod</li>
<li><strong><code>AttachableVolumePlugin</code></strong> - 需要先 Attach 到 Node，再挂载 Device，才可以将 Volume 挂载给 Pod</li>
<li><strong><code>ExpandableVolumePlugin</code></strong> - Volume 支持从控制面触发 Expand</li>
<li><strong><code>NodeExpandableVolumePlugin</code></strong> - Volume 支持 Node 触发 Expand</li>
<li><strong><code>VolumePluginWithAttachLimits</code></strong> - 限制 Node 能够 Attach Volume 的数量</li>
<li><strong><code>BlockVolumePlugin</code></strong> - 支持 Block Volume</li>
</ul>
<p>看几个 Interface 为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// DeletableVolumePlugin 表示支持 Delete 操作的 Volume Plugin
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DeletableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">VolumePlugin</span>
	<span class="nf">NewDeleter</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">Deleter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ProvisionableVolumePlugin 表示支持 Provisioner 操作的 Volume Plugin
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ProvisionableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">VolumePlugin</span>
	<span class="nf">NewProvisioner</span><span class="p">(</span><span class="nx">options</span> <span class="nx">VolumeOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Provisioner</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// AttachableVolumePlugin 表示支持 Attach/Detach 操作的 Volume Plugin
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">AttachableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">DeviceMountableVolumePlugin</span>
	<span class="nf">NewAttacher</span><span class="p">()</span> <span class="p">(</span><span class="nx">Attacher</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">NewDetacher</span><span class="p">()</span> <span class="p">(</span><span class="nx">Detacher</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">CanAttach</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// DeviceMountableVolumePlugin 表示支持 Mount/Unmount 操作的 Volume Plugin
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DeviceMountableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">VolumePlugin</span>
	<span class="nf">NewDeviceMounter</span><span class="p">()</span> <span class="p">(</span><span class="nx">DeviceMounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">NewDeviceUnmounter</span><span class="p">()</span> <span class="p">(</span><span class="nx">DeviceUnmounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetDeviceMountRefs</span><span class="p">(</span><span class="nx">deviceMountPath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">CanDeviceMount</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>用一个类图总结一下：</p>
<a class="lightgallery" href="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png" title="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png" data-thumbnail="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png"
            data-srcset="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png 1.5x, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img3.png" width="908" height="400" />
    </a>
<p>可以看到，上面 <strong><code>VolumePlugin</code></strong> 相关 Interface 除了提供基础的信息查询接口外，不直接提供实际的操作 Volume 的接口，而是返回 Mounter 这样的 Interface。</p>
<h3 id="12-control-interface">1.2 Control Interface</h3>
<p>源码中将提供 Mount / Provision 具体操作接口单独抽成了一个个 Interface，我们现称之为 Control Interface。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Why<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>个人猜想还是为了复用，例如不同的 Plugin 可能大部分 Volume 操作都是不同的，但是一些例如 SetUp 这样的接口大部分实现都是一样的，因此能够通过返回同一个 Mounter 实例来复用逻辑。</p>
<p><important>将 Control 逻辑抽象为 Interface 是一个很常见的设计方式。</important></p>
</div>
        </div>
    </div>
<p>Control Interface 包括：</p>
<ul>
<li><strong><code>Mounter</code></strong>
<ul>
<li><code>CanMount()</code> - SetUp() 调用前检查所需的组件（例如插件程序）是否准备好</li>
<li><code>SetUp()</code> 与 <code>SetUpAt()</code> - 为 Pod 准备好对应的 Volume 目录</li>
</ul>
</li>
<li><strong><code>Unmounter</code></strong>
<ul>
<li><code>TearDown()</code> 与 <code>TearDownAt()</code> - 移除为 Pod 准备的 Volume 目录</li>
</ul>
</li>
<li><strong><code>CustomBlockVolumeMapper</code></strong>
<ul>
<li><code>SetUpDevice()</code> - 为 Pod 准备好 Device</li>
<li><code>MapPodDevice()</code> - 将 Device 映射给 Pod</li>
</ul>
</li>
<li><strong><code>CustomBlockVolumeUnmapper</code></strong>
<ul>
<li><code>TearDownDevice()</code> - 移除为 Pod 准备好的 Device</li>
<li><code>UnmapPodDevice()</code> - 取消 Device 映射</li>
</ul>
</li>
<li><strong><code>Provisioner</code></strong>
<ul>
<li><code>Provision()</code> - 创建一个 Volume</li>
</ul>
</li>
<li><strong><code>Deleter</code></strong>
<ul>
<li><code>Delete()</code> - 删除一个 Volume</li>
</ul>
</li>
<li><strong><code>Attacher</code></strong>
<ul>
<li><code>Attach()</code> - Attach Volume 到 Node 上</li>
<li><code>VolumesAreAttached()</code> - 返回 Node 上的 attached Volume</li>
</ul>
</li>
<li><strong><code>Detacher</code></strong>
<ul>
<li><code>Detach()</code> - Detach Volume</li>
</ul>
</li>
<li><strong><code>DeviceMounter</code></strong>
<ul>
<li><code>MountDevice()</code> - 将 attached Volume 挂载到一个全局目录</li>
</ul>
</li>
<li><strong><code>DeviceUnmounter</code></strong>
<ul>
<li><code>UnmountDevice()</code> - 取消 attached Volume 的全局目录挂载</li>
</ul>
</li>
</ul>
<p>来看几个 Control Interface：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Volume represents a directory used by pods or hosts on a node. All method
</span><span class="c1">// implementations of methods in the volume interface must be idempotent.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Volume</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// GetPath 返回 volume 需要的挂载路径
</span><span class="c1"></span>	<span class="nf">GetPath</span><span class="p">()</span> <span class="kt">string</span>
	<span class="c1">// MetricsProvider 提供统计接口
</span><span class="c1"></span>	<span class="nx">MetricsProvider</span>
<span class="p">}</span>

<span class="c1">// Mounter 接口为 Pod 提供 Volume 对应的目录
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Mounter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Volume</span>
	<span class="c1">// CanMount 优先于 Setup 调用，用于检查当前环境是否包含能够 Mount 的组件
</span><span class="c1"></span>	<span class="nf">CanMount</span><span class="p">()</span> <span class="kt">error</span>
	<span class="c1">// SetUp 为 Pod 提供 Volume 的目录，目录路径由自己决定
</span><span class="c1"></span>	<span class="nf">SetUp</span><span class="p">(</span><span class="nx">mounterArgs</span> <span class="nx">MounterArgs</span><span class="p">)</span> <span class="kt">error</span>
	<span class="c1">// SetUpAt  为 Pod 提供 Volume 的目录，目录路径由 dir 指定
</span><span class="c1"></span>	<span class="nf">SetUpAt</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">mounterArgs</span> <span class="nx">MounterArgs</span><span class="p">)</span> <span class="kt">error</span>
	<span class="c1">// GetAttributes 返回 Volume 的属性
</span><span class="c1"></span>	<span class="nf">GetAttributes</span><span class="p">()</span> <span class="nx">Attributes</span>
<span class="p">}</span>

<span class="c1">// Unmounter interface provides methods to cleanup/unmount the volumes.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Unmounter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Volume</span>
	<span class="c1">// TearDown 取消为 Pod 提供的目录
</span><span class="c1"></span>	<span class="nf">TearDown</span><span class="p">()</span> <span class="kt">error</span>
	<span class="c1">// TearDown 取消为 Pod 提供的指定目录
</span><span class="c1"></span>	<span class="nf">TearDownAt</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="c1">// BlockVolumeMapper interface is a mapper interface for block volume.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">BlockVolumeMapper</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">BlockVolume</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Provisioner</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Provision 创建一个 Volume
</span><span class="c1"></span>	<span class="nf">Provision</span><span class="p">(</span><span class="nx">selectedNode</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">allowedTopologies</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">TopologySelectorTerm</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Deleter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Volume</span>
	<span class="c1">// Deleter 移除一个 Volume
</span><span class="c1"></span>	<span class="nf">Delete</span><span class="p">()</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Attacher</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">DeviceMounter</span>
	<span class="c1">// Attach Volume 到指定的 Node 上
</span><span class="c1"></span>	<span class="nf">Attach</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// VolumesAreAttached 查询 Node 上的 attached Volume
</span><span class="c1"></span>	<span class="nf">VolumesAreAttached</span><span class="p">(</span><span class="nx">specs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Spec</span><span class="p">]</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// WaitForAttach 等待 attach 结束
</span><span class="c1"></span>	<span class="nf">WaitForAttach</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">devicePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DeviceMounter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// GetDeviceMountPath 返回 Node 上 Volume 对应的块设备路径
</span><span class="c1"></span>	<span class="nf">GetDeviceMountPath</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// MountDevice 将 Volume 对应的块设备挂载到一个全局的目录（不提供给 Pod）
</span><span class="c1"></span>	<span class="nf">MountDevice</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">devicePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deviceMountPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deviceMounterArgs</span> <span class="nx">DeviceMounterArgs</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Detacher</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">DeviceUnmounter</span>
	<span class="c1">// Detach Volume 在指定的 Node
</span><span class="c1"></span>	<span class="nf">Detach</span><span class="p">(</span><span class="nx">volumeName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DeviceUnmounter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// UnmountDevice 取消 Volume 对应块设备的挂载
</span><span class="c1"></span>	<span class="nf">UnmountDevice</span><span class="p">(</span><span class="nx">deviceMountPath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="2-volume-plugin-的管理">2 Volume Plugin 的管理</h2>
<p>当我们有了 <strong><code>VolumePlugin</code></strong> 及相关的 Interface 后，Kubernetes 就需要实现如果管理多个 Volume Plugin 了。</p>
<h3 id="21-volumepluginmgr-类">2.1 VolumePluginMgr 类</h3>
<p><strong>所有的 VolumePlugin 会注册到 VolumePluginMgr 对象中管理。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">VolumePluginMgr</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">mutex</span>                     <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">plugins</span>                   <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">VolumePlugin</span>  <span class="c1">// 静态注册的 VolumePlugin
</span><span class="c1"></span>	<span class="nx">prober</span>                    <span class="nx">DynamicPluginProber</span>
	<span class="nx">probedPlugins</span>             <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">VolumePlugin</span> <span class="c1">// probe 探测出的 VolumePlugin
</span><span class="c1"></span>	<span class="nx">loggedDeprecationWarnings</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span>
	<span class="nx">Host</span>                      <span class="nx">VolumeHost</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>大多数 Controller 需要使用 Volume Plugin 时，就会调用 Find 函数来查找对应的 Plugin。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FindPluginBySpec 查找能够支持 spec 的 VolumePlugin
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="o">*</span><span class="nx">VolumePluginMgr</span><span class="p">)</span> <span class="nf">FindPluginBySpec</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">VolumePlugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">spec</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not find plugin because volume spec is nil&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// 调用静态注册的 VolumePlugin.CanSupport() 函数筛选
</span><span class="c1"></span>	<span class="nx">matches</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">VolumePlugin</span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">plugins</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">CanSupport</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">matches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// 进行一次 Probe Plugin
</span><span class="c1"></span>	<span class="nx">pm</span><span class="p">.</span><span class="nf">refreshProbedPlugins</span><span class="p">()</span>

	<span class="c1">// 调用动态注册的 VolumePlugin.CanSupport() 函数筛选
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">plugin</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">probedPlugins</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">CanSupport</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">matches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">plugin</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// 没有任何 Volume Plugin 能够处理
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no volume plugin matched&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// 多个 Volume Plugin 能够处理
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="nx">matchedPluginNames</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">plugin</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">matches</span> <span class="p">{</span>
			<span class="nx">matchedPluginNames</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matchedPluginNames</span><span class="p">,</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">GetPluginName</span><span class="p">())</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;multiple volume plugins matched: %s&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">matchedPluginNames</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="c1">// 返回唯一的 Volume Plugin
</span><span class="c1"></span>	<span class="c1">// Issue warning if the matched provider is deprecated
</span><span class="c1"></span>	<span class="nx">pm</span><span class="p">.</span><span class="nf">logDeprecation</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">GetPluginName</span><span class="p">())</span>
	<span class="k">return</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// FindPluginByName 通过 plugin name 查找 Volume Plugin
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="o">*</span><span class="nx">VolumePluginMgr</span><span class="p">)</span> <span class="nf">FindPluginByName</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">VolumePlugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="o">*</span><span class="nx">VolumePluginMgr</span><span class="p">)</span> <span class="nf">FindPersistentPluginBySpec</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">PersistentVolumePlugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// 其他各个类型的 VolumePlugin ...
</span></code></pre></td></tr></table>
</div>
</div><h3 id="22-如何注册-volume-plugin">2.2 如何注册 Volume Plugin</h3>
<p>不同类型的 Volume Plugin 有着不同的注册方式：</p>
<ul>
<li>In-Tree Plugin 在代码中直接注册到 <strong><code>VolumePluginMgr</code></strong> 中。</li>
<li>FlexVolume 通过 DynamicPluginProber 动态探测，探测后注册到 <strong><code>VolumePluginMgr</code></strong> 中。</li>
<li>CSI 是内置了一个 Plugin 实现，用以创建 PVC 与 VolumeAttacment 等资源，靠 Controller 异步的处理。在 Node 上通过 socket 的方式进行动态的注册到 Kubelet 中。</li>
</ul>
<h4 id="221-dynamicpluginprober-接口">2.2.1 DynamicPluginProber 接口</h4>
<p>FlexVolume 是由 DynamicPluginProber 接口进行 Probe 后，以动态方式注册。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ProbeEvent</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Plugin</span>     <span class="nx">VolumePlugin</span> <span class="c1">// VolumePlugin that was added/updated/removed. if ProbeEvent.Op is &#39;ProbeRemove&#39;, Plugin should be nil
</span><span class="c1"></span>	<span class="nx">PluginName</span> <span class="kt">string</span>
	<span class="nx">Op</span>         <span class="nx">ProbeOperation</span> <span class="c1">// The operation to the plugin
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">type</span> <span class="nx">DynamicPluginProber</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Init</span><span class="p">()</span> <span class="kt">error</span>

	<span class="c1">// If an error occurs, events are undefined.
</span><span class="c1"></span>	<span class="nf">Probe</span><span class="p">()</span> <span class="p">(</span><span class="nx">events</span> <span class="p">[]</span><span class="nx">ProbeEvent</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>调用 <strong><code>Probe()</code></strong> 会去插件目录查找插件的可执行文件，并创建 <strong><code>flexVolumePlugin</code></strong> 类，<strong>flexVolumePlugin 即实现了 VolumePlugin 接口</strong>，可以注册到 VolumePluginMgr 中。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>插件目录<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Probe() 接口查找的目录格式为 <code>&lt;plugindir&gt;/&lt;vendor~driver&gt;/&lt;driver&gt;</code>，<code>&lt;plugindir&gt;</code> 在 Kubelet 由参数 <code>--volume-plugin-dir</code> 指定，在 Controller Manager 由参数 <code>--flex-volume-plugin-dir</code>。</p>
<p>默认为路径 <code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec</code>。</p>
</div>
        </div>
    </div>
<p><strong><code>DynamicPluginProber</code></strong> 周期性进行 <strong><code>Probe()</code></strong> 操作，注册新发现的 flexVolumePlugin，移除不存在的 flexVolumePlugin。</p>
<p>当调用 flexVolumePlugin 的操作接口（NewMounter、NewAttacher 等），会转发调用各个可执行文件的命令。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ./uds
Usage:
  flexvoldrv <span class="o">[</span>command<span class="o">]</span>

Available Commands:
  <span class="nb">help</span>        Help about any <span class="nb">command</span>
  init        Flex volume init command.
  mount       Flex volume unmount command.
  unmount     Flex volume unmount command.
  version     Print version
</code></pre></td></tr></table>
</div>
</div><h4 id="222-csi-plugin-的注册">2.2.2 CSI Plugin 的注册</h4>
<p>见 <a href="../csi-implementation/" rel=""><strong>K8s 实现 - CSI 实现</strong></a></p>
<h2 id="3-pv-controller">3 PV Controller</h2>
<p><strong><code>PV Controller</code></strong> 主要<important>负责 PV 与 PVC 的绑定，并负责了 PV 的创建与销毁</important>。</p>
<p>PV Controller 就是一个 Controller，<strong>监听着 PV 与 PVC 的事件，并对应进行 PV 与 PVC 的协调处理</strong>。</p>
<a class="lightgallery" href="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png" title="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png" data-thumbnail="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png"
            data-srcset="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png 1.5x, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img4.png" width="339" height="350" />
    </a>
<h3 id="31-触发逻辑">3.1 触发逻辑</h3>
<p>所有的 Event 会走最终的 Reconcile 函数：</p>
<ul>
<li>PV Event：走 <code>syncVolume</code> 处理</li>
<li>PVC Event：走 <code>syncClaim()</code> 进行处理</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">updateVolume</span><span class="p">(</span><span class="nx">volume</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 更新 Store
</span><span class="c1"></span>    <span class="nx">new</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">storeVolumeUpdate</span><span class="p">(</span><span class="nx">volume</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">new</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

    <span class="c1">// 执行 sync
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">syncVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// log
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">updateClaim</span><span class="p">(</span><span class="nx">claim</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 更新 Store
</span><span class="c1"></span>	<span class="nx">new</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">storeClaimUpdate</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">new</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
    <span class="c1">// 执行 sync
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">syncClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// log
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="32-reconcile-pv">3.2 Reconcile PV</h3>
<p>Reconcile 主要<strong>负责了 PV 的状态更新，以及 PV 的回收</strong>。而 PV 创建与绑定相关都是由后续的 PVC 的控制循环处理。</p>
<p>大部分的逻辑都是围绕着 PV 与 PVC 是否绑定，以及 PVC 的状态来判断的。其中，通过 <code>PV.Spec.ClaimRef == nil</code> 判断是否绑定 PVC，通过 <code>PV.Spec.ClaimRef.UID</code> 判断具体绑定到哪个 PVC。</p>
<ul>
<li>
<p><strong>ClaimRef == nil</strong></p>
<p>表明 PV 还未绑定 PVC，那么更新 PV Phase 为 <strong>Available</strong>。</p>
</li>
<li>
<p><strong>ClaimRef != nil</strong> &amp;&amp; <strong>ClaimRef.UID == &ldquo;&quot;</strong></p>
<p>表明 PV 是为某个 PVC 预留的，那么更新 PV Phase 为 <strong>Available</strong>，不走尝试绑定 PVC 的逻辑。</p>
</li>
<li>
<p><strong>ClaimRef != nil</strong> &amp;&amp; <strong>ClaimRef.UID != &ldquo;&quot;</strong></p>
<ul>
<li>
<p><strong>PVC Exist</strong></p>
<p>PV 与 PVC 相互绑定，那么更新 PV Phase 为 <strong>Bound</strong>。</p>
</li>
<li>
<p><strong>PVC not Exist</strong></p>
<p>说明 PVC 已经被删除了，那么更新 PV Phase 为 <strong>Released</strong>。根据 PV ReclaimPolicy 决定是否执行删除：</p>
<ul>
<li>Retain - 不执行任何操作</li>
<li>Recycle - 调用 Volume Plugin 回收 Volume，并解除 PV 与 PVC 绑定</li>
<li>Delete - 调用 Volume Plugin 删除 Volume，并删除 PV 对象</li>
</ul>
</li>
<li>
<p><strong>PVC Bind Miss</strong></p>
<p>这种情况是指 PV 绑定了 PVC，但是对应的 PVC 绑定的并不是该 PV。也就是说，PV 与 PVC 绑定不对称。那么会解除 PV 的绑定，允许情况下还会删除 PV。</p>
</li>
</ul>
</li>
</ul>
<p>具体代码见 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/persistentvolume/pv_controller.go" target="_blank" rel="noopener noreffer"><strong>Kubernetes 源码 syncVolume 函数</strong></a>。</p>
<h3 id="33-reconcile-pvc">3.3 Reconcile PVC</h3>
<p>Reconcile PVC <strong>负责 PVC 与 PV 的绑定，以及一些情况下根据 StorageClass 创建 PV</strong>。</p>
<p>控制逻辑分为了两个分支：</p>
<ul>
<li>
<p><important>PVC.Anno[pv.kubernetes.io/bind-completed] Exist</important></p>
<p>表明 PVC 已绑定 PV，这时候主要是检查 PV 与 PVC 的绑定关系是否正常</p>
<ul>
<li>
<p><important>PVC.Spec.VolumeName == &ldquo;&quot;</important></p>
<p>说明绑定关系丢失了，那么更新 PVC Phase 为 <strong>Lost</strong>。</p>
</li>
<li>
<p><important>PVC.Spec.VolumeName != &ldquo;&quot;</important> &amp;&amp; <important>PV not Exist</important></p>
<p>说明绑定的 PV 不存在，那么更新 PVC Phase 为 <strong>Lost</strong>。</p>
</li>
<li>
<p><important>PVC.Spec.VolumeName != &ldquo;&quot;</important> &amp;&amp; <important>PV Exist</important> &amp;&amp; <important>PV.Spec.ClaimRef == nil</important></p>
<p>说明 PV 还未绑定到 PVC，那么执行绑定操作。</p>
</li>
<li>
<p><important>PVC Bind Miss</important></p>
<p>这种情况是指 PVC 绑定了 PV，但是对应的 PV 绑定的并不是该 PVC，也就是说，PV 与 PVC 绑定不对称。那么会更新 PVC Phase 为 Lost。</p>
</li>
</ul>
<p>具体代码见 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/persistentvolume/pv_controller.go" target="_blank" rel="noopener noreffer"><strong>Kubernetes 源码 syncBoundClaim 函数</strong></a>。</p>
</li>
<li>
<p><important>PVC.Anno[pv.kubernetes.io/bind-completed] not Exist</important></p>
<p>表明 PVC 还未绑定 PV。</p>
<ul>
<li>
<p><important>PVC.Spec.VolumeName != &ldquo;&quot;</important></p>
<p>表示创建 PVC 时就选择了特定需要绑定的 PV，那么执行绑定操作。</p>
</li>
<li>
<p><important>PVC.Spec.VolumeName == &ldquo;&quot;</important></p>
<p>表示也不知道绑定哪个 PV，那么就会尝试寻找一个已有的 PV。</p>
<ul>
<li>
<p><important>PV Founded</important></p>
<p>已有 PV 可以满足 PVC，那么执行绑定操作。s</p>
</li>
<li>
<p><important>PV not Founded</important> &amp;&amp; P<important>VC.Spec.StorageClassName != &ldquo;&quot;</important></p>
<p>无法使用已有的 PV，那么调用 Volume Plugin 接口尝试创建一个 PV。</p>
</li>
<li>
<p><important>PV not Founded</important> &amp;&amp; <important>PVC.Spec.StorageClassName == &ldquo;&quot;</important></p>
<p>无法使用已有 PV，也不能自己创建一个，设置 PVC Phase 为 Pending，啥也不做了。</p>
</li>
</ul>
</li>
</ul>
<p>具体代码见 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/persistentvolume/pv_controller.go" target="_blank" rel="noopener noreffer"><strong>Kubernetes 源码 syncUnboundClaim 函数</strong></a>。</p>
</li>
</ul>
<h2 id="4-attachdetach-controller">4 AttachDetach Controller</h2>
<p><a href="#3-pv-controller" rel=""><strong>PV Controller</strong></a> 负责了 PV 与 PVC。当 PVC 绑定并被 Pod 使用后，就会由<important> AttachDetach Controller 负责将其 Attach 到 Node 上</important>。同样，<important>AttachDetach Controller 也负责将 Volume 从 Node 上 Detach</important>。</p>
<p>整体 AttachDetach Controller 还是基于 Controller 模式，不过与正常的 Controller 编写方式不同，AttachDetach Controller 围绕着两个 Map 的数据进行 Reconcile：</p>
<ul>
<li><strong><code>desiredStateOfWorld</code></strong> - 代表着各个 Volume 的期望状态；</li>
<li><strong><code>actualStateOfWorld</code></strong> - 代表着各个 Volume 的实际状态；</li>
</ul>
<a class="lightgallery" href="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png" title="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png" data-thumbnail="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png"
            data-srcset="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png 1.5x, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img5.png" width="932" height="300" />
    </a>
<p>因此，AttachDetach Controller 的核心逻辑可以分为三个部分：</p>
<ul>
<li>根据 PVC 与 Pod 更新 <code>desiredStateOfWorld</code></li>
<li>根据 Node 更新 <code>actualStateOfWorld</code></li>
<li>对比 <code>actualStateOfWorld</code> 与 <code>desiredStateOfWorld</code> 进行 Reconcile</li>
</ul>
<h3 id="41-更新-desiredstateofworld">4.1 更新 desiredStateOfWorld</h3>
<p><code>desiredStateOfWorld</code> <strong>记录 Volume 的期望状态</strong>，即哪些 Volume 需要 Attach 到哪些 Node。</p>
<p>所有的 Volume 的期望状态来自于 Pod 的 Spec 定义，对应的以下情况会更新 <code>desiredStateOfWorld</code>：</p>
<ul>
<li>
<p><strong>Watch PVC 的 Add/Update 事件</strong></p>
<p>对于已经绑定到 PV 的 PVC（<strong>Phase == Bound</strong> &amp;&amp; <strong>Spec.VolumeName != &ldquo;&quot;</strong>），找到对应的 Pod ，调用 <strong><code>ProcessPodVolumes()</code></strong>。</p>
</li>
<li>
<p><strong>Watch Node 的 Add/Update/Delete 事件</strong></p>
<p>对于 Delete 事件，删除对应 Node 的记录。</p>
<p>对于 Add/Update 事件，遍历 Node 上所有的 Pod，调用 <strong><code>ProcessPodVolumes()</code></strong>。</p>
</li>
<li>
<p><strong>Watch Pod 的 Add/Update/Delete 事件，以及周期性遍历所有 Pod</strong></p>
<p>根据 Pod 调用 <strong><code>ProcessPodVolumes()</code></strong>。</p>
</li>
<li>
<p><strong>启动时第一次，以及周期性遍历所有 Pod</strong></p>
<p>根据 Pod 调用 <strong><code>ProcessPodVolumes()</code></strong>。</p>
</li>
</ul>
<p>可以看到，大部分都是调用同一个函数 <code>ProcessPodVolumes()</code> 进行处理。该函数参数很简单，提供 Pod 以及对应的行为 (add/delete) 即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ProcessPodVolumes</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">addVolumes</span> <span class="kt">bool</span><span class="p">,</span>
	<span class="nx">desiredStateOfWorld</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">DesiredStateOfWorld</span><span class="p">,</span> <span class="nx">volumePluginMgr</span> <span class="o">*</span><span class="nx">volume</span><span class="p">.</span><span class="nx">VolumePluginMgr</span><span class="p">,</span>
	<span class="nx">pvcLister</span> <span class="nx">corelisters</span><span class="p">.</span><span class="nx">PersistentVolumeClaimLister</span><span class="p">,</span> <span class="nx">pvLister</span> <span class="nx">corelisters</span><span class="p">.</span><span class="nx">PersistentVolumeLister</span><span class="p">,</span>
	<span class="nx">csiMigratedPluginManager</span> <span class="nx">csimigration</span><span class="p">.</span><span class="nx">PluginManager</span><span class="p">,</span> <span class="nx">csiTranslator</span> <span class="nx">csimigration</span><span class="p">.</span><span class="nx">InTreeToCSITranslator</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ProcessPodVolumes()</code> 函数会遍历 Pod 的 <code>Spec.Volumes</code>，找到对应的 Volume Spec，更新 <code>desiredStateOfWorld</code>。</p>
<p>具体源码见 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/attachdetach/util/util.go" target="_blank" rel="noopener noreffer"><strong>Kubernetes 的 ProcessPodVolumes() 函数</strong></a>。</p>
<h3 id="42-更新-actualstateofworld">4.2 更新 actualStateOfWorld</h3>
<p><code>actualStateOfWorld</code> <strong>记录 Volume 的当前状态</strong>，即 Node 上的 Attached Volume。</p>
<p>状态更新来自于：</p>
<ul>
<li>
<p>执行 Attach/Detach 操作</p>
<p>Reconcile 时执行 Volume Attach/Detach 后，更新 <code>actualStateOfWorld</code>。</p>
</li>
<li>
<p>启动时第一次，以及周期性执行更新</p>
</li>
<li>
<p>监听 Node 的 Add/Update/Delete 事件</p>
</li>
</ul>
<p>大部分处理都会调用函数 <code>processVolumesInUse()</code> 进行处理。该函数参数包括 NodeName 以及 Node.Status.VolumesInUse。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">adc</span> <span class="o">*</span><span class="nx">attachDetachController</span><span class="p">)</span> <span class="nf">processVolumesInUse</span><span class="p">(</span>
	<span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">,</span> <span class="nx">volumesInUse</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">UniqueVolumeName</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>函数逻辑也很简单，遍历 Volume 更新 <code>actualStateOfWorld</code> 中状态。</p>
<p>具体见源码中的 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/attachdetach/util/util.go" target="_blank" rel="noopener noreffer"><strong>processVolumesInUse() 函数</strong></a> 以及 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/attachdetach/reconciler/reconciler.go" target="_blank" rel="noopener noreffer"><strong>sycn() 函数</strong></a>。</p>
<h3 id="43-reconcile">4.3 Reconcile</h3>
<p>核心的 Reconcile 中就是围绕着 <code>actualStateOfWorld</code> 与 <code>desiredStateOfWorld</code> 中的状态，进行实际的操作。</p>
<ul>
<li>
<p><strong>desiredStateOfWorld[Volume] Exist</strong> &amp;&amp; <strong>actualStateOfWorld[Volume] Unattached</strong></p>
<p>表明 Volume 存在于 <code>desiredStateOfWorld</code>，但是 <code>actualStateOfWorld</code> 中对应的状态为 Unattached。</p>
<p>那么就调用 Volume Plugin 执行 Attach Volume 操作。</p>
</li>
<li>
<p><strong>desiredStateOfWorld[Volume] not Exist</strong> &amp;&amp; <strong>actualStateOfWorld[Volume] Attached</strong></p>
<p>表明 Attached Volume 存在于 <code>actualStateOfWorld</code>，但是不存在于 <code>desiredStateOfWorld</code>。</p>
<p>那么就调用 Volume Plugin 执行 Detach Volume 操作。</p>
</li>
</ul>
<p>具体见源码中的 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/attachdetach/reconciler/reconciler.go" target="_blank" rel="noopener noreffer"><strong>reconcile() 函数</strong></a>。</p>
<h2 id="5-kubelet-如何处理-volume">5 Kubelet 如何处理 Volume</h2>
<p>Provision/Delete 与 Attach/Detach 都是在 Kubernetes 控制面处理，Volume 在 Node 上涉及的 Mount/Unmount 与 SetUp/TearDown 就是由 Kubelet 处理了。</p>
<p>Kubelet 中的实现也是依赖于两个 Map 进行 Reconcile：</p>
<ul>
<li><strong><code>desiredStateOfWorld</code></strong> - 代表着各个 Volume 的期望状态；</li>
<li><strong><code>actualStateOfWorld</code></strong> - 代表着各个 Volume 的实际状态；</li>
</ul>
<a class="lightgallery" href="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png" title="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png" data-thumbnail="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png"
            data-srcset="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png 1.5x, /posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/img6.png" width="488" height="200" />
    </a>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">在 Kubelet 实现中，术语 Attach/Detach 对应的是 <a href="../../k8s_learning/volume" rel=""><strong>Kubernetes - 存储设计</strong></a> 中的 Mount/Unmount 操作，术语 Mount/Unmount 对应的是 <a href="../../k8s_learning/volume" rel=""><strong>Kubernetes - 存储设计</strong></a> 中的 SetUp/TearDown 操作。</div>
        </div>
    </div>
<h3 id="51-reconcile">5.1 Reconcile</h3>
<p>Kubelet 中的 Reconcile 就是负责 Volume 的 Mount/Unmount 与 SetUp/TearDown，整体逻辑分为三部分：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">reconcile</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Unmounts are triggered before mounts so that a volume that was
</span><span class="c1"></span>	<span class="c1">// referenced by a pod that was deleted and is now referenced by another
</span><span class="c1"></span>	<span class="c1">// pod is unmounted from the first pod before being mounted to the new
</span><span class="c1"></span>	<span class="c1">// pod.
</span><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">unmountVolumes</span><span class="p">()</span>

	<span class="c1">// Next we mount required volumes. This function could also trigger
</span><span class="c1"></span>	<span class="c1">// attach if kubelet is responsible for attaching volumes.
</span><span class="c1"></span>	<span class="c1">// If underlying PVC was resized while in-use then this function also handles volume
</span><span class="c1"></span>	<span class="c1">// resizing.
</span><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">mountAttachVolumes</span><span class="p">()</span>

	<span class="c1">// Ensure devices that should be detached/unmounted are detached/unmounted.
</span><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">unmountDetachDevices</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="511-unmountvolumes">5.1.1 unmountVolumes</h4>
<p><code>unmountVolumes</code> 函数中执行 TearDown Volume 参数。</p>
<ul>
<li>
<p><strong>desiredStateOfWorld[Volume] Exist</strong> &amp;&amp; <strong>actualStateOfWorld[Volume] Mounted</strong></p>
<p>表明 Mounted Volume 需要被删除，因此调用 Volume Plugin 的 TearDown 操作。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">unmountVolumes</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 遍历当前节点所有的 mounted volume
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">mountedVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAllMountedVolumes</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">// 检查该 volume 与 pod 是否存在于 desiredStateOfWorld
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">PodExistsInVolume</span><span class="p">(</span><span class="nx">mountedVolume</span><span class="p">.</span><span class="nx">PodName</span><span class="p">,</span> <span class="nx">mountedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// 进行 unmount volume 操作（底层调用的是 VolumePlugin.TearDown）
</span><span class="c1"></span>			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">UnmountVolume</span><span class="p">(</span>
				<span class="nx">mountedVolume</span><span class="p">.</span><span class="nx">MountedVolume</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">kubeletPodsDir</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span>
				<span class="p">!</span><span class="nx">nestedpendingoperations</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">!</span><span class="nx">exponentialbackoff</span><span class="p">.</span><span class="nf">IsExponentialBackoff</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="c1">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class="c1"></span>				<span class="c1">// Log all other errors.
</span><span class="c1"></span>				<span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">mountedVolume</span><span class="p">.</span><span class="nf">GenerateErrorDetailed</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;operationExecutor.UnmountVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">controllerAttachDetachEnabled</span><span class="p">),</span> <span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">klog</span><span class="p">.</span><span class="nf">InfoS</span><span class="p">(</span><span class="nx">mountedVolume</span><span class="p">.</span><span class="nf">GenerateMsgDetailed</span><span class="p">(</span><span class="s">&#34;operationExecutor.UnmountVolume started&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="512-mountattachvolumes">5.1.2 mountAttachVolumes</h4>
<p><code>mountAttachVolumes</code> 函数中负责执行 Mount 与 SetUp/MountDevice 操作。</p>
<ul>
<li>
<p><strong>desiredStateOfWorld[Volume] Exist</strong> &amp;&amp; <strong>actualStateOfWorld[Volume] Unattached</strong></p>
<p>表明 Volume 还未被 Mount，那么调用 Volume Plugin 的 Mount 操作。</p>
</li>
<li>
<p><strong>desiredStateOfWorld[Volume] Exist</strong> &amp;&amp; <strong>actualStateOfWorld[Volume] Unmounted</strong></p>
<p>表明 Volume 还未被 Setup，那么调用 Volume Plugin 的 SetUp 操作。</p>
</li>
</ul>
<p>具体见源码中的 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/volumemanager/reconciler/reconciler.go" target="_blank" rel="noopener noreffer"><strong>mountAttachVolumes 函数</strong></a>。</p>
<h4 id="513-unmountdetachdevices">5.1.3 unmountDetachDevices</h4>
<p><code>unmountDetachDevices</code> 函数中负责执行 Unmount Volume 操作解除全局目录挂载。另外，允许情况下还可能执行 Detach Volume 操作。</p>
<ul>
<li>
<p><strong>desiredStateOfWorld[Volume] not Exist</strong> &amp;&amp; <strong>actualStateOfWorld[Volume] Mounted</strong></p>
<p>表明 Volume 还未被 Unmounted，那么调用 Volume Plugin 的 Unmount 操作。</p>
</li>
</ul>
<p>具体见源码中的 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/volumemanager/reconciler/reconciler.go" target="_blank" rel="noopener noreffer"><strong>unmountDetachDevices 函数</strong></a>。</p>
<h2 id="总结">总结</h2>
<p>围绕着 <a href="../../k8s_learning/volume" rel=""><strong>Kubernetes - 存储设计</strong></a> 所提到的 Volume 操作，对应的实现为：</p>
<ul>
<li>Provision / Delete - <a href="#3-pv-controller" rel=""><strong>PV Controller</strong></a></li>
<li>Bind / UnBind - <a href="#3-pv-controller" rel=""><strong>PV Controller</strong></a></li>
<li>Attach / Detach - <a href="#4-attachdetach-controller" rel=""><strong>AttachDetach Controller</strong></a></li>
<li>Mount / Unmount - <a href="#5-kubelet-%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86-volume" rel=""><strong>Kubelet</strong></a></li>
<li>SetUp / TearDown - <a href="#5-kubelet-%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86-volume" rel=""><strong>Kubelet</strong></a></li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://draveness.me/kubernetes-volume/" target="_blank" rel="noopener noreffer"><strong>Blog：详解 Kubernetes Volume 的实现原理</strong></a></li>
<li><a href="http://bingerambo.com/posts/2021/02/kubelet-volume-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener noreffer"><strong>Blog：kubelet volume manager 源码分析</strong></a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-02-09&nbsp;<a class="git-hash" href="https://github.com/KanShiori/KanShiori.github.io/commit/cce6cdaa228e3a058ee0c6c86ffb8bd366b9d734" target="_blank" title="commit by Shiori(yshshihaoren@qq.com) cce6cdaa228e3a058ee0c6c86ffb8bd366b9d734: Post(Operator Desgin Notes) (#36)">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>cce6cda</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-title="K8s 实现 - Volume 实现" data-hashtags="k8s,云计算"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-hashtag="k8s"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-title="K8s 实现 - Volume 实现"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-title="K8s 实现 - Volume 实现"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-title="K8s 实现 - Volume 实现"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-title="K8s 实现 - Volume 实现"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/baidu.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_programming/volume-implementation/" data-title="K8s 实现 - Volume 实现"><i class="fab fa-evernote fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-design/" class="prev" rel="prev" title="Kubernetes - 存储设计"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Kubernetes - 存储设计</a>
            <a href="/posts/cloud/cloud_native/kubernetes/k8s_programming/csi-implementation/" class="next" rel="next" title="K8s 实现 - CSI 实现">K8s 实现 - CSI 实现<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2020 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Shiori</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":35},"comment":{},"lightgallery":true,"search":{"algoliaAppID":"9NJS0VQU0I","algoliaIndex":"blog","algoliaSearchKey":"85d62ea65a7f7445fbfb413bdca088f2","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
