<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Kubernetes - Volume - Shiori&#39;s Blog</title><meta name="Description" content="Volume 相关概念"><meta property="og:title" content="Kubernetes - Volume" />
<meta property="og:description" content="Volume 相关概念" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" /><meta property="og:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-08T07:43:09+00:00" />
<meta property="article:modified_time" content="2023-03-26T14:26:12+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/>

<meta name="twitter:title" content="Kubernetes - Volume"/>
<meta name="twitter:description" content="Volume 相关概念"/>
<meta name="application-name" content="Shiori&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Shiori&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/icons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" /><link rel="prev" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/dns-in-k8s/" /><link rel="next" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/rbac/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubernetes - Volume",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_native\/kubernetes\/k8s_learning\/volume\/"
        },"image": ["https:\/\/KanShiori.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "k8s, 云计算","wordcount":  8136 ,
        "url": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_native\/kubernetes\/k8s_learning\/volume\/","datePublished": "2021-06-08T07:43:09+00:00","dateModified": "2023-03-26T14:26:12+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/KanShiori.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Shiori"
            },"description": "Volume 相关概念"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="http://kanshiori.cn" rel="noopener noreffer" target="_blank"> 主页 </a><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="http://kanshiori.cn" title="" rel="noopener noreffer" target="_blank">主页</a><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kubernetes - Volume</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Shiori</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes-%E5%AD%A6%E4%B9%A0/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Kubernetes 学习</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-06-08">2021-06-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 8136 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 17 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-pv-pvc-storageclass">1 PV PVC StorageClass</a>
      <ul>
        <li><a href="#11-pv">1.1 PV</a>
          <ul>
            <li><a href="#111-phase-与-lifecycle">1.1.1 Phase 与 Lifecycle</a></li>
            <li><a href="#112-reclaim-policy">1.1.2 Reclaim Policy</a></li>
            <li><a href="#113-volume-mode">1.1.3 Volume Mode</a></li>
            <li><a href="#114-access-mode">1.1.4 Access Mode</a></li>
            <li><a href="#115-finalizer">1.1.5 Finalizer</a></li>
          </ul>
        </li>
        <li><a href="#12-pvc">1.2 PVC</a>
          <ul>
            <li><a href="#121-phase">1.2.1 Phase</a></li>
            <li><a href="#122-storageclass">1.2.2 StorageClass</a></li>
            <li><a href="#123-pod-使用-pvc">1.2.3 Pod 使用 PVC</a></li>
            <li><a href="#124-datasource-与-datasourceref">1.2.4 DataSource 与 DataSourceRef</a></li>
          </ul>
        </li>
        <li><a href="#13-storageclass">1.3 StorageClass</a>
          <ul>
            <li><a href="#131-provisioner">1.3.1 Provisioner</a></li>
            <li><a href="#132-volume-binding-mode">1.3.2 Volume Binding Mode</a></li>
            <li><a href="#133-allowed-topologies">1.3.3 Allowed Topologies</a></li>
            <li><a href="#134-parameters">1.3.4 Parameters</a></li>
            <li><a href="#135-default-storageclass">1.3.5 Default StorageClass</a></li>
          </ul>
        </li>
        <li><a href="#14-绑定关系">1.4 绑定关系</a>
          <ul>
            <li><a href="#141-预留-pv-与-pvc">1.4.1 预留 PV 与 PVC</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#2-local-pv">2 Local PV</a>
      <ul>
        <li><a href="#21-手动创建使用-localpv">2.1 手动创建使用 LocalPV</a></li>
        <li><a href="#22-local-pv-static-provisioner">2.2 local pv static provisioner</a>
          <ul>
            <li><a href="#221-原理">2.2.1 原理</a></li>
            <li><a href="#222-示例">2.2.2 示例</a></li>
          </ul>
        </li>
        <li><a href="#23-local-path-provisioner推荐">2.3 local path provisioner（推荐）</a></li>
      </ul>
    </li>
    <li><a href="#3-expand-volume">3 Expand Volume</a>
      <ul>
        <li><a href="#31-前置条件">3.1 前置条件</a></li>
        <li><a href="#32-扩容行为">3.2 扩容行为</a></li>
        <li><a href="#33-原理">3.3 原理</a></li>
        <li><a href="#34-错误处理">3.4 错误处理</a></li>
      </ul>
    </li>
    <li><a href="#4-ephemeral-volume">4 Ephemeral Volume</a>
      <ul>
        <li><a href="#41-generic-ephemeral-volume">4.1 Generic Ephemeral Volume</a>
          <ul>
            <li><a href="#411-lifecycle-与-pvc">4.1.1 Lifecycle 与 PVC</a></li>
            <li><a href="#412-pvc-的命名">4.1.2 PVC 的命名</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#5-volume-snapshot">5 Volume Snapshot</a>
      <ul>
        <li><a href="#51-volumesnapshot">5.1 VolumeSnapshot</a></li>
        <li><a href="#52-volumesnapshotcontent">5.2 VolumeSnapshotContent</a>
          <ul>
            <li><a href="#521-source-volume-mode">5.2.1 Source Volume Mode</a></li>
          </ul>
        </li>
        <li><a href="#53-volumesnapshotclass">5.3 VolumeSnapshotClass</a></li>
        <li><a href="#54-基于-snapshot-创建-pv">5.4 基于 Snapshot 创建 PV</a></li>
      </ul>
    </li>
    <li><a href="#6-clone-volume">6 Clone Volume</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-pv-pvc-storageclass">1 PV PVC StorageClass</h2>
<h3 id="11-pv">1.1 PV</h3>
<p><strong><ruby>PV<rt>Persistent Volume</rt></ruby></strong> 代表一个实际可用的后端存储（也可能不是后端，而是 Local PV）。大多数情况下，PV 是一个网络文件系统，或者分布式存储，或者云厂商的云盘。</p>
<p>PV 的定义仅仅描述了存储的属性：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv0003</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Recycle</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">slow</span><span class="w">
</span><span class="w">  </span><span class="nt">mountOptions</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">hard</span><span class="w">
</span><span class="w">    </span>- <span class="l">nfsvers=4.1</span><span class="w">
</span><span class="w">  </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">172.17.0.2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong><code>capacity</code></strong> - 描述存储的大小</p>
</li>
<li>
<p><code>volumeMode</code> - 存储类型，见 <a href="#113-volume-mode" rel=""><strong>Volume Modes</strong></a></p>
</li>
<li>
<p><code>accessModes</code> - 决定了是否允许多节点复用，并其读写权限，见 <a href="#114-access-mode" rel=""><strong>Access Mode</strong></a></p>
</li>
<li>
<p><strong><code>storageClassName</code></strong> ：指定其所属的 StorageClass。</p>
<p>也可以不指定 StorageClass，那么只有不指定 class 的 PVC 才可以绑定该 PV。</p>
</li>
<li>
<p><code>persistentVolumeReclaimPolicy</code> - PV 回收策略，见 <a href="#112-reclaim-policy" rel=""><strong>Reclaim Policy</strong></a></p>
</li>
<li>
<p><code>mountOptions</code> ：PV 挂载到 Node 时添加的挂载选项</p>
<p>Kubernetes 不会对挂载选项有任何的检查。针对不同类型的 PV，这个选项是不同的，具体见 <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#mount-options" target="_blank" rel="noopener noreffer"><strong>Mount Points</strong></a>。</p>
</li>
<li>
<p><strong><code>nodeAffinity</code></strong> ：设定节点亲和性来限制只有特定的节点可以使用其 PV</p>
<p>在使用 Local PV 时必定要使用 nodeAffinity。</p>
</li>
</ul>
<h4 id="111-phase-与-lifecycle">1.1.1 Phase 与 Lifecycle</h4>
<p>Phase 描述了 PV 所处的状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Available</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>可见的 Phase 有：</p>
<ul>
<li>
<p><strong>Available</strong> - PV 已经创建，没有绑定 PVC。</p>
</li>
<li>
<p><strong>Bound</strong> - PV 已经绑定到了 PVC。可以从 <code>spec.claimRef</code> 看到绑定了的 PVC。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">claimRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tikv-main-cluster-tikv-2</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">    </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1121998&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">12612562</span>-<span class="l">cc49-4f66-a76d-34bce001e1eb</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>Released</strong> - 在 <code>persistentVolumeReclaimPolicy: Retain</code> 模式下，PV 不会随着 PVC 被删除而删除，会处于 Released 状态。</p>
<p>Released 状态会保留 PVC 的绑定信息 <code>spec.claimRef</code>，如果删除 <code>spec.claimRef</code> PV 会重新变为 &ldquo;Available&rdquo;，因此可以被再次使用。</p>
</li>
<li>
<p><strong>Failed</strong> - 在 <code>persistentVolumeReclaimPolicy: Recycle</code> 模式下，清除 PV 数据时失败会变为 Failed 状态。</p>
</li>
</ul>
<p>PV 生命周期包括 5 个阶段：</p>
<ol>
<li><strong>Provisioning</strong> ：即 PV 的创建，可以直接创建 PV（静态方式），也可以使用 StorageClass 动态创建；</li>
<li><strong>Binding</strong> ：将 PV 分配给 PVC；</li>
<li><strong>Using</strong> ：Pod 通过 PVC 使用该 Volume，并可以通过准入控制 <code>StorageObjectInUseProtection</code> 阻止删除正在使用的 PVC；</li>
<li><strong>Releasing</strong> ：Pod 释放 Volume 并删除 PVC；</li>
<li><strong>Reclaiming</strong> ：回收 PV，可以保留 PV 以便下次使用，也可以直接从云存储中删除；</li>
<li><strong>Deleting</strong> ：删除 PV 并从云存储中删除后段存储；</li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">PV 的底层实现见 <a href="../volume/" rel=""><strong>Kubernetes - 存储设计</strong></a>。</div>
        </div>
    </div>
<h4 id="112-reclaim-policy">1.1.2 Reclaim Policy</h4>
<p>Reclaim Policy 指定了当其绑定的 PVC 删除时，该如何处理 PV。目前支持的策略包括：</p>
<ul>
<li>
<p><strong>Retain</strong></p>
<p>当 PVC 删除时，PV 仍然存在（表明实际数据仍然存在），不给过 PV 会变为 Released 状态。因此，目前该 PV 是不能再次被绑定的。</p>
<p><important>如果删除 Released 状态的 PV，对应实际的数据盘（例如 AWS EBS、GCE PD 等）是不会被删除的</important>。这意味着，需要用户去手动删除对应的实际存储。</p>
<p>如果期望重用 Released PV，可以创建 PV 定义 <code>spec.volumeName</code> 对应的 PVC。</p>
</li>
<li>
<p><strong>Delete</strong></p>
<p>当 PVC 删除时，PV 会自动被删除，并且<important>对应实际的数据盘也会被删除</important>。</p>
</li>
<li>
<p><strong>Recycle</strong>（Deprecated）</p>
<p>如果底层的数据盘支持，<code>Recycle</code> 在 PVC 删除时，会清除 PV 上的数据（例如 <code>rm -rf /volume/*</code>），使得该 PV 可以直接被重新复用。</p>
</li>
</ul>
<h4 id="113-volume-mode">1.1.3 Volume Mode</h4>
<p>Volume Mode 表明了存储的类型，目前支持：</p>
<ul>
<li>
<p><strong>Filesystem</strong>（默认）- 存储为文件系统，使用时会通过 Mount 挂载到 Pod 某个目录。如果使用的 Device 没有文件系统，那么 Kubernetes 会按照存储类型相关参数创建文件系统。</p>
</li>
<li>
<p><strong>Block</strong> - 存储为块设备，Pod 中可以直接使用该块设备。Kubernetes 不会为块设备创建文件系统，因此需要 Pod 自行处理块设备。</p>
</li>
</ul>
<h4 id="114-access-mode">1.1.4 Access Mode</h4>
<p>Access Mode 描述了 Pod 访问 Volume 的模式，是否支持多节点同时挂载。目前支持：</p>
<ul>
<li>
<p>ReadWriteOnce - 只允许一个 Node 挂载使用（Pod 可以同时访问），并且支持 Read 与 Write。</p>
</li>
<li>
<p>ReadOnlyMany - 允许多个 Node 同时挂载，但是仅仅支持 Read。</p>
</li>
<li>
<p>ReadWriteMany - 允许多个 Node 同时挂载，并且支持同时 Read 与 Write。</p>
</li>
<li>
<p>ReadWriteOncePod - 只允许一个 Pod 使用，支持 Read 与 Write。</p>
</li>
</ul>
<p>当然，不同的数据盘类型对其 accessMode 支持程度不同，具体见 <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes" target="_blank" rel="noopener noreffer"><strong>AccessMode</strong></a>。</p>
<h4 id="115-finalizer">1.1.5 Finalizer</h4>
<p>所有的绑定了 PVC 的 PV 会添加一个名为 <code>kubernetes.io/pv-protection</code> 的 Finalizer，以防止用户删除正在使用中的 PV。</p>
<p>同样，如果 PVC 被某个 Pod 使用中，也会添加一个名为 <code>kubernetes.io/pvc-protection</code> 的 Finalizer，以防止用户删除使用中的 PVC。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">实际存储的删除在 Finalizer 移除后开始了，不会参考 PV 上其他的 Finalizer。</div>
        </div>
    </div>
<h3 id="12-pvc">1.2 PVC</h3>
<p><strong><ruby>PVC<rt>Persistent Volume Claim</rt></ruby></strong> 描述一个 Pod 对 PV 的需求，是基于 namespace 下的。</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>为什么需要 PV PVC？<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>感觉还是为了解耦，解耦使得 Pod 与存储形成了多对多的关系。</p>
<p>最直观的好处，一个 PV 可以通过多个 PVC 进行绑定，使得数据可以被多个 Pod 共享使用。也可以预定义多个 PV，而通过 PVC 可以直接由调度去选择合适的 PV 进行绑定。</p>
</div>
        </div>
    </div>
<p>PVC 定义中主要是描述了对 PV 的需求，也就是<strong>告诉调度如何选择一个合适的 PV</strong>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myclaim</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l">foo-pv</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">8Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">slow </span><span class="w"> </span><span class="c"># 指定绑定的 StorageClass</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;stable&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- {<span class="nt">key: environment, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">dev]}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>volumeMode</code> - 存储类型，见 <a href="#113-volume-mode" rel=""><strong>Volume Modes</strong></a></p>
</li>
<li>
<p><code>accessModes</code> - 决定了是否允许多节点复用，并其读写权限，见 <a href="#114-access-mode" rel=""><strong>Access Mode</strong></a></p>
</li>
<li>
<p><code>volumeName</code> ：指定绑定的 PV name，或者 Bind 后也会填充为对应的 PV name</p>
</li>
<li>
<p><code>resources</code> ：Pod 所需求的资源</p>
</li>
<li>
<p><code>selector</code>：进一步来过滤选择的 PV，只有满足匹配条件的 PV 才可以被绑定</p>
</li>
<li>
<p><code>storageClassName</code> ：指定所属的 StorageClass，见 <a href="#13-storageclass" rel=""><strong>StorageClass</strong></a></p>
</li>
</ul>
<h4 id="121-phase">1.2.1 Phase</h4>
<p>PVC <code>status.phase</code> 表明 PVC 所处于的阶段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Bound</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>Pending</strong> - PVC 还没有绑定到 PV，这时 <code>spec.volumeName</code> 为空。</p>
</li>
<li>
<p><strong>Bound</strong> - PVC 已经绑定了 PV，这是 <code>spec.volumeName</code> 为对应 PV。</p>
</li>
<li>
<p><strong>Lost</strong> - 与 PV 的绑定关系丢失。包括几种情况：</p>
<ul>
<li>PVC 之前是 Bound 状态，但是 <code>spec.volumeName</code> 为空；</li>
<li><code>spec.volumeName</code> 对应的 PV 不存在了；</li>
<li><code>spec.volumeName</code> 对应的 PV 存在，但是 PV 并没有绑定该 PVC，也就是说，PV 与 PVC 之间绑定关系不是对应的；</li>
</ul>
</li>
</ul>
<h4 id="122-storageclass">1.2.2 StorageClass</h4>
<p>PVC <code>spec.storageClassName</code> 用于指定创建 PV 使用的 StorageClass。只有相同 StorageClass 的 PV 与 PVC 才可以完成绑定。</p>
<p>需要注意的是，不设置 <code>storageClassName</code> 与 <code>storageClassName: &quot;&quot;</code> 是两种情况：</p>
<ul>
<li>
<p><code>storageClassName: &quot;&quot;</code> - 可以认为 &quot;&quot; 就是一种 StorageClass，只有都是 &quot;&quot; 的 PV 与 PVC 才可以完成绑定</p>
</li>
<li>
<p>不设置 <code>storageClassName</code> - 具体行为取决于集群是否有着 <a href="#135-default-storageclass" rel=""><strong>Default StorageClass</strong></a>。如果存在，那么 <code>storageClassName</code> 就会默认配置为 Default StorageClass。</p>
</li>
</ul>
<p>如果不存在 Default StorageClass，那么不设置 <code>storageClassName</code> 等同于 <code>storageClassName: &quot;&quot;</code>。</p>
<h4 id="123-pod-使用-pvc">1.2.3 Pod 使用 PVC</h4>
<p>在 Pod 定义或者 Pod Template 中，使用 pvc 类型 <code>volume</code> 来指定使用的 PVC。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mypod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myfrontend</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">         </span><span class="c"># 添加 volume 挂载</span><span class="w">
</span><span class="w">      </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/var/www/html&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mypd</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mypd           </span><span class="w"> </span><span class="c"># volume 类型为 PVC</span><span class="w">
</span><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">myclaim </span><span class="w"> </span><span class="c"># 指定使用的 PVC</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="124-datasource-与-datasourceref">1.2.4 DataSource 与 DataSourceRef</h4>
<p>PVC 提供了 <code>dataSource</code> 字段来实现 <a href="#5-volume-snapshot" rel=""><strong>Volume Snapshot</strong></a> 与 <a href="#6-clone-volume" rel=""><strong>Volume Clone</strong></a>。</p>
<p>PVC 还提供了 <code>dataSourceRef</code> 字段，该字段大致含义与 <code>dataSource</code> 几乎相同，大部分情况下该字段都是相同的内容。</p>
<p>不过，<code>dataSourceRef</code> 提供了更高级的功能，包括：</p>
<ul>
<li><code>dataSourceRef</code> 可以包含不同任意类型的对象，而 <code>dataSource</code> 只支持 PVC 与 VolumeSnapshot。</li>
<li><code>dataSourceRef</code> 能给支持跨 Namespace 的 PVC 或 VolumeSnapshot，<code>dataSource</code> 只能支持同 Namespace 操作。</li>
</ul>
<h3 id="13-storageclass">1.3 StorageClass</h3>
<p>PV 的创建方法有两种：</p>
<ul>
<li>
<p><strong><ruby>静态创建<rt>Static Provision</rt></ruby></strong>，由管理员手动创建所有支持的 PV；</p>
</li>
<li>
<p><strong><ruby>动态创建<rt>Dynamic Provision</rt></ruby></strong>，定义 StorageClass，按 PVC 来创建合适的 PV；</p>
</li>
</ul>
<p>所以明确，<strong><code>StorageClass</code></strong> 是<strong>根据 PVC，来创建/回收 PV 的</strong>。</p>
<p>而<strong>创建与回收的 Driver</strong> 就称为 <strong><code>Provisioner</code></strong>，不同类型的 PV 的创建与回收方式都是不同的，所以有着许多的 Provisioner 实现。</p>
<p>StorageClass 中大多数属性是其创建出 <strong>PV 的模板</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">standard</span><span class="w">
</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/aws-ebs </span><span class="w"> </span><span class="c"># 指定 Provisioner</span><span class="w">
</span><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">gp2</span><span class="w">
</span><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span><span class="w"></span><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">mountOptions</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">debug</span><span class="w">
</span><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">Immediate</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>provisioner</code> - 指定创建 PV 的插件，见 <a href="#131-provisioner" rel=""><strong>Provisioner</strong></a></p>
</li>
<li>
<p><code>reclaimPolicy</code> - 指定创建的 PV 的回收策略，默认为 Delete</p>
</li>
<li>
<p><code>allowVolumeExpansion</code> - 是否允许通过修改 PVC 对象的属性，来对使用的 PV 进行扩容。</p>
<p>大多数云存储都支持该选项，具体见 <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#allow-volume-expansion" target="_blank" rel="noopener noreffer"><strong>allow-volume-expansion</strong></a>。</p>
</li>
<li>
<p><code>mountOptions</code> - 指定其创建的 PV 的 Mount Options</p>
</li>
<li>
<p><code>volumeBindingMode</code> - PV 与 PVC 的绑定操作的时机，见 <a href="#132-volume-binding-mode" rel=""><strong>Volume Binding Mode</strong></a></p>
</li>
<li>
<p><code>allowedTopologies</code> - 指定允许创建 PV 的区域，见 <a href="#133-allowed-topologies" rel=""><strong>Allowed Topologies</strong></a></p>
</li>
<li>
<p><code>parameters</code> - 存储参数，见 <a href="#134-parameters" rel=""><strong>Parameters</strong></a></p>
</li>
</ul>
<h4 id="131-provisioner">1.3.1 Provisioner</h4>
<p>StorageClass 代表了是创建 PV 的模板，为了支持多样的实际的数据盘类型，StorageClass 通过指定 Provisioner 来表明由哪个存储插件来创建 PV。</p>
<p><strong>Provisioner 只是一个标识，本质上由各个存储的管理程序（本质上就是 Controller）通过 <code>spec.provisioner</code> 来筛选 PV，进而去创建 PV</strong>。</p>
<p>Kubernetes 原生支持的 Provisioner 以 <code>kubernetes.io/xxx</code> 的规范命名。当然，Provisioner 也可以以 Pod 方式运行，只要能够识别 <code>spec.provisioner</code> 即可。</p>
<p>所有 Kubernetes 内置支持的 Provisioner 见 <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner" target="_blank" rel="noopener noreffer"><strong>provisioner</strong></a>。</p>
<h4 id="132-volume-binding-mode">1.3.2 Volume Binding Mode</h4>
<p>Volume Binding Mode 决定了 PV 与 PVC 的绑定操作应该发生在什么时候。</p>
<ul>
<li>
<p><strong>Immediate</strong>（默认）</p>
<p>Immediate 表示创建了 PVC 后，就去完成 PV 与 PVC 的绑定。<strong>这也意味着，PV 与 PVC 的绑定是不会考虑 Pod 的调度要求的</strong>。</p>
</li>
<li>
<p><strong>WaitForFirstConsumer</strong></p>
<p>WaitForFirstConsumer 表明：等待使用该 PVC 的 Pod 被创建被调度后，才会去完成 PV 与 PVC 的绑定的。<strong>因此，PVC 的绑定会考虑到 Pod 的调度要求</strong>。</p>
<p>在一些场景，WaitForFirstConsumer 就是必须的了，例如：</p>
<ul>
<li>在云厂商场景下，PV 往往是 AZ 级别的，所以要等到 Pod 调度后，去对应的 AZ 创建 PV。</li>
<li>在 Local PV 场景下，PV 是每个 Node 单独的，因此需要等到 Pod 调度后，才绑定 Local PV。</li>
</ul>
</li>
</ul>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">使用 WaitForFirstConsumer 时，不能使用 Pod <code>spec.nodeName</code> 来选择 Node。因为这种情况 Pod 不会经过 Scheduler 来调度，因此无法完成 PVC 的绑定。</div>
        </div>
    </div>
<h4 id="133-allowed-topologies">1.3.3 Allowed Topologies</h4>
<p>对于大部分云厂商，云盘是 AZ 级别的服务，无法跨 AZ 使用。Allowed Topologies 可以提供给 Provisioner，指定允许哪些区域创建。</p>
<p>例如，下面示例表明在 AZ <code>us-central-1a</code> 与 <code>us-central-1b</code> 下创建 PV。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">standard</span><span class="w">
</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/gce-pd</span><span class="w">
</span><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pd-standard</span><span class="w">
</span><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">WaitForFirstConsumer</span><span class="w">
</span><span class="w"></span><span class="nt">allowedTopologies</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">matchLabelExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">failure-domain.beta.kubernetes.io/zone</span><span class="w">
</span><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">us-central-1a</span><span class="w">
</span><span class="w">    </span>- <span class="l">us-central-1b</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当然，不同的 Provisioner 支持的 Label Key 不同，使用时需要参考对应的文档。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">当使用了 <code>volumeBindingMode: WaitForFirstConsumer</code> 时，PV 会等待 Pod 调度后才会创建。此时 Pod 所属 Node 已经确定（AZ 已经确定），因此 PV 所属 AZ 也是确定的，所以不需要使用 Allowed Topologies 限定 PV 区域。</div>
        </div>
    </div>
<h4 id="134-parameters">1.3.4 Parameters</h4>
<p>Parameters 为特定存储类型的参数，是专门提供给 Provisioner 使用的。例如 AWS EBS 支持的参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">slow</span><span class="w">
</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/aws-ebs</span><span class="w">
</span><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">io1</span><span class="w">
</span><span class="w">  </span><span class="nt">iopsPerGB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Kubernetes 内置的 Provisioner 支持的参数见 <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters" target="_blank" rel="noopener noreffer"><strong>parameters</strong></a>。</p>
<p>一个 StorageClass 最多可以定义 512 个参数。这些参数对象的总长度不能 超过 256 KiB, 包括参数的键和值。</p>
<h4 id="135-default-storageclass">1.3.5 Default StorageClass</h4>
<p>Default StorageClass 是没有设置 <code>storageClassName</code> 的 PVC 使用的 StorageClass。通过添加一个 Anno <code>storageclass.kubernetes.io/is-default-class</code> 来设置 Default StorageClass：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">storageclass.kubernetes.io/is-default-class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gp2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="14-绑定关系">1.4 绑定关系</h3>
<p>PV PVC StorageClass 三者的关系如下图：</p>
<a class="lightgallery" href="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png" title="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png" data-thumbnail="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png"
            data-srcset="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png, /posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png 1.5x, /posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/img1.png" width="568" height="250" />
    </a>
<p>PVC 绑定 PV 基于 <code>spec.volumeName</code> 字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-f278fa2e-63d6-4086-af29-a4b7b91ec031</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>PV 绑定 PVC 基于 <code>spec.claimRef</code> 字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">claimRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grafana-storage</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring</span><span class="w">
</span><span class="w">    </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;59917623&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">f278fa2e-63d6-4086-af29-a4b7b91ec031</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>本质上，PV 与 PVC 的绑定都是基于 Controller 来维护的。大致流程如下：</p>
<ol>
<li>PVC Controller 通过 <code>pvc.spec.volumeName</code> 字段，判断出 PVC 需要选择一个 PV 绑定。</li>
<li>PVC Controller 查找所有 Available PV，选择出满足条件的 PV 进行绑定。</li>
<li>如果没有满足的 PV，那么会基于 <code>pvc.spec.storageClassName</code> 指定的 StorageClass，创建一个 PV。</li>
</ol>
<h4 id="141-预留-pv-与-pvc">1.4.1 预留 PV 与 PVC</h4>
<p>基于上面的绑定关系字段，我们可以一开始再创建 PVC 或者 PV 时，就设置好对应的字段，那么 Controller 就不会去绑定对应的 PV 或 PVC。</p>
<p>因此，这样可以实现固定关系一多一的 PV 与 PVC。</p>
<h2 id="2-local-pv">2 Local PV</h2>
<h3 id="21-手动创建使用-localpv">2.1 手动创建使用 LocalPV</h3>
<p>在自己测试环境下，往往没有一个云存储可以作为 PV 使用，而使用 Local PV，使得 Pod 使用的 PV 来自于本地的目录或者块设备。</p>
<p>先明确 Local PV 如何定义，即 <strong>PV 类型为 <code>hostPath</code></strong>，表明实际存储设备来自于宿主机的一个目录。</p>
<p>同时，只有调度到该节点的 Pod 才能使用这个 PV，所以要<strong>设定 PV 的 <code>spec.nodeAffinity</code></strong>，仅仅允许该节点使用该 PV：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-pv</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage </span><span class="w"> </span><span class="c"># 指定 storageClassName</span><span class="w">
</span><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">  </span><span class="c"># local 类型表明使用 Local PV</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/disks/vol1</span><span class="w">
</span><span class="w">  </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">  </span><span class="c"># 设定节点亲和性，使得只能本地节点使用 PV</span><span class="w">
</span><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">          </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">node-1 </span><span class="w"> </span><span class="c"># 仅仅允许 node-1 使用该 PV</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>而为了让 PVC 与 PV 绑定推迟到 Pod 创建后才决定绑定的 PV，我们需要一个 <strong>StorageClass</strong>，即使其并不能够支持动态创建 PV：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage</span><span class="w">
</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/no-provisioner </span><span class="w"> </span><span class="c"># no-provisioner 不支持动态创建 PV</span><span class="w">
</span><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">WaitForFirstConsumer </span><span class="w"> </span><span class="c"># 让 PVC 绑定推迟</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>而在使用时候，我们只需要一个普通的 PVC，指定好 <code>spec.storageClassName</code> 后，就可以使用 LocalPV 了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-local-claim</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage </span><span class="w"> </span><span class="c"># 指定 StorageClass，来绑定 PV</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="22-local-pv-static-provisioner">2.2 local pv static provisioner</h3>
<p><a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner" target="_blank" rel="noopener noreffer"><strong>local pv static provisioner</strong></a> 将上面的步骤进行了简化，其启动了一个 DaemonSet，<strong>根据配置好的目录，自动生成对应目录的 Local PV</strong>。</p>
<p>所以带来的好处就是，我们不需要为一个个节点去创建对应的 PV 了，有 Pod 自动负责该事。</p>
<h4 id="221-原理">2.2.1 原理</h4>
<p>local pv static provisioner 为创建一个 DamonSet，在每个节点创建 Daemon Pod。</p>
<p>每个节点上的 Daemon Pod 会根据其 ConfigMap 配置好的 <strong><code>discovery dir</code></strong>，在目下查找可以作为 PV 的子目录。</p>
<p>在 discovery dir 下挑选目录有两个条件：</p>
<ul>
<li>
<p><strong>目录必须是一个挂载点</strong>，也就是 mountinfo 中可以看到的；</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>为什么必须是挂载点？<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">我猜测这是为了通过挂载点得到目录容量大小，从而填充 PV 容量相关属性。</div>
        </div>
    </div>
</li>
<li>
<p><strong>满足其 ConfigMap 中指定的目录匹配方式 namePattern</strong>。</p>
</li>
</ul>
<h4 id="222-示例">2.2.2 示例</h4>
<p>而为了使用 LocalPV，我们也需要定义一个 StorageClass，让创建出的 LocalPV 能够属于正确的 StorageClass。</p>
<p>所以使用的步骤为：</p>
<ol>
<li>每个节点上<strong>准备作为 LocalPV 的目录</strong>，该目录必须是一个挂载点，且位于 discovery dir 下；</li>
<li><strong>创建 StorageClass</strong>，作为后续创建出的 Local PV 的 StorageClass；</li>
<li><strong>定义并创建 ConfigMap</strong>，为了将相关的信息传递给 provisioner 的 DaemonSet Pod；</li>
<li><strong>定义并创建 ServiceAccount</strong>，因为后续的 Daemon Pod 需要创建 Local PV 结构，所以需要相关的权限；</li>
<li><strong>定义并创建 DaemonSet</strong>，根据 config map 信息，其 Pod 里程序会自动创建 Local PV，其定义就与上述的 PV 一致；</li>
</ol>
<p>看一下其 StorageClass、ConfigMap 和 DaemonSet 定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fast-disks </span><span class="w"> </span><span class="c"># name 要与下面 ConfigMap 相同</span><span class="w">
</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/no-provisioner</span><span class="w">
</span><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">WaitForFirstConsumer</span><span class="w">
</span><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete </span><span class="w"> </span><span class="c"># 支持 Delete Retain</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-provisioner-config </span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default </span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassMap</span><span class="p">:</span><span class="w"> </span><span class="l">|     </span><span class="w">
</span><span class="w">    </span><span class="nt">fast-disks</span><span class="p">:</span><span class="w">  </span><span class="c"># 上面创建的 StorageClass 名字</span><span class="w">
</span><span class="w">       </span><span class="nt">hostDir</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/fast-disks </span><span class="w"> </span><span class="c"># 宿主机 discovery dir</span><span class="w">
</span><span class="w">       </span><span class="nt">mountDir</span><span class="p">:</span><span class="w">  </span><span class="l">/mnt/fast-disks  </span><span class="w"> </span><span class="c"># Daemon Pod 中查找的 discover dir</span><span class="w">
</span><span class="w">       </span><span class="nt">blockCleanerCommand</span><span class="p">:</span><span class="w">
</span><span class="w">         </span>- <span class="s2">&#34;/scripts/shred.sh&#34;</span><span class="w">
</span><span class="w">         </span>- <span class="s2">&#34;2&#34;</span><span class="w">
</span><span class="w">       </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">       </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span><span class="w">       </span><span class="nt">namePattern</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">  </span><span class="c"># 查找子目录的匹配方式</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-volume-provisioner</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">local-volume-provisioner</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">local-volume-provisioner </span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">local-volume-provisioner</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">local-storage-admin</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;k8s.gcr.io/sig-storage/local-volume-provisioner:v2.4.0&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Always&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">provisioner </span><span class="w">
</span><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MY_NODE_NAME</span><span class="w">
</span><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">spec.nodeName</span><span class="w">
</span><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/provisioner/config </span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">provisioner-config</span><span class="w">
</span><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">             
</span><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w">  </span><span class="l">/mnt/fast-disks </span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fast-disks</span><span class="w">
</span><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;HostToContainer&#34;</span><span class="w"> 
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">provisioner-config </span><span class="w"> </span><span class="c"># 能够访问到 ConfigMap</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-provisioner-config      </span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fast-disks </span><span class="w"> </span><span class="c"># 能够查看到 discovery dir</span><span class="w">
</span><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/fast-disks </span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>等到自动创建出 Local PV 后，后续的流程其实就是使用一个 Local PV 的流程了。</p>
<h3 id="23-local-path-provisioner推荐">2.3 local path provisioner（推荐）</h3>
<p>上面的 local pv static provisioner 需要自行挂载一个磁盘或者目录，在测试环境中这显得比较繁琐。</p>
<p>在测试环境中推荐使用 <a href="https://github.com/rancher/local-path-provisioner" target="_blank" rel="noopener noreffer"><strong>local path provisioner</strong></a>，其会在指定的目录自动为 PV 创建目录，PV 清理时自动删除目录，不需要为每个 PV 进行一次挂载。</p>
<h2 id="3-expand-volume">3 Expand Volume</h2>
<h3 id="31-前置条件">3.1 前置条件</h3>
<p>不同的存储类型对于扩容的支持不同，目前支持的存储有：</p>
<ul>
<li>大部分云厂商磁盘</li>
<li>CSI</li>
</ul>
<p>因为 CSI 是一个存储框架，需要 CSI Driver 支持 <code>Expand Volume</code> 相关的接口。因此，需要参考具体 CSI 插件的文档以确定是否支持扩容。</p>
<p>并且，只有当 StorageClass 中设置 <code>allowVolumeExpansion: true</code> 时，表明才允许扩容 PVC。</p>
<p>对于 Filesystem 类型的 PVC，还有一些额外的条件：</p>
<ul>
<li>文件系统必须是 XFS、Ext3、Ext4；</li>
<li>Access Mode 必须是 <strong>ReadWrite</strong>；</li>
</ul>
<h3 id="32-扩容行为">3.2 扩容行为</h3>
<p>目前，扩容可以分为两种情况：</p>
<ul>
<li>
<p><strong>Pod 启动时扩容</strong></p>
<p>对于块设备，扩容行为是动态的，但是对于文件系统的扩容仅仅在 Pod 启动期间完成。也就是说，当改变 PVC 的大小后，需要重启 Pod 才会在 Pod 中生效。</p>
</li>
<li>
<p><strong>Pod 运行中扩容</strong></p>
<p>对于文件存储，是天然支持动态扩容的，因此 Pod 运行中可以感知到扩容，不需要重启 Pod。</p>
<p>目前，Kubernetes 还支持 <code>ExpandInUsePersistentVolumes</code> 特性（目前还是 beta 状态），支持部分块设备在 Pod 运行中扩容。包括：GCE-PD, AWS-EBS, Cinder, and Ceph RBD。</p>
<p>该特性默认是不打开的，需要设置 kubelet 的启动参数 <code>--feature-gates ExpandInUsePersistentVolumes=true</code>，不过部分云厂商的集群默认是打开的，需要参考对应的文档。</p>
</li>
</ul>
<p>从 PVC 的 <code>status.condition</code> 中可以看到扩容相关的状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">lastProbeTime</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2019-04-14T03:51:36Z</span><span class="w">
</span><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Waiting for user to (re-)start a pod to finish file system resize of</span><span class="w">
</span><span class="w">      </span><span class="l">volume on node.</span><span class="w">
</span><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">FileSystemResizePending</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>condition 可能的类型包括：</p>
<ul>
<li><strong>Resizing</strong> - 扩容操作正常进行中；</li>
<li><strong>FileSystemResizePending</strong> - 底层块设备扩容已经完成，文件系统扩容需要等待 Pod 重启；</li>
</ul>
<h3 id="33-原理">3.3 原理</h3>
<p>从控制面来看，扩容操作的触发就是基于 PVC 与 PV 的大小是否相等。如果不相等，那么 Controller 就会开始执行扩容操作。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">如果手动修改 PV 的大小与 PVC 相等，那么实际上就会跳过扩容。</div>
        </div>
    </div>
<p>扩容操作本质上可以分为两个阶段：</p>
<ol>
<li>
<p><strong>扩容底层块设备</strong></p>
<p>因为本质上还是扩容底层块设备，因此会受到不同云盘的限制，先要参考对应的文档。</p>
<p>例如，AWS EBS 扩容间隔为 6h。</p>
</li>
<li>
<p><strong>扩容文件系统</strong></p>
<p>部分文件系统是支持挂载时扩容的，例如 <code>xfs_growfs</code> 扩容 XFS 或者 <code>resize2fs</code> 扩容 Ext4 文件系统。</p>
</li>
</ol>
<h3 id="34-错误处理">3.4 错误处理</h3>
<p>当 PVC 扩容失败时，Kubernetes 会不断的重试扩容操作，直到成功。这时候，需要手动采取一些操作才能恢复。</p>
<ul>
<li>
<p>重建 PVC</p>
<p>通过删除 PVC 与创建新的 PVC 来放弃扩容。大致流程如下：</p>
<ol>
<li>修改 PV 为 <code>Retain</code> 策略，防止数据丢失。</li>
<li>删除 PVC 对象，并且将 PV 的 <code>spec.claimRef</code> 设置为控制，设置 PV 可以被重新绑定。</li>
<li>重新创建 PVC，改变 PVC 大小。通过 PVC 的 <code>spec.volumeName</code> 来复用 PV。</li>
</ol>
</li>
<li>
<p>降低 PVC 扩容的大小（v1.23）[alpha]</p>
<p>在开启 <code>ExpandPersistentVolumes</code> 与 <code>RecoverVolumeExpansionFailure</code> 特性情况下，可以多次修改 PVC 的大小。并且，通过 PVC 的 <code>status.resizeStatus</code> 字段可以观察扩容的状态。</p>
<p>但是，新的大小仍然高于 <code>status.capacity</code>，也就是说，不允许进行缩容。</p>
</li>
</ul>
<h2 id="4-ephemeral-volume">4 Ephemeral Volume</h2>
<p>一些应用可能需要临时的存储作为缓存，不关心重启后是否可用。一般情况下会使用 <code>EmptyDir</code> 来作为临时的存储使用，但是 <code>EmptyDir</code> 使用的是 Node 上的存储，会占用 Node 的存储空间，并且性能完全由 Node 上的存储决定。</p>
<p>为此，Kubernetes 提供了 Ephemeral Volume 的功能。Ephemeral Volume 的生命周期完全遵从于 Pod 的生命周期，随着 Pod 一起创建与删除。</p>
<p>目前支持的 Ephemeral Volume 有：</p>
<ul>
<li><code>EmptyDir</code> - EmptyDir 可以看做为一种 Ephemeral Volume，使用的是 Node 存储或者内存</li>
<li><code>ConfigMap</code> <code>DownwardAPI</code> <code>Sercret</code> - 不同类型的 Kubernetes 数据注入到 Pod 中</li>
<li>CSI Ephemeral Volume - 由 CSI Driver 支持的 Ephemeral Volume</li>
<li>Generic Ephemeral Volume - 由 Kubernetes 基于 PV 使用的 Ephemeral Volume</li>
</ul>
<h3 id="41-generic-ephemeral-volume">4.1 Generic Ephemeral Volume</h3>
<p>Generic Ephemeral Volume 类似于 <code>EmptyDir</code>，但是是由 PV 实现的。因此，Generic Ephemeral Volume 能够实现一些额外的功能：</p>
<ul>
<li>Volume 可以是 Local PV 或者 Cloud PV</li>
<li>Volume 有着限制的大小，不会像 <code>EmptyDir</code> 能够超限使用</li>
<li>Volume 支持 MountOption 配置</li>
<li>支持 Volume 相关操作，例如 Snapshot、Expand 等</li>
</ul>
<p>一个典型的例子如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-frontend</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.28</span><span class="w">
</span><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/scratch&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scratch-volume</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;sleep&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1000000&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scratch-volume</span><span class="w">
</span><span class="w">      </span><span class="nt">ephemeral</span><span class="p">:</span><span class="w">             </span><span class="c"># 指定 ephemeral volume</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeClaimTemplate</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">my-frontend-volume</span><span class="w">
</span><span class="w">          </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;ReadWriteOnce&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">            </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;scratch-storage-class&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="411-lifecycle-与-pvc">4.1.1 Lifecycle 与 PVC</h4>
<p>当 Pod 创建后，Kubernetes 会创建 Ephemeral Volume 对应的 PVC，从而走对应的 PV 创建与绑定操作。</p>
<p>当 Pod 被删除时，Kubernetes 会删除对应的 PVC，而 PV 的保留策略仍然是由 <a href="#112-reclaim-policy" rel=""><strong>Reclaim Policy</strong></a> 决定。</p>
<p>因为有着对应的 PVC，所以 PVC 相关的 Snapshot、Expand 等功能都是可以使用的。</p>
<h4 id="412-pvc-的命名">4.1.2 PVC 的命名</h4>
<p>Kubernetes 为 Ephemeral Volume 创建的 PVC 命名为：<code>${pod-name}-${volume-name}</code>。因为命名规则是固定的，所以要小心不同 Pod 创建的 PVC 可能冲突。</p>
<h2 id="5-volume-snapshot">5 Volume Snapshot</h2>
<p>Volume Snapshot 利用云厂商的功能，通过 CR 来对存储进行快照备份。目前，Volume Snapshot 仅部分 CSI Driver 支持。</p>
<p>Volume Snapshot 涉及到以下 CRD：</p>
<ul>
<li>
<p><strong>VolumeSnapshotContent</strong> - 实际创建出的 Volume Snapshot（概念类似与 PV）</p>
</li>
<li>
<p><strong>VolumeSnapshot</strong> - 执行 Volume Snapshot 的请求（概念类似于 PVC）</p>
</li>
<li>
<p><strong>VolumeSnapshotClass</strong> - 指定 VolumeSnapshot 的不同属性（概念类似于 StorageClass）</p>
</li>
</ul>
<p>Kubernetes 提供了 <code>csi-snapshotter</code> 的 Sidecar Container 和 CSI Driver 共同部署。<code>csi-snapshotter</code> 负责 Watch 和管理集群中的 VolumeSnapshot 和 VolumeSnapshotContent 资源，涉及实际操作时调用 CSI Driver 的 <code>CreateSnapshot</code> 和 <code>DeleteSnapshot</code> 接口。</p>
<h3 id="51-volumesnapshot">5.1 VolumeSnapshot</h3>
<p>VolumeSnapshot 中定义了对某个 PVC 执行 Volume Snapshot 的请求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshot</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-test</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeSnapshotClassName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-hostpath-snapclass</span><span class="w">
</span><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">persistentVolumeClaimName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-test</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>volumeSnapshotClassName</code> 定义了使用的 VolumeSnapshotClass，那么执行快照时会使用对应的属性。如果没指定，会使用默认 Class。</p>
<p>Snapshot 操作执行后，将对应的 VolumeSnapshotContent 设置在定义中。当然，你也可以直接绑定一个已经存在的 VolumeSnapshotContent。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshot</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-snapshot</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">volumeSnapshotContentName</span><span class="p">:</span><span class="w"> </span><span class="l">test-content</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="52-volumesnapshotcontent">5.2 VolumeSnapshotContent</h3>
<p>VolumeSnapshotContent 代表一个具体的快照资源。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshotContent</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">snapcontent-72d9a349-aacd-42d2-a240-d775650d2455</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">deletionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span><span class="w">  </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath.csi.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">volumeHandle</span><span class="p">:</span><span class="w"> </span><span class="l">ee0cfb94-f8d4-11e9-b2d8-0242ac110002</span><span class="w">
</span><span class="w">  </span><span class="nt">sourceVolumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeSnapshotClassName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-hostpath-snapclass</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeSnapshotRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-test</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">72d9a349-aacd-42d2-a240-d775650d2455</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>volumeHandle</code> 指定了执行 Snapshot 的 Volume ID，而不是对应的 Snapshot ID。</p>
<p>创建快照后，对应的 Snapshot ID 记录在 <code>snapshotHandle</code> 上。当然，也可以通过该字段将已有的 Snapshot 绑定到 VolumeSnapshotContent。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshotContent</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-content-test</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">deletionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span><span class="w">  </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath.csi.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">snapshotHandle</span><span class="p">:</span><span class="w"> </span><span class="l">7bdd0de3-aaeb-11e8-9aae-0242ac110002 </span><span class="w"> </span><span class="c"># snapshot id</span><span class="w">
</span><span class="w">  </span><span class="nt">sourceVolumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeSnapshotRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-test</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="521-source-volume-mode">5.2.1 Source Volume Mode</h4>
<p><code>sourceVolumeMode</code> 字段表明执行 Snapshot 的 Volume 的模式，包括：Filesystem 或 Block。</p>
<p>如果你希望使用 Snapshot 创建 PVC 时，支持转换 Volume Mode，那么需要添加一个 Annotation：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshotContent</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-content-test</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">snapshot.storage.kubernetes.io/allow-volume-mode-change</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># 表明改变 Mode</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">deletionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span><span class="w">  </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath.csi.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">snapshotHandle</span><span class="p">:</span><span class="w"> </span><span class="l">7bdd0de3-aaeb-11e8-9aae-0242ac110002</span><span class="w">
</span><span class="w">  </span><span class="nt">sourceVolumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeSnapshotRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-test</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="53-volumesnapshotclass">5.3 VolumeSnapshotClass</h3>
<p>VolumeSnapshotClass 提供了执行 Snapshot 的参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshotClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-hostpath-snapclass</span><span class="w">
</span><span class="w"></span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath.csi.k8s.io</span><span class="w">
</span><span class="w"></span><span class="nt">deletionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>driver</code> 指定了使用哪个 CSI Driver，因为由 Driver 具体执行 Snapshot 操作。</p>
<p><code>deletionPolicy</code> 表明 VolumeSnapshot 删除时，如何处理 VolumeSnapshotContent。</p>
<ul>
<li><strong>Retain</strong> - 保留 VolumeSnapshotContent，意味着底层的 Snapshot 也会保留</li>
<li><strong>Delete</strong> - 删除 VolumeSnapshotContent，底层的 Snapshot 也会删除</li>
</ul>
<h3 id="54-基于-snapshot-创建-pv">5.4 基于 Snapshot 创建 PV</h3>
<p>定义 PVC 时，可以指定让其使用 VolumeSnapshot 创建 PV。那么 PV 对应的存储将从实际 Snapshot 恢复，从而恢复数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restore-pvc</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-hostpath-sc</span><span class="w">
</span><span class="w">  </span><span class="nt">dataSource</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-snapshot-test</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VolumeSnapshot </span><span class="w"> </span><span class="c"># 基于快照恢复</span><span class="w">
</span><span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">snapshot.storage.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="6-clone-volume">6 Clone Volume</h2>
<p>Clone Volume 的意思是复制现有的 Volume。利用大部分云厂商的 Clone Disk 的功能。</p>
<p>从 Kubernetes 角度看，Clone 只能是在创建新的 PVC 时，指定一个现有的 PVC 作为数据源，并且源 PVC 必须是 Bound 状态并且不在使用中。新的 PVC 会绑定到新的 PV，对应后面会绑定到 Clone 出的新的 Disk。</p>
<p>实际上的 Volume Clone 操作完全由 CSI Driver 负责。新的</p>
<p>通过 <code>dataSource</code> 来表明从一个先有的 PVC 克隆。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clone-of-pvc-1</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">myns</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cloning</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi </span><span class="w"> </span><span class="c"># 大于等于现在的 storage</span><span class="w">
</span><span class="w">  </span><span class="nt">dataSource</span><span class="p">:</span><span class="w">       </span><span class="c"># 指向一个 PVC</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Clone 后的 PVC 是完全独立的，源 PVC 的修改或删除都不会影响新的 PVC。</p>
<h2 id="参考">参考</h2>
<ul>
<li>官方文档：<a href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener noreffer"><strong>StorageClass</strong></a></li>
<li>官方文档：<a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener noreffer"><strong>Persistent Volume</strong></a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-03-26&nbsp;<a class="git-hash" href="https://github.com/KanShiori/KanShiori.github.io/commit/bfe87111649e7975198d9b269ae7633e095159dd" target="_blank" title="commit by Shiori(yshshihaoren@qq.com) bfe87111649e7975198d9b269ae7633e095159dd: optimize (#37)">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>bfe8711</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-title="Kubernetes - Volume" data-hashtags="k8s,云计算"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-hashtag="k8s"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-title="Kubernetes - Volume"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-title="Kubernetes - Volume"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-title="Kubernetes - Volume"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-title="Kubernetes - Volume"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/baidu.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume/" data-title="Kubernetes - Volume"><i class="fab fa-evernote fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cloud/cloud_native/kubernetes/k8s_learning/dns-in-k8s/" class="prev" rel="prev" title="Kubernetes - 集群中的 DNS"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Kubernetes - 集群中的 DNS</a>
            <a href="/posts/cloud/cloud_native/kubernetes/k8s_learning/rbac/" class="next" rel="next" title="Kubernetes - RBAC 与 ServiceAccount">Kubernetes - RBAC 与 ServiceAccount<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2020 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Shiori</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":35},"comment":{},"search":{"algoliaAppID":"9NJS0VQU0I","algoliaIndex":"blog","algoliaSearchKey":"85d62ea65a7f7445fbfb413bdca088f2","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
