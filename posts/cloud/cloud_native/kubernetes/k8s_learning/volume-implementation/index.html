<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Kubernetes - Volume 实现 - Shiori&#39;s Blog</title><meta name="Description" content="Kubernetes Volume 的背后原理"><meta property="og:title" content="Kubernetes - Volume 实现" />
<meta property="og:description" content="Kubernetes Volume 的背后原理" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/" /><meta property="og:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-11T14:35:42+00:00" />
<meta property="article:modified_time" content="2022-04-28T12:10:58+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/>

<meta name="twitter:title" content="Kubernetes - Volume 实现"/>
<meta name="twitter:description" content="Kubernetes Volume 的背后原理"/>
<meta name="application-name" content="Shiori&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Shiori&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/icons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/" /><link rel="prev" href="https://KanShiori.github.io/posts/security/credentials/" /><link rel="next" href="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/csi/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubernetes - Volume 实现",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_native\/kubernetes\/k8s_learning\/volume-implementation\/"
        },"image": ["https:\/\/KanShiori.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "k8s, 云计算","wordcount":  11629 ,
        "url": "https:\/\/KanShiori.github.io\/posts\/cloud\/cloud_native\/kubernetes\/k8s_learning\/volume-implementation\/","datePublished": "2021-11-11T14:35:42+00:00","dateModified": "2022-04-28T12:10:58+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/KanShiori.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Shiori"
            },"description": "Kubernetes Volume 的背后原理"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="http://kanshiori.cn" rel="noopener noreffer" target="_blank"> 主页 </a><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="http://kanshiori.cn" title="" rel="noopener noreffer" target="_blank">主页</a><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Kubernetes - Volume 实现</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Shiori</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes-%E5%AD%A6%E4%B9%A0/"><i class="far fa-folder fa-fw"></i>Kubernetes 学习</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-11-11">2021-11-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 11629 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 24 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-概述">1 概述</a></li>
    <li><a href="#2-volume-plugin">2 Volume Plugin</a>
      <ul>
        <li><a href="#21-基础接口">2.1 基础接口</a></li>
        <li><a href="#22-volumeplugin-接口">2.2 VolumePlugin 接口</a></li>
        <li><a href="#23-dynamicpluginprober-接口">2.3 DynamicPluginProber 接口</a></li>
        <li><a href="#24-volumepluginmgr-类">2.4 VolumePluginMgr 类</a></li>
      </ul>
    </li>
    <li><a href="#3-pv-controller">3 PV Controller</a>
      <ul>
        <li><a href="#31-触发逻辑">3.1 触发逻辑</a></li>
        <li><a href="#32-pv-的控制循环">3.2 PV 的控制循环</a></li>
        <li><a href="#33-pvc-的控制循环">3.3 PVC 的控制循环</a></li>
      </ul>
    </li>
    <li><a href="#4-attachdetach-controller">4 AttachDetach Controller</a>
      <ul>
        <li><a href="#41-更新-desiredstateofworld">4.1 更新 desiredStateOfWorld</a></li>
        <li><a href="#42-更新-actualstateofworld">4.2 更新 actualStateOfWorld</a></li>
        <li><a href="#43-reconcile">4.3 Reconcile</a></li>
      </ul>
    </li>
    <li><a href="#5-kubelet-的处理">5 Kubelet 的处理</a>
      <ul>
        <li><a href="#51-reconcile">5.1 Reconcile</a>
          <ul>
            <li><a href="#511-unmountvolumes">5.1.1 unmountVolumes</a></li>
            <li><a href="#512-mountattachvolumes">5.1.2 mountAttachVolumes</a></li>
            <li><a href="#513-unmountdetachdevices">5.1.3 unmountDetachDevices</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-概述">1 概述</h2>
<p>以一个云存储作为 Volume 为例，其架构图如下：








    <br><img src="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img2.png"/>


</p>
<ol>
<li><strong><code>Deploy PVC</code></strong> - 用户 Deploy PVC 对象。</li>
<li><strong><code>Provision Volume</code></strong> - PV Controller 基于 StorageClass 创建一个 Volume（无法绑定已有 PV 的情况下），并创建 PV 对象。</li>
<li><strong><code>Bind PV</code></strong> - PV Controller 将 PV 与 PVC 绑定。</li>
<li><strong><code>Attach Volume</code></strong> - AttachDetach Controller Attach Volume 到 Node 上，Node 上看来是一个块设备。</li>
<li><strong><code>Mount Device</code></strong> - Kubelet 将块设备 Mount 到一个全局的目录。</li>
<li><strong><code>Setup Volume</code></strong> - Kubelet 准备 Pod 特定的目录，该目录后续用于挂载到各个容器中的目录。</li>
</ol>
<p>上述过程是一个完成的过程，不同的 Volume 类型可能只会执行其中的几步，例如一些 “特殊” 的 Volume（例如 hostpath、secret、configmap 等），仅仅实现了 SetUp 步骤。








    <br><img src="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img2-2.png"/>


</p>
<p>对应的，销毁流程就是创建流程的相反操作：</p>
<ol>
<li><strong><code>TearDown Volume</code></strong> - Kubelet 移除为 Pod 准备的目录。</li>
<li><strong><code>Unmount Device</code></strong> - Unmount 全局目录。</li>
<li><strong><code>Detach Volume</code></strong> - 从 Node 上 Detach Volume。</li>
<li><strong><code>Delete</code></strong> - 特定条件下，删除该 Volume。</li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">上述步骤很重要，是后续所有组件执行的操作。</div>
        </div>
    </div>
<h2 id="2-volume-plugin">2 Volume Plugin</h2>
<p>无论是控制面的 Controller 还是 Kubelet，涉及到实际的 Volume 操作（Create/Delete、Attach/Detach 等）时，都会调用对应的 <strong><code>VolumePlugin</code></strong> 接口。VolumePlugin 为管理组件提供了 <a href="#1-%e6%a6%82%e8%bf%b0" rel=""><strong>概述</strong></a> 中的具体操作接口。</p>
<p>目前 Kubernetes 内置了许多的 Volume Plugin，可以分为三类：</p>
<ul>
<li><strong>内置 Volume</strong> - 包括 ConfigMap、HostPath、以及各个云厂商的 Volume，其代码是原生内置在 Controller Manager 中的；</li>
<li><strong>CSI</strong> - Container Storage Interface，在 Controller Mananger 中是一个独立的 Volume Plugin，由该 Plugin 来调用注册的 CSI Plugin；</li>
<li><strong>FlexVolume</strong> - 通过可执行文件实现的动态注册插件</li>
</ul>
<h3 id="21-基础接口">2.1 基础接口</h3>
<p>先了解下最基本执行各个操作的接口，这些接口都是用于特定 Pod 执行特定的 Volume 操作（Pod 与 Volume 都是确定的了），由 VolumePlugin 的方法得到。</p>
<p>可以看到，各个接口对应了在 <a href="#1-%e6%a6%82%e8%bf%b0" rel=""><strong>概述</strong></a> 所对应的步骤。</p>
<ul>
<li><strong>Mounter</strong>
<ul>
<li><code>CanMount()</code> - SetUp() 调用前检查所需的组件（例如插件程序）是否准备好</li>
<li><code>SetUp()</code> 与 <code>SetUpAt()</code> - 为 Pod 准备好对应的 Volume 目录</li>
</ul>
</li>
<li><strong>Unmounter</strong>
<ul>
<li><code>TearDown()</code> 与 <code>TearDownAt()</code> - 移除为 Pod 准备的 Volume 目录</li>
</ul>
</li>
<li><strong>CustomBlockVolumeMapper</strong>
<ul>
<li><code>SetUpDevice()</code> - 为 Pod 准备好 Device</li>
<li><code>MapPodDevice()</code> - 将 Device 映射给 Pod</li>
</ul>
</li>
<li><strong>CustomBlockVolumeUnmapper</strong>
<ul>
<li><code>TearDownDevice()</code> - 移除为 Pod 准备好的 Device</li>
<li><code>UnmapPodDevice()</code> - 取消 Device 映射</li>
</ul>
</li>
<li><strong>Provisioner</strong>
<ul>
<li><code>Provision()</code> - 创建一个 Volume</li>
</ul>
</li>
<li><strong>Deleter</strong>
<ul>
<li><code>Delete()</code> - 删除一个 Volume</li>
</ul>
</li>
<li><strong>Attacher</strong>
<ul>
<li><code>Attach()</code> - Attach Volume 到 Node 上</li>
<li><code>VolumesAreAttached()</code> - 返回 Node 上的 attached Volume</li>
</ul>
</li>
<li><strong>Detacher</strong>
<ul>
<li><code>Detach()</code> - Detach Volume</li>
</ul>
</li>
<li><strong>DeviceMounter</strong>
<ul>
<li><code>MountDevice()</code> - 将 attached Volume 挂载到一个全局目录</li>
</ul>
</li>
<li><strong>DeviceUnmounter</strong>
<ul>
<li><code>UnmountDevice()</code> - 取消 attached Volume 的全局目录挂载</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Volume represents a directory used by pods or hosts on a node. All method
</span></span></span><span class="line"><span class="cl"><span class="c1">// implementations of methods in the volume interface must be idempotent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Volume</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetPath 返回 volume 需要的挂载路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetPath</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// MetricsProvider 提供统计接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">MetricsProvider</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlockVolume interface provides methods to generate global map path
</span></span></span><span class="line"><span class="cl"><span class="c1">// and pod device map path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BlockVolume</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetGlobalMapPath returns a global map path which contains
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// bind mount associated to a block device.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ex. plugins/kubernetes.io/{PluginName}/{DefaultKubeletVolumeDevicesDirName}/{volumePluginDependentPath}/{pod uuid}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetGlobalMapPath</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetPodDeviceMapPath returns a pod device map path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and name of a symbolic link associated to a block device.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ex. pods/{podUid}/{DefaultKubeletVolumeDevicesDirName}/{escapeQualifiedPluginName}/, {volumeName}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetPodDeviceMapPath</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SupportsMetrics</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MetricsProvider</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Mounter 接口为 Pod 提供 Volume 对应的目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Mounter</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Volume</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// CanMount 优先于 Setup 调用，用于检查当前环境是否包含能够 Mount 的组件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">CanMount</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SetUp 为 Pod 提供 Volume 的目录，目录路径由自己决定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetUp</span><span class="p">(</span><span class="nx">mounterArgs</span> <span class="nx">MounterArgs</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SetUpAt  为 Pod 提供 Volume 的目录，目录路径由 dir 指定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetUpAt</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">mounterArgs</span> <span class="nx">MounterArgs</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetAttributes 返回 Volume 的属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetAttributes</span><span class="p">()</span> <span class="nx">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Unmounter interface provides methods to cleanup/unmount the volumes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Unmounter</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Volume</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// TearDown 取消为 Pod 提供的目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">TearDown</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TearDown 取消为 Pod 提供的指定目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">TearDownAt</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlockVolumeMapper interface is a mapper interface for block volume.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BlockVolumeMapper</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">BlockVolume</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CustomBlockVolumeMapper interface provides custom methods to set up/map the volume.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">CustomBlockVolumeMapper</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">BlockVolumeMapper</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// SetUpDevice 准备为 Pod 提供的块设备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetUpDevice</span><span class="p">()</span> <span class="p">(</span><span class="nx">stagingPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// MapPodDevice maps the block device to a path and return the path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">MapPodDevice</span><span class="p">()</span> <span class="p">(</span><span class="nx">publishPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetStagingPath returns path that was used for staging the volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// it is mainly used by CSI plugins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetStagingPath</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlockVolumeUnmapper interface is an unmapper interface for block volume.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BlockVolumeUnmapper</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">BlockVolume</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CustomBlockVolumeUnmapper interface provides custom methods to cleanup/unmap the volumes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">CustomBlockVolumeUnmapper</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">BlockVolumeUnmapper</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TearDownDevice 移除为 Pod 提供的块设备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">TearDownDevice</span><span class="p">(</span><span class="nx">mapPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">devicePath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// UnmapPodDevice removes traces of the MapPodDevice procedure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">UnmapPodDevice</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Provisioner</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Provision 创建一个 Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Provision</span><span class="p">(</span><span class="nx">selectedNode</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">allowedTopologies</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">TopologySelectorTerm</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Deleter</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Volume</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Deleter 移除一个 Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Delete</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Attacher</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">DeviceMounter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Attach Volume 到指定的 Node 上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Attach</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// VolumesAreAttached 查询 Node 上的 attached Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">VolumesAreAttached</span><span class="p">(</span><span class="nx">specs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Spec</span><span class="p">]</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// WaitForAttach 等待 attach 结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">WaitForAttach</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">devicePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DeviceMounter</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetDeviceMountPath 返回 Node 上 Volume 对应的块设备路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetDeviceMountPath</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// MountDevice 将 Volume 对应的块设备挂载到一个全局的目录（不提供给 Pod）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">MountDevice</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">devicePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deviceMountPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deviceMounterArgs</span> <span class="nx">DeviceMounterArgs</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BulkVolumeVerifier</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// BulkVerifyVolumes checks whether the list of volumes still attached to the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the clusters in the node. It returns a map which maps from the volume spec to the checking result.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If an error occurs during check - error should be returned and volume on nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// should be assumed as still attached.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">BulkVerifyVolumes</span><span class="p">(</span><span class="nx">volumesByNode</span> <span class="kd">map</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">][]</span><span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Spec</span><span class="p">]</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Detacher</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">DeviceUnmounter</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Detach Volume 在指定的 Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Detach</span><span class="p">(</span><span class="nx">volumeName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DeviceUnmounter</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// UnmountDevice 取消 Volume 对应块设备的挂载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">UnmountDevice</span><span class="p">(</span><span class="nx">deviceMountPath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-volumeplugin-接口">2.2 VolumePlugin 接口</h3>
<p><strong><code>VolumePlugin</code></strong> 是 Volume Plugin 的最基本的 interface。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Spec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Volume</span>                          <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Volume</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PersistentVolume</span>                <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ReadOnly</span>                        <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">InlineVolumeSpecForCSIMigration</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Migrated</span>                        <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// VolumePlugin is an interface to volume plugins that can be used on a
</span></span></span><span class="line"><span class="cl"><span class="c1">// kubernetes node (e.g. by kubelet) to instantiate and manage volumes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">VolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Init 初始化 plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Init</span><span class="p">(</span><span class="nx">host</span> <span class="nx">VolumeHost</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Name 返回 plugin name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 命名方式为 &#34;example.com/volume&#34;，&#34;kubernetes.io&#34; 由 kubernete 内置 Volume 预留使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetPluginName</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// GetVolumeName 基于 spec 返回一个唯一的 volume name 或者 id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 对于 Attach 与 Detach 操作会传递该 name 来让 plugin 识别 volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetVolumeName</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// CanSupport 返回 plugin 是否支持该 spec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">CanSupport</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// RequiresRemount 表明 plugin 是否支持 volume 的重新挂载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">RequiresRemount</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// NewMounter 创建一个 Mounter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewMounter</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">podRef</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">VolumeOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Mounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// NewUnmounter 创建一个 UnMounter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewUnmounter</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">podUID</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">)</span> <span class="p">(</span><span class="nx">Unmounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ConstructVolumeSpec 由 volume name 得到一个 spec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ConstructVolumeSpec</span><span class="p">(</span><span class="nx">volumeName</span><span class="p">,</span> <span class="nx">volumePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// SupportsMountOption 表明是否支持挂载选项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SupportsMountOption</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// SupportsBulkVolumeVerification checks if volume plugin type is capable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// of enabling bulk polling of all nodes. This can speed up verification of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// attached volumes by quite a bit, but underlying pluging must support it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SupportsBulkVolumeVerification</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Mounter 的作用<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Mounter 并不是进行块设备的挂载的（这是 DeviceMounter 的工作），而是<important>为特定的 Pod.Volume 准备一个目录</important>，而该目录后续由 kubelet 挂载给 Pod 的各个容器。</div>
        </div>
    </div>
<p>VolumePlugin 是一个最基本的 interface，在 VolumePlugin 之上还根据功能有着各样的 Plugin interface。</p>
<ul>
<li><strong><code>PersistentVolumePlugin</code></strong> - Volume 支持保存持久数据</li>
<li><strong><code>RecyclableVolumePlugin</code></strong> - 支持 Recycle Volume</li>
<li><strong><code>DeletableVolumePlugin</code></strong> - 支持 Delete Volume</li>
<li><strong><code>ProvisionableVolumePlugin</code></strong> - 支持 Provision Volume</li>
<li><strong><code>DeviceMountableVolumePlugin</code></strong> - 需要先挂载 Device，才可以将 Volume 挂载给 Pod</li>
<li><strong><code>AttachableVolumePlugin</code></strong> - 需要先 Attach 到 Node，再挂载 Device，才可以将 Volume 挂载给 Pod</li>
<li><strong><code>ExpandableVolumePlugin</code></strong> - Volume 支持从控制面触发 Expand</li>
<li><strong><code>NodeExpandableVolumePlugin</code></strong> - Volume 支持 Node 触发 Expand</li>
<li><strong><code>VolumePluginWithAttachLimits</code></strong> - 限制 Node 能够 Attach Volume 的数量</li>
<li><strong><code>BlockVolumePlugin</code></strong> - 支持 Block Volume</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// PersistentVolumePlugin is an extended interface of VolumePlugin and is used
</span></span></span><span class="line"><span class="cl"><span class="c1">// by volumes that want to provide long term persistence of data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PersistentVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetAccessModes describes the ways a given volume can be accessed/mounted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetAccessModes</span><span class="p">()</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeAccessMode</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// RecyclableVolumePlugin is an extended interface of VolumePlugin and is used
</span></span></span><span class="line"><span class="cl"><span class="c1">// by persistent volumes that want to be recycled before being made available
</span></span></span><span class="line"><span class="cl"><span class="c1">// again to new claims
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">RecyclableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Recycle knows how to reclaim this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// resource after the volume&#39;s release from a PersistentVolumeClaim.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Recycle will use the provided recorder to write any events that might be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// interesting to user. It&#39;s expected that caller will pass these events to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the PV being recycled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Recycle</span><span class="p">(</span><span class="nx">pvName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">eventRecorder</span> <span class="nx">recyclerclient</span><span class="p">.</span><span class="nx">RecycleEventRecorder</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DeletableVolumePlugin is an extended interface of VolumePlugin and is used
</span></span></span><span class="line"><span class="cl"><span class="c1">// by persistent volumes that want to be deleted from the cluster after their
</span></span></span><span class="line"><span class="cl"><span class="c1">// release from a PersistentVolumeClaim.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">DeletableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NewDeleter creates a new volume.Deleter which knows how to delete this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// resource in accordance with the underlying storage provider after the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// volume&#39;s release from a claim
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewDeleter</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">Deleter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ProvisionableVolumePlugin is an extended interface of VolumePlugin and is
</span></span></span><span class="line"><span class="cl"><span class="c1">// used to create volumes for the cluster.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ProvisionableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NewProvisioner creates a new volume.Provisioner which knows how to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// create PersistentVolumes in accordance with the plugin&#39;s underlying
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// storage provider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewProvisioner</span><span class="p">(</span><span class="nx">options</span> <span class="nx">VolumeOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Provisioner</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// AttachableVolumePlugin is an extended interface of VolumePlugin and is used for volumes that require attachment
</span></span></span><span class="line"><span class="cl"><span class="c1">// to a node before mounting.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AttachableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">DeviceMountableVolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NewAttacher</span><span class="p">()</span> <span class="p">(</span><span class="nx">Attacher</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NewDetacher</span><span class="p">()</span> <span class="p">(</span><span class="nx">Detacher</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// CanAttach tests if provided volume spec is attachable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">CanAttach</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DeviceMountableVolumePlugin is an extended interface of VolumePlugin and is used
</span></span></span><span class="line"><span class="cl"><span class="c1">// for volumes that requires mount device to a node before binding to volume to pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">DeviceMountableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NewDeviceMounter</span><span class="p">()</span> <span class="p">(</span><span class="nx">DeviceMounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NewDeviceUnmounter</span><span class="p">()</span> <span class="p">(</span><span class="nx">DeviceUnmounter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetDeviceMountRefs</span><span class="p">(</span><span class="nx">deviceMountPath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// CanDeviceMount determines if device in volume.Spec is mountable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">CanDeviceMount</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ExpandableVolumePlugin is an extended interface of VolumePlugin and is used for volumes that can be
</span></span></span><span class="line"><span class="cl"><span class="c1">// expanded via control-plane ExpandVolumeDevice call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ExpandableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ExpandVolumeDevice</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">newSize</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span><span class="p">,</span> <span class="nx">oldSize</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span><span class="p">)</span> <span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RequiresFSResize</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NodeExpandableVolumePlugin is an expanded interface of VolumePlugin and is used for volumes that
</span></span></span><span class="line"><span class="cl"><span class="c1">// require expansion on the node via NodeExpand call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">NodeExpandableVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RequiresFSResize</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NodeExpand expands volume on given deviceMountPath and returns true if resize is successful.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NodeExpand</span><span class="p">(</span><span class="nx">resizeOptions</span> <span class="nx">NodeResizeOptions</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// VolumePluginWithAttachLimits is an extended interface of VolumePlugin that restricts number of
</span></span></span><span class="line"><span class="cl"><span class="c1">// volumes that can be attached to a node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">VolumePluginWithAttachLimits</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Return maximum number of volumes that can be attached to a node for this plugin.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The key must be same as string returned by VolumeLimitKey function. The returned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// map may look like:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//     - { &#34;storage-limits-aws-ebs&#34;: 39 }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//     - { &#34;storage-limits-gce-pd&#34;: 10 }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// A volume plugin may return error from this function - if it can not be used on a given node or not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// applicable in given environment (where environment could be cloudprovider or any other dependency)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// For example - calling this function for EBS volume plugin on a GCE node should
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// result in error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The returned values are stored in node allocatable property and will be used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// by scheduler to determine how many pods with volumes can be scheduled on given node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetVolumeLimits</span><span class="p">()</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Return volume limit key string to be used in node capacity constraints
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The key must start with prefix storage-limits-. For example:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//    - storage-limits-aws-ebs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//    - storage-limits-csi-cinder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The key should respect character limit of ResourceName type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This function may be called by kubelet or scheduler to identify node allocatable property
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// which stores volumes limits.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">VolumeLimitKey</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlockVolumePlugin is an extend interface of VolumePlugin and is used for block volumes support.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BlockVolumePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VolumePlugin</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NewBlockVolumeMapper creates a new volume.BlockVolumeMapper from an API specification.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Ownership of the spec pointer in *not* transferred.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec: The v1.Volume spec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - pod: The enclosing pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewBlockVolumeMapper</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">podRef</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">VolumeOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">BlockVolumeMapper</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NewBlockVolumeUnmapper creates a new volume.BlockVolumeUnmapper from recoverable state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - name: The volume name, as per the v1.Volume spec.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - podUID: The UID of the enclosing pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewBlockVolumeUnmapper</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">podUID</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">)</span> <span class="p">(</span><span class="nx">BlockVolumeUnmapper</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ConstructBlockVolumeSpec constructs a volume spec based on the given
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// podUID, volume name and a pod device map path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The spec may have incomplete information due to limited information
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// from input. This function is used by volume manager to reconstruct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// volume spec by reading the volume directories from disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ConstructBlockVolumeSpec</span><span class="p">(</span><span class="nx">podUID</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">volumeName</span><span class="p">,</span> <span class="nx">volumePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Spec</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用一个类图总结一下：</p>
<a class="lightgallery" href="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img3.png" title="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img3.png" data-thumbnail="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img3.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="img3.png"
            data-srcset="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img3.png, img3.png 1.5x, /posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img3.png 2x"
            data-sizes="auto"
            alt="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/img3.png" />
    </a>
<h3 id="23-dynamicpluginprober-接口">2.3 DynamicPluginProber 接口</h3>
<p>大部分内置的插件都以代码方式实现了 VolumePlugin 接口，以静态方式注册。<important>而 FlexVolume 是由 DynamicPluginProber 接口进行 Probe 后，以动态方式注册。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ProbeEvent</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Plugin</span>     <span class="nx">VolumePlugin</span> <span class="c1">// VolumePlugin that was added/updated/removed. if ProbeEvent.Op is &#39;ProbeRemove&#39;, Plugin should be nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PluginName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Op</span>         <span class="nx">ProbeOperation</span> <span class="c1">// The operation to the plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DynamicPluginProber</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Init</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If an error occurs, events are undefined.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Probe</span><span class="p">()</span> <span class="p">(</span><span class="nx">events</span> <span class="p">[]</span><span class="nx">ProbeEvent</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用 Probe() 接口会去插件目录查找插件的可执行文件，并创建 <strong><code>flexVolumePlugin</code></strong> 类，<strong>flexVolumePlugin 即实现了 VolumePlugin 接口</strong>，可以注册到 VolumePluginMgr 中。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>插件目录<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Probe() 接口查找的目录格式为 <code>&lt;plugindir&gt;/&lt;vendor~driver&gt;/&lt;driver&gt;</code>，<code>&lt;plugindir&gt;</code> 在 Kubelet 由参数 <code>--volume-plugin-dir</code> 指定，在 Controller Manager 由参数 <code>--flex-volume-plugin-dir</code>。</p>
<p>默认为路径 <code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec</code>。</p>
</div>
        </div>
    </div>
<p>DynamicPluginProber 周期性进行 Probe() 操作，注册新发现的 flexVolumePlugin，移除不存在的 flexVolumePlugin。</p>
<p>当调用 flexVolumePlugin 的操作接口（NewMounter、NewAttacher 等），会转发调用各个可执行文件的命令。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./uds
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  flexvoldrv <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Available Commands:
</span></span><span class="line"><span class="cl">  <span class="nb">help</span>        Help about any <span class="nb">command</span>
</span></span><span class="line"><span class="cl">  init        Flex volume init command.
</span></span><span class="line"><span class="cl">  mount       Flex volume unmount command.
</span></span><span class="line"><span class="cl">  unmount     Flex volume unmount command.
</span></span><span class="line"><span class="cl">  version     Print version
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-volumepluginmgr-类">2.4 VolumePluginMgr 类</h3>
<p><strong>所有的 VolumePlugin 会注册到 VolumePluginMgr 对象中管理。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">VolumePluginMgr</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mutex</span>                     <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">plugins</span>                   <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">VolumePlugin</span>  <span class="c1">// 静态注册的 VolumePlugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">prober</span>                    <span class="nx">DynamicPluginProber</span>
</span></span><span class="line"><span class="cl">	<span class="nx">probedPlugins</span>             <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">VolumePlugin</span> <span class="c1">// probe 探测出的 VolumePlugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">loggedDeprecationWarnings</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Host</span>                      <span class="nx">VolumeHost</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而大多数 Controller 使用时，就会先通过各个 Find 函数来查找可用的 VolumePlugin，然后调用 VolumePlugin 的方法进行实际的操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// FindPluginBySpec 查找能够支持 spec 的 VolumePlugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="o">*</span><span class="nx">VolumePluginMgr</span><span class="p">)</span> <span class="nf">FindPluginBySpec</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">VolumePlugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">spec</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not find plugin because volume spec is nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 调用静态注册的 VolumePlugin.CanSupport() 函数筛选
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">matches</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">VolumePlugin</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">plugins</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">CanSupport</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">matches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 进行一次 Probe Plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pm</span><span class="p">.</span><span class="nf">refreshProbedPlugins</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 调用动态注册的 VolumePlugin.CanSupport() 函数筛选
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">plugin</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">probedPlugins</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">CanSupport</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">matches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">plugin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 没有任何 Volume Plugin 能够处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no volume plugin matched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 多个 Volume Plugin 能够处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">matchedPluginNames</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">plugin</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">matches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">matchedPluginNames</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matchedPluginNames</span><span class="p">,</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">GetPluginName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;multiple volume plugins matched: %s&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">matchedPluginNames</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 返回唯一的 Volume Plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Issue warning if the matched provider is deprecated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pm</span><span class="p">.</span><span class="nf">logDeprecation</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">GetPluginName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// FindPluginByName 通过 plugin name 查找 Volume Plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="o">*</span><span class="nx">VolumePluginMgr</span><span class="p">)</span> <span class="nf">FindPluginByName</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">VolumePlugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 查找静态注册的 VolumePlugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Once we can get rid of legacy names we can reduce this to a map lookup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">matches</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">VolumePlugin</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">plugins</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">matches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 进行一次 Probe Plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pm</span><span class="p">.</span><span class="nf">refreshProbedPlugins</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 查找动态注册的 VolumePlugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">plugin</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">probedPlugins</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">matches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">plugin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 没有任何 VolumePlugin 或者多个 VolumePlugin 视为错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no volume plugin matched name: %s&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">matchedPluginNames</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">plugin</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">matches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">matchedPluginNames</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">matchedPluginNames</span><span class="p">,</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">GetPluginName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;multiple volume plugins matched: %s&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">matchedPluginNames</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 返回唯一的 VolumePlugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Issue warning if the matched provider is deprecated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pm</span><span class="p">.</span><span class="nf">logDeprecation</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">GetPluginName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="o">*</span><span class="nx">VolumePluginMgr</span><span class="p">)</span> <span class="nf">FindPersistentPluginBySpec</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">PersistentVolumePlugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 其他各个类型的 VolumePlugin ...
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-pv-controller">3 PV Controller</h2>
<p><strong><code>PV Controller</code></strong> 主要<important>负责 PV 与 PVC 的绑定，并负责了 PV 的创建与销毁</important>。</p>
<p>PV Controller 就是一个控制器，<strong>监听着 PV 与 PVC 的事件，并对应进行 PV 与 PVC 的协调处理</strong>。</p>
<h3 id="31-触发逻辑">3.1 触发逻辑</h3>
<p>Controller 基本都是通过 Informer 实现，周期性与事件触发。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewController 创建一个 PV Controller 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewController</span><span class="p">(</span><span class="nx">p</span> <span class="nx">ControllerParameters</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 构建 Controller 对象，基本的参数都来自于 ControllerParameters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">controller</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">PersistentVolumeController</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">volumes</span><span class="p">:</span>                       <span class="nf">newPersistentVolumeOrderedIndex</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">claims</span><span class="p">:</span>                        <span class="nx">cache</span><span class="p">.</span><span class="nf">NewStore</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">DeletionHandlingMetaNamespaceKeyFunc</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kubeClient</span><span class="p">:</span>                    <span class="nx">p</span><span class="p">.</span><span class="nx">KubeClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">eventRecorder</span><span class="p">:</span>                 <span class="nx">eventRecorder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runningOperations</span><span class="p">:</span>             <span class="nx">goroutinemap</span><span class="p">.</span><span class="nf">NewGoRoutineMap</span><span class="p">(</span><span class="kc">true</span> <span class="cm">/* exponentialBackOffOnError */</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cloud</span><span class="p">:</span>                         <span class="nx">p</span><span class="p">.</span><span class="nx">Cloud</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">enableDynamicProvisioning</span><span class="p">:</span>     <span class="nx">p</span><span class="p">.</span><span class="nx">EnableDynamicProvisioning</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterName</span><span class="p">:</span>                   <span class="nx">p</span><span class="p">.</span><span class="nx">ClusterName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">createProvisionedPVRetryCount</span><span class="p">:</span> <span class="nx">createProvisionedPVRetryCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">createProvisionedPVInterval</span><span class="p">:</span>   <span class="nx">createProvisionedPVInterval</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">claimQueue</span><span class="p">:</span>                    <span class="nx">workqueue</span><span class="p">.</span><span class="nf">NewNamed</span><span class="p">(</span><span class="s">&#34;claims&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">volumeQueue</span><span class="p">:</span>                   <span class="nx">workqueue</span><span class="p">.</span><span class="nf">NewNamed</span><span class="p">(</span><span class="s">&#34;volumes&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resyncPeriod</span><span class="p">:</span>                  <span class="nx">p</span><span class="p">.</span><span class="nx">SyncPeriod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">operationTimestamps</span><span class="p">:</span>           <span class="nx">metrics</span><span class="p">.</span><span class="nf">NewOperationStartTimeCache</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化所有的 Volume Plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">volumePluginMgr</span><span class="p">.</span><span class="nf">InitPlugins</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">VolumePlugins</span><span class="p">,</span> <span class="kc">nil</span> <span class="cm">/* prober */</span><span class="p">,</span> <span class="nx">controller</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not initialize volume plugins for PersistentVolume Controller: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 监听 PV 事件，注册回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">p</span><span class="p">.</span><span class="nx">VolumeInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">AddFunc</span><span class="p">:</span>    <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">,</span> <span class="nx">newObj</span><span class="p">)</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">controller</span><span class="p">.</span><span class="nx">volumeLister</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">VolumeInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">controller</span><span class="p">.</span><span class="nx">volumeListerSynced</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">VolumeInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 监听 PVC 事件，注册回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">p</span><span class="p">.</span><span class="nx">ClaimInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">AddFunc</span><span class="p">:</span>    <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">,</span> <span class="nx">newObj</span><span class="p">)</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">controller</span><span class="p">.</span><span class="nx">claimLister</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">ClaimInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">controller</span><span class="p">.</span><span class="nx">claimListerSynced</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">ClaimInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 构建对象其他属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">controller</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// enqueueWork enqueueWork 将对象的 key 放入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">queue</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Beware of &#34;xxx deleted&#34; events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">unknown</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">DeletedFinalStateUnknown</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">unknown</span><span class="p">.</span><span class="nx">Obj</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">obj</span> <span class="p">=</span> <span class="nx">unknown</span><span class="p">.</span><span class="nx">Obj</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">objName</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">KeyFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">queue</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">objName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，PV/PVC 的事件回调都放入了对应的 <code>controller.volumeQueue</code>/<code>controller.claimQueue</code> 队列。</p>
<p>在 PV Controller 的 Run 函数时，启动了三个协程进行处理，分别进行：</p>
<ul>
<li>resync</li>
<li>处理 volumeQueue</li>
<li>处理 claimQueue。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run 启动 Controller 的控制循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleCrash</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">.</span><span class="nf">ShutDown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">.</span><span class="nf">ShutDown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 等待 cache 填充
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">cache</span><span class="p">.</span><span class="nf">WaitForNamedCacheSync</span><span class="p">(</span><span class="s">&#34;persistent volume&#34;</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeListerSynced</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimListerSynced</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">classListerSynced</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">podListerSynced</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">NodeListerSynced</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化 ctrl.Store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ctrl</span><span class="p">.</span><span class="nf">initializeCaches</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeLister</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimLister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 执行各个工作函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">resync</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">resyncPeriod</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeWorker</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimWorker</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先看下 resync，其作用就是为了比 Informer 更短周期的进行周期性的控制循环。因为 Shared Informer 的触发周期是所有使用者相同的，所以自己实现了一个 resync 函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// resync supplements short resync period of shared informers - we don&#39;t want
</span></span></span><span class="line"><span class="cl"><span class="c1">// all consumers of PV/PVC shared informer to have a short resync period,
</span></span></span><span class="line"><span class="cl"><span class="c1">// therefore we do our own.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">resync</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// List 所有 PVC，放入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pvcs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimLister</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nf">NewSelector</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pvc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pvcs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctrl</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">,</span> <span class="nx">pvc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// List 所有 PV，放入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pvs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeLister</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nf">NewSelector</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pvs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctrl</span><span class="p">.</span><span class="nf">enqueueWork</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">,</span> <span class="nx">pv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下如何处理 PV 事件。可以看到，后续调用 <code>updateVolume()</code> 与 <code>deleteVolume()</code> 方法进行处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">volumeWorker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 工作函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">workFunc</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 从队列中取出元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">keyObj</span><span class="p">,</span> <span class="nx">quit</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">quit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeQueue</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="nx">keyObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">key</span> <span class="o">:=</span> <span class="nx">keyObj</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 解析出 namespace 与 name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">_</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">SplitMetaNamespaceKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 查询 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">volume</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumeLister</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 查询的到 PV，那么事件为 add/update/sync，调用 updateVolume 处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// PV 不存在，说明 PV 对象已经被删除，那么 Controller 负责执行删除的逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 通过自己的 Store，可以保证 Controller 能够在删除失败的情况下不断重试。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 从自己的 Store 中查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">volumeObj</span><span class="p">,</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumes</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">GetByKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果不存在所有 Controller 已经处理了该 PV 的删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// The controller has already processed the delete event and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// deleted the volume from its cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 如果 Store 中找到，说明 PV 删除还未处理，调用 deleteVolume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">volume</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">volumeObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctrl</span><span class="p">.</span><span class="nf">deleteVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 永久执行工作函数，直到退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">quit</span> <span class="o">:=</span> <span class="nf">workFunc</span><span class="p">();</span> <span class="nx">quit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>PVC 的处理也是类似，后续调用 <code>updateClaim()</code> 与 <code>deleteClaim()</code> 进行处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">claimWorker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">workFunc</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">keyObj</span><span class="p">,</span> <span class="nx">quit</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">quit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="nx">keyObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">key</span> <span class="o">:=</span> <span class="nx">keyObj</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">SplitMetaNamespaceKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">claim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimLister</span><span class="p">.</span><span class="nf">PersistentVolumeClaims</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">claimObj</span><span class="p">,</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nf">GetByKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">claim</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">claimObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctrl</span><span class="p">.</span><span class="nf">deleteClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">quit</span> <span class="o">:=</span> <span class="nf">workFunc</span><span class="p">();</span> <span class="nx">quit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后看下各个 updateXXX 如何处理。最终，就是调用<code> syncVolume()</code> <code>syncClaim()</code> 函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">updateVolume</span><span class="p">(</span><span class="nx">volume</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新 Store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">new</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">storeVolumeUpdate</span><span class="p">(</span><span class="nx">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">new</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行 sync
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">syncVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsConflict</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Version conflict error happens quite often and the controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// recovers from it easily.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;could not sync volume %q: %+v&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not sync volume %q: %+v&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">updateClaim</span><span class="p">(</span><span class="nx">claim</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新 Store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">new</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">storeClaimUpdate</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">new</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行 sync
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">syncClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsConflict</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Version conflict error happens quite often and the controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// recovers from it easily.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;could not sync claim %q: %+v&#34;</span><span class="p">,</span> <span class="nf">claimToClaimKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not sync volume %q: %+v&#34;</span><span class="p">,</span> <span class="nf">claimToClaimKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-pv-的控制循环">3.2 PV 的控制循环</h3>
<p>PV 的控制循环主要<strong>负责了 PV 的状态更新，以及 PV 的回收</strong>。而 PV 创建与绑定相关都是由后续的 PVC 的控制循环处理。</p>
<p>PV 控制循环大概可以分为几个步骤：</p>
<ul>
<li>检查 PV 的绑定情况：
<ol>
<li>PV 还未绑定 PVC (PV spec.claimRef == nil)，更新 PV status.phase 为 &ldquo;Available&rdquo;。</li>
<li>PV 绑定了 PVC (PV spec.claimRef == nil)：
<ol>
<li>
<p>绑定的 PVC 还未创建 (PV spec.claimRef.UID == &ldquo;&quot;)，更新 PV status.phase 为 &ldquo;Available&rdquo;，后续不执行。</p>
</li>
<li>
<p>绑定的 PV 创建过了 (PV spec.claimRef.UID != &ldquo;&quot;)，检查实际的 PV 是否存在。</p>
<p>会查询三个地方，一个查询成功即表明存在</p>
<ul>
<li>Controller 自己维护的 Store</li>
<li>Informer.Cache</li>
<li>APiServer</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
<li>如果 PV 已经绑定了 PVC，但是 PVC 不存在，说明 PVC 已经被删除了
<ol>
<li>更新 PV status.phase 为 &ldquo;Released&rdquo;。</li>
<li>根据 PV spec.persistentVolumeReclaimPolicy，执行对 PV 的操作：
<ul>
<li>&ldquo;Retain&rdquo; - 不执行任何操作</li>
<li>&ldquo;Recycle&rdquo; - 调用 CSI 插件回收 Volume，解除 PV 与 PVC 的绑定</li>
<li>&ldquo;Delete&rdquo; - 调用 CSI 插件删除 Volume，并删除 PV 对象</li>
</ul>
</li>
</ol>
</li>
<li>如果 PV 已经绑定了 PVC，但是 PVC 还未绑定 PV
<ol>
<li>检查 PVC 与 PV 的 VolumeMode 是否匹配</li>
<li>触发一次 syncClaim</li>
</ol>
</li>
<li>如果 PV 与 PVC 相互绑定，那么更新 PV status.phase 为 &ldquo;Bound&rdquo;。</li>
<li>如果 PV 与 PVC 绑定不对称，那么解除绑定，允许的情况下还会删除 PV。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">syncVolume</span><span class="p">(</span><span class="nx">volume</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ..
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// PV Spec 没有指定绑定 PVC，那么更新 Volume Phase 为 &#34;Available&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateVolumePhase</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeAvailable</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* pv.Spec.ClaimRef != nil */</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// PV Spec 指定了绑定了 PVC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 绑定的 PVC 还未存在（没有 UID），表明给 PV 是预留的，更新 Volume Phase 为 &#34;Available&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">UID</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateVolumePhase</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeAvailable</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Nothing was saved; we will fall back into the same
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// condition in the next call to this method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 到这里，说明绑定的 PVC 已经存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Get the PVC by _name_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">var</span> <span class="nx">claim</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span>
</span></span><span class="line"><span class="cl">		<span class="nx">claimName</span> <span class="o">:=</span> <span class="nf">claimrefToClaimKey</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 查询 PVC 是否还存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">obj</span><span class="p">,</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nf">GetByKey</span><span class="p">(</span><span class="nx">claimName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果 PVC 在自己的 store 不存在，进行 double check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// If the PV was created by an external PV provisioner or
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// bound by external PV binder (e.g. kube-scheduler), it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// possible under heavy load that the corresponding PVC is not synced to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// controller local cache yet. So we need to double-check PVC in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//   1) informer cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//   2) apiserver if not found in informer cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// to make sure we will not reclaim a PV wrongly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Note that only non-released and non-failed volumes will be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// updated to Released state when PVC does not exist.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">!=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeReleased</span> <span class="o">&amp;&amp;</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">!=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeFailed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimLister</span><span class="p">.</span><span class="nf">PersistentVolumeClaims</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">found</span> <span class="p">=</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">PersistentVolumeClaims</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="nx">found</span> <span class="p">=</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;synchronizing PersistentVolume[%s]: claim %s not found&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nf">claimrefToClaimKey</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Fall through with claim = nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">			<span class="nx">claim</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot convert object from volume cache to volume %q!?: %#v&#34;</span><span class="p">,</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;synchronizing PersistentVolume[%s]: claim %s found: %s&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nf">claimrefToClaimKey</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">),</span> <span class="nf">getClaimStatusForLogging</span><span class="p">(</span><span class="nx">claim</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">claim</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">UID</span> <span class="o">!=</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">UID</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">claim</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">claim</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果最终检查的该 PVC 还是不存在，那么 PVC 已经被删除了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 更新 Volume Phase 为 &#34;Released&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">!=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeReleased</span> <span class="o">&amp;&amp;</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">!=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeFailed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateVolumePhase</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeReleased</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// Nothing was saved; we will fall back into the same condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// in the next call to this method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 根据 ReclaimPolicy 决定是否销毁 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">reclaimVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果 ReclaimPolicy 为保留，后续操作不执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">PersistentVolumeReclaimPolicy</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeReclaimRetain</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;PersistentVolume[%s] references a claim %q (%s) that is not found&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nf">claimrefToClaimKey</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">),</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">UID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// PVC 还未绑定 PV（PV 已经绑定了 PVC）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 检查 PV 与 PVC 的 VolumeMode（Filesystem/Block） 是否匹配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// 如果不匹配不执行后续的 sync 操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">pvutil</span><span class="p">.</span><span class="nf">CheckVolumeModeMismatches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Skipping syncClaim
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 后续由 PVC 的控制循环处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">HasAnnotation</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">,</span> <span class="nx">pvutil</span><span class="p">.</span><span class="nx">AnnBoundByController</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// The binding is not completed; let PVC sync handle it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;synchronizing PersistentVolume[%s]: volume not bound yet, waiting for syncClaim to fix it&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Dangling PV; try to re-establish the link in the PVC sync
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;synchronizing PersistentVolume[%s]: volume was bound and got unbound (by user?), waiting for syncClaim to fix it&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ctrl</span><span class="p">.</span><span class="nx">claimQueue</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">claimToClaimKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span> <span class="o">==</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// PVC 绑定的就是该 PV，更新 PV Phase 为 &#34;Bound&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateVolumePhase</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeBound</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// PVC 绑定的不是该 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">HasAnnotation</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">,</span> <span class="nx">pvutil</span><span class="p">.</span><span class="nx">AnnDynamicallyProvisioned</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">PersistentVolumeReclaimPolicy</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeReclaimDelete</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 如果 PV 是动态创建的（由 StorageClass 而创建的），并且允许删除，那么回收 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">!=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeReleased</span> <span class="o">&amp;&amp;</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">!=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeFailed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// Also, log this only once:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;dynamically volume %q is released and it will be deleted&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateVolumePhase</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">VolumeReleased</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="c1">// Nothing was saved; we will fall back into the same condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="c1">// in the next call to this method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">reclaimVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// Deletion failed, we will fall back into the same condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// in the next call to this method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// PV 不能允许被删除，那么就仅仅将绑定关系解除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// Volume is bound to a claim, but the claim is bound elsewhere
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// and it&#39;s not dynamically provisioned.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">HasAnnotation</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">,</span> <span class="nx">pvutil</span><span class="p">.</span><span class="nx">AnnBoundByController</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// This is part of the normal operation of the controller; the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// controller tried to use this volume for a claim but the claim
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// was fulfilled by another volume. We did this; fix it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">unbindVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// The PV must have been created with this ptr; leave it alone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// This just updates the volume phase and clears
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// volume.Spec.ClaimRef.UID. It leaves the volume pre-bound
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// to the claim.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">unbindVolume</span><span class="p">(</span><span class="nx">volume</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-pvc-的控制循环">3.3 PVC 的控制循环</h3>
<p>PVC 的控制循环<strong>负责 PVC 与 PV 的绑定，如果 PVC 指定 StorageClass 还可能创建一个 PV</strong>。</p>
<p>PVC 控制循环分为两种情况：</p>
<ul>
<li>PVC 已经由 Controller 绑定了 PV（判断 PVC annotation &ldquo;pv.kubernetes.io/bind-completed&rdquo;），执行 <code>syncBoundClaim()</code> 方法。</li>
<li>PVC 还未由 Controller 绑定了 PV（判断 PVC annotation &ldquo;pv.kubernetes.io/bind-completed&rdquo;），执行 <code>syncUnboundClaim()</code> 方法。</li>
</ul>
<p>先看简单的 <code>syncBoundClaim()</code> 逻辑，主要就是检查 PV 与 PVC 的绑定关系是否正常。</p>
<ol>
<li>PVC spec.volumeName == &ldquo;&quot;，说明绑定关系丢失了，更新 PVC status.phase 为 &ldquo;Lost&rdquo;。</li>
<li>查询对应绑定的 PV，如果 PV 不存在，说明 PV 丢失，更新 PVC status.phase 为 &ldquo;Lost&rdquo;。</li>
<li>对应的 PV 存在，但是 PV 未绑定该 PVC（PV spec.claimRef == nil），那么执行绑定操作。</li>
<li>对应的 PV 存在，但是 PV 绑定的不是该 PVC，说明绑定关系丢失了，更新 PVC status.phase 为 &ldquo;Lost&rdquo;。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">syncBoundClaim</span><span class="p">(</span><span class="nx">claim</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Annotation 表明 PVC 已经绑定了 PV，但是 PVC Spec.VolumeName 为空，说明 PV 丢失了，更新 Phase 为 &#34;Lost&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateClaimStatusWithEvent</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ClaimLost</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="s">&#34;ClaimLost&#34;</span><span class="p">,</span> <span class="s">&#34;Bound claim has lost reference to PersistentVolume. Data on the volume is lost!&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 查询 PVC 绑定的 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj</span><span class="p">,</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumes</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">GetByKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 对应的 PV 不存在，表明 PV 丢失了，更新 Phase 为 &#34;Lost&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateClaimStatusWithEvent</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ClaimLost</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="s">&#34;ClaimLost&#34;</span><span class="p">,</span> <span class="s">&#34;Bound claim has lost its PersistentVolume. Data on the volume is lost!&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">volume</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot convert object from volume cache to volume %q!?: %#v&#34;</span><span class="p">,</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 对应 PV 还未绑定，那么将对应 PV 绑定到自身 PVC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">claim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ClaimRef</span><span class="p">.</span><span class="nx">UID</span> <span class="o">==</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">UID</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// PV 与 PVC 都相互绑定了，还是调用一个 bind
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// NOTE: syncPV can handle this so it can be left out.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// NOTE: bind() call here will do nothing in most cases as
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// everything should be already set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">claim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 对应的 PV 绑定的不是该 PVC，更新 Phase 为 &#34;Lost&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateClaimStatusWithEvent</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ClaimLost</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="s">&#34;ClaimMisbound&#34;</span><span class="p">,</span> <span class="s">&#34;Two claims are bound to the same volume, this one is bound incorrectly&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>syncUnboundClaim()</code> 主要负责 PV 与 PVC 的绑定关系，如果未绑定会查找合适的 PV。</p>
<ul>
<li>PV spec.volumeName == &ldquo;&quot;，尝试绑定一个合适的 PV
<ol>
<li>无法查找到合适的 PV
<ol>
<li>如果 PVC 指定了 StorageClass，那么尝试创建一个 PV。</li>
<li>其他情况，PVC status.phase 为 &ldquo;Pending&rdquo;。</li>
</ol>
</li>
<li>找到了合适的 PV，执行绑定操作</li>
</ol>
</li>
<li>PV spec.volumeName != &ldquo;&quot;，说明是用户部署时指定了 PV，那么执行绑定操作。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">PersistentVolumeController</span><span class="p">)</span> <span class="nf">syncUnboundClaim</span><span class="p">(</span><span class="nx">claim</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 确实未绑定 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 确认 BindingMode 是否为 &#34;WaitForFirstConsumer&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">delayBinding</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pvutil</span><span class="p">.</span><span class="nf">IsDelayBindingMode</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">classLister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 查找合适的 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">volume</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumes</span><span class="p">.</span><span class="nf">findBestMatchForClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">delayBinding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error finding PV for claim %q: %w&#34;</span><span class="p">,</span> <span class="nf">claimToClaimKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">volume</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 没找到合适的 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">delayBinding</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">pvutil</span><span class="p">.</span><span class="nf">IsDelayBindingProvisioning</span><span class="p">(</span><span class="nx">claim</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 延迟绑定，并且还未调度到 Node（通过 PVC annotation &#34;volume.kubernetes.io/selected-node&#34; 判断）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">emitEventForUnboundDelayBindingClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">storagehelpers</span><span class="p">.</span><span class="nf">GetPersistentVolumeClaimClass</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// PVC 指定了 StorageClass，那么尝试创建一个 PV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">provisionClaim</span><span class="p">(</span><span class="nx">claim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ctrl</span><span class="p">.</span><span class="nx">eventRecorder</span><span class="p">.</span><span class="nf">Event</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">FailedBinding</span><span class="p">,</span> <span class="s">&#34;no persistent volumes available for this claim and no storage class is set&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 更新 PVC 状态为 Pending
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateClaimStatus</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ClaimPending</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* pv != nil */</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 找了一个合适的 PV，执行绑定操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="nx">claimKey</span> <span class="o">:=</span> <span class="nf">claimToClaimKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">volume</span><span class="p">,</span> <span class="nx">claim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* pvc.Spec.VolumeName != nil */</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// PVC 已经指定绑定的 PV，说明是用户指定的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 查找对应 PV 是否存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">obj</span><span class="p">,</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">volumes</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">GetByKey</span><span class="p">(</span><span class="nx">claim</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 不存在，PVC Phase 更新为 Pending
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">updateClaimStatus</span><span class="p">(</span><span class="nx">claim</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ClaimPending</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 存在，执行绑定操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-attachdetach-controller">4 AttachDetach Controller</h2>
<p>前面 PV Controller 负责了 PV 的创建与销毁，以及 PV 与 PVC 的绑定与解绑。当 PVC 绑定后，并被 Pod 使用后，<important>由 AttachDetach Controller 负责将其 Attach 到 Node 上，以及负责从 Node 上 Detach。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Attach 表示将 Volume 提供到 Node 上，以便后续 Node 上的 kubelet 进行处理。</div>
        </div>
    </div>
<p>整体 AttachDetach Controller 还是基于 Controller 模式，但是其核心是依赖于两个 map 的数据进行处理：<code>actualStateOfWorld</code> 与 <code>desiredStateOfWorld</code>。处理流程就是，根据当前状态，执行操作，向期望状态靠拢。</p>
<p>因此，AttachDetach Controller 的核心逻辑可以分为三个部分：</p>
<ul>
<li>更新 <code>desiredStateOfWorld</code></li>
<li>更新 <code>actualStateOfWorld</code></li>
<li>Reconcile</li>
</ul>
<h3 id="41-更新-desiredstateofworld">4.1 更新 desiredStateOfWorld</h3>
<p><code>desiredStateOfWorld</code> <strong>记录 Volume 的期望状态</strong>，即哪些 Volume 需要 Attach 到哪些 Node。</p>
<p>所有的期望状态来自于 Pod 的 Spec 定义，状态更新来自于：</p>
<ul>
<li>监听 Pod/PVC 的事件，</li>
<li>周期性遍历所有的 Pod</li>
</ul>
<p>总之最终都会收敛到同一个函数 <code>ProcessPodVolumes()</code> 进行处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ProcessPodVolumes</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">addVolumes</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">desiredStateOfWorld</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">DesiredStateOfWorld</span><span class="p">,</span> <span class="nx">volumePluginMgr</span> <span class="o">*</span><span class="nx">volume</span><span class="p">.</span><span class="nx">VolumePluginMgr</span><span class="p">,</span> <span class="nx">pvcLister</span> <span class="nx">corelisters</span><span class="p">.</span><span class="nx">PersistentVolumeClaimLister</span><span class="p">,</span> <span class="nx">pvLister</span> <span class="nx">corelisters</span><span class="p">.</span><span class="nx">PersistentVolumeLister</span><span class="p">,</span> <span class="nx">csiMigratedPluginManager</span> <span class="nx">csimigration</span><span class="p">.</span><span class="nx">PluginManager</span><span class="p">,</span> <span class="nx">csiTranslator</span> <span class="nx">csimigration</span><span class="p">.</span><span class="nx">InTreeToCSITranslator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">pod</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 如果 Pod 没有使用 Volume，啥也不干
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Volumes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Skipping processing of pod %q/%q: it has no volumes.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 查询是否调度到了一个存在的 Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeName</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">NodeName</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">nodeName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">NodeExists</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If the node the pod is scheduled to does not exist in the desired
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// state of the world data structure, that indicates the node is not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// yet managed by the controller. Therefore, ignore the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 处理 Pod Spec 中的 Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">podVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Volumes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 创建 Volume 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">volumeSpec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateVolumeSpec</span><span class="p">(</span><span class="nx">podVolume</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">volumePluginMgr</span><span class="p">,</span> <span class="nx">pvcLister</span><span class="p">,</span> <span class="nx">pvLister</span><span class="p">,</span> <span class="nx">csiMigratedPluginManager</span><span class="p">,</span> <span class="nx">csiTranslator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Error processing volume %q for pod %q/%q: %v&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">podVolume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 找到对应的 CSI Plugin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">attachableVolumePlugin</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span>
</span></span><span class="line"><span class="cl">			<span class="nx">volumePluginMgr</span><span class="p">.</span><span class="nf">FindAttachablePluginBySpec</span><span class="p">(</span><span class="nx">volumeSpec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">attachableVolumePlugin</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Skipping volume %q for pod %q/%q: it does not implement attacher interface. err=%v&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">podVolume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">uniquePodName</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GetUniquePodName</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">addVolumes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 添加 Volume 到 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">AddPod</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uniquePodName</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">volumeSpec</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 移除 Volume 从 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Remove volume from desired state of world
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">uniqueVolumeName</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GetUniqueVolumeNameFromSpec</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">attachableVolumePlugin</span><span class="p">,</span> <span class="nx">volumeSpec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">DeletePod</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uniquePodName</span><span class="p">,</span> <span class="nx">uniqueVolumeName</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-更新-actualstateofworld">4.2 更新 actualStateOfWorld</h3>
<p><code>actualStateOfWorld</code> <strong>记录 Volume 的当前状态</strong>，即 Node 上的 Attached Volume。</p>
<p>其状态更新本质来自于：</p>
<ul>
<li>执行 Volume 操作后，更新 <code>actualStateOfWorld</code>；</li>
<li>启动时与后续周期性执行 sync，更新 <code>actualStateOfWorld</code>；</li>
<li>监听 Node 的 Add/Update/Delete 事件，更新 <code>actualStateOfWorld</code>；</li>
</ul>
<p>最终操作会收敛到函数 <code>processVolumesInUse()</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// nodeAdd 处理 Node 添加事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">adc</span> <span class="o">*</span><span class="nx">attachDetachController</span><span class="p">)</span> <span class="nf">nodeAdd</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">node</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 转为 Node 的更新处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeName</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">NodeName</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">adc</span><span class="p">.</span><span class="nf">nodeUpdate</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 更新 actualStateOfWorld 的 Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">adc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">SetNodeStatusUpdateNeeded</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// nodeUpdate 处理 Node 更新事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">adc</span> <span class="o">*</span><span class="nx">attachDetachController</span><span class="p">)</span> <span class="nf">nodeUpdate</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">node</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">newObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Node 添加到 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeName</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">NodeName</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">adc</span><span class="p">.</span><span class="nf">addNodeToDswp</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">adc</span><span class="p">.</span><span class="nf">processVolumesInUse</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">VolumesInUse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// nodeDelete 处理 Node Delete 事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">adc</span> <span class="o">*</span><span class="nx">attachDetachController</span><span class="p">)</span> <span class="nf">nodeDelete</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">node</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 从 desiredStateOfWorld 删除 Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeName</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">NodeName</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">adc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">DeleteNode</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nx">adc</span><span class="p">.</span><span class="nf">processVolumesInUse</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">VolumesInUse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">adc</span> <span class="o">*</span><span class="nx">attachDetachController</span><span class="p">)</span> <span class="nf">processVolumesInUse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodeName</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">,</span> <span class="nx">volumesInUse</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">UniqueVolumeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;processVolumesInUse for node %q&#34;</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取 Node 上已经 Attached Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">attachedVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">adc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAttachedVolumesForNode</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mounted</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 检查 Volume 是否是 Attached
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">volumeInUse</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">volumesInUse</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span> <span class="o">==</span> <span class="nx">volumeInUse</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">mounted</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 记录到 actualStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">adc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">SetVolumeMountedByNode</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">mounted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;SetVolumeMountedByNode(%q, %q, %v) returned an error: %v&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">mounted</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动时与周期调用 Reconcile 时，都会执行一部分 sync 逻辑，其中会遍历所有 Node 的 Volume，进行检查并更新 actualStateOfWorld。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">sync</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">rc</span><span class="p">.</span><span class="nf">updateSyncTime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rc</span><span class="p">.</span><span class="nf">syncStates</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">updateSyncTime</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rc</span><span class="p">.</span><span class="nx">timeOfLastSync</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">syncStates</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">volumesPerNode</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAttachedVolumesPerNode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rc</span><span class="p">.</span><span class="nx">attacherDetacher</span><span class="p">.</span><span class="nf">VerifyVolumesAreAttached</span><span class="p">(</span><span class="nx">volumesPerNode</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="43-reconcile">4.3 Reconcile</h3>
<p>核心的 Reconcile 中主要执行了两个操作：</p>
<ul>
<li><strong><code>Detach Volume</code></strong> - Attached Volume 存在于 <code>actualStateOfWorld</code>，但是不存在于 <code>desiredStateOfWorld</code></li>
<li><strong><code>Attach Volume</code></strong> - Volume 存在于 <code>desiredStateOfWorld</code>，但是 <code>actualStateOfWorld</code> 中状态为 Unattached</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">reconcile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">attachedVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAttachedVolumes</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">VolumeExists</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果 Attached Volume 存在于 actualStateOfWorld，但是不存在于 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// 表明 Volume 需要 detach
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="nx">attachState</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAttachState</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">attachState</span> <span class="o">==</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">AttachStateDetached</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 如果 attachState 已经是 Detached 了，跳过处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 将 Volume 标记为 detached
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">err</span> <span class="p">=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">RemoveVolumeFromReportAsAttached</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 更新 Node Status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">err</span> <span class="p">=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">nodeStatusUpdater</span><span class="p">.</span><span class="nf">UpdateNodeStatuses</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 执行 detach Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nf">GenerateMsgDetailed</span><span class="p">(</span><span class="s">&#34;Starting attacherDetacher.DetachVolume&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">verifySafeToDetach</span> <span class="o">:=</span> <span class="p">!</span><span class="nx">timeout</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">attacherDetacher</span><span class="p">.</span><span class="nf">DetachVolume</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">AttachedVolume</span><span class="p">,</span> <span class="nx">verifySafeToDetach</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// attach Volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">attachDesiredVolumes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Update Node Status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">nodeStatusUpdater</span><span class="p">.</span><span class="nf">UpdateNodeStatuses</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">attachDesiredVolumes</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure volumes that should be attached are attached.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">volumeToAttach</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">GetVolumesToAttach</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 遍历 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="nx">attachState</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAttachState</span><span class="p">(</span><span class="nx">volumeToAttach</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">volumeToAttach</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">attachState</span> <span class="o">==</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">AttachStateAttached</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Volume/Node exists, touch it to reset detachRequestedTime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">ResetDetachRequestTime</span><span class="p">(</span><span class="nx">volumeToAttach</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">volumeToAttach</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">attacherDetacher</span><span class="p">.</span><span class="nf">AttachVolume</span><span class="p">(</span><span class="nx">volumeToAttach</span><span class="p">.</span><span class="nx">VolumeToAttach</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-kubelet-的处理">5 Kubelet 的处理</h2>
<p>Kubelet 中对 Volume 的处理也是基于 <a href="#4-attachdetach-controller" rel=""><strong>AttachDetach Controller</strong></a> 的方式，依赖于两个 map <code>的数据进行周期性协调：actualStateOfWorld</code> 与 <code>desiredStateOfWorld</code>。</p>
<p>我们不再说明 <code>actualStateOfWorld</code> 与 <code>desiredStateOfWorld</code> 的填充，只看下其 Reconcile 流程。</p>
<h3 id="51-reconcile">5.1 Reconcile</h3>
<p>reconcile() 整体逻辑就是三步：</p>
<ol>
<li><code>unmountVolumes()</code></li>
<li><code>mountAttachVolumes()</code></li>
<li><code>unmountDetachDevices()</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">reconcile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Unmounts are triggered before mounts so that a volume that was
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// referenced by a pod that was deleted and is now referenced by another
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// pod is unmounted from the first pod before being mounted to the new
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">unmountVolumes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Next we mount required volumes. This function could also trigger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// attach if kubelet is responsible for attaching volumes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If underlying PVC was resized while in-use then this function also handles volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// resizing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">mountAttachVolumes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure devices that should be detached/unmounted are detached/unmounted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rc</span><span class="p">.</span><span class="nf">unmountDetachDevices</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="511-unmountvolumes">5.1.1 unmountVolumes</h4>
<p><code>unmountVolumes</code> <strong>负责 unmount 需要的 volume</strong>，通过判断 mounted volume 是否存在于 <code>actualStateOfWorld</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">unmountVolumes</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 遍历当前节点所有的 mounted volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">mountedVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetAllMountedVolumes</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 检查该 volume 与 pod 是否存在于 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">PodExistsInVolume</span><span class="p">(</span><span class="nx">mountedVolume</span><span class="p">.</span><span class="nx">PodName</span><span class="p">,</span> <span class="nx">mountedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 进行 unmount volume 操作（底层调用的是 VolumePlugin.TearDown）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">UnmountVolume</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">mountedVolume</span><span class="p">.</span><span class="nx">MountedVolume</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">kubeletPodsDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">				<span class="p">!</span><span class="nx">nestedpendingoperations</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">				<span class="p">!</span><span class="nx">exponentialbackoff</span><span class="p">.</span><span class="nf">IsExponentialBackoff</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// Log all other errors.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">mountedVolume</span><span class="p">.</span><span class="nf">GenerateErrorDetailed</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;operationExecutor.UnmountVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">controllerAttachDetachEnabled</span><span class="p">),</span> <span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">InfoS</span><span class="p">(</span><span class="nx">mountedVolume</span><span class="p">.</span><span class="nf">GenerateMsgDetailed</span><span class="p">(</span><span class="s">&#34;operationExecutor.UnmountVolume started&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>operationExecutor.UnmountVolume()</code> 是对 unmount 进行了封装，其底层会查找支持的 VolumePlugin，并调用 <strong><code>VolumePlugin.TearDown()</code></strong> 接口。</p>
<h4 id="512-mountattachvolumes">5.1.2 mountAttachVolumes</h4>
<p><code>mountAttachVolumes</code> 负责准备 volume。有两种可能的情况：</p>
<ul>
<li>如果 volume 还未 attach，而 kubelet 允许执行 attach，那么<strong>调用 <code>Attach</code> 操作</strong>。</li>
<li>如果 volume 还未 mount，那么<strong>执行 <code>MountDevice</code> 与 <code>SetUp</code> 操作</strong>。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">mountAttachVolumes</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 遍历 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Ensure volumes that should be attached/mounted are attached/mounted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">volumeToMount</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">GetVolumesToMount</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 查询 actualStateOfWorld 对应的 volume 状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">volMounted</span><span class="p">,</span> <span class="nx">devicePath</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">PodExistsInVolume</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">PodName</span><span class="p">,</span> <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">DevicePath</span> <span class="p">=</span> <span class="nx">devicePath</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 根据 volMounted 与 err，执行操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsVolumeNotAttachedError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果 err 表明 volume 还未被 attache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">controllerAttachDetachEnabled</span> <span class="o">||</span> <span class="p">!</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">PluginIsAttachable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// volume 未被 attach，而 kubelet 不允许执行 attach 操作，那么等待 Contrller 进行 attach
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">VerifyControllerAttachedVolume</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">					<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeToMount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">rc</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// volume 未被 attach，而 kubelet 允许进行 attach 操作，那么由 kubelet 调用 attach 操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">volumeToAttach</span> <span class="o">:=</span> <span class="nx">operationexecutor</span><span class="p">.</span><span class="nx">VolumeToAttach</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">VolumeName</span><span class="p">:</span> <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">VolumeSpec</span><span class="p">:</span> <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeSpec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">NodeName</span><span class="p">:</span>   <span class="nx">rc</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">AttachVolume</span><span class="p">(</span><span class="nx">volumeToAttach</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">volMounted</span> <span class="o">||</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsRemountRequiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果 volume 还未被 mount，或者 err 需要重新 mount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 调用 MountVolume，底层会进行 MountDevice + SetUp 操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">remountingLogStr</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="nx">isRemount</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsRemountRequiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">isRemount</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">remountingLogStr</span> <span class="p">=</span> <span class="s">&#34;Volume is already mounted to pod, but remount was requested.&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">MountVolume</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rc</span><span class="p">.</span><span class="nx">waitForAttachTimeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeToMount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">isRemount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsFSResizeRequiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">ExpandInUsePersistentVolumes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 如果 volume 为需要扩容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 调用 ExpandInUseVolume 进行扩容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nf">GenerateMsgDetailed</span><span class="p">(</span><span class="s">&#34;Starting operationExecutor.ExpandInUseVolume&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">),</span> <span class="s">&#34;pod&#34;</span><span class="p">,</span> <span class="nx">klog</span><span class="p">.</span><span class="nf">KObj</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">Pod</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">ExpandInUseVolume</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeToMount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="513-unmountdetachdevices">5.1.3 unmountDetachDevices</h4>
<p><code>unmountDetachDevices</code> 调用 <strong><code>Unmount Device</code> 操作解除全局目录的挂载，允许情况下还可能调用 Detach 操作移除 Volume</strong>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">unmountDetachDevices</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 遍历 actualStateOfWorld 所有 unmounted volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">attachedVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">GetUnmountedVolumes</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">VolumeExists</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">			<span class="p">!</span><span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">IsOperationPending</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">nestedpendingoperations</span><span class="p">.</span><span class="nx">EmptyUniquePodName</span><span class="p">,</span> <span class="nx">nestedpendingoperations</span><span class="p">.</span><span class="nx">EmptyNodeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 如果 Volume 不存在于 desiredStateOfWorld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nf">DeviceMayBeMounted</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Device 还是 mounted 状态，调用 Unmount Device
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">UnmountDevice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">					<span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">AttachedVolume</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">hostutil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				
</span></span><span class="line"><span class="cl">				<span class="c1">// log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="c1">// Device 已经 unmounted 了，如果是有 Kubelet 负责 attach 的，进行 Detach 操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">controllerAttachDetachEnabled</span> <span class="o">||</span> <span class="p">!</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">PluginIsAttachable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">MarkVolumeAsDetached</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nx">klog</span><span class="p">.</span><span class="nf">InfoS</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nf">GenerateMsgDetailed</span><span class="p">(</span><span class="s">&#34;Volume detached&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;DevicePath %q&#34;</span><span class="p">,</span> <span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">DevicePath</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// 调用 Detach
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="nx">attachedVolume</span><span class="p">.</span><span class="nf">GenerateMsgDetailed</span><span class="p">(</span><span class="s">&#34;Starting operationExecutor.DetachVolume&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">					<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">DetachVolume</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">						<span class="nx">attachedVolume</span><span class="p">.</span><span class="nx">AttachedVolume</span><span class="p">,</span> <span class="kc">false</span> <span class="cm">/* verifySafeToDetach */</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://draveness.me/kubernetes-volume/" target="_blank" rel="noopener noreffer"><strong>Blog：详解 Kubernetes Volume 的实现原理</strong></a></li>
<li><a href="http://bingerambo.com/posts/2021/02/kubelet-volume-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener noreffer"><strong>Blog：kubelet volume manager 源码分析</strong></a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-04-28&nbsp;<a class="git-hash" href="https://github.com/KanShiori/KanShiori.github.io/commit/8e561e2db54193849ec27bd70ac77c07a6bcb783" target="_blank" title="commit by Shiori(yshshihaoren@qq.com) 8e561e2db54193849ec27bd70ac77c07a6bcb783: post: kubeconfig">
                                    <i class="fas fa-hashtag fa-fw"></i>8e561e2</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/" data-title="Kubernetes - Volume 实现"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/" data-title="Kubernetes - Volume 实现"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://KanShiori.github.io/posts/cloud/cloud_native/kubernetes/k8s_learning/volume-implementation/" data-title="Kubernetes - Volume 实现"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/security/credentials/" class="prev" rel="prev" title="凭证 Credential"><i class="fas fa-angle-left fa-fw"></i>凭证 Credential</a>
            <a href="/posts/cloud/cloud_native/kubernetes/k8s_learning/csi/" class="next" rel="next" title="Kubernetes - CSI 概念与实现">Kubernetes - CSI 概念与实现<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.95.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Shiori</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":35},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"9NJS0VQU0I","algoliaIndex":"blog","algoliaSearchKey":"85d62ea65a7f7445fbfb413bdca088f2","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
