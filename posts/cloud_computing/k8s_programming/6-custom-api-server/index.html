<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>K8s 编程 - Custom APIServer - Shiori&#39;s Blog</title><meta name="Description" content="Shiori&#39;s Blog"><meta property="og:title" content="K8s 编程 - Custom APIServer" />
<meta property="og:description" content="Kubernetes 编程系列 主要记录一些开发 Controller 所相关的知识，大部分内容来自于《Programming Kubernetes》（推荐直接阅读）。 Custom APIServer 可以作为 CRD 的替" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://KanShiori.github.io/posts/cloud_computing/k8s_programming/6-custom-api-server/" /><meta property="og:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-22T07:32:49&#43;00:00" />
<meta property="article:modified_time" content="2021-09-16T11:29:58&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://KanShiori.github.io/icons/favicon-16x16.png"/>

<meta name="twitter:title" content="K8s 编程 - Custom APIServer"/>
<meta name="twitter:description" content="Kubernetes 编程系列 主要记录一些开发 Controller 所相关的知识，大部分内容来自于《Programming Kubernetes》（推荐直接阅读）。 Custom APIServer 可以作为 CRD 的替"/>
<meta name="application-name" content="Shiori&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Shiori&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/icons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://KanShiori.github.io/posts/cloud_computing/k8s_programming/6-custom-api-server/" /><link rel="prev" href="https://KanShiori.github.io/posts/cloud_computing/k8s_programming/5-shipping-controllers/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "K8s 编程 - Custom APIServer",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/KanShiori.github.io\/posts\/cloud_computing\/k8s_programming\/6-custom-api-server\/"
        },"image": ["https:\/\/KanShiori.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "k8s, 云计算","wordcount":  14862 ,
        "url": "https:\/\/KanShiori.github.io\/posts\/cloud_computing\/k8s_programming\/6-custom-api-server\/","datePublished": "2021-08-22T07:32:49+00:00","dateModified": "2021-09-16T11:29:58+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/KanShiori.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Shiori"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="http://kanshiori.cn" rel="noopener noreffer" target="_blank"> 主页 </a><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Shiori&#39;s Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon-32x32.png"
        data-srcset="/icons/favicon-32x32.png, /icons/favicon-32x32.png 1.5x, /icons/favicon-32x32.png 2x"
        data-sizes="auto"
        alt="/icons/favicon-32x32.png"
        title="/icons/favicon-32x32.png" />Shiori&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="http://kanshiori.cn" title="" rel="noopener noreffer" target="_blank">主页</a><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/KanShiori/KanShiori.github.io" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">K8s 编程 - Custom APIServer</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Shiori</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes-%E7%BC%96%E7%A8%8B/"><i class="far fa-folder fa-fw"></i>Kubernetes 编程</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-08-22">2021-08-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 14862 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 30 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-custom-apisever-的适用场景">1 Custom APISever 的适用场景</a></li>
    <li><a href="#2-架构">2 架构</a>
      <ul>
        <li><a href="#21-apiservice">2.1 APIService</a></li>
        <li><a href="#22-custom-apiserver-的内部架构">2.2 Custom APIServer 的内部架构</a></li>
        <li><a href="#23-身份认证机制">2.3 身份认证机制</a></li>
        <li><a href="#24-授权">2.4 授权</a></li>
      </ul>
    </li>
    <li><a href="#3-多版本类型实现">3 多版本类型实现</a>
      <ul>
        <li><a href="#31-处理流程">3.1 处理流程</a></li>
        <li><a href="#32-internal-version-类型实现">3.2 Internal Version 类型实现</a></li>
        <li><a href="#33-external-version-类型实现">3.3 External Version 类型实现</a>
          <ul>
            <li><a href="#331-convert">3.3.1 Convert</a></li>
            <li><a href="#331-default">3.3.1 Default</a></li>
          </ul>
        </li>
        <li><a href="#34-向-scheme-注册">3.4 向 Scheme 注册</a></li>
      </ul>
    </li>
    <li><a href="#4-registry-与-strategy">4 Registry 与 Strategy</a>
      <ul>
        <li><a href="#41-apiserver-对象">4.1 APIServer 对象</a></li>
        <li><a href="#42-apigroupinfo">4.2 APIGroupInfo</a></li>
        <li><a href="#43-reststorage">4.3 rest.Storage</a></li>
        <li><a href="#44-registrystore-与-strategy">4.4 registry.Store 与 Strategy</a></li>
        <li><a href="#45-总结">4.5 总结</a></li>
      </ul>
    </li>
    <li><a href="#5-validate">5 Validate</a></li>
    <li><a href="#6-admission">6 Admission</a>
      <ul>
        <li><a href="#61-admission-plugin-选项">6.1 Admission Plugin 选项</a></li>
        <li><a href="#62-admission-plugin-interface">6.2 Admission Plugin Interface</a></li>
        <li><a href="#63-实现-admission-plugin">6.3 实现 Admission Plugin</a></li>
        <li><a href="#64-基础组件">6.4 基础组件</a></li>
        <li><a href="#65-总结">6.5 总结</a></li>
      </ul>
    </li>
    <li><a href="#7-初始化与启动">7 初始化与启动</a>
      <ul>
        <li><a href="#71-options">7.1 Options</a>
          <ul>
            <li><a href="#711-complete-option">7.1.1 Complete Option</a></li>
            <li><a href="#712-validate-option">7.1.2 Validate Option</a></li>
            <li><a href="#713-run-server">7.1.3 Run Server</a></li>
          </ul>
        </li>
        <li><a href="#72-config">7.2 Config</a>
          <ul>
            <li><a href="#721-complete-config">7.2.1 Complete Config</a></li>
            <li><a href="#722-new-apiserver">7.2.2 New APIServer</a></li>
          </ul>
        </li>
        <li><a href="#73-server">7.3 Server</a></li>
      </ul>
    </li>
    <li><a href="#8-部署">8 部署</a>
      <ul>
        <li><a href="#81-部署清单">8.1 部署清单</a></li>
        <li><a href="#82-配置证书">8.2 配置证书</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p><strong>Kubernetes 编程系列</strong> 主要记录一些开发 Controller 所相关的知识，大部分内容来自于<a href="https://www.oreilly.com/library/view/programming-kubernetes/9781492047094/" target="_blank" rel="noopener noreffer">《Programming Kubernetes》</a>（推荐直接阅读）。</p>
</blockquote>
<p>Custom APIServer 可以作为 CRD 的替代品，它可以像 Kubernetes 的原生的 APIServer 一样为 API Group 提供服务。</p>
<blockquote>
<p>下面代码都来自于 <a href="https://github.com/kubernetes/sample-apiserver" target="_blank" rel="noopener noreffer"><em>kubernetes/sample-apiserver</em></a>，这是官方的 Custom APIServer 的示例</p>
</blockquote>
<h2 id="1-custom-apisever-的适用场景">1 Custom APISever 的适用场景</h2>
<p>自定义 APIServer 以一定开发与使用复杂性的代价，而做到十分灵活的功能。我们通过对比 CRD 与 APIServer 来看一下其特有的好处：</p>
<p>CRD 的缺陷：</p>
<ul>
<li>只能使用 Kubernetes 使用的存储方式（默认 etcd）</li>
<li>不支持 protobuf，只支持 JSON</li>
<li>仅仅支持 /status 和 /scale 两种子资源</li>
<li>不支持平滑删除，你需要靠 Finalizer 来模拟这个行为</li>
<li>显著增加了 Kubernetes APIServer 的 CPU 负载，因为所有算法都用一个通用方式实现</li>
<li>对 API HTTP Endpoint 仅仅实现了标准的 CRUD 语义，不能扩展</li>
<li>不支持资源共栖（即不同 APIGroup 的资源或不同名字的资源在底层共栖存储）</li>
</ul>
<p>APIServer 可以实现：</p>
<ul>
<li><strong>可以使用任何存储作为后端存储</strong></li>
<li><strong>可以实现 Protobuf 支持</strong></li>
<li><strong>可以提供任意自定义的子资源</strong>，例如 /exec、/logs、/port-forward 等</li>
<li><strong>可以实现平滑删除逻辑</strong></li>
<li><strong>可以用 Go 高效的实现所有操作，包括验证、准入和转换</strong></li>
<li><strong>可以自定义语义</strong>，即定义 CRUD 之外的 API</li>
<li><strong>可以为相同存储机制的不同 APIGroup 或不同名称资源提供服务</strong>，例如 Deployment 最初存储在 extension/v1 组，后来挪到了 apps/v1</li>
</ul>
<h2 id="2-架构">2 架构</h2>
<p>自定义 APIServer 是为 APIGroup 提供服务的进程，通常会使用 <a href="https://github.com/kubernetes/apiserver" target="_blank" rel="noopener noreffer"><strong>k8s.io/apiserver</strong></a> 这个库来实现。</p>
<p>自定义 APIServer 可以在 Kubernetes 集群内运行，也可以在集群外运行。<strong>通常它们运行在 Pod 中，并通过 Service 提供服务</strong>。</p>
<p>Kubernetes 原生的 APIServer 称为 <strong><code>kube-apiserver</code></strong>。<strong>当 client 请求自定义 APIServer 时，请求首先会访问 kube-apiserver，然后由其转发给自定义 APIServer</strong>。这也代表了，kube-apiserver 知道所有的自定义 APIServer。</p>
<p>在 kube-apiserver 实现中，这个转发代理的组件称为 <strong><code>kube-aggregator</code></strong>，代理 API 请求的过程称为 <strong><code>API Aggregate</code></strong>。</p>
<p>向自定义 APIServer 发起请求的过程如下（下图中最左侧的流程）：</p>
<ol>
<li>kube-apiserver 收到请求。</li>
<li>请求经过处理链处理，包括身份认证、审计日志、切换用户、限流、授权等流程。</li>
<li>kube-apiserver 对相关 /apis/&lt;aggregate-API-group-name&gt; HTTP Path 下的请求进行拦截。</li>
<li>将拦截下来的请求转发给自定义 APIServer。</li>
</ol>








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img1.png"/>



<p>总结一下，kube-aggregator 提供两种功能：</p>
<ul>
<li><strong>Proxy</strong> - 可以为某个 HTTP Path 下的一个特定版本提供代理服务，例如 <strong>&quot;/apis/group-name/version&quot;</strong></li>
<li><strong>Discovery</strong> - kube-aggregator 可以为所有聚合的 APIServer 提供 Discovery Endpoint，也是就说，你可以通过 <strong>&quot;/apis&quot;</strong> 和 <strong>&quot;/apis/group-name&quot;</strong> 找到所有的自定义 APIServer。</li>
</ul>
<h3 id="21-apiservice">2.1 APIService</h3>
<p>如同 CRD 一样，为了让 Kubernetes APIServer 知道一个自定义 APIServer 的存在，必须创建一个 <strong><code>APIService</code></strong> 对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiregistration.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">APIService </span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">  
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">name </span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">API-group-name </span><span class="w">
</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">API-group-version </span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w"> 
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">custom-API-server-service-namespace </span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">API-server-service</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">1234</span><span class="w">
</span><span class="w">  </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">base64-caBundle</span><span class="w">
</span><span class="w">  </span><span class="nt">groupPriorityMinimum</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w"> 
</span><span class="w">  </span><span class="nt">versionPriority</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w"> 
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>spec.service - 指定自定义 APIServer 的 service，可以是集群内普通的 ClusterIP Service，也可以是外部的 ExternalName Service。</p>
</li>
<li>
<p>spec.caBundle - 用于设置访问自定义 APIServer 所需要的证书。</p>
</li>
<li>
<p>spec.groupPriorityMinimum - Group 的优先级，如果多个不同版本 APIService 设置了不同的值，值最大的会实际生效。</p>
<p>如果存在冲突的资源名称或者短名称，则拥有最大 groupPriorityMinimum 值的资源会生效。</p>
</li>
<li>
<p>spec.versionPriority - 给 Group 下各个版本排序，用于决定客户端优先使用哪个版本。</p>
</li>
</ul>
<p>下面是 Kubernetes API 组的 groupPriorityMinimum 值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">apiVersionPriorities</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">]</span><span class="nx">priority</span><span class="p">{</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span> <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">18000</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
	<span class="c1">// to my knowledge, nothing below here collides
</span><span class="c1"></span>	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;apps&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                               <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17800</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;events.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                      <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17750</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;events.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>                 <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17750</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;authentication.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>              <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17700</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;authorization.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>               <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17600</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;autoscaling&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                        <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17500</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;autoscaling&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v2beta1&#34;</span><span class="p">}:</span>                   <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17500</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;autoscaling&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v2beta2&#34;</span><span class="p">}:</span>                   <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17500</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;batch&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                              <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17400</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;batch&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>                         <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17400</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;batch&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v2alpha1&#34;</span><span class="p">}:</span>                        <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17400</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;certificates.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17300</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;networking.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                  <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17200</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;policy&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                             <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17100</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;policy&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>                        <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17100</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;rbac.authorization.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>          <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">17000</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;storage.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                     <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16800</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;storage.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>                <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16800</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;storage.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1alpha1&#34;</span><span class="p">}:</span>               <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16800</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;apiextensions.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>               <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16700</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;admissionregistration.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>       <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16700</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;scheduling.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                  <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16600</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;coordination.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16500</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;node.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                        <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16300</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;node.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1alpha1&#34;</span><span class="p">}:</span>                  <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16300</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;node.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>                   <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16300</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;discovery.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">}:</span>                   <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16200</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;discovery.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>              <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16200</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;flowcontrol.apiserver.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">}:</span>  <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16100</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;flowcontrol.apiserver.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1alpha1&#34;</span><span class="p">}:</span> <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16100</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;internal.apiserver.k8s.io&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1alpha1&#34;</span><span class="p">}:</span>    <span class="p">{</span><span class="nx">group</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span> <span class="nx">version</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
	<span class="c1">// Append a new group to the end of the list if unsure.
</span><span class="c1"></span>	<span class="c1">// You can use min(existing group)-100 as the initial value for a group.
</span><span class="c1"></span>	<span class="c1">// Version can be set to 9 (to have space around) for a new group.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>替换原生的 API<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><strong>如果你替换原生的 API Group，就可以对自定义 APIService 指定为比上表中更低的优先级实现。</strong></div>
        </div>
    </div>
<h3 id="22-custom-apiserver-的内部架构">2.2 Custom APIServer 的内部架构</h3>
<p>Custom APIServer 大体上与 Kubernetes APIServer 相同，不过没有嵌入 kube-aggregator 和 apiextension-apiserver。








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img2.png"/>


</p>
<p>总结一下自定义 APIServer 的特点：</p>
<ul>
<li><strong>与 Kubernetes APIServer 内部结构一致</strong>。</li>
<li><strong>拥有自己的处理链，包括身份认证、审计、切换用户等</strong></li>
<li><strong>拥有自己的资源处理流水线</strong>，包括解码、转换、准入、REST 映射和编码。</li>
<li><strong>会调用 Webhook</strong>。</li>
<li><strong>可以写 etcd，或者其他的后端存储</strong>。</li>
<li><strong>拥有自己的 Scheme 并实现了自定义 API 组的 Registry</strong>。</li>
<li><strong>再次进行身份认证</strong>。通常会发送一个 TokenAccessReview 请求对 Kubernetes APIServer 回调，实现基于 client 的证书认证和 token 认证。</li>
<li><strong>自己进行审计</strong>。</li>
<li>使用 SubjectAccessReview 请求 Kubernetes APIServer 完成授权。</li>
</ul>
<h3 id="23-身份认证机制">2.3 身份认证机制</h3>
<p>Custom APIServer 的处理在于 Kubernetes APIServer 之后，所以 <strong>Kubernetes APIServer 会先对请求进行认证，通过后再转发给自定义 APIServer</strong>。</p>
<p>Kubernetes APIServer 会将身份认证的结果保存在 HTTP 请求头里，通常是 <strong><code>X-Remote-User</code></strong> 和 <strong><code>X-Remote-Group Head</code></strong>。
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">通过 APIServer 的启动命令参数 <strong>&quot;&ndash;requestheader-username-headers&quot;</strong> 和 <strong>&quot;&ndash;requestheader-group-headers&quot;</strong> 可以配置。</div>
        </div>
    </div></p>
<p>为了让 Custom APIServer 信任这两个 HTTP Head，Custom APIServer 会验证发送请求者的 CA。因此，需要<strong>通过一个 ConfigMap 配置 Kubernetes APIServer 的证书</strong>，证书要与 Custom APIServer 相同的根证书签名：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1 </span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap </span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extension-apiserver-authentication </span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system </span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span><span class="nt">client-ca-file</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span><span class="w">    </span>-----<span class="l">BEGIN CERTIFICATE----- </span><span class="w">
</span><span class="w">    </span><span class="l">... </span><span class="w">
</span><span class="w">    </span>-----<span class="l">END CERTIFICATE----- </span><span class="w">
</span><span class="w">  </span><span class="nt">requestheader-allowed-names</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;[&#34;aggregator&#34;]&#39;</span><span class="w"> 
</span><span class="w">  </span><span class="nt">requestheader-client-ca-file</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span><span class="w">    </span>-----<span class="l">BEGIN CERTIFICATE----- </span><span class="w">
</span><span class="w">    </span><span class="l">... </span><span class="w">
</span><span class="w">    </span>-----<span class="l">END CERTIFICATE----- </span><span class="w">
</span><span class="w">  </span><span class="nt">requestheader-extra-headers-prefix</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;[&#34;X-Remote-Extra-&#34;]&#39;</span><span class="w"> 
</span><span class="w">  </span><span class="nt">requestheader-group-headers</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;[&#34;X-Remote-Group&#34;]&#39;</span><span class="w"> 
</span><span class="w">  </span><span class="nt">requestheader-username-headers</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;[&#34;X-Remote-User&#34;]&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这样认证的过程如下：</p>
<ol>
<li>Kubernetes APIServer 就会使用 <code>data.client-ca-file</code> 指定的客户端证书发起请求，进行 “预认证”</li>
<li>预认证后需要通过 <code>data.requestheader-client-ca-file</code> 证书发起转发请求，同时设置好相关的 Head。</li>
<li>最后，Custom APIServer 会通过 <strong><code>TokenAccessReview</code></strong> 的机制发送 Bearer Token（通过 HTTP Head：Authorization: bearer token）给 Kubernetes APIServer 来验证是否合法。</li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">上面这些过程主要是由 k8s.io/apiserver 库自动完成，我们只需要配置好证书。</div>
        </div>
    </div>
<h3 id="24-授权">2.4 授权</h3>
<p>完成身份认证后，每个请求都需要授权，Kubernetes 的授权机制是基于 RBAC 来完成的。</p>
<p>RBAC 将身份映射到角色，再将角色映射到授权规则，授权规则最终决定接受或者拒绝请求。我们需要理解，自定义 APIServer 是通过 <strong><code>SubjectAccessReview</code></strong> 代理授权来对请求授权的，<strong>它自身不会处理 RBAC 规则，而是委托给 Kubernetes APIServer 完成的</strong>。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>为了什么需要 APIServer 授权<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">由于可能发送给 Custom APIServer 的请求是没有经过授权的，所以需要通过 Kubernetes APIServer 来进行授权。</div>
        </div>
    </div>
<p>自定义 APIServer 会发送一个 SubjectAccessReview 请求到 Kubernetes APIServer。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">authorization.k8s.io/v1 </span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SubjectAccessReview </span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span><span class="nt">resourceAttributes</span><span class="p">:</span><span class="w"> 
</span><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">apps </span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l">deployments </span><span class="w">
</span><span class="w">    </span><span class="nt">verb</span><span class="p">:</span><span class="w"> </span><span class="l">create </span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default </span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1 </span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example </span><span class="w">
</span><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">michael </span><span class="w">
</span><span class="w">  </span><span class="nt">groups</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span>- <span class="l">system:authenticated </span><span class="w">
</span><span class="w">  </span>- <span class="l">admins </span><span class="w">
</span><span class="w">  </span>- <span class="l">authors</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Kubernetes APIServer 收到请求后，将基于 RBAC 规则进行判定，结果还是返回一个 SubjectAccessReview 对象。其中，会设置关键的 status 字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">authorization.k8s.io/v1 </span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SubjectAccessReview </span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span><span class="nt">allowed</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> 
</span><span class="w">  </span><span class="nt">denied</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> 
</span><span class="w">  </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rule foo allowed this request&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>status.allowed - 表明是否允许</li>
<li>status.denied - 表明是否拒绝请求
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">allowed 与 denied 可能同时为 false，这表明 Kubernetes APIServer 无法对请求做出判断。这应该依靠自定义 APIServer 里的权限逻辑进行判断。</div>
        </div>
    </div></li>
</ul>
<p>注意，处于性能方面考虑，<strong>委托授权机制在每个 Custom APIServer 中都维护了一个本地缓存</strong>：</p>
<ul>
<li>默认缓存 1024 个授权条目。</li>
<li>所有通过的授权请求缓存过期时间为 5min。</li>
<li>所有拒绝的授权请求缓存过期时间为 30s。</li>
</ul>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">可以通过 <strong>&quot;&ndash;authorization-webhook-cache-authorized-ttl&quot;</strong> 和 <strong>&quot;&ndash;authorization-webhook-cache-unauthorized-ttl&quot;</strong> 来进行配置。</div>
        </div>
    </div>
<h2 id="3-多版本类型实现">3 多版本类型实现</h2>
<h3 id="31-处理流程">3.1 处理流程</h3>
<p>每个 APIServer 都可以提供多个资源和版本的接口。为了让一个资源的多版本共存称为可能，<strong>APIServer 需要将资源在多个版本之间进行转换</strong>。








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img3.png"/>


</p>
<p>APIServer 在真正实现 API 逻辑时，会使用一个 <strong><ruby>内部版本<rt>internal version</rt></ruby></strong>，也称为 <strong><ruby>中枢版本<rt>hub version</rt></ruby></strong>。它可以用作每个版本都可以与之转换的中间版本，所以内部 API 逻辑都是根据中枢版本实现的。</p>
<p>所以，APIServer 中存在三个版本的概念：</p>
<ul>
<li><strong><code>External Version</code></strong> - 能够处理的版本，例如 v1beta1 v1 等；</li>
<li><strong><code>Internal Version</code></strong> - 用于 External Version 之间转换的中间版本；</li>
<li><strong><code>Storage Version</code></strong> - 保存到后端存储（etcd）的版本，属于 External Version 其中一个（通过 CRD 定义设置）；</li>
</ul>
<p>下图展示了 APIServer 在一个 API 请求的生命周期中，三个版本之间的转换情况：








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img4.png"/>


</p>
<ol>
<li>用户发送一个特定版本的请求（例如 v1，但是可以是任何支持的版本）。<strong>[External Version]</strong></li>
<li>APIServer 将请求解码，并转换为内部版本。<strong>[External Version -&gt; Internal Version]</strong></li>
<li>APIServer 对内部版本进行准入检测与验证。<strong>[Internal Version]</strong></li>
<li>注册表中的 API 逻辑都是使用内部版本的。<strong>[Internal Version]</strong></li>
<li>etcd 读写或写入特定版本对象（例如使用 v2 作为存储版本），这个过程中，它需要与内部版本进行互转。<strong>[Internal Version -&gt; Storage Version]</strong></li>
<li>结果转换为请求中的版本，例如 v1。<strong>[Internal Version -&gt; External Version]</strong></li>
</ol>
<p>从上图可以看到，一次写请求操作中，至少要做三次转换（步骤 2 5 6）。如果部署了 admission webhook，还会发生更多次的转换。</p>
<p>除了转换，下图中展示了默认值会何时处理，Default 填充未设置值字段的过程。默认值处理总是和转换一起出现，并且总是在用户请求、etcd 或者 admission webhook 时的 External Version 进行（也就是只在<strong>External Version 转换到 Internal Version 时进行</strong>），不会发生在中枢版本向外部版本转换过程中。








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img5.png"/>


</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">可以看到，转换是至关重要的，所有的两个方向的转换都必须是正确的，即是 <strong><ruby>双程的<rt>roundtrippable</rt></ruby></strong>。roundtrippable 意味着我们可以对任意的值在整个版本中来回转换，而不丢弃任何信息。</div>
        </div>
    </div>
<h3 id="32-internal-version-类型实现">3.2 Internal Version 类型实现</h3>
<p>我们看下 Internal Version 实现，位于 <strong>&ldquo;pkg/apis/&lt;group&gt;/types.go&rdquo;</strong> 文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +genclient
</span><span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Flunder</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span>

	<span class="nx">Spec</span>   <span class="nx">FlunderSpec</span>
	<span class="nx">Status</span> <span class="nx">FlunderStatus</span>
<span class="p">}</span>

<span class="c1">// +genclient
</span><span class="c1">// +genclient:nonNamespaced
</span><span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span class="c1"></span>
<span class="c1">// Fischer is an example type with a list of disallowed Flunder.Names
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Fischer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span>

	<span class="c1">// DisallowedFlunders holds a list of Flunder.Names that are disallowed.
</span><span class="c1"></span>	<span class="nx">DisallowedFlunders</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// ...
</span></code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>没有标签<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">注意，<strong>Internal Version 类型是没有 JSON 和 protobuf 标签的</strong>。因为 JSON 标签会被一些生成器用于探测一个 types.go 文件是对应内部版本还是外部版本，所以不能包含标签。</div>
        </div>
    </div>
<p>在将 Internal Version 类型注册到 Scheme 时，我们可以看到其注册的 GroupVersion 是一个特殊的 <code>runtime.APIVersionInternal</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">SchemeGroupVersion</span> <span class="p">=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">APIVersionInternal</span><span class="p">}</span>

<span class="c1">// Adds the list of known types to the given scheme.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">addKnownTypes</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">scheme</span><span class="p">.</span><span class="nf">AddKnownTypes</span><span class="p">(</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">Flunder</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">FlunderList</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">Fischer</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">FischerList</span><span class="p">{},</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>除了基本的类型与对应的 DeepCopy 相关的实现，Internal Version 类型不需要更多的代码实现了。Convert 与 Default 相关都是针对特定的External Version 类型需要实现的。</p>
<h3 id="33-external-version-类型实现">3.3 External Version 类型实现</h3>
<p>在 sample-apiserver 中实现了 v1alpha1 v1beta1 两个 External Version。我们以 v1alpha1 版本主要说明。</p>
<p>一个 External Version 类型放置于 <strong>&ldquo;pkg/apis/&lt;group&gt;/&lt;version&gt;/types.go&rdquo;</strong> 文件中。当然，其是必须包含 JSON 标签的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +genclient
</span><span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Flunder</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>

	<span class="nx">Spec</span>   <span class="nx">FlunderSpec</span>   <span class="s">`json:&#34;spec,omitempty&#34; protobuf:&#34;bytes,2,opt,name=spec&#34;`</span>
	<span class="nx">Status</span> <span class="nx">FlunderStatus</span> <span class="s">`json:&#34;status,omitempty&#34; protobuf:&#34;bytes,3,opt,name=status&#34;`</span>
<span class="p">}</span>
<span class="c1">// +genclient
</span><span class="c1">// +genclient:nonNamespaced
</span><span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Fischer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>

	<span class="c1">// DisallowedFlunders holds a list of Flunder.Names that are disallowed.
</span><span class="c1"></span>	<span class="nx">DisallowedFlunders</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;disallowedFlunders,omitempty&#34; protobuf:&#34;bytes,2,rep,name=disallowedFlunders&#34;`</span>
<span class="p">}</span>
<span class="c1">// ...
</span></code></pre></td></tr></table>
</div>
</div><p>与 Internal Version 不同了，其注册到 Scheme 的 GroupVersion 就是对应版本的 string 了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">SchemeGroupVersion</span> <span class="p">=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1alpha1&#34;</span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">addKnownTypes</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">scheme</span><span class="p">.</span><span class="nf">AddKnownTypes</span><span class="p">(</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">Flunder</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">FlunderList</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">Fischer</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">FischerList</span><span class="p">{},</span>
	<span class="p">)</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nf">AddToGroupVersion</span><span class="p">(</span><span class="nx">scheme</span><span class="p">,</span> <span class="nx">SchemeGroupVersion</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="331-convert">3.3.1 Convert</h4>
<p>在 <a href="#31-%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" rel=""><strong>3.1 处理流程</strong></a> 中看到，APIServer 处理请求过程中有着多次 External Version 与 Internal Version 双向的转换，因此其需要注册对应的转换函数，其注册函数会自动生成位于 <strong>&ldquo;pkg/apis/&lt;group&gt;/&lt;version&gt;/zz_generated.conversion.go&rdquo;</strong>。</p>
<p>可以看到，其类型转换函数通过 <code>Scheme.AddGeneratedConversionFunc()</code> 接口注册到 Scheme 中。而在 APIServer 抽象实现中，会按照 <a href="#31-%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" rel=""><strong>3.1 处理流程</strong></a> 中的请求处理流程调用 <code>Scheme.Convert()</code> 接口进行转换。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 注册转换函数
</span><span class="c1"></span>	<span class="nx">localSchemeBuilder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">RegisterConversions</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// RegisterConversions adds conversion functions to the given scheme.
</span><span class="c1">// Public to allow building arbitrary schemes.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">RegisterConversions</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// Scheme.AddGeneratedConversionFunc(a, b interface{}, fn conversion.ConversionFunc) 用于注册一个转换函数
</span><span class="c1"></span>	<span class="c1">// 表明 fn 会用于将 a -&gt; b
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// fn 为 type ConversionFunc func(a, b interface{}, scope Scope) error
</span><span class="c1"></span>	<span class="c1">// 实现实际的将 a -&gt; b，scope 表示范围（大部分情况不使用）
</span><span class="c1"></span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">Fischer</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Fischer</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_v1alpha1_Fischer_To_wardle_Fischer</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">Fischer</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Fischer</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Fischer</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">Fischer</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_wardle_Fischer_To_v1alpha1_Fischer</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Fischer</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">Fischer</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">FischerList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_v1alpha1_FischerList_To_wardle_FischerList</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">FischerList</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerList</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">FischerList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_wardle_FischerList_To_v1alpha1_FischerList</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerList</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">FischerList</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">Flunder</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_v1alpha1_Flunder_To_wardle_Flunder</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">Flunder</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">Flunder</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_wardle_Flunder_To_v1alpha1_Flunder</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">Flunder</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">FlunderList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_v1alpha1_FlunderList_To_wardle_FlunderList</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderList</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderList</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">FlunderList</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_wardle_FlunderList_To_v1alpha1_FlunderList</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderList</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderList</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">FlunderStatus</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderStatus</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_v1alpha1_FlunderStatus_To_wardle_FlunderStatus</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderStatus</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderStatus</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddGeneratedConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderStatus</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">FlunderStatus</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_wardle_FlunderStatus_To_v1alpha1_FlunderStatus</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderStatus</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderStatus</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderSpec</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_v1alpha1_FlunderSpec_To_wardle_FlunderSpec</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderSpec</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderSpec</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Convert_wardle_FlunderSpec_To_v1alpha1_FlunderSpec</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderSpec</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>生成器会自动生成 <code>Convert_&lt;group&gt;_&lt;Internal-Type&gt;_To_&lt;External-Version&gt;_&lt;&lt;External-Type&gt;()</code> 与 <code>Convert_&lt;External-Version&gt;_&lt;External-Type&gt;_To_&lt;group&gt;_&lt;Internal-Type&gt;</code> 两个双向的 Internal Version 与 External Version 转换的函数。</p>
<p>当然，自动生成的函数只是简单的结构体转换，即转换前后的结构体都是使用同一块内存。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">autoConvert_v1alpha1_FischerList_To_wardle_FischerList</span><span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">FischerList</span><span class="p">,</span> <span class="nx">out</span> <span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerList</span><span class="p">,</span> <span class="nx">s</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">out</span><span class="p">.</span><span class="nx">ListMeta</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ListMeta</span>
	<span class="nx">out</span><span class="p">.</span><span class="nx">Items</span> <span class="p">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">[]</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Fischer</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">in</span><span class="p">.</span><span class="nx">Items</span><span class="p">))</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">上面这种转换方式也说明了，在转换后，源对象应该不要再修改了，否则会影响到转换后的对象。</div>
        </div>
    </div>
<p><strong>对于版本之间不同的结构体，就需要我们自己实现对应的转换函数了</strong>。在 <strong>&ldquo;pkg/apis/&lt;group&gt;/&lt;version&gt;/conversion.go&rdquo;</strong> 文件中，我们按照对应的格式实现特殊的转换函数。而生成器判断到对应的转换函数已经存在，就会跳过自动生成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 自定义的版本转换函数
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Convert_v1alpha1_FlunderSpec_To_wardle_FlunderSpec</span><span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">,</span> <span class="nx">out</span> <span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderSpec</span><span class="p">,</span> <span class="nx">s</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// assume that ReferenceType is defaulted
</span><span class="c1"></span>		<span class="k">switch</span> <span class="o">*</span><span class="nx">in</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">FlunderReferenceType</span><span class="p">:</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">=</span> <span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderReferenceType</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">FlunderReference</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Reference</span>
		<span class="k">case</span> <span class="nx">FischerReferenceType</span><span class="p">:</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">=</span> <span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerReferenceType</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">FischerReference</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Reference</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 自定义的版本转换函数
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Convert_wardle_FlunderSpec_To_v1alpha1_FlunderSpec</span><span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderSpec</span><span class="p">,</span> <span class="nx">out</span> <span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">,</span> <span class="nx">s</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderReferenceType</span><span class="p">:</span>
		<span class="nx">t</span> <span class="o">:=</span> <span class="nx">FlunderReferenceType</span>
		<span class="nx">out</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">t</span>
		<span class="nx">out</span><span class="p">.</span><span class="nx">Reference</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">FlunderReference</span>
	<span class="k">case</span> <span class="nx">wardle</span><span class="p">.</span><span class="nx">FischerReferenceType</span><span class="p">:</span>
		<span class="nx">t</span> <span class="o">:=</span> <span class="nx">FischerReferenceType</span>
		<span class="nx">out</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">t</span>
		<span class="nx">out</span><span class="p">.</span><span class="nx">Reference</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">FischerReference</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>WARN<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">转换的过程中，源对象一定不能被修改。</div>
        </div>
    </div>
<h4 id="331-default">3.3.1 Default</h4>
<p>除了 Convert 函数之外，External Version 类型也可以设置 Default 函数。在 <a href="#311-%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" rel=""><strong>3.1.1 处理流程</strong></a> 中提到过，APIServer 会在 External Version 转换到 Internal Version 时进行默认值处理。</p>
<p>同样，生成器也会自动生成 Default 相关函数，位于文件 <strong>&ldquo;pkg/apis/&lt;group&gt;/&lt;version&gt;/zz_generated.defaults.go&rdquo;</strong>，但是底层设置默认值的函数还是要我们自己编写。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// RegisterDefaults 用于向 Scheme 注册默认值处理函数
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">RegisterDefaults</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">scheme</span><span class="p">.</span><span class="nf">AddTypeDefaultingFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Flunder</span><span class="p">{},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nf">SetObjectDefaults_Flunder</span><span class="p">(</span><span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">Flunder</span><span class="p">))</span> <span class="p">})</span>
	<span class="nx">scheme</span><span class="p">.</span><span class="nf">AddTypeDefaultingFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">FlunderList</span><span class="p">{},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nf">SetObjectDefaults_FlunderList</span><span class="p">(</span><span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">FlunderList</span><span class="p">))</span> <span class="p">})</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">SetObjectDefaults_Flunder</span><span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">Flunder</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">SetDefaults_FlunderSpec</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">in</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span> <span class="c1">// 调用真正的设置默认值的函数
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">SetObjectDefaults_FlunderList</span><span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">FlunderList</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">a</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">in</span><span class="p">.</span><span class="nx">Items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
		<span class="nf">SetObjectDefaults_Flunder</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>自己编写的设置默认值的函数位于文件 <strong>&ldquo;pkg/apis/&lt;group&gt;/&lt;version&gt;/defaults.go&rdquo;</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SetDefaults_FlunderSpec sets defaults for Flunder spec
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SetDefaults_FlunderSpec</span><span class="p">(</span><span class="nx">obj</span> <span class="o">*</span><span class="nx">FlunderSpec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">obj</span><span class="p">.</span><span class="nx">ReferenceType</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">Reference</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">t</span> <span class="o">:=</span> <span class="nx">FlunderReferenceType</span>
		<span class="nx">obj</span><span class="p">.</span><span class="nx">ReferenceType</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">t</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="34-向-scheme-注册">3.4 向 Scheme 注册</h3>
<p>最后在说明一下类型、Convert 函数、Default 函数是如何注册到 Scheme 中的。这三类都会注册到代码生成的一个 <code>SchemeBuilder</code> 对象，其作用就是用于调用注册的 <code>funcs (scheme *Scheme) error</code> 去设置 Scheme。</p>
<p>而前面看到的各个 Register 函数都是注册到 <code>SchemeBuilder</code> 对象中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">SchemeBuilder</span>      <span class="nx">runtime</span><span class="p">.</span><span class="nx">SchemeBuilder</span>
	<span class="nx">localSchemeBuilder</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">SchemeBuilder</span>
	<span class="c1">// AddToScheme is a common registration function for mapping packaged scoped group &amp; version keys to a scheme
</span><span class="c1"></span>	<span class="nx">AddToScheme</span> <span class="p">=</span> <span class="nx">localSchemeBuilder</span><span class="p">.</span><span class="nx">AddToScheme</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// We only register manually written functions here. The registration of the
</span><span class="c1"></span>	<span class="c1">// generated functions takes place in the generated files. The separation
</span><span class="c1"></span>	<span class="c1">// makes the code compile even when the generated files are missing.
</span><span class="c1"></span>	<span class="nx">localSchemeBuilder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">addKnownTypes</span><span class="p">,</span> <span class="nx">addDefaultingFuncs</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// addKnownTypes 注册类型
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">addKnownTypes</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">scheme</span><span class="p">.</span><span class="nf">AddKnownTypes</span><span class="p">(</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">Flunder</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">FlunderList</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">Fischer</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="nx">FischerList</span><span class="p">{},</span>
	<span class="p">)</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nf">AddToGroupVersion</span><span class="p">(</span><span class="nx">scheme</span><span class="p">,</span> <span class="nx">SchemeGroupVersion</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// addDefaultingFuncs 注册 Default 函数
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">addDefaultingFuncs</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">RegisterDefaults</span><span class="p">(</span><span class="nx">scheme</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">localSchemeBuilder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">RegisterConversions</span><span class="p">)</span> <span class="c1">// 注册 Convert 函数
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所有版本的 AddToScheme 都是在 <strong>&ldquo;pkg/apis/&lt;group&gt;/install/install.go&rdquo;</strong> 中一个辅助函数 Install 中注册：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Install registers the API group and adds types to a scheme
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Install</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 注册 Internal Version
</span><span class="c1"></span>	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">wardle</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">))</span>
	<span class="c1">// 注册 v1beta1
</span><span class="c1"></span>	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">))</span>
	<span class="c1">// 注册 v1alpha1
</span><span class="c1"></span>	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">))</span>
	<span class="c1">// 设置优先级（优先级用于客户端选择版本）
</span><span class="c1"></span>	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">scheme</span><span class="p">.</span><span class="nf">SetVersionPriority</span><span class="p">(</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Install 函数在 APIServer 包中会自动调用，也就是说，程序运行一开始就将所有 Scheme 相关的注册处理好了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
	<span class="c1">// Scheme defines methods for serializing and deserializing API objects.
</span><span class="c1"></span>	<span class="nx">Scheme</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">install</span><span class="p">.</span><span class="nf">Install</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="4-registry-与-strategy">4 Registry 与 Strategy</h2>
<p>APIServer 本质上就是一个 HTTP Server，client 通过访问以 Resource 为单位的 RESTful 接口来进行交互。在 Custom APIServer 中，为了让 Custom APIServer 能够处理 CR 相关的接口，我们需要注册相关接口的 HTTP Handle。</p>
<p>k8s.io/apiserver 库提供了该功能的高度封装，其核心就是 Registry。</p>
<h3 id="41-apiserver-对象">4.1 APIServer 对象</h3>
<p>在 Custom APIServer 实现中，不需要自己定义 HTTP Server，可以直接内嵌提供的 <code>GenericAPIServer</code> 类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">genericapiserver</span> <span class="s">&#34;k8s.io/apiserver/pkg/server&#34;</span>

<span class="c1">// WardleServer contains state for a Kubernetes cluster master/api server.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">WardleServer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">GenericAPIServer</span> <span class="o">*</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">GenericAPIServer</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在整个 Custom APIServer 程序启动流程中，会调用 <code>GenericAPIServer.PrepareRun().Run()</code> 运行一个 HTTP Server。（整个启动流程很长，后面单独说明）</p>
<p>在创建 WardleServer 过程中，我们会创建 <code>APIGroupInfo</code> 对象，而将其注册到 <code>GenericAPIServer</code> 对象中，可以理解为完成了某个 Group 下所有 Resource 对应的 HTTP Handle 注册。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">WardleServer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// CompletedConfig 得到一个 GenericAPIServer
</span><span class="c1"></span>	<span class="nx">genericServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;sample-apiserver&#34;</span><span class="p">,</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewEmptyDelegate</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// Custom APIServer 对象
</span><span class="c1"></span>	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">WardleServer</span><span class="p">{</span>
		<span class="nx">GenericAPIServer</span><span class="p">:</span> <span class="nx">genericServer</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// 构建 APIGroupInfo
</span><span class="c1"></span>	<span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewDefaultAPIGroupInfo</span><span class="p">(</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Scheme</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span> <span class="nx">Codecs</span><span class="p">)</span>

	<span class="c1">// 构建 APIGroup
</span><span class="c1"></span>	<span class="nx">v1alpha1storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
	<span class="nx">v1alpha1storage</span><span class="p">[</span><span class="s">&#34;flunders&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">flunderstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">v1alpha1storage</span><span class="p">[</span><span class="s">&#34;fischers&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">fischerstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="s">&#34;v1alpha1&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1alpha1storage</span>

	<span class="nx">v1beta1storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
	<span class="nx">v1beta1storage</span><span class="p">[</span><span class="s">&#34;flunders&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">flunderstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="s">&#34;v1beta1&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1beta1storage</span>

	<span class="c1">// 注册 APIGroup 到 Kubernetes APIServer
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallAPIGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">这里暂时不去深入了解 APIGroupInfo 是如何映射到 HTTP Handle 的，因为这是 k8s.io/apiserver 库提供的封装。（其实我也不懂）</div>
        </div>
    </div>
<h3 id="42-apigroupinfo">4.2 APIGroupInfo</h3>
<p><strong><code>APIGroupInfo</code></strong> 能够变为一个 Group 下所有 Version 所有 Resource 的的 HTTP Handle。因此，我们可以想到，我们提供给 APIGroupInfo 什么信息：</p>
<ul>
<li>
<p>该 Group 支持的所有 Version，以及每个 Version 支持的所有 Resource；</p>
<p>由调用 <code>genericapiserver.NewDefaultAPIGroupInfo()</code> 传入的 Group + Scheme + Codecs 提供。这样，处理 HTTP 请求时能够将数据序列化为特定的对象。</p>
</li>
<li>
<p>GroupVersionResource 维度的 RESTful HTTP Handle；</p>
<p>通过将 <code>rest.Storage</code> 注册到 <code>APIGroupInfo.VersionedResourcesStorageMap</code> 中。rest.Storage 为一个 RESTful HTTP Handle 的实现。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="c1">// 构建 APIGroupInfo
</span><span class="c1"></span>	<span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewDefaultAPIGroupInfo</span><span class="p">(</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Scheme</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span> <span class="nx">Codecs</span><span class="p">)</span>

	<span class="c1">// 构建 APIGroup
</span><span class="c1"></span>	<span class="c1">// 一个 rest.Storage 对应了一个 HTTP API Endpoint
</span><span class="c1"></span>	<span class="c1">// 即 /apis/&lt;group&gt;/&lt;version&gt;/&lt;resource&gt;
</span><span class="c1"></span>
	<span class="c1">// 下面注册了两个 Endpoint
</span><span class="c1"></span>	<span class="c1">//	+ /apis/wardle.example.com/v1alpha1/flunders
</span><span class="c1"></span>	<span class="c1">//	+ /apis/wardle.example.com/v1alpha1/fischers
</span><span class="c1"></span>	<span class="nx">v1alpha1storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
	<span class="nx">v1alpha1storage</span><span class="p">[</span><span class="s">&#34;flunders&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">flunderstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">v1alpha1storage</span><span class="p">[</span><span class="s">&#34;fischers&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">fischerstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="s">&#34;v1alpha1&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1alpha1storage</span> <span class="c1">// 注册到 APIGroupInfo v1alpha1 版本
</span><span class="c1"></span>
	<span class="c1">// 下面注册了一个 Endpoint
</span><span class="c1"></span>	<span class="c1">//	+ /apis/wardle.example.com/v1beta1/flunders
</span><span class="c1"></span>	<span class="nx">v1beta1storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
	<span class="nx">v1beta1storage</span><span class="p">[</span><span class="s">&#34;flunders&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">flunderstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="s">&#34;v1beta1&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1beta1storage</span> <span class="c1">// 注册到 APIGroupInfo v1beta1 版本
</span></code></pre></td></tr></table>
</div>
</div><h3 id="43-reststorage">4.3 rest.Storage</h3>
<p>终于，我们看似来到了这个封装的最底层 <code>rest.Storage</code>，提供 REST 风格各个 Handle 的类。<code>rest.Storage</code> 本身的 interface 实现很简单，仅仅只需要提供 <code>New()</code> 方法就好了，也就是说，一个 Resource HTTP Endpoint 至少要提供一个 Create/Update 接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Storage is a generic interface for RESTful storage services.
</span><span class="c1">// Resources which are exported to the RESTful API of apiserver need to implement this interface. It is expected
</span><span class="c1">// that objects may implement any of the below interfaces.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Storage</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// New returns an empty object that can be used with Create and Update after request data has been put into it.
</span><span class="c1"></span>	<span class="c1">// This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object)
</span><span class="c1"></span>	<span class="nf">New</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>实现 Custom APIServer 时，为了能够支持多个 HTTP Endpoint，使用的是 <code>rest.StandardStorage</code> interface。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// StandardStorage is an interface covering the common verbs. Provided for testing whether a
</span><span class="c1">// resource satisfies the normal storage methods. Use Storage when passing opaque storage objects.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">StandardStorage</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Getter</span>
	<span class="nx">Lister</span>
	<span class="nx">CreaterUpdater</span>
	<span class="nx">GracefulDeleter</span>
	<span class="nx">CollectionDeleter</span>
	<span class="nx">Watcher</span>
<span class="p">}</span>

<span class="c1">// Getter is an object that can retrieve a named RESTful resource.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Getter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Get finds a resource in the storage by name and returns it.
</span><span class="c1"></span>	<span class="c1">// Although it can return an arbitrary error value, IsNotFound(err) is true for the
</span><span class="c1"></span>	<span class="c1">// returned error value err when the specified resource is not found.
</span><span class="c1"></span>	<span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Lister is an object that can retrieve resources that match the provided field and label criteria.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Lister</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// NewList returns an empty object that can be used with the List call.
</span><span class="c1"></span>	<span class="c1">// This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object)
</span><span class="c1"></span>	<span class="nf">NewList</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>
	<span class="c1">// List selects resources in the storage which match to the selector. &#39;options&#39; can be nil.
</span><span class="c1"></span>	<span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// TableConvertor ensures all list implementers also implement table conversion
</span><span class="c1"></span>	<span class="nx">TableConvertor</span>
<span class="p">}</span>

<span class="c1">// CreaterUpdater is a storage object that must support both create and update.
</span><span class="c1">// Go prevents embedded interfaces that implement the same method.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CreaterUpdater</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Creater</span>
	<span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">objInfo</span> <span class="nx">UpdatedObjectInfo</span><span class="p">,</span> <span class="nx">createValidation</span> <span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">updateValidation</span> <span class="nx">ValidateObjectUpdateFunc</span><span class="p">,</span> <span class="nx">forceAllowCreate</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">UpdateOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Creater is an object that can create an instance of a RESTful object.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Creater</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// New returns an empty object that can be used with Create after request data has been put into it.
</span><span class="c1"></span>	<span class="c1">// This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object)
</span><span class="c1"></span>	<span class="nf">New</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>

	<span class="c1">// Create creates a new version of a resource.
</span><span class="c1"></span>	<span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">createValidation</span> <span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// GracefulDeleter knows how to pass deletion options to allow delayed deletion of a
</span><span class="c1">// RESTful object.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">GracefulDeleter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Delete finds a resource in the storage and deletes it.
</span><span class="c1"></span>	<span class="c1">// The delete attempt is validated by the deleteValidation first.
</span><span class="c1"></span>	<span class="c1">// If options are provided, the resource will attempt to honor them or return an invalid
</span><span class="c1"></span>	<span class="c1">// request error.
</span><span class="c1"></span>	<span class="c1">// Although it can return an arbitrary error value, IsNotFound(err) is true for the
</span><span class="c1"></span>	<span class="c1">// returned error value err when the specified resource is not found.
</span><span class="c1"></span>	<span class="c1">// Delete *may* return the object that was deleted, or a status object indicating additional
</span><span class="c1"></span>	<span class="c1">// information about deletion.
</span><span class="c1"></span>	<span class="c1">// It also returns a boolean which is set to true if the resource was instantly
</span><span class="c1"></span>	<span class="c1">// deleted or false if it will be deleted asynchronously.
</span><span class="c1"></span>	<span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deleteValidation</span> <span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// CollectionDeleter is an object that can delete a collection
</span><span class="c1">// of RESTful resources.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CollectionDeleter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// DeleteCollection selects all resources in the storage matching given &#39;listOptions&#39;
</span><span class="c1"></span>	<span class="c1">// and deletes them. The delete attempt is validated by the deleteValidation first.
</span><span class="c1"></span>	<span class="c1">// If &#39;options&#39; are provided, the resource will attempt to honor them or return an
</span><span class="c1"></span>	<span class="c1">// invalid request error.
</span><span class="c1"></span>	<span class="c1">// DeleteCollection may not be atomic - i.e. it may delete some objects and still
</span><span class="c1"></span>	<span class="c1">// return an error after it. On success, returns a list of deleted objects.
</span><span class="c1"></span>	<span class="nf">DeleteCollection</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">deleteValidation</span> <span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">,</span> <span class="nx">listOptions</span> <span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Watcher should be implemented by all Storage objects that
</span><span class="c1">// want to offer the ability to watch for changes through the watch api.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Watcher</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// &#39;label&#39; selects on labels; &#39;field&#39; selects on the object&#39;s fields. Not all fields
</span><span class="c1"></span>	<span class="c1">// are supported; an error should be returned if &#39;field&#39; tries to select on a field that
</span><span class="c1"></span>	<span class="c1">// isn&#39;t supported. &#39;resourceVersion&#39; allows for continuing/starting a watch at a
</span><span class="c1"></span>	<span class="c1">// particular version.
</span><span class="c1"></span>	<span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所有嵌套的 Handle interface 都是包含名字对应的 HTTP Handle 实现，从名字上就可以知道对应的功能。之外还有许多个 Handle interface：</p>
<table>
<thead>
<tr>
<th>Interface</th>
<th>HTTP Method</th>
<th>Endpoint</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lister</td>
<td>List</td>
<td>&lt;ResourcePath&gt;</td>
<td>可以匹配指定 Field 和 Label 获取 ResourceList</td>
</tr>
<tr>
<td>Creater</td>
<td>POST</td>
<td>&lt;ResourcePath&gt;</td>
<td>创建一个 Resource</td>
</tr>
<tr>
<td>CollectionDeleter</td>
<td>DELETECOLLECTION</td>
<td>&lt;ResourcePath&gt;         删除一组 Resource</td>
<td></td>
</tr>
<tr>
<td>Getter</td>
<td>GET</td>
<td>&lt;ResourcePath&gt;/{name}</td>
<td>按 name 获取一个 Resource</td>
</tr>
<tr>
<td>Updater</td>
<td>PUT</td>
<td>&lt;ResourcePath&gt;/{name}</td>
<td>更新一个 Resource</td>
</tr>
<tr>
<td>Patcher</td>
<td>PATCH</td>
<td>&lt;ResourcePath&gt;/{name}</td>
<td>Patch 方式更新一个 Resource Resource</td>
</tr>
<tr>
<td>GracefulDeleter</td>
<td>DELETE</td>
<td>&lt;ResourcePath&gt;/{name}</td>
<td>删除一个 Resource</td>
</tr>
<tr>
<td>Watcher</td>
<td>HTTP Method</td>
<td>&lt;ResourcePath&gt;</td>
<td>删除一组 Resource</td>
</tr>
<tr>
<td>Connecter</td>
<td>Connect</td>
<td>-</td>
<td>Creater + Updater</td>
</tr>
<tr>
<td>CreateUpdater</td>
<td>GET/PUT</td>
<td>-</td>
<td>Creater + Updater</td>
</tr>
<tr>
<td>Scoper</td>
<td>-</td>
<td>-</td>
<td>（必须实现）用于代码中判断是否是 Namespaced</td>
</tr>
</tbody>
</table>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>ResourcePath<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">ResourcePath 就是路径 /api/apiVersion/resource 或者 /api/apiVersion/{namespace}/resource。</div>
        </div>
    </div>
<p>所以，我们需要将实现了 <code>rest.Storage</code> interface 的对象注册到 <code>APIGroupInfo</code> 中。</p>
<h3 id="44-registrystore-与-strategy">4.4 registry.Store 与 Strategy</h3>
<p>要实现 <code>rest.Storage</code> interface？Kubernetes 依旧提供了实现了 <code>rest.Storage</code> 的类 <code>registry.Store</code>。我们真正要做的就是将一个回调函数设置到 Store 对象中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Store implements k8s.io/apiserver/pkg/registry/rest.StandardStorage. It&#39;s
</span><span class="c1">// intended to be embeddable and allows the consumer to implement any
</span><span class="c1">// non-generic functions that are required. This object is intended to be
</span><span class="c1">// copyable so that it can be used in different ways but share the same
</span><span class="c1">// underlying behavior.
</span><span class="c1">//
</span><span class="c1">// All fields are required unless specified.
</span><span class="c1">//
</span><span class="c1">// The intended use of this type is embedding within a Kind specific
</span><span class="c1">// RESTStorage implementation. This type provides CRUD semantics on a Kubelike
</span><span class="c1">// resource, handling details like conflict detection with ResourceVersion and
</span><span class="c1">// semantics. The RESTCreateStrategy, RESTUpdateStrategy, and
</span><span class="c1">// RESTDeleteStrategy are generic across all backends, and encapsulate logic
</span><span class="c1">// specific to the API.
</span><span class="c1">//
</span><span class="c1">// TODO: make the default exposed methods exactly match a generic RESTStorage
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Store</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们仅仅关注在如何使用 <code>rest.Store</code>，以 Flunder 的 REST 实现为例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// REST implements a RESTStorage for API services against etcd
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">REST</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="o">*</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewREST</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">optsGetter</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">registry</span><span class="p">.</span><span class="nx">REST</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">strategy</span> <span class="o">:=</span> <span class="nf">NewStrategy</span><span class="p">(</span><span class="nx">scheme</span><span class="p">)</span>

	<span class="nx">store</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span><span class="p">{</span>
		<span class="nx">NewFunc</span><span class="p">:</span>                  <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">{}</span> <span class="p">},</span>
		<span class="nx">NewListFunc</span><span class="p">:</span>              <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">FlunderList</span><span class="p">{}</span> <span class="p">},</span>
		<span class="nx">PredicateFunc</span><span class="p">:</span>            <span class="nx">MatchFlunder</span><span class="p">,</span>
		<span class="nx">DefaultQualifiedResource</span><span class="p">:</span> <span class="nx">wardle</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;flunders&#34;</span><span class="p">),</span>

		<span class="nx">CreateStrategy</span><span class="p">:</span> <span class="nx">strategy</span><span class="p">,</span>
		<span class="nx">UpdateStrategy</span><span class="p">:</span> <span class="nx">strategy</span><span class="p">,</span>
		<span class="nx">DeleteStrategy</span><span class="p">:</span> <span class="nx">strategy</span><span class="p">,</span>

		<span class="c1">// TODO: define table converter that exposes more than name/creation timestamp
</span><span class="c1"></span>		<span class="nx">TableConvertor</span><span class="p">:</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">NewDefaultTableConvertor</span><span class="p">(</span><span class="nx">wardle</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;flunders&#34;</span><span class="p">)),</span>
	<span class="p">}</span>
	<span class="nx">options</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">generic</span><span class="p">.</span><span class="nx">StoreOptions</span><span class="p">{</span><span class="nx">RESTOptions</span><span class="p">:</span> <span class="nx">optsGetter</span><span class="p">,</span> <span class="nx">AttrFunc</span><span class="p">:</span> <span class="nx">GetAttrs</span><span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">store</span><span class="p">.</span><span class="nf">CompleteWithOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">registry</span><span class="p">.</span><span class="nx">REST</span><span class="p">{</span><span class="nx">store</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Store 已经实现了 Creater、Updater 等 interface，确切的说是 <code>rest.StandardStorage</code>。也就是说，Store 将最基本的 CRUD 逻辑实现了，我们需要实现的就是扩展点的函数。</p>
<p>每个操作的扩展点就称为 Strategy（总算看到了标题）。看下我们自己实现的 Strategy:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">flunderStrategy</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">runtime</span><span class="p">.</span><span class="nx">ObjectTyper</span>
	<span class="nx">names</span><span class="p">.</span><span class="nx">NameGenerator</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">NamespaceScoped</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">PrepareForCreate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">PrepareForUpdate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">old</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// Validate 用于对对象进行验证
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">Validate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span> <span class="p">{</span>
	<span class="nx">flunder</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">validation</span><span class="p">.</span><span class="nf">ValidateFlunder</span><span class="p">(</span><span class="nx">flunder</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WarningsOnCreate returns warnings for the creation of the given object.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">WarningsOnCreate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">[]</span><span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">AllowCreateOnUpdate</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">AllowUnconditionalUpdate</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">Canonicalize</span><span class="p">(</span><span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">ValidateUpdate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">old</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// WarningsOnUpdate returns warnings for the given update.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">WarningsOnUpdate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">old</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">[]</span><span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="45-总结">4.5 总结</h3>
<p>兜兜绕绕了一圈，我们总结一下这个复杂的结构：</p>
<ol>
<li>整个 APIServer 就是一个 HTTP Server；</li>
<li>HTTPServer 由多个 APIGroupInfo，每个 APIGroupInfo 代表了一组 HTTP 接口，即 <strong>&quot;/apis/&lt;group&gt;&quot;</strong>；</li>
<li>每个 APIGroupInfo 包含多个版本，即 <strong>&quot;/apis/&lt;group&gt;/&lt;version&gt;&quot;</strong>；</li>
<li>每个版本可以包含多个 Resource 对应的 rest.Storage 实现，一个 rest.Storage 就是该 Resource 的 REST HTTP Handle，即 <strong>&quot;/apis/&lt;group&gt;/&lt;version&gt;/&lt;resource&gt;&quot;</strong>。</li>
<li>registry.Store 是 Kubernetes 库提供的实现了 rest.Storage 的类，其提供多个扩展点，扩展点就称为 Strategy。</li>
</ol>
<p>我们再回头看，其实这样复杂的结构实现就是为能够实现了 <strong>/apis/&lt;group&gt;/&lt;version&gt;/&lt;resource&gt;</strong> 以及处理函数的抽象。</p>
<h2 id="5-validate">5 Validate</h2>
<p><strong>准入过程中的 Validate 能够实现针对字段动态验证</strong>，比 CRD 定义中的静态验证更加灵活。由下图可见，Validate 过程是在 Mutate Plugin 与 Validate Plugin 之间完成的。








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img1.png"/>


</p>
<p>因此 Validate 只需要为 Internal Version 实现一次，不许为各个 External Version 分别实现。Registry 与 Strategy 为我们封装了上面的真个 Resource Handler，因此 Validate 的入口其实就是 Strategy 中对于 Create/Update 的检查。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">flunderStrategy</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">runtime</span><span class="p">.</span><span class="nx">ObjectTyper</span>
	<span class="nx">names</span><span class="p">.</span><span class="nx">NameGenerator</span>
<span class="p">}</span>

<span class="c1">// ...
</span><span class="c1"></span>
<span class="c1">// Validate 用于对 Create Object 时进行验证
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">flunderStrategy</span><span class="p">)</span> <span class="nf">Validate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span> <span class="p">{</span>
	<span class="nx">flunder</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">validation</span><span class="p">.</span><span class="nf">ValidateFlunder</span><span class="p">(</span><span class="nx">flunder</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>后续就是我们自己实现的 Validate 逻辑，这里使用了 field.ErrorList 这样的方式来方便的展示出错误的字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ValidateFlunder validates a Flunder.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ValidateFlunder</span><span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">Flunder</span><span class="p">)</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span> <span class="p">{</span>
	<span class="nx">allErrs</span> <span class="o">:=</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span><span class="p">{}</span>

	<span class="c1">// 嵌套的属性认证
</span><span class="c1"></span>	<span class="nx">allErrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allErrs</span><span class="p">,</span> <span class="nf">ValidateFlunderSpec</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">f</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">field</span><span class="p">.</span><span class="nf">NewPath</span><span class="p">(</span><span class="s">&#34;spec&#34;</span><span class="p">))</span><span class="o">...</span><span class="p">)</span> <span class="c1">// field.NewPath(记录属性路径)
</span><span class="c1"></span>
	<span class="k">return</span> <span class="nx">allErrs</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于 Validate 逻辑都是在代码中编写的，所以你可以对比多个字段来进行 Validate，灵活性页更高。</p>
<h2 id="6-admission">6 Admission</h2>
<p>还是下图，每个请求在经过反序列化、默认值处理、转换为 Internal Version 后，都会经过 <strong><code>Admission Plugin Chain</code></strong> 处理（图中的 Admission 一块）。








    <br><img src="/posts/cloud_computing/k8s_programming/6-custom-api-server/img1.png"/>


</p>
<p>Admission Plugin 因为两个阶段，也就是可以分为两类插件：</p>
<ul>
<li><strong>Mutate Plugin</strong></li>
<li><strong>Validate Plugin</strong></li>
</ul>
<p>一个 Admission Plugin 可以同时属于这两类，那么在 Admission Controll 过程中，该插件会被调用两次（要么同时启动、要么同时禁用）。</p>
<ul>
<li>Mutate 阶段，所有 Mutate Plugin 会依次调用；</li>
<li>Validate 阶段，所有 Validate Plugin 会被调用（可能并发地调用）；</li>
</ul>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Webhook Admission<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">这里所说的都是继承到 APIServer 代码内部的 Admission Plugin，Kubernetes 也提供了外部基于 Webhook 的 Admission Control，也就是图中调用外部服务的地方。</div>
        </div>
    </div>
<p>下面从入口开始看 Admission Plugin 如何实现的。</p>
<h3 id="61-admission-plugin-选项">6.1 Admission Plugin 选项</h3>
<p>在 APIServer 中，所有的 Admission Plugin 以及相关选项都记录在 APIServer Option <code>RecommendedOptions.Admission</code> 字段中，其是 <code>AdmissionOptions</code> 类型。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// AdmissionOptions holds the admission options
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">AdmissionOptions</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// RecommendedPluginOrder holds an ordered list of plugin names we recommend to use by default
</span><span class="c1"></span>	<span class="nx">RecommendedPluginOrder</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="c1">// DefaultOffPlugins is a set of plugin names that is disabled by default
</span><span class="c1"></span>	<span class="nx">DefaultOffPlugins</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span>

	<span class="c1">// EnablePlugins indicates plugins to be enabled passed through `--enable-admission-plugins`.
</span><span class="c1"></span>	<span class="nx">EnablePlugins</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="c1">// DisablePlugins indicates plugins to be disabled passed through `--disable-admission-plugins`.
</span><span class="c1"></span>	<span class="nx">DisablePlugins</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="c1">// ConfigFile is the file path with admission control configuration.
</span><span class="c1"></span>	<span class="nx">ConfigFile</span> <span class="kt">string</span>
	<span class="c1">// Plugins contains all registered plugins.
</span><span class="c1"></span>	<span class="nx">Plugins</span> <span class="o">*</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Plugins</span>
	<span class="c1">// Decorators is a list of admission decorator to wrap around the admission plugins
</span><span class="c1"></span>	<span class="nx">Decorators</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Decorators</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>RecommendedPluginOrder - Plugin 执行顺序</li>
<li>EnablePlugins - 通过命令行参数 <code>--enable-admission-plugins</code> 打开的 Plugin</li>
<li>DisablePlugins - 通过命令行参数 <code>--disable-admission-plugins</code> 关闭的 Plugin</li>
<li>Plugins - 所有注册了的 Plugin</li>
</ul>
<p>与 Kubernetes APIServer 包含的 Plugin 不同，NewAdmissionOptions() 仅仅包含三个默认的 Plugin：</p>
<ul>
<li>NamespaceLifecycle - 根据 namespace 阶段来执行一些约束，包括：禁止在删除中的 namespace 中创建新对象，对不存在的 namespace 请求拒绝，禁止删除 default、kube-system、kube-public 三个 namespace。</li>
<li>ValidatingAdmissionWebhook - 允许注册与使用 Validating Admission Webhook。</li>
<li>MutatingAdmissionWebhook - 允许注册与使用 Mutating Admission Webhook。</li>
</ul>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Kubernetes APIServer 提供了许多的 Admission Plugin，具体见 <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#%E6%AF%8F%E4%B8%AA%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88" target="_blank" rel="noopener noreffer"><strong>使用准入控制器</strong></a></div>
        </div>
    </div>
<p>代码中，在 APIServer 启动过程中的 <code>Complete()</code> 时会进行自定义 Plugin 的注册，调用 <code>*admission.Plugins.Register()</code> 即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Complete fills in fields required to have valid data
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">WardleServerOptions</span><span class="p">)</span> <span class="nf">Complete</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// 注册 BanFlunder 的 Admission Plugin
</span><span class="c1"></span>	<span class="c1">// register admission plugins
</span><span class="c1"></span>	<span class="nx">banflunder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nx">Plugins</span><span class="p">)</span>

	<span class="c1">// 记录到 Plugins 中
</span><span class="c1"></span>	<span class="c1">// add admission plugins to the RecommendedPluginOrder
</span><span class="c1"></span>	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nx">RecommendedPluginOrder</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nx">RecommendedPluginOrder</span><span class="p">,</span> <span class="s">&#34;BanFlunder&#34;</span><span class="p">)</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// banflunder.Register
</span><span class="c1">// Register registers a plugin
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">plugins</span> <span class="o">*</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Plugins</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">plugins</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="s">&#34;BanFlunder&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">config</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">New</span><span class="p">()</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="62-admission-plugin-interface">6.2 Admission Plugin Interface</h3>
<p>要实现一个 Admission Plugin 需要实现以下接口：</p>
<ul>
<li>addmission.Interface - 用于注册到 Plugin Chain 中</li>
<li>addmission.MutatingInterface（可选）- 能够在 Mutate 阶段被调用</li>
<li>addmission.ValidationInterface（可选）- 能够在 Validate 阶段被调用</li>
</ul>
<p>这三个接口都在 <strong>&ldquo;k8s.io/apiserver/pkg/admission&rdquo;</strong> 包中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Interface is an abstract, pluggable interface for Admission Control decisions.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Handles returns true if this admission controller can handle the given operation
</span><span class="c1"></span>	<span class="c1">// where operation can be one of CREATE, UPDATE, DELETE, or CONNECT
</span><span class="c1"></span>	<span class="nf">Handles</span><span class="p">(</span><span class="nx">operation</span> <span class="nx">Operation</span><span class="p">)</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">MutationInterface</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Interface</span>

	<span class="c1">// Admit makes an admission decision based on the request attributes.
</span><span class="c1"></span>	<span class="c1">// Context is used only for timeout/deadline/cancellation and tracing information.
</span><span class="c1"></span>	<span class="nf">Admit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">a</span> <span class="nx">Attributes</span><span class="p">,</span> <span class="nx">o</span> <span class="nx">ObjectInterfaces</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ValidationInterface is an abstract, pluggable interface for Admission Control decisions.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ValidationInterface</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Interface</span>

	<span class="c1">// Validate makes an admission decision based on the request attributes.  It is NOT allowed to mutate
</span><span class="c1"></span>	<span class="c1">// Context is used only for timeout/deadline/cancellation and tracing information.
</span><span class="c1"></span>	<span class="nf">Validate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">a</span> <span class="nx">Attributes</span><span class="p">,</span> <span class="nx">o</span> <span class="nx">ObjectInterfaces</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Interface.Handles() 根据操作对请求进行过滤，因此可以针对特定的请求才进行 Mutate 与 Validate 阶段；</li>
<li>MutationInterface.Admit() 验证请求，并允许变更对象；</li>
<li>ValidationInterface.Validate() 仅仅验证请求；</li>
</ul>
<h3 id="63-实现-admission-plugin">6.3 实现 Admission Plugin</h3>
<p>好了，我们已经知道在哪里注册 Plugin，以及 Plugin 应该实现哪些接口了，我们开始看一个 Plugin 的实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// New creates a new ban flunder admission plugin
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">DisallowFlunder</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">DisallowFlunder</span><span class="p">{</span>
		<span class="nx">Handler</span><span class="p">:</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">NewHandler</span><span class="p">(</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Create</span><span class="p">),</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DisallowFlunder is a ban flunder admission plugin
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DisallowFlunder</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="o">*</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Handler</span>
	<span class="nx">lister</span> <span class="nx">listers</span><span class="p">.</span><span class="nx">FischerLister</span>
<span class="p">}</span>

<span class="c1">// SetInternalWardleInformerFactory gets Lister from SharedInformerFactory.
</span><span class="c1">// The lister knows how to lists Fischers.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DisallowFlunder</span><span class="p">)</span> <span class="nf">SetInternalWardleInformerFactory</span><span class="p">(</span><span class="nx">f</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">d</span><span class="p">.</span><span class="nx">lister</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Wardle</span><span class="p">().</span><span class="nf">V1alpha1</span><span class="p">().</span><span class="nf">Fischers</span><span class="p">().</span><span class="nf">Lister</span><span class="p">()</span>
	<span class="nx">d</span><span class="p">.</span><span class="nf">SetReadyFunc</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nf">Wardle</span><span class="p">().</span><span class="nf">V1alpha1</span><span class="p">().</span><span class="nf">Fischers</span><span class="p">().</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ValidateInitialization checks whether the plugin was correctly initialized.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DisallowFlunder</span><span class="p">)</span> <span class="nf">ValidateInitialization</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lister</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;missing fischer lister&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>admission.Handler - 内嵌 admission.Handler 的对象实现了 Interface.Handles() 方法，我们只需要注册我们感兴趣的 Operation（Create）；</li>
<li>SetInternalWardleInformerFactory - 传入需要的 Lister</li>
</ul>
<p>Admit() 实现就很简单了，进行一些检查：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DisallowFlunder</span><span class="p">)</span> <span class="nf">Admit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">a</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">,</span> <span class="nx">o</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">ObjectInterfaces</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// 检查 GVK
</span><span class="c1"></span>	<span class="c1">// we are only interested in flunders
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">GetKind</span><span class="p">().</span><span class="nf">GroupKind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">wardle</span><span class="p">.</span><span class="nf">Kind</span><span class="p">(</span><span class="s">&#34;Flunder&#34;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="c1">// 等待 Lister 准备好
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">d</span><span class="p">.</span><span class="nf">WaitForReady</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">NewForbidden</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;not yet ready to handle request&#34;</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="c1">// 进行业务上的 Validate
</span><span class="c1"></span>	<span class="nx">metaAccessor</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">Accessor</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nf">GetObject</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">flunderName</span> <span class="o">:=</span> <span class="nx">metaAccessor</span><span class="p">.</span><span class="nf">GetName</span><span class="p">()</span>

	<span class="nx">fischers</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lister</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nf">Everything</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 黑名单检查
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fischer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fischers</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">disallowedFlunder</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fischer</span><span class="p">.</span><span class="nx">DisallowedFlunders</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">flunderName</span> <span class="o">==</span> <span class="nx">disallowedFlunder</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewForbidden</span><span class="p">(</span>
					<span class="nx">a</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">().</span><span class="nf">GroupResource</span><span class="p">(),</span>
					<span class="nx">a</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(),</span>
					<span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;this name may not be used, please change the resource name&#34;</span><span class="p">),</span>
				<span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="64-基础组件">6.4 基础组件</h3>
<p>Admission Plugin 通常需要 client 和 Informer 去访问其他资源，可以在插件的初始化逻辑中准备好这些基础组件。</p>
<p>库中提供了 <code>admission.PluginInitializer</code> interface 抽象来进行 Plugin 的初始化操作，初始化过程中会对所有的 Plugin 调用每个 <code>PluginInitializer.Initialize()</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// PluginInitializer is used for initialization of shareable resources between admission plugins.
</span><span class="c1">// After initialization the resources have to be set separately
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PluginInitializer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Initialize</span><span class="p">(</span><span class="nx">plugin</span> <span class="nx">Interface</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>根据前面的 Plugin 实现中的 <code>SetInternalWardleInformerFactory()</code> 接口，我们只需要实现了自己的 Initializer 来传递 Informer 即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">pluginInitializer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">informers</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span>
<span class="p">}</span>

<span class="c1">// New creates an instance of wardle admission plugins initializer.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">informers</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">)</span> <span class="nx">pluginInitializer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">pluginInitializer</span><span class="p">{</span>
		<span class="nx">informers</span><span class="p">:</span> <span class="nx">informers</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Initialize checks the initialization interfaces implemented by a plugin
</span><span class="c1">// and provide the appropriate initialization data
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">i</span> <span class="nx">pluginInitializer</span><span class="p">)</span> <span class="nf">Initialize</span><span class="p">(</span><span class="nx">plugin</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">wants</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">plugin</span><span class="p">.(</span><span class="nx">WantsInternalWardleInformerFactory</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">wants</span><span class="p">.</span><span class="nf">SetInternalWardleInformerFactory</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">informers</span><span class="p">)</span> <span class="c1">// 将 Informer 传递给 Plugin
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// WantsInternalWardleInformerFactory defines a function which sets InformerFactory for admission plugins that need it
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">WantsInternalWardleInformerFactory</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">SetInternalWardleInformerFactory</span><span class="p">(</span><span class="nx">informers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">)</span>
	<span class="nx">admission</span><span class="p">.</span><span class="nx">InitializationValidator</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>WantsInternalWardleInformerFactory - 仅仅是特针对于 Informer 的 interface 实现，也是为了单向的抽象，这样如果多个 Plugin 依赖于同一个 Informer，那么至需要创建一个 Initializer</li>
</ul>
<p>最后，所有 <code>admission.PluginInitializer</code> 记录到 <code>RecommendedOptions.ExtraAdmissionInitializers</code> 字段，这样就会自动调用进行初始化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">ExtraAdmissionInitializers</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">RecommendedConfig</span><span class="p">)</span> <span class="p">([]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// 创建 ClientSet
</span><span class="c1"></span>		<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="c1">// 创建 CustomResource Informer，并记录到 Option 中
</span><span class="c1"></span>		<span class="nx">informerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">)</span>
		<span class="nx">o</span><span class="p">.</span><span class="nx">SharedInformerFactory</span> <span class="p">=</span> <span class="nx">informerFactory</span>

		<span class="c1">// 构建 Admission Plugin Initializer，传递了 Informer
</span><span class="c1"></span>		<span class="c1">// Initializer.Initialize 将 Informer 传递给了 Admission Plugin
</span><span class="c1"></span>		<span class="k">return</span> <span class="p">[]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">{</span><span class="nx">wardleinitializer</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">informerFactory</span><span class="p">)},</span> <span class="kc">nil</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="65-总结">6.5 总结</h3>
<p>又是一个复杂的框架搬的实现，看下重要的几个点：</p>
<ol>
<li><code>RecommendedOptions.Admission</code> 记录着所有需要执行的 Admission Plugin，自己编写的也是注册到其中。</li>
<li><code>RecommendedOptions.ExtraAdmissionInitializers</code> 记录着初始化 Plugin 的实现，用于在代码中向各个 Plugin 传递 Informer 等基础组件。</li>
<li>我们需要编写类实现 admission.Interface + admission.MutationInterface + admission.ValidationInterface。在 Admit() 函数中进行 Mutate，在 Validate() 函数中进行 Validate。</li>
<li>如果我们的 Plugin 需要使用 Informer 这样的组件，还需要编写一个类实现 admission.PluginInitializer，用于传递 Informer。</li>
</ol>
<h2 id="7-初始化与启动">7 初始化与启动</h2>
<p>看 main 函数，一切的入口是一个 Option:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 初始化日志
</span><span class="c1"></span>	<span class="nx">logs</span><span class="p">.</span><span class="nf">InitLogs</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">logs</span><span class="p">.</span><span class="nf">FlushLogs</span><span class="p">()</span>

	<span class="c1">// 注册 SIGTERM 与 SIGINT 信号
</span><span class="c1"></span>	<span class="nx">stopCh</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">SetupSignalHandler</span><span class="p">()</span>

	<span class="c1">// 构建 Option
</span><span class="c1"></span>	<span class="nx">options</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewWardleServerOptions</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">)</span>

	<span class="c1">// 得到 cmd 命令行
</span><span class="c1"></span>	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewCommandStartWardleServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
	<span class="nx">cmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">AddGoFlagSet</span><span class="p">(</span><span class="nx">flag</span><span class="p">.</span><span class="nx">CommandLine</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>NewCommandStartWardleServer</code> 得到一个 cobra.Command，所以其真正的运行入口在这里面：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// NewCommandStartWardleServer provides a CLI handler for &#39;start master&#39; command
</span><span class="c1">// with a default WardleServerOptions.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewCommandStartWardleServer</span><span class="p">(</span><span class="nx">defaults</span> <span class="o">*</span><span class="nx">WardleServerOptions</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span> <span class="p">{</span>
	<span class="nx">o</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">defaults</span>
	<span class="nx">cmd</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
		<span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Launch a wardle API server&#34;</span><span class="p">,</span>
		<span class="nx">Long</span><span class="p">:</span>  <span class="s">&#34;Launch a wardle API server&#34;</span><span class="p">,</span>
		<span class="nx">RunE</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nf">RunWardleServer</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">},</span>
	<span class="p">}</span>

	<span class="c1">// 注册命令行参数，Option 中所有字段都可以使用命令行参数配置
</span><span class="c1"></span>	<span class="nx">flags</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">()</span>
	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nf">AddFlags</span><span class="p">(</span><span class="nx">flags</span><span class="p">)</span>
	<span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultMutableFeatureGate</span><span class="p">.</span><span class="nf">AddFlag</span><span class="p">(</span><span class="nx">flags</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">cmd</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="71-options">7.1 Options</h3>
<p>启动 Server 的第一个阶段是得到 Option，代码中创建的是 <code>WardleServerOptions</code>，其最重要的就是包含了 <code>RecommendedOptions</code>，这是 k8s.io/apiserver 库提供的包含所有最基本的 APIServer 配置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WardleServerOptions contains state for master/api server
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">WardleServerOptions</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// RecommendedOptions 记录官方的配置，包含大多数 APIServer 指定的配置
</span><span class="c1"></span>	<span class="nx">RecommendedOptions</span> <span class="o">*</span><span class="nx">genericoptions</span><span class="p">.</span><span class="nx">RecommendedOptions</span>

	<span class="nx">SharedInformerFactory</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span>
	<span class="nx">StdOut</span>                <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
	<span class="nx">StdErr</span>                <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
<span class="p">}</span>

<span class="c1">// RecommendedOptions contains the recommended options for running an API server.
</span><span class="c1">// If you add something to this list, it should be in a logical grouping.
</span><span class="c1">// Each of them can be nil to leave the feature unconfigured on ApplyTo.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">RecommendedOptions</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Etcd</span>           <span class="o">*</span><span class="nx">EtcdOptions</span>  <span class="c1">// 后端存储相关
</span><span class="c1"></span>	<span class="nx">SecureServing</span>  <span class="o">*</span><span class="nx">SecureServingOptionsWithLoopback</span> <span class="c1">// HTTPS 相关配置
</span><span class="c1"></span>	<span class="nx">Authentication</span> <span class="o">*</span><span class="nx">DelegatingAuthenticationOptions</span> 
	<span class="nx">Authorization</span>  <span class="o">*</span><span class="nx">DelegatingAuthorizationOptions</span>
	<span class="nx">Audit</span>          <span class="o">*</span><span class="nx">AuditOptions</span>   <span class="c1">// 审计相关，默认关闭，开启后可以输出审计日志或者发送审计事件到外部后端系统
</span><span class="c1"></span>	<span class="nx">Features</span>       <span class="o">*</span><span class="nx">FeatureOptions</span> <span class="c1">// 开启或禁用某些 Alpha 或 Beta 功能
</span><span class="c1"></span>	<span class="nx">CoreAPI</span>        <span class="o">*</span><span class="nx">CoreAPIOptions</span> <span class="c1">// 访问 Kubernetes APIServer 的 kubeconfig 文件路径
</span><span class="c1"></span>
	<span class="c1">// FeatureGate is a way to plumb feature gate through if you have them.
</span><span class="c1"></span>	<span class="nx">FeatureGate</span> <span class="nx">featuregate</span><span class="p">.</span><span class="nx">FeatureGate</span>
	<span class="c1">// ExtraAdmissionInitializers is called once after all ApplyTo from the options above, to pass the returned
</span><span class="c1"></span>	<span class="c1">// admission plugin initializers to Admission.ApplyTo.
</span><span class="c1"></span>	<span class="nx">ExtraAdmissionInitializers</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">RecommendedConfig</span><span class="p">)</span> <span class="p">([]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nx">Admission</span>                  <span class="o">*</span><span class="nx">AdmissionOptions</span>
	<span class="c1">// API Server Egress Selector is used to control outbound traffic from the API Server
</span><span class="c1"></span>	<span class="nx">EgressSelector</span> <span class="o">*</span><span class="nx">EgressSelectorOptions</span>
	<span class="c1">// Traces contains options to control distributed request tracing.
</span><span class="c1"></span>	<span class="nx">Traces</span> <span class="o">*</span><span class="nx">TracingOptions</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们重点关注使用 <code>RecommendedOptions</code>，使用提供的 <code>genericoptions.NewRecommendedOptions()</code> 来创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">defaultEtcdPathPrefix</span> <span class="p">=</span> <span class="s">&#34;/registry/wardle.example.com&#34;</span>

<span class="c1">// NewWardleServerOptions returns a new WardleServerOptions
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewWardleServerOptions</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">errOut</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="o">*</span><span class="nx">WardleServerOptions</span> <span class="p">{</span>
	<span class="nx">o</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">WardleServerOptions</span><span class="p">{</span>
		<span class="c1">// NewRecommendedOptions 创建 APIServer 推荐的配置，大多数都包含了默认的配置
</span><span class="c1"></span>		<span class="nx">RecommendedOptions</span><span class="p">:</span> <span class="nx">genericoptions</span><span class="p">.</span><span class="nf">NewRecommendedOptions</span><span class="p">(</span>
			<span class="nx">defaultEtcdPathPrefix</span><span class="p">,</span> <span class="c1">// 存在 Etcd 中的 path 前缀
</span><span class="c1"></span>			<span class="nx">apiserver</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">.</span><span class="nf">LegacyCodec</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">),</span> <span class="c1">// 注册解码器
</span><span class="c1"></span>		<span class="p">),</span>

		<span class="nx">StdOut</span><span class="p">:</span> <span class="nx">out</span><span class="p">,</span>
		<span class="nx">StdErr</span><span class="p">:</span> <span class="nx">errOut</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Etcd</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">EncodeVersioner</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewMultiGroupVersioner</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupKind</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">})</span>
	<span class="k">return</span> <span class="nx">o</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>L13 - 定义 ETCD 存储的版本</li>
</ul>
<h4 id="711-complete-option">7.1.1 Complete Option</h4>
<p>启动 Server 的第一步，就是调用 <code>WardleServerOptions.Complete()</code>，其中主要作用就是注册自定义的 Admission Plugin：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Complete fills in fields required to have valid data
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">WardleServerOptions</span><span class="p">)</span> <span class="nf">Complete</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// 注册 BanFlunder 的 Admission Plugin
</span><span class="c1"></span>	<span class="c1">// register admission plugins
</span><span class="c1"></span>	<span class="nx">banflunder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nx">Plugins</span><span class="p">)</span>

	<span class="c1">// 记录到 Plugins 中
</span><span class="c1"></span>	<span class="c1">// add admission plugins to the RecommendedPluginOrder
</span><span class="c1"></span>	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nx">RecommendedPluginOrder</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nx">RecommendedPluginOrder</span><span class="p">,</span> <span class="s">&#34;BanFlunder&#34;</span><span class="p">)</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="712-validate-option">7.1.2 Validate Option</h4>
<p>启动 Server 的第二步，调用 <code>WardleServerOptions.Validate()</code> 进行参数验证。因为我们没有使用额外的参数，所以直接调用 <code>RecommendedOptions.Validate()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Validate validates WardleServerOptions
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="nx">WardleServerOptions</span><span class="p">)</span> <span class="nf">Validate</span><span class="p">(</span><span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">errors</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">error</span><span class="p">{}</span>
	<span class="c1">// 验证 Option 的合法性，执行各个 XXXOptions.Validate()
</span><span class="c1"></span>	<span class="nx">errors</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nf">Validate</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">utilerrors</span><span class="p">.</span><span class="nf">NewAggregate</span><span class="p">(</span><span class="nx">errors</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="713-run-server">7.1.3 Run Server</h4>
<p>启动 Server 的第三步，调用 <code>WardleServerOptions.RunWardleServer</code> 运行一个 Server。其流程为：Options -&gt; Config -&gt; APIServer，最后真正运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// RunWardleServer starts a new WardleServer given WardleServerOptions
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="nx">WardleServerOptions</span><span class="p">)</span> <span class="nf">RunWardleServer</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// Option 转化为 APIServer Config
</span><span class="c1"></span>	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nf">Config</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// config.Complete() 填充一些默认的参数
</span><span class="c1"></span>	<span class="c1">// New() 得到一个 Server 对象，并注册 APIGroup 到 Kubernetes APIServer
</span><span class="c1"></span>	<span class="c1">// NOTE: Custom APIServer 的关键就在这里，注册了一个 APIGroup，Kubernetes APIServer
</span><span class="c1"></span>	<span class="c1">// 会根据注册的 APIGroup 来转发请求
</span><span class="c1"></span>	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">New</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 注册一个 PostStart Hook
</span><span class="c1"></span>	<span class="c1">// Hook 会在 HTTPs Server 启动并监听后被调用
</span><span class="c1"></span>	<span class="nx">server</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-sample-server-informers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="c1">// 启动原生对象的 SharedInformer
</span><span class="c1"></span>		<span class="nx">config</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
		<span class="c1">// 启动 Custom Resource Informer
</span><span class="c1"></span>		<span class="nx">o</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="c1">// PrepareRun 执行启动前的准备工作
</span><span class="c1"></span>	<span class="c1">// Run 运行 HTTPs Server
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">PrepareRun</span><span class="p">().</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，Option 对视为针对于命令行参数的数据结构，Config 是针对于 APIServer 配置的数据结构。其通过 <code>WardleServerOptions.Config()</code> 进行转化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Config returns config for the api server given WardleServerOptions
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">WardleServerOptions</span><span class="p">)</span> <span class="nf">Config</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 创建一个自签名的证书，用于用户没有传预生成证书时使用
</span><span class="c1"></span>	<span class="c1">// TODO have a &#34;real&#34; external address
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">SecureServing</span><span class="p">.</span><span class="nf">MaybeDefaultWithSelfSignedCerts</span><span class="p">(</span><span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="p">[]</span><span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">{</span><span class="nx">netutils</span><span class="p">.</span><span class="nf">ParseIPSloppy</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">)});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error creating self-signed certificates: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// 设置 Storage Paging
</span><span class="c1"></span>	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">Etcd</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">Paging</span> <span class="p">=</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">APIListChunking</span><span class="p">)</span>

	<span class="c1">// 注册 ExtraAdmissionInitializers
</span><span class="c1"></span>	<span class="c1">// AdmissionInitializers 在 Option.ApplyTo 调用后执行一次，并将返回值 []admission.PluginInitializer 传递给 Admission.Applyto
</span><span class="c1"></span>	<span class="c1">// 这里用来初始化了 ClientSet 与 Informer，并传递给了自身 Server 的 Admission Plugin
</span><span class="c1"></span>	<span class="c1">// NOTE: 所以这里是用于让 Custom APIServer 与 Custom Admission Plugin 传递对象用的
</span><span class="c1"></span>	<span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nx">ExtraAdmissionInitializers</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">RecommendedConfig</span><span class="p">)</span> <span class="p">([]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// 创建 ClientSet
</span><span class="c1"></span>		<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="c1">// 创建 CustomResource Informer，并记录到 Option 中
</span><span class="c1"></span>		<span class="nx">informerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">)</span>
		<span class="nx">o</span><span class="p">.</span><span class="nx">SharedInformerFactory</span> <span class="p">=</span> <span class="nx">informerFactory</span>

		<span class="c1">// 构建 Admission Plugin Initializer，传递了 Informer
</span><span class="c1"></span>		<span class="c1">// Initializer.Initialize 将 Informer 传递给了 Admission Plugin
</span><span class="c1"></span>		<span class="k">return</span> <span class="p">[]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">{</span><span class="nx">wardleinitializer</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">informerFactory</span><span class="p">)},</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="c1">// 新建 RecommendedConfig
</span><span class="c1"></span>	<span class="nx">serverConfig</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewRecommendedConfig</span><span class="p">(</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">)</span>

	<span class="c1">// 配置生成 OpenAPI 相关配置
</span><span class="c1"></span>	<span class="nx">serverConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span> <span class="p">=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">DefaultOpenAPIConfig</span><span class="p">(</span><span class="nx">sampleopenapi</span><span class="p">.</span><span class="nx">GetOpenAPIDefinitions</span><span class="p">,</span> <span class="nx">openapi</span><span class="p">.</span><span class="nf">NewDefinitionNamer</span><span class="p">(</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">))</span>
	<span class="nx">serverConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&#34;Wardle&#34;</span>
	<span class="nx">serverConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="s">&#34;0.1&#34;</span>

	<span class="c1">// 将 Option 转换为 Config
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="nx">serverConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 得到 APIServer Config
</span><span class="c1"></span>	<span class="c1">// 包含:
</span><span class="c1"></span>	<span class="c1">//	1. RecommendedConfig - 预定的通用 Config
</span><span class="c1"></span>	<span class="c1">//	2. ExtraConfig - 自身可传递的一些 Config
</span><span class="c1"></span>	<span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
		<span class="nx">GenericConfig</span><span class="p">:</span> <span class="nx">serverConfig</span><span class="p">,</span>
		<span class="nx">ExtraConfig</span><span class="p">:</span>   <span class="nx">apiserver</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">{},</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">config</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，Option 转化为 Config 过程中，执行了之前讲过的向 Admission Plugin 传递基础组件的过程。</p>
<p>k8s.io/apiserver 中，我们基于 RecommendOptions 来实现所有的选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span> 
    <span class="c1">// ... 
</span><span class="c1"></span>    <span class="nx">informers</span> <span class="s">&#34;github.com/programming-kubernetes/pizza-apiserver/pkg/generated/informers/externalversions&#34;</span> 
<span class="p">)</span> 

<span class="c1">// etcd 中存储数据的键前缀
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">defaultEtcdPathPrefix</span> <span class="p">=</span> <span class="s">&#34;/registry/restaurant.programming-
</span><span class="s">kubernetes.info&#34;</span> 

<span class="c1">// 自定义的 Options 结构
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CustomServerOptions</span> <span class="kd">struct</span> <span class="p">{</span> 
    <span class="nx">RecommendedOptions</span> <span class="o">*</span><span class="nx">genericoptions</span><span class="p">.</span><span class="nx">RecommendedOptions</span> 
    <span class="nx">SharedInformerFactory</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span> 
<span class="p">}</span> 
 
<span class="kd">func</span> <span class="nf">NewCustomServerOptions</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">errOut</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="o">*</span><span class="nx">CustomServerOptions</span> <span class="p">{</span> 
    <span class="nx">o</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CustomServerOptions</span><span class="p">{</span> 
        <span class="nx">RecommendedOptions</span><span class="p">:</span> <span class="nx">genericoptions</span><span class="p">.</span><span class="nf">NewRecommendedOptions</span><span class="p">(</span> 
            <span class="nx">defaultEtcdPathPrefix</span><span class="p">,</span> 
            <span class="nx">apiserver</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">.</span><span class="nf">LegacyCodec</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">),</span> 
            <span class="nx">genericoptions</span><span class="p">.</span><span class="nf">NewProcessInfo</span><span class="p">(</span><span class="s">&#34;pizza-apiserver&#34;</span><span class="p">,</span> <span class="s">&#34;pizza-
</span><span class="s">apiserver&#34;</span><span class="p">),</span> 
        <span class="p">),</span> 
    <span class="p">}</span> 
 
    <span class="k">return</span> <span class="nx">o</span> 
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="72-config">7.2 Config</h3>
<p>启动 Server 的第二阶段是 Config 类，与 Option 类似，我们会包含 k8s.io/apiserver 库提供的 <code>RecommendedConfig</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">GenericConfig</span> <span class="o">*</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">RecommendedConfig</span>
	<span class="nx">ExtraConfig</span>   <span class="nx">ExtraConfig</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>RecommendedConfig</code> 有着许多的配置项，所以我们不深入其实现，主要观察如何使用它。也就是如何从 Config，得到 APIServer 对象。</p>
<p>正如之前看到的，由 Option 转化为 Config 对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="c1">// 新建 RecommendedConfig
</span><span class="c1"></span>	<span class="nx">serverConfig</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewRecommendedConfig</span><span class="p">(</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">)</span>

	<span class="c1">// 配置生成 OpenAPI 相关配置
</span><span class="c1"></span>	<span class="nx">serverConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span> <span class="p">=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">DefaultOpenAPIConfig</span><span class="p">(</span><span class="nx">sampleopenapi</span><span class="p">.</span><span class="nx">GetOpenAPIDefinitions</span><span class="p">,</span> <span class="nx">openapi</span><span class="p">.</span><span class="nf">NewDefinitionNamer</span><span class="p">(</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">))</span>
	<span class="nx">serverConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&#34;Wardle&#34;</span>
	<span class="nx">serverConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="s">&#34;0.1&#34;</span>

	<span class="c1">// 将 Option 转换为 Config
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">RecommendedOptions</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="nx">serverConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 得到 APIServer Config
</span><span class="c1"></span>	<span class="c1">// 包含:
</span><span class="c1"></span>	<span class="c1">//	1. RecommendedConfig - 预定的通用 Config
</span><span class="c1"></span>	<span class="c1">//	2. ExtraConfig - 自身可传递的一些 Config
</span><span class="c1"></span>	<span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
		<span class="nx">GenericConfig</span><span class="p">:</span> <span class="nx">serverConfig</span><span class="p">,</span>
		<span class="nx">ExtraConfig</span><span class="p">:</span>   <span class="nx">apiserver</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">{},</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从 Config 得到 Server 对象就很简单了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">New</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="721-complete-config">7.2.1 Complete Config</h4>
<p>Complete 过程依旧简单，执行 <code>GenericConfig.Complete()</code> 以及设置到版本号即可，返回一个 <code>CompletedConfig</code> 对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// CompletedConfig embeds a private pointer that cannot be instantiated outside of this package.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CompletedConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="o">*</span><span class="nx">completedConfig</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">cfg</span> <span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="nf">Complete</span><span class="p">()</span> <span class="nx">CompletedConfig</span> <span class="p">{</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">completedConfig</span><span class="p">{</span>
		<span class="nx">cfg</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">(),</span>
		<span class="o">&amp;</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">version</span><span class="p">.</span><span class="nx">Info</span><span class="p">{</span>
		<span class="nx">Major</span><span class="p">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span>
		<span class="nx">Minor</span><span class="p">:</span> <span class="s">&#34;0&#34;</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">CompletedConfig</span><span class="p">{</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>为何使用新的对象 CompletedConfig?<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">CompletedConfig 才包含 New() 方法，这样能保证 New APIServer 时一定是经过 Complete Config 的。</div>
        </div>
    </div>
<h4 id="722-new-apiserver">7.2.2 New APIServer</h4>
<p>New APIServer 过程在创建一个 APIServer 对象后，就完成了 HTTP API Handle 的注册了，而这就是最关键的地方：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// New returns a new instance of WardleServer from the given config.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">WardleServer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// CompletedConfig 得到一个 GenericAPIServer
</span><span class="c1"></span>	<span class="nx">genericServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;sample-apiserver&#34;</span><span class="p">,</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewEmptyDelegate</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// Custom APIServer 对象
</span><span class="c1"></span>	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">WardleServer</span><span class="p">{</span>
		<span class="nx">GenericAPIServer</span><span class="p">:</span> <span class="nx">genericServer</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// 构建 APIGroupInfo
</span><span class="c1"></span>	<span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewDefaultAPIGroupInfo</span><span class="p">(</span><span class="nx">wardle</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Scheme</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span> <span class="nx">Codecs</span><span class="p">)</span>

	<span class="c1">// 构建 APIGroup
</span><span class="c1"></span>	<span class="c1">// 一个 rest.Storage 对应了一个 HTTP API Endpoint
</span><span class="c1"></span>	<span class="c1">// 即 /apis/&lt;group&gt;/&lt;version&gt;/&lt;resource&gt;
</span><span class="c1"></span>
	<span class="c1">// 下面注册了两个 Endpoint
</span><span class="c1"></span>	<span class="c1">//	+ /apis/wardle.example.com/v1alpha1/flunders
</span><span class="c1"></span>	<span class="c1">//	+ /apis/wardle.example.com/v1alpha1/fischers
</span><span class="c1"></span>	<span class="nx">v1alpha1storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
	<span class="nx">v1alpha1storage</span><span class="p">[</span><span class="s">&#34;flunders&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">flunderstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">v1alpha1storage</span><span class="p">[</span><span class="s">&#34;fischers&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">fischerstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="s">&#34;v1alpha1&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1alpha1storage</span>

	<span class="c1">// 下面注册了一个 Endpoint
</span><span class="c1"></span>	<span class="c1">//	+ /apis/wardle.example.com/v1beta1/flunders
</span><span class="c1"></span>	<span class="nx">v1beta1storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
	<span class="nx">v1beta1storage</span><span class="p">[</span><span class="s">&#34;flunders&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">wardleregistry</span><span class="p">.</span><span class="nf">RESTInPeace</span><span class="p">(</span><span class="nx">flunderstorage</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">))</span>
	<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="s">&#34;v1beta1&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1beta1storage</span>

	<span class="c1">// 注册 APIGroup 到 Kubernetes APIServer
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallAPIGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="73-server">7.3 Server</h3>
<p>总算来到最后的阶段，Server 对象就是一个 APIServer 的实现了，我们只需要调用库提供的 <code>GenericAPIServer</code> 实现的 PrepareRun() 与 Run() 接口实现即可运行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">New</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 注册一个 PostStart Hook
</span><span class="c1"></span>	<span class="c1">// Hook 会在 HTTPs Server 启动并监听后被调用
</span><span class="c1"></span>	<span class="nx">server</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-sample-server-informers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="c1">// 启动原生对象的 SharedInformer
</span><span class="c1"></span>		<span class="nx">config</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
		<span class="c1">// 启动 Custom Resource Informer
</span><span class="c1"></span>		<span class="nx">o</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="c1">// PrepareRun 执行启动前的准备工作
</span><span class="c1"></span>	<span class="c1">// Run 运行 HTTPs Server
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">PrepareRun</span><span class="p">().</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="8-部署">8 部署</h2>
<h3 id="81-部署清单">8.1 部署清单</h3>
<p>清单：</p>
<ul>
<li>APIService</li>
<li>Service</li>
<li>Deployment</li>
<li>ServiceAccount + ClusterRole + ClusterRoleBinding</li>
</ul>
<p>之前提到，APIService 对象向原生 Kubernetes APIServer 注册一个 Custom APISever。因此这是必须要部署的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiregistration.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">APIService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1alpha1.wardle.example.com</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">insecureSkipTLSVerify</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">wardle.example.com</span><span class="w">
</span><span class="w">  </span><span class="nt">groupPriorityMinimum</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="w">  </span><span class="nt">versionPriority</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1alpha1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>注意，测试环境我们将 <code>spec.insecureSkipTLSVerify</code> 设为 true，而生产环境不能这么做。</p>
<p>APIService 仅仅是让 Kubernetes APIServer 知晓 Custom APIServer 存在，为了能够转发请求，我们还需要部署 Custom APIServer 使用的 Service 对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiserver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>运行我们 Custom APIServer 程序的 Deployment。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wardle-server</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiserver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">apiserver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">apiserver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">apiserver</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wardle-server</span><span class="w">
</span><span class="w">        </span><span class="c"># build from staging/src/k8s.io/sample-apiserver/artifacts/simple-image/Dockerfile</span><span class="w">
</span><span class="w">        </span><span class="c"># or</span><span class="w">
</span><span class="w">        </span><span class="c"># docker pull k8s.gcr.io/e2e-test-images/sample-apiserver:1.17.4</span><span class="w">
</span><span class="w">        </span><span class="c"># docker tag k8s.gcr.io/e2e-test-images/sample-apiserver:1.17.4 kube-sample-apiserver:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kube-sample-apiserver:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;--etcd-servers=http://localhost:2379&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/coreos/etcd:v3.5.0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">APIServer 是无状态的，所以如果你只部署一个 etcd 作为后端存储情况下，可以运行多个 Custom APIServer，并且不需要进行选举。</div>
        </div>
    </div>
<p>访问 Kubernetes APIServer 使用的 ServiceAccount：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apiserver</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ClusterRole 提供相关的访问权限，主要包括：</p>
<ul>
<li>namespace - 为了实现 Namespace 删除时，其下相关对象也被删除，需要 namespace 相关权限</li>
<li>admission webhook - 为了能够支持 admission webhook</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aggregated-apiserver-clusterrole</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;namespaces&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;admissionregistration.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;mutatingwebhookconfigurations&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;validatingwebhookconfigurations&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ClusterRoleBinding 连接 ClusterRole 与 ServiceAccount，并且还需要绑定一些预创建的 ClusterRole。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-apiserver-clusterrolebinding</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aggregated-apiserver-clusterrole</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apiserver</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wardle:system:auth-delegator</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:auth-delegator</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apiserver</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 为了代理认证和授权</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wardle-auth-reader</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extension-apiserver-authentication-reader</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apiserver</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">wardle</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="82-配置证书">8.2 配置证书</h3>
<p>前面我们使用 APIService 中的 <code>spec.insecureSkipTLSVerify</code> 为 false 来让 Custom APIServer 与 Kubernetes APIServer 之前通信跳过 TLS 鉴权。</p>
<p>如果需要配置 TLS，可以在 APIService 中的 <code>spec.caBundle</code> 字段配置 Custom APISever 的根证书，这样 Kubernetes APIServer 就会使用该证书来对 Custom APISever 进行鉴权。</p>
<p>对于 Custom APIServer，我们创建好 Server 的证书与私钥后，创建一个 Secret 对象，然后将其挂载到 Pod 的 /var/run/apiserver/serving-cert/tls.{crt,key} 文件中。
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>/var/run/apiserver/serving-cert/tls.{crt,key} 是默认的放置 APIServer 证书与私钥的目录。</p>
<p>你可以通过命令行参数 &ndash;cert-dir &ldquo;dir&rdquo; 指定证书与私钥的目录。</p>
<p>或者，通过 &ndash;tls-cert-file &ldquo;file&rdquo; 与 &ndash;tls-private-key-file &ldquo;file&rdquo; 指定证书文件与私钥文件。</p>
</div>
        </div>
    </div></p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/kubernetes/apiserver" target="_blank" rel="noopener noreffer"><strong>k8s.io/apiserver</strong></a></li>
<li><a href="https://book.douban.com/subject/33393681/" target="_blank" rel="noopener noreffer"><strong>《Programming Kubernetes》</strong></a></li>
<li><a href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/" target="_blank" rel="noopener noreffer"><strong>Configure the Aggregation Layer</strong></a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-09-16&nbsp;<a class="git-hash" href="https://github.com/KanShiori/KanShiori.github.io/commit/59a7cb740036bc1cbf02993b7f016f2902354213" target="_blank" title="commit by Shiori(yshshihaoren@qq.com) 59a7cb740036bc1cbf02993b7f016f2902354213: optimize">
                                    <i class="fas fa-hashtag fa-fw"></i>59a7cb7</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/cloud_computing/k8s_programming/6-custom-api-server/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://KanShiori.github.io/posts/cloud_computing/k8s_programming/6-custom-api-server/" data-title="K8s 编程 - Custom APIServer"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://KanShiori.github.io/posts/cloud_computing/k8s_programming/6-custom-api-server/" data-title="K8s 编程 - Custom APIServer"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://KanShiori.github.io/posts/cloud_computing/k8s_programming/6-custom-api-server/" data-title="K8s 编程 - Custom APIServer"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cloud_computing/k8s_programming/5-shipping-controllers/" class="prev" rel="prev" title="K8s 编程 - 发布 Operator"><i class="fas fa-angle-left fa-fw"></i>K8s 编程 - 发布 Operator</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Shiori</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":25},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"9NJS0VQU0I","algoliaIndex":"blog","algoliaSearchKey":"85d62ea65a7f7445fbfb413bdca088f2","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
